// --------------------------------------
// 
//    _  _ _/ .  _  _/ /_ _  _  _        
//   /_|/_ / /|//_  / / //_ /_// /_/     
//   https://activetheory.com    _/      
// 
// --------------------------------------
//   8/31/22 11:12a
// --------------------------------------

"undefined"==typeof console&&(window.console={},console.log=console.error=console.info=console.debug=console.warn=console.trace=function(){}),window.performance=window.performance&&window.performance.now?window.performance:Date,Date.now=Date.now||function(){return+new Date},window.requestAnimationFrame||(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.oRequestAnimationFrame||window.msRequestAnimationFrame||function(){const start=Date.now();return function(callback){window.setTimeout(()=>callback(Date.now()-start),1e3/60)}}()),window.defer=window.requestAnimationFrame,window.clearTimeout=function(){const _clearTimeout=window.clearTimeout;return function(ref){return window.Timer&&Timer.__clearTimeout(ref)||_clearTimeout(ref)}}(),window.requestIdleCallback=function(){const _requestIdleCallback=window.requestIdleCallback;return function(callback,max){return _requestIdleCallback?_requestIdleCallback(callback,max?{timeout:max}:null):defer(()=>{callback({didTimeout:!1})},0)}}(),window.onIdle=window.requestIdleCallback,"undefined"==typeof Float32Array&&(Float32Array=Array),Math.sign=function(x){return 0===(x=+x)||isNaN(x)?Number(x):x>0?1:-1},Math._round=Math.round,Math.round=function(value,precision=0){let p=Math.pow(10,precision);return Math._round(value*p)/p},Math._random=Math.random,Math.rand=Math.random=function(min,max,precision=0){return void 0===min?Math._random():min===max?min:(min=min||0,max=max||1,0==precision?Math.floor(Math._random()*(max+1-min)+min):Math.round(min+Math._random()*(max-min),precision))},Math.degrees=function(radians){return radians*(180/Math.PI)},Math.radians=function(degrees){return degrees*(Math.PI/180)},Math.clamp=function(value,min=0,max=1){return Math.min(Math.max(value,Math.min(min,max)),Math.max(min,max))},Math.map=Math.range=function(value,oldMin=-1,oldMax=1,newMin=0,newMax=1,isClamp){const newValue=(value-oldMin)*(newMax-newMin)/(oldMax-oldMin)+newMin;return isClamp?Math.clamp(newValue,Math.min(newMin,newMax),Math.max(newMin,newMax)):newValue},Math.mix=function(a,b,alpha){return a*(1-alpha)+b*alpha},Math.step=function(edge,value){return value<edge?0:1},Math.smoothStep=function(min,max,value){const x=Math.max(0,Math.min(1,(value-min)/(max-min)));return x*x*(3-2*x)},Math.fract=function(value){return value-Math.floor(value)},Math.lerp=function(target,value,alpha){return value+(target-value)*Math.clamp(alpha*Render.HZ_MULTIPLIER,0,1)},Math.mod=function(value,n){return(value%n+n)%n},Array.prototype.shuffle=function(){let temp,r,i=this.length-1;for(;i>0;)r=Math.random(0,i,0),i-=1,temp=this[i],this[i]=this[r],this[r]=temp;return this},Array.storeRandom=function(arr){arr.randomStore=[]},Array.prototype.random=function(range){let value=Math.random(0,this.length-1);if(arguments.length&&!this.randomStore&&Array.storeRandom(this),!this.randomStore)return this[value];if(range>this.length-1&&(range=this.length),range>1){for(;~this.randomStore.indexOf(value);)(value+=1)>this.length-1&&(value=0);this.randomStore.push(value),this.randomStore.length>=range&&this.randomStore.shift()}return this[value]},Array.prototype.remove=function(element){if(!this.indexOf)return;const index=this.indexOf(element);return~index?this.splice(index,1):void 0},Array.prototype.last=function(){return this[this.length-1]},window.Promise=window.Promise||{},Array.prototype.flat||Object.defineProperty(Array.prototype,"flat",{configurable:!0,value:function flat(){var depth=isNaN(arguments[0])?1:Number(arguments[0]);return depth?Array.prototype.reduce.call(this,(function(acc,cur){return Array.isArray(cur)?acc.push.apply(acc,flat.call(cur,depth-1)):acc.push(cur),acc}),[]):Array.prototype.slice.call(this)},writable:!0}),Promise.create=function(){const promise=new Promise((resolve,reject)=>{this.temp_resolve=resolve,this.temp_reject=reject});return promise.resolve=this.temp_resolve,promise.reject=this.temp_reject,delete this.temp_resolve,delete this.temp_reject,promise},Promise.catchAll=function(array){let promises=[];return array.forEach(promise=>{let p=Promise.create();promises.push(p),promise.then(d=>p.resolve(d)).catch(e=>p.reject(e))}),Promise.all(promises)},String.prototype.includes=function(str){if(!Array.isArray(str))return!!~this.indexOf(str);for(let i=str.length-1;i>=0;i--)if(~this.indexOf(str[i]))return!0;return!1},String.prototype.equals=function(str){let compare=String(this);if(!Array.isArray(str))return str===compare;for(let i=str.length-1;i>=0;i--)if(str[i]===compare)return!0;return!1},String.prototype.strpos=function(str){return console.warn("strpos deprecated: use .includes()"),this.includes(str)},String.prototype.clip=function(num,end=""){return this.length>num?this.slice(0,Math.max(0,num-end.length)).trim()+end:this.slice()},String.prototype.capitalize=function(){return this.charAt(0).toUpperCase()+this.slice(1)},String.prototype.replaceAll=function(find,replace){return this.split(find).join(replace)},String.prototype.replaceAt=function(index,replacement){return this.substr(0,index)+replacement+this.substr(index+replacement.length)},window.fetch&&!location.protocol.includes("file")||(window.fetch=function(url,options){options=options||{};const promise=Promise.create(),request=new XMLHttpRequest;request.open(options.method||"get",url),url.includes(".ktx")&&(request.responseType="arraybuffer");for(let i in options.headers)request.setRequestHeader(i,options.headers[i]);function response(){let header,keys=[],all=[],headers={};return request.getAllResponseHeaders().replace(/^(.*?):\s*([\s\S]*?)$/gm,(m,key,value)=>{keys.push(key=key.toLowerCase()),all.push([key,value]),header=headers[key],headers[key]=header?`${header},${value}`:value}),{ok:1==(request.status/200|0),status:request.status,statusText:request.statusText,url:request.responseURL,clone:response,text:()=>Promise.resolve(request.responseText),json:()=>Promise.resolve(request.responseText).then(JSON.parse),xml:()=>Promise.resolve(request.responseXML),blob:()=>Promise.resolve(new Blob([request.response])),arrayBuffer:()=>Promise.resolve(request.response),headers:{keys:()=>keys,entries:()=>all,get:n=>headers[n.toLowerCase()],has:n=>n.toLowerCase()in headers}}}return request.onload=()=>{promise.resolve(response())},request.onerror=promise.reject,request.send(options.body),promise}),window.get=function(url,options={credentials:"same-origin"}){let promise=Promise.create();return options.method="GET",fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then(text=>{if(text.charAt(0).includes(["[","{"]))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)})})).catch(promise.reject),promise},window.post=function(url,body,options={}){let promise=Promise.create();return options.method="POST",body&&(options.body="object"==typeof body||Array.isArray(body)?JSON.stringify(body):body),fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then(text=>{if(text.charAt(0).includes(["[","{"]))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)})})).catch(promise.reject),promise},window.put=function(url,body,options={}){let promise=Promise.create();return options.method="PUT",body&&(options.body=JSON.stringify(body)),fetch(url,options).then((function handleResponse(e){if(!e.ok)return promise.reject(e);e.text().then(text=>{if(text.charAt(0).includes(["[","{"]))try{promise.resolve(JSON.parse(text))}catch(err){promise.resolve(text)}else promise.resolve(text)})})).catch(promise.reject),promise},window.Class=function(_class,_type,_static){const _this=this||window,_name=_class.name||_class.toString().match(/function ?([^\(]+)/)[1];"function"==typeof _type&&(_static=_type,_type=null),(_type=(_type||"").toLowerCase())?"static"==_type?_this[_name]=new _class:"singleton"==_type&&(_this[_name]=_class,function(){let _instance;_this[_name].instance=function(a,b,c){return _instance||(_instance=new _class(a,b,c)),_instance}}(),_static&&_static()):(_this[_name]=_class,_static&&_static()),this&&this!==window&&(this[_name]._namespace=this.__namespace)},window.Inherit=function(child,parent){const args=[].slice.call(arguments,2);parent.apply(child,args);const save={};for(let method in child)save[method]=child[method];defer(()=>{for(let method in child)if(save[method]&&child[method]!==save[method]){if("destroy"==method&&child.destroy&&!child.__element)throw"Do not override destroy directly, use onDestroy :: "+child.constructor.toString();child["_"+method]=save[method]}})},window.Namespace=function(obj){"string"==typeof obj?window[obj]||(window[obj]={Class:Class,__namespace:obj}):(obj.Class=Class,obj.__namespace=obj.constructor.name||obj.constructor.toString().match(/function ([^\(]+)/)[1])},window.Global={},window.THREAD=!1,Class((function Hydra(){const _this=this,_readyPromise=Promise.create();var _base,_callbacks=[];function initLoad(){return document&&window?window._NODE_?setTimeout(loaded,1):window._AURA_?window.Main?setTimeout(loaded,1):setTimeout(initLoad,1):void window.addEventListener("load",loaded,!1):setTimeout(initLoad,1)}function loaded(){window.removeEventListener("load",loaded,!1),_this.LOCAL=!window._BUILT_&&(location.hostname.indexOf("local")>-1||"10"==location.hostname.split(".")[0]||"192"==location.hostname.split(".")[0])&&""==location.port,_callbacks.forEach(cb=>cb()),_callbacks=null,_readyPromise.resolve(),window.Main&&_readyPromise.then(()=>Hydra.Main=new window.Main)}this.HASH=window.location.hash.slice(1),this.LOCAL=!window._BUILT_&&(location.hostname.indexOf("local")>-1||"10"==location.hostname.split(".")[0]||"192"==location.hostname.split(".")[0])&&""==location.port,initLoad(),this.__triggerReady=function(){loaded()},this.ready=function(callback){if(!callback)return _readyPromise;_callbacks?_callbacks.push(callback):callback()},this.absolutePath=function(path){if(window.AURA)return path;let base=_base;if(void 0===base)try{if(document.getElementsByTagName("base").length>0){var a=document.createElement("a");a.href=document.getElementsByTagName("base")[0].href,base=a.pathname,_base=base}}catch(e){_base=null}let pathname=base||location.pathname;pathname.includes("/index.html")&&(pathname=pathname.replace("/index.html",""));let port=Number(location.port)>1e3?`:${location.port}`:"";return path.includes("http")?path:(location.protocol.length?location.protocol+"//":"")+(location.hostname+port+pathname+"/"+path).replace("//","/")}}),"Static"),Class((function Utils(){var _queries={};this.query=function(key,force=!1){if(void 0!==_queries[key]&&!force)return _queries[key];const str=decodeURI(window.location.search.replace(new RegExp("^(?:.*[&\\?]"+encodeURI(key).replace(/[\.\+\*]/g,"\\$&")+"(?:\\=([^&]*))?)?.*$","i"),"$1"));return"0"==str?(_queries[key]=0,0):str.length&&"false"!=str?(_queries[key]=str,str):(_queries[key]=location.search.includes(key),_queries[key])},this.getConstructorName=function(obj){return obj?obj.constructor.name||obj.constructor.toString().match(/function ([^\(]+)/)[1]:obj},this.nullObject=function(object){if(object&&(object.destroy||object.div))for(var key in object)void 0!==object[key]&&(object[key]=null);return null},this.cloneObject=function(obj){return JSON.parse(JSON.stringify(obj))},this.headsTails=function(n0,n1){return Math.random(0,1)?n1:n0},this.mergeObject=function(){for(var obj={},i=0;i<arguments.length;i++){var o=arguments[i];for(var key in o)obj[key]=o[key]}return obj},this.timestamp=function(){return(Date.now()+Math.random(0,99999,0)).toString()},this.randomColor=function(){var color="#"+Math.floor(16777215*Math.random()).toString(16);return color.length<7&&(color=this.randomColor()),color},this.numberWithCommas=function(num){return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")},this.padInt=function(num,digits,isLimit){isLimit&&(num=Math.min(num,Math.pow(10,digits)-1));let str=Math.floor(num).toString();return Math.pow(10,Math.max(0,digits-str.length)).toString().slice(1)+str},this.copyToClipboard=function(string){try{var el=document.createElement("textarea"),range=document.createRange();el.contentEditable=!0,el.readOnly=!0,el.value=string,document.body.appendChild(el),el.select(),range.selectNodeContents(el);var s=window.getSelection();return s.removeAllRanges(),s.addRange(range),el.setSelectionRange(0,string.length),document.execCommand("copy"),document.body.removeChild(el),!0}catch(e){return!1}},this.stringList=function(items=[],limit=0,options={}){if(0===items.length)return"";let output="",printed=0;"object"==typeof limit&&(options=limit,limit=0),options.oxford=!0===options.oxford,options.more=!1!==options.more&&(options.more?options.more:"more"),options.and=options.and?options.and:"&",options.comma=options.comma?options.comma:",",isNaN(options.limit)||(limit=options.limit),0===limit&&(limit=items.length);do{output=`${output}${items.shift()}${options.comma} `,printed++}while(items.length>1&&printed+1<limit);if(output=output.trim(),output=output.slice(0,output.length-1),1===items.length)output=`${output}${options.oxford&&printed>1?options.comma:""} ${options.and} ${items.shift()}`;else if(items.length>1&&options.more){let more=`${items.length} ${options.more}`;output=`${output}${options.oxford&&printed>1?options.comma:""} ${options.and} ${more}`}return output}}),"Static"),Class((function Render(){const _this=this,_render=[],_drawFrame=[],_multipliers=[];var _last=performance.now(),_skipLimit=200,_localTSL=0,_elapsed=0,_capLast=0,_sampleRefreshRate=[],_firstSample=!1,rAF=requestAnimationFrame;function render(tsl){if(_this.capFPS>0){let delta=tsl-_capLast;if(_capLast=tsl,(_elapsed+=delta)<1e3/_this.capFPS)return rAF(render);_this.REFRESH_RATE=_this.capFPS,_this.HZ_MULTIPLIER=60/_this.REFRESH_RATE,_elapsed=0}if(_this.timeScaleUniform.value=1,_multipliers.length)for(let i=0;i<_multipliers.length;i++){let obj=_multipliers[i];_this.timeScaleUniform.value*=obj.value}_this.DT=tsl-_last,_last=tsl;let delta=_this.DT*_this.timeScaleUniform.value;if(delta=Math.min(_skipLimit,delta),_this.startFrame&&_this.startFrame(tsl,delta),_sampleRefreshRate&&!_this.capFPS){let fps=1e3/_this.DT;if(_sampleRefreshRate.push(fps),_sampleRefreshRate.length>30){_sampleRefreshRate.sort((a,b)=>a-b);let rate=_sampleRefreshRate[Math.round(_sampleRefreshRate.length/2)];rate=_this.REFRESH_TABLE.reduce((prev,curr)=>Math.abs(curr-rate)<Math.abs(prev-rate)?curr:prev),_this.REFRESH_RATE=_firstSample?Math.max(_this.REFRESH_RATE,rate):rate,_this.HZ_MULTIPLIER=60/_this.REFRESH_RATE,_sampleRefreshRate=null,_firstSample=!0}}_this.TIME=tsl,_this.DELTA=delta,_localTSL+=delta;for(let i=_render.length-1;i>=0;i--){var callback=_render[i];if(callback)if(callback.fps){if(tsl-callback.last<1e3/callback.fps)continue;callback(++callback.frame),callback.last=tsl}else callback(tsl,delta);else _render.remove(callback)}for(let i=_drawFrame.length-1;i>-1;i--)_drawFrame[i](tsl,delta);_this.drawFrame&&_this.drawFrame(tsl,delta),_this.endFrame&&_this.endFrame(tsl,delta),THREAD||_this.isPaused||rAF(render)}this.timeScaleUniform={value:1,type:"f",ignoreUIL:!0},this.REFRESH_TABLE=[30,60,72,90,100,120,144,240],this.REFRESH_RATE=60,this.HZ_MULTIPLIER=1,this.capFPS=null,THREAD||(rAF(render),setInterval(_=>_sampleRefreshRate=[],3e3)),this.now=function(){return _localTSL},this.start=function(callback,fps){fps&&(callback.fps=fps,callback.last=-1/0,callback.frame=-1),~_render.indexOf(callback)||_render.unshift(callback)},this.stop=function(callback){_render.remove(callback)},this.tick=function(){THREAD&&(this.TIME=performance.now(),render(this.TIME))},this.Worker=function(_callback,_budget=4){Inherit(this,Component);let _scope=this,_elapsed=0;function loop(){if(!_scope.dead){for(;_elapsed<_budget;){if(_scope.dead)return;const start=performance.now();_callback&&_callback(),_elapsed+=performance.now()-start}_elapsed=0}}this.startRender(loop),this.stop=function(){this.dead=!0,this.stopRender(loop)},this.pause=function(){this.stopRender(loop)},this.resume=function(){this.startRender(loop)}},this.pause=function(){_this.isPaused=!0},this.resume=function(){_this.isPaused&&(_this.isPaused=!1,rAF(render))},this.useRAF=function(raf){_firstSample=null,_last=performance.now(),(rAF=raf)(render)},this.onDrawFrame=function(cb){_drawFrame.push(cb)},this.setTimeScale=function(v){_this.timeScaleUniform.value=v},this.getTimeScale=function(){return _this.timeScaleUniform.value},this.createTimeMultiplier=function(){let obj={value:1};return _multipliers.push(obj),obj},this.destroyTimeMultiplier=function(obj){_multipliers.remove(obj)},this.tweenTimeScale=function(value,time,ease,delay){return tween(_this.timeScaleUniform,{value:value},time,ease,delay,null,null,!0)}}),"Static"),Class((function Timer(){const _callbacks=[],_discard=[],_deferA=[],_deferB=[];var _defer=_deferA;function loop(t,delta){for(let i=_discard.length-1;i>=0;i--){let obj=_discard[i];obj.callback=null,_callbacks.remove(obj)}_discard.length&&(_discard.length=0);for(let i=_callbacks.length-1;i>=0;i--){let obj=_callbacks[i];obj?(obj.scaledTime?obj.current+=delta:obj.current+=Render.DT,obj.current>=obj.time&&(obj.callback&&obj.callback(),_discard.push(obj))):_callbacks.remove(obj)}for(let i=_defer.length-1;i>-1;i--)_defer[i]();_defer.length=0,_defer=_defer==_deferA?_deferB:_deferA}Render.start(loop),this.__clearTimeout=function(ref){const obj=function find(ref){for(let i=_callbacks.length-1;i>-1;i--)if(_callbacks[i].ref==ref)return _callbacks[i]}(ref);return!!obj&&(obj.callback=null,_callbacks.remove(obj),!0)},this.create=function(callback,time,scaledTime){if(window._NODE_)return setTimeout(callback,time);const obj={time:Math.max(1,time||1),current:0,ref:Utils.timestamp(),callback:callback,scaledTime:scaledTime};return _callbacks.unshift(obj),obj.ref},window.defer=this.defer=function(callback){if(!callback){callback=Promise.create().resolve}(_defer==_deferA?_deferB:_deferA).unshift(callback)}}),"static"),Class((function Events(){this.events={};const _e={},_linked=[];let _emitter;this.events.sub=function(obj,evt,callback){if("object"!=typeof obj&&(callback=evt,evt=obj,obj=null),!obj)return Events.emitter._addEvent(evt,callback.resolve?callback.resolve:callback,this),callback;let emitter=obj.events.emitter();return emitter._addEvent(evt,callback.resolve?callback.resolve:callback,this),emitter._saveLink(this),_linked.push(emitter),callback},this.events.unsub=function(obj,evt,callback){if("object"!=typeof obj&&(callback=evt,evt=obj,obj=null),!obj)return Events.emitter._removeEvent(evt,callback.resolve?callback.resolve:callback);obj.events.emitter()._removeEvent(evt,callback.resolve?callback.resolve:callback)},this.events.fire=function(evt,obj,isLocalOnly){(obj=obj||_e).target=this,Events.emitter._check(evt),_emitter&&_emitter._fireEvent(evt,obj)||isLocalOnly||Events.emitter._fireEvent(evt,obj)},this.events.bubble=function(obj,evt){let _this=this;_this.sub(obj,evt,e=>_this.fire(evt,e))},this.events.destroy=function(){return Events.emitter._destroyEvents(this),_linked&&_linked.forEach(emitter=>emitter._destroyEvents(this)),_emitter&&_emitter.links&&_emitter.links.forEach(obj=>obj.events&&obj.events._unlink(_emitter)),null},this.events.emitter=function(){return _emitter||(_emitter=Events.emitter.createLocalEmitter()),_emitter},this.events._unlink=function(emitter){_linked.remove(emitter)}}),()=>{Events.emitter=new function Emitter(){const prototype=Emitter.prototype;if(this.events=[],void 0!==prototype._check)return;prototype._check=function(evt){if(void 0===evt)throw"Undefined event"},prototype._addEvent=function(evt,callback,object){this._check(evt),this.events.push({evt:evt,object:object,callback:callback})},prototype._removeEvent=function(eventString,callback){this._check(eventString);let _this=this,marked=!1;for(let i=this.events.length-1;i>=0;i--)this.events[i].evt==eventString&&this.events[i].callback==callback&&(this.events[i].markedForDeletion=!0,marked=!0);marked&&defer(()=>_this._sweepEvents())},prototype._sweepEvents=function(){for(let i=0;i<this.events.length;i++)this.events[i].markedForDeletion&&this.events.remove(this.events[i])},prototype._fireEvent=function(eventString,obj){this._check&&this._check(eventString),obj=obj||_e;let called=!1;for(let i=0;i<this.events.length;i++){let evt=this.events[i];evt.evt!=eventString||evt.markedForDeletion||(evt.callback(obj),called=!0)}return called},prototype._destroyEvents=function(object){for(var i=this.events.length-1;i>=0;i--)this.events[i].object==object&&(this.events.splice(i,1)[0]=null)},prototype._saveLink=function(obj){this.links||(this.links=[]),~this.links.indexOf(obj)||this.links.push(obj)},prototype.createLocalEmitter=function(){return new Emitter}},Events.broadcast=Events.emitter._fireEvent,Events.VISIBILITY="hydra_visibility",Events.HASH_UPDATE="hydra_hash_update",Events.COMPLETE="hydra_complete",Events.PROGRESS="hydra_progress",Events.UPDATE="hydra_update",Events.LOADED="hydra_loaded",Events.END="hydra_end",Events.FAIL="hydra_fail",Events.SELECT="hydra_select",Events.ERROR="hydra_error",Events.READY="hydra_ready",Events.RESIZE="hydra_resize",Events.CLICK="hydra_click",Events.HOVER="hydra_hover",Events.MESSAGE="hydra_message",Events.ORIENTATION="orientation",Events.BACKGROUND="background",Events.BACK="hydra_back",Events.PREVIOUS="hydra_previous",Events.NEXT="hydra_next",Events.RELOAD="hydra_reload",Events.UNLOAD="hydra_unload",Events.FULLSCREEN="hydra_fullscreen";const _e={};Hydra.ready(()=>{if(function(){let _last,_lastTime=performance.now();function onfocus(){"focus"!=_last&&Events.emitter._fireEvent(Events.VISIBILITY,{type:"focus"}),_last="focus"}function onblur(){"blur"!=_last&&Events.emitter._fireEvent(Events.VISIBILITY,{type:"blur"}),_last="blur"}Timer.create((function addVisibilityHandler(){let hidden,eventName;if([["msHidden","msvisibilitychange"],["webkitHidden","webkitvisibilitychange"],["hidden","visibilitychange"]].forEach(d=>{void 0!==document[d[0]]&&(hidden=d[0],eventName=d[1])}),!eventName){const root="ie"==Device.browser?document:window;return root.onfocus=onfocus,void(root.onblur=onblur)}document.addEventListener(eventName,()=>{const time=performance.now();time-_lastTime>10&&(!1===document[hidden]?onfocus():onblur()),_lastTime=time})}),250),window.onbeforeunload=_=>(Events.emitter._fireEvent(Events.UNLOAD),null)}(),window.Stage=window.Stage||{},Tests.socialBrowser()){let box=document.createElement("div");box.style.position="fixed",box.style.top=box.style.left=box.style.right=box.style.bottom="0px",box.style.zIndex="-1",box.style.opacity="0",box.style.pointerEvents="none",document.body.appendChild(box),Global.box=box}let timer;updateStage();let delay="ios"===Device.system.os?250:16;function updateStage(){if(Global.box&&"ios"===Device.system.os){let bbox=Global.box.getBoundingClientRect();Stage.width=bbox.width||window.innerWidth||document.body.clientWidth||document.documentElement.offsetWidth,Stage.height=bbox.height||window.innerHeight||document.body.clientHeight||document.documentElement.offsetHeight,"ios"===Device.system.os&&(document.body.parentElement.scrollTop=document.body.scrollTop=0,document.body.parentElement.height=document.body.style.height=`${Stage.height}px`)}else Stage.width=window.innerWidth||document.body.clientWidth||document.documentElement.offsetWidth,Stage.height=window.innerHeight||document.body.clientHeight||document.documentElement.offsetHeight,"ios"===Device.system.os&&(document.body.parentElement.scrollTop=document.body.scrollTop=0,document.body.parentElement.height=document.body.style.height=`${Stage.height}px`);window.location.href.includes("apps.fbsbx")&&(Stage.width=window.innerWidth,Stage.height=window.innerHeight)}window.addEventListener("resize",(function(){clearTimeout(timer),timer=setTimeout(async _=>{updateStage(),Events.emitter._fireEvent(Events.RESIZE)},delay)})),window.onorientationchange=window.onresize,defer(window.onresize)})}),Class((function Device(){var vid,_this=this;this.agent=navigator.userAgent.toLowerCase(),this.detect=function(match){return this.agent.includes(match)},this.touchCapable=!!navigator.maxTouchPoints,this.pixelRatio=window.devicePixelRatio,this.system={},this.system.retina=window.devicePixelRatio>1,this.system.webworker=void 0!==window.Worker,window._NODE_||(this.system.geolocation=void 0!==navigator.geolocation),window._NODE_||(this.system.pushstate=void 0!==window.history.pushState),this.system.webcam=!!(navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia),this.system.language=window.navigator.userLanguage||window.navigator.language,this.system.webaudio=void 0!==window.AudioContext,this.system.xr=navigator.getVRDisplays||navigator.xr,this.system.exokit=_this.detect("exokit");try{this.system.localStorage=void 0!==window.localStorage}catch(e){this.system.localStorage=!1}this.system.fullscreen=document.fullscreenEnabled||document.webkitFullscreenEnabled||document.mozFullScreenEnabled||document.msFullscreenEnabled,this.system.os=_this.detect(["exokit"])&&"linux"==navigator.platform?"magicleap":_this.detect(["ipad","iphone","ios"])||_this.detect("mac")&&_this.touchCapable&&Math.max(screen.width,screen.height)<1370?"ios":_this.detect(["android","kindle"])?"android":_this.detect(["blackberry"])?"blackberry":_this.detect(["mac os"])?"mac":_this.detect(["windows","iemobile"])?"windows":_this.detect(["linux"])?"linux":"unknown",this.system.version=function(){try{if("ios"==_this.system.os){if(_this.agent.includes("intel mac")){let split=_this.agent.split("version/")[1].split(" ")[0].split(".");return Number(split[0]+"."+split[1])}var num=_this.agent.split("os ")[1].split("_"),main=num[0],sub=num[1].split(" ")[0];return Number(main+"."+sub)}if("android"==_this.system.os){var version=_this.agent.split("android ")[1].split(";")[0];return version.length>3&&(version=version.slice(0,-2)),"."==version.charAt(version.length-1)&&(version=version.slice(0,-1)),Number(version)}if("windows"==_this.system.os)return _this.agent.includes("rv:11")?11:Number(_this.agent.split("windows phone ")[1].split(";")[0])}catch(e){}return-1}(),this.system.browser="ios"==_this.system.os?_this.detect(["twitter","fbios"])?"social":_this.detect(["crios"])?"chrome":_this.detect(["safari"])?"safari":"unknown":"android"==_this.system.os?_this.detect(["twitter","fb","facebook"])?"social":_this.detect(["chrome"])?"chrome":_this.detect(["firefox"])?"firefox":"browser":_this.detect(["msie"])?"ie":_this.detect(["trident"])&&_this.detect(["rv:"])?"ie":_this.detect(["windows"])&&_this.detect(["edge"])?"ie":_this.detect(["chrome"])?"chrome":_this.detect(["safari"])?"safari":_this.detect(["firefox"])?"firefox":"unknown",this.system.browserVersion=function(){try{if("chrome"==_this.system.browser)return Number(_this.agent.split("chrome/")[1].split(".")[0]);if("firefox"==_this.system.browser)return Number(_this.agent.split("firefox/")[1].split(".")[0]);if("safari"==_this.system.browser)return Number(_this.agent.split("version/")[1].split(".")[0].split(".")[0]);if("ie"==_this.system.browser)return _this.detect(["msie"])?Number(_this.agent.split("msie ")[1].split(".")[0]):_this.detect(["rv:"])?Number(_this.agent.split("rv:")[1].split(".")[0]):Number(_this.agent.split("edge/")[1].split(".")[0])}catch(e){return-1}}(),this.mobile=!(window._NODE_||!("ontouchstart"in window||"onpointerdown"in window)||!_this.system.os.includes(["ios","android","magicleap"]))&&{},this.mobile&&this.detect(["windows"])&&!this.detect(["touch"])&&(this.mobile=!1),this.mobile&&(this.mobile.tablet=Math.max(window.screen?screen.width:window.innerWidth,window.screen?screen.height:window.innerHeight)>1e3,this.mobile.phone=!this.mobile.tablet,this.mobile.pwa=!(!window.matchMedia||!window.matchMedia("(display-mode: standalone)").matches)||!!window.navigator.standalone,Hydra.ready(()=>{_this.mobile.native=!(!Mobile.NativeCore||!Mobile.NativeCore.active)||!!window._AURA_})),this.media={},this.media.audio=!!document.createElement("audio").canPlayType&&(_this.detect(["firefox","opera"])?"ogg":"mp3"),this.media.video=!!(vid=document.createElement("video")).canPlayType&&(vid.canPlayType("video/webm;")?"webm":"mp4"),this.media.webrtc=!!(window.webkitRTCPeerConnection||window.mozRTCPeerConnection||window.msRTCPeerConnection||window.oRTCPeerConnection||window.RTCPeerConnection),this.graphics={},this.graphics.webgl=function(){let DISABLED=!1;Object.defineProperty(_this.graphics,"webgl",{get:()=>{if(DISABLED)return!1;if(_this.graphics._webglContext)return _this.graphics._webglContext;try{const names=["webgl2","webgl","experimental-webgl"],canvas=document.createElement("canvas");let gl;for(let i=0;i<names.length&&(gl=canvas.getContext(names[i]),!gl);i++);let info=gl.getExtension("WEBGL_debug_renderer_info"),output={};if(info){let gpu=info.UNMASKED_RENDERER_WEBGL;output.gpu=gl.getParameter(gpu).toLowerCase()}return output.renderer=gl.getParameter(gl.RENDERER).toLowerCase(),output.version=gl.getParameter(gl.VERSION).toLowerCase(),output.glsl=gl.getParameter(gl.SHADING_LANGUAGE_VERSION).toLowerCase(),output.extensions=gl.getSupportedExtensions(),output.webgl2=output.version.includes(["webgl 2","webgl2"]),output.canvas=canvas,output.context=gl,output.detect=function(matches){if(output.gpu&&output.gpu.toLowerCase().includes(matches))return!0;if(output.version&&output.version.toLowerCase().includes(matches))return!0;for(let i=0;i<output.extensions.length;i++)if(output.extensions[i].toLowerCase().includes(matches))return!0;return!1},output.webgl2||output.detect("instance")||(DISABLED=!0),_this.graphics._webglContext=output,output}catch(e){return!1}},set:v=>{!1===v&&(DISABLED=!0)}})}(),this.graphics.metal=function(){if(!window.Metal)return!1;let output={};return output.gpu=Metal.device.getName().toLowerCase(),output.detect=function(matches){return output.gpu.includes(matches)},output}(),this.graphics.gpu=function(){if(!_this.graphics.webgl&&!_this.graphics.metal)return!1;let output={};return["metal","webgl"].forEach(name=>{_this.graphics[name]&&!output.identifier&&(output.detect=_this.graphics[name].detect,output.identifier=_this.graphics[name].gpu)}),output}(),this.graphics.canvas=!!document.createElement("canvas").getContext;const checkForStyle=function(){let _tagDiv;return function(prop){_tagDiv=_tagDiv||document.createElement("div");const vendors=["Khtml","ms","O","Moz","Webkit"];if(prop in _tagDiv.style)return!0;prop=prop.replace(/^[a-z]/,val=>val.toUpperCase());for(let i=vendors.length-1;i>=0;i--)if(vendors[i]+prop in _tagDiv.style)return!0;return!1}}();this.styles={},this.styles.filter=checkForStyle("filter"),this.styles.blendMode=checkForStyle("mix-blend-mode"),this.tween={},this.tween.transition=checkForStyle("transition"),this.tween.css2d=checkForStyle("transform"),this.tween.css3d=checkForStyle("perspective")}),"Static"),Class((function Component(){Inherit(this,Events);const _this=this,_setters={},_flags={},_timers=[],_loops=[];var _postLoops,_onDestroy;function defineSetter(_this,prop){_setters[prop]={},Object.defineProperty(_this,prop,{set:function(v){_setters[prop]&&_setters[prop].s&&_setters[prop].s.call(_this,v),v=null},get:function(){if(_setters[prop]&&_setters[prop].g)return _setters[prop].g.apply(_this)}})}this.classes={},this.findParent=function(type){let p=_this.parent;for(;p;){if(p._cachedName||(p._cachedName=Utils.getConstructorName(p)),p._cachedName==type)return p;p=p.parent}},this.set=function(prop,callback){_setters[prop]||defineSetter(this,prop),_setters[prop].s=callback},this.get=function(prop,callback){_setters[prop]||defineSetter(this,prop),_setters[prop].g=callback},this.initClass=function(clss){if(!clss)throw"unable to locate class";const args=[].slice.call(arguments,1),child=Object.create(clss.prototype);if(child.parent=this,clss.apply(child,args),child.destroy){const id=Utils.timestamp();this.classes[id]=child,this.classes[id].__id=id}if(child.element){const last=arguments[arguments.length-1];Array.isArray(last)&&1==last.length&&last[0]instanceof HydraObject?last[0].add(child.element):this.element&&null!==last&&this.element.add(child.element)}if(child.group){const last=arguments[arguments.length-1];this.group&&null!==last&&this.group.add(child.group)}return child},this.delayedCall=function(callback,time,scaledTime){const timer=Timer.create(()=>{_this&&_this.destroy&&callback&&callback()},time,scaledTime);return _timers.push(timer),_timers.length>50&&_timers.shift(),timer},this.clearTimers=function(){for(let i=_timers.length-1;i>=0;i--)clearTimeout(_timers[i]);_timers.length=0},this.startRender=function(callback,fps,obj){"object"==typeof fps&&(obj=fps,fps=void 0);for(let i=0;i<_loops.length;i++)if(_loops[i].callback==callback)return;let flagInvisible=_=>{_this._invisible||(_this._invisible=!0,_this.onInvisible&&_this.onInvisible())},loop=(a,b,c,d)=>{if(!_this.startRender)return!1;let p=_this;for(;p;){if(!1===p.visible)return flagInvisible();if(p.group&&!1===p.group.visible)return flagInvisible();p=p.parent}return!1!==_this._invisible&&(_this._invisible=!1,_this.onVisible&&_this.onVisible()),callback(a,b,c,d),!0};_loops.push({callback:callback,loop:loop}),obj?window.Nuke&&obj instanceof window.Nuke?_this.events.sub(obj,Nuke.RENDER,loop):obj._onPostLoop&&obj._onPostLoop(loop):Render.start(loop,fps)},this.postLoop=function(){_postLoops&&_postLoops.forEach(cb=>{!1===cb()&&_postLoops.remove(cb)})},this._onPostLoop=function(callback){_postLoops||(_postLoops=[]),_postLoops.push(callback)},this.onResize=function(callback){callback(),this.events.sub(Events.RESIZE,callback)},this.stopRender=function(callback){for(let i=0;i<_loops.length;i++)_loops[i].callback==callback&&(Render.stop(_loops[i].loop),_loops.splice(i,1))},this.clearRenders=function(){for(let i=0;i<_loops.length;i++)Render.stop(_loops[i].loop);_loops.length=0},this.wait=function(object,key,callback){const promise=Promise.create();if("string"==typeof object&&(callback=key,key=object,object=_this),"number"==typeof object&&!key)return _this.delayedCall(promise.resolve,object),promise;if("function"==typeof object&&"function"!=typeof callback){let _object=object;object=key,key=callback,callback=_object}if(callback=callback||promise.resolve,object[key]||_this.flag(key))callback();else{Render.start((function test(){if(!object||!_this.flag)return Render.stop(test);(object[key]||_this.flag(key))&&(callback(),Render.stop(test))}))}return promise},this.flag=function(name,value,time){if(void 0===value)return _flags[name];_flags[name]=value,time&&(clearTimeout(_flags[name+"_timer"]),_flags[name+"_timer"]=this.delayedCall(()=>{_flags[name]=!_flags[name]},time))},this.destroy=function(){this.removeDispatch&&this.removeDispatch(),this.onDestroy&&this.onDestroy(),_onDestroy&&_onDestroy.forEach(cb=>cb());for(let id in this.classes){var clss=this.classes[id];clss&&clss.destroy&&clss.destroy()}return this.classes=null,this.clearRenders&&this.clearRenders(),this.clearTimers&&this.clearTimers(),this.element&&window.GLUI&&this.element instanceof GLUIObject&&this.element.remove(),this.events&&(this.events=this.events.destroy()),this.parent&&this.parent.__destroyChild&&this.parent.__destroyChild(this.__id),Utils.nullObject(this)},this._bindOnDestroy=function(callback){_onDestroy||(_onDestroy=[]),_onDestroy.push(callback)},this.__destroyChild=function(name){delete this.classes[name]}})),Class((function Model(){Inherit(this,Component),Namespace(this);const _this=this,_storage={};let _data=0,_triggered=0;this.push=function(name,val){_storage[name]=val},this.pull=function(name){return _storage[name]},this.waitForData=this.promiseData=function(num=1){_data+=num},this.fulfillData=this.resolveData=function(){_triggered++,_triggered==_data&&(_this.dataReady=!0)},this.ready=function(callback){let promise=Promise.create();return callback&&promise.then(callback),_this.wait(_this,"dataReady").then(promise.resolve),promise},this.initWithData=function(data){for(var key in _this.STATIC_DATA=data,_this){var model=_this[key],init=!1;for(var i in data)i.toLowerCase().replace(/-/g,"")==key.toLowerCase()&&(init=!0,model.init&&model.init(data[i]));!init&&model.init&&model.init()}_this.init&&_this.init(data)},this.loadData=function(url,callback){let promise=Promise.create();callback||(callback=promise.resolve);var _this=this;return get(url+"?"+Utils.timestamp()).then(d=>{defer(()=>{_this.initWithData(d),callback(d)})}),promise}})),Class((function Modules(){const _modules={},_constructors={};function exec(){for(let m in _modules)for(let key in _modules[m]){let module=_modules[m][key];module._ready||(module._ready=!0,module.exec&&module.exec())}}defer(exec),this.Module=function(module){let m=new module,name=module.toString().slice(0,100).match(/function ([^\(]+)/);name?(m._ready=!0,name=name[1],_modules[name]={index:m},_constructors[name]=module):(_modules[m.module]||(_modules[m.module]={}),_modules[m.module][m.path]=m)},this.require=function(path){let root;return path.includes("/")?(root=path.split("/")[0],path=path.replace(root+"/","")):(root=path,path="index"),function requireModule(root,path){let module=_modules[root];if(!module)throw`Module ${root} not found`;return module=module[path],module._ready||(module._ready=!0,module.exec&&module.exec()),module}(root,path).exports},this.getConstructor=function(name){return _constructors[name]},window.Module=this.Module,window._NODE_||(window.requireNative=window.require,window.require=this.require)}),"Static"),Class((function LinkedList(){var prototype=LinkedList.prototype;this.length=0,this.first=null,this.last=null,this.current=null,this.prev=null,void 0===prototype.push&&(prototype.push=function(obj){this.first?(obj.__next=this.first,obj.__prev=this.last,this.last.__next=obj,this.last=obj):(this.first=obj,this.last=obj,obj.__prev=obj,obj.__next=obj),this.length++},prototype.remove=function(obj){obj&&obj.__next&&(this.length<=1?this.empty():(obj==this.first?(this.first=obj.__next,this.last.__next=this.first,this.first.__prev=this.last):obj==this.last?(this.last=obj.__prev,this.last.__next=this.first,this.first.__prev=this.last):(obj.__prev.__next=obj.__next,obj.__next.__prev=obj.__prev),this.length--),obj.__prev=null,obj.__next=null)},prototype.empty=function(){this.first=null,this.last=null,this.current=null,this.prev=null,this.length=0},prototype.start=function(){return this.current=this.first,this.prev=this.current,this.current},prototype.next=function(){if(this.current&&(this.current=this.current.__next,1!=this.length&&this.prev.__next!=this.first))return this.prev=this.current,this.current},prototype.destroy=function(){return Utils.nullObject(this),null})})),Class((function ObjectPool(_type,_number=10){var _pool=[];this.array=_pool,function(){if(_type)for(var i=0;i<_number;i++)_pool.push(new _type)}(),this.get=function(){return _pool.shift()||(_type?new _type:null)},this.empty=function(){_pool.length=0},this.put=function(obj){obj&&_pool.push(obj)},this.insert=function(array){void 0===array.push&&(array=[array]);for(var i=0;i<array.length;i++)_pool.push(array[i])},this.length=function(){return _pool.length},this.randomize=function(){let array=_pool;for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]]}},this.destroy=function(){for(let i=_pool.length-1;i>=0;i--)_pool[i].destroy&&_pool[i].destroy();return _pool=null}})),Class((function Gate(){var _list=[],_map={};this.create=function(name){let promise=Promise.create();name?_map[name]=promise:_list.push(promise)},this.open=function(name){name&&(_map[name]||(_map[name]=Promise.create()),_map[name].resolve());let promise=_list.shift();promise&&promise.resolve()},this.wait=function(name){return _list.length||name?name?(_map[name]||(_map[name]=Promise.create()),_map[name]):_list[_list.length-1]||Promise.resolve():Promise.resolve()}}),"static"),Class((function Assets(){const _this=this;function AssetList(arr){return arr.__proto__=AssetList.prototype,arr}this.__loaded=[],this.FLIPY=!0,this.CDN="",this.CORS=null,this.IMAGES={},this.SDF={},this.JSON={push:function(prop,value){this[prop]=value,Object.defineProperty(this,prop,{get:()=>JSON.parse(JSON.stringify(value))})}},Object.defineProperty(this.JSON,"push",{enumerable:!1,writable:!0}),this.SVG={},AssetList.prototype=new Array,AssetList.prototype.filter=function(items){for(let i=this.length-1;i>=0;i--)this[i].includes(items)||this.splice(i,1);return this},AssetList.prototype.exclude=function(items){for(let i=this.length-1;i>=0;i--)this[i].includes(items)&&this.splice(i,1);return this},AssetList.prototype.prepend=function(prefix){for(let i=this.length-1;i>=0;i--)this[i]=prefix+this[i];return this},AssetList.prototype.append=function(suffix){for(let i=this.length-1;i>=0;i--)this[i]=this[i]+suffix;return this},this.list=function(){return window.ASSETS||console.warn("ASSETS list not available"),new AssetList(window.ASSETS.slice(0)||[])},this.getPath=function(path){return~path.indexOf("//")?path:(path=function parseResolution(path){if(!window.ASSETS||!ASSETS.RES)return path;var res=ASSETS.RES[path],ratio=Math.min(Device.pixelRatio,3);if(!res)return path;if(!res["x"+ratio])return path;var split=path.split("/"),file=split[split.length-1];return split=file.split("."),path.replace(file,split[0]+"-"+ratio+"x."+split[1])}(path),this.CDN&&!~path.indexOf(this.CDN)&&(path=this.CDN+path),path)},this.loadImage=function(path,isStore){var img=new Image;return img.crossOrigin=this.CORS,img.src=_this.getPath(path),img.loadPromise=function(){let promise=Promise.create();return img.onload=promise.resolve,promise},isStore&&(this.IMAGES[path]=img),img},this.decodeImage=function(path,params){let promise=Promise.create(),img=_this.loadImage(path);return img.onload=()=>promise.resolve(img),img.onerror=()=>promise.reject(),promise}}),"static"),Class((function AssetLoader(_assets,_callback,ASSETS=Assets){Inherit(this,Events);const _this=this;let _total=_assets.length,_loaded=0,_lastFiredPercent=0;function loadAsset(){let path=_assets.splice(_assets.length-1,1)[0];const name=path.split("assets/").last().split(".")[0],ext=path.split(".").last().split("?")[0].toLowerCase();let timeout=Timer.create(timedOut,AssetLoader.TIMEOUT,path);if(!Assets.preventCache&&~Assets.__loaded.indexOf(path))return loaded();if(ext.includes(["jpg","jpeg","png","gif"])){let image=ASSETS.loadImage(path);return image.complete?loaded():(image.onload=loaded,void(image.onerror=loaded))}if(window.AURA&&window.AURA.import&&"js"==ext)return AURA.import(path),void loaded();function loaded(){timeout&&clearTimeout(timeout),increment(),_assets.length&&loadAsset()}get(Assets.getPath(path),Assets.HEADERS).then(data=>{Assets.__loaded.push(path),"json"==ext&&ASSETS.JSON.push(name,data),"svg"==ext&&(ASSETS.SVG[name]=data),"fnt"==ext&&(ASSETS.SDF[name.split("/")[1]]=data),"js"==ext&&window.eval(data),ext.includes(["fs","vs","glsl"])&&window.Shaders&&Shaders.parse(data,path),loaded()}).catch(e=>{console.warn(e),loaded()})}function increment(){let percent=Math.max(_lastFiredPercent,Math.min(1,++_loaded/_total));_this.events.fire(Events.PROGRESS,{percent:percent}),_lastFiredPercent=percent,_loaded>=_total&&defer(complete)}function complete(){_this.completed||(_this.completed=!0,defer(()=>{_callback&&_callback(),_this.events.fire(Events.COMPLETE)}))}function timedOut(path){console.warn("Asset timed out",path)}!function(){if(!Array.isArray(_assets))throw"AssetLoader requires array of assets to load";_assets=_assets.slice(0).reverse(),function init(){if(!_assets.length)return complete();for(let i=0;i<AssetLoader.SPLIT;i++)_assets.length&&loadAsset()}()}(),this.loadModules=function(){if(!window._BUILT_||window.AURA)return;this.add(1);let module=window._ES5_?"es5-modules":"modules",s=document.createElement("script");return s.src="assets/js/"+module+".js?"+window._CACHE_,s.async=!0,document.head.appendChild(s),AssetLoader.waitForLib("_MODULES_").then(_=>_this.trigger(1))},this.add=function(num){_total+=num||1},this.trigger=function(num){for(let i=0;i<(num||1);i++)increment()}}),()=>{AssetLoader.SPLIT=2,AssetLoader.TIMEOUT=5e3,AssetLoader.loadAllAssets=function(callback){let promise=Promise.create();return callback||(callback=promise.resolve),promise.loader=new AssetLoader(Assets.list(),()=>{callback&&callback(),promise.loader&&promise.loader.destroy&&(promise.loader=promise.loader.destroy())}),promise},AssetLoader.loadAssets=function(list,callback){let promise=Promise.create();return callback||(callback=promise.resolve),promise.loader=new AssetLoader(list,()=>{callback&&callback(),promise.loader&&promise.loader.destroy&&(promise.loader=promise.loader.destroy())}),promise},AssetLoader.waitForLib=function(name,callback){let promise=Promise.create();return callback||(callback=promise.resolve),Render.start((function check(){window[name]&&(Render.stop(check),callback&&callback())})),promise},AssetLoader.waitForModules=function(){return AssetLoader.waitForLib(window._BUILT_?"_MODULES_":"zUtils3D")}}),Hydra.ready((function(){window.__window=$(window),window.__document=$(document),window.__body=$(document.getElementsByTagName("body")[0]),window.Stage=window.Stage&&window.Stage.style?$(window.Stage):__body.create("#Stage"),Stage.size("100%"),Stage.__useFragment=!0,Stage.width=window.innerWidth||document.body.clientWidth||document.documentElement.offsetWidth,Stage.height=window.innerHeight||document.body.clientHeight||document.documentElement.offsetHeight})),Class((function CSS(){var _obj,_style,_needsUpdate,_this=this;function objToCSS(key){var match=key.match(/[A-Z]/),camelIndex=match?match.index:null;if(camelIndex){var start=key.slice(0,camelIndex),end=key.slice(camelIndex);key=start+"-"+end.toLowerCase()}return key}function cssToObj(key){var match=key.match(/\-/),camelIndex=match?match.index:null;if(camelIndex){var start=key.slice(0,camelIndex),end=key.slice(camelIndex).slice(1),letter=end.charAt(0);end=end.slice(1),key=start+(end=letter.toUpperCase()+end)}return key}function setHTML(){_obj.innerHTML=_style,_needsUpdate=!1}Hydra.ready((function(){_style="",(_obj=document.createElement("style")).type="text/css",document.getElementsByTagName("head")[0].appendChild(_obj)})),this._read=function(){return _style},this._write=function(css){_style=css,_needsUpdate||(_needsUpdate=!0,defer(setHTML))},this.style=function(selector,obj){var s=selector+" {";for(var key in obj){var prop=objToCSS(key),val=obj[key];"string"!=typeof val&&"opacity"!=key&&(val+="px"),s+=prop+":"+val+"!important;"}s+="}",_this._write(_style+s)},this.get=function(selector,prop){for(var values=new Object,string=_obj.innerHTML.split(selector+" {"),i=0;i<string.length;i++){var str=string[i];if(str.length){var split=str.split("!important;");for(var j in split)if(split[j].includes(":")){var fsplit=split[j].split(":");"px"==fsplit[1].slice(-2)&&(fsplit[1]=Number(fsplit[1].slice(0,-2))),values[cssToObj(fsplit[0])]=fsplit[1]}}}return prop?values[prop]:values},this.textSize=function($obj){var $clone=$obj.clone();$clone.css({position:"relative",cssFloat:"left",styleFloat:"left",marginTop:-99999,width:"",height:""}),__body.addChild($clone);var width=$clone.div.offsetWidth,height=$clone.div.offsetHeight;return $clone.remove(),{width:width,height:height}},this.prefix=function(style){return""==_this.styles.vendor?style.charAt(0).toLowerCase()+style.slice(1):_this.styles.vendor+style},this._toCSS=objToCSS}),"Static"),Class((function HydraObject(_selector,_type,_exists,_useFragment){this._children=new LinkedList,this.__useFragment=_useFragment,this._initSelector(_selector,_type,_exists)}),()=>{var prototype=HydraObject.prototype;prototype._initSelector=function(_selector,_type,_exists){if(_selector&&"string"!=typeof _selector)this.div=_selector;else{var first=_selector?_selector.charAt(0):null,name=_selector?_selector.slice(1):null;if("."!=first&&"#"!=first&&(name=_selector,first="."),_exists){if("#"!=first)throw"Hydra Selectors Require #ID";this.div=document.getElementById(name)}else this._type=_type||"div","svg"==this._type?(this.div=document.createElementNS("http://www.w3.org/2000/svg",this._type),this.div.setAttributeNS("http://www.w3.org/2000/xmlns/","xmlns:xlink","http://www.w3.org/1999/xlink")):(this.div=document.createElement(this._type),first&&("#"==first?this.div.id=name:this.div.className=name))}this.div.hydraObject=this},prototype.add=function(child){var div=this.div,_this=this,createFrag=function(){_this.__useFragment&&(_this._fragment||(_this._fragment=document.createDocumentFragment(),defer((function(){if(!_this._fragment||!_this.div)return _this._fragment=null;_this.div.appendChild(_this._fragment),_this._fragment=null}))),div=_this._fragment)};return child.element&&child.element instanceof HydraObject?(createFrag(),div.appendChild(child.element.div),this._children.push(child.element),child.element._parent=this,child.element.div.parentNode=this.div):child.div?(createFrag(),div.appendChild(child.div),this._children.push(child),child._parent=this,child.div.parentNode=this.div):child.nodeName&&(createFrag(),div.appendChild(child),child.parentNode=this.div),this},prototype.clone=function(){return $(this.div.cloneNode(!0))},prototype.create=function(name,type){var $obj=$(name,type);return this.add($obj),$obj},prototype.empty=function(){for(var child=this._children.start();child;)child&&child.remove&&child.remove(),child=this._children.next();return this.div.innerHTML="",this},prototype.parent=function(){return this._parent},prototype.children=function(){return this.div.children?this.div.children:this.div.childNodes},prototype.removeChild=function(object,keep){try{object.div.parentNode.removeChild(object.div)}catch(e){}keep||this._children.remove(object)},prototype.remove=prototype.destroy=function(){this.removed=!0;var parent=this._parent;parent&&!parent.removed&&parent.removeChild&&parent.removeChild(this,!0);for(var child=this._children.start();child;)child&&child.remove&&child.remove(),child=this._children.next();this._children.destroy(),this.div.hydraObject=null,Utils.nullObject(this)},window.$=function(selector,type,exists){return new HydraObject(selector,type,exists)},$.fn=HydraObject.prototype}),$.fn.text=function(text){return void 0!==text?(this.__cacheText!=text&&(this.div.textContent=text),this.__cacheText=text,this):this.div.textContent},$.fn.html=function(text,force){return!text||text.includes("<")||force?void 0!==text?(this.div.innerHTML=text,this):this.div.innerHTML:this.text(text)},$.fn.hide=function(){return this.div.style.display="none",this},$.fn.show=function(){return this.div.style.display="",this},$.fn.visible=function(){return this.div.style.visibility="visible",this},$.fn.invisible=function(){return this.div.style.visibility="hidden",this},$.fn.setZ=function(z){return this.div.style.zIndex=z,this},$.fn.clearAlpha=function(){return this.div.style.opacity="",this},$.fn.size=function(w,h,noScale){return"string"==typeof w?(void 0===h?h="100%":"string"!=typeof h&&(h+="px"),this.div.style.width=w,this.div.style.height=h):(this.div.style.width=w+"px",this.div.style.height=h+"px",noScale||(this.div.style.backgroundSize=w+"px "+h+"px")),this.width=w,this.height=h,this},$.fn.mouseEnabled=function(bool){return this.div.style.pointerEvents=bool?"auto":"none",this},$.fn.fontStyle=function(family,size,color,style){var font={};return family&&(font.fontFamily=family),size&&(font.fontSize=size),color&&(font.color=color),style&&(font.fontStyle=style),this.css(font),this},$.fn.font=function(font){return this.css("font",font),this},$.fn.bg=function(src,x,y,repeat){return src?(src.includes(".")&&(src=Assets.getPath(src)),src.includes(".")?this.div.style.backgroundImage="url("+src+")":this.div.style.backgroundColor=src,void 0!==x&&(x="number"==typeof x?x+"px":x,y="number"==typeof y?y+"px":y,this.div.style.backgroundPosition=x+" "+y),repeat&&(this.div.style.backgroundSize="",this.div.style.backgroundRepeat=repeat),"cover"!=x&&"contain"!=x||(this.div.style.backgroundSize=x,this.div.style.backgroundPosition=void 0!==y?y+" "+repeat:"center"),this):this},$.fn.center=function(x,y,noPos){var css={};return void 0===x?(css.left="50%",css.top="50%",css.marginLeft=-this.width/2,css.marginTop=-this.height/2):(x&&(css.left="50%",css.marginLeft=-this.width/2),y&&(css.top="50%",css.marginTop=-this.height/2)),noPos&&(delete css.left,delete css.top),this.css(css),this},$.fn.max=function(width,height){let w,h;return void 0!==width&&(w="number"==typeof width?width+"px":width,this.div.style.maxWidth=w),void 0!==height?(h="number"==typeof height?height+"px":height,this.div.style.maxHeight=h):(h=w,this.div.style.maxHeight=h),this},$.fn.min=function(width,height){let w,h;return void 0!==width&&(w="number"==typeof width?width+"px":width,this.div.style.minWidth=w),void 0!==height?(h="number"==typeof height?height+"px":height,this.div.style.minHeight=h):(h=w,this.div.style.minHeight=h),this},$.fn.flex=function(inline){return this.div.style.display=inline?"inline-flex":"flex",this.div.style.justifyContent="center",this.div.style.alignItems="center",this.div.classList.add("relative-children"),this},$.fn.order=function(opts={}){let s=this.div.style;return"none"===opts.flexWrap&&(opts.flexWrap="nowrap"),opts.direction&&(s.flexDirection=opts.direction),opts.wrap&&(s.flexWrap=opts.wrap),opts.order&&(s.order=opts.order),this},$.fn.align=function(opts={}){let s=this.div.style;function flex(str,contentMode=!1){return"start"===str?"flex-start":"end"===str?"flex-end":"between"===str?contentMode?"space-between":"flex-between":"around"===str?contentMode?"space-around":"flex-around":"none"===str?"nowrap":str}return opts.justify&&(s.justifyContent=flex(opts.justify)),opts.items&&(s.alignItems=flex(opts.items)),opts.self&&(s.alignSelf=flex(opts.self)),opts.content&&(s.alignContent=flex(opts.content,!0)),this},$.fn.flexibility=function(opts={}){let s=this.div.style;return"undefined"!==opts.grow&&(s.flexGrow=opts.grow),"undefined"!==opts.shrink&&(s.flexGrow=opts.shrink),void 0!==opts.basis&&(s.flexBasis="number"==typeof opts.basis?opts.basis+"px":opts.basis),this},$.fn.mask=function(arg){let maskPrefix="Moz"===CSS.styles.vendor?"mask":CSS.prefix("Mask");return this.div.style[maskPrefix]=(arg.includes(".")?"url("+arg+")":arg)+" no-repeat",this.div.style[maskPrefix+"Size"]="contain",this},$.fn.blendMode=function(mode,bg){return bg?this.div.style["background-blend-mode"]=mode:this.div.style["mix-blend-mode"]=mode,this},$.fn.css=function(obj,value){if("boolean"==typeof value&&(value=null),"object"!=typeof obj){if(value)return this.div.style[obj]=value,this;var style=this.div.style[obj];if("number"!=typeof style){if(!style)return!1;style.includes("px")&&(style=Number(style.slice(0,-2))),"opacity"==obj&&(style=isNaN(Number(this.div.style.opacity))?1:Number(this.div.style.opacity))}return style||(style=0),style}for(var type in TweenManager._clearCSSTween(this),obj){var val=obj[type];"string"!=typeof val&&"number"!=typeof val||("string"!=typeof val&&"opacity"!=type&&"zIndex"!=type&&(val+="px"),this.div.style[type]=val)}return this},$.fn.transform=function(props){if(!(this.multiTween&&this.cssTweens&&this._cssTweens.length>1&&this.__transformTime&&Render.TIME-this.__transformTime<15)){if(this.__transformTime=Render.TIME,TweenManager._clearCSSTween(this),Device.tween.css2d){if(props)for(var key in props)"number"==typeof props[key]&&(this[key]=props[key]);else props=this;var transformString=TweenManager._parseTransform(props);this.__transformCache!=transformString&&(this.div.style[CSS.styles.vendorTransform]=transformString,this.__transformCache=transformString)}return this}},$.fn.willChange=function(props){if("boolean"==typeof props)this._willChangeLock=!0===props;else if(this._willChangeLock)return;var string="string"==typeof props;this._willChange&&!string||"null"==typeof props?(this._willChange=!1,this.div.style["will-change"]=""):(this._willChange=!0,this.div.style["will-change"]=string?props:CSS.transformProperty+", opacity")},$.fn.backfaceVisibility=function(visible){this.div.style[CSS.prefix("BackfaceVisibility")]=visible?"visible":"hidden"},$.fn.enable3D=function(perspective,x,y){return Device.tween.css3d?(this.div.style[CSS.prefix("TransformStyle")]="preserve-3d",perspective&&(this.div.style[CSS.prefix("Perspective")]=perspective+"px"),void 0!==x&&(x="number"==typeof x?x+"px":x,y="number"==typeof y?y+"px":y,this.div.style[CSS.prefix("PerspectiveOrigin")]=x+" "+y),this):this},$.fn.disable3D=function(){return this.div.style[CSS.prefix("TransformStyle")]="",this.div.style[CSS.prefix("Perspective")]="",this},$.fn.transformPoint=function(x,y,z){var origin="";return void 0!==x&&(origin+="number"==typeof x?x+"px ":x+" "),void 0!==y&&(origin+="number"==typeof y?y+"px ":y+" "),void 0!==z&&(origin+="number"==typeof z?z+"px":z),this.div.style[CSS.prefix("TransformOrigin")]=origin,this},$.fn.tween=function(props,time,ease,delay,callback,manual){"boolean"==typeof delay?(manual=delay,delay=0,callback=null):"function"==typeof delay&&(callback=delay,delay=0),"boolean"==typeof callback&&(manual=callback,callback=null),delay||(delay=0);var usePromise=null;callback&&callback instanceof Promise&&(usePromise=callback,callback=callback.resolve);var tween=TweenManager._detectTween(this,props,time,ease,delay,callback,manual);return usePromise||tween},$.fn.clearTransform=function(){return"number"==typeof this.x&&(this.x=0),"number"==typeof this.y&&(this.y=0),"number"==typeof this.z&&(this.z=0),"number"==typeof this.scale&&(this.scale=1),"number"==typeof this.scaleX&&(this.scaleX=1),"number"==typeof this.scaleY&&(this.scaleY=1),"number"==typeof this.rotation&&(this.rotation=0),"number"==typeof this.rotationX&&(this.rotationX=0),"number"==typeof this.rotationY&&(this.rotationY=0),"number"==typeof this.rotationZ&&(this.rotationZ=0),"number"==typeof this.skewX&&(this.skewX=0),"number"==typeof this.skewY&&(this.skewY=0),this.div.style[CSS.styles.vendorTransform]="",this},$.fn.clearTween=function(){return this._cssTween&&this._cssTween.stop(),this._mathTween&&this._mathTween.stop(),this},$.fn.stopTween=function(){return console.warn(".stopTween deprecated. use .clearTween instead"),this.clearTween()},$.fn.keypress=function(callback){this.div.onkeypress=function(e){(e=e||window.event).code=e.keyCode?e.keyCode:e.charCode,callback&&callback(e)}},$.fn.keydown=function(callback){this.div.onkeydown=function(e){(e=e||window.event).code=e.keyCode,callback&&callback(e)}},$.fn.keyup=function(callback){this.div.onkeyup=function(e){(e=e||window.event).code=e.keyCode,callback&&callback(e)}},$.fn.attr=function(attr,value){if(attr&&value)""==value?this.div.removeAttribute(attr):this.div.setAttribute(attr,value);else if(attr)return this.div.getAttribute(attr);return this},$.fn.val=function(value){return void 0===value?this.div.value:(this.div.value=value,this)},$.fn.change=function(callback){var _this=this;"select"==this._type&&(this.div.onchange=function(){callback({object:_this,value:_this.div.value||""})})},$.fn.svgSymbol=function(id,width,height){var config=SVG.getSymbolConfig(id),svgHTML='<svg viewBox="0 0 '+config.width+" "+config.height+'" width="'+width+'" height="'+height+'"><use xlink:href="#'+config.id+'" x="0" y="0" /></svg>';this.html(svgHTML,!0)},$.fn.overflowScroll=function(dir){var x=!!dir.x,y=!!dir.y,overflow={};(!x&&!y||x&&y)&&(overflow.overflow="auto"),!x&&y&&(overflow.overflowY="auto",overflow.overflowX="hidden"),x&&!y&&(overflow.overflowX="auto",overflow.overflowY="hidden"),Device.mobile&&(overflow["-webkit-overflow-scrolling"]="touch",Mobile._addOverflowScroll(this)),this.css(overflow)},$.fn.removeOverflowScroll=function(){this.css({overflow:"hidden",overflowX:"",overflowY:"","-webkit-overflow-scrolling":""}),Device.mobile&&Mobile._removeOverflowScroll(this)},$.fn.accessible=function(type="label",tabIndex=-1){switch(tabIndex>-1&&this.attr("tabindex",tabIndex),type){case"label":this.attr("aria-label",this.div.textContent);break;case"hidden":this.attr("aria-hidden",!0)}},$.fn.tabIndex=function(tabIndex){this.attr("tabindex",tabIndex)},function(){var windowsPointer=!!window.MSGesture,translateEvent=function(evt){if(windowsPointer)switch(evt){case"touchstart":return"pointerdown";case"touchmove":return"MSGestureChange";case"touchend":return"pointerup"}return evt},convertTouchEvent=function(e){var touchEvent={x:0,y:0};if(e.windowsPointer)return e;if(!e)return touchEvent;if(e.touches||e.changedTouches?e.touches.length?(touchEvent.x=e.touches[0].pageX,touchEvent.y=e.touches[0].pageY):(touchEvent.x=e.changedTouches[0].pageX,touchEvent.y=e.changedTouches[0].pageY):(touchEvent.x=e.pageX,touchEvent.y=e.pageY),Mobile.ScreenLock&&Mobile.ScreenLock.isActive&&Mobile.orientationSet&&Mobile.orientation!==Mobile.orientationSet){if(90==window.orientation||0===window.orientation){var x=touchEvent.y;touchEvent.y=touchEvent.x,touchEvent.x=Stage.width-x}if(-90==window.orientation||180===window.orientation){var y=touchEvent.x;touchEvent.x=touchEvent.y,touchEvent.y=Stage.height-y}}return touchEvent};$.fn.click=function(callback){var _this=this;return this.div.addEventListener(translateEvent("click"),(function click(e){return!!_this.div&&(!Mouse._preventClicks&&(e.object="hit"==_this.div.className?_this.parent():_this,e.action="click",e.pageX||(e.pageX=e.clientX,e.pageY=e.clientY),callback&&callback(e),void(Mouse.autoPreventClicks&&Mouse.preventClicks())))}),!0),this.div.style.cursor="pointer",this},$.fn.hover=function(callback){var _time,_this=this,_over=!1;function hover(e){if(!_this.div)return!1;var time=performance.now(),original=e.toElement||e.relatedTarget;if(_time&&time-_time<5)return _time=time,!1;switch(_time=time,e.object="hit"==_this.div.className?_this.parent():_this,e.type){case"mouseout":case"mouseleave":e.action="out";break;default:e.action="over"}if(_over){if(Mouse._preventClicks)return!1;if("over"==e.action)return!1;if("out"==e.action&&function isAChild(div,object){for(var len=div.children.length-1,i=len;i>-1;i--)if(object==div.children[i])return!0;for(i=len;i>-1;i--)if(isAChild(div.children[i],object))return!0}(_this.div,original))return!1;_over=!1}else{if("out"==e.action)return!1;_over=!0}e.pageX||(e.pageX=e.clientX,e.pageY=e.clientY),callback&&callback(e)}return this.div.addEventListener(translateEvent("mouseover"),hover,!0),this.div.addEventListener(translateEvent("mouseout"),hover,!0),this},$.fn.press=function(callback){var _this=this;function press(e){if(!_this.div)return!1;switch(e.object="hit"==_this.div.className?_this.parent():_this,e.type){case"mousedown":e.action="down";break;default:e.action="up"}e.pageX||(e.pageX=e.clientX,e.pageY=e.clientY),callback&&callback(e)}return this.div.addEventListener(translateEvent("mousedown"),press,!0),this.div.addEventListener(translateEvent("mouseup"),press,!0),this},$.fn.bind=function(evt,callback){if(this._events=this._events||{},windowsPointer&&this==__window)return Stage.bind(evt,callback);"touchstart"==evt?Device.mobile||(Device.touchCapable?this.bind("mousedown",callback):evt="mousedown"):"touchmove"==evt?(Device.mobile||(Device.touchCapable?this.bind("mousemove",callback):evt="mousemove"),windowsPointer&&!this.div.msGesture&&(this.div.msGesture=new MSGesture,this.div.msGesture.target=this.div)):"touchend"==evt&&(Device.mobile||(Device.touchCapable?this.bind("mouseup",callback):evt="mouseup")),this._events["bind_"+evt]=this._events["bind_"+evt]||[];var _events=this._events["bind_"+evt],e={},target=this.div;function touchEvent(e){windowsPointer&&target.msGesture&&"touchstart"==evt&&target.msGesture.addPointer(e.pointerId),Device.mobile||"touchstart"!=evt||e.preventDefault();var touch=convertTouchEvent(e);if(windowsPointer){var windowsEvt=e;(e={}).x=Number(windowsEvt.pageX||windowsEvt.clientX),e.y=Number(windowsEvt.pageY||windowsEvt.clientY),e.target=windowsEvt.target,e.currentTarget=windowsEvt.currentTarget,e.path=[];for(var node=e.target;node;)e.path.push(node),node=node.parentElement||null;e.windowsPointer=!0}else e.x=touch.x,e.y=touch.y;for(var i=0;i<_events.length;i++){var ev=_events[i];ev.target==e.currentTarget&&ev.callback(e)}}return e.callback=callback,e.target=this.div,_events.push(e),this._events["fn_"+evt]||(this._events["fn_"+evt]=touchEvent,this.div.addEventListener(translateEvent(evt),touchEvent,{capture:!0,passive:!1})),this},$.fn.unbind=function(evt,callback){if(this._events=this._events||{},windowsPointer&&this==__window)return Stage.unbind(evt,callback);"touchstart"==evt?Device.mobile||(Device.touchCapable?this.unbind("mousedown",callback):evt="mousedown"):"touchmove"==evt?Device.mobile||(Device.touchCapable?this.unbind("mousemove",callback):evt="mousemove"):"touchend"==evt&&(Device.mobile||(Device.touchCapable?this.unbind("mouseup",callback):evt="mouseup"));var _events=this._events["bind_"+evt];if(!_events)return this;for(var i=0;i<_events.length;i++){_events[i].callback==callback&&_events.splice(i,1)}return this._events["fn_"+evt]&&!_events.length&&(this.div.removeEventListener(translateEvent(evt),this._events["fn_"+evt],!Device.mobile||{passive:!0}),this._events["fn_"+evt]=null),this},$.fn.interact=function(overCallback,clickCallback,seoLink,seoText){this.hit||(this.hit=$(".hit",seoLink?"a":void 0),this.hit.css({width:"100%",height:"100%",zIndex:99999,top:0,left:0,position:"absolute"}),this.add(this.hit),seoLink&&(this.hit.attr("href",Hydra.absolutePath(seoLink)),this.hit.text(seoText||this.div.textContent),this.hit.css({fontSize:0}),this.hit.accessible(),this.hit.div.onfocus=_=>overCallback({action:"over"}),this.hit.div.onblur=_=>overCallback({action:"out"}),this.hit.div.onclick=e=>{e.preventDefault(),clicked(e)}));let time=Render.TIME;function clicked(e){clickCallback&&Render.TIME-time>100&&clickCallback(e),time=Render.TIME}Device.mobile?this.hit.touchClick(overCallback,clicked).click(clicked):this.hit.hover(overCallback).click(clicked)},$.fn.touchSwipe=function(callback,distance){if(!window.addEventListener)return this;var _startX,_startY,_this=this,_distance=distance||75,_moving=!1,_move={};function touchMove(e){if(!_this.div)return!1;if(_moving){var touch=convertTouchEvent(e),dx=_startX-touch.x,dy=_startY-touch.y;_move.direction=null,_move.moving=null,_move.x=null,_move.y=null,_move.evt=e,Math.abs(dx)>=_distance?(touchEnd(),_move.direction=dx>0?"left":"right"):Math.abs(dy)>=_distance?(touchEnd(),_move.direction=dy>0?"up":"down"):(_move.moving=!0,_move.x=dx,_move.y=dy),callback&&callback(_move,e)}}function touchEnd(e){if(!_this.div)return!1;_startX=_startY=_moving=!1,_this.div.removeEventListener(translateEvent("touchmove"),touchMove)}return Device.mobile&&(this.div.addEventListener(translateEvent("touchstart"),(function touchStart(e){var touch=convertTouchEvent(e);if(!_this.div)return!1;1==e.touches.length&&(_startX=touch.x,_startY=touch.y,_moving=!0,_this.div.addEventListener(translateEvent("touchmove"),touchMove,{passive:!0}))}),{passive:!0}),this.div.addEventListener(translateEvent("touchend"),touchEnd,{passive:!0}),this.div.addEventListener(translateEvent("touchcancel"),touchEnd,{passive:!0})),this},$.fn.touchClick=function(hover,click){if(!window.addEventListener)return this;var _time,_move,_this=this,_start={},_touch={};function setTouch(e){var touch=convertTouchEvent(e);e.touchX=touch.x,e.touchY=touch.y,_start.x=e.touchX,_start.y=e.touchY}return Device.mobile&&(this.div.addEventListener(translateEvent("touchstart"),(function touchStart(e){if(!_this.div)return!1;_time=performance.now(),e.action="over",e.object="hit"==_this.div.className?_this.parent():_this,setTouch(e),hover&&!_move&&hover(e)}),{passive:!0}),this.div.addEventListener(translateEvent("touchend"),(function touchEnd(e){if(!_this.div)return!1;var time=performance.now();if(_touch=convertTouchEvent(e),_move=function findDistance(p1,p2){var dx=p2.x-p1.x,dy=p2.y-p1.y;return Math.sqrt(dx*dx+dy*dy)}(_start,_touch)>5,e.object="hit"==_this.div.className?_this.parent():_this,setTouch(e),_time&&time-_time<750){if(Mouse._preventClicks)return!1;click&&!_move&&(!0,e.action="click",click&&!_move&&click(e),Mouse.autoPreventClicks&&Mouse.preventClicks())}hover&&(e.action="out",Mouse._preventFire||hover(e));_move=!1}),{passive:!0})),this}}(),Class((function Element(type="div"){Inherit(this,Component);var name=Utils.getConstructorName(this);this.__element=!0,this.element=$("."+name,type),this.element.__useFragment=!0,this.destroy=function(){this.element&&this.element.remove&&(this.element=this.element.remove()),this._destroy&&this._destroy()}})),Hydra.ready(()=>{TweenManager.Transforms=["scale","scaleX","scaleY","x","y","z","rotation","rotationX","rotationY","rotationZ","skewX","skewY","perspective"],TweenManager.CubicEases=[{name:"easeOutCubic",curve:"cubic-bezier(0.215, 0.610, 0.355, 1.000)"},{name:"easeOutQuad",curve:"cubic-bezier(0.250, 0.460, 0.450, 0.940)"},{name:"easeOutQuart",curve:"cubic-bezier(0.165, 0.840, 0.440, 1.000)"},{name:"easeOutQuint",curve:"cubic-bezier(0.230, 1.000, 0.320, 1.000)"},{name:"easeOutSine",curve:"cubic-bezier(0.390, 0.575, 0.565, 1.000)"},{name:"easeOutExpo",curve:"cubic-bezier(0.190, 1.000, 0.220, 1.000)"},{name:"easeOutCirc",curve:"cubic-bezier(0.075, 0.820, 0.165, 1.000)"},{name:"easeOutBack",curve:"cubic-bezier(0.175, 0.885, 0.320, 1.275)"},{name:"easeInCubic",curve:"cubic-bezier(0.550, 0.055, 0.675, 0.190)"},{name:"easeInQuad",curve:"cubic-bezier(0.550, 0.085, 0.680, 0.530)"},{name:"easeInQuart",curve:"cubic-bezier(0.895, 0.030, 0.685, 0.220)"},{name:"easeInQuint",curve:"cubic-bezier(0.755, 0.050, 0.855, 0.060)"},{name:"easeInSine",curve:"cubic-bezier(0.470, 0.000, 0.745, 0.715)"},{name:"easeInCirc",curve:"cubic-bezier(0.600, 0.040, 0.980, 0.335)"},{name:"easeInBack",curve:"cubic-bezier(0.600, -0.280, 0.735, 0.045)"},{name:"easeInOutCubic",curve:"cubic-bezier(0.645, 0.045, 0.355, 1.000)"},{name:"easeInOutQuad",curve:"cubic-bezier(0.455, 0.030, 0.515, 0.955)"},{name:"easeInOutQuart",curve:"cubic-bezier(0.770, 0.000, 0.175, 1.000)"},{name:"easeInOutQuint",curve:"cubic-bezier(0.860, 0.000, 0.070, 1.000)"},{name:"easeInOutSine",curve:"cubic-bezier(0.445, 0.050, 0.550, 0.950)"},{name:"easeInOutExpo",curve:"cubic-bezier(1.000, 0.000, 0.000, 1.000)"},{name:"easeInOutCirc",curve:"cubic-bezier(0.785, 0.135, 0.150, 0.860)"},{name:"easeInOutBack",curve:"cubic-bezier(0.680, -0.550, 0.265, 1.550)"},{name:"easeInOut",curve:"cubic-bezier(.42,0,.58,1)"},{name:"linear",curve:"linear"}],TweenManager.useCSSTrans=function(props,ease,object){return!(props.math||"string"==typeof ease&&ease.includes(["Elastic","Bounce"])||object.multiTween||TweenManager._inspectEase(ease).path||!Device.tween.transition)},TweenManager._detectTween=function(object,props,time,ease,delay,callback){return TweenManager.useCSSTrans(props,ease,object)?new CSSTransition(object,props,time,ease,delay,callback):new FrameTween(object,props,time,ease,delay,callback)},TweenManager._parseTransform=function(props){var transforms="",translate="";if(props.perspective>0&&(transforms+="perspective("+props.perspective+"px)"),void 0!==props.x||void 0!==props.y||void 0!==props.z){var x=props.x||0,y=props.y||0,z=props.z||0;translate+=x+("string"==typeof props.x&&(props.x.includes("%")||props.x.includes("vw")||props.x.includes("vh"))?"":"px")+", ",translate+=y+("string"==typeof props.y&&(props.y.includes("%")||props.y.includes("vw")||props.y.includes("vh"))?"":"px"),Device.tween.css3d?transforms+="translate3d("+(translate+=", "+z+"px")+")":transforms+="translate("+translate+")"}return void 0!==props.scale?transforms+="scale("+props.scale+")":(void 0!==props.scaleX&&(transforms+="scaleX("+props.scaleX+")"),void 0!==props.scaleY&&(transforms+="scaleY("+props.scaleY+")")),void 0!==props.rotation&&(transforms+="rotate("+props.rotation+"deg)"),void 0!==props.rotationX&&(transforms+="rotateX("+props.rotationX+"deg)"),void 0!==props.rotationY&&(transforms+="rotateY("+props.rotationY+"deg)"),void 0!==props.rotationZ&&(transforms+="rotateZ("+props.rotationZ+"deg)"),void 0!==props.skewX&&(transforms+="skewX("+props.skewX+"deg)"),void 0!==props.skewY&&(transforms+="skewY("+props.skewY+"deg)"),transforms},TweenManager._clearCSSTween=function(obj){obj&&!obj._cssTween&&obj.div._transition&&!obj.persistTween&&(obj.div.style[CSS.styles.vendorTransition]="",obj.div._transition=!1,obj._cssTween=null)},TweenManager._isTransform=function(key){return TweenManager.Transforms.indexOf(key)>-1},TweenManager._getAllTransforms=function(object){for(var obj={},i=TweenManager.Transforms.length-1;i>-1;i--){var tf=TweenManager.Transforms[i],val=object[tf];0!==val&&"number"==typeof val&&(obj[tf]=val)}return obj};const prefix=function(){let pre="",dom="";try{var styles=window.getComputedStyle(document.documentElement,"");return pre=(Array.prototype.slice.call(styles).join("").match(/-(moz|webkit|ms)-/)||""===styles.OLink&&["","o"])[1],dom="WebKit|Moz|MS|O".match(new RegExp("("+pre+")","i"))[1],{unprefixed:"ie"==Device.system.browser&&!Device.detect("msie 9"),dom:dom,lowercase:pre,css:"-"+pre+"-",js:("ie"==Device.system.browser?pre[0]:pre[0].toUpperCase())+pre.substr(1)}}catch(e){return{unprefixed:!0,dom:"",lowercase:"",css:"",js:""}}}();CSS.styles={},CSS.styles.vendor=prefix.unprefixed?"":prefix.js,CSS.styles.vendorTransition=CSS.styles.vendor.length?CSS.styles.vendor+"Transition":"transition",CSS.styles.vendorTransform=CSS.styles.vendor.length?CSS.styles.vendor+"Transform":"transform",CSS.vendor=prefix.css,CSS.transformProperty=function(){switch(prefix.lowercase){case"moz":return"-moz-transform";case"webkit":return"-webkit-transform";case"o":return"-o-transform";case"ms":return"-ms-transform";default:return"transform"}}(),CSS.tween={},CSS.tween.complete=prefix.unprefixed?"transitionend":prefix.lowercase+"TransitionEnd"}),Class((function CSSTransition(_object,_props,_time,_ease,_delay,_callback){const _this=this;let _transformProps,_transitionProps;function killed(){return!_this||_this.kill||!_object||!_object.div}function clearCSSTween(){killed()||(_this.playing=!1,_object._cssTween=null,_object.willChange(null),_object=_props=null,Utils.nullObject(this))}this.playing=!0,function(){if("number"!=typeof _time)throw"CSSTween Requires object, props, time, ease";!function initProperties(){var transform=TweenManager._getAllTransforms(_object),properties=[];for(var key in _props)TweenManager._isTransform(key)?(transform.use=!0,transform[key]=_props[key],delete _props[key]):("number"==typeof _props[key]||key.includes(["-","color"]))&&properties.push(key);transform.use&&(properties.push(CSS.transformProperty),delete transform.use);_transformProps=transform,_transitionProps=properties}(),async function initCSSTween(values){if(killed())return;_object._cssTween&&(_object._cssTween.kill=!0);_object._cssTween=_this,_object.div._transition=!0;var strings=function buildStrings(time,ease,delay){for(var props="",str="",len=_transitionProps.length,i=0;i<len;i++){var transitionProp=_transitionProps[i];props+=(props.length?", ":"")+transitionProp,str+=(str.length?", ":"")+transitionProp+" "+time+"ms "+TweenManager._getEase(ease)+" "+delay+"ms"}return{props:props,transition:str}}(_time,_ease,_delay);_object.willChange(strings.props);var time=values?values.time:_time,delay=values?values.delay:_delay,props=values?values.props:_props,transformProps=values?values.transform:_transformProps;if(_this.time=_time,_this.delay=_delay,await defer(),await defer(),killed())return;if(_object.div.style[CSS.styles.vendorTransition]=strings.transition,_this.playing=!0,"safari"==Device.system.browser){if(Device.system.browserVersion<11&&await defer(),killed())return;_object.css(props),_object.transform(transformProps)}else _object.css(props),_object.transform(transformProps);Timer.create((function(){killed()||(clearCSSTween(),_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve())}),time+delay)}()}(),this.stop=function(){this.playing&&(this.kill=!0,this.playing=!1,_object.div.style[CSS.styles.vendorTransition]="",_object.div._transition=!1,_object.willChange(null),_object._cssTween=null,Utils.nullObject(this))},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise=Promise.create(),_this.completePromise}})),Class((function FrameTween(_object,_props,_time,_ease,_delay,_callback,_manual){var _endValues,_transformEnd,_transformStart,_startValues,_isTransform,_isCSS,_transformProps,_cssTween,_transformTween,_update,_this=this;function copy(obj){let newObj={};for(let key in obj)"number"==typeof obj[key]&&(newObj[key]=obj[key]);return newObj}function clear(){_object._cssTweens&&_object._cssTweens.remove(_this),_this.playing=!1,_object._cssTween=null,_object=_props=null}function update(){if(!function killed(){return _this.kill||!_object||!_object.div}()){if(_isCSS&&_object.css(_props),_isTransform)if(_object.multiTween){for(var key in _transformProps)"number"==typeof _transformProps[key]&&(_object[key]=_transformProps[key]);_object.transform()}else _object.transform(_transformProps);_update&&_update()}}function tweenComplete(){_this.playing&&(clear(),_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve())}this.playing=!0,_this.object=_object,_this.props=_props,_this.time=_time,_this.ease=_ease,_this.delay=_delay,defer((function(){if(_this.overrideValues){let values=_this.overrideValues(_this,_object,_props,_time,_ease,_delay);values&&(_this.props=_props=values.props||_props,_this.time=_time=values.time||_time,_this.ease=_ease=values.ease||_ease,_this.delay=_delay=values.delay||_delay)}if("object"==typeof _ease&&(_ease="easeOutCubic"),_object&&_props){if(_this.object=_object,"number"!=typeof _time)throw"FrameTween Requires object, props, time, ease";!function initValues(){_props.math&&delete _props.math;Device.tween.transition&&_object.div._transition&&(_object.div.style[CSS.styles.vendorTransition]="",_object.div._transition=!1);_this.time=_time,_this.delay=_delay,_endValues={},_transformEnd={},_transformStart={},_startValues={},_object.multiTween||(void 0===_props.x&&(_props.x=_object.x),void 0===_props.y&&(_props.y=_object.y),void 0===_props.z&&(_props.z=_object.z));for(var key in _props)if(key.includes(["damping","spring"]))_endValues[key]=_props[key],_transformEnd[key]=_props[key];else if(TweenManager._isTransform(key))_isTransform=!0,_transformStart[key]=_object[key]||("scale"==key?1:0),_transformEnd[key]=_props[key];else{_isCSS=!0;var v=_props[key];"string"==typeof v?_object.div.style[key]=v:"number"==typeof v&&(_startValues[key]=Number(_object.css(key)),_endValues[key]=v)}}(),function startTween(){!_object._cssTween||_manual||_object.multiTween||(_object._cssTween.kill=!0);_this.time=_time,_this.delay=_delay,_object.multiTween&&(_object._cssTweens||(_object._cssTweens=[]),_object._cssTweens.push(_this));_object._cssTween=_this,_this.playing=!0,_props=copy(_startValues),_transformProps=copy(_transformStart),_isCSS&&(_cssTween=tween(_props,_endValues,_time,_ease,_delay,null,_manual).onUpdate(update).onComplete(tweenComplete));_isTransform&&(_transformTween=tween(_transformProps,_transformEnd,_time,_ease,_delay,null,_manual).onComplete(_isCSS?null:tweenComplete).onUpdate(_isCSS?null:update))}()}})),this.stop=function(){this.playing&&(_cssTween&&_cssTween.stop&&_cssTween.stop(),_transformTween&&_transformTween.stop&&_transformTween.stop(),clear())},this.interpolate=function(elapsed){_cssTween&&_cssTween.interpolate(elapsed),_transformTween&&_transformTween.interpolate(elapsed),update()},this.getValues=function(){return{start:_startValues,transformStart:_transformStart,end:_endValues,transformEnd:_transformEnd}},this.setEase=function(ease){_cssTween&&_cssTween.setEase(ease),_transformTween&&_transformTween.setEase(ease)},this.onUpdate=function(){return this},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise||(_this.completePromise=Promise.create()),_this.completePromise}})),Class((function Interaction(_object){Inherit(this,Events);const _this=this;var _velocity=[],_moved=0,_time=performance.now();function Vec2(){this.x=0,this.y=0,this.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y)}}var _vec2Pool=new ObjectPool(Vec2,10);let _distance,_timeDown,_timeMove;function loop(){_moved++>10&&(_this.velocity.x=_this.velocity.y=0,_this.delta.x=_this.delta.y=0)}function down(e){_this.isTouching=!0,e.touches&&"number"==typeof e.touches[0].force&&(e.force=e.touches[0].force),_this.x=e.x,_this.y=e.y,_this.hold.x=_this.last.x=e.x,_this.hold.y=_this.last.y=e.y,_this.delta.x=_this.move.x=_this.velocity.x=0,_this.delta.y=_this.move.y=_this.velocity.y=0,_distance=0,_this.events.fire(Interaction.START,e,!0),_timeDown=_timeMove=Render.TIME}function move(e){let now=performance.now();if(now-_time<16)return;_time=now,_this.isTouching&&(_this.move.x=e.x-_this.hold.x,_this.move.y=e.y-_this.hold.y),e.touches&&"number"==typeof e.touches[0].force&&(e.force=e.touches[0].force),_this.x=e.x,_this.y=e.y,_this.delta.x=e.x-_this.last.x,_this.delta.y=e.y-_this.last.y,_this.last.x=e.x,_this.last.y=e.y,_moved=0,_distance+=_this.delta.length();let delta=Render.TIME-(_timeMove||Render.TIME);if(_timeMove=Render.TIME,delta>.01){let velocity=_vec2Pool.get();velocity.x=Math.abs(_this.delta.x)/delta,velocity.y=Math.abs(_this.delta.y)/delta,_velocity.push(velocity),_velocity.length>5&&_vec2Pool.put(_velocity.shift())}_this.velocity.x=_this.velocity.y=0;for(let i=0;i<_velocity.length;i++)_this.velocity.x+=_velocity[i].x,_this.velocity.y+=_velocity[i].y;_this.velocity.x/=_velocity.length,_this.velocity.y/=_velocity.length,_this.velocity.x=_this.velocity.x||0,_this.velocity.y=_this.velocity.y||0,_this.events.fire(Interaction.MOVE,e,!0),_this.isTouching&&_this.events.fire(Interaction.DRAG,e,!0)}function up(e){if(!_this.isTouching)return;_this.isTouching=!1,_this.move.x=0,_this.move.y=0,Math.max(.001,Render.TIME-(_timeMove||Render.TIME))>100&&(_this.delta.x=0,_this.delta.y=0),_distance<20&&Render.TIME-_timeDown<2e3&&_this.events.fire(Interaction.CLICK,e,!0),_this.events.fire(Interaction.END,e,!0),Device.mobile&&(_this.velocity.x=_this.velocity.y=0)}function leave(){_this.delta.x=0,_this.delta.y=0,up()}this.x=0,this.y=0,this.hold=new Vec2,this.last=new Vec2,this.delta=new Vec2,this.move=new Vec2,this.velocity=new Vec2,function(){if(!_object instanceof HydraObject)throw"Interaction.Input requires a HydraObject";!function addHandlers(){_object==Stage||_object==__window?Interaction.bind("touchstart",down):_object.bind("touchstart",down);Interaction.bind("touchmove",move),Interaction.bind("touchend",up),Interaction.bind("leave",leave)}(),Render.start(loop)}(),this.onDestroy=function(){Interaction.unbind("touchstart",down),Interaction.unbind("touchmove",move),Interaction.unbind("touchend",up),Render.stop(loop),_object&&_object.unbind&&_object.unbind("touchstart",down)}}),()=>{Namespace(Interaction),Interaction.CLICK="interaction_click",Interaction.START="interaction_start",Interaction.MOVE="interaction_move",Interaction.DRAG="interaction_drag",Interaction.END="interaction_end";const _events={touchstart:[],touchmove:[],touchend:[],leave:[]};function touchMove(e){_events.touchmove.forEach(c=>c(e))}function touchStart(e){_events.touchstart.forEach(c=>c(e))}function touchEnd(e){_events.touchend.forEach(c=>c(e))}function leave(e){_events.leave.forEach(c=>c(e))}Hydra.ready(async()=>{await defer(),__window.bind("touchstart",touchStart),__window.bind("touchmove",touchMove),__window.bind("touchend",touchEnd),__window.bind("touchcancel",touchEnd),__window.bind("contextmenu",touchEnd),__window.bind("mouseleave",leave),__window.bind("mouseout",leave)}),Interaction.bind=function(evt,callback){_events[evt].push(callback)},Interaction.unbind=function(evt,callback){_events[evt].remove(callback)}}),Class((function Mouse(){Inherit(this,Events);const _this=this;this.x=0,this.y=0,this.normal={x:0,y:0},this.tilt={x:0,y:0},this.inverseNormal={x:0,y:0},this.resetOnRelease=!1;const _offset={x:0,y:0};function init(){defer(_=>{_this.resetOnRelease&&Device.mobile&&(_this.x=Stage.width/2,_this.y=Stage.height/2)}),_this.input=new Interaction(__window),_this.events.sub(_this.input,Interaction.START,update),_this.events.sub(_this.input,Interaction.MOVE,update),_this.events.sub(_this.input,Interaction.END,end),_this.hold=_this.input.hold,_this.last=_this.input.last,_this.delta=_this.input.delta,_this.move=_this.input.move,_this.velocity=_this.input.velocity,defer(()=>{_this.events.sub(Events.RESIZE,resize),resize()})}function update(e){_this.x=e.x,_this.y=e.y,Stage.width&&Stage.height&&(_this.normal.x=e.x/Stage.width-_offset.x,_this.normal.y=e.y/Stage.height-_offset.y,_this.tilt.x=2*_this.normal.x-1,_this.tilt.y=1-2*_this.normal.y,_this.inverseNormal.x=_this.normal.x,_this.inverseNormal.y=1-_this.normal.y)}function end(e){Device.mobile&&_this.resetOnRelease&&update({x:Stage.width/2,y:Stage.height/2})}function resize(){Stage.css("top")&&(_offset.y=Stage.css("top")/Stage.height),Stage.css("left")&&(_offset.x=Stage.css("left")/Stage.width)}Hydra.ready(init)}),"Static"),Class((function Mobile(){Inherit(this,Component),Namespace(this);const _this=this;function preventNativeScroll(e){if(_this.isAllowNativeScroll)return;let target=e.target;if("INPUT"==target.nodeName||"TEXTAREA"==target.nodeName||"SELECT"==target.nodeName||"A"==target.nodeName)return;let prevent=target.hydraObject;for(;target.parentNode&&prevent;)target._scrollParent&&(prevent=!1),target=target.parentNode;prevent&&e.preventDefault()}function resize(){updateOrientation(),checkResizeRefresh(),_this.isAllowNativeScroll||(document.body.scrollTop=0)}function updateOrientation(){_this.orientation=Stage.width>Stage.height?"landscape":"portrait",_this.orientationSet&&(window.Fullscreen.isOpen||Device.mobile.pwa)&&window.screen&&window.screen.orientation&&window.screen.orientation.lock&&window.screen.orientation.lock(_this.orientationSet)}Hydra.ready(()=>{Device.mobile&&(!function addHandlers(){_this.events.sub(Events.RESIZE,resize),Device.mobile.native||window.addEventListener("touchstart",preventNativeScroll,{passive:!1})}(),"safari"!=Device.system.browser||Device.mobile.native||(__body.css({height:"100%"}).div.scrollTop=0),Device.mobile.native&&Stage.css({width:"100vw",height:"100vh"}))});const checkResizeRefresh=function(){let _lastWidth;return function(){_this.isPreventResizeReload||_lastWidth!=Stage.width&&(_lastWidth=Stage.width,("ios"===Device.system.os||"android"==Device.system.os&&Device.system.version>=7)&&(!Device.mobile.tablet||Math.max(Stage.width,Stage.height)>800||window.location.reload()))}}();this.vibrate=function(duration){navigator.vibrate&&navigator.vibrate(duration)},this.fullscreen=function(){if(Device.mobile&&!Device.mobile.native&&!Device.mobile.pwa&&!Dev.emulator){if(!window.Fullscreen)throw"Mobile.fullscreen requires Fullscreen module";"android"===Device.system.os&&(__window.bind("touchend",()=>{Fullscreen.open()}),_this.ScreenLock&&_this.ScreenLock.isActive&&window.onresize())}},this.setOrientation=function(orientation,isForce){if(_this.System&&_this.NativeCore.active)return _this.System.orientation=_this.System[orientation.toUpperCase()];if(_this.orientationSet=orientation,updateOrientation(),isForce){if(!_this.ScreenLock)throw"Mobile.setOrientation isForce argument requires ScreenLock module";"any"===orientation?_this.ScreenLock.unlock():_this.ScreenLock.lock()}},this.allowNativeScroll=function(){_this.isAllowNativeScroll=!0},this.preventResizeReload=function(){_this.isPreventResizeReload=!0},this._addOverflowScroll=function($obj){$obj.div._scrollParent=!0,Device.mobile.native||($obj.div._preventEvent=function(e){e.stopPropagation()},$obj.bind("touchmove",$obj.div._preventEvent))},this._removeOverflowScroll=function($obj){$obj.unbind("touchmove",$obj.div._preventEvent)},this.get("phone",()=>{throw"Mobile.phone is removed. Use Device.mobile.phone"}),this.get("tablet",()=>{throw"Mobile.tablet is removed. Use Device.mobile.tablet"}),this.get("os",()=>{throw"Mobile.os is removed. Use Device.system.os"})}),"Static"),Class((function PushState(_isHash){const _this=this;let _store,_root="";function getState(){return _isHash?String(window.location.hash.slice(3)):("/"!==_root?location.pathname.split(_root)[1]:location.pathname.slice(1))||""}function handleStateChange(state,forced){if(state!==_store||forced)if(!_this.isLocked||forced)_store=state,_this.events.fire(Events.UPDATE,{value:state,split:state.split("/")});else{if(!_store)return;_isHash?window.location.hash="!/"+_store:window.history.pushState(null,null,_root+_store)}}"boolean"!=typeof _isHash&&(_isHash=Hydra.LOCAL||!Device.system.pushstate),this.isLocked=!1,function addHandlers(){if(_isHash)return window.addEventListener("hashchange",()=>handleStateChange(getState()),!1);window.onpopstate=history.onpushstate=()=>handleStateChange(getState())}(),_store=getState(),this.getState=function(){return Device.mobile.native?Storage.get("app_state")||"":getState()},this.setRoot=function(root){_root="/"===root.charAt(0)?root:"/"+root},this.setState=function(state,forced){if(Device.mobile.native&&Storage.set("app_state",state),state!==_store)return _store=state,_isHash?window.location.hash="!/"+state:window.history.pushState(null,null,_root+state),PushState.fireChangeWhenSet&&handleStateChange(getState(),forced),!0},this.replaceState=function(state){state!==_store&&(_store=state,_isHash?window.location.hash="!/"+state:window.history.replaceState(null,null,_root+state))},this.setTitle=function(title){document.title=title},this.lock=function(){this.isLocked=!0},this.unlock=function(){this.isLocked=!1},this.useHash=function(){_isHash=!0}})),Class((function Dev(){var _post,_alert,_inter,_timerName,_this=this,_id=Utils.timestamp();function catchErrors(){window.onerror=function(message,file,line){var string=message+" ::: "+file+" : "+line;_alert&&alert(string),_post&&post(_post+"/api/data/debug",getDebugInfo(string)),_this.onError&&_this.onError(message,file,line)}}function getDebugInfo(string){var obj={};return obj.time=(new Date).toString(),obj.deviceId=_id,obj.err=string,obj.ua=Device.agent,obj.width=Stage.width,obj.height=Stage.height,obj.screenWidth=screen.width,obj.screenHeight=screen.height,obj}this.emulator=Device.mobile&&navigator.platform&&navigator.platform.toLowerCase().includes(["mac","windows"]),this.alertErrors=function(url){_alert=!0,"string"==typeof url&&(url=[url]);for(var i=0;i<url.length;i++)if(location.href.includes(url[i])||location.hash.includes(url[i]))return catchErrors()},this.postErrors=function(url,post){_post=post,"string"==typeof url&&(url=[url]);for(var i=0;i<url.length;i++)if(location.href.includes(url[i]))return catchErrors()},this.expose=function(name,val,force){(Hydra.LOCAL||force)&&(window[name]=val)},this.logServer=function(msg){_post&&post(_post+"/api/data/debug",getDebugInfo(msg))},this.unsupported=function(needsAlert){needsAlert&&alert("Hi! This build is not yet ready for this device, things may not work as expected. Refer to build schedule for when this device will be supported.")},this.checkForLeaks=function(flag,array){if(!window.AURA){var matchArray=function(prop){if(!array)return!1;for(var i=0;i<array.length;i++)if(prop.includes(array[i]))return!0;return!1};clearInterval(_inter),flag&&(_inter=setInterval((function(){for(var prop in window){if(!prop.includes("webkit"))if("function"!=typeof window[prop]&&prop.length>2){if(prop.includes("_ga")||prop.includes("_typeface_js")||matchArray(prop))continue;var char1=prop.charAt(0),char2=prop.charAt(1);if(("_"==char1||"$"==char1)&&char2!==char2.toUpperCase())throw console.log(window[prop]),"Hydra Warning:: "+prop+" leaking into global scope"}}}),1e3))}},this.startTimer=function(name){_timerName=name||"Timer",console.time&&!window._NODE_?console.time(_timerName):_timer=performance.now()},this.stopTimer=function(){console.time&&!window._NODE_?console.timeEnd(_timerName):console.log("Render "+_timerName+": "+(performance.now()-_timer))},this.writeFile=function(file,data){if(!Hydra.LOCAL)return;let url=location.protocol+"//"+location.hostname+":8017"+location.pathname+file;post(url,data).then(e=>{"OK"!=e&&console.warn(`Unable to write to ${file}`)})},this.execUILScript=async function(name,data){if(!Hydra.LOCAL)return;let url=location.protocol+"//"+location.hostname+":8017"+location.pathname+"/uil/"+name,response=await post(url,data);if("ERROR"==response)throw response;return response},Hydra.LOCAL&&_this.checkForLeaks(!0)}),"Static"),Class((function Service(){Inherit(this,Component);var _sw,_this=this;function getSWAssets(){if(!window.ASSETS.SW||_this.cached)return[];var assets=window.ASSETS.SW;return assets.forEach((asset,i)=>{asset.includes(".js")&&(asset=assets[i].replace(".js",".js?"+window._CACHE_))}),assets}function handleRegistration(e){}function handleReady(e){_this.isReady=!0,_this.events.fire(Events.READY,e,!0),_sw=navigator.serviceWorker.controller,function checkCache(){Storage.get("service_cache")!=window._CACHE_&&_this.post("clearCache")}()}function handleError(e){e&&(_this.events.fire(Events.ERROR,e,!0),_this.active=!1)}function handleMessage(e){var data=e.data;data.evt&&_this.events.fire(data.evt,data)}this.active=!1,this.ready=!1,this.cached=!1,this.offline=!1,this.disabled=!1,this.ready=function(){return this.wait(this,"isReady")},this.init=function(){Hydra.ready(()=>{!("serviceWorker"in navigator)||Hydra.LOCAL&&""==location.port||window.process||_this.disabled||function initWorker(){_this.active=!0,navigator.serviceWorker.register("sw.js").then(handleRegistration).then(handleReady).then(handleError)}()})},this.cache=function(assets=[]){assets=Array.from(assets);_this.active&&_this.wait(_this,"ready",(function(){_this.post("upload",{assets:assets,cdn:Assets.CDN,hostname:location.hostname,sw:getSWAssets(),offline:_this.offline}),Storage.set("service_cache",window._CACHE_),_this.cached=!0}))},this.post=function(fn,data={}){if(!_this.active)return;_this.wait(_this,"ready",(function(){let mc=new MessageChannel;mc.port1.onmessage=handleMessage,data.fn=fn,_sw&&_sw.postMessage(data,[mc.port2])}))}}),"static"),Class((function Storage(){var _storage;function cookie(key,value,expires){var options;if(arguments.length>1&&(null===value||"object"!=typeof value)){if((options={}).path="/",options.expires=expires||1,null===value&&(options.expires=-1),"number"==typeof options.expires){var days=options.expires,t=options.expires=new Date;t.setDate(t.getDate()+days)}return document.cookie=[encodeURIComponent(key),"=",options.raw?String(value):encodeURIComponent(String(value)),options.expires?"; expires="+options.expires.toUTCString():"",options.path?"; path="+options.path:"",options.domain?"; domain="+options.domain:"",options.secure?"; secure":""].join("")}var result,decode=(options=value||{}).raw?function(s){return s}:decodeURIComponent;return(result=new RegExp("(?:^|; )"+encodeURIComponent(key)+"=([^;]*)").exec(document.cookie))?decode(result[1]):null}!function testStorage(){try{if(window.localStorage)try{window.localStorage.test=1,window.localStorage.removeItem("test"),_storage=!0}catch(e){_storage=!1}else _storage=!1}catch(e){_storage=!1}}(),this.setCookie=function(key,value,expires){cookie(key,value,expires)},this.getCookie=function(key){return cookie(key)},this.set=function(key,value){null!=value&&"object"==typeof value&&(value=JSON.stringify(value)),_storage?null===value?window.localStorage.removeItem(key):window.localStorage[key]=value:cookie(key,value,365)},this.get=function(key){var val,char0;(val=_storage?window.localStorage[key]:cookie(key))&&(val.charAt&&(char0=val.charAt(0)),"{"!=char0&&"["!=char0||(val=JSON.parse(val)),"true"!=val&&"false"!=val||(val="true"==val));return val}}),"Static"),Class((function Thread(_class){Inherit(this,Component);var _this=this,_worker,_callbacks,_path,_mvc,_msg={};function init(){let file=window._ES5_?"assets/js/hydra/hydra-thread-es5.js":"assets/js/hydra/hydra-thread.js";_callbacks={},_worker=new Worker(Thread.PATH+file)}function importClasses(){importClass(Utils),importClass(Component),importClass(Events),importClass(_class,!0)}function importClass(_class,scoped){if(_class){var code;if(scoped){code=(code=_class.toString().replace("{","!!!")).split("!!!")[1];for(var splitChar=window._MINIFIED_?"=":" ";code.includes("this");){var name=code.slice(code.indexOf("this.")).split("this.")[1].split(splitChar)[0];code=code.replace("this","self"),createMethod(name)}code=(code=code.slice(0,-1)).replace(/_self/g,"_this")}else if("function"!=typeof _class){if((code=_class.constructor.toString()).includes("[native"))return;code=(_class.constructor._namespace?_class.constructor._namespace+".":"")+"Class("+code+', "static");'}else code=(_class._namespace?_class._namespace+".":"")+"Class("+_class.toString()+");";_worker.postMessage({code:code})}}function createMethod(name){_this[name]=function(message={},callback,buffer){let promise;return Array.isArray(callback)&&(buffer=callback,callback=void 0),Array.isArray(buffer)&&((message={msg:message,transfer:!0}).buffer=buffer),void 0===callback&&(promise=Promise.create(),callback=promise.resolve),_this.send(name,message,callback),promise}}function addListeners(){_worker.addEventListener("message",workerMessage)}function workerMessage(e){if(e.data.console)console.log(e.data.message);else if(e.data.id){(callback=_callbacks[e.data.id])&&callback(e.data.message),delete _callbacks[e.data.id]}else if(e.data.emit){(callback=_callbacks[e.data.evt])&&callback(e.data.msg)}else{var callback;(callback=_callbacks.transfer)&&callback(e.data)}}init(),importClasses(),addListeners(),this.on=function(evt,callback){_callbacks[evt]=callback},this.off=function(evt){delete _callbacks[evt]},this.loadFunction=function(){let names=[],load=code=>{var split=(code=(code=code.toString()).replace("(","!!!")).split("!!!"),name=split[0].split(" ")[1];code="self."+name+" = function("+split[1],_worker.postMessage({code:code}),createMethod(name),names.push(name)};for(var i=0;i<arguments.length;i++)load(arguments[i]);return names},this.importScript=function(path){_worker.postMessage({path:Thread.absolutePath(path),importScript:!0})},this.importCode=function(code){_worker.postMessage({code:code})},this.importClass=function(){for(var i=0;i<arguments.length;i++){var code=arguments[i];importClass(code)}},this.importModules=this.importModule=function(){for(var i=0;i<arguments.length;i++){let code=Modules.getConstructor(arguments[i]).toString();_worker.postMessage({code:`Module(${code})`})}},this.importES6Class=function(name){if(window._ES5_){let Class=window[name],base=Class.toString(),proto=[];Object.getOwnPropertyNames(Class.prototype).forEach(fn=>{"constructor"!=fn&&Class.prototype[fn]&&proto.push({key:fn,string:Class.prototype[fn].toString()})}),_worker.postMessage({es5:base,name:name,proto:proto})}else _worker.postMessage({es6:`(${eval(name)})`,name:name})},this.send=function(name,message,callback){if("string"==typeof name){(message=message||{}).fn=name}else callback=message,message=name;Thread.UNIQUE_ID>999999&&(Thread.UNIQUE_ID=1);var id=Thread.UNIQUE_ID++;callback&&(_callbacks[id]=callback),message.transfer?(message.msg.id=id,message.msg.fn=message.fn,message.msg.transfer=!0,_worker.postMessage(message.msg,message.buffer)):(_msg.message=message,_msg.id=id,_worker.postMessage(_msg))},this.onDestroy=function(){_worker.terminate&&_worker.terminate()}}),()=>{var _shared;Thread.PATH="",Thread.UNIQUE_ID=1,Thread.absolutePath=Hydra.absolutePath,Thread.cluster=function(){return new function(){let index=0,array=[];this.push=function(thread){array.push(thread)},this.get=function(){let thread=array[index];return index++,index>=array.length&&(index=0),thread},this.array=array}},Thread.upload=function(...args){let name;Thread.shared();for(let i=0;i<_shared.array.length;i++)name=_shared.array[i].loadFunction(...args);return name},Thread.shared=function(list){if(!_shared){_shared=Thread.cluster();let count=navigator.hardwareConcurrency||4;for(let i=0;i<count;i++)_shared.push(new Thread)}return list?_shared:_shared.get()}}),Class((function TweenManager(){Namespace(this);var _this=this,_tweens=[];function updateTweens(time,dt){for(let i=_tweens.length-1;i>=0;i--){let tween=_tweens[i];tween.update?tween.update(dt):_this._removeMathTween(tween)}}function findEase(name){for(var eases=_this.CubicEases,i=eases.length-1;i>-1;i--)if(eases[i].name==name)return eases[i];return!1}this.CubicEases=[],Render.start(updateTweens),this._addMathTween=function(tween){_tweens.push(tween)},this._removeMathTween=function(tween){_tweens.remove(tween)},this._getEase=function(name,values){var ease=findEase(name);return!!ease&&(values?ease.path?ease.path.solve:ease.values:ease.curve)},this._inspectEase=function(name){return findEase(name)},this.tween=function(object,props,time,ease,delay,complete,isManual,scaledTime){"number"!=typeof delay&&(update=complete,complete=delay,delay=0);const tween=new MathTween(object,props,time,ease,delay,complete,isManual,scaledTime);let usePromise=null;return complete&&complete instanceof Promise&&(usePromise=complete,complete=complete.resolve),usePromise||tween},this.clearTween=function(object){if(object._mathTween&&object._mathTween.stop&&object._mathTween.stop(),object._mathTweens){for(var tweens=object._mathTweens,i=0;i<tweens.length;i++){var tw=tweens[i];tw&&tw.stop&&tw.stop()}object._mathTweens=null}},this.addCustomEase=function(ease){var add=!0;if("object"!=typeof ease||!ease.name||!ease.curve)throw"TweenManager :: addCustomEase requires {name, curve}";for(var i=_this.CubicEases.length-1;i>-1;i--)ease.name==_this.CubicEases[i].name&&(add=!1);if(add){if("m"==ease.curve.charAt(0).toLowerCase()){if(!window.EasingPath)throw"Using custom eases requires easingpath module";ease.path=new EasingPath(ease.curve)}else ease.values=function stringToValues(str){for(var values=str.split("(")[1].slice(0,-1).split(","),i=0;i<values.length;i++)values[i]=parseFloat(values[i]);return values}(ease.curve);_this.CubicEases.push(ease)}return ease},Math.interpolate=function(start,end,alpha,ease){const fn=_this.Interpolation.convertEase(ease);return Math.mix(start,end,"function"==typeof fn?fn(alpha):_this.Interpolation.solve(fn,alpha))},window.tween=this.tween,window.clearTween=this.clearTween}),"Static"),TweenManager.Class((function Interpolation(){function calculateBezier(aT,aA1,aA2){return((A(aA1,aA2)*aT+B(aA1,aA2))*aT+C(aA1))*aT}function A(aA1,aA2){return 1-3*aA2+3*aA1}function B(aA1,aA2){return 3*aA2-6*aA1}function C(aA1){return 3*aA1}this.convertEase=function(ease){var fn=function(){switch(ease){case"easeInQuad":return TweenManager.Interpolation.Quad.In;case"easeInCubic":return TweenManager.Interpolation.Cubic.In;case"easeInQuart":return TweenManager.Interpolation.Quart.In;case"easeInQuint":return TweenManager.Interpolation.Quint.In;case"easeInSine":return TweenManager.Interpolation.Sine.In;case"easeInExpo":return TweenManager.Interpolation.Expo.In;case"easeInCirc":return TweenManager.Interpolation.Circ.In;case"easeInElastic":return TweenManager.Interpolation.Elastic.In;case"easeInBack":return TweenManager.Interpolation.Back.In;case"easeInBounce":return TweenManager.Interpolation.Bounce.In;case"easeOutQuad":return TweenManager.Interpolation.Quad.Out;case"easeOutCubic":return TweenManager.Interpolation.Cubic.Out;case"easeOutQuart":return TweenManager.Interpolation.Quart.Out;case"easeOutQuint":return TweenManager.Interpolation.Quint.Out;case"easeOutSine":return TweenManager.Interpolation.Sine.Out;case"easeOutExpo":return TweenManager.Interpolation.Expo.Out;case"easeOutCirc":return TweenManager.Interpolation.Circ.Out;case"easeOutElastic":return TweenManager.Interpolation.Elastic.Out;case"easeOutBack":return TweenManager.Interpolation.Back.Out;case"easeOutBounce":return TweenManager.Interpolation.Bounce.Out;case"easeInOutQuad":return TweenManager.Interpolation.Quad.InOut;case"easeInOutCubic":return TweenManager.Interpolation.Cubic.InOut;case"easeInOutQuart":return TweenManager.Interpolation.Quart.InOut;case"easeInOutQuint":return TweenManager.Interpolation.Quint.InOut;case"easeInOutSine":return TweenManager.Interpolation.Sine.InOut;case"easeInOutExpo":return TweenManager.Interpolation.Expo.InOut;case"easeInOutCirc":return TweenManager.Interpolation.Circ.InOut;case"easeInOutElastic":return TweenManager.Interpolation.Elastic.InOut;case"easeInOutBack":return TweenManager.Interpolation.Back.InOut;case"easeInOutBounce":return TweenManager.Interpolation.Bounce.InOut;case"linear":return TweenManager.Interpolation.Linear.None}}();if(!fn){var curve=TweenManager._getEase(ease,!0);fn=curve||TweenManager.Interpolation.Cubic.Out}return fn},this.solve=function(values,elapsed){return values[0]==values[1]&&values[2]==values[3]?elapsed:calculateBezier(function getTForX(aX,mX1,mX2){for(var aT,aA1,aA2,aGuessT=aX,i=0;i<4;i++){var currentSlope=(aT=aGuessT,3*A(aA1=mX1,aA2=mX2)*aT*aT+2*B(aA1,aA2)*aT+C(aA1));if(0==currentSlope)return aGuessT;aGuessT-=(calculateBezier(aGuessT,mX1,mX2)-aX)/currentSlope}return aGuessT}(elapsed,values[0],values[2]),values[1],values[3])},this.Linear={None:function(k){return k}},this.Quad={In:function(k){return k*k},Out:function(k){return k*(2-k)},InOut:function(k){return(k*=2)<1?.5*k*k:-.5*(--k*(k-2)-1)}},this.Cubic={In:function(k){return k*k*k},Out:function(k){return--k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k:.5*((k-=2)*k*k+2)}},this.Quart={In:function(k){return k*k*k*k},Out:function(k){return 1- --k*k*k*k},InOut:function(k){return(k*=2)<1?.5*k*k*k*k:-.5*((k-=2)*k*k*k-2)}},this.Quint={In:function(k){return k*k*k*k*k},Out:function(k){return--k*k*k*k*k+1},InOut:function(k){return(k*=2)<1?.5*k*k*k*k*k:.5*((k-=2)*k*k*k*k+2)}},this.Sine={In:function(k){return 1-Math.cos(k*Math.PI/2)},Out:function(k){return Math.sin(k*Math.PI/2)},InOut:function(k){return.5*(1-Math.cos(Math.PI*k))}},this.Expo={In:function(k){return 0===k?0:Math.pow(1024,k-1)},Out:function(k){return 1===k?1:1-Math.pow(2,-10*k)},InOut:function(k){return 0===k?0:1===k?1:(k*=2)<1?.5*Math.pow(1024,k-1):.5*(2-Math.pow(2,-10*(k-1)))}},this.Circ={In:function(k){return 1-Math.sqrt(1-k*k)},Out:function(k){return Math.sqrt(1- --k*k)},InOut:function(k){return(k*=2)<1?-.5*(Math.sqrt(1-k*k)-1):.5*(Math.sqrt(1-(k-=2)*k)+1)}},this.Elastic={In:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),-a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p))},Out:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),a*Math.pow(2,-10*k)*Math.sin((k-s)*(2*Math.PI)/p)+1)},InOut:function(k,a=1,p=.4){var s;return 0===k?0:1===k?1:(!a||a<1?(a=1,s=p/4):s=p*Math.asin(1/a)/(2*Math.PI),(k*=2)<1?a*Math.pow(2,10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*-.5:a*Math.pow(2,-10*(k-=1))*Math.sin((k-s)*(2*Math.PI)/p)*.5+1)}},this.Back={In:function(k){var s=1.70158;return k*k*((s+1)*k-s)},Out:function(k){var s=1.70158;return--k*k*((s+1)*k+s)+1},InOut:function(k){var s=2.5949095;return(k*=2)<1?k*k*((s+1)*k-s)*.5:.5*((k-=2)*k*((s+1)*k+s)+2)}},this.Bounce={In:function(k){return 1-this.Bounce.Out(1-k)},Out:function(k){return k<1/2.75?7.5625*k*k:k<2/2.75?7.5625*(k-=1.5/2.75)*k+.75:k<2.5/2.75?7.5625*(k-=2.25/2.75)*k+.9375:7.5625*(k-=2.625/2.75)*k+.984375},InOut:function(k){return k<.5?.5*this.Bounce.In(2*k):.5*this.Bounce.Out(2*k-1)+.5}}}),"Static"),Class((function MathTween(_object,_props,_time,_ease,_delay,_callback,_manual,_scaledTime){var _startTime,_startValues,_endValues,_easeFunction,_paused,_newEase,_spring,_damping,_update,_currentTime,_this=this,_elapsed=0;function clear(){if(!_object&&!_props)return!1;_object._mathTween=null,TweenManager._removeMathTween(_this),Utils.nullObject(_this),_object._mathTweens&&_object._mathTweens.remove(_this._tweenWrapper)}_this.object=_object,_this.props=_props,_this.time=_time,_this.ease=_ease,_this.delay=_delay,defer((function(){if(_this.overrideValues){let values=_this.overrideValues(_this,_object,_props,_time,_ease,_delay);values&&(_this.props=_props=values.props||_props,_this.time=_time=values.time||_time,_this.ease=_ease=values.ease||_ease,_this.delay=_delay=values.delay||_delay)}if(_object&&_props){if(_this.object=_object,"number"!=typeof _time)throw"MathTween Requires object, props, time, ease";!function start(){_object.multiTween||!_object._mathTween||_manual||TweenManager.clearTween(_object);_manual||TweenManager._addMathTween(_this);_this.time=_time,_this.delay=_delay;let propString=function getPropString(){let string="";for(let key in _props)"number"==typeof _props[key]&&(string+=key+" ");return string}();_object._mathTween=_this,_object.multiTween&&(_object._mathTweens||(_object._mathTweens=[]),_object._mathTweens.forEach(t=>{t.props==propString&&t.tween.stop()}),_this._tweenWrapper={props:propString,tween:_this},_object._mathTweens.push(_this._tweenWrapper));_ease||(_ease="linear");"string"==typeof _ease&&(_ease=TweenManager.Interpolation.convertEase(_ease),_easeFunction="function"==typeof _ease);_startTime=_scaledTime?Render.now():performance.now(),_currentTime=_startTime,_startTime+=_delay,_endValues=_props,_startValues={},_props.spring&&(_spring=_props.spring);_props.damping&&(_damping=_props.damping);for(var prop in _this.startValues=_startValues,_endValues)"number"==typeof _object[prop]&&(_startValues[prop]=_object[prop])}()}})),this.update=function(dt){if(_paused)return;if((_currentTime+=_scaledTime?dt:Render.DT)<_startTime)return;_elapsed=(_elapsed=(_currentTime-_startTime)/_time)>1?1:_elapsed;let delta=this.interpolate(_elapsed);_update&&_update(delta),1==_elapsed&&(_callback&&_callback(),_this.completePromise&&_this.completePromise.resolve(),clear())},this.pause=function(){_paused=!0},this.resume=function(){_paused=!1},this.stop=function(){return _this.stopped=!0,clear(),null},this.setEase=function(ease){_newEase!=ease&&(_newEase=ease,_ease=TweenManager.Interpolation.convertEase(ease),_easeFunction="function"==typeof _ease)},this.getValues=function(){return{start:_startValues,end:_endValues}},this.interpolate=function(elapsed){var delta=_easeFunction?_ease(elapsed,_spring,_damping):TweenManager.Interpolation.solve(_ease,elapsed);for(var prop in _startValues)if("number"==typeof _startValues[prop]&&"number"==typeof _endValues[prop]){var start=_startValues[prop],end=_endValues[prop];_object[prop]=start+(end-start)*delta}return delta},this.onUpdate=function(callback){return _update=callback,this},this.onComplete=function(callback){return _callback=callback,this},this.promise=function(){return _this.completePromise=Promise.create(),_this.completePromise},this.setElapsed=function(elapsed){_startTime=performance.now(),_currentTime=_startTime+_time*elapsed}})),Class((function TweenTimeline(){Inherit(this,Component);const _this=this;let _tween,_total=0;const _tweens=[];function calculate(){_tweens.sort((function(a,b){const ta=a.time+a.delay;return b.time+b.delay-ta}));const first=_tweens[0];_total=first.time+first.delay}function loop(){let time=_this.elapsed*_total;for(let i=_tweens.length-1;i>-1;i--){let t=_tweens[i],relativeTime=time-t.delay,elapsed=Math.clamp(relativeTime/t.time,0,1);t.interpolate(elapsed)}_this.events.fire(Events.UPDATE,_this,!0)}this.elapsed=0,this.get("timeRemaining",()=>_total-_this.elapsed*_total),this.add=function(object,props,time,ease,delay=0){let tween;return(object instanceof MathTween||object instanceof FrameTween)&&(props=object.props,time=object.time,ease=object.ease,delay=object.delay,object=object.object),tween=object instanceof HydraObject?new FrameTween(object,props,time,ease,delay,null,!0):new MathTween(object,props,time,ease,delay,null,!0),_tweens.push(tween),defer(calculate),tween},this.tween=function(to,time,ease,delay,callback){return _this.clearTween(),_tween=tween(_this,{elapsed:to},time,ease,delay).onUpdate(loop).onComplete(callback),_tween},this.clearTween=function(){_tween&&_tween.stop&&_tween.stop()},this.startRender=function(){Render.start(loop)},this.stopRender=function(){Render.stop(loop)},this.update=function(){loop()},this.onDestroy=function(){_this.clearTween(),Render.stop(loop);for(var i=0;i<_tweens.length;i++)_tweens[i].stop()}})),Class((function Data(){Inherit(this,Model);const _this=this;var _ghost,_fbDeepLink;this.tracks={},async function(){await Hydra.ready(),await UILStorage.ready(),function getCarList(){return InputUIL.create("CarManagerConfig",null).get("names").split("\n").map(l=>l.includes(":")?l.split(":")[0]:l)}().forEach((name,index)=>{let track=_this.initClass(DataTrack,name);track.index=index,_this.tracks[name]=track}),_this.flag("loaded",!0),_this.flag("dataReady",!0)}(),this.getGhost=async function(clear){if(clear&&(_ghost=null),_ghost)return _ghost;await _this.wait("loaded");let data=_this.decodeQuery();return data?_ghost=await _this.Race.get(data.id):null},this.setGhost=function(data){let value=_this.encodeQuery(data);_this.clearGhost(),window.history.replaceState({},document.title,location.pathname+URLUtil.addParam(location.search,"play",value))},this.clearGhost=function(){window.history.replaceState({},document.title,location.pathname+URLUtil.removeParam(location.search,"play")),_fbDeepLink=!0,_ghost=null},this.decodeQuery=function(){let playQuery;if(Config.FACEBOOK&&!_fbDeepLink){let data=FBInstant.getEntryPointData();data&&data.id&&(playQuery=data.id)}else"string"==typeof Utils.query("play",!0)&&(playQuery=Utils.query("play",!0));return playQuery?JSON.parse(atob(playQuery)):null},this.encodeQuery=function(data){return btoa(JSON.stringify(data))},this.appendShareData=function(id,value){try{let d=JSON.parse(atob(id));return d.s=value,btoa(JSON.stringify(d))}catch(error){return console.log("error appending share data"),id}},this.getTrackByCar=function(name){let track="test";switch(name){case"arx":track="arx";break;case"integra":track="integra";break;case"old_nsx":track="old_nsx";break;case"new_nsx":track="new_nsx";break;case"rdx":track="rdx";break;case"type_s":track="type_s"}return track},this.getTrackNumberByName=function(name){switch(name){case"old_nsx":return 1;case"integra":return 2;case"rdx":return 3;case"arx":return 4;case"new_nsx":return 5;case"type_s":return 6}return null},this.getTrackNameByNumber=function(number){switch(Number(number)){case 1:return"old_nsx";case 2:return"integra";case 3:return"rdx";case 4:return"arx";case 5:return"new_nsx";case 6:return"type_s"}return null},this.getCarByTrackNumber=function(index){switch(index){case 1:return"NSX";case 2:return"Integra";case 3:return"RDX";case 4:return"ARX";case 5:return"NSX";case 6:return"TYPE S"}return null},this.getSpecsByTrackNumber=function(index){switch(index){case 1:return{acceleration:.6,handling:.7,braking:.5};case 2:return{acceleration:.3,handling:.8,braking:.5};case 3:return{acceleration:.5,handling:.5,braking:.4};case 4:return{acceleration:1,handling:1,braking:1};case 5:return{acceleration:.9,handling:.8,braking:.8};case 6:return{acceleration:.7,handling:.6,braking:.6}}},this.allTracksUnlocked=async function(){let unlocked=!0;for(let name in _this.tracks){let track=_this.tracks[name],isUnlocked=await track.isUnlocked(),isAvailable=track.index<Config.TOTAL_LEVELS;!isUnlocked&&isAvailable&&(unlocked=!1)}return unlocked},this.setQualified=function(track){Storage.set(`qualified_${track}`,!0)},this.allTracksQualified=function(){let qualified=0;for(var i=0;i<Config.TOTAL_LEVELS;i++){let track=i+1;Storage.get(`qualified_${track}`)&&qualified++}return qualified>=Config.TOTAL_LEVELS},this.levelDeepLink=function(){if(Config.FACEBOOK){let data=FBInstant.getEntryPointData();if(data&&data.level)return data.level}return Utils.query("level")}}),"static"),window.ASSETS=["assets/js/lib/Klang.js","assets/js/lib/Sentry.js","assets/data/uil.json","assets/images/cars/arx/arx_BaseColor.jpg","assets/images/cars/arx/arx_BaseColor_2-merged/arx_BaseColor_2-merged-astc.ktx","assets/images/cars/arx/arx_BaseColor_2-merged/arx_BaseColor_2-merged-dxt.ktx","assets/images/cars/arx/arx_BaseColor_2-merged/arx_BaseColor_2-merged-pvrtc.ktx","assets/images/cars/arx/arx_BaseColor_2-merged.png","assets/images/cars/arx/arx_BaseColor_2.jpg","assets/images/cars/arx/arx_BaseColor_2.png","assets/images/cars/arx/arx_MRO/arx_MRO-astc.ktx","assets/images/cars/arx/arx_MRO/arx_MRO-dxt.ktx","assets/images/cars/arx/arx_MRO/arx_MRO-pvrtc.ktx","assets/images/cars/arx/arx_MRO.jpg","assets/images/cars/arx/arx_Normal/arx_Normal-astc.ktx","assets/images/cars/arx/arx_Normal/arx_Normal-dxt.ktx","assets/images/cars/arx/arx_Normal/arx_Normal-pvrtc.ktx","assets/images/cars/arx/arx_Normal.jpg","assets/images/cars/arx/arx_Paintmask.jpg","assets/images/cars/arx/arx_new.png","assets/images/cars/arx/lights/lights-astc.ktx","assets/images/cars/arx/lights/lights-dxt.ktx","assets/images/cars/arx/lights/lights-pvrtc.ktx","assets/images/cars/arx/lights.jpg","assets/images/cars/hum3dtest/ece5722e02029183fe11663c307db681-diffuse-sRGB.png","assets/images/cars/hum3dtest/ece5722e02029183fe11663c307db681-specular-sRGB.png","assets/images/cars/hum3dtest/ece5722e02029183fe11663c307db681.jpg","assets/images/cars/hum3dtest/honda_nsx.png","assets/images/cars/hum3dtest/hum3dtest_AO.jpg","assets/images/cars/hum3dtest/hum3dtest_Diffuse.jpg","assets/images/cars/hum3dtest/hum3dtest_Diffuse_dithered.png","assets/images/cars/hum3dtest/hum3dtest_Glossiness.jpg","assets/images/cars/hum3dtest/hum3dtest_MRO.jpg","assets/images/cars/hum3dtest/hum3dtest_Normal/hum3dtest_Normal-astc.ktx","assets/images/cars/hum3dtest/hum3dtest_Normal/hum3dtest_Normal-dxt.ktx","assets/images/cars/hum3dtest/hum3dtest_Normal/hum3dtest_Normal-pvrtc.ktx","assets/images/cars/hum3dtest/hum3dtest_Normal.jpg","assets/images/cars/hum3dtest/hum3dtest_Reflection.jpg","assets/images/cars/hum3dtest/hum3dtest_Specular.jpg","assets/images/cars/hum3dtest/hum3dtest_paintmask.jpg","assets/images/cars/hum3dtest/hum3dtest_paintmask.png","assets/images/cars/hum3dtest/istockphoto-671360592-612x612-diffuse-sRGB.png","assets/images/cars/hum3dtest/istockphoto-671360592-612x612-specular-sRGB.png","assets/images/cars/hum3dtest/istockphoto-671360592-612x612.jpg","assets/images/cars/hum3dtest/lighting.jpg","assets/images/cars/hum3dtest/lookup.png","assets/images/cars/hum3dtest/lookup_integra.png","assets/images/cars/hum3dtest/posterize.png","assets/images/cars/hum3dtest/spherical-360-degree-equirectangular-panorama-of-praa-do-povo-funchal-madeira-R1GEED-diffuse-sRGB.png","assets/images/cars/hum3dtest/spherical-360-degree-equirectangular-panorama-of-praa-do-povo-funchal-madeira-R1GEED-specular-sRGB.png","assets/images/cars/hum3dtest/spherical-360-degree-equirectangular-panorama-of-praa-do-povo-funchal-madeira-R1GEED.jpg","assets/images/cars/hum3dtest/window-mask.png","assets/images/cars/integra/integra_BaseColor-merged/integra_BaseColor-merged-astc.ktx","assets/images/cars/integra/integra_BaseColor-merged/integra_BaseColor-merged-dxt.ktx","assets/images/cars/integra/integra_BaseColor-merged/integra_BaseColor-merged-pvrtc.ktx","assets/images/cars/integra/integra_BaseColor-merged.png","assets/images/cars/integra/integra_BaseColor.jpg","assets/images/cars/integra/integra_MRO.jpg","assets/images/cars/integra/integra_Normal/integra_Normal-astc.ktx","assets/images/cars/integra/integra_Normal/integra_Normal-dxt.ktx","assets/images/cars/integra/integra_Normal/integra_Normal-pvrtc.ktx","assets/images/cars/integra/integra_Normal.jpg","assets/images/cars/integra/integra_lights/integra_lights-astc.ktx","assets/images/cars/integra/integra_lights/integra_lights-dxt.ktx","assets/images/cars/integra/integra_lights/integra_lights-pvrtc.ktx","assets/images/cars/integra/integra_lights.jpg","assets/images/cars/integra/integra_paintmask.jpg","assets/images/cars/integra/lookup.png","assets/images/cars/new_nsx/new_nsx_updated_BaseColor.png","assets/images/cars/new_nsx/new_nsx_updated_BaseColor_White-merged/new_nsx_updated_BaseColor_White-merged-astc.ktx","assets/images/cars/new_nsx/new_nsx_updated_BaseColor_White-merged/new_nsx_updated_BaseColor_White-merged-dxt.ktx","assets/images/cars/new_nsx/new_nsx_updated_BaseColor_White-merged/new_nsx_updated_BaseColor_White-merged-pvrtc.ktx","assets/images/cars/new_nsx/new_nsx_updated_BaseColor_White-merged.png","assets/images/cars/new_nsx/new_nsx_updated_BaseColor_White.png","assets/images/cars/new_nsx/new_nsx_updated_MRO/new_nsx_updated_MRO-astc.ktx","assets/images/cars/new_nsx/new_nsx_updated_MRO/new_nsx_updated_MRO-dxt.ktx","assets/images/cars/new_nsx/new_nsx_updated_MRO/new_nsx_updated_MRO-pvrtc.ktx","assets/images/cars/new_nsx/new_nsx_updated_MRO.png","assets/images/cars/new_nsx/new_nsx_updated_Normal/new_nsx_updated_Normal-astc.ktx","assets/images/cars/new_nsx/new_nsx_updated_Normal/new_nsx_updated_Normal-dxt.ktx","assets/images/cars/new_nsx/new_nsx_updated_Normal/new_nsx_updated_Normal-pvrtc.ktx","assets/images/cars/new_nsx/new_nsx_updated_Normal.png","assets/images/cars/new_nsx/new_nsx_updated_Paintmask.png","assets/images/cars/new_nsx/new_nsx_updated_brakelights/new_nsx_updated_brakelights-astc.ktx","assets/images/cars/new_nsx/new_nsx_updated_brakelights/new_nsx_updated_brakelights-dxt.ktx","assets/images/cars/new_nsx/new_nsx_updated_brakelights/new_nsx_updated_brakelights-pvrtc.ktx","assets/images/cars/new_nsx/new_nsx_updated_brakelights.png","assets/images/cars/new_nsx/new_nsx_updated_lights/new_nsx_updated_lights-astc.ktx","assets/images/cars/new_nsx/new_nsx_updated_lights/new_nsx_updated_lights-dxt.ktx","assets/images/cars/new_nsx/new_nsx_updated_lights/new_nsx_updated_lights-pvrtc.ktx","assets/images/cars/new_nsx/new_nsx_updated_lights.png","assets/images/cars/old_nsx/lights_alt.jpg","assets/images/cars/old_nsx/lookup.png","assets/images/cars/old_nsx/old_nsx_BaseColor-merged/old_nsx_BaseColor-merged-astc.ktx","assets/images/cars/old_nsx/old_nsx_BaseColor-merged/old_nsx_BaseColor-merged-dxt.ktx","assets/images/cars/old_nsx/old_nsx_BaseColor-merged/old_nsx_BaseColor-merged-pvrtc.ktx","assets/images/cars/old_nsx/old_nsx_BaseColor-merged.png","assets/images/cars/old_nsx/old_nsx_BaseColor.jpg","assets/images/cars/old_nsx/old_nsx_BaseColor2.jpg","assets/images/cars/old_nsx/old_nsx_lights/old_nsx_lights-astc.ktx","assets/images/cars/old_nsx/old_nsx_lights/old_nsx_lights-dxt.ktx","assets/images/cars/old_nsx/old_nsx_lights/old_nsx_lights-pvrtc.ktx","assets/images/cars/old_nsx/old_nsx_lights.jpg","assets/images/cars/old_nsx/old_nsx_paintmask.jpg","assets/images/cars/old_nsx/retro-sky.png","assets/images/cars/old_nsx/window-reflection.png","assets/images/cars/rdx/lookup.png","assets/images/cars/rdx/rdx_16bit_Normal/rdx_16bit_Normal-astc.ktx","assets/images/cars/rdx/rdx_16bit_Normal/rdx_16bit_Normal-dxt.ktx","assets/images/cars/rdx/rdx_16bit_Normal/rdx_16bit_Normal-pvrtc.ktx","assets/images/cars/rdx/rdx_16bit_Normal.png","assets/images/cars/rdx/rdx_BaseColor-merged/rdx_BaseColor-merged-astc.ktx","assets/images/cars/rdx/rdx_BaseColor-merged/rdx_BaseColor-merged-dxt.ktx","assets/images/cars/rdx/rdx_BaseColor-merged/rdx_BaseColor-merged-pvrtc.ktx","assets/images/cars/rdx/rdx_BaseColor-merged.png","assets/images/cars/rdx/rdx_BaseColor2/rdx_BaseColor2-astc.ktx","assets/images/cars/rdx/rdx_BaseColor2/rdx_BaseColor2-dxt.ktx","assets/images/cars/rdx/rdx_BaseColor2/rdx_BaseColor2-pvrtc.ktx","assets/images/cars/rdx/rdx_BaseColor2.jpg","assets/images/cars/rdx/rdx_BaseColor3/rdx_BaseColor3-astc.ktx","assets/images/cars/rdx/rdx_BaseColor3/rdx_BaseColor3-dxt.ktx","assets/images/cars/rdx/rdx_BaseColor3/rdx_BaseColor3-pvrtc.ktx","assets/images/cars/rdx/rdx_BaseColor3.jpg","assets/images/cars/rdx/rdx_BaseColor4-merged/rdx_BaseColor4-merged-astc.ktx","assets/images/cars/rdx/rdx_BaseColor4-merged/rdx_BaseColor4-merged-dxt.ktx","assets/images/cars/rdx/rdx_BaseColor4-merged/rdx_BaseColor4-merged-pvrtc.ktx","assets/images/cars/rdx/rdx_BaseColor4-merged.png","assets/images/cars/rdx/rdx_BaseColor4.png","assets/images/cars/rdx/rdx_MRO/rdx_MRO-astc.ktx","assets/images/cars/rdx/rdx_MRO/rdx_MRO-dxt.ktx","assets/images/cars/rdx/rdx_MRO/rdx_MRO-pvrtc.ktx","assets/images/cars/rdx/rdx_MRO.jpg","assets/images/cars/rdx/rdx_headlights/rdx_headlights-astc.ktx","assets/images/cars/rdx/rdx_headlights/rdx_headlights-dxt.ktx","assets/images/cars/rdx/rdx_headlights/rdx_headlights-pvrtc.ktx","assets/images/cars/rdx/rdx_headlights.jpg","assets/images/cars/rdx/rdx_lights/rdx_lights-astc.ktx","assets/images/cars/rdx/rdx_lights/rdx_lights-dxt.ktx","assets/images/cars/rdx/rdx_lights/rdx_lights-pvrtc.ktx","assets/images/cars/rdx/rdx_lights.jpg","assets/images/cars/rdx/rdx_paintmask.jpg","assets/images/cars/type_s/carconfig_template_type_s_2_BaseColor-merged/carconfig_template_type_s_2_BaseColor-merged-astc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_BaseColor-merged/carconfig_template_type_s_2_BaseColor-merged-dxt.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_BaseColor-merged/carconfig_template_type_s_2_BaseColor-merged-pvrtc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_BaseColor-merged.png","assets/images/cars/type_s/carconfig_template_type_s_2_BaseColor.png","assets/images/cars/type_s/carconfig_template_type_s_2_MRO/carconfig_template_type_s_2_MRO-astc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_MRO/carconfig_template_type_s_2_MRO-dxt.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_MRO/carconfig_template_type_s_2_MRO-pvrtc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_MRO.png","assets/images/cars/type_s/carconfig_template_type_s_2_Normal/carconfig_template_type_s_2_Normal-astc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_Normal/carconfig_template_type_s_2_Normal-dxt.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_Normal/carconfig_template_type_s_2_Normal-pvrtc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_Normal.png","assets/images/cars/type_s/carconfig_template_type_s_2_Paintmask.png","assets/images/cars/type_s/carconfig_template_type_s_2_headlights/carconfig_template_type_s_2_headlights-astc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_headlights/carconfig_template_type_s_2_headlights-dxt.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_headlights/carconfig_template_type_s_2_headlights-pvrtc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_headlights.png","assets/images/cars/type_s/carconfig_template_type_s_2_lights/carconfig_template_type_s_2_lights-astc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_lights/carconfig_template_type_s_2_lights-dxt.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_lights/carconfig_template_type_s_2_lights-pvrtc.ktx","assets/images/cars/type_s/carconfig_template_type_s_2_lights.png","assets/images/environment/arx/ads/ads.jpg","assets/images/environment/arx/ads.jpg","assets/images/environment/arx/asphalt_fine_cracked_diffuse/asphalt_fine_cracked_diffuse-astc.ktx","assets/images/environment/arx/asphalt_fine_cracked_diffuse/asphalt_fine_cracked_diffuse-dxt.ktx","assets/images/environment/arx/asphalt_fine_cracked_diffuse/asphalt_fine_cracked_diffuse-pvrtc.ktx","assets/images/environment/arx/asphalt_fine_cracked_diffuse.jpg","assets/images/environment/arx/asphalt_fine_cracked_mro/asphalt_fine_cracked_mro-astc.ktx","assets/images/environment/arx/asphalt_fine_cracked_mro/asphalt_fine_cracked_mro-dxt.ktx","assets/images/environment/arx/asphalt_fine_cracked_mro/asphalt_fine_cracked_mro-pvrtc.ktx","assets/images/environment/arx/asphalt_fine_cracked_mro.jpg","assets/images/environment/arx/asphalt_fine_cracked_normal/asphalt_fine_cracked_normal-astc.ktx","assets/images/environment/arx/asphalt_fine_cracked_normal/asphalt_fine_cracked_normal-dxt.ktx","assets/images/environment/arx/asphalt_fine_cracked_normal/asphalt_fine_cracked_normal-pvrtc.ktx","assets/images/environment/arx/asphalt_fine_cracked_normal.jpg","assets/images/environment/arx/asphalt_fine_cracked_roughness.jpg","assets/images/environment/arx/building_long_basecolor/building_long_basecolor-astc.ktx","assets/images/environment/arx/building_long_basecolor/building_long_basecolor-dxt.ktx","assets/images/environment/arx/building_long_basecolor/building_long_basecolor-pvrtc.ktx","assets/images/environment/arx/building_long_basecolor.jpg","assets/images/environment/arx/building_long_basecolor.png","assets/images/environment/arx/building_long_mro/building_long_mro-astc.ktx","assets/images/environment/arx/building_long_mro/building_long_mro-dxt.ktx","assets/images/environment/arx/building_long_mro/building_long_mro-pvrtc.ktx","assets/images/environment/arx/building_long_mro.jpg","assets/images/environment/arx/building_long_normal/building_long_normal-astc.ktx","assets/images/environment/arx/building_long_normal/building_long_normal-dxt.ktx","assets/images/environment/arx/building_long_normal/building_long_normal-pvrtc.ktx","assets/images/environment/arx/building_long_normal.jpg","assets/images/environment/arx/building_tall_basecolor/building_tall_basecolor-astc.ktx","assets/images/environment/arx/building_tall_basecolor/building_tall_basecolor-dxt.ktx","assets/images/environment/arx/building_tall_basecolor/building_tall_basecolor-pvrtc.ktx","assets/images/environment/arx/building_tall_basecolor.jpg","assets/images/environment/arx/building_tall_basecolor.png","assets/images/environment/arx/building_tall_mro/building_tall_mro-astc.ktx","assets/images/environment/arx/building_tall_mro/building_tall_mro-dxt.ktx","assets/images/environment/arx/building_tall_mro/building_tall_mro-pvrtc.ktx","assets/images/environment/arx/building_tall_mro.jpg","assets/images/environment/arx/building_tall_normal/building_tall_normal-astc.ktx","assets/images/environment/arx/building_tall_normal/building_tall_normal-dxt.ktx","assets/images/environment/arx/building_tall_normal/building_tall_normal-pvrtc.ktx","assets/images/environment/arx/building_tall_normal.jpg","assets/images/environment/arx/buildingb_normal/buildingb_normal-astc.ktx","assets/images/environment/arx/buildingb_normal/buildingb_normal-dxt.ktx","assets/images/environment/arx/buildingb_normal/buildingb_normal-pvrtc.ktx","assets/images/environment/arx/buildingb_normal.jpg","assets/images/environment/arx/buildingb_normal.png","assets/images/environment/arx/buildingplane1.png","assets/images/environment/arx/checkpoint_diffuse/checkpoint_diffuse-astc.ktx","assets/images/environment/arx/checkpoint_diffuse/checkpoint_diffuse-dxt.ktx","assets/images/environment/arx/checkpoint_diffuse/checkpoint_diffuse-pvrtc.ktx","assets/images/environment/arx/checkpoint_diffuse.jpg","assets/images/environment/arx/checkpoint_diffuse_finish/checkpoint_diffuse_finish-astc.ktx","assets/images/environment/arx/checkpoint_diffuse_finish/checkpoint_diffuse_finish-dxt.ktx","assets/images/environment/arx/checkpoint_diffuse_finish/checkpoint_diffuse_finish-pvrtc.ktx","assets/images/environment/arx/checkpoint_diffuse_finish.jpg","assets/images/environment/arx/checkpoint_mro/checkpoint_mro-astc.ktx","assets/images/environment/arx/checkpoint_mro/checkpoint_mro-dxt.ktx","assets/images/environment/arx/checkpoint_mro/checkpoint_mro-pvrtc.ktx","assets/images/environment/arx/checkpoint_mro.jpg","assets/images/environment/arx/checkpoint_normal/checkpoint_normal-astc.ktx","assets/images/environment/arx/checkpoint_normal/checkpoint_normal-dxt.ktx","assets/images/environment/arx/checkpoint_normal/checkpoint_normal-pvrtc.ktx","assets/images/environment/arx/checkpoint_normal.jpg","assets/images/environment/arx/fence_basecolor/fence_basecolor-astc.ktx","assets/images/environment/arx/fence_basecolor/fence_basecolor-dxt.ktx","assets/images/environment/arx/fence_basecolor/fence_basecolor-pvrtc.ktx","assets/images/environment/arx/fence_basecolor.jpg","assets/images/environment/arx/fence_mro/fence_mro-astc.ktx","assets/images/environment/arx/fence_mro/fence_mro-dxt.ktx","assets/images/environment/arx/fence_mro/fence_mro-pvrtc.ktx","assets/images/environment/arx/fence_mro.jpg","assets/images/environment/arx/fence_normal/fence_normal-astc.ktx","assets/images/environment/arx/fence_normal/fence_normal-dxt.ktx","assets/images/environment/arx/fence_normal/fence_normal-pvrtc.ktx","assets/images/environment/arx/fence_normal.jpg","assets/images/environment/arx/fence_opacity/fence_opacity-astc.ktx","assets/images/environment/arx/fence_opacity/fence_opacity-dxt.ktx","assets/images/environment/arx/fence_opacity/fence_opacity-pvrtc.ktx","assets/images/environment/arx/fence_opacity/fence_opacity.jpg","assets/images/environment/arx/fence_opacity.jpg","assets/images/environment/arx/finish-line/finish-line-astc.ktx","assets/images/environment/arx/finish-line/finish-line-dxt.ktx","assets/images/environment/arx/finish-line/finish-line-pvrtc.ktx","assets/images/environment/arx/finish-line.png","assets/images/environment/arx/finish-line_alpha.jpg","assets/images/environment/arx/finish-line_basecolor/finish-line_basecolor-astc.ktx","assets/images/environment/arx/finish-line_basecolor/finish-line_basecolor-dxt.ktx","assets/images/environment/arx/finish-line_basecolor/finish-line_basecolor-pvrtc.ktx","assets/images/environment/arx/finish-line_basecolor.jpg","assets/images/environment/arx/finish_mro/finish_mro-astc.ktx","assets/images/environment/arx/finish_mro/finish_mro-dxt.ktx","assets/images/environment/arx/finish_mro/finish_mro-pvrtc.ktx","assets/images/environment/arx/finish_mro.jpg","assets/images/environment/arx/grandstand_diffuse.jpg","assets/images/environment/arx/grass_MRO/grass_MRO-astc.ktx","assets/images/environment/arx/grass_MRO/grass_MRO-dxt.ktx","assets/images/environment/arx/grass_MRO/grass_MRO-pvrtc.ktx","assets/images/environment/arx/grass_MRO.jpg","assets/images/environment/arx/grass_diffuse/grass_diffuse-astc.ktx","assets/images/environment/arx/grass_diffuse/grass_diffuse-dxt.ktx","assets/images/environment/arx/grass_diffuse/grass_diffuse-pvrtc.ktx","assets/images/environment/arx/grass_diffuse/grass_diffuse.jpg","assets/images/environment/arx/grass_diffuse.jpg","assets/images/environment/arx/grass_normal/grass_normal-astc.ktx","assets/images/environment/arx/grass_normal/grass_normal-dxt.ktx","assets/images/environment/arx/grass_normal/grass_normal-pvrtc.ktx","assets/images/environment/arx/grass_normal.jpg","assets/images/environment/arx/ground_basecolor.png","assets/images/environment/arx/ground_basecolor_light/ground_basecolor_light-astc.ktx","assets/images/environment/arx/ground_basecolor_light/ground_basecolor_light-dxt.ktx","assets/images/environment/arx/ground_basecolor_light/ground_basecolor_light-pvrtc.ktx","assets/images/environment/arx/ground_basecolor_light.jpg","assets/images/environment/arx/ground_mro/ground_mro-astc.ktx","assets/images/environment/arx/ground_mro/ground_mro-dxt.ktx","assets/images/environment/arx/ground_mro/ground_mro-pvrtc.ktx","assets/images/environment/arx/ground_mro.jpg","assets/images/environment/arx/ground_normal/ground_normal-astc.ktx","assets/images/environment/arx/ground_normal/ground_normal-dxt.ktx","assets/images/environment/arx/ground_normal/ground_normal-pvrtc.ktx","assets/images/environment/arx/ground_normal.jpg","assets/images/environment/arx/palm_alpha.jpg","assets/images/environment/arx/palm_diffuse/palm_diffuse-astc.ktx","assets/images/environment/arx/palm_diffuse/palm_diffuse-dxt.ktx","assets/images/environment/arx/palm_diffuse/palm_diffuse-pvrtc.ktx","assets/images/environment/arx/palm_diffuse.jpg","assets/images/environment/arx/palm_normal/palm_normal-astc.ktx","assets/images/environment/arx/palm_normal/palm_normal-dxt.ktx","assets/images/environment/arx/palm_normal/palm_normal-pvrtc.ktx","assets/images/environment/arx/palm_normal.jpg","assets/images/environment/arx/pano-acura-beat-that-1578200654608-diffuse-sRGB/pano-acura-beat-that-1578200654608-diffuse-sRGB.png","assets/images/environment/arx/pano-acura-beat-that-1578200654608-diffuse-sRGB.png","assets/images/environment/arx/pano-acura-beat-that-1578200654608-specular-sRGB.png","assets/images/environment/arx/pano-acura-beat-that-1578200654608.png","assets/images/environment/arx/pbuilding_01_diffuse/pbuilding_01_diffuse-astc.ktx","assets/images/environment/arx/pbuilding_01_diffuse/pbuilding_01_diffuse-dxt.ktx","assets/images/environment/arx/pbuilding_01_diffuse/pbuilding_01_diffuse-pvrtc.ktx","assets/images/environment/arx/pbuilding_01_diffuse/pbuilding_01_diffuse.jpg","assets/images/environment/arx/pbuilding_01_diffuse.jpg","assets/images/environment/arx/pbuilding_02_diffuse/pbuilding_02_diffuse-astc.ktx","assets/images/environment/arx/pbuilding_02_diffuse/pbuilding_02_diffuse-dxt.ktx","assets/images/environment/arx/pbuilding_02_diffuse/pbuilding_02_diffuse-pvrtc.ktx","assets/images/environment/arx/pbuilding_02_diffuse.jpg","assets/images/environment/arx/pbuilding_03_diffuse/pbuilding_03_diffuse-astc.ktx","assets/images/environment/arx/pbuilding_03_diffuse/pbuilding_03_diffuse-dxt.ktx","assets/images/environment/arx/pbuilding_03_diffuse/pbuilding_03_diffuse-pvrtc.ktx","assets/images/environment/arx/pbuilding_03_diffuse.jpg","assets/images/environment/arx/pbuilding_03_mro.jpg","assets/images/environment/arx/pbuilding_04_diffuse/pbuilding_04_diffuse-astc.ktx","assets/images/environment/arx/pbuilding_04_diffuse/pbuilding_04_diffuse-dxt.ktx","assets/images/environment/arx/pbuilding_04_diffuse/pbuilding_04_diffuse-pvrtc.ktx","assets/images/environment/arx/pbuilding_04_diffuse.jpg","assets/images/environment/arx/pbuilding_05_diffuse/pbuilding_05_diffuse-astc.ktx","assets/images/environment/arx/pbuilding_05_diffuse/pbuilding_05_diffuse-dxt.ktx","assets/images/environment/arx/pbuilding_05_diffuse/pbuilding_05_diffuse-pvrtc.ktx","assets/images/environment/arx/pbuilding_05_diffuse.jpg","assets/images/environment/arx/pbuilding_08_diffuse/pbuilding_08_diffuse-astc.ktx","assets/images/environment/arx/pbuilding_08_diffuse/pbuilding_08_diffuse-dxt.ktx","assets/images/environment/arx/pbuilding_08_diffuse/pbuilding_08_diffuse-pvrtc.ktx","assets/images/environment/arx/pbuilding_08_diffuse.jpg","assets/images/environment/arx/sky.jpg","assets/images/environment/arx/sky_2.jpg","assets/images/environment/arx/sky_2_sanssun.jpg","assets/images/environment/arx/white/white-astc.ktx","assets/images/environment/arx/white/white-dxt.ktx","assets/images/environment/arx/white/white-pvrtc.ktx","assets/images/environment/arx/white.jpg","assets/images/environment/asphalt/asphalt_diffuse.png","assets/images/environment/asphalt/asphalt_glossiness.png","assets/images/environment/asphalt/asphalt_mro.jpg","assets/images/environment/asphalt/asphalt_normal.png","assets/images/environment/black.jpg","assets/images/environment/garage/00-1-diffuse-sRGB.png","assets/images/environment/garage/00-1-specular-sRGB.png","assets/images/environment/garage/00-1.jpg","assets/images/environment/garage/00-2-diffuse-sRGB.png","assets/images/environment/garage/00-2-specular-sRGB.png","assets/images/environment/garage/00-2.jpg","assets/images/environment/garage/1.jpg","assets/images/environment/garage/2-old.jpg","assets/images/environment/garage/2.jpg","assets/images/environment/garage/3.jpg","assets/images/environment/garage/floor_BaseColor.jpg","assets/images/environment/garage/floor_MRO/floor_MRO-astc.ktx","assets/images/environment/garage/floor_MRO/floor_MRO-dxt.ktx","assets/images/environment/garage/floor_MRO/floor_MRO-pvrtc.ktx","assets/images/environment/garage/floor_MRO.jpg","assets/images/environment/garage/floor_Normal/floor_Normal-astc.ktx","assets/images/environment/garage/floor_Normal/floor_Normal-dxt.ktx","assets/images/environment/garage/floor_Normal/floor_Normal-pvrtc.ktx","assets/images/environment/garage/floor_Normal.jpg","assets/images/environment/garage/top-detail_BaseColor/top-detail_BaseColor-astc.ktx","assets/images/environment/garage/top-detail_BaseColor/top-detail_BaseColor-dxt.ktx","assets/images/environment/garage/top-detail_BaseColor/top-detail_BaseColor-pvrtc.ktx","assets/images/environment/garage/top-detail_BaseColor.jpg","assets/images/environment/garage/top-detail_MRO/top-detail_MRO-astc.ktx","assets/images/environment/garage/top-detail_MRO/top-detail_MRO-dxt.ktx","assets/images/environment/garage/top-detail_MRO/top-detail_MRO-pvrtc.ktx","assets/images/environment/garage/top-detail_MRO.jpg","assets/images/environment/garage/top-detail_Normal/top-detail_Normal.jpg","assets/images/environment/garage/top-detail_Normal.jpg","assets/images/environment/garage/wall_BaseColor.jpg","assets/images/environment/garage/wall_MRO/wall_MRO-astc.ktx","assets/images/environment/garage/wall_MRO/wall_MRO-dxt.ktx","assets/images/environment/garage/wall_MRO/wall_MRO-pvrtc.ktx","assets/images/environment/garage/wall_MRO.jpg","assets/images/environment/garage/wall_Normal/wall_Normal-astc.ktx","assets/images/environment/garage/wall_Normal/wall_Normal-dxt.ktx","assets/images/environment/garage/wall_Normal/wall_Normal-pvrtc.ktx","assets/images/environment/garage/wall_Normal.jpg","assets/images/environment/grey/grey-astc.ktx","assets/images/environment/grey/grey-dxt.ktx","assets/images/environment/grey/grey-pvrtc.ktx","assets/images/environment/grey/grey.jpg","assets/images/environment/grey.jpg","assets/images/environment/integra/LB_building-2/LB_building-2-astc.ktx","assets/images/environment/integra/LB_building-2/LB_building-2-dxt.ktx","assets/images/environment/integra/LB_building-2/LB_building-2-pvrtc.ktx","assets/images/environment/integra/LB_building-2.jpg","assets/images/environment/integra/LB_building-3/LB_building-3-astc.ktx","assets/images/environment/integra/LB_building-3/LB_building-3-dxt.ktx","assets/images/environment/integra/LB_building-3/LB_building-3-pvrtc.ktx","assets/images/environment/integra/LB_building-3.jpg","assets/images/environment/integra/LB_building-4/LB_building-4-astc.ktx","assets/images/environment/integra/LB_building-4/LB_building-4-dxt.ktx","assets/images/environment/integra/LB_building-4/LB_building-4-pvrtc.ktx","assets/images/environment/integra/LB_building-4.jpg","assets/images/environment/integra/LB_building-6/LB_building-6-astc.ktx","assets/images/environment/integra/LB_building-6/LB_building-6-dxt.ktx","assets/images/environment/integra/LB_building-6/LB_building-6-pvrtc.ktx","assets/images/environment/integra/LB_building-6.jpg","assets/images/environment/integra/checkpoint/checkpoint-astc.ktx","assets/images/environment/integra/checkpoint/checkpoint-dxt.ktx","assets/images/environment/integra/checkpoint/checkpoint-pvrtc.ktx","assets/images/environment/integra/checkpoint.png","assets/images/environment/integra/concrete_tiling/concrete_tiling-astc.ktx","assets/images/environment/integra/concrete_tiling/concrete_tiling-dxt.ktx","assets/images/environment/integra/concrete_tiling/concrete_tiling-pvrtc.ktx","assets/images/environment/integra/concrete_tiling.jpg","assets/images/environment/integra/finish/finish-astc.ktx","assets/images/environment/integra/finish/finish-dxt.ktx","assets/images/environment/integra/finish/finish-pvrtc.ktx","assets/images/environment/integra/finish.png","assets/images/environment/integra/integra_concrete/integra_concrete-astc.ktx","assets/images/environment/integra/integra_concrete/integra_concrete-dxt.ktx","assets/images/environment/integra/integra_concrete/integra_concrete-pvrtc.ktx","assets/images/environment/integra/integra_concrete.jpg","assets/images/environment/integra/integra_pole5_diffuse/integra_pole5_diffuse-astc.ktx","assets/images/environment/integra/integra_pole5_diffuse/integra_pole5_diffuse-dxt.ktx","assets/images/environment/integra/integra_pole5_diffuse/integra_pole5_diffuse-pvrtc.ktx","assets/images/environment/integra/integra_pole5_diffuse.png","assets/images/environment/integra/integra_road/integra_road-astc.ktx","assets/images/environment/integra/integra_road/integra_road-dxt.ktx","assets/images/environment/integra/integra_road/integra_road-pvrtc.ktx","assets/images/environment/integra/integra_road.jpg","assets/images/environment/integra/integra_road.png","assets/images/environment/integra/integra_sky.jpg","assets/images/environment/integra/lookup.png","assets/images/environment/integra/pano-acura-beat-that-1578446604880-diffuse-sRGB.png","assets/images/environment/integra/pano-acura-beat-that-1578446604880-specular-sRGB.png","assets/images/environment/integra/postprocessing.png","assets/images/environment/integra/road_grey.jpg","assets/images/environment/integra/tree.png","assets/images/environment/integra/tree_transparency.png","assets/images/environment/istockphoto-1036688544-170667a-diffuse-sRGB.png","assets/images/environment/istockphoto-1036688544-170667a-specular-sRGB.png","assets/images/environment/istockphoto-1036688544-170667a.jpg","assets/images/environment/lookup.png","assets/images/environment/new_nsx/49TH_STREET_environment-diffuse-sRGB.png","assets/images/environment/new_nsx/49TH_STREET_environment-specular-sRGB.png","assets/images/environment/new_nsx/arrows.jpg","assets/images/environment/new_nsx/building_01_lightmap/building_01_lightmap-astc.ktx","assets/images/environment/new_nsx/building_01_lightmap/building_01_lightmap-dxt.ktx","assets/images/environment/new_nsx/building_01_lightmap/building_01_lightmap-pvrtc.ktx","assets/images/environment/new_nsx/building_01_lightmap.jpg","assets/images/environment/new_nsx/building_02_lightmap/building_02_lightmap-astc.ktx","assets/images/environment/new_nsx/building_02_lightmap/building_02_lightmap-dxt.ktx","assets/images/environment/new_nsx/building_02_lightmap/building_02_lightmap-pvrtc.ktx","assets/images/environment/new_nsx/building_02_lightmap.jpg","assets/images/environment/new_nsx/building_03_lightmap/building_03_lightmap-astc.ktx","assets/images/environment/new_nsx/building_03_lightmap/building_03_lightmap-dxt.ktx","assets/images/environment/new_nsx/building_03_lightmap/building_03_lightmap-pvrtc.ktx","assets/images/environment/new_nsx/building_03_lightmap.jpg","assets/images/environment/new_nsx/building_04_lightmap.jpg","assets/images/environment/new_nsx/building_08_lightmap/building_08_lightmap-astc.ktx","assets/images/environment/new_nsx/building_08_lightmap/building_08_lightmap-dxt.ktx","assets/images/environment/new_nsx/building_08_lightmap/building_08_lightmap-pvrtc.ktx","assets/images/environment/new_nsx/building_08_lightmap.jpg","assets/images/environment/new_nsx/checkpoint_newnsx.jpg","assets/images/environment/new_nsx/finish.jpg","assets/images/environment/new_nsx/groundlight.jpg","assets/images/environment/new_nsx/groundlight2.jpg","assets/images/environment/new_nsx/nsx_road_2_basecolor/nsx_road_2_basecolor-astc.ktx","assets/images/environment/new_nsx/nsx_road_2_basecolor/nsx_road_2_basecolor-dxt.ktx","assets/images/environment/new_nsx/nsx_road_2_basecolor/nsx_road_2_basecolor-pvrtc.ktx","assets/images/environment/new_nsx/nsx_road_2_basecolor.jpg","assets/images/environment/new_nsx/nsx_road_2_mro/nsx_road_2_mro-astc.ktx","assets/images/environment/new_nsx/nsx_road_2_mro/nsx_road_2_mro-dxt.ktx","assets/images/environment/new_nsx/nsx_road_2_mro/nsx_road_2_mro-pvrtc.ktx","assets/images/environment/new_nsx/nsx_road_2_mro.jpg","assets/images/environment/new_nsx/nsx_road_2_normal/nsx_road_2_normal-astc.ktx","assets/images/environment/new_nsx/nsx_road_2_normal/nsx_road_2_normal-dxt.ktx","assets/images/environment/new_nsx/nsx_road_2_normal/nsx_road_2_normal-pvrtc.ktx","assets/images/environment/new_nsx/nsx_road_2_normal.jpg","assets/images/environment/new_nsx/pano-acura-beat-that-1580256483404-diffuse-sRGB.png","assets/images/environment/new_nsx/pano-acura-beat-that-1580256483404-specular-sRGB.png","assets/images/environment/new_nsx/pano-acura-beat-that-1580845458586-specular-sRGB.png","assets/images/environment/new_nsx/pbuilding_03_emission.jpg","assets/images/environment/new_nsx/pbuilding_03_normal.jpg","assets/images/environment/new_nsx/rain.jpg","assets/images/environment/new_nsx/signsheet/signsheet-astc.ktx","assets/images/environment/new_nsx/signsheet/signsheet-dxt.ktx","assets/images/environment/new_nsx/signsheet/signsheet-pvrtc.ktx","assets/images/environment/new_nsx/signsheet.jpg","assets/images/environment/new_nsx/types_road_output_lightmap.jpg","assets/images/environment/normal/normal-astc.ktx","assets/images/environment/normal/normal-dxt.ktx","assets/images/environment/normal/normal-pvrtc.ktx","assets/images/environment/normal.jpg","assets/images/environment/old_nsx/arrow.png","assets/images/environment/old_nsx/blimp.jpg","assets/images/environment/old_nsx/checkpoint/checkpoint-astc.ktx","assets/images/environment/old_nsx/checkpoint/checkpoint-dxt.ktx","assets/images/environment/old_nsx/checkpoint/checkpoint-pvrtc.ktx","assets/images/environment/old_nsx/checkpoint.png","assets/images/environment/old_nsx/cloud.jpg","assets/images/environment/old_nsx/cloud.png","assets/images/environment/old_nsx/finish/finish-astc.ktx","assets/images/environment/old_nsx/finish/finish-dxt.ktx","assets/images/environment/old_nsx/finish/finish-pvrtc.ktx","assets/images/environment/old_nsx/finish/finish.png","assets/images/environment/old_nsx/finish.png","assets/images/environment/old_nsx/lookup-water.png","assets/images/environment/old_nsx/lookup.png","assets/images/environment/old_nsx/mountain-mask.png","assets/images/environment/old_nsx/noise.png","assets/images/environment/old_nsx/normal2/normal2-astc.ktx","assets/images/environment/old_nsx/normal2/normal2-dxt.ktx","assets/images/environment/old_nsx/normal2/normal2-pvrtc.ktx","assets/images/environment/old_nsx/normal2.jpg","assets/images/environment/old_nsx/pano-acura-beat-that-1578109849434-diffuse-sRGB.png","assets/images/environment/old_nsx/pano-acura-beat-that-1578109849434-specular-sRGB.png","assets/images/environment/old_nsx/pano-acura-beat-that-1578109849434.jpg","assets/images/environment/old_nsx/pano-acura-beat-that-1578109849434.png","assets/images/environment/old_nsx/railing.png","assets/images/environment/old_nsx/railing_normal.jpg","assets/images/environment/old_nsx/railing_opacity.jpg","assets/images/environment/old_nsx/reflection.png","assets/images/environment/old_nsx/road.png","assets/images/environment/old_nsx/water.jpg","assets/images/environment/old_nsx/waternormals.jpg","assets/images/environment/powerup.png","assets/images/environment/rdx/RockCubicA_diffuse/RockCubicA_diffuse-astc.ktx","assets/images/environment/rdx/RockCubicA_diffuse/RockCubicA_diffuse-dxt.ktx","assets/images/environment/rdx/RockCubicA_diffuse/RockCubicA_diffuse-pvrtc.ktx","assets/images/environment/rdx/RockCubicA_diffuse.jpg","assets/images/environment/rdx/cloud.jpg","assets/images/environment/rdx/finish-graphic.png","assets/images/environment/rdx/iceroad_MRO/iceroad_MRO-astc.ktx","assets/images/environment/rdx/iceroad_MRO/iceroad_MRO-dxt.ktx","assets/images/environment/rdx/iceroad_MRO/iceroad_MRO-pvrtc.ktx","assets/images/environment/rdx/iceroad_MRO.png","assets/images/environment/rdx/iceroad_basecolor/iceroad_basecolor-astc.ktx","assets/images/environment/rdx/iceroad_basecolor/iceroad_basecolor-dxt.ktx","assets/images/environment/rdx/iceroad_basecolor/iceroad_basecolor-pvrtc.ktx","assets/images/environment/rdx/iceroad_basecolor.png","assets/images/environment/rdx/iceroad_normal/iceroad_normal-astc.ktx","assets/images/environment/rdx/iceroad_normal/iceroad_normal-dxt.ktx","assets/images/environment/rdx/iceroad_normal/iceroad_normal-pvrtc.ktx","assets/images/environment/rdx/iceroad_normal.png","assets/images/environment/rdx/iceroad_opacity.png","assets/images/environment/rdx/icewall_MRO/icewall_MRO-astc.ktx","assets/images/environment/rdx/icewall_MRO/icewall_MRO-dxt.ktx","assets/images/environment/rdx/icewall_MRO/icewall_MRO-pvrtc.ktx","assets/images/environment/rdx/icewall_MRO.png","assets/images/environment/rdx/icewall_basecolor/icewall_basecolor-astc.ktx","assets/images/environment/rdx/icewall_basecolor/icewall_basecolor-dxt.ktx","assets/images/environment/rdx/icewall_basecolor/icewall_basecolor-pvrtc.ktx","assets/images/environment/rdx/icewall_basecolor.png","assets/images/environment/rdx/icewall_normal/icewall_normal-astc.ktx","assets/images/environment/rdx/icewall_normal/icewall_normal-dxt.ktx","assets/images/environment/rdx/icewall_normal/icewall_normal-pvrtc.ktx","assets/images/environment/rdx/icewall_normal.png","assets/images/environment/rdx/lookup.png","assets/images/environment/rdx/mountain_normal/mountain_normal-astc.ktx","assets/images/environment/rdx/mountain_normal/mountain_normal-dxt.ktx","assets/images/environment/rdx/mountain_normal/mountain_normal-pvrtc.ktx","assets/images/environment/rdx/mountain_normal/mountain_normal.jpg","assets/images/environment/rdx/mountain_normal.jpg","assets/images/environment/rdx/pano-acura-beat-that-1578537723439-diffuse-sRGB.png","assets/images/environment/rdx/pano-acura-beat-that-1578537723439-specular-sRGB.png","assets/images/environment/rdx/rdx_checkpoint/rdx_checkpoint-astc.ktx","assets/images/environment/rdx/rdx_checkpoint/rdx_checkpoint-dxt.ktx","assets/images/environment/rdx/rdx_checkpoint/rdx_checkpoint-pvrtc.ktx","assets/images/environment/rdx/rdx_checkpoint.png","assets/images/environment/rdx/rock_normal/rock_normal-astc.ktx","assets/images/environment/rdx/rock_normal/rock_normal-dxt.ktx","assets/images/environment/rdx/rock_normal/rock_normal-pvrtc.ktx","assets/images/environment/rdx/rock_normal.jpg","assets/images/environment/rdx/sky.jpg","assets/images/environment/rdx/snow-combined.jpg","assets/images/environment/rdx/snow.jpg","assets/images/environment/rdx/snow2.jpg","assets/images/environment/road/asphalt_bare.jpg","assets/images/environment/road/road_tiled.jpg","assets/images/environment/road/snowroad_tiled.jpg","assets/images/environment/skybox/tan_gradient.jpg","assets/images/environment/spec-diffuse-sRGB.png","assets/images/environment/spec-specular-sRGB.png","assets/images/environment/types/arrow.png","assets/images/environment/types/blue-diffuse-sRGB.jpg","assets/images/environment/types/blue-specular-sRGB.jpg","assets/images/environment/types/blue2-diffuse-sRGB.jpg","assets/images/environment/types/blue2-specular-sRGB.jpg","assets/images/environment/types/ceiling_lights_basecolor/ceiling_lights_basecolor-astc.ktx","assets/images/environment/types/ceiling_lights_basecolor/ceiling_lights_basecolor-dxt.ktx","assets/images/environment/types/ceiling_lights_basecolor/ceiling_lights_basecolor-pvrtc.ktx","assets/images/environment/types/ceiling_lights_basecolor.jpg","assets/images/environment/types/ceiling_lights_basecolor.png","assets/images/environment/types/ceiling_lights_vertical/ceiling_lights_vertical-astc.ktx","assets/images/environment/types/ceiling_lights_vertical/ceiling_lights_vertical-dxt.ktx","assets/images/environment/types/ceiling_lights_vertical/ceiling_lights_vertical-pvrtc.ktx","assets/images/environment/types/ceiling_lights_vertical/ceiling_lights_vertical.jpg","assets/images/environment/types/ceiling_lights_vertical.jpg","assets/images/environment/types/checkpoint.jpg","assets/images/environment/types/checkpoint_types.jpg","assets/images/environment/types/finish.jpg","assets/images/environment/types/pano-acura-beat-that-1580256799280-diffuse-sRGB.png","assets/images/environment/types/pano-acura-beat-that-1580256799280-specular-sRGB.png","assets/images/environment/types/pano-acura-beat-that-1580438473787-diffuse-sRGB.png","assets/images/environment/types/pano-acura-beat-that-1580438473787-specular-sRGB.png","assets/images/environment/types/pano-acura-beat-that-1580948310130-diffuse-sRGB.png","assets/images/environment/types/pano-acura-beat-that-1580948310130-specular-sRGB.png","assets/images/environment/types/pano-acura-beat-that-1580948310130.png","assets/images/environment/types/railing.jpg","assets/images/environment/types/spec-diffuse-sRGB.png","assets/images/environment/types/spec-specular-sRGB.png","assets/images/environment/types/tb_03_lightmap/tb_03_lightmap-astc.ktx","assets/images/environment/types/tb_03_lightmap/tb_03_lightmap-dxt.ktx","assets/images/environment/types/tb_03_lightmap/tb_03_lightmap-pvrtc.ktx","assets/images/environment/types/tb_03_lightmap.jpg","assets/images/environment/types/tb_04_lightmap/tb_04_lightmap-astc.ktx","assets/images/environment/types/tb_04_lightmap/tb_04_lightmap-dxt.ktx","assets/images/environment/types/tb_04_lightmap/tb_04_lightmap-pvrtc.ktx","assets/images/environment/types/tb_04_lightmap.jpg","assets/images/environment/types/tb_05_lightmap/tb_05_lightmap-astc.ktx","assets/images/environment/types/tb_05_lightmap/tb_05_lightmap-dxt.ktx","assets/images/environment/types/tb_05_lightmap/tb_05_lightmap-pvrtc.ktx","assets/images/environment/types/tb_05_lightmap.jpg","assets/images/environment/types/types_road_basecolor.jpg","assets/images/environment/types/types_road_lightmap.jpg","assets/images/environment/types/types_road_mro/types_road_mro-astc.ktx","assets/images/environment/types/types_road_mro/types_road_mro-dxt.ktx","assets/images/environment/types/types_road_mro/types_road_mro-pvrtc.ktx","assets/images/environment/types/types_road_mro.jpg","assets/images/environment/types/types_road_mro.png","assets/images/environment/types/types_road_normal/types_road_normal-astc.ktx","assets/images/environment/types/types_road_normal/types_road_normal-dxt.ktx","assets/images/environment/types/types_road_normal/types_road_normal-pvrtc.ktx","assets/images/environment/types/types_road_normal.jpg","assets/images/environment/types/types_road_normal.png","assets/images/environment/types/types_road_output_1.png","assets/images/environment/types/types_road_output_2/types_road_output_2-astc.ktx","assets/images/environment/types/types_road_output_2/types_road_output_2-dxt.ktx","assets/images/environment/types/types_road_output_2/types_road_output_2-pvrtc.ktx","assets/images/environment/types/types_road_output_2.jpg","assets/images/environment/types/types_road_output_2.png","assets/images/environment/white.jpg","assets/images/logo-horizontal.svg","assets/images/maps/arx.png","assets/images/maps/decor/arx/border.png","assets/images/maps/decor/arx/player.png","assets/images/maps/decor/new_nsx/border.png","assets/images/maps/decor/new_nsx/player.png","assets/images/maps/decor/rdx/border.png","assets/images/maps/decor/rdx/player.png","assets/images/maps/decor/type_s/border.png","assets/images/maps/decor/type_s/player.png","assets/images/maps/integra.png","assets/images/maps/new_nsx.png","assets/images/maps/old_nsx.png","assets/images/maps/rdx.png","assets/images/maps/type_s.png","assets/images/pbr/defaultblack.png","assets/images/pbr/defaultmro.png","assets/images/pbr/defaultnormal.png","assets/images/pbr/defaultwhite.png","assets/images/pbr/lut.png","assets/images/speedometers/arx/dial.png","assets/images/speedometers/arx/speedometer.png","assets/images/speedometers/integra/dial.png","assets/images/speedometers/integra/speedometer.png","assets/images/speedometers/new-nsx/speedometer.png","assets/images/speedometers/old-nsx/speedometer.png","assets/images/speedometers/rdx/dial.png","assets/images/speedometers/rdx/speedometer.png","assets/images/speedometers/type-s/dial.png","assets/images/speedometers/type-s/speedometer.png","assets/images/splash/bottom-land.png","assets/images/splash/car.png","assets/images/splash/land.jpg","assets/images/splash/land.png","assets/images/splash/lock-up.png","assets/images/splash/logo.png","assets/images/splash/mountain-back.png","assets/images/splash/mountain-back2.png","assets/images/splash/mountain-front.png","assets/images/splash/mountain-front2.png","assets/images/splash/ocean-2.png","assets/images/splash/ocean-reflection-left.png","assets/images/splash/ocean-reflection-right.png","assets/images/splash/ocean.jpg","assets/images/splash/palm-trees.png","assets/images/splash/post-blue.png","assets/images/splash/post-dark-blue.png","assets/images/splash/post-orange.png","assets/images/splash/post-purple.png","assets/images/splash/post-red.png","assets/images/splash/post.png","assets/images/splash/reflection.png","assets/images/splash/road-2.jpg","assets/images/splash/road-3.jpg","assets/images/splash/road.jpg","assets/images/splash/sky.jpg","assets/images/splash/sky2.jpg","assets/images/splash/sun.png","assets/images/transitions/arx.png","assets/images/transitions/crossfade.png","assets/images/transitions/dirtylens.jpg","assets/images/transitions/glitchnoise1.jpg","assets/images/transitions/rdxlookup.png","assets/images/transitions/rgb_texture.jpg","assets/images/uistyles/acura-logo.png","assets/images/uistyles/flag-icon.png","assets/images/uistyles/flags-white.png","assets/images/uistyles/integra-shine.jpg","assets/images/uistyles/share-logo-black.png","assets/images/uistyles/share-logo.png","assets/images/uistyles/social-arrow.png","assets/images/uistyles/social-unsupported-screen.jpg","assets/images/uistyles/splash-screen-logo.png","assets/images/uistyles/start.png","assets/images/uistyles/ui-rotate.png","assets/images/uistyles/ui1/ui1-1v1-button.png","assets/images/uistyles/ui1/ui1-1v1-icon.png","assets/images/uistyles/ui1/ui1-arrow-down-icon.png","assets/images/uistyles/ui1/ui1-arrow-right-icon.png","assets/images/uistyles/ui1/ui1-arrow-up-icon.png","assets/images/uistyles/ui1/ui1-check-icon.png","assets/images/uistyles/ui1/ui1-close-icon.png","assets/images/uistyles/ui1/ui1-desktop-keyboard-left.png","assets/images/uistyles/ui1/ui1-desktop-keyboard-right.png","assets/images/uistyles/ui1/ui1-desktop-space-bar.png","assets/images/uistyles/ui1/ui1-fb-icon.png","assets/images/uistyles/ui1/ui1-finish-flags.png","assets/images/uistyles/ui1/ui1-icon-scroll-button.png","assets/images/uistyles/ui1/ui1-lockup.png","assets/images/uistyles/ui1/ui1-multiplayer-close.png","assets/images/uistyles/ui1/ui1-play-icon.png","assets/images/uistyles/ui1/ui1-share-icon.png","assets/images/uistyles/ui1/ui1-sound-off-icon.png","assets/images/uistyles/ui1/ui1-sound-on-icon.png","assets/images/uistyles/ui1/ui1-spec-bg.png","assets/images/uistyles/ui1/ui1-trophy-icon.png","assets/images/uistyles/ui1/ui1-tw-icon.png","assets/images/uistyles/ui1-pause.png","assets/images/uistyles/ui1-resume-icon.png","assets/images/uistyles/ui1-share-icon.png","assets/images/uistyles/ui1-sound-off-icon.png","assets/images/uistyles/ui1-speed-dial.png","assets/images/uistyles/ui1-trophy.png","assets/images/uistyles/ui1-tutorial-hold.png","assets/images/uistyles/ui1-tutorial-tap.png","assets/images/uistyles/ui2/S2/ui2-scroll-bar-button.png","assets/images/uistyles/ui2/ui2-1v1-icon.png","assets/images/uistyles/ui2/ui2-arrow-down.png","assets/images/uistyles/ui2/ui2-arrow-left.png","assets/images/uistyles/ui2/ui2-arrow-right.png","assets/images/uistyles/ui2/ui2-arrow-up.png","assets/images/uistyles/ui2/ui2-check.png","assets/images/uistyles/ui2/ui2-close.png","assets/images/uistyles/ui2/ui2-desktop-keyboard-left.png","assets/images/uistyles/ui2/ui2-desktop-keyboard-right.png","assets/images/uistyles/ui2/ui2-desktop-space-bar.png","assets/images/uistyles/ui2/ui2-fb.png","assets/images/uistyles/ui2/ui2-hold-left.png","assets/images/uistyles/ui2/ui2-hold-right.png","assets/images/uistyles/ui2/ui2-leaderboard-button-selector.png","assets/images/uistyles/ui2/ui2-lock.png","assets/images/uistyles/ui2/ui2-lockup.png","assets/images/uistyles/ui2/ui2-play.png","assets/images/uistyles/ui2/ui2-share.png","assets/images/uistyles/ui2/ui2-sound-off.png","assets/images/uistyles/ui2/ui2-sound-on.png","assets/images/uistyles/ui2/ui2-spec-bg.png","assets/images/uistyles/ui2/ui2-spec-fill.png","assets/images/uistyles/ui2/ui2-tap-left.png","assets/images/uistyles/ui2/ui2-tap-right.png","assets/images/uistyles/ui2/ui2-trophy.png","assets/images/uistyles/ui2/ui2-tw.png","assets/images/uistyles/ui2-gradient-grey.png","assets/images/uistyles/ui2-gradient-yellow.png","assets/images/uistyles/ui2-gradient.png","assets/images/uistyles/ui2-pause.png","assets/images/uistyles/ui2-tutorial-hold.png","assets/images/uistyles/ui2-tutorial-tap.png","assets/images/uistyles/ui3/ui3-1v1-icon.png","assets/images/uistyles/ui3/ui3-1v1-mask.jpg","assets/images/uistyles/ui3/ui3-arrow-down.png","assets/images/uistyles/ui3/ui3-arrow-left.png","assets/images/uistyles/ui3/ui3-arrow-right.png","assets/images/uistyles/ui3/ui3-arrow-up.png","assets/images/uistyles/ui3/ui3-check.png","assets/images/uistyles/ui3/ui3-close.png","assets/images/uistyles/ui3/ui3-desktop-keyboard-left.png","assets/images/uistyles/ui3/ui3-desktop-keyboard-right.png","assets/images/uistyles/ui3/ui3-desktop-space-bar.png","assets/images/uistyles/ui3/ui3-fb.png","assets/images/uistyles/ui3/ui3-hold-left.png","assets/images/uistyles/ui3/ui3-hold-right.png","assets/images/uistyles/ui3/ui3-leaderboard-button-selector.png","assets/images/uistyles/ui3/ui3-leaderboard-qualified-box.png","assets/images/uistyles/ui3/ui3-lock.png","assets/images/uistyles/ui3/ui3-lockup.png","assets/images/uistyles/ui3/ui3-play.png","assets/images/uistyles/ui3/ui3-scroll-bar-button.png","assets/images/uistyles/ui3/ui3-share.png","assets/images/uistyles/ui3/ui3-sound-off.png","assets/images/uistyles/ui3/ui3-sound-on.png","assets/images/uistyles/ui3/ui3-spec-arrow.png","assets/images/uistyles/ui3/ui3-spec-bg.png","assets/images/uistyles/ui3/ui3-tap-left.png","assets/images/uistyles/ui3/ui3-tap-right.png","assets/images/uistyles/ui3/ui3-trophy.png","assets/images/uistyles/ui3/ui3-tw.png","assets/images/uistyles/ui3-pause.png","assets/images/uistyles/ui3-tutorial-hold.png","assets/images/uistyles/ui3-tutorial-tap.png","assets/images/uistyles/ui4/ui4-1v1-icon.png","assets/images/uistyles/ui4/ui4-arrow-down.png","assets/images/uistyles/ui4/ui4-arrow-left.png","assets/images/uistyles/ui4/ui4-arrow-right.png","assets/images/uistyles/ui4/ui4-arrow-up.png","assets/images/uistyles/ui4/ui4-check.png","assets/images/uistyles/ui4/ui4-close.png","assets/images/uistyles/ui4/ui4-desktop-keyboard-left.png","assets/images/uistyles/ui4/ui4-desktop-keyboard-right.png","assets/images/uistyles/ui4/ui4-desktop-space-bar.png","assets/images/uistyles/ui4/ui4-fb.png","assets/images/uistyles/ui4/ui4-hold-left.png","assets/images/uistyles/ui4/ui4-hold-right.png","assets/images/uistyles/ui4/ui4-leaderboard-button-selector.png","assets/images/uistyles/ui4/ui4-lock.png","assets/images/uistyles/ui4/ui4-lockup.png","assets/images/uistyles/ui4/ui4-play.png","assets/images/uistyles/ui4/ui4-scroll-bar-button.png","assets/images/uistyles/ui4/ui4-share.png","assets/images/uistyles/ui4/ui4-sound-off.png","assets/images/uistyles/ui4/ui4-sound-on.png","assets/images/uistyles/ui4/ui4-spec-bg.png","assets/images/uistyles/ui4/ui4-tap-left.png","assets/images/uistyles/ui4/ui4-tap-right.png","assets/images/uistyles/ui4/ui4-trophy.png","assets/images/uistyles/ui4/ui4-tw.png","assets/images/uistyles/ui4-map.png","assets/images/uistyles/ui4-odometer.png","assets/images/uistyles/ui4-pause.png","assets/images/uistyles/ui4-square-notch.png","assets/images/uistyles/ui4-tutorial-hold.png","assets/images/uistyles/ui4-tutorial-tap.png","assets/images/uistyles/ui4-wide-notch.png","assets/images/uistyles/ui5/ui5-1v1-icon.png","assets/images/uistyles/ui5/ui5-arrow-down.png","assets/images/uistyles/ui5/ui5-arrow-left.png","assets/images/uistyles/ui5/ui5-arrow-right.png","assets/images/uistyles/ui5/ui5-arrow-up.png","assets/images/uistyles/ui5/ui5-check.png","assets/images/uistyles/ui5/ui5-close.png","assets/images/uistyles/ui5/ui5-desktop-keyboard-left.png","assets/images/uistyles/ui5/ui5-desktop-keyboard-right.png","assets/images/uistyles/ui5/ui5-desktop-space-bar.png","assets/images/uistyles/ui5/ui5-fb.png","assets/images/uistyles/ui5/ui5-hexagon-orange.png","assets/images/uistyles/ui5/ui5-hexagon-white.png","assets/images/uistyles/ui5/ui5-hold-left.png","assets/images/uistyles/ui5/ui5-hold-right.png","assets/images/uistyles/ui5/ui5-icon-close.png","assets/images/uistyles/ui5/ui5-leaderboard-button-selector.png","assets/images/uistyles/ui5/ui5-level-box.png","assets/images/uistyles/ui5/ui5-lock.png","assets/images/uistyles/ui5/ui5-lockup.png","assets/images/uistyles/ui5/ui5-pause.png","assets/images/uistyles/ui5/ui5-play.png","assets/images/uistyles/ui5/ui5-scroll-bar-button.png","assets/images/uistyles/ui5/ui5-share-white.png","assets/images/uistyles/ui5/ui5-share-yellow.png","assets/images/uistyles/ui5/ui5-share.png","assets/images/uistyles/ui5/ui5-sound-off.png","assets/images/uistyles/ui5/ui5-sound-on.png","assets/images/uistyles/ui5/ui5-spec-bg.png","assets/images/uistyles/ui5/ui5-tap-left.png","assets/images/uistyles/ui5/ui5-tap-right.png","assets/images/uistyles/ui5/ui5-trophy.png","assets/images/uistyles/ui5/ui5-tw.png","assets/images/uistyles/ui6/ui6-1v1-icon.png","assets/images/uistyles/ui6/ui6-arrow-down.png","assets/images/uistyles/ui6/ui6-arrow-left.png","assets/images/uistyles/ui6/ui6-arrow-right.png","assets/images/uistyles/ui6/ui6-arrow-up.png","assets/images/uistyles/ui6/ui6-beat-that-box.png","assets/images/uistyles/ui6/ui6-check.png","assets/images/uistyles/ui6/ui6-close.png","assets/images/uistyles/ui6/ui6-desktop-keyboard-left.png","assets/images/uistyles/ui6/ui6-desktop-keyboard-right.png","assets/images/uistyles/ui6/ui6-desktop-space-bar.png","assets/images/uistyles/ui6/ui6-fb.png","assets/images/uistyles/ui6/ui6-hold-left.png","assets/images/uistyles/ui6/ui6-hold-right.png","assets/images/uistyles/ui6/ui6-leaderboard-button-selector.png","assets/images/uistyles/ui6/ui6-level-box.png","assets/images/uistyles/ui6/ui6-lock.png","assets/images/uistyles/ui6/ui6-lockup.png","assets/images/uistyles/ui6/ui6-pause.png","assets/images/uistyles/ui6/ui6-play.png","assets/images/uistyles/ui6/ui6-scroll-bar-button.png","assets/images/uistyles/ui6/ui6-share-blue.png","assets/images/uistyles/ui6/ui6-share-white.png","assets/images/uistyles/ui6/ui6-share.png","assets/images/uistyles/ui6/ui6-sound-off.png","assets/images/uistyles/ui6/ui6-sound-on.png","assets/images/uistyles/ui6/ui6-spec-bg.png","assets/images/uistyles/ui6/ui6-tap-left.png","assets/images/uistyles/ui6/ui6-tap-right.png","assets/images/uistyles/ui6/ui6-trophy.png","assets/images/uistyles/ui6/ui6-tw.png","assets/images/uistyles/ui6/ui6-your-time-box.png","assets/images/uistyles/unsupported-screen.jpg","assets/geometry/blank_instances.json","assets/geometry/cars/arx/arx_config.json","assets/geometry/cars/arx/body.json","assets/geometry/cars/arx/lights.json","assets/geometry/cars/arx/wheel.json","assets/geometry/cars/hum3dtest/body.json","assets/geometry/cars/hum3dtest/hum3dtestconfig.json","assets/geometry/cars/hum3dtest/wheel.json","assets/geometry/cars/integra/body.json","assets/geometry/cars/integra/body2.json","assets/geometry/cars/integra/integraconfig.json","assets/geometry/cars/integra/integraconfig2.json","assets/geometry/cars/integra/integraconfig3.json","assets/geometry/cars/integra/lights.json","assets/geometry/cars/integra/wheel.json","assets/geometry/cars/integra/wheel2.json","assets/geometry/cars/new_nsx/body.json","assets/geometry/cars/new_nsx/brakelights.json","assets/geometry/cars/new_nsx/lights.json","assets/geometry/cars/new_nsx/new_nsx_config.json","assets/geometry/cars/new_nsx/wheel.json","assets/geometry/cars/old_nsx/body3.json","assets/geometry/cars/old_nsx/body4.json","assets/geometry/cars/old_nsx/body5.json","assets/geometry/cars/old_nsx/lights1.json","assets/geometry/cars/old_nsx/old_nsx_config3.json","assets/geometry/cars/old_nsx/old_nsx_config4.json","assets/geometry/cars/old_nsx/old_nsx_config5.json","assets/geometry/cars/old_nsx/old_nsx_config6.json","assets/geometry/cars/old_nsx/old_nsx_config7.json","assets/geometry/cars/old_nsx/wheel3.json","assets/geometry/cars/old_nsx/wheel4.json","assets/geometry/cars/old_nsx/wheel_front_5.json","assets/geometry/cars/old_nsx/wheel_rear_5.json","assets/geometry/cars/old_nsx_test/body.json","assets/geometry/cars/old_nsx_test/honda_nsx.json","assets/geometry/cars/old_nsx_test/old_nsx_test_config.json","assets/geometry/cars/old_nsx_test/wheel.json","assets/geometry/cars/rdx/body.json","assets/geometry/cars/rdx/headlights.json","assets/geometry/cars/rdx/lights.json","assets/geometry/cars/rdx/rdx_config.json","assets/geometry/cars/rdx/rdx_config2.json","assets/geometry/cars/rdx/rdx_config2_old.json","assets/geometry/cars/rdx/wheel.json","assets/geometry/cars/test/body.json","assets/geometry/cars/test/nsxconfig.json","assets/geometry/cars/test/wheel.json","assets/geometry/cars/type_s/body.json","assets/geometry/cars/type_s/headlights.json","assets/geometry/cars/type_s/lights.json","assets/geometry/cars/type_s/type_s_config.json","assets/geometry/cars/type_s/wheel.json","assets/geometry/environments/arx/arx_b2.json","assets/geometry/environments/arx/arx_b2_instances.json","assets/geometry/environments/arx/arx_b3.json","assets/geometry/environments/arx/arx_b3_instances.json","assets/geometry/environments/arx/arx_fence.json","assets/geometry/environments/arx/arx_grandstand.json","assets/geometry/environments/arx/arx_grandstand_instances.json","assets/geometry/environments/arx/arx_ground.json","assets/geometry/environments/arx/arx_overpass.json","assets/geometry/environments/arx/arx_pb1.json","assets/geometry/environments/arx/arx_pb1_instances.json","assets/geometry/environments/arx/arx_pb2.json","assets/geometry/environments/arx/arx_pb2_instances.json","assets/geometry/environments/arx/arx_pb3.json","assets/geometry/environments/arx/arx_pb3_instances.json","assets/geometry/environments/arx/arx_pb4.json","assets/geometry/environments/arx/arx_pb4_instances.json","assets/geometry/environments/arx/arx_pb5.json","assets/geometry/environments/arx/arx_pb5_instances.json","assets/geometry/environments/arx/arx_pb8.json","assets/geometry/environments/arx/arx_pb8_instances.json","assets/geometry/environments/arx/arx_tree.json","assets/geometry/environments/arx/arx_tree_instances.json","assets/geometry/environments/garage/cylinder.json","assets/geometry/environments/garage/floor.json","assets/geometry/environments/garage/floor2.json","assets/geometry/environments/garage/instance-neon.json","assets/geometry/environments/garage/neon1.json","assets/geometry/environments/garage/top-detail.json","assets/geometry/environments/garage/top-detail2.json","assets/geometry/environments/garage/wall.json","assets/geometry/environments/garage/wall2.json","assets/geometry/environments/garage/wall3.json","assets/geometry/environments/integra/barrier.json","assets/geometry/environments/integra/barrier_instances.json","assets/geometry/environments/integra/building2.json","assets/geometry/environments/integra/building2_instances.json","assets/geometry/environments/integra/building3.json","assets/geometry/environments/integra/building3_instances.json","assets/geometry/environments/integra/building4.json","assets/geometry/environments/integra/building4_instances.json","assets/geometry/environments/integra/building6.json","assets/geometry/environments/integra/building6_instances.json","assets/geometry/environments/integra/gutter.json","assets/geometry/environments/integra/utilitypole3.json","assets/geometry/environments/integra/utilitypole3_instances.json","assets/geometry/environments/integra/utilitypole5.json","assets/geometry/environments/integra/utilitypole5_instances.json","assets/geometry/environments/new_nsx/b1.json","assets/geometry/environments/new_nsx/b1_instances.json","assets/geometry/environments/new_nsx/b2.json","assets/geometry/environments/new_nsx/b2_instances.json","assets/geometry/environments/new_nsx/b3.json","assets/geometry/environments/new_nsx/b3_instances.json","assets/geometry/environments/new_nsx/b4.json","assets/geometry/environments/new_nsx/b4_instances.json","assets/geometry/environments/new_nsx/b8.json","assets/geometry/environments/new_nsx/b8_instances.json","assets/geometry/environments/new_nsx/empty.json","assets/geometry/environments/new_nsx/highway.json","assets/geometry/environments/new_nsx/new_nsx_pb1_instances.json","assets/geometry/environments/new_nsx/new_nsx_pb3_instances.json","assets/geometry/environments/new_nsx/pointlights.json","assets/geometry/environments/new_nsx/post.json","assets/geometry/environments/new_nsx/post_instances.json","assets/geometry/environments/new_nsx/railing.json","assets/geometry/environments/new_nsx/signs.json","assets/geometry/environments/new_nsx/signs_uv2.json","assets/geometry/environments/new_nsx/streetlight.json","assets/geometry/environments/new_nsx/streetlight_instances.json","assets/geometry/environments/old_nsx/blimp.json","assets/geometry/environments/old_nsx/old_nsx_railing_left.json","assets/geometry/environments/old_nsx/old_nsx_railing_right.json","assets/geometry/environments/old_nsx/old_nsx_railings.json","assets/geometry/environments/old_nsx/old_nsx_rock.json","assets/geometry/environments/old_nsx/old_nsx_rock_instances.json","assets/geometry/environments/old_nsx/old_nsx_trackborder.json","assets/geometry/environments/old_nsx/old_nsx_tree.json","assets/geometry/environments/old_nsx/old_nsx_tree_instances.json","assets/geometry/environments/rdx/rdx_bottomrock.json","assets/geometry/environments/rdx/rdx_bottomrock_instances.json","assets/geometry/environments/rdx/rdx_mountain.json","assets/geometry/environments/rdx/rdx_mountain_instances.json","assets/geometry/environments/rdx/rdx_railing.json","assets/geometry/environments/rdx/rdx_railing_inner.json","assets/geometry/environments/rdx/rdx_snowtrack.json","assets/geometry/environments/rdx/rdx_toprock.json","assets/geometry/environments/rdx/rdx_toprock_instances.json","assets/geometry/environments/rdx/rdx_track_cosmetic.json","assets/geometry/environments/rdx/rdx_tunnel.json","assets/geometry/environments/type_s/ceiling.json","assets/geometry/environments/type_s/ceilinglights.json","assets/geometry/environments/type_s/checkpointarrow.json","assets/geometry/environments/type_s/edgestructure.json","assets/geometry/environments/type_s/edgestructure_alt.json","assets/geometry/environments/type_s/railing.json","assets/geometry/environments/type_s/tb3.json","assets/geometry/environments/type_s/tb3_instances.json","assets/geometry/environments/type_s/tb4.json","assets/geometry/environments/type_s/tb4_instances.json","assets/geometry/environments/type_s/tb5.json","assets/geometry/environments/type_s/tb5_instances.json","assets/geometry/environments/type_s/toprailing.json","assets/geometry/environments/type_s/tubes.json","assets/geometry/instancetest.json","assets/geometry/instancetest_cube.json","assets/geometry/instancetest_ring.json","assets/geometry/loops.json","assets/geometry/sphere_c4d_track.json","assets/geometry/teapot_c4d_2.json","assets/geometry/track.json","assets/geometry/track_flat.json","assets/geometry/track_incline.json","assets/geometry/track_incline_spline.json","assets/geometry/tracks/arx/arx_hitmesh.json","assets/geometry/tracks/arx/arx_line.json","assets/geometry/tracks/arx/arx_track.json","assets/geometry/tracks/integra/integra_hitmesh.json","assets/geometry/tracks/integra/integra_line.json","assets/geometry/tracks/integra/integra_track.json","assets/geometry/tracks/new_nsx/new_nsx_hitmesh.json","assets/geometry/tracks/new_nsx/new_nsx_line.json","assets/geometry/tracks/new_nsx/new_nsx_track.json","assets/geometry/tracks/old_nsx/old_nsx_hitmesh.json","assets/geometry/tracks/old_nsx/old_nsx_line.json","assets/geometry/tracks/old_nsx/old_nsx_track.json","assets/geometry/tracks/rdx/rdx_hitmesh.json","assets/geometry/tracks/rdx/rdx_line.json","assets/geometry/tracks/rdx/rdx_track.json","assets/geometry/tracks/test/test_track.json","assets/geometry/tracks/type_s/type_s_hitmesh.json","assets/geometry/tracks/type_s/type_s_line.json","assets/geometry/tracks/type_s/type_s_track.json","assets/geometry/trackspline.json","assets/shaders/compiled.vs"],ASSETS.SW=["assets/fonts/BarlowCondensed-BoldItalic.json","assets/fonts/BarlowCondensed-BoldItalic.png","assets/fonts/BarlowCondensed-BoldItalic.ttf","assets/fonts/BarlowCondensed-ExtraBoldItalic.json","assets/fonts/BarlowCondensed-ExtraBoldItalic.png","assets/fonts/BarlowCondensed-ExtraBoldItalic.ttf","assets/fonts/BarlowCondensed-Italic.json","assets/fonts/BarlowCondensed-Italic.png","assets/fonts/BarlowCondensed-Italic.ttf","assets/fonts/Capture_it.json","assets/fonts/Capture_it.png","assets/fonts/Capture_it.ttf","assets/fonts/ChangelingNeo-Bold.json","assets/fonts/ChangelingNeo-Bold.png","assets/fonts/ChangelingNeo-Bold.ttf","assets/fonts/ChangelingNeo-Light.json","assets/fonts/ChangelingNeo-Light.png","assets/fonts/ChangelingNeo-Light.ttf","assets/fonts/ChangelingNeo-Regular.json","assets/fonts/ChangelingNeo-Regular.png","assets/fonts/ChangelingNeo-Regular.ttf","assets/fonts/HelveticaNeue-Medium.json","assets/fonts/HelveticaNeue-Medium.png","assets/fonts/Orbitron-Black.json","assets/fonts/Orbitron-Black.png","assets/fonts/Orbitron-Black.ttf","assets/fonts/Orbitron-Bold.json","assets/fonts/Orbitron-Bold.png","assets/fonts/Orbitron-Bold.ttf","assets/fonts/Orbitron-Medium.json","assets/fonts/Orbitron-Medium.png","assets/fonts/Orbitron-Medium.ttf","assets/fonts/Orbitron-Regular.json","assets/fonts/Orbitron-Regular.png","assets/fonts/Orbitron-Regular.ttf","assets/fonts/PressStart2P-Regular.json","assets/fonts/PressStart2P-Regular.png","assets/fonts/PressStart2P-Regular.ttf","assets/fonts/PressStart2P-Regular.woff","assets/fonts/PressStart2P-Regular.woff2","assets/fonts/Roboto-Black.json","assets/fonts/Roboto-Black.png","assets/fonts/Roboto-Black.ttf","assets/fonts/Roboto-BlackItalic.json","assets/fonts/Roboto-BlackItalic.png","assets/fonts/Roboto-BlackItalic.ttf","assets/fonts/Roboto-Bold.json","assets/fonts/Roboto-Bold.png","assets/fonts/Roboto-Bold.ttf","assets/fonts/RobotoCondensed-BoldItalic.json","assets/fonts/RobotoCondensed-BoldItalic.png","assets/fonts/RobotoCondensed-BoldItalic.ttf","assets/fonts/Tomorrow-Bold.json","assets/fonts/Tomorrow-Bold.png","assets/fonts/Tomorrow-Bold.ttf","assets/fonts/Tomorrow-BoldItalic.json","assets/fonts/Tomorrow-BoldItalic.png","assets/fonts/Tomorrow-BoldItalic.ttf","assets/fonts/Tomorrow-Medium.json","assets/fonts/Tomorrow-Medium.png","assets/fonts/Tomorrow-Medium.ttf","assets/fonts/Tomorrow-SemiBold.json","assets/fonts/Tomorrow-SemiBold.png","assets/fonts/Tomorrow-SemiBold.ttf","assets/fonts/futura-pt-cond-bold.json","assets/fonts/futura-pt-cond-bold.png","assets/fonts/futura-pt-cond-bold.ttf","assets/css/fallback.css","assets/css/style.css","assets/js/app.js"],Class((function Config(){Inherit(this,Component);this.FACEBOOK=window.location.href.includes("apps.fbsbx"),this.API=window._CONFIG_.api||"https://acura-beat-that.web.app",this.STORAGE=window._CONFIG_.storage||"https://storage.googleapis.com/acura-beat-that",this.RACE=this.API+"/race/:raceid",this.UPLOAD=this.API+"/upload",this.MODERATION=this.API+"/moderation",this.LEADERBOARD=this.STORAGE+"/leaderboard",this.SHARE=this.FACEBOOK?"https://playbeatthat.acura.com/share/:raceid":window._SHARE_||`${location.protocol}//${location.host}/share/:raceid`,this.SHARE_LEVEL=this.SHARE.split("/share")[0]+"/level/:levelid",this.TOTAL_LEVELS=6,this.LOCK_NEW_CARS=!1,this.CDN=window._CONFIG_.cdn,this.TRACKS=["old_nsx","integra","rdx","arx","new_nsx","type_s"],this.VERSION=window._VERSION_||0,this.VISIT_ACURA="https://acura.com/",this.PROD=this.FACEBOOK||"playbeatthat.acura.com"===window.location.hostname,this.OPEN="open-dot-acura-beat-that.appspot.com"===window.location.hostname,this.ANALYTICS_ID="UA-58859408-5",this.LEVEL_IMAGE_CACHE="b",this.SOCKET="wss://dev.dreamwave.network/acura/ws",this.get("UI_SCALE",_=>Math.range(Stage.height,450,900,415,600))}),"static"),Class((function Copy(){this.RESULT={leaderboard_all_first:"YOU. JUST. MADE. HISTORY.\nYOU'RE #1 ON THE ALL-TIME TOP 10",leaderboard_all:"BRAGGING RIGHTS ARE YOURS. YOU'RE {position} ON THE ALL-TIME TOP 10!",leaderboard_daily_first:"IS IT LONELY AT THE TOP?\nYOU'RE #1 ON TODAY'S TOP 10!",leaderboard_daily:"YOU'RE FAST! YOU'RE {position} ON TODAY'S TOP 10!",beat_challenge:"YOU BEAT {challenger}'s TIME!",lose_challenge:"{challenger} BEAT YOU! YOU GONNA TAKE THAT?",qualified_beat:"YOU BEAT {percentage} OF ALL OTHER PLAYERS!",qualified_next:"YOU QUALIFIED FOR THE NEXT ROUND.",qualified:"YOU QUALIFIED.",unlocked:"YOU DIDN'T JUST BEAT THAT. YOU BEAT THE GAME!\nYOU'VE UNLOCKED EVERY LEVEL.",default:"TWO WORDS: BEAT THAT.\nTWO MORE WORDS: PLAY NOW."},this.TIPS=["TIP: Stay on the optimal racing line to find the shortest path","TIP: Try tapping and releasing the brake on sharper turns. ","TIP: Walls and barriers slow you down. Avoid them.","TIP: Try lightly tapping to steer left and right."],this.SHARE={default:"CAN YOU “BEAT THAT”?",not_qualified:"PLAY “BEAT THAT” THE GAME.",qualified:"CAN YOU “BEAT THAT”?",beat_challenge:"I JUST BEAT SOMEONE. BEAT THAT.",leaderboard_daily:"I JUST PLACED {position} ON THE DAILY TOP 10. BEAT THAT.",leaderboard_daily_first:"I JUST PLACED 1ST ON THE DAILY TOP 10. BEAT THAT.",leaderboard_all:"I JUST PLACED {position} ON THE ALL TIME LEADER BOARD. BEAT THAT.",leaderboard_all_first:"I JUST PLACED 1ST ON THE ALL TIME LEADER BOARD. BEAT THAT.",unlocked:"I JUST UNLOCKED EVERY LEVEL. BEAT THAT."},this.SHARE_TITLE="PLAY “BEAT THAT” THE GAME.",this.QUALIFIED="YOU QUALIFIED",this.TRY_AGAIN="TRY AGAIN",this.YOUR_TIME="YOUR TIME",this.BEAT_THAT_TIME="BEAT THAT TIME",this.START_AUDIO=(_=>`${Device.mobile?"TAP":"CLICK"} TO ENABLE AUDIO`)()}),"static"),Class((function FontConfig(){StageLayout.FIGMA_FONT={DEFAULT:"Orbitron-Regular",Orbitron:{regular:{name:"Orbitron-Regular",scale:1.4},medium:{name:"Orbitron-Medium",scale:1.4},black:{name:"Orbitron-Black",scale:1.4}},"Press Start 2P":{regular:{name:"PressStart2P-Regular",scale:1}},"Futura PT Cond":{regular:{name:"futura-pt-cond-bold",scale:1}},Roboto:{black:{name:"Roboto-Black",scale:1},"black italic":{name:"Roboto-BlackItalic",scale:1},bold:{name:"Roboto-Bold",scale:1}},Tomorrow:{medium:{name:"Tomorrow-Medium",scale:1},"semi bold":{name:"Tomorrow-SemiBold",scale:1},bold:{name:"Tomorrow-Bold",scale:1},"bold italic":{name:"Tomorrow-BoldItalic",scale:1}},Capture_it:{regular:{name:"Capture_it",scale:1}},"Barlow Condensed":{"extrabold italic":{name:"BarlowCondensed-ExtraBoldItalic"},"bold italic":{name:"BarlowCondensed-BoldItalic"},medium:{name:"BarlowCondensed-Italic"}},ChangelingNeo:{regular:{name:"ChangelingNeo-Regular",scale:1},light:{name:"ChangelingNeo-Light",scale:1},bold:{name:"ChangelingNeo-Bold",scale:1}}}}),"singleton"),Class((function Qualifying(){this.old_nsx={time:44,splits:[7973.159,14778.608999999997,20583.448000000004,26938.524999999994,32943.482,38147.796]},this.integra={time:46,splits:[9124.34899999993,17080.727999999886,22285.08899999992,27739.554999999935,34795.164999999804,40099.527]},this.rdx={time:64,splits:[11676.292000000365,17681.22500000056,24586.85300000012,32293.256000000052,39298.974000000395,46554.89300000016]},this.arx={time:58,splits:[11442.699000000022,14795.439000000246,18048.28299999982,21250.80999999959,24453.35900000017,28356.55999999959,31859.35300000012,35062.075000000186,38915.246000000276,42017.764999999665,47071.998999999836,51175.36500000022]},this.new_nsx={time:71,splits:[16880.519999999553,27989.680999999866,38298.06499999948,48906.794999999925,58815.05399999954]},this.type_s={time:73,splits:[12276.901999999769,23435.90499999933,35395.82099999953,47705.710999999195,59415.46999999974]}}),"static"),Class((function UIConfig(){Inherit(this,Component);const _this=this,LAYERS=["Game","Leaderboard","Share","Rotate","Loader","Multiplayer"];var _offset,_position,_mult,$background,_current="game",_locked=!1,_bgLayers=0,_layers=[];function loop(){_offset.lerp(_mult,.3),_position.lerp(_offset,.1);for(let layer of _layers)layer.x=5*_position.x}function resize(){$background.width=Stage.width,$background.height=Stage.height,$background.x=0,$background.y=0}function animateBackgroundOut(){$background.tween({alpha:0},500,"easeOutCubic")}function onChange({view:view}){view}function show(id){let layer=GLUI.Stage[`${id}Layer`];layer.alpha=0,layer.show(),tween(layer,{alpha:1},800,"easeOutCubic")}function hide(layers){for(let id of layers){let layer=GLUI.Stage[`${id}Layer`];tween(layer,{alpha:0},250,"easeOutCubic").onComplete(_=>{layer.hide()})}}function onVisibility(e){let state=!!e&&e.state,unlock=!!e&&e.unlock;if(!_locked||unlock)switch(_locked=!1,state){case"loader":hide(["Game","Leaderboard","Share","Rotate","Multiplayer"]),show("Loader"),_current="loader";break;case"rotate":hide(["Game","Leaderboard","Share","Loader","Multiplayer"]),show("Rotate"),_locked=!0,_current="rotate";break;case"share":hide(["Game","Leaderboard","Rotate","Loader","Multiplayer"]),show("Share"),_current="share";break;case"leaderboard":hide(["Game","Share","Rotate","Loader","Multiplayer"]),show("Leaderboard"),_current="leaderboard";break;case"multiplayer":hide(["Game","Share","Rotate","Loader","Leaderboard"]),show("Multiplayer"),_current="multiplayer";break;case"game":default:hide(["Leaderboard","Share","Rotate","Loader","Multiplayer"]),show("Game"),_current="game"}}!async function(){!function addEvents(){_this.VISIBILITY=UIConfig.VISIBILITY="ui_config_visiblity"}(),await Hydra.ready(),await _this.wait(window,"GLUI"),await GLUI.ready(),function initBackground(){($background=$gl(Stage.width,Stage.height,"#000000")).alpha=0,$background.setZ(-10),GLUI.Stage.add($background)}(),function initUILayers(){for(let id of LAYERS){let name=`${id}Layer`,layer=GLUI.Stage[name]=$gl();GLUI.Stage.add(layer),_layers.push(layer)}}(),function addHandlers(){new Vector2,_offset=new Vector2,_position=new Vector2,_mult=new Vector2,_this.events.sub(ViewController.CHANGE,onChange),_this.events.sub(UIConfig.VISIBILITY,onVisibility),onVisibility(),_this.onResize(resize)}(),_this.startRender(loop),_this.flag("isReady",!0)}(),this.get("state",_=>_current),this.gameOffset=function(vec){_offset.lerp(vec,.5)},this.ready=function(){return _this.wait(_this,"isReady")},this.showBackground=function(){++_bgLayers>0&&function animateBackgroundIn(){$background.tween({alpha:.5},500,"easeOutCubic")}()},this.hideBackground=function(){_bgLayers--,(_bgLayers=Math.max(0,_bgLayers))<=0&&animateBackgroundOut()},this.resetBackground=function(){_bgLayers=0,animateBackgroundOut()}}),"static"),Mobile.Class((function Accelerometer(){var _this=this;function updateAccel(e){switch(window.orientation){case 0:_this.x=-e.accelerationIncludingGravity.x,_this.y=e.accelerationIncludingGravity.y,_this.z=e.accelerationIncludingGravity.z,e.rotationRate&&(_this.rotationRate.alpha=e.rotationRate.beta*_this.toRadians,_this.rotationRate.beta=-e.rotationRate.alpha*_this.toRadians,_this.rotationRate.gamma=e.rotationRate.gamma*_this.toRadians);break;case 180:_this.x=e.accelerationIncludingGravity.x,_this.y=-e.accelerationIncludingGravity.y,_this.z=e.accelerationIncludingGravity.z,e.rotationRate&&(_this.rotationRate.alpha=-e.rotationRate.beta*_this.toRadians,_this.rotationRate.beta=e.rotationRate.alpha*_this.toRadians,_this.rotationRate.gamma=e.rotationRate.gamma*_this.toRadians);break;case 90:_this.x=e.accelerationIncludingGravity.y,_this.y=e.accelerationIncludingGravity.x,_this.z=e.accelerationIncludingGravity.z,e.rotationRate&&(_this.rotationRate.alpha=e.rotationRate.alpha*_this.toRadians,_this.rotationRate.beta=e.rotationRate.beta*_this.toRadians,_this.rotationRate.gamma=e.rotationRate.gamma*_this.toRadians);break;case-90:_this.x=-e.accelerationIncludingGravity.y,_this.y=-e.accelerationIncludingGravity.x,_this.z=e.accelerationIncludingGravity.z,e.rotationRate&&(_this.rotationRate.alpha=-e.rotationRate.alpha*_this.toRadians,_this.rotationRate.beta=-e.rotationRate.beta*_this.toRadians,_this.rotationRate.gamma=e.rotationRate.gamma*_this.toRadians)}"android"==Device.system.os&&(_this.x*=-1,_this.y*=-1,_this.z*=-1)}function updateOrientation(e){for(var key in e)key.toLowerCase().includes("heading")&&(_this.heading=e[key]);switch(window.orientation){case 0:_this.alpha=e.beta*_this.toRadians,_this.beta=-e.alpha*_this.toRadians,_this.gamma=e.gamma*_this.toRadians;break;case 180:_this.alpha=-e.beta*_this.toRadians,_this.beta=e.alpha*_this.toRadians,_this.gamma=e.gamma*_this.toRadians;break;case 90:_this.alpha=e.alpha*_this.toRadians,_this.beta=e.beta*_this.toRadians,_this.gamma=e.gamma*_this.toRadians;break;case-90:_this.alpha=-e.alpha*_this.toRadians,_this.beta=-e.beta*_this.toRadians,_this.gamma=e.gamma*_this.toRadians}_this.tilt=e.beta*_this.toRadians,_this.yaw=e.alpha*_this.toRadians,_this.roll=-e.gamma*_this.toRadians,"android"==Device.system.os&&(_this.heading=function compassHeading(alpha,beta,gamma){var degtorad=Math.PI/180,_x=beta?beta*degtorad:0,_y=gamma?gamma*degtorad:0,_z=alpha?alpha*degtorad:0,cY=(Math.cos(_x),Math.cos(_y)),cZ=Math.cos(_z),sX=Math.sin(_x),sY=Math.sin(_y),sZ=Math.sin(_z),Vx=-cZ*sY-sZ*sX*cY,Vy=-sZ*sY+cZ*sX*cY,compassHeading=Math.atan(Vx/Vy);Vy<0?compassHeading+=Math.PI:Vx<0&&(compassHeading+=2*Math.PI);return compassHeading*(180/Math.PI)}(e.alpha,e.beta,e.gamma))}this.x=0,this.y=0,this.z=0,this.alpha=0,this.beta=0,this.gamma=0,this.heading=0,this.rotationRate={},this.rotationRate.alpha=0,this.rotationRate.beta=0,this.rotationRate.gamma=0,this.toRadians="ios"==Device.system.os?Math.PI/180:1,this.capture=function(){this.active||(this.active=!0,window.ondevicemotion=updateAccel,window.addEventListener("deviceorientation",updateOrientation))},this.stop=function(){this.active=!1,window.ondevicemotion=null,_this.x=_this.y=_this.z=0,window.removeEventListener("deviceorientation",updateOrientation)}}),"Static"),Class((function Antimatter(_num,_config,_renderer=World.RENDERER){Inherit(this,AntimatterFBO);var _geometry,_this=this,_drawLimit=_num,_size=function findSize(){var values=[2,4,8,16,32,64,128,256,512,1024,2048,4096];for(let i=0;i<values.length;i++){var p2=values[i];if(p2*p2>=_num)return p2}}();async function createBuffer(){let{geometry:geometry,vertices:vertices,attribs:attribs,usedDepth:usedDepth}=await AntimatterUtil.createBufferArray(_size,_num,_config);_this.vertices=_this.cloneVertices?vertices.clone():vertices,(_geometry=geometry.clone(!0)).drawRange.end=_drawLimit,_this.vertices.geometry=_geometry,_this.attribs=_this.random=attribs,_this.textureUsedDepth=usedDepth,_this.init(_geometry,_renderer,_size)}defer(createBuffer),this.createFloatArray=function(components=3){return new Float32Array(_size*_size*components)},this.createFloatArrayAsync=async function(components=3,freshCopy){let{array:array}=await AntimatterUtil.createFloatArray(_size*_size*components,freshCopy);return array},this.ready=function(callback){return _this.wait(_this,"vertices")},this.useShader=function(vs,fs,params){"object"==typeof fs&&(params=fs,fs=null),this.vertexShader=vs,this.fragmentShader=fs||vs,this.uniforms=params},this.createMesh=this.getMesh=function(){let shader=_this.createShader(_this.fragmentShader||"AntimatterBasicFrag");return _this.mesh=new Points(_geometry,shader),_this.mesh.frustumCulled=!1,_this.shader=shader,_this.geometry=_geometry,_this.mesh},this.createShader=function(fs){let uniforms=_this.uniforms||{},obj={tPos:{type:"t",value:_this.vertices.texture,ignoreUIL:!0},tPrevPos:{type:"t",value:_this.vertices.texture,ignoreUIL:!0}};for(let key in uniforms)obj[key]=uniforms[key];let shader=new Shader(_this.vertexShader||"AntimatterPosition",fs,obj),vs=shader.vertexShader;if(vs&&!vs.includes("uniform sampler2D tPos")){let split=vs.split("__ACTIVE_THEORY_LIGHTS__"),defined="uniform sampler2D tPos;";shader.vertexShader=split[0]+"\n"+defined+"\n__ACTIVE_THEORY_LIGHTS__\n"+split[1]}return shader},this.getLookupArray=function(){return new Float32Array(_this.vertices.geometry.attributes.position.array)},this.getRandomArray=function(){return _geometry.attributes.random.array},this.overrideShader=function(original){let shader=original.clone();original.copyUniformsTo(shader),shader.uniforms.tPos={type:"t",value:_this.vertices.texture,ignoreUIL:!0},shader.uniforms.tPrevPos={type:"t",value:_this.vertices.texture,ignoreUIL:!0},_this.shader=shader,_this.mesh.shader=shader},this.upload=async function(){_this.preventRender=!0,_geometry.distributeBufferData=!0,await _this.ready(),await _this.vertices.uploadAsync(),await defer(),await _this.random.uploadAsync(),await defer(),_this.mesh&&(_this.mesh.upload(),await _geometry.uploadBuffersAsync());for(let key in _this.shader.uniforms){let uniform=_this.shader.uniforms[key];uniform.value&&(uniform.value.uploadAsync?await uniform.value.uploadAsync():uniform.value.upload&&(uniform.value.upload(),await defer()))}await _this.wait(100);for(let i=0;i<_this.passes.length;i++)await _this.passes[i].upload();_this.preventRender=!1},this.uploadSync=async function(){await _this.ready(),_this.customClass&&_this.customClass.loaded&&await _this.customClass.loaded(),_this.mesh&&_this.mesh.upload();for(let i=0;i<4;i++)_this.update()},this.get("particleCount",_=>_size*_size)})),Class((function AntimatterAttribute(_data,_components){Inherit(this,Component);var _this=this,_size=Math.sqrt(_data.length/(_components||3));this.size=_size,this.count=_size*_size,this.buffer=_data,this.texture=new DataTexture(_data,_size,_size,4==_components?Texture.RGBAFormat:Texture.RGBFormat,Texture.FLOAT),this.set("needsUpdate",(function(){_this.texture.needsUpdate=!0})),this.bufferData=function(data,components){_this.buffer=data,components!=_components?(_this.texture.destroy(),_this.texture=new DataTexture(data,_size,_size,4==components?Texture.RGBAFormat:Texture.RGBFormat,Texture.FLOAT)):(_this.texture.data=data,_this.texture.needsUpdate=!0),_components=components,_data=data},this.upload=function(){_this.texture.upload()},this.uploadAsync=function(){return _this.texture.distributeTextureData=!0,_this.texture.upload(),_this.texture.uploadAsync()},this.clone=function(){return new AntimatterAttribute(_data,_components)},this.onDestroy=function(){_this.texture&&_this.texture.destroy&&_this.texture.destroy()}})),Class((function AntimatterFBO(){var _this,_gpuGeom,_renderer,_size,_prevRT,_scene,_mesh,_camera,_copy,_geometry;Inherit(this,Component);var _output={type:"t",value:null,ignoreUIL:!0},_prevOutput={type:"t",value:null,ignoreUIL:!0};function copy(input,output){World.RENDERER.blit(input,output)||(_copy.visible=!0,_mesh.visible=!1,_copy.shader.uniforms.tMap.value=input,_renderer.renderSingle(_copy,_camera,output),_copy.visible=!1,_mesh.visible=!0)}this.passes=[],this.init=function(geometry,renderer,size){_this=this,_gpuGeom=geometry.attributes.position.array,_renderer=renderer,_size=size,function initPasses(){_camera=World.CAMERA,_geometry=World.QUAD,_scene=new Scene,(_mesh=new Mesh(_geometry,null)).frustumCulled=!1,_mesh.noMatrices=!0,_scene.add(_mesh);let copyShader=AntimatterFBO.getCopyShader();(_copy=new Mesh(_geometry,copyShader)).noMatrices=!0,_scene.add(_copy),_copy.visible=!1}()},this.getGPUGeom=function(){return _gpuGeom},this.addPass=function(pass,index){_this=this,pass.init||pass.initialize(_size),"number"!=typeof index?_this.passes.push(pass):_this.passes.splice(index,0,pass)},this.findPass=function(name){_this=this;for(var i=0;i<_this.passes.length;i++){var pass=_this.passes[i];if(pass.name==name)return pass}},this.removePass=function(pass){_this=this,"number"==typeof pass?_this.passes.splice(pass):_this.passes.remove(pass)},this.update=function(){if((_this=this).mesh&&!_this.preventRender){var output=_output.value||_this.vertices.texture;_this.storeVelocity&&(_prevRT?(copy(_output.value,_prevRT),_prevOutput.value=_prevRT):(_prevOutput.value=output,(_prevRT=_this.passes[0].getRT(0).clone()).upload()));for(var i=0;i<_this.passes.length;i++){var pass=_this.passes[i],needsInit=!pass.init,firstRender=!pass.first;needsInit&&pass.initialize(_size),pass.first=!0,_mesh.shader=pass.shader,_mesh.shader.uniforms.tInput.value=firstRender?_this.vertices.texture:pass.output,pass.ready||(_mesh.shader.uniforms.tInput.value=_this.vertices.texture);var rt=firstRender?pass.getRT(0):pass.getWrite();output=pass.output;_renderer.renderSingle(_scene.children[0],_camera,rt),copy(rt,output),pass.swap()}output&&(_output.value=output,_this.mesh.shader.uniforms.tPos.value=_output.value,_this.mesh.shader.uniforms.tPrevPos.value=_prevOutput.value)}},this.getOutput=function(){return _output},this.getPrevOutput=function(){return _prevOutput}}),(function(){var _shader;AntimatterFBO.getCopyShader=function(){return _shader||((_shader=new Shader("ScreenQuad")).uniforms={tMap:{type:"t",value:null}},_shader._attachmentData={format:Texture.RGBAFormat,type:Texture.FLOAT,attachments:1}),_shader}})),Class((function AntimatterPass(_shader,_uni,_clone){var _this=this;this.UILPrefix="am_"+_shader;const _uniforms={tInput:{type:"t",value:null,ignoreUIL:!0},fSize:{type:"f",value:64,ignoreUIL:!0}};var _rts=[],_read=0,_write=0;function prepareShader(code,type){if("vs"==type)return code;let header=["uniform sampler2D tInput;","uniform float fSize;","varying vec2 vUv;",Shaders.getShader("antimatter.glsl")].join("\n"),mainAt=code.indexOf("void main()"),before=code.slice(0,mainAt),after=code.slice(mainAt);return code=before+header+after,_this.onCreateShader&&(code=_this.onCreateShader(code)),code}function initRT(size){var type="ios"==Device.system.os?Texture.HALF_FLOAT:Texture.FLOAT,parameters={minFilter:Texture.NEAREST,magFilter:Texture.NEAREST,format:Texture.RGBAFormat,type:type},rt=new RenderTarget(size,size,parameters);return rt.texture.generateMipmaps=!1,rt}this.uniforms=_uniforms,this.output=initRT(64),this.name=_shader,this.id=Utils.timestamp(),this.ready=!1,function(){if(_uni)for(var key in _uni.unique&&(_this.UILPrefix+="_"+_uni.unique.replace("/","_"),delete _uni.unique),_uni.customCompile&&(_this.customCompile=_uni.customCompile||"",delete _uni.customCompile),_uni)_uniforms[key]=_uni[key]}(),this.addInput=function(name,attribute){var uniform="object"!=typeof attribute||attribute.height||"string"!=typeof attribute.type?attribute instanceof AntimatterAttribute?{type:"t",value:attribute.texture,ignoreUIL:!0}:attribute instanceof AntimatterPass?{type:"t",value:attribute.output,ignoreUIL:!0}:{type:"t",value:attribute,ignoreUIL:!0}:attribute;let lookup=UILStorage.parse(_this.UILPrefix+name);return lookup&&(uniform.value=lookup.value),_uniforms[name]=uniform,uniform.ignoreUIL=!0,_uniforms[name]},this.addUniforms=function(object){for(let key in object){let uniform=object[key],lookup=UILStorage.parse(_this.UILPrefix+key);if(lookup){if(Array.isArray(lookup.value))switch(lookup.value.length){case 2:lookup.value=(new Vector2).fromArray(lookup.value);break;case 3:lookup.value=(new Vector3).fromArray(lookup.value);break;case 4:lookup.value=(new Vector4).fromArray(lookup.value)}uniform.value=lookup.value}_uniforms[key]=uniform}},this.getRT=function(index){return _rts[index]},this.getRead=function(){return _rts[_read]},this.getWrite=function(){return _rts[_write]},this.setRead=function(index){_read=index},this.setWrite=function(index){_write=index},this.swap=function(){++_write>2&&(_write=0,_this.ready=!0),++_read>2&&(_this.onInit&&(_this.onInit(),_this.onInit=null),_read=0)},this.initialize=function(size){if(!_this.init){_this.init=!0;for(var i=0;i<3;i++)_rts.push(initRT(size));_this.output.setSize(size,size),_shader instanceof Shader||((_shader=new Shader("AntimatterPass",_shader,{customCompile:_this.customCompile}))._attachmentData={format:Texture.RGBAFormat,type:Texture.FLOAT,attachments:1},_shader.preCompile=prepareShader,_shader.uniforms=_uniforms,_shader.UILPrefix=_this.UILPrefix,_shader.id=Utils.timestamp()),_this.shader=_shader,_shader.uniforms.fSize.value=size}},this.setUniform=function(key,value){_uniforms[key]={value:value},_shader&&_shader.uniforms&&(_shader.uniforms[key].value=value)},this.getUniform=function(key){return _shader&&_shader.uniforms?_shader.uniforms[key].value:null},this.tween=function(key,value,time,ease,delay,callback,update){return tween(_shader.uniforms[key],{value:value},time,ease,delay,callback,update)},this.clone=function(){return new AntimatterPass(_shader,_uni)},this.destroy=function(){_rts.forEach((function(rt){rt&&rt.destroy&&rt.destroy()}))},this.upload=async function(){_shader.upload(),await defer();for(let i=0;i<_rts.length;i++)_rts[i].upload(),await defer();for(let key in _shader.uniforms){let uniform=_shader.uniforms[key];uniform.value&&(uniform.value.uploadAsync?await uniform.value.uploadAsync():uniform.value.upload&&(uniform.value.upload(),await defer()))}}})),Class((function AntimatterSpawn(_proton,_group,_input){Inherit(this,Component);const _this=this;var _life,_pass,_velocity,_color,_index=-1,_total=_proton.particleCount,_releasedA=[],_releasedB=[];function loop(){let count=_releasedA.length;for(let i=count-1;i>-1;i--){let index=_releasedA[i];_life.buffer[4*index+0]=0}_releasedA.length=0,count&&(_life.needsUpdate=!0);let hold=_releasedA;_releasedA=_releasedB,_releasedB=hold}!async function(){await async function initPass(){let[lifeBuffer,velocityBuffer]=await Promise.all([_proton.antimatter.createFloatArrayAsync(4,!0),_proton.antimatter.createFloatArrayAsync(3,!0)]);_life=_this.initClass(AntimatterAttribute,lifeBuffer,4),_velocity=_this.initClass(AntimatterAttribute,velocityBuffer,3),_pass=_this.initClass(AntimatterPass,"AntimatterSpawn",{unique:_input.prefix,uMaxCount:_proton.behavior.uniforms.uMaxCount,tAttribs:_proton.behavior.uniforms.tAttribs,tLife:{value:_life,ignoreUIL:!0},uSetup:{value:1,ignoreUIL:!0},decay:{value:1},decayRandom:{value:new Vector2(1,1)}}),ShaderUIL.add(_pass,_group).setLabel("Life Shader"),_pass.onInit=_=>{_pass.setUniform("uSetup",0),_this.canEmit=!0},_proton.behavior.addInput("tSpawn",_pass),_proton.behavior.addInput("tVelocity",_velocity),_proton.shader.addUniforms({tLife:{value:_pass.output}}),_proton.antimatter.addPass(_pass,0),_this.lifeOutput=_pass.output}(),_this.startRender(loop)}(),this.emit=function(position,velocity,color){if(!_this.canEmit)return;if(velocity&&position.length!=velocity.length)throw"Position and velocity need to be the same length";if(color&&position.length!=color.length)throw"Position and color need to be the same length";let count=position.length/3;for(let i=0;i<count;i++){let index=++_index;_index>=_total&&(_index=-1),_life.buffer[4*index+0]=1,_life.buffer[4*index+1]=position[3*i+0],_life.buffer[4*index+2]=position[3*i+1],_life.buffer[4*index+3]=position[3*i+2],velocity&&(_velocity.buffer[3*index+0]=velocity[3*i+0],_velocity.buffer[3*index+1]=velocity[3*i+1],_velocity.buffer[3*index+2]=velocity[3*i+2]),color&&_color&&(_color.buffer[3*index+0]=color[3*i+0],_color.buffer[3*index+1]=color[3*i+1],_color.buffer[3*index+2]=color[3*i+2]),_releasedB.push(index)}_life.needsUpdate=!0,velocity&&(_velocity.needsUpdate=!0),color&&(_color.needsUpdate=!0)},this.release=function(pos,count=1,radius=0,velocity){if(!_this.canEmit)return;let positions=[],velocities=velocity?[]:null;for(let i=0;i<count;i++)positions[3*i+0]=pos.x+Math.random(-1,1,4)*radius,positions[3*i+1]=pos.y+Math.random(-1,1,4)*radius,positions[3*i+2]=pos.z+Math.random(-1,1,4)*radius,velocities&&(velocities[3*i+0]=velocity.x,velocities[3*i+1]=velocity.y,velocities[3*i+2]=velocity.z);_this.emit(positions,velocities)},this.upload=async function(){await _life.uploadAsync(),await _velocity.uploadAsync()},this.useColor=async function(){let colorBuffer=await _proton.antimatter.createFloatArrayAsync(3,!0);_color=_this.initClass(AntimatterAttribute,colorBuffer,3),_proton.shader.addUniforms({tColor:{value:_color}})},this.get("total",_=>_total),this.get("index",_=>_index),this.set("index",i=>_index=i)})),Class((function AntimatterUtil(){Inherit(this,Component);var _thread,_promises={};function createBufferArrayAntimatter(e,id){let size=e.size,num=e.num,position=new Float32Array(size*size*3);if(window.NativeUtils)NativeUtils.fillBufferUV(position,num,size);else for(let i=0;i<num;i++)position[3*i+0]=i%size/size,position[3*i+1]=Math.floor(i/size)/size,position[3*i+2]=i;let{w:w,h:h,d:d}=e.dimensions,usedDepth=num/(size*size),grid=0==w[0]&&0==w[1]&&0==h[0]&&0==h[1];var vertices=new Float32Array(size*size*4);if(window.NativeUtils)grid?NativeUtils.fillBufferGrid(vertices,num,size,usedDepth):NativeUtils.fillBufferRange(vertices,num,w[0],w[1],h[0],h[1],d[0],d[1]);else for(let i=0;i<num;i++)grid?(vertices[4*i+0]=Math.range(i%size,0,size,-1,1),vertices[4*i+1]=Math.range(i/size,size*usedDepth*usedDepth,0,-1,1)):(vertices[4*i+0]=Math.random(w[0],w[1],10),vertices[4*i+1]=Math.random(h[0],h[1],10),vertices[4*i+2]=Math.random(d[0],d[1],10)),vertices[4*i+3]=1;var attribs=new Float32Array(size*size*4);if(window.NativeUtils)NativeUtils.fillBufferRandom(attribs,attribs.length);else for(let i=0;i<num;i++)attribs[4*i+0]=Math.random(0,1,10),attribs[4*i+1]=Math.random(0,1,10),attribs[4*i+2]=Math.random(0,1,10),attribs[4*i+3]=Math.random(0,1,10);resolve({geometry:position,vertices:vertices,attribs:attribs,usedDepth:usedDepth},id,[position.buffer,vertices.buffer,attribs.buffer])}function createFloatArrayAntimatter({size:size},id){let array=new Float32Array(size);resolve({array:array},id,[array.buffer])}this.createBufferArray=function(size,num,config={}){_thread||function initThread(){_thread=!0,Thread.upload(createBufferArrayAntimatter),Thread.upload(createFloatArrayAntimatter)}();let key=`buffer_${JSON.stringify(config)}_${size}_${num}`;if(_promises[key])return _promises[key];let promise=_promises[key]=Promise.create();return Thread.shared().createBufferArrayAntimatter({size:size,num:num,dimensions:config}).then(data=>{data.attribs=new AntimatterAttribute(data.attribs,4),data.vertices=new AntimatterAttribute(data.vertices,4);let geometry=data.geometry;data.geometry=new Geometry,data.geometry.addAttribute("position",new GeometryAttribute(geometry,3)),data.geometry.addAttribute("random",new GeometryAttribute(data.attribs.buffer,4)),promise.resolve(data)}),promise},this.createFloatArray=function(size,freshCopy){if(freshCopy)return Thread.shared().createFloatArrayAntimatter({size:size});if(_promises[`float_size${size}`])return _promises[`float_size${size}`];return _promises[`float_size${size}`]=Thread.shared().createFloatArrayAntimatter({size:size})}}),"static"),Class((function AppState(){const _this=this;var _map=new Map,_bindings=new Map;function StateBinding(_keys,_obj){var _string,_oldValue;_obj instanceof HydraObject?("div"==_obj._type&&(_string=_obj.text()),"input"==_obj._type&&(_string=_obj.val())):window.GLUI&&_obj instanceof GLUIText&&(_string=_obj.getTextString()),this.update=function(key,value){let newValue=function parse(key,value){if(!_string)return value;let string=_string;return _keys.forEach(key=>{string=string.replace(`$(${key})`,_this.get(key))}),string}(0,value);newValue!=_oldValue&&(_oldValue=newValue,_obj instanceof HydraObject?("div"==_obj._type&&_obj.text(newValue),"input"==_obj._type&&_obj.val(newValue)):window.GLUI&&_obj instanceof GLUIText?_obj.setText(newValue):_obj.onStateChange?_obj.onStateChange(value):"function"==typeof _obj&&_obj(value))}}this.set=function(key,value){_map.set(key,value);let array=_bindings.get(key);array&&array.forEach(b=>b.update(key,value))},this.get=function(key){return _map.get(key)},this.bind=function(keys,obj){Array.isArray(keys)||(keys=[keys]);let binding=new StateBinding(keys,obj);keys.forEach(key=>{_bindings.has(key)?_bindings.get(key).push(binding):_bindings.set(key,[binding]);let value=_map.get(key);value&&binding.update(value)})},this.createLocal=function(){return new AppState}}),"static"),Module((function BufferToVertices(){const FACES=["a","b","c"];this.exports={toVertices:function toVertices(geom){!function buildFaces(geom){let attributes=geom.attributes,positions=attributes.position.array,normals=attributes.normal.array,uvs=attributes.uv.array,tempNormals=[],tempUVs=[];geom.vertices=[],geom.faceVertexUvs=[[]],geom.faces=[];let indices=geom.index;function Face3(a,b,c,normal){this.a=a,this.b=b,this.c=c,this.normal=normal}for(let i=0,j=0;i<positions.length;i+=3,j+=2)geom.vertices.push(new Vector3(positions[i],positions[i+1],positions[i+2])),tempNormals.push(new Vector3(normals[i],normals[i+1],normals[i+2])),tempUVs.push(new Vector2(uvs[j],uvs[j+1]));function addFace(a,b,c,materialIndex){let face=new Face3(a,b,c,[tempNormals[a].clone(),tempNormals[b].clone(),tempNormals[c].clone()]);geom.faces.push(face),geom.faceVertexUvs[0].push([tempUVs[a].clone(),tempUVs[b].clone(),tempUVs[c].clone()])}for(var i=0;i<indices.length;i+=3)addFace(indices[i],indices[i+1],indices[i+2]);!function mergeVertices(geom){var v,key,i,il,face,indices,j,jl,verticesMap={},unique=[],changes=[],precision=Math.pow(10,4);for(i=0,il=geom.vertices.length;i<il;i++)v=geom.vertices[i],key=Math.round(v.x*precision)+"_"+Math.round(v.y*precision)+"_"+Math.round(v.z*precision),void 0===verticesMap[key]?(verticesMap[key]=i,unique.push(geom.vertices[i]),changes[i]=unique.length-1):changes[i]=changes[verticesMap[key]];var faceIndicesToRemove=[];for(i=0,il=geom.faces.length;i<il;i++){(face=geom.faces[i]).a=changes[face.a],face.b=changes[face.b],face.c=changes[face.c],indices=[face.a,face.b,face.c];for(var n=0;n<3;n++)if(indices[n]===indices[(n+1)%3]){faceIndicesToRemove.push(i);break}}for(i=faceIndicesToRemove.length-1;i>=0;i--){var idx=faceIndicesToRemove[i];for(geom.faces.splice(idx,1),j=0,jl=geom.faceVertexUvs.length;j<jl;j++)geom.faceVertexUvs[j].splice(idx,1)}var diff=geom.vertices.length-unique.length;return geom.vertices=unique,diff}(geom)}(geom)},toBuffer:function toBuffer(geom){let faces=geom.faces,array=geom.attributes.position.array;for(let i=0;i<faces.length;i++){let face=faces[i];for(let f=0;f<FACES.length;f++){let index=face[FACES[f]],vertex=geom.vertices[index];array[3*index+0]=vertex.x,array[3*index+1]=vertex.y,array[3*index+2]=vertex.z}}}}})),Class((function CameraTrack(_name,_group,_customFields){Inherit(this,Object3D);const _this=this;var _list,_panel,_range,_line,_timeline,_originalFields,_unlockView,_tween,_holdArray;this.camera=new BaseCamera,this.elapsed=0;var _config=InputUIL.create(`cameraTrack_${_name}`,null),_count=_config.getNumber("count")||0,_data=_config.get("data")||[],_array=[],_map={},_target=new Group,_sort=0;const EDIT=Utils.query("orbit")&&Utils.query("editTrack"),RANGE=Utils.query("editTrack"),SHOW=Utils.query("showAllPaths");function initDebugLine(){if(!_array.length)return;_line&&_this.remove(_line);let points=[];_array.forEach(c=>{c.group.updateMatrixWorld(!0),points.push((new Vector3).copy(c.camera.getWorldPosition()))});let geometry=(new Geometry).setFromPoints(points),shader=Utils3D.getTestShader(16711680);_line=new Line(geometry,shader),_this.add(_line)}function play(){if(_array&&_array[0])return TweenManager.clearTween(_this),_this.camera.group.position.copy(_array[0].group.position),_this.camera.group.quaternion.copy(_array[0].group.quaternion),_this.elapsed=0,(_tween=tween(_this,{elapsed:1},_this.duration,_panel.get("ease"),0,null,null,!0).onUpdate(_=>{_range&&_range.force(_this.elapsed,!0)})).promise()}function lerpCustom(f,t,a,ptr){if(Array.isArray(f))for(let i=0;i<f.length;i++)ptr[i]=Math.mix(f[i],t[i],a);else ptr=Math.mix(f,t,a);return ptr}function loop(){if(!_array.length||!_timeline.data.length)return;let elapsed=_this.elapsed,t=(_array.length,function getNextStep(elapsed){let next=999,index=0;for(let i=0;i<_timeline.data.length;i++){let d=_timeline.data[i];d.value>=elapsed&&d.value<=next&&(next=d.value,index=i)}return index}(elapsed)),f=Math.max(0,t-1),mix=Math.range(elapsed,_timeline.data[f].value,_timeline.data[t].value,0,1,!0)||0;if(!_array[f]||!_array[t])return;_this.flag("firstFrame")||(_this.flag("firstFrame",!0),_target.position.copy(_array[0].camera.getWorldPosition()),_target.quaternion.copy(_array[0].camera.getWorldQuaternion()),_this.camera.group.position.copy(_target.position),_this.camera.group.quaternion.copy(_target.quaternion)),_target.position.copy(_array[f].camera.getWorldPosition()).lerp(_array[t].camera.getWorldPosition(),mix,!0),_target.quaternion.copy(_array[f].camera.getWorldQuaternion()).slerp(_array[t].camera.getWorldQuaternion(),mix,!0);let lerp=_panel.getNumber("lerp");if(_this.camera.group.position.lerp(_target.position,lerp),_this.camera.group.quaternion.slerp(_target.quaternion,lerp),!EDIT)for(let key in _customFields)_customFields[key]=lerpCustom(_array[f].customFields[key],_array[t].customFields[key],mix,_customFields[key])}function createCamera(postfix){let storeData,locked,debug,input,camera=new BaseCamera;_this.add(camera),camera.sortIndex=_sort++,(EDIT||SHOW)&&(debug=new Mesh(new BoxGeometry(.25,.25,.5,1,1,5),new Shader("DebugCamera",{uColor:{value:new Color}})),_this.startRender(_=>{debug.position.copy(camera.camera.getWorldPosition()),debug.quaternion.copy(camera.camera.getWorldQuaternion())}),_this.add(debug));let lock=_=>{if(World.CAMERA.position.copy(camera.camera.getWorldPosition()),World.CAMERA.quaternion.copy(camera.camera.getWorldQuaternion()),World.CAMERA.fov=camera.fov,World.CAMERA.updateProjectionMatrix(),_customFields)for(let key in _customFields)_customFields[key]=input.get(key),Array.isArray(_customFields[key])||(_customFields[key]=Number(_customFields[key]));_this.events.fire(CameraTrack.LOCK_VIEW,{type:"lock",fields:_customFields})},orbitView=_=>{locked||!_unlockView||_unlockView==orbitView?(locked=!1,World.CONTROLS.enabled=!0,_this.stopRender(lock),World.CAMERA.position.copy(storeData.position),World.CAMERA.quaternion.copy(storeData.quaternion),World.CAMERA.fov=storeData.fov,World.CAMERA.updateProjectionMatrix(),_this.events.fire(CameraTrack.LOCK_VIEW,{type:"release",fields:_originalFields})):_unlockView=_unlockView()};if(input=InputUIL.create(`${_name}_cameraTrack_${postfix}`,UIL.global,!0),input.setLabel("Keyframe"),input.addColor("colorCode"),input.add("label"),input.add("quaternion","hidden"),input.add("mapped","hidden"),input.addNumber("fov",World.CAMERA.fov),input.addVector("position",[0,0,0]),input.addVector("rotation",[0,0,0],{step:1}),_customFields){camera.customFields={};for(let key in _customFields){let value=_customFields[key];"number"==typeof value&&(input.addNumber(key,value),camera.customFields[key]=input.getNumber(key)),Array.isArray(value)&&(input.addVector(key,value),camera.customFields[key]=input.get(key))}}input.addButton("editrot",{actions:[{title:"Edit Rotation",callback:_=>{let c=World.CAMERA.clone(),controls=new DebugControls(c,World.ELEMENT.div);camera.camera.rotation.set(0,0,0),input.setValue("rotation",[0,0,0]),World.CONTROLS.enabled=!1;let update=_=>{controls.update(),debug.quaternion.copy(c.quaternion),camera.group.quaternion.copy(c.quaternion)};_this.startRender(update);let up=_=>{locked||(World.CONTROLS.enabled=!0),_this.stopRender(update),controls.dispose(),input.setValue("quaternion",camera.group.quaternion.toArray()),Stage.unbind("mouseup",up)};Stage.bind("mouseup",up)}}],hideLabel:!0}),input.addButton("cameraview",{actions:[{title:"Camera View",callback:_=>{_unlockView&&_unlockView!=orbitView&&(_unlockView=_unlockView()),_unlockView=orbitView,locked||(locked=!0,storeData=World.CAMERA.clone(),World.CONTROLS.enabled=!1,_this.startRender(lock))}}],hideLabel:!0}),input.addButton("orbitview",{actions:[{title:"Orbit View",callback:orbitView}],hideLabel:!0}),input.addButton("snapshot",{actions:[{title:"Snapshot from Orbit",callback:_=>{camera.group.position.copy(World.CAMERA.position),camera.group.quaternion.copy(World.CAMERA.quaternion),input.setValue("quaternion",camera.group.quaternion.toArray()),input.setValue("position",camera.group.position.toArray()),input.setValue("rotation",[0,0,0])}}],hideLabel:!0}),camera.postfix=postfix,camera.input=input,input.onUpdate=key=>{if("position"==key&&(camera.group.position.fromArray(input.get(key)),_line)){camera.group.updateMatrixWorld(!0);let array=_line.geometry.attributes.position.array,{x:x,y:y,z:z}=camera.camera.getWorldPosition();array[3*camera.sortIndex+0]=x,array[3*camera.sortIndex+1]=y,array[3*camera.sortIndex+2]=z,_line.geometry.attributes.position.needsUpdate=!0}"rotation"==key&&camera.camera.rotation.fromArray(function toRadians(array){return array?(array.length=3,array.map(x=>Math.radians(x))):[0,0,0]}(input.get(key))),"quaternion"==key&&camera.group.quaternion.fromArray(input.get(key)||[0,0,0,1]),"fov"==key&&(camera.fov=input.get(key)),"colorCode"==key&&debug&&debug.shader.uniforms.uColor.value.set(input.get(key)),"label"==key&&(camera&&camera.oInput&&camera.oInput.setLabel(input.get(key)||"Keyframe"),input.setLabel(input.get(key)||"Keyframe"))},["position","rotation","fov","colorCode","label","quaternion"].forEach(input.onUpdate),_array.push(camera),EDIT&&_this.events.sub(_list,ListUIL.OPEN,_=>{input.onUpdate("label")})}function socketEvent(e){switch(e.action){case"play":play();break;case"pause":_tween.pause();break;case"resume":_tween.resume()}}function keyUp(e){switch(e.key){case"k":let panel=ListUIL.getPanel();_this.flag("kAdd",!0,50),panel&&panel.add()}}function btnPlay(){_this.flag("playing")?(_this.flag("playing",!1),_panel.getField("play").setTitle("Play"),_tween&&_tween.pause&&_tween.pause(),_this.onBtnPlay&&_this.onBtnPlay("pause"),UILSocket.send("cameraTrack",{action:"pause"})):(_this.flag("playing",!0),_panel.getField("play").setTitle("Pause"),_this.flag("inPlay")?(_tween&&_tween.resume&&_tween.resume(),_this.onBtnPlay&&_this.onBtnPlay("resume"),UILSocket.send("cameraTrack",{action:"resume"})):(UILSocket.send("cameraTrack",{action:"play"}),_this.onBtnPlay&&_this.onBtnPlay("play"),_this.flag("inPlay",!0),play().then(_=>{_this.flag("playing",!1),_this.flag("inPlay",!1),_panel.getField("play").setTitle("Play")})))}function uilSave(){if(!_timeline)return;let timeline=[];_array.forEach(camera=>{let data={};data.label=camera.input.get("label")||"Keyframe",camera.input.get("mapped")||(data.percent=1,camera.input.setValue("mapped",!0)),timeline.push(data)}),_timeline.model.setState(timeline)}function addKeyframe(name,input,index){_holdArray=_array.slice(0),_array[index]||function create(){_count++,_data.push(`c${_count}`),_config.setValue("data",JSON.stringify(_data)),_config.setValue("count",_count),createCamera(`c${_count}`),initDebugLine()}(),input.group.add(_array[index].input.group),_array[index].mapId=name,_map[name]=_array[index],_map[name].oInput=input,_this.flag("kAdd")&&defer(_=>{for(let key in _map){_map[key].oInput.listUILItem.close()}let sort=function getAutoSortIndex(){if(1==_this.elapsed)return-1;if(0==_this.elapsed)return 0;let index=0;for(let i=0;i<_holdArray.length;i++)_this.elapsed>=Math.range(i,0,_holdArray.length-1,0,1)&&(index=i+1),index==i&&i==_holdArray.length-1&&(index=-1);return index}();sort>-1&&input.listUILItem.forceSort(sort),input.listUILItem.open()})}function removeKeyframe(name){let postfix=_map[name].postfix;_array.remove(_map[name]),_data.remove(postfix),_config.setValue("data",JSON.stringify(_data))}function sortKeyframes(array){let arr=[];array.forEach((name,i)=>{_map[name].sortIndex=i,arr.push(_map[name].postfix)}),_array.sort((a,b)=>a.sortIndex-b.sortIndex),_data=arr,_config.setValue("data",JSON.stringify(_data)),EDIT&&initDebugLine()}!_group||_group instanceof UILFolder||(_customFields=_group,_group=void 0),_customFields&&(_originalFields=Utils.cloneObject(_customFields)),RANGE&&!UIL.global&&console.error("Editing CameraTrack requires &uil"),function addListeners(){_this.events.sub(UILStorage.SAVE,uilSave),_this.events.sub(KeyboardUtil.UP,keyUp),window.UILSocket&&_this.events.sub(UILSocket,"cameraTrack",socketEvent)}(),_this.editing=EDIT,(_timeline=TimelineUIL.create(`${_name}_cameraTrack`,RANGE?_group||void 0:null)).model.lock().rails(),_timeline.setLabel("Timeline"),_timeline.data=_timeline.model.getData(),(_list=ListUIL.create(`${_name}_cameraTrack`,RANGE?_group||void 0:null)).setLabel("Keyframes"),_list.onAdd(addKeyframe),_list.onRemove(removeKeyframe),_list.onSort(sortKeyframes),_data.forEach(createCamera),EDIT&&initDebugLine(),(_panel=InputUIL.create(`${_name}_camera_config`,RANGE?_group||void 0:null)).setLabel("Camera Config"),_panel.add("duration",5e3),_panel.add("lerp",.07),_panel.add("ease","linear"),_panel.addButton("play",{actions:[{title:"Play",callback:btnPlay}],hideLabel:!0}),_this.duration=_panel.getNumber("duration"),EDIT&&defer(_=>{_this.onCreatePanel&&_this.onCreatePanel(_panel)}),RANGE&&(_this.camera.lock(),(_range=new UILControlRange("Track Progress",{min:0,max:1,step:.001})).onChange(val=>{!_this.flag("playing")&&_tween&&_tween.setElapsed(val),_this.elapsed=val}),_range.onFinishChange(val=>{_this.flag("playing")||(_this.onRangeDrag&&_this.onRangeDrag(val),_this.camera.group.position.copy(_target.position),_this.camera.group.quaternion.copy(_target.quaternion))}),_panel.group.add(_range)),defer(_=>{_array.length&&(_this.camera.group.position.copy(_array[0].group.position),_this.camera.group.quaternion.copy(_array[0].group.quaternion))}),_this.startRender(loop),this.addCustomFields=function(fields){_customFields=fields},this.play=function(){return play()}}),_=>{CameraTrack.LOCK_VIEW="camera_track_lock_view"}),Module((function ConsoleSecurity(){this.exports=function(){let err=new Error;if(err.stack){if(err.stack.toString().toLowerCase().includes(["@debugger","<anonymous>:1","_evaluateandwrap","eval code:1:1)"]))return!0}return!1}}));class CubicPoly{constructor(x0,x1,t0,t1){this.init(x0,x1,t0,t1)}init(x0,x1,t0,t1){this.c0=x0,this.c1=t0,this.c2=-3*x0+3*x1-2*t0-t1,this.c3=2*x0-2*x1+t0+t1}initCatmullRom(x0,x1,x2,x3,tension){this.init(x1,x2,tension*(x2-x0),tension*(x3-x1))}initNonuniformCatmullRom(x0,x1,x2,x3,dt0,dt1,dt2){let t1=(x1-x0)/dt0-(x2-x0)/(dt0+dt1)+(x2-x1)/dt1,t2=(x2-x1)/dt1-(x3-x1)/(dt1+dt2)+(x3-x2)/dt2;t1*=dt1,t2*=dt1,this.init(x1,x2,t1,t2)}calc(t){let t2=t*t,t3=t2*t;return this.c0+this.c1*t+this.c2*t2+this.c3*t3}}Class((function Curve(_input){Inherit(this,Component);const _this=this;var _curve;this.root=new Group,Array.isArray(_input)&&Array.isArray(_input[0])?function initFromArray(){let points=[];for(let i=0;i<_input.length;i++)points.push((new Vector3).fromArray(_input[i]));_curve=new CatmullRomCurve(points)}():function initFromObj(obj){if("string"==typeof obj){let name=obj;if(!(obj=Assets.JSON[obj]))throw`No curve ${name} found`;obj.curves=obj.curves[0]}else obj.curves=Array.isArray(obj.curves[0])?obj.curves[0]:obj.curves;for(var data=obj.curves,points=[],j=0;j<data.length;j+=3)points.push(new Vector3(data[j+0],data[j+1],data[j+2]));_curve=new CatmullRomCurve(points)}(_input),this.debug=function(){let points=_curve.getPoints(50),geometry=(new Geometry).setFromPoints(points),shader=Utils3D.getTestShader(4095),curveObject=new Line(geometry,shader);return _this.root.add(curveObject),_this.root},this.getPointAt=function(t){t=Math.max(0,Math.min(1,t)),window.THREAD||this.root.updateMatrixWorld();let pos=_curve.getPointAt(t);return window.THREAD||pos.applyMatrix4(this.root.matrixWorld),pos},this.getPoint=function(t){t=Math.max(0,Math.min(1,t)),window.THREAD||this.root.updateMatrixWorld();let pos=_curve.getPoint(t);return window.THREAD||pos.applyMatrix4(this.root.matrixWorld),pos},this.getTangent=function(t){t=Math.max(0,Math.min(1,t)),window.THREAD||this.root.updateMatrixWorld();let pos=_curve.getTangent(t);return window.THREAD||pos.applyMatrix4(this.root.matrixWorld),pos},this.set("closed",v=>{_curve.closed=v}),this.get("curve",_=>_curve)}),_=>{Curve.parseFile=async function(data){"string"==typeof data&&(data=await get(Assets.getPath(data)));let curves=[];return data.curves.forEach(array=>{curves.push(new Curve({curves:[array]}))}),curves},Curve.loadOnThread=function(thread){thread.importES6Class("CubicPoly"),thread.importES6Class("Curve3D"),thread.importES6Class("CatmullRomCurve"),thread.importClass(Curve)}});class Curve3D{constructor(){this.arcLengthDivisions=200}getPointAt(u){let t=this.getUtoTmapping(u);return this.getPoint(t)}getPoints(divisions=5){let points=[];for(let d=0;d<=divisions;d++)points.push(this.getPoint(d/divisions));return points}getSpacedPoints(divisions=5){let points=[];for(let d=0;d<=divisions;d++)points.push(this.getPointAt(d/divisions));return points}getLength(){let lengths=this.getLengths();return lengths[lengths.length-1]}getLengths(divisions=this.arcLengthDivisions){if(this.cacheArcLengths&&this.cacheArcLengths.length===divisions+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;let current,p,cache=[],last=this.getPoint(0),sum=0;for(cache.push(0),p=1;p<=divisions;p++)current=this.getPoint(p/divisions),sum+=current.distanceTo(last),cache.push(sum),last=current;return this.cacheArcLengths=cache,cache}updateArtLengths(){this.needsUpdate=!0,this.getLengths()}getUtoTmapping(u,distance){let targetArcLength,arcLengths=this.getLengths(),i=0,il=arcLengths.length;targetArcLength=distance||u*arcLengths[il-1];let comparison,low=0,high=il-1;for(;low<=high;)if(i=Math.floor(low+(high-low)/2),comparison=arcLengths[i]-targetArcLength,comparison<0)low=i+1;else{if(!(comparison>0)){high=i;break}high=i-1}if(i=high,arcLengths[i]===targetArcLength)return i/(il-1);let lengthBefore=arcLengths[i];return(i+(targetArcLength-lengthBefore)/(arcLengths[i+1]-lengthBefore))/(il-1)}getTangent(t){let t1=t-1e-4,t2=t+1e-4;t1<0&&(t1=0),t2>1&&(t2=1);let pt1=this.getPoint(t1);return this.getPoint(t2).clone().sub(pt1).normalize()}getTangentAt(u){let t=this.getUtoTmapping(u);return this.getTangent(t)}computeFrenetFrames(segments,closed){let i,u,theta,normal=new Vector3,tangents=[],normals=[],binormals=[],vec=new Vector3,mat=new Matrix4;for(i=0;i<=segments;i++)u=i/segments,tangents[i]=this.getTangentAt(u),tangents[i].normalize();normals[0]=new Vector3,binormals[0]=new Vector3;let min=Number.MAX_VALUE,tx=Math.abs(tangents[0].x),ty=Math.abs(tangents[0].y),tz=Math.abs(tangents[0].z);for(tx<=min&&(min=tx,normal.set(1,0,0)),ty<=min&&(min=ty,normal.set(0,1,0)),tz<=min&&normal.set(0,0,1),vec.crossVectors(tangents[0],normal).normalize(),normals[0].crossVectors(tangents[0],vec),binormals[0].crossVectors(tangents[0],normals[0]),i=1;i<=segments;i++)normals[i]=normals[i-1].clone(),binormals[i]=binormals[i-1].clone(),vec.crossVectors(tangents[i-1],tangents[i]),vec.length()>Number.EPSILON&&(vec.normalize(),theta=Math.acos(Math.clamp(tangents[i-1].dot(tangents[i]),-1,1)),normals[i].applyMatrix4(mat.makeRotationAxis(vec,theta))),binormals[i].crossVectors(tangents[i],normals[i]);if(!0===closed)for(theta=Math.acos(Math.clamp(normals[0].dot(normals[segments]),-1,1)),theta/=segments,tangents[0].dot(vec.crossVectors(normals[0],normals[segments]))>0&&(theta=-theta),i=1;i<=segments;i++)normals[i].applyMatrix4(mat.makeRotationAxis(tangents[i],theta*i)),binormals[i].crossVectors(tangents[i],normals[i]);return{tangents:tangents,normals:normals,binormals:binormals}}}Class((function CurveLayer(_input,_group){Inherit(this,Object3D);const _this=this;let _config,_curve,_debug;function getJSONPath(){let path=_config.get("json");return path.includes("assets/geometry")||(path="assets/geometry/"+path),path.includes(".json")||(path+=".json"),path}!async function(){_config=InputUIL.create(_input.prefix+"curve",_group),_config.setLabel("Curve"),_config.add("json"),_config.addToggle("debug"),_config.get("json")&&await async function initCurve(path){let data=_this.data=await get(Assets.getPath(path));_curve=_this.initClass(Curve,data),Global.PLAYGROUND&&(_debug=_curve.debug(),_debug.visible=_config.get("debug"),_this.add(_debug))}(getJSONPath()),_config.onUpdate=_=>{_debug&&(_debug.visible=Global.PLAYGROUND&&_config.get("debug"))},_this.flag("loaded",!0)}(),this.getData=async function(){return _config.get("json")||console.warn("No json path set on CurveLayer :: Promise won't resolve"),await _this.wait("data"),_this.data},this.getJSONPath=function(){return _config.get("json")||console.warn("No json path set on CurveLayer"),getJSONPath()},this.getCurve=async function(){return await _this.wait("loaded"),_curve}}));class CatmullRomCurve extends Curve3D{constructor(points=[]){if(super(),this.tmp=new Vector3,this.px=new CubicPoly,this.py=new CubicPoly,this.pz=new CubicPoly,points.length<2)throw"CatmullRomCurve: Points array needs at least two entries.";this.points=points,this.closed=!1}getLength(){const tmp=this.tmp;let length=0;return this.points.forEach((p,i)=>{0!==i&&(tmp.subVectors(p,this.points[i-1]),length+=tmp.length())}),length}getPoint(t,target){let p0,p1,p2,p3,tmp=this.tmp,px=this.px,py=this.py,pz=this.pz,points=this.points,l=points.length,point=(l-(this.closed?0:1))*t,intPoint=Math.floor(point),weight=point-intPoint;if(this.closed?intPoint+=intPoint>0?0:(Math.floor(Math.abs(intPoint)/points.length)+1)*points.length:0===weight&&intPoint===l-1&&(intPoint=l-2,weight=1),this.closed||intPoint>0?p0=points[(intPoint-1)%l]:(tmp.subVectors(points[0],points[1]).add(points[0]),p0=tmp),p1=points[intPoint%l],p2=points[(intPoint+1)%l],this.closed||intPoint+2<l?p3=points[(intPoint+2)%l]:(tmp.subVectors(points[l-1],points[l-2]).add(points[l-1]),p3=tmp),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){let pow="chordal"===this.type?.5:.25,dt0=Math.pow(p0.distanceToSquared(p1),pow),dt1=Math.pow(p1.distanceToSquared(p2),pow),dt2=Math.pow(p2.distanceToSquared(p3),pow);dt1<1e-4&&(dt1=1),dt0<1e-4&&(dt0=dt1),dt2<1e-4&&(dt2=dt1),px.initNonuniformCatmullRom(p0.x,p1.x,p2.x,p3.x,dt0,dt1,dt2),py.initNonuniformCatmullRom(p0.y,p1.y,p2.y,p3.y,dt0,dt1,dt2),pz.initNonuniformCatmullRom(p0.z,p1.z,p2.z,p3.z,dt0,dt1,dt2)}else if("catmullrom"===this.type){let tension=void 0!==this.tension?this.tension:.5;px.initCatmullRom(p0.x,p1.x,p2.x,p3.x,tension),py.initCatmullRom(p0.y,p1.y,p2.y,p3.y,tension),pz.initCatmullRom(p0.z,p1.z,p2.z,p3.z,tension)}if(!target)return new Vector3(px.calc(weight),py.calc(weight),pz.calc(weight));target.set(px.calc(weight),py.calc(weight),pz.calc(weight))}}Class((function ImageDecoder(){Inherit(this,Component);var _compressed,_this=this;const ACTIVE=!(!(window.fetch&&window.createImageBitmap&&Device.system.browser.includes("chrome"))||window.AURA);function decodeImage(data,id){(async _=>{try{let e=await fetch(data.path,{mode:"cors"});if(200!=e.status)throw resolve({fail:!0},id),`Image not found :: ${data.path}`;let blob=await e.blob(),obj={imageOrientation:"flipY",crossOrigin:"anonymous"};data.params&&!1===data.params.premultiplyAlpha&&(obj.premultiplyAlpha="none"),obj.imageOrientation=data.params&&!1===data.params.flipY?void 0:"flipY";let bitmap=await createImageBitmap(blob,obj),message={post:!0,id:id,message:bitmap};self.postMessage(message,[bitmap])}catch(e){throw resolve({fail:!0},id),e}})()}function decodeCompressedImage(data,id){(async _=>{let ext;data.settings.dxt?ext="dxt":data.settings.etc?ext="astc":data.settings.pvrtc?ext="pvrtc":data.settings.astc&&(ext="astc");let fileName=data.path.split("/");fileName=fileName[fileName.length-1];let e=await fetch(`${data.path}/${fileName}-${ext}.ktx`);if(200!=e.status)throw`Image not found :: ${data.path}`;try{let arrayBuffer=await e.arrayBuffer(),header=new Int32Array(arrayBuffer,12,13),gliFormat=(header[1],header[2],header[3],header[4]),width=(header[5],header[6]),height=header[7],miplevels=header[11],bytesOfKeyValueData=header[12],buffers=[],compressedData=[],sizes=[],dataOffset=64+bytesOfKeyValueData;for(let level=0;level<miplevels;level++){let imageSize=new Int32Array(arrayBuffer,dataOffset,1)[0];dataOffset+=4;let byteArray=new Uint8Array(arrayBuffer,dataOffset,imageSize);dataOffset+=imageSize,dataOffset+=3-(imageSize+3)%4,sizes.push(width),width=Math.max(1,.5*width),height=Math.max(1,.5*height);let clone=new Uint8Array(byteArray);compressedData.push(clone),buffers.push(clone.buffer)}resolve({gliFormat:gliFormat,compressedData:compressedData,sizes:sizes,width:width,height:height},id,buffers)}catch(e){throw`${data.path} could not be decoded`}})()}this.scale=1,async function(){await Hydra.ready(),Thread.upload(decodeImage),Thread.upload(decodeCompressedImage)}(),this.decode=async function(path,params={}){if(path=Thread.absolutePath(Assets.getPath(path)),!_compressed){_compressed={dxt:!!Renderer.extensions.s3tc,etc:!!Renderer.extensions.etc1,pvrtc:!!Renderer.extensions.pvrtc,astc:!!Renderer.extensions.astc};let found=!1;for(let key in _compressed)1==_compressed[key]&&(found=!0);found||(_compressed=null)}if(!_compressed&&path.includes("-compressedKtx")&&(path=path.replace("-compressedKtx","")),path.includes("-compressedKtx")){return path=path.substring(0,path.lastIndexOf(".")),await Thread.shared().decodeCompressedImage({path:path,params:params,settings:_compressed})}try{let bitmap=await(ACTIVE?Thread.shared().decodeImage({path:path,params:params}):Assets.decodeImage(path,params));if(bitmap.fail)throw"could not decode "+path;return function process(bitmap,scale){if(1==scale*_this.scale)return bitmap;let pow2=Math.isPowerOf2(bitmap.width,bitmap.height),canvas=document.createElement("canvas");return canvas.context=canvas.getContext("2d"),canvas.width=Math.round(bitmap.width*_this.scale*scale),canvas.height=Math.round(bitmap.height*_this.scale*scale),pow2&&scale*_this.scale<1&&(canvas.width=canvas.height=Math.floorPowerOf2(Math.max(canvas.width,canvas.height))),canvas.context.drawImage(bitmap,0,0,canvas.width,canvas.height),canvas}(bitmap,params.scale||1)}catch(e){throw"could not decode "+path}}}),"static"),Class((function BaseCamera(_input,_group){Inherit(this,Object3D);const _this=this;var _type="perspective";function resize(){switch(_type){case"perspective":_this.camera.aspect=Stage.width/Stage.height,_this.camera.updateProjectionMatrix();break;case"orthographic":if(_this.width||_this.height)_this.camera.setViewport(_this.width,_this.height);else{let m=900/Stage.height/100;_this.camera.setViewport(Stage.width*m,Stage.height*m)}}}this.camera=new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),this.group.add(this.camera),this.startRender(_=>{_this.group.updateMatrixWorld(!0)}),this.onResize(_=>{resize()}),_group&&(_this.prefix=_input.prefix,CameraUIL.add(_this,_group).setLabel("Camera")),this.playgroundLock=function(camera=Camera.instance()){if(!Global.PLAYGROUND)return;Utils.getConstructorName(_this.parent).includes(Global.PLAYGROUND.split("/")[0])&&RenderManager.type==RenderManager.NORMAL&&camera.lock(_this.camera)},this.lock=function(camera=Camera.instance()){if("orthographic"==_type)return console.error("You can't lock an orthographic camera to the main camera. Use an FXScene .setCamera");RenderManager.type==RenderManager.NORMAL&&camera.lock(_this.camera)},this.transition=function(time,ease,delay,camera=Camera.instance()){"object"==typeof delay&&(camera=delay,delay=0);let p=Promise.create();return camera.transition(_this.camera,time,ease,delay||0),delay>0?_this.delayedCall(_=>p.resolve(),delay):p.resolve(),p},this.setFOV=function(fov){fov!=this.camera.fov&&(this.camera.fov=fov,this.camera.updateProjectionMatrix())},this.getFOV=function(){return this.camera.fov},this.useOrthographic=function(w,h){"orthographic"!==_type&&"orthographic"!==_type&&(isNaN(w)||(this.width=w),isNaN(h)||(this.height=h),this.camera&&this.group.remove(this.camera),this.camera=new OrthographicCamera,this.group.add(this.camera),_type="orthographic",resize())},this.usePerspective=function(){"perspective"!==_type&&(this.camera&&this.group.remove(this.camera),this.camera=new PerspectiveCamera,this.group.add(this.camera),_type="perspective",resize())}})),Class((function Camera(_worldCamera){Inherit(this,Component);const _this=this;var _debug,_prevCamera,_lockCamera,_curve,_calc=new Vector3,_target=new Group,_anim={weight:0,weight2:0},_center=new Vector3;function loop(){if(_debug&&(_debug.visible=!_debug.position.equals(_center)),_anim.weight+=(_anim.weight2-_anim.weight)*_this.lerp,_prevCamera){if(_curve){let pos=_curve.getPoint(_anim.weight);pos.lerp(_prevCamera.getWorldPosition(),Math.range(_anim.weight,0,.1,1,0,!0)),pos.lerp(_lockCamera.getWorldPosition(),Math.range(_anim.weight,.6,1,0,1,!0)),_curve.lerpPos||(_curve.lerpPos=(new Vector3).copy(_prevCamera.getWorldPosition()),_curve.lerpBlend={value:0});let lerp=Math.mix(_curveLerp||1,1,_curve.lerpBlend.value);_curve.lerpPos.lerp(pos,lerp),0==_curve.lerpBlend.value&&_calc.subVectors(_worldCamera.position,_lockCamera.getWorldPosition()).length()<.01&&(_curve.lerpBlend.value=.001,tween(_curve.lerpBlend,{value:1},1e3,"linear"),_this.onCurveComplete&&_this.onCurveComplete()),_target.position.copy(_curve.lerpPos)}else _target.position.copy(_prevCamera.getWorldPosition()).lerp(_lockCamera.getWorldPosition(),_anim.weight);_target.quaternion.copy(_prevCamera.getWorldQuaternion()).slerp(_lockCamera.getWorldQuaternion(),_anim.weight),_worldCamera.fov!=_lockCamera.fov&&(_worldCamera.fov+=(_lockCamera.fov-_worldCamera.fov)*_anim.weight,_worldCamera.updateProjectionMatrix()),_worldCamera.position.lerp(_target.position,_this.lerp2),_worldCamera.quaternion.slerp(_target.quaternion,_this.lerp2)}else _lockCamera&&(Utils3D.decompose(_lockCamera,_worldCamera),_worldCamera.fov!=_lockCamera.fov&&(_worldCamera.fov=_lockCamera.fov,_worldCamera.updateProjectionMatrix()));_debug&&(_debug.position.copy(_worldCamera.position),_debug.quaternion.copy(_worldCamera.quaternion)),_this.postLoop()}this.lerp=1,this.lerp2=1,this.worldCamera=_worldCamera,Utils.query("orbit")?function initDebug(){(_debug=new Mesh(new BoxGeometry(.25,.25,.5,1,1,5),new Shader("DebugCamera",{uColor:{value:new Color,transparent:!0,depthTest:!1}}))).renderOrder=9999,World.SCENE.add(_debug),_worldCamera=new PerspectiveCamera;let p=Global.PLAYGROUND||"m",pos=Storage.get(`debugCameraPos_${p}`)||World.CAMERA.position.toArray();World.CAMERA.position.fromArray(pos),World.CONTROLS.onChange=_=>Storage.set(`debugCameraPos_${p}`,World.CAMERA.position.toArray())}():World.CONTROLS&&(World.CONTROLS.enabled=!1),_this.startRender(loop),this.lock=function(camera){_lockCamera=camera,_worldCamera.fov=_lockCamera.fov,_worldCamera.updateProjectionMatrix(),_prevCamera=null,loop()},this.transition=function(camera,duration=1e3,ease="easeInOutCubic"){return _curve&&(_curve.lerpPos=_curve.lerpBlend=null),camera.curve&&((_curve=camera.curve).lerpPos=camera.lerpPos),_prevCamera===camera?(duration*=.5*Math.smoothStep(.5,1,_anim.weight)+.5,_anim.weight=1-_anim.weight):_anim.weight=0,_anim.weight2=_anim.weight,_prevCamera=_lockCamera,_lockCamera=camera,tween(_anim,{weight2:1},duration,ease)},this.get("worldCamera",_=>_worldCamera),this.set("debugScale",s=>{_debug&&_debug.scale.setScalar(s)}),this.createLocal=function(camera){return camera||(camera=World.CAMERA.clone(),_this.onResize(_=>{camera.aspect=Stage.width/Stage.height,camera.updateProjectionMatrix()})),new Camera(camera.camera||camera)}}),"singleton"),Class((function GazeCamera(_input,_group){Inherit(this,BaseCamera);const _this=this;var _strength={v:1},_move=new Vector3,_position=new Vector3,_wobble=new Vector3,_rotation=0,_wobbleAngle=Math.radians(Math.rand(0,360)),_innerGroup=new Group;function loop(){if(_this.useAccelerometer&&Device.mobile)_move.x=_this.position.x+Math.range(Mobile.Accelerometer.x,-2,2,-1,1,!0)*_strength.v*_this.moveXY.x*_this.strength,_move.y=0;else{_move.x=_this.position.x+Math.range(Mouse.x,0,Stage.width,-1,1,!0)*_strength.v*_this.moveXY.x*_this.strength,_move.y=_this.position.y+Math.range(Mouse.y,0,Stage.height,-1,1,!0)*_strength.v*_this.moveXY.y*_this.strength;let rotateStrength=Math.range(Math.abs(Mouse.delta.x)/Stage.width,0,.02,0,1,!0);_rotation=Math.lerp(Math.radians(_this.deltaRotate)*rotateStrength*Math.sign(Mouse.delta.x),_rotation,.02*_this.deltaLerp*_strength.v),_this.group.rotation.z=Math.lerp(_rotation,_this.group.rotation.z,.07*_this.deltaLerp)}if(_move.z=_this.position.z,_position.lerp(_move,_this.lerpSpeed2),_this.camera.position.lerp(_position,_this.lerpSpeed),_this.camera.lookAt(_this.lookAt),_this.wobbleStrength>0){let t=Render.TIME;_wobble.x=Math.cos(_wobbleAngle+t*(75e-5*_this.wobbleSpeed))*(_wobbleAngle+200*Math.sin(t*(95e-5*_this.wobbleSpeed))),_wobble.y=Math.sin(Math.asin(Math.cos(_wobbleAngle+t*(85e-5*_this.wobbleSpeed))))*(150*Math.sin(_wobbleAngle+t*(75e-5*_this.wobbleSpeed))),_wobble.x*=2*Math.sin(_wobbleAngle+t*(75e-5*_this.wobbleSpeed)),_wobble.y*=1.75*Math.cos(_wobbleAngle+t*(65e-5*_this.wobbleSpeed)),_wobble.x*=1.1*Math.cos(_wobbleAngle+t*(75e-5*_this.wobbleSpeed)),_wobble.y*=1.15*Math.sin(_wobbleAngle+t*(25e-5*_this.wobbleSpeed)),_wobble.z=Math.sin(_wobbleAngle+.0025*_wobble.x)*(100*_this.wobbleZ),_wobble.multiplyScalar(.001*_this.wobbleStrength*_strength.v),_innerGroup.position.lerp(_wobble,.07)}}this.strength=1,this.moveXY=new Vector2(4,4),this.position=new function Position(){Inherit(this,Component);var _x=0,_y=0,_z=0;this.get("x",_=>_x),this.get("y",_=>_y),this.get("z",_=>_z),this.set("x",x=>{_x=x}),this.set("y",y=>{_y=y}),this.set("z",z=>{_z=z,_move.z=_z,_this.camera.position.copy(_move),_position.copy(_move)}),this.set=function(x,y,z){_x=x,_y=y,_z=z,_move.z=z,_this.camera.position.copy(_move),_position.copy(_move)},this.toArray=function(){return[_x,_y,_z]},this.fromArray=function(array){_x=array[0],_y=array[1],_z=array[2],_move.set(_x,_y,_z),_this.camera.position.copy(_move),_position.copy(_move)}},this.lerpSpeed=.04,this.lerpSpeed2=1,this.lookAt=new Vector3(0,0,0),this.deltaRotate=10,this.deltaLerp=1,this.wobbleSpeed=1,this.wobbleStrength=0,this.wobbleZ=1,_input&&(_this.prefix=_input.prefix,CameraUIL.add(_this,_group).setLabel("Camera")),Mobile.Accelerometer.capture(),_this.startRender(loop),_innerGroup.add(_this.camera),_this.group.add(_innerGroup),this.orbit=function(time=1e3,ease="easeInOutSine"){return tween(_strength,{v:1},time,ease)},this.still=function(time=300,ease="easeInOutSine"){return tween(_strength,{v:0},time,ease)}}));class Base3D{constructor(){this.position=new Vector3D,this.rotation=new Euler,this.quaternion=new Quaternion,this.scale=new Vector3D(1,1,1),this._parent=null,this.up=new Vector3(0,1,0),this.isObject3D=!0,this.children=[],this.childrenLength=0,this.modelViewMatrix=new Matrix4,this.normalMatrix=new Matrix3,this.matrix=new Matrix4,this.matrixWorld=new Matrix4,this.matrixAutoUpdate=!0,this.matrixWorldNeedsUpdate=!1,this.matrixDirty=!0,this.visible=!0,this.castShadow=!1,this.frustumCulled=!0,this._renderOrder=0,this.worldPos=new Vector3;const _this=this;this.quaternion.onChange(_=>{_this.matrixDirty=!0,_this.rotation.setFromQuaternion(_this.quaternion,void 0,!1)}),this.rotation.onChange(_=>{_this.matrixDirty=!0,_this.quaternion.setFromEuler(_this.rotation,!1)}),this.scale.onChange(_=>{_this.matrixDirty=!0}),this.position.onChange(_=>{_this.matrixDirty=!0})}get renderOrder(){return this._renderOrder}set renderOrder(value){this._renderOrder=value;let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent;for(let i=0;i<this.children.length;i++)this.children[i].renderOrder+=value}applyMatrix(matrix){return this.matrix.multiplyMatrices(matrix,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale),this}applyQuaternion(q){return this.quaternion.premultiply(q),this}setRotationFromAxisAngle(axis,angle){this.quaternion.setFromAxisAngle(axis,angle)}setRotationFromMatrix(m){this.quaternion.setFromRotationMatrix(m)}setRotationFromQuaternion(q){this.quaternion.copy(q)}localToWorld(v){return v.applyMatrix4(this.matrixWorld)}worldToLocal(v){let m1=this.M1||new Matrix4;this.M1=m1,v.applyMatrix4(m1.getInverse(this.matrixWorld))}lookAt(x,y,z){let m1=this.M1||new Matrix4;this.M1=m1;let v=this.V1||new Vector3;this.V1=v,x.isVector3?v.copy(x):v.set(x,y,z),this.isCamera?m1.lookAt(this.position,v,this.up):m1.lookAt(v,this.position,this.up),this.quaternion.setFromRotationMatrix(m1)}add(object){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.add(arguments[i]);return this}if(object===this)return this;if(object&&object.isObject3D?(null!==object._parent&&object._parent.remove(object),object._parent=this,this.children.push(object),this.childrenLength=this.children.length):console.error("Object is not instance of Object3D",object),this.isScene)this.displayNeedsUpdate=!0;else{let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent}return this}remove(object){if(arguments.length>1){for(let i=0;i<arguments.length;i++)this.remove(arguments[i]);return this}if(this.isScene)this.displayNeedsUpdate=!0;else{let p=this._parent;for(;p;)p instanceof Scene&&(p.displayNeedsUpdate=!0),p=p._parent}this.children.remove(object),this.childrenLength=this.children.length}getWorldPosition(target){let v=this.V1||new Vector3;return this.V1=v,target||(target=v),this.updateMatrixWorld(),target.setFromMatrixPosition(this.matrixWorld)}getWorldScale(target){let v=this.V1||new Vector3;this.V1=v;let v2=this.V12||new Vector3;this.V2=v2;let q=this.Q1||new Quaternion;return this.Q1=q,target||(target=v2),this.updateMatrixWorld(),this.matrixWorld.decompose(v,q,target),target}getWorldQuaternion(target){let v=this.V1||new Vector3;this.V1=v;let q=this.Q1||new Quaternion;return this.Q1=q,target||(target=q),this.updateMatrixWorld(),this.matrixWorld.decompose(v,target,v),target}traverse(callback){callback(this);let children=this.children;for(let i=0;i<children.length;i++)children[i].traverse(callback)}updateMatrix(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0}updateMatrixWorld(force){if(!force&&!this.determineVisible())return;(this.determineDirty()||force)&&!0===this.matrixAutoUpdate&&this.updateMatrix(),!0!==this.matrixWorldNeedsUpdate&&!0!==force||(null===this._parent||this.determineNoTransform()?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this._parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1),this.children.forEach(c=>c.updateMatrixWorld(force)),this.matrixDirty=!1}clone(recursive){(new this.constructor).copy(this,recursive)}copy(source,recursive){if(this.name=source.name,this.up.copy(source.up),this.position.copy(source.position),this.quaternion.copy(source.quaternion),this.scale.copy(source.scale),this.matrix.copy(source.matrix),this.matrixWorld.copy(source.matrixWorld),this.matrixAutoUpdate=source.matrixAutoUpdate,this.matrixWorldNeedsUpdate=source.matrixWorldNeedsUpdate,this.visible=source.visible,this.castShadow=source.castShadow,this.receiveShadow=source.receiveShadow,this.frustumCulled=source.frustumCulled,this.renderOrder=source.renderOrder,!0===recursive)for(let i=0;i<source.children.length;i++){let child=source.children[i];this.add(child.clone())}return this}render(){}determineVisible(){if(this.determineVisibleCacheTime>0&&Render.TIME-this.determineVisibleCacheTime<8)return this.determineVisibleCache;if(this.determineVisibleCacheTime=Render.TIME,!this.visible)return this.determineVisibleCache=!1,!1;let p=this._parent;for(;p;){if(!p.visible)return this.determineVisibleCache=!1,!1;p=p._parent}return this.determineVisibleCache=!0,!0}determineDirty(){let p=this._parent;for(;p;){if(p.matrixDirty)return!0;p=p._parent}return this.matrixDirty}determineNoTransform(){return this._parent?this._parent.determineNoTransform()&&this.matrix.isIdentity():this.matrix.isIdentity()}upload(){this.shader&&(this.shader.upload(this,this.geometry),this.shader.shadow&&this.shader.shadow.upload(this,this.geometry)),this.geometry&&this.geometry.upload(this,this.shader)}destroy(){this.geometry&&this.geometry.destroy&&this.geometry.destroy(this),this.shader&&this.shader.destroy&&this.shader.destroy(this),this.hitDestroy&&this.hitDestroy(),this._gl&&this._gl.ubo&&this._gl.ubo.destroy(),this._gl&&this._gl.vao&&this._gl.vao.destroy(),this._gl&&(this._gl=null),this._parent&&this._parent.remove(this),this.parent&&this.parent.__destroyChild&&this.parent.__destroyChild(this.__id)}}Class((function Renderer(_params={}){Inherit(this,Component);const _this=this;var _canvas,_gl,_width,_height,_anisotropy,_projScreenMatrix,_frustum,_ubo,_dpr=1,_resolution=new Vector2,_m0=new Matrix4,_m1=new Matrix4,_time={value:0};function initCameraUBO(camera){camera._ubo=new UBO(0,_gl),camera._ubo.push({value:camera.projectionMatrix}),camera._ubo.push({value:camera.matrixWorldInverse}),camera._ubo.push({value:camera.worldPos}),camera._ubo.push({value:_resolution}),camera._ubo.push(_time),camera._ubo.push(Render.timeScaleUniform),camera._ubo.upload()}function attachSceneUniforms(object,scene,camera){if(Shader.renderer.appendUniform(object.shader,"normalMatrix",object.normalMatrix),Shader.renderer.appendUniform(object.shader,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader,"modelViewMatrix",object.modelViewMatrix),_ubo?camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader,"projectionMatrix",camera.projectionMatrix),Shader.renderer.appendUniform(object.shader,"viewMatrix",camera.matrixWorldInverse),Shader.renderer.appendUniform(object.shader,"cameraPosition",camera.worldPos),Shader.renderer.appendUniform(object.shader,"resolution",_resolution),Shader.renderer.appendUniform(object.shader,"time",_time.value),Shader.renderer.appendUniform(object.shader,"timeScale",Render.timeScaleUniform.value)),_this.shadows&&object.shader.receiveShadow&&!_this.overridePreventShadows){let lights=Lighting.getShadowLights();object._gl||(object._gl={}),object._gl.shadowData||(object._gl.shadowData={combined:new Float32Array(16*lights.length)});for(let i=0;i<lights.length;i++){let light=lights[i];_m1.multiplyMatrices(light.shadow.camera.matrixWorldInverse,object.matrixWorld),_m0.multiplyMatrices(light.shadow.camera.projectionMatrix,_m1),_m0.toArray(object._gl.shadowData.combined,16*i)}scene._shadowData&&scene._shadowData.count&&(object.shader.uniforms.shadowMap.value=scene._shadowData[_this.overridePreventShadows?"emptyMaps":"maps"],Shader.renderer.appendUniform(object.shader,"shadowMatrix",object._gl.shadowData.combined,"matrix"),Shader.renderer.appendUniform(object.shader,"shadowLightPos",scene._shadowData.pos,"vec3"),Shader.renderer.appendUniform(object.shader,"shadowSize",scene._shadowData.size,"float"))}}function attachShadowUniforms(object,scene,light){light._mvm||(light._mvm=new Matrix4),light._nm||(light._nm=new Matrix3),light._mvm.multiplyMatrices(light.shadow.camera.matrixWorldInverse,object.matrixWorld),light._nm.getNormalMatrix(object.modelViewMatrix),Shader.renderer.appendUniform(object.shader.shadow,"normalMatrix",light._nm),Shader.renderer.appendUniform(object.shader.shadow,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader.shadow,"modelViewMatrix",light._mvm),_ubo?light.shadow.camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader.shadow,"projectionMatrix",light.shadow.camera.projectionMatrix),Shader.renderer.appendUniform(object.shader.shadow,"viewMatrix",light.shadow.camera.matrixWorldInverse))}function loop(t,dt){_time.value+=.001*dt}function render(scene,camera,rt){rt?(_resolution.set(rt.width,rt.height),RenderTarget.renderer.bind(rt)):(Renderer.overrideViewport||(_gl.viewport(0,0,_width*_dpr,_height*_dpr),_resolution.set(_canvas.width,_canvas.height)),_this.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))),camera.parent||camera.updateMatrixWorld(),camera.getWorldPosition(camera.worldPos),_frustum.setFromCamera(camera),_ubo&&(camera._ubo?camera._ubo.update():initCameraUBO(camera));for(let l=0;l<2;l++){let len=scene.toRender[l].length;for(let i=0;i<len;i++){let object=scene.toRender[l][i];object.onBeforeRender&&object.onBeforeRender(),object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&(!1!==object.frustumCulled&&!0!==_frustum.intersectsObject(object)||(object.shader.draw(object,object.geometry),attachSceneUniforms(object,scene,camera),object.geometry.draw(object,object.shader)))}}rt&&RenderTarget.renderer.unbind(rt)}this.autoClear=!0,this.shadows=Renderer.SHADOWS_MED,Renderer.instance=_this,Renderer.CLEAR=[0,0,0,1],function initContext(){let contextAttributes={antialias:void 0!==_params.antialias&&_params.antialias,powerPreference:_params.powerPreference,preserveDrawingBuffer:_params.preserveDrawingBuffer,xrCompatible:_params.xrCompatible,alpha:void 0!==_params.alpha&&_params.alpha};if(_canvas=_params.canvas||document.createElement("canvas"),_params.gl?(_gl=_params.gl,_this.type=Device.graphics.webgl.version.includes(["webgl 2","webgl2"])?Renderer.WEBGL2:Renderer.WEBGL1):Device.graphics.webgl?["webgl2","webgl","experimental-webgl"].forEach(name=>{_gl||"webgl2"==name&&_params.forceWebGL1||(_gl=_canvas.getContext(name,contextAttributes),_this.type=_gl&&"webgl2"==name?Renderer.WEBGL2:Renderer.WEBGL1)}):(_gl=new NoGLPolyfill,_this.type=Renderer.WEBGL2),!_gl)throw"Error! Could not create WebGL context";_this.domElement=_canvas,_canvas.style.background="black",Renderer.type=_this.type,Renderer.context=_this.context=_gl}(),function setExtensions(){_this.extensions={},_this.type!=Renderer.WEBGL2?(_this.extensions.VAO=_gl.getExtension("OES_vertex_array_object"),_this.extensions.instancedArrays=_gl.getExtension("ANGLE_instanced_arrays"),_this.extensions.standardDerivatives=_gl.getExtension("OES_standard_derivatives"),_this.extensions.depthTextures=_gl.getExtension("WEBGL_depth_texture"),_this.extensions.drawBuffers=_gl.getExtension("WEBGL_draw_buffers"),_this.extensions.halfFloat=_gl.getExtension("OES_texture_half_float"),_this.extensions.float=_gl.getExtension("OES_texture_float"),_this.extensions.colorBufferFloat=_gl.getExtension("WEBGL_color_buffer_float")):_this.extensions.colorBufferFloat=_gl.getExtension("EXT_color_buffer_float"),_this.extensions.filterFloat=_gl.getExtension("OES_texture_float_linear"),_this.extensions.anisotropy=_gl.getExtension("EXT_texture_filter_anisotropic")||_gl.getExtension("WEBKIT_EXT_texture_filter_anisotropic"),_this.extensions.astc=_gl.getExtension("WEBGL_compressed_texture_astc"),_this.extensions.atc=_gl.getExtension("WEBGL_compressed_texture_atc"),_this.extensions.etc=_gl.getExtension("WEBGL_compressed_texture_etc"),_this.extensions.etc1=_gl.getExtension("WEBGL_compressed_texture_etc1"),_this.extensions.pvrtc=_gl.getExtension("WEBGL_compressed_texture_pvrtc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc"),_this.extensions.s3tc=_gl.getExtension("WEBGL_compressed_texture_s3tc")||_gl.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc"),_this.extensions.s3tc_srgb=_gl.getExtension("WEBGL_compressed_texture_s3tc_srgb"),Renderer.extensions=_this.extensions}(),function initRenderers(){Geometry.renderer=new GeometryRendererWebGL(_gl),Texture.renderer=new TextureRendererWebGL(_gl),Shader.renderer=new ShaderRendererWebGL(_gl),RenderTarget.renderer=new FBORendererWebGL(_gl)}(),function initMath(){_projScreenMatrix=new Matrix4,new Vector3,_frustum=new Frustum}(),function initUBO(){_this.type==Renderer.WEBGL2&&(_ubo=!0),Renderer.UBO=_ubo}(),_this.startRender(loop),this.render=function(scene,camera,rt,forceToScreen){scene.displayNeedsUpdate&&(scene.toRender[0].length=0,scene.toRender[1].length=0),scene.updateMatrixWorld(),function projectObject(object,camera,scene){if(void 0!==object.shader){let visible=object.determineVisible()&&object.shader.visible&&!object.shader.neverRender;visible&&(object.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix)),(scene.displayNeedsUpdate||object.shader.transparent&&!scene.disableAutoSort&&visible)&&object.getWorldPosition(object.worldPos),scene.displayNeedsUpdate&&scene.toRender[object.shader.transparent?1:0].push(object)}if(!0===object.visible||scene.displayNeedsUpdate)for(let i=object.childrenLength-1;i>-1;i--)projectObject(object.children[i],camera,scene)}(scene,camera,scene),scene.displayNeedsUpdate&&function sortOpaque(array){for(let i=array.length-1;i>-1;i--){let obj=array[i];obj.shader._gl||obj.shader.upload()}array.sort((a,b)=>{if(a.renderOrder!==b.renderOrder)return a.renderOrder-b.renderOrder;let aid=a.shader._gl._id,bid=b.shader._gl._id;return aid!==bid?aid-bid:a.id-b.id})}(scene.toRender[0]),(scene.displayNeedsUpdate||scene.toRender[1].length&&!scene.disableAutoSort)&&function sortTransparent(array){RenderStats.update("SortTransparent",array.length),array.sort((a,b)=>a.renderOrder!==b.renderOrder?a.renderOrder-b.renderOrder:a.worldPos.z!==b.worldPos.z?a.worldPos.z-b.worldPos.z:a.id-b.id)}(scene.toRender[1]),_this.shadows&&!_this.overridePreventShadows&&!_this.pauseShadowRendering&&scene.hasShadowLight&&function renderShadows(scene,camera){let render=light=>{RenderTarget.renderer.bind(light.shadow.rt),RenderStats.update("ShadowLights"),light.shadow.camera.updateMatrixWorld(),camera.getWorldPosition(camera.worldPos),_frustum.setFromCamera(camera),_ubo&&(light.shadow.camera._ubo?light.shadow.camera._ubo.update():initCameraUBO(light.shadow.camera));for(let l=0;l<2;l++)for(let i=0;i<scene.toRender[l].length;i++){let object=scene.toRender[l][i];!0===object.castShadow&&object.determineVisible()&&object.shader.visible&&!object.shader.neverRender&&(!1!==object.frustumCulled&&!0!==_frustum.intersectsObject(object)||(object.shader.shadow||Lighting.initShadowShader(object),object.shader.shadow.draw(object,object.geometry),attachShadowUniforms(object,0,light),object.geometry.draw(object,object.shader),_ubo&&light.shadow.camera._ubo.unbind(),RenderStats.update("ShadowMesh")))}RenderTarget.renderer.unbind(light.shadow.rt)},lights=Lighting.getShadowLights();scene._shadowData||(scene._shadowData={maps:[],emptyMaps:[],size:new Float32Array(lights.length),pos:new Float32Array(3*lights.length),count:lights.length}),scene._shadowData.count!=lights.length&&(scene._shadowData.size=new Float32Array(lights.length),scene._shadowData.pos=new Float32Array(3*lights.length),scene._shadowData.count=lights.length);for(let i=0;i<lights.length;i++){let light=lights[i];light.prepareRender(),scene._shadowData.maps[i]=light.shadow.rt.depth,scene._shadowData.emptyMaps[i]=Utils3D.getEmptyTexture(),scene._shadowData.size[i]=light.shadow.size,light.position.toArray(scene._shadowData.pos,3*i)}for(let i=0;i<lights.length;i++){let light=lights[i];!light.shadow.frozen&&light.determineVisible()&&render(light)}}(scene,camera),rt||!_this.vrRenderingPath||forceToScreen?rt||!_this.arRenderingPath||forceToScreen?render(scene,camera,rt):_this.arRenderingPath(render,scene,camera):_this.vrRenderingPath(scene,camera,_projScreenMatrix,_frustum,attachSceneUniforms),scene.displayNeedsUpdate=!1,Shader.renderer.resetState()},this.renderSingle=function(object,camera,rt){rt?(_resolution.set(rt.width,rt.height),RenderTarget.renderer.bind(rt)):(Renderer.overrideViewport||(_gl.viewport(0,0,_width*_dpr,_height*_dpr),_resolution.set(_canvas.width,_canvas.height)),_this.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))),camera.getWorldPosition(camera.worldPos),object.modelViewMatrix.multiplyMatrices(camera.matrixWorldInverse,object.matrixWorld),object.normalMatrix.getNormalMatrix(object.modelViewMatrix),object.getWorldPosition(object.worldPos),_ubo&&(camera._ubo||initCameraUBO(camera)),object.shader.draw(object,object.geometry),object.noMatrices||(Shader.renderer.appendUniform(object.shader,"normalMatrix",object.normalMatrix),Shader.renderer.appendUniform(object.shader,"modelMatrix",object.matrixWorld),Shader.renderer.appendUniform(object.shader,"modelViewMatrix",object.modelViewMatrix)),_ubo?camera._ubo.bind(object.shader._gl.program,"global"):(Shader.renderer.appendUniform(object.shader,"projectionMatrix",camera.projectionMatrix),Shader.renderer.appendUniform(object.shader,"viewMatrix",camera.matrixWorldInverse),Shader.renderer.appendUniform(object.shader,"cameraPosition",camera.worldPos),Shader.renderer.appendUniform(object.shader,"resolution",_resolution),Shader.renderer.appendUniform(object.shader,"time",_time.value),Shader.renderer.appendUniform(object.shader,"timeScale",Render.timeScaleUniform.value)),object.geometry.draw(object,object.shader),_ubo&&camera._ubo.unbind(),rt&&RenderTarget.renderer.unbind(rt),Shader.renderer.resetState()},this.setClearColor=function(color,alpha=1){_this.clearColor=new Color(color),Renderer.CLEAR=[_this.clearColor.r,_this.clearColor.g,_this.clearColor.b,alpha]},this.setClearAlpha=function(alpha){Renderer.CLEAR[3]=alpha},this.getClearColor=function(){return _this.clearColor||(_this.clearColor=new Color(0,0,0)),_this.clearColor},this.getClearAlpha=function(){return Renderer.CLEAR[3]},this.setPixelRatio=function(dpr){_dpr=dpr,this.setSize(_width,_height)},this.setSize=function(width,height){_width=width,_height=height,_canvas.width=width*_dpr,_canvas.height=height*_dpr,_canvas.style.width=`${width}px`,_canvas.style.height=`${height}px`,_resolution.set(_canvas.width,_canvas.height)},this.getMaxAnisotropy=function(){return Device.graphics.webgl&&_this.extensions.anisotropy?(_anisotropy||(_anisotropy=_gl.getParameter(_this.extensions.anisotropy.MAX_TEXTURE_MAX_ANISOTROPY_EXT)),_anisotropy):0},this.readPixels=function(rt,x=0,y=0,width,height){width||(width=rt?rt.width:1),height||(height=rt?rt.height:1);let array=new Uint8Array((width-x)*(height-y)*4);return _gl.bindFramebuffer(_gl.FRAMEBUFFER,rt?rt._gl:null),_gl.readPixels(x,y,width,height,_gl.RGBA,_gl.UNSIGNED_BYTE,array),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),array},this.blit=function(input,output){return _this.type==Renderer.WEBGL2&&(input._gl||input.upload(),output._gl||output.upload(),_gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,input._gl),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,output._gl),_gl.blitFramebuffer(0,0,input.width,input.height,0,0,output.width,output.height,_gl.COLOR_BUFFER_BIT,_gl.NEAREST),_gl.bindFramebuffer(_gl.READ_FRAMEBUFFER,null),_gl.bindFramebuffer(_gl.DRAW_FRAMEBUFFER,null),!0)},this.get("resolution",_=>_resolution),this.get("time",_=>_time),this.get("canvas",_=>_canvas)}),_=>{Renderer.WEBGL1="webgl1",Renderer.WEBGL2="webgl2",Renderer.STATIC_SHADOWS="static_shadows",Renderer.SHADOWS_LOW="shadows_low",Renderer.SHADOWS_MED="shadows_med",Renderer.SHADOWS_HIGH="shadows_high",Renderer.ID=0});class CameraBase3D extends Base3D{constructor(){super(),this.matrixWorldInverse=new Matrix4,this.projectionMatrix=new Matrix4,this.isCamera=!0}copy(source,recursive){return Base3D.prototype.copy.call(this,source,recursive),this.matrixWorldInverse.copy(source.matrixWorldInverse),this.projectionMatrix.copy(source.projectionMatrix),this}updateMatrixWorld(force){Base3D.prototype.updateMatrixWorld.call(this,force),this.matrixWorldInverse.getInverse(this.matrixWorld)}clone(){return(new this.constructor).copy(this)}}class CubeCamera extends Base3D{constructor(near=.1,far=1e3,cubeResolution=512){super();this.px=new PerspectiveCamera(90,1,near,far),this.px.up.set(0,-1,0),this.px.lookAt(new Vector3(1,0,0)),this.add(this.px),this.nx=new PerspectiveCamera(90,1,near,far),this.nx.up.set(0,-1,0),this.nx.lookAt(new Vector3(-1,0,0)),this.add(this.nx),this.py=new PerspectiveCamera(90,1,near,far),this.py.up.set(0,0,1),this.py.lookAt(new Vector3(0,1,0)),this.add(this.py),this.ny=new PerspectiveCamera(90,1,near,far),this.ny.up.set(0,0,-1),this.ny.lookAt(new Vector3(0,-1,0)),this.add(this.ny),this.pz=new PerspectiveCamera(90,1,near,far),this.pz.up.set(0,-1,0),this.pz.lookAt(new Vector3(0,0,1)),this.add(this.pz),this.nz=new PerspectiveCamera(90,1,near,far),this.nz.up.set(0,-1,0),this.nz.lookAt(new Vector3(0,0,-1)),this.add(this.nz),this.rt=new CubeRenderTarget(cubeResolution,cubeResolution)}render(scene=World.SCENE,renderer=World.RENDERER){let rt=this.rt;rt.activeFace=0,renderer.render(scene,this.px,rt),this.afterRender&&this.afterRender(rt),rt.activeFace=1,renderer.render(scene,this.nx,rt),this.afterRender&&this.afterRender(rt),rt.activeFace=2,renderer.render(scene,this.py,rt),this.afterRender&&this.afterRender(rt),rt.activeFace=3,renderer.render(scene,this.ny,rt),this.afterRender&&this.afterRender(rt),rt.activeFace=4,renderer.render(scene,this.pz,rt),this.afterRender&&this.afterRender(rt),rt.activeFace=5,renderer.render(scene,this.nz,rt),this.afterRender&&this.afterRender(rt)}}class OrthographicCamera extends CameraBase3D{constructor(left,right,top,bottom,near,far){super(),this.isOrthographicCamera=!0,this.zoom=1,this.left=left,this.right=right,this.top=top,this.bottom=bottom,this.near=void 0!==near?near:.1,this.far=void 0!==far?far:2e3,this.position.z=1,this.updateProjectionMatrix()}clone(){return(new OrthographicCamera).copy(this)}copy(source,recursive){return CameraBase3D.prototype.copy.call(this,source,recursive),this.left=source.left,this.right=source.right,this.top=source.top,this.bottom=source.bottom,this.near=source.near,this.far=source.far,this.zoom=source.zoom,this.view=null===source.view?null:Object.assign({},source.view),this}updateProjectionMatrix(){let dx=(this.right-this.left)/(2*this.zoom),dy=(this.top-this.bottom)/(2*this.zoom),cx=(this.right+this.left)/2,cy=(this.top+this.bottom)/2,left=cx-dx,right=cx+dx,top=cy+dy,bottom=cy-dy;this.projectionMatrix.makeOrthographic(left,right,top,bottom,this.near,this.far)}setViewport(width,height){this.left=width/-2,this.right=width/2,this.top=height/2,this.bottom=height/-2,this.updateProjectionMatrix()}}class PerspectiveCamera extends CameraBase3D{constructor(fov,aspect,near,far){super(),this.type="PerspectiveCamera",this.fov=fov||50,this.zoom=1,this.near=near||.1,this.far=far||2e3,this.focus=10,this.aspect=aspect||1,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}clone(){return(new PerspectiveCamera).copy(this)}copy(source,recursive){return CameraBase3D.prototype.copy.call(this,source,recursive),this.fov=source.fov,this.zoom=source.zoom,this.near=source.near,this.far=source.far,this.focus=source.focus,this.aspect=source.aspect,this.filmGauge=source.filmGauge,this.filmOffset=source.filmOffset,this}setFocalLength(focalLength){let vExtentSlope=.5*this.getFilmHeight()/focalLength;this.fov=Math.degrees(2*Math.atan(vExtentSlope)),this.updateProjectionMatrix()}getFocalLength(){let vExtentSlope=Math.tan(Math.radians(.5*this.fov));return.5*this.getFilmHeight()/vExtentSlope}getEffectiveFOV(){return Math.degrees(2*Math.atan(Math.tan(Math.radians(.5*this.fov))/this.zoom))}getFilmWidth(){return this.filmGauge*Math.min(this.aspect,1)}getFilmHeight(){return this.filmGauge/Math.max(this.aspect,1)}updateProjectionMatrix(){let near=this.near,top=near*Math.tan(Math.radians(.5*this.fov))/this.zoom,height=2*top,width=this.aspect*height,left=-.5*width,skew=(this.view,this.filmOffset);0!==skew&&(left+=near*skew/this.getFilmWidth()),this.projectionMatrix.makePerspective(left,left+width,top,top-height,near,this.far)}}class Geometry{constructor(){this.attributes={},this.drawRange={start:0,end:0},this.boundingBox=null,this.boundingSphere=null,this.index=null,this.maxInstancedCount=void 0,this.keepAlive=!1,this.id=Utils.timestamp()}draw(mesh,shader){Geometry.renderer.draw(this,mesh,shader)}upload(mesh,shader){Geometry.renderer.upload(this,mesh,shader)}destroy(mesh){this.keepAlive||Geometry.renderer.destroy(this,mesh)}addAttribute(name,attribute){attribute.meshPerAttribute>=1&&(this.isInstanced=!0,this.maxInstancedCount=attribute.count),this.attributes[name]=attribute}setIndex(attribute){this.index=attribute.array||attribute}toNonIndexed(){let geometry2=new Geometry,indices=this.index,attributes=this.attributes;for(let name in attributes){let attribute=attributes[name],array=attribute.array,itemSize=attribute.itemSize,array2=new array.constructor(indices.length*itemSize),index=0,index2=0;for(let i=0,l=indices.length;i<l;i++){index=indices[i]*itemSize;for(let j=0;j<itemSize;j++)array2[index2++]=array[index++]}geometry2.addAttribute(name,new GeometryAttribute(array2,itemSize))}return geometry2}normalizeNormals(){let vector=this._V1||new Vector3;this._V1=vector;let x,y,z,normals=this.attributes.normal;for(let i=0,il=normals.count;i<il;i++)x=3*i+0,y=3*i+1,z=3*i+2,vector.x=normals.array[x],vector.y=normals.array[y],vector.z=normals.array[z],vector.normalize(),normals.array[x]=vector.x,normals.array[y]=vector.y,normals.array[z]=vector.z}computeFaceNormals(){let cb=new Vector3,ab=new Vector3;for(let f=0,fl=this.faces.length;f<fl;f++){let face=this.faces[f],vA=this.vertices[face.a],vB=this.vertices[face.b],vC=this.vertices[face.c];cb.subVectors(vC,vB),ab.subVectors(vA,vB),cb.cross(ab),cb.normalize(),face.normal.copy(cb)}}computeVertexNormals(){let index=this.index,attributes=this.attributes,groups=this.groups;if(attributes.position){let positions=attributes.position.array;if(void 0===attributes.normal)this.addAttribute("normal",new BufferAttribute(new Float32Array(positions.length),3));else{let array=attributes.normal.array;for(let i=0,il=array.length;i<il;i++)array[i]=0}let vA,vB,vC,normals=attributes.normal.array,pA=new Vector3,pB=new Vector3,pC=new Vector3,cb=new Vector3,ab=new Vector3;if(index){let indices=index.array;0===groups.length&&this.addGroup(0,indices.length);for(let j=0,jl=groups.length;j<jl;++j){let group=groups[j],start=group.start;for(let i=start,il=start+group.count;i<il;i+=3)vA=3*indices[i+0],vB=3*indices[i+1],vC=3*indices[i+2],pA.fromArray(positions,vA),pB.fromArray(positions,vB),pC.fromArray(positions,vC),cb.subVectors(pC,pB),ab.subVectors(pA,pB),cb.cross(ab),normals[vA]+=cb.x,normals[vA+1]+=cb.y,normals[vA+2]+=cb.z,normals[vB]+=cb.x,normals[vB+1]+=cb.y,normals[vB+2]+=cb.z,normals[vC]+=cb.x,normals[vC+1]+=cb.y,normals[vC+2]+=cb.z}}else for(let i=0,il=positions.length;i<il;i+=9)pA.fromArray(positions,i),pB.fromArray(positions,i+3),pC.fromArray(positions,i+6),cb.subVectors(pC,pB),ab.subVectors(pA,pB),cb.cross(ab),normals[i]=cb.x,normals[i+1]=cb.y,normals[i+2]=cb.z,normals[i+3]=cb.x,normals[i+4]=cb.y,normals[i+5]=cb.z,normals[i+6]=cb.x,normals[i+7]=cb.y,normals[i+8]=cb.z;this.normalizeNormals(),attributes.normal.needsUpdate=!0}}computeBoundingBox(){this.boundingBox||(this.boundingBox=new Box3);let position=this.attributes.position;position?this.boundingBox.setFromBufferAttribute(position):this.boundingBox.makeEmpty()}computeBoundingSphere(){let box=new Box3,vector=new Vector3;this.boundingSphere||(this.boundingSphere=new Sphere);let position=this.attributes.position;if(position){let center=this.boundingSphere.center;box.setFromBufferAttribute(position),box.getCenter(center);let maxRadiusSq=0;for(let i=0,il=position.count;i<il;i++)vector.x=position.array[3*i+0],vector.y=position.array[3*i+1],vector.z=position.array[3*i+2],maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(vector));this.boundingSphere.radius=Math.sqrt(maxRadiusSq),isNaN(this.boundingSphere.radius)&&console.error("Bounding Sphere came up NaN, broken position buffer.",this)}}merge(geometry){let Float32ArrayConcat=(first,second)=>{let firstLength=first.length,result=new Float32Array(firstLength+second.length);return result.set(first),result.set(second,firstLength),result},attributes=this.attributes;if(this.index){let indices=geometry.index,offset=attributes.position.count;for(let i=0,il=indices.length;i<il;i++)indices[i]=offset+indices[i];this.index=((first,second)=>{let firstLength=first.length,result=new Uint16Array(firstLength+second.length);return result.set(first),result.set(second,firstLength),result})(this.index,indices)}for(let key in attributes)void 0!==geometry.attributes[key]&&(attributes[key].array=Float32ArrayConcat(attributes[key].array,geometry.attributes[key].array),attributes[key].count=attributes[key].array.length/attributes[key].itemSize);return this}clone(noCopy){return(new Geometry).copy(this,noCopy)}copy(source,noCopy){this.index=null,this.attributes={},this.boundingBox=null,this.boundingSphere=null,this.index=source.index;let attributes=source.attributes;for(let name in attributes)this.addAttribute(name,attributes[name].clone(noCopy));let boundingBox=source.boundingBox;boundingBox&&boundingBox.clone&&(this.boundingBox=boundingBox.clone());let boundingSphere=source.boundingSphere;return boundingSphere&&boundingSphere.clone&&(this.boundingSphere=boundingSphere.clone()),this}center(){let offset=new Vector3;return this.computeBoundingBox(),this.boundingBox.getCenter(offset).negate(),this.applyMatrix((new Matrix4).makeTranslation(offset.x,offset.y,offset.z)),this}applyMatrix(matrix){let position=this.attributes.position;position&&(matrix.applyToBufferAttribute(position),position.needsUpdate=!0);let normal=this.attributes.normal;if(normal){(new Matrix3).getNormalMatrix(matrix).applyToBufferAttribute(normal),normal.needsUpdate=!0}return this.boundingBox&&this.computeBoundingBox(),this.boundingSphere&&this.computeBoundingSphere(),this}scale(x,y,z){this.applyMatrix((new Matrix4).makeScale(x,y,z))}setFromPoints(points){let position=[];for(let i=0,l=points.length;i<l;i++){let point=points[i];position.push(point.x,point.y,point.z||0)}return this.addAttribute("position",new GeometryAttribute(new Float32Array(position),3)),this}instanceFrom(geom){geom.index&&(geom=geom.toNonIndexed());for(let key in geom.attributes)this.addAttribute(key,geom.attributes[key]);return this}uploadBuffersAsync(){return Geometry.renderer.uploadBuffersAsync(this)}}class GeometryAttribute{constructor(_array,_itemSize,_meshPerAttribute){this.array=_array,this.itemSize=_itemSize,this.count=void 0!==_array?_array.length/_itemSize:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.meshPerAttribute=_meshPerAttribute}setArray(array){let newCount=void 0!==array?array.length/this.itemSize:0;newCount!=this.count&&(this.needsNewBuffer=!0),this.array=array,this.count=newCount,this.needsUpdate=!0}clone(noCopy){return noCopy?this:new GeometryAttribute(new Float32Array(this.array),this.itemSize,this.meshPerAttribute)}getX(index){return this.array[index*this.itemSize]}setX(index,x){return this.array[index*this.itemSize]=x,this}getY(index){return this.array[index*this.itemSize+1]}setY(index,y){return this.array[index*this.itemSize+1]=y,this}getZ(index){return this.array[index*this.itemSize+2]}setZ(index,z){return this.array[index*this.itemSize+2]=z,this}getW(index){return this.array[index*this.itemSize+3]}setW(index,w){return this.array[index*this.itemSize+3]=w,this}setXY(index,x,y){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this}setXYZ(index,x,y,z){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this.array[index+2]=z,this}setXYZW(index,x,y,z,w){return index*=this.itemSize,this.array[index+0]=x,this.array[index+1]=y,this.array[index+2]=z,this.array[index+3]=w,this}}class Group extends Base3D{constructor(){super(),this.isGroup=!0}}class BaseLight extends Base3D{constructor(color=16777215,intensity=1,distance=9999){super(),this.color=new Color(color),this.data=new Vector4,this.data2=new Vector4,this.data3=new Vector4,this.properties=new Vector4(intensity,distance,0,0)}destroy(){this.shadow&&(Lighting.removeFromShadowGroup(this),this.shadow.destroy())}prepareRender(){this.shadow.camera.position.copy(this.position),this.shadow.camera.lookAt(this.shadow.target)}set castShadow(bool){(this.shadow||bool)&&(this.shadow||(this.shadow=new Shadow(this)),this.shadow.enabled=bool,this.silentShadow||(bool?Lighting.addToShadowGroup(this):Lighting.removeFromShadowGroup(this)))}set intensity(v){this.properties.x=v}get intensity(){return this.properties.x}set distance(v){this.properties.y=v}get distance(){return this.properties.y}set bounce(v){this.properties.z=v}get bounce(){return this.properties.z}}class Line extends Base3D{constructor(geometry,shader){super(),this.geometry=geometry,this.shader=shader,this.isLine=!0,this.id=Renderer.ID++}clone(){return new Line(this.geometry,this.shader).copy(this)}}class Mesh extends Base3D{constructor(geometry,shader){super(),this._geometry=geometry,this._shader=shader&&shader.shader?shader.shader:shader,this.isMesh=!0,this.id=Utils.timestamp(),shader&&(this._shader.mesh=this)}clone(){return new Mesh(this._geometry,this.shader).copy(this)}set geometry(g){Geometry.renderer.resetMeshGeom(this),this._geometry=g}get geometry(){return this._geometry}set shader(shader){this._shader=shader&&shader.shader?shader.shader:shader}get shader(){return this._shader}}class Points extends Base3D{constructor(geometry,shader){super(),this._geometry=geometry,this.shader=shader,this.isPoints=!0,this.id=Renderer.ID++,shader&&(this.shader.mesh=this)}clone(){return new Points(this._geometry,this.shader).copy(this)}set geometry(g){Geometry.renderer.resetMeshGeom(this),this._geometry=g}get geometry(){return this._geometry}}class Scene extends Base3D{constructor(){super(),this.autoUpdate=!0,this.toRender=[[],[]],this._displayNeedsUpdate=!0,this.isScene=!0,this.changes=[]}set displayNeedsUpdate(v){!0===v&&this.changes.forEach(cb=>cb()),this._displayNeedsUpdate=v}get displayNeedsUpdate(){return this._displayNeedsUpdate}bindSceneChange(cb){this.changes.push(cb)}}Class((function FBORendererWebGL(_gl){const WEBGL2=Renderer.type==Renderer.WEBGL2,{getFormat:getFormat,getProperty:getProperty,getType:getType,getFloatParams:getFloatParams}=require("GLTypes");function prepareTexture(texture){texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_2D,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),texture.needsUpdate=!1}function texImageDB(rt,texture){if(texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),getType(texture),null);_gl.bindTexture(_gl.TEXTURE_2D,null)}this.upload=function(rt){if(!rt._gl){if(rt.cube)return function uploadCube(rt){rt._gl=_gl.createFramebuffer(),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl);let texture=rt.texture;texture._gl=_gl.createTexture(),texture.cube=!0,texture.needsUpdate=!1,_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);for(let i=0;i<6;i++)_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),_gl.UNSIGNED_BYTE,null);_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(_gl.TEXTURE_CUBE_MAP,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),rt._depthBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,rt.width,rt.height),_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,rt._depthBuffer),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}(rt);if(rt._gl=_gl.createFramebuffer(),rt.depth||rt.disableDepth||(rt._depthBuffer=_gl.createRenderbuffer(),_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,rt.width,rt.height)),RenderCount.add(`fbo_${rt.width}x${rt.height}`,rt),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.multi)if(WEBGL2){let colorAttachments=[];for(let i=0;i<rt.attachments.length;i++){let key="COLOR_ATTACHMENT"+i,texture=rt.attachments[i];colorAttachments.push(_gl[key]),prepareTexture(texture),texImageDB(rt,texture),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl[key],_gl.TEXTURE_2D,texture._gl,0)}_gl.drawBuffers(colorAttachments)}else{let ext=Renderer.extensions.drawBuffers,colorAttachments=[];for(let i=0;i<rt.attachments.length;i++){let key="COLOR_ATTACHMENT"+i+"_WEBGL",texture=rt.attachments[i];colorAttachments.push(ext[key]),prepareTexture(texture),texImageDB(rt,texture),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,ext[key],_gl.TEXTURE_2D,texture._gl,0)}ext.drawBuffersWEBGL(colorAttachments)}else{if(prepareTexture(rt.texture),rt.texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(rt.texture),rt.width,rt.height,0,getFormat(rt.texture),getType(rt.texture),null);_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_2D,rt.texture._gl,0)}if(rt.depth){prepareTexture(rt.depth);let iformat=WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT;_gl.texImage2D(_gl.TEXTURE_2D,0,iformat,rt.width,rt.height,0,_gl.DEPTH_COMPONENT,_gl.UNSIGNED_INT,null),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.TEXTURE_2D,rt.depth._gl,0)}else rt.disableDepth||_gl.framebufferRenderbuffer(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.RENDERBUFFER,rt._depthBuffer);_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}},this.bind=function(rt){rt._gl||this.upload(rt),_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.cube&&_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.COLOR_ATTACHMENT0,_gl.TEXTURE_CUBE_MAP_POSITIVE_X+rt.activeFace,rt.texture._gl,0),rt.scissor&&(_gl.enable(_gl.SCISSOR_TEST),_gl.scissor(rt.scissor.x,rt.scissor.y,rt.scissor.width,rt.scissor.height)),_gl.viewport(rt.viewport.x,rt.viewport.y,rt.width,rt.height),Renderer.instance.autoClear&&(_gl.clearColor(Renderer.CLEAR[0],Renderer.CLEAR[1],Renderer.CLEAR[2],Renderer.CLEAR[3]),_gl.clear(_gl.COLOR_BUFFER_BIT|_gl.DEPTH_BUFFER_BIT))},this.unbind=function(rt){rt.scissor&&_gl.disable(_gl.SCISSOR_TEST),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null)},this.resize=function(rt){if(rt.texture._gl&&rt._gl){if(_gl.bindFramebuffer(_gl.FRAMEBUFFER,rt._gl),rt.multi)for(let i=0;i<rt.attachments.length;i++){let texture=rt.attachments[i];if(_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(texture),rt.width,rt.height,0,getFormat(texture),getType(texture),null)}else if(_gl.bindTexture(_gl.TEXTURE_2D,rt.texture._gl),rt.texture.type.includes("float")){let{internalformat:internalformat,format:format,type:type}=getFloatParams(rt.texture);_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,rt.width,rt.height,0,format,type,null)}else _gl.texImage2D(_gl.TEXTURE_2D,0,getFormat(rt.texture),rt.width,rt.height,0,getFormat(rt.texture),getType(rt.texture),null);if(rt.depth){_gl.bindTexture(_gl.TEXTURE_2D,rt.depth._gl);let iformat=WEBGL2?_gl.DEPTH_COMPONENT24:_gl.DEPTH_COMPONENT;_gl.texImage2D(_gl.TEXTURE_2D,0,iformat,rt.width,rt.height,0,_gl.DEPTH_COMPONENT,_gl.UNSIGNED_INT,null),_gl.framebufferTexture2D(_gl.FRAMEBUFFER,_gl.DEPTH_ATTACHMENT,_gl.TEXTURE_2D,rt.depth._gl,0)}else rt.disableDepth||(_gl.bindRenderbuffer(_gl.RENDERBUFFER,rt._depthBuffer),_gl.renderbufferStorage(_gl.RENDERBUFFER,_gl.DEPTH_COMPONENT16,rt.width,rt.height));_gl.bindTexture(_gl.TEXTURE_2D,null),_gl.bindFramebuffer(_gl.FRAMEBUFFER,null),_gl.bindRenderbuffer(_gl.RENDERBUFFER,null)}},this.destroy=function(rt){_gl.deleteFramebuffer(rt._gl),rt._depthBuffer&&_gl.deleteRenderbuffer(rt._depthBuffer),Texture.renderer.destroy(rt.texture),RenderCount.remove(`fbo_${rt.width}x${rt.height}`),rt.multi&&rt.attachments.forEach(t=>Texture.renderer.destroy(t)),rt._gl=null}})),Class((function GeometryRendererWebGL(_gl){var _cache={};const WEBGL2=Renderer.type==Renderer.WEBGL2;function updateBuffer(attrib){if(!attrib._gl)return;attrib.needsUpdate=!1,_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),RenderStats.update("BufferUpdates");let array=attrib.array,updateRange=attrib.updateRange;if(-1===updateRange.count)attrib.needsNewBuffer?(_gl.bufferData(_gl.ARRAY_BUFFER,attrib.array,_gl.DYNAMIC_DRAW),attrib.needsNewBuffer=!1):_gl.bufferSubData(_gl.ARRAY_BUFFER,0,array);else if(Array.isArray(updateRange)){for(let i=updateRange.length-1;i>-1;i--){let{offset:offset,count:count}=updateRange[i];_gl.bufferSubData(_gl.ARRAY_BUFFER,offset*array.BYTES_PER_ELEMENT,array.subarray(offset,offset+count))}updateRange.length=0}else _gl.bufferSubData(_gl.ARRAY_BUFFER,updateRange.offset*array.BYTES_PER_ELEMENT,array.subarray(updateRange.offset,updateRange.offset+updateRange.count));_gl.bindBuffer(_gl.ARRAY_BUFFER,null)}this.draw=function(geom,mesh,shader){geom._gl&&!geom.needsUpdate&&mesh._gl&&mesh._gl.geomInit||this.upload(geom,mesh,shader),RenderStats.active&&RenderStats.update("DrawCalls",1,shader.vsName+"|"+shader.fsName,mesh);for(let key in geom.attributes){let attrib=geom.attributes[key];mesh._gl.program!=shader._gl.program?(mesh._gl[key]=_gl.getAttribLocation(shader._gl.program,key),mesh._gl.program=shader._gl.program):void 0===mesh._gl[key]&&(mesh._gl[key]=_gl.getAttribLocation(shader._gl.program,key)),-1!==mesh._gl[key]&&((attrib.needsUpdate||attrib.dynamic)&&updateBuffer(attrib))}geom.indexNeedsUpdate&&(_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,geom.index,_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,null),geom.indexNeedsUpdate=!1),mesh._gl.vao.bind();let mode=mesh._gl.mode;mode||(mesh._gl.mode=mode=function getMode(mesh,shader){return mesh.isPoints?_gl.POINTS:mesh.isLine?_gl.LINE_STRIP:shader.wireframe?_gl.LINES:_gl.TRIANGLES}(mesh,shader));let drawStart=geom.drawRange.start||0,drawEnd=geom.drawRange.end||geom.attributes.position.count;geom.isInstanced?WEBGL2?geom.index?_gl.drawElementsInstanced(mode,geom.index.length,_gl.UNSIGNED_SHORT,0,geom.maxInstancedCount):_gl.drawArraysInstanced(mode,drawStart,drawEnd,geom.maxInstancedCount):geom.index?Renderer.extensions.instancedArrays.drawElementsInstancedANGLE(mode,geom.index.length,_gl.UNSIGNED_SHORT,0,geom.maxInstancedCount):Renderer.extensions.instancedArrays.drawArraysInstancedANGLE(mode,0,drawEnd,geom.maxInstancedCount):geom.index?_gl.drawElements(mode,geom.index.length,_gl.UNSIGNED_SHORT,0):_gl.drawArrays(mode,drawStart,drawEnd),mesh._gl.vao.unbind()},this.upload=function(geom,mesh,shader){if(!mesh)return;geom._gl||(geom._gl={id:Utils.timestamp()}),mesh._gl||(mesh._gl={}),mesh._gl.geomInit=!0,geom._gl.uploaded=!0;const KEY=`${geom._gl.id}_${shader._gl._id}`;let cached=_cache[KEY];if(cached)return cached.count++,mesh._gl.vao=cached.vao,void(mesh._gl.lookup=KEY);RenderCount.add("geometry"),mesh._gl.vao&&mesh._gl.vao.destroy(),mesh._gl.vao=new VAO(_gl),geom.distributeBufferData||RenderCount.add("geom_upload",geom);for(let key in geom.attributes){let attrib=geom.attributes[key],location=mesh._gl[key]||_gl.getAttribLocation(shader._gl.program,key);mesh._gl[key]=location,attrib._gl||(attrib._gl={},attrib._gl.buffer=_gl.createBuffer(),attrib._gl.bufferUploaded=!geom.distributeBufferData,_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.bufferData(_gl.ARRAY_BUFFER,geom.distributeBufferData?attrib.array.length*attrib.array.BYTES_PER_ELEMENT:attrib.array,attrib.dynamic?_gl.DYNAMIC_DRAW:_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ARRAY_BUFFER,null),attrib.needsUpdate=!1)}geom.index&&(geom._gl.index||(geom._gl.index=_gl.createBuffer(),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),_gl.bufferData(_gl.ELEMENT_ARRAY_BUFFER,geom.index,_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,null))),mesh._gl.vao.bind();for(let key in geom.attributes){let attrib=geom.attributes[key],location=mesh._gl[key];-1!=location&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.vertexAttribPointer(location,attrib.itemSize,_gl.FLOAT,!1,0,0),_gl.enableVertexAttribArray(location),geom.isInstanced&&(WEBGL2?_gl.vertexAttribDivisor(location,attrib.meshPerAttribute):Renderer.extensions.instancedArrays.vertexAttribDivisorANGLE(location,attrib.meshPerAttribute)))}geom.index&&_gl.bindBuffer(_gl.ELEMENT_ARRAY_BUFFER,geom._gl.index),mesh._gl.vao.unbind(),_cache[KEY]={count:1,vao:mesh._gl.vao}},this.destroy=function(geom,mesh){for(let key in geom.attributes){let attrib=geom.attributes[key];attrib._gl&&(_gl.deleteBuffer(attrib._gl.buffer),attrib._gl=null)}if(mesh&&mesh._gl&&mesh._gl.vao){let cache=_cache[mesh._gl.lookup];cache?(cache.count--,0==cache.count&&(cache.vao.destroy(),delete _cache[mesh._gl.lookup])):mesh._gl.vao.destroy(),delete mesh._gl.vao}delete geom._gl},this.resetMeshGeom=function(mesh){mesh._gl&&(mesh._gl.geomInit=!1)},this.uploadBuffersAsync=async function(geom){if(geom._gl&&geom._gl.uploadedAsync)return;let upload=attrib=>{let array=attrib.array,buffer=attrib._gl.buffer,promise=Promise.create(),amt=4,match=!1;for(;!match;)amt--,array.length%amt==0&&(match=!0);let chunk=array.length/amt,i=0,worker=new Render.Worker((function uploadBuffersAsync(){let offset=i*chunk,subarray=array.subarray(offset,offset+chunk);if(!attrib._gl)return worker.stop(),promise.resolve();subarray.length&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,buffer),_gl.bufferSubData(_gl.ARRAY_BUFFER,offset*array.BYTES_PER_ELEMENT,subarray),_gl.bindBuffer(_gl.ARRAY_BUFFER,null)),++i==amt&&(promise.resolve(),worker.stop())}));return promise},uploaded=!1;for(let key in geom.attributes){let attrib=geom.attributes[key];attrib._gl||(geom.distributeBufferData=!0,attrib._gl={},attrib._gl.buffer=_gl.createBuffer(),attrib._gl.bufferUploaded=!geom.distributeBufferData,attrib.array.length&&(_gl.bindBuffer(_gl.ARRAY_BUFFER,attrib._gl.buffer),_gl.bufferData(_gl.ARRAY_BUFFER,attrib.array.length*attrib.array.BYTES_PER_ELEMENT,attrib.dynamic?_gl.DYNAMIC_DRAW:_gl.STATIC_DRAW),_gl.bindBuffer(_gl.ARRAY_BUFFER,null)),attrib.needsUpdate=!1,geom.needsUpdate=!0),attrib._gl.bufferUploaded||(attrib._gl.bufferUploaded=!0,uploaded=!0,await upload(attrib),attrib.needsUpdate=!1)}geom._gl.uploadedAsync=!0,uploaded&&RenderCount.add("geom_uploadAsync",geom)}})),Class((function ShaderRendererWebGL(_gl){var _pool={},_programID=0,_cached={},_uboCache={};const WEBGL2=Renderer.type==Renderer.WEBGL2,GLOBAL_UNIFORMS=["normalMatrix","modelMatrix","modelViewMatrix","projectionMatrix","viewMatrix","cameraPosition","resolution","time","shadowMatrix","shadowLightPos","shadowSize"];function toTypedArray(uni){uni.value;return uni._gl||(uni._gl={}),uni._gl.array&&uni._gl.array.length==uni.value.length?uni._gl.array.set(uni.value):uni._gl.array=new Float32Array(uni.value),uni._gl.array}function createShader(str,type){let shader=_gl.createShader(type);if(_gl.shaderSource(shader,str),_gl.compileShader(shader),Hydra.LOCAL&&!_gl.getShaderParameter(shader,_gl.COMPILE_STATUS)){let error=_gl.getShaderInfoLog(shader);_gl.deleteShader(shader);let split=str.split("\n"),errorString="";split.forEach((line,index)=>{index=function(){switch(index.toString().length){case 1:return"00"+index;case 2:return"0"+index}return index}(),errorString+=`${index}: ${line}\n`}),console.warn(error,errorString)}return shader}function setupShaders(shader){for(let key in shader.uniforms){let uniform=shader.uniforms[key];if(void 0===shader._gl[key]&&uniform)if(uniform.ubo)if(WEBGL2){if(_uboCache[shader.UILPrefix]&&!shader.ubo&&(shader.ubo=_uboCache[shader.UILPrefix]),_uboCache[shader.UILPrefix]){shader._gl[key]="U";continue}shader.ubo||(shader.ubo=new UBO(1,_gl)),shader.ubo.push(uniform),shader._gl[key]="U"}else shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key);else WEBGL2&&uniform.lightUBO?(shader._gl[key]="U",shader.uboLight=!0):shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key)}shader.ubo&&!_uboCache[shader.UILPrefix]&&(_uboCache[shader.UILPrefix]=shader.ubo),shader._gl.setupGlobals||(shader._gl.setupGlobals=!0,GLOBAL_UNIFORMS.forEach(key=>{shader._gl[key]=_gl.getUniformLocation(shader._gl.program,key)})),shader.uboLight&&_gl.getUniformBlockIndex(shader._gl.program,"lights"),WEBGL2&&_gl.getUniformBlockIndex(shader._gl.program,"global")}function uniformTextureArray(uni,uLoc,shader){let array=shader._gl.texArray||[];array.length=0,shader._gl.texArray=array;for(let i=0;i<uni.value.length;i++){array.push(shader._gl.texIndex);let texture=uni.value[i];!1===texture.loaded&&(texture=Utils3D.getEmptyTexture()),(void 0===texture._gl||texture.needsReupload)&&Texture.renderer.upload(texture),_gl.activeTexture(_gl[`TEXTURE${shader._gl.texIndex++}`]),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl)}_gl.uniform1iv(uLoc,array)}this.upload=function(shader){if(!shader._gl){shader._gl={};let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`,cached=_pool[key];cached?(shader._gl.program=cached.program,shader._gl._id=cached.id,cached.count++):(shader._gl.program=function createProgram(shader){let vsCode=shader.onBeforeCompile(shader.vertexShader,"vs"),fsCode=shader.onBeforeCompile(shader.fragmentShader,"fs");RenderCount.add("shader",shader);let vs=createShader(vsCode,_gl.VERTEX_SHADER),fs=createShader(fsCode,_gl.FRAGMENT_SHADER);Hydra.LOCAL&&window.GLSLLinter&&GLSLLinter.lint(shader,vsCode,fsCode);let program=_gl.createProgram();return _gl.attachShader(program,vs),_gl.attachShader(program,fs),_gl.linkProgram(program),Hydra.LOCAL&&(_gl.getProgramParameter(program,_gl.LINK_STATUS)||(console.warn(`Shader: ${shader.vsName} | ${shader.vsName}`),console.warn(vsCode),console.warn(fsCode),console.error(`Could not compile WebGL program. ${shader.vsName} ${shader.fsName} \n\n`+_gl.getProgramInfoLog(program)))),_gl.deleteShader(vs),_gl.deleteShader(fs),program}(shader),shader._gl._id=_programID++,_pool[key]={count:1,program:shader._gl.program,id:shader._gl._id})}setupShaders(shader),shader.ubo&&shader.ubo.upload(),shader.vertexShader=shader.fragmentShader=""},this.findCachedProgram=function(shader){let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`,cached=_pool[key];return!!cached&&(shader._gl={},shader._gl.program=cached.program,shader._gl._id=cached.id,_uboCache[shader.UILPrefix]&&(shader.ubo=shader.UILPrefix),cached.count++,!0)},this.draw=function(shader){void 0===shader._gl&&this.upload(shader),shader._gl.texIndex=0,shader._gl.program!=_cached.program&&(_gl.useProgram(shader._gl.program),_cached.program=shader._gl.program),shader.ubo&&shader.ubo.bind(shader._gl.program,"ubo"),shader.uboLight&&Lighting.bindUBO(shader._gl.program);for(let key in shader.uniforms){let uni=shader.uniforms[key];void 0===shader._gl[key]&&setupShaders(shader);let uLoc=shader._gl[key];if(uni&&(null===uni.value&&(uni.value=Utils3D.getEmptyTexture()),null!==uLoc&&-1!==uLoc&&"U"!==uLoc)){if(void 0===uni.value)throw`Uniform ${key} value is undefined. | ${shader.vsName} ${shader.fsName}`;switch(uni.type||(uni.type="string"==typeof(uniform=uni).type?uniform.type:null===uniform.value||uniform.value instanceof Texture||uniform.value.texture||uniform.value.rt&&uniform.value.rt.texture?"t":uniform.value instanceof Vector2?"v2":uniform.value instanceof Vector3?"v3":uniform.value instanceof Vector3D?"v3":uniform.value instanceof Vector4?"v4":uniform.value instanceof Matrix4?"m4":uniform.value instanceof Matrix3?"m3":uniform.value instanceof Color?"c":uniform.value instanceof Quaternion?"q":Array.isArray(uniform.value)&&uniform.value[0]instanceof Texture?"tv":"f"),uni.type){case"f":_gl.uniform1f(uLoc,uni.value);break;case"v2":_gl.uniform2f(uLoc,uni.value.x,uni.value.y);break;case"v3":_gl.uniform3f(uLoc,uni.value.x,uni.value.y,uni.value.z);break;case"c":_gl.uniform3f(uLoc,uni.value.r,uni.value.g,uni.value.b);break;case"q":case"v4":_gl.uniform4f(uLoc,uni.value.x,uni.value.y,uni.value.z,uni.value.w);break;case"v3v":_gl.uniform3fv(uLoc,toTypedArray(uni));break;case"v4v":_gl.uniform4fv(uLoc,toTypedArray(uni));break;case"v2v":_gl.uniform2fv(uLoc,toTypedArray(uni));break;case"fv":_gl.uniform1fv(uLoc,toTypedArray(uni));break;case"m4":_gl.uniformMatrix4fv(uLoc,!1,uni.value.elements);break;case"m3":_gl.uniformMatrix3fv(uLoc,!1,uni.value.elements);break;case"tv":uniformTextureArray(uni,uLoc,shader);break;case"t":let texture=uni.value;texture.isTexture||(uni.value.rt&&(texture=uni.value.rt.overrideTexture||uni.value.rt.texture),uni.value.texture&&(texture=uni.value.texture)),!1===texture.loaded&&(texture=Utils3D.getEmptyTexture());let texIndex=shader._gl.texIndex++;uni.value.vrRT&&(shader._gl.vrRT=!0,uni.value._glTexIndex=texIndex),Texture.renderer.draw(texture,uLoc,key,texIndex)}}}var uniform;if(shader.polygonOffset){let key=shader.polygonOffsetFactor+"_"+shader.polygonOffsetUnits;_cached.polygonOffset!=key&&(_gl.enable(_gl.POLYGON_OFFSET_FILL),_gl.polygonOffset(shader.polygonOffsetFactor,shader.polygonOffsetUnits)),_cached.polygonOffset=key}else _cached.polygonOffset&&_gl.disable(_gl.POLYGON_OFFSET_FILL),_cached.polygonOffset=!1;if(shader.transparent?(_cached.transparent||_gl.enable(_gl.BLEND),_cached.transparent=!0):(_cached.transparent&&_gl.disable(_gl.BLEND),_cached.transparent=!1),_cached.blending!=shader.blending){switch(shader.blending){case Shader.ADDITIVE_BLENDING:_gl.blendEquation(_gl.FUNC_ADD),_gl.blendFunc(_gl.SRC_ALPHA,_gl.ONE);break;default:_gl.blendEquationSeparate(_gl.FUNC_ADD,_gl.FUNC_ADD),_gl.blendFuncSeparate(_gl.SRC_ALPHA,_gl.ONE_MINUS_SRC_ALPHA,_gl.ONE,_gl.ONE_MINUS_SRC_ALPHA)}_cached.blending=shader.blending}switch(shader.depthTest?(_cached.depthTest||_gl.enable(_gl.DEPTH_TEST),_cached.depthTest=!0):(_cached.depthTest&&_gl.disable(_gl.DEPTH_TEST),_cached.depthTest=!1),shader.side){case Shader.BACK_SIDE:_cached.side!=Shader.BACK_SIDE&&(_gl.enable(_gl.CULL_FACE),_gl.cullFace(_gl.FRONT),_cached.side=Shader.BACK_SIDE);break;case Shader.DOUBLE_SIDE:_cached.side!=Shader.DOUBLE_SIDE&&(_gl.disable(_gl.CULL_FACE),_cached.side=Shader.DOUBLE_SIDE);break;default:_cached.side!=Shader.FRONT_SIDE&&(_gl.enable(_gl.CULL_FACE),_gl.cullFace(_gl.BACK),_cached.side=Shader.FRONT_SIDE)}switch(_cached.depthMask!=shader.depthWrite&&(_gl.depthMask(!!shader.depthWrite),_cached.depthMask=shader.depthWrite),shader.colorMask){case Shader.COLOR_MASK_NONE:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!0,!0,!0,!0),_cached.colorMask=shader.colorMask);break;case Shader.COLOR_MASK_RGB:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!1,!1,!1,!0),_cached.colorMask=shader.colorMask);break;case Shader.COLOR_MASK_RGBA:_cached.colorMask!=shader.colorMask&&(_gl.colorMask(!1,!1,!1,!1),_cached.colorMask=shader.colorMask)}},this.destroy=function(shader){delete shader._gl,shader.ubo&&shader.ubo.destroy();let key=`${shader.vsName}_${shader.fsName}_${shader.customCompile}`;_pool[key]},this.appendUniform=function(shader,key,value,hint){let loc=shader._gl[key];if(void 0===loc&&(loc=loc=_gl.getUniformLocation(shader._gl.program,key)),null!==loc)if(value.isMatrix4)_gl.uniformMatrix4fv(loc,!1,value.elements);else if(value.isMatrix3)_gl.uniformMatrix3fv(loc,!1,value.elements);else if(value.isVector3)_gl.uniform3f(loc,value.x,value.y,value.z);else if(value.isVector2)_gl.uniform2f(loc,value.x,value.y);else if(value instanceof Float32Array)switch(hint){case"matrix":_gl.uniformMatrix4fv(loc,!1,value);break;case"float":_gl.uniform1fv(loc,value);break;case"vec3":_gl.uniform3fv(loc,value)}else if(Array.isArray(value)){let array=shader._gl.texArray||[];array.length=0,shader._gl.texArray=array;for(let i=0;i<value.length;i++)array.push(shader._gl.texIndex),_gl.activeTexture(_gl[`TEXTURE${shader._gl.texIndex++}`]),_gl.bindTexture(_gl.TEXTURE_2D,value[i]._gl);_gl.uniform1iv(loc,array)}else _gl.uniform1f(loc,value)},this.resetState=function(){_cached.depthMask||(_gl.depthMask(!0),_cached.depthMask=!0),_cached.depthTest||_gl.enable(_gl.DEPTH_TEST),_cached.depthTest=!0,_cached.colorMask!=Shader.COLOR_MASK_NONE&&(_gl.colorMask(!0,!0,!0,!0),_cached.colorMask=Shader.COLOR_MASK_NONE),_cached.program=null},this.clearState=function(){_cached={}}})),Class((function TextureRendererWebGL(_gl){const _this=this;var _state={};const DATA=new Uint8Array([0,0,0,0]),{getFormat:getFormat,getProperty:getProperty,getType:getType,getFloatParams:getFloatParams}=require("GLTypes");function setTextureParams(texture,textureType=_gl.TEXTURE_2D){let format=getFormat(texture);textureType!=_gl.TEXTURE_2D||texture.compressed||_gl.texImage2D(textureType,0,format,1,1,0,format,_gl.UNSIGNED_BYTE,DATA),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_S,getProperty(texture.wrapS)),_gl.texParameteri(textureType,_gl.TEXTURE_WRAP_T,getProperty(texture.wrapT)),_gl.texParameteri(textureType,_gl.TEXTURE_MAG_FILTER,getProperty(texture.magFilter)),_gl.texParameteri(textureType,_gl.TEXTURE_MIN_FILTER,getProperty(texture.minFilter)),texture.data||texture.format!=Texture.RGBAFormat?1==_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):!1===texture.premultiplyAlpha?(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_state.premultiply=!0),texture.anisotropy>1&&_gl.texParameterf(_gl.TEXTURE_2D,Renderer.extensions.anisotropy.TEXTURE_MAX_ANISOTROPY_EXT,texture.anisotropy)}this.draw=function(texture,loc,key,id){if((void 0===texture._gl||texture.needsReupload)&&this.upload(texture),_gl.activeTexture(_gl[`TEXTURE${id}`]),texture.cube)_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl);else{let texType=texture.EXT_OES?_gl.TEXTURE_EXTERNAL_OES:_gl.TEXTURE_2D;_gl.bindTexture(texType,texture._gl)}_gl.uniform1i(loc,id),(texture.dynamic||texture.needsUpdate)&&function updateDynamic(texture){if(texture.isDataTexture){if(!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1),!texture.glFormat){let{format:format,type:type}=getFloatParams(texture);texture.glFormat=format,texture.glType=type}_gl.texSubImage2D(_gl.TEXTURE_2D,0,0,0,texture.width,texture.height,texture.glFormat,texture.glType,texture.data)}else _state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),texture.format==Texture.RGBAFormat?!1===texture.premultiplyAlpha?(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1):(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0),_state.premultiply=!0):_state.premultiply&&(_gl.pixelStorei(_gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1),_state.premultiply=!1),texture.glFormat||(texture.glFormat=getFormat(texture)),_gl.texImage2D(_gl.TEXTURE_2D,0,texture.glFormat,texture.glFormat,getType(texture),texture.image)}(texture),texture.needsUpdate=!1},this.upload=function(texture){if(texture._gl&&!texture.needsReupload&&!texture.needsUpdate)return;let format=getFormat(texture);if(RenderCount.add("texture"),texture.distributeTextureData||RenderCount.add("tex_upload",texture),texture.cube){if(6!=texture.cube.length)throw"Cube texture requires 6 images";return function uploadCube(texture){void 0===texture._gl&&(texture._gl=_gl.createTexture(),_gl.bindTexture(_gl.TEXTURE_CUBE_MAP,texture._gl),_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),setTextureParams(texture,_gl.TEXTURE_CUBE_MAP));let format=getFormat(texture);for(let i=0;i<6;i++)_gl.texImage2D(_gl.TEXTURE_CUBE_MAP_POSITIVE_X+i,0,format,format,getType(texture),texture.cube[i]);_gl.generateMipmap(_gl.TEXTURE_CUBE_MAP),texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()}(texture)}let texType=texture.EXT_OES?_gl.TEXTURE_EXTERNAL_OES:_gl.TEXTURE_2D;if(void 0===texture._gl?(texture._gl=_gl.createTexture(),_gl.bindTexture(texType,texture._gl),setTextureParams(texture,texType)):_gl.bindTexture(texType,texture._gl),texture.isDataTexture||texture.type&&texture.type.includes("float")){!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_gl.pixelStorei(_gl.UNPACK_ALIGNMENT,1);let{internalformat:internalformat,format:format,type:type}=getFloatParams(texture);if("ie"===Device.system.browser)try{_gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,texture.width,texture.height,0,format,type,texture.distributeTextureData?null:texture.data)}catch(e){console.log(e)}else _gl.texImage2D(_gl.TEXTURE_2D,0,internalformat,texture.width,texture.height,0,format,type,texture.distributeTextureData?null:texture.data)}else if(_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0),texture.image&&texture.compressed){let data=texture.image.compressedData;for(let i=0;i<data.length;i++){let size=texture.image.sizes[i];_gl.compressedTexImage2D(_gl.TEXTURE_2D,i,texture.image.gliFormat,size,size,0,data[i])}data.length=0}else if(texture.image&&!(texture.image instanceof HTMLVideoElement))try{_gl.texImage2D(_gl.TEXTURE_2D,0,format,format,getType(texture),texture.image)}catch(e){console.log("error loading texture",e,texture.image)}(texture.image||texture.data)&&texture.generateMipmaps&&!texture.compressed&&_gl.generateMipmap(_gl.TEXTURE_2D),texture.needsUpdate=texture.needsReupload=!1,texture.onUpdate&&texture.onUpdate()},this.uploadAsync=function(texture){let{format:format,type:type}=getFloatParams(texture);if(texture._uploadAsyncPromise)return texture._uploadAsyncPromise;texture._uploadAsyncPromise=Promise.create(),RenderCount.add("tex_uploadAsync",texture),texture._gl||(texture.distributeTextureData=!0,_this.upload(texture));let pixelsPerChunk=texture.height/4,dataPerChunk=texture.data.length/4,i=0,worker=new Render.Worker((function workerUploadAsync(){let pixelOffset=pixelsPerChunk*i,dataOffset=dataPerChunk*i,subarray=texture.data.subarray(dataOffset,dataOffset+dataPerChunk);!0===texture.flipY?_state.flipY||(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!0),_state.flipY=!0):_state.flipY&&(_gl.pixelStorei(_gl.UNPACK_FLIP_Y_WEBGL,!1),_state.flipY=!1),_gl.bindTexture(_gl.TEXTURE_2D,texture._gl),_gl.texSubImage2D(_gl.TEXTURE_2D,0,0,pixelOffset,texture.width,pixelsPerChunk,format,type,subarray),_gl.bindTexture(_gl.TEXTURE_2D,null),4==++i&&(worker.stop(),texture._uploadAsyncPromise.resolve())}));return texture._uploadAsyncPromise},this.destroy=function(texture){texture._gl&&(_gl.deleteTexture(texture._gl),RenderCount.remove("texture"),RenderCount.add("tex_destroy",texture)),delete texture._gl}}));class RenderTarget{constructor(width,height,options={}){this.width=width,this.height=height,this.viewport=new Vector2(0,0),void 0===options.minFilter&&(options.minFilter=Texture.LINEAR),this.texture=new Texture(null),this.texture.generateMipmaps=options.generateMipmaps,this.texture.width=width,this.texture.height=height,this.texture.minFilter=options.minFilter||Texture.LINEAR,this.texture.magFilter=options.magFilter||Texture.LINEAR,this.texture.wrapS=options.wrapS||Texture.CLAMP_TO_EDGE,this.texture.wrapT=options.wrapT||Texture.CLAMP_TO_EDGE,this.texture.format=options.format||Texture.RGBFormat,options.type&&(this.texture.type=options.type),this.isRT=!0}setSize(width,height){this.width=width,this.height=height,this.texture.width=width,this.texture.height=height,this.viewport.set(0,0),RenderTarget.renderer.resize(this)}clone(){return(new RenderTarget).copy(this)}copy(source){return this.width=source.width,this.height=source.height,this.viewport.copy(source.viewport),this.texture=source.texture.clone(),this}createDepthTexture(){return this.depth=new Texture(null),this.depth.generateMipmaps=!1,this.depth.minFilter=Texture.NEAREST,this.depth.magFilter=Texture.NEAREST,this.depth.wrapS=Texture.CLAMP_TO_EDGE,this.depth.wrapT=Texture.CLAMP_TO_EDGE,this.depth}destroy(){RenderTarget.renderer.destroy(this)}upload(){this._gl||RenderTarget.renderer.upload(this)}}class MultiRenderTarget extends RenderTarget{constructor(width,height,options={}){super(width,height,options),this.multi=!0,this.attachments=[this.texture]}}class CubeRenderTarget extends RenderTarget{constructor(width,height,options={}){super(width,height,options),this.activeFace=0,this.cube=!0}}Class((function Shader(_vertexShader,_fragmentShader,_params,_onBeforeBuild,_postfix){const _this=this;this.uniforms={},this.side=Shader.FRONT_SIDE,this.blending=Shader.NORMAL_BLENDING,this.colorMask=Shader.COLOR_MASK_NONE,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=1,this.depthTest=!0,this.depthWrite=!0,this.wireframe=!1,this.transparent=!1,this.visible=!0,this.persists=!1,this.precision="high",this.customCompile="","string"!=typeof _fragmentShader&&(_params=_fragmentShader,_fragmentShader=_vertexShader),_params=_params||{},_this.vsParam=_vertexShader,_this.fsParam=_fragmentShader,_this.params=_params,_this.vsName=_vertexShader,_this.fsName=(_fragmentShader||_vertexShader)+(_postfix||""),_params.vsName&&(_this.vsName=_params.vsName,delete _params.vsName),_params.precision&&(_this.precision=_params.precision),_params.receiveShadow&&(_this.receiveLight=!0,World.RENDERER.shadows&&(_this.precision="high"));let vs=_vertexShader,fs=_fragmentShader;_params.uilFrom&&(vs=_params.uilFrom,fs=_params.uilFrom,delete _params.uilFrom),_this.UILPrefix=_params.UILPrefix||`${vs}/${fs}/${_params.unique?_params.unique+"/":""}`,Shader.parseParams(_params,_this),Shader.renderer.findCachedProgram(_this)||(_this.vertexShader=Shader.process(Shaders.getShader(_vertexShader+".vs"),"vs",_this,_onBeforeBuild),_this.fragmentShader=Shader.process(Shaders.getShader(_fragmentShader+".fs"),"fs",_this,_onBeforeBuild))}),_=>{Shader.FRONT_SIDE="shader_front_side",Shader.BACK_SIDE="shader_back_side",Shader.DOUBLE_SIDE="shader_double_side",Shader.ADDITIVE_BLENDING="shader_additive_blending",Shader.NORMAL_BLENDING="shader_normal_blending",Shader.CUSTOM_DEPTH="shader_custom_depth",Shader.COLOR_MASK_RGB="shader_colormask_rgb",Shader.COLOR_MASK_RGBA="shader_colormask_rgba",Shader.COLOR_MASK_NONE="shader_colormask_none",Shader.parseParams=function(_params,_this){for(let key in _params)if("receiveShadow"==key)_this.receiveShadow=_params[key];else if("receiveLight"==key)_this.receiveLight=_params[key];else if(_params[key]&&void 0!==_params[key].value)window.UILStorage?(_this.uniforms[key]=UILStorage.parse(_this.UILPrefix+key,_params[key].value)||_params[key],_params[key].ubo&&(_this.uniforms[key].ubo=!0)):_this.uniforms[key]=_params[key];else{if("unique"==key)continue;_this[key]=_params[key]}},Shader.process=function(code,type,_this,_onBeforeBuild){const WEBGL2=Renderer.type==Renderer.WEBGL2;if(!code)throw"No shader found! "+_this.vsName+" | "+_this.fsName;const externalOES=code.includes("samplerOES")&&window.AURA&&"android"==Device.system.os,standardDeriv=!WEBGL2&&code.includes(["fwidth","dFdx"]),drawBuffers=!WEBGL2&&code.includes(["gl_FragData","#drawbuffer"])&&window.World&&World.NUKE.useDrawBuffers;return header="vs"==type?["#version 300 es",`precision ${_this.precision}p float;`,`precision ${_this.precision}p int;`,"attribute vec2 uv;","attribute vec3 position;","attribute vec3 normal;","uniform mat3 normalMatrix;","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform global {","mat4 projectionMatrix;","mat4 viewMatrix;","vec3 cameraPosition;","vec2 resolution;","float time;","float timeScale;","};"].join("\n"):["#version 300 es",externalOES?"#extension GL_OES_EGL_image_external_essl3 : require":"",standardDeriv?"#extension GL_OES_standard_derivatives : enable":"",drawBuffers?"#extension GL_EXT_draw_buffers : require":"",`precision ${_this.precision}p float;`,`precision ${_this.precision}p int;`,"uniform mat3 normalMatrix;","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform global {","mat4 projectionMatrix;","mat4 viewMatrix;","vec3 cameraPosition;","vec2 resolution;","float time;","float timeScale;","};","out vec4 FragColor;"].join("\n"),header+="\n__ACTIVE_THEORY_LIGHTS__\n\n",window.AURA&&(header+="#define AURA\n"),_onBeforeBuild&&(code=_onBeforeBuild(code,type)),code=header+code};const prototype=Shader.prototype;var _emptyShadowMap;prototype.copyUniformsTo=function(shader,linked){if(linked)shader.uniforms=this.uniforms;else for(let key in this.uniforms)shader.uniforms[key]={type:this.uniforms[key].type,value:this.uniforms[key].value}},prototype.addUniforms=function(uniforms){uniforms.UILPrefix&&(this.UILPrefix=uniforms.UILPrefix,delete uniforms.UILPrefix);for(let key in uniforms)this.uniforms[key]=uniforms[key]},prototype.draw=function(mesh,geom){this.receiveLight&&!this.__lighting&&Lighting.getLighting(this),Shader.renderer.draw(this,mesh,geom)},prototype.upload=function(mesh,geom){let p=this.mesh,scene=World.SCENE;for(;p;)p instanceof Scene&&(scene=p),p=p._parent;scene.nuke&&scene.nuke.onBeforeShaderCompile(this.mesh),Shader.renderer.upload(this,mesh,geom),this.receiveShadow&&!this.shadow&&Lighting.initShadowShader(this,mesh)},prototype.destroy=function(){this.persists||(Shader.renderer.destroy(this),this.shadow&&this.shadow.destroy()),this.receiveLight&&Lighting.destroyShader(this)},prototype.onBeforeCompile=function(code,type){const WEBGL2=Renderer.type==Renderer.WEBGL2;this.receiveShadow&&(this.receiveLight=!0);let replace,varyings=[];(code=code.split("\n")).forEach((line,index)=>{"fs"==type&&line.includes("#drawbuffer")&&(line.includes("#drawbuffer Color")?code[index]=line.replace("#drawbuffer Color",""):code[index]=""),line.includes("varying")&&varyings.push(line)}),code=code.join("\n"),varyings.length&&varyings.forEach(varying=>{let count=0;varyings.forEach(v2=>{varying==v2&&count++}),count>1&&(replace||(replace=[]),replace.includes(varying)||replace.push(varying))}),replace&&replace.forEach(varying=>{let index=code.lastIndexOf(varying);code=code.substring(0,index)+code.substring(index+varying.length)}),"fs"==type&&(WEBGL2?code.includes("gl_FragColor")&&(code=code.replace(/gl_FragColor/g,"FragColor")):code.includes("#applyShadow")&&(code=code.replace("#applyShadow",""))),code=code.replace("__ACTIVE_THEORY_LIGHTS__",function getLightingCode(_this){if(!_this.receiveLight||_this.isShadow)return"";let numLights=Lighting.getLighting(_this).position.length/4;return 0==numLights?Lighting.getShadowUniforms(_this):[`#define NUM_LIGHTS ${numLights}`,"uniform lights {",`vec4 lightPos[${numLights}];`,`vec4 lightColor[${numLights}];`,`vec4 lightData[${numLights}];`,`vec4 lightData2[${numLights}];`,`vec4 lightData3[${numLights}];`,`vec4 lightProperties[${numLights}];`,"};"].join("\n")+Lighting.getShadowUniforms(_this)}(this)),"fs"==type&&code.includes("SHADOW_MAPS")&&(code=require("GLSLOptimizer")(code.replace("SHADOW_COUNT",Lighting.getShadowCount(this)))),this.preCompile&&(code=this.preCompile(code,type));let converter=require("ShaderCode");return code=WEBGL2?converter.convertWebGL2(code,type):converter.convertWebGL1(code)},prototype.set=function(key,value,ref){let _this=ref||this;return _this.uniforms[key]?(void 0!==value&&(TweenManager.clearTween(_this.uniforms[key]),_this.uniforms[key].value=value,_this.ubo&&(_this.ubo.needsUpdate=!0)),_this.uniforms[key].value):console.warn(`No key ${key} found on shader`,_this)},prototype.get=function(key,ref){return(ref||this).uniforms[key].value},prototype.tween=function(key,value,time,ease,delay,callback,update,scaledTime){return"number"==typeof value?tween(this.uniforms[key],{value:value},time,ease,delay,callback,update,null,scaledTime):tween(this.uniforms[key].value,value,time,ease,delay,callback,update,null,scaledTime)},prototype.clone=function(noShadows,postfix){const _this=this;noShadows&&(_this.params.receiveShadow=!1);let shader=new Shader(_this.vsParam,_this.fsParam,_this.params,null,postfix);for(let key in _this)key.includes(["vsName","fsName","uniforms"])||"function"==typeof _this[key]||(shader[key]=_this[key]);for(let key in _this.uniforms)shader.uniforms[key]={type:_this.uniforms[key].type,value:_this.uniforms[key].value};return shader},prototype.resetProgram=function(){this.destroy(),this.vertexShader=Shader.process(Shaders.getShader(this.vsName+".vs"),"vs",this),this.fragmentShader=Shader.process(Shaders.getShader(this.fsName+".fs"),"fs",this)},Object.defineProperty(prototype,"receiveShadow",{set:function(v){this._receiveShadow=v,v&&(_emptyShadowMap||(_emptyShadowMap=[Utils3D.getEmptyTexture()]),this.uniforms.shadowMap={value:_emptyShadowMap})},get:function(){return this._receiveShadow}})});class Texture{constructor(img){this.magFilter=Texture.LINEAR,this.minFilter=Texture.LINEAR_MIPMAP,this.format=Texture.RGBAFormat,this.wrapS=this.wrapT=Texture.CLAMP_TO_EDGE,this._image=img,this.needsUpdate=!0,this.generateMipmaps=!0,this.anisotropy=1,this.type=Texture.UNSIGNED_BYTE,this.isTexture=!0,img&&img.onCreateTexture&&img.onCreateTexture(this)}set image(img){this._image=img,img&&img.onCreateTexture&&img.onCreateTexture(this)}get image(){return this._image}upload(){this._gl||Texture.renderer.upload(this)}destroy(){Texture.renderer.destroy(this),this._image=null}clone(){let texture=new Texture(this.img);return texture.format=this.format,texture.type=this.type,texture.anisotropy=this.anisotropy,texture.wrapS=this.wrapS,texture.wrapT=this.wrapT,texture.generateMipmaps=this.generateMipmaps,texture.minFilter=this.minFilter,texture.magFilter=this.magFilter,texture}}class DataTexture extends Texture{constructor(data,width,height,format,type){super(),format&&(this.format=format),this.width=width,this.height=height,this.data=data,this.minFilter=this.magFilter=Texture.NEAREST,this.generateMipmaps=!1,this.type=type||Texture.FLOAT,this.isDataTexture=!0}uploadAsync(){return Texture.renderer.uploadAsync(this)}}Texture.NEAREST="texture_nearest",Texture.CLAMP_TO_EDGE="texture_clamp",Texture.REPEAT="texture_repeat",Texture.MIRROR_REPEAT="texture_mirror_repeat",Texture.LINEAR="texture_linear",Texture.LINEAR_MIPMAP="texture_linear_mip",Texture.LINEAR_MIPMAP_NEAREST="texture_linear_mip_nearest",Texture.NEAREST_MIPMAP="texture_nearest_mip",Texture.RGBFormat="texture_rgbFormat",Texture.RGBAFormat="texture_rgbaFormat",Texture.UNSIGNED_BYTE="texture_unsigned_byte",Texture.DEPTH="texture_depth",Texture.FLOAT="texture_float",Texture.HALF_FLOAT="texture_half_float",Module((function GLSLOptimizer(){this.exports=function(code){return function unrollLoops(string){return string.replace(/#pragma unroll_loop[\s]+?for \(int i \= (\d+)\; i < (\d+)\; i\+\+\) \{([\s\S]+?)(?=\})\}/g,(function replace(match,start,end,snippet){let unroll="";for(let i=parseInt(start);i<parseInt(end);i++)unroll+=snippet.replace(/\[i\]/g,"["+i+"]");return unroll}))}(code)}})),Module((function GLTypes(){function getType(texture){let _gl=Renderer.context;switch(texture.type){case Texture.FLOAT:return _gl.FLOAT;case Texture.HALF_FLOAT:return Renderer.type==Renderer.WEBGL2?_gl.HALF_FLOAT:Renderer.extensions.halfFloat.HALF_FLOAT_OES;default:return _gl.UNSIGNED_BYTE}}this.exports={getFormat:function getFormat(texture){let _gl=Renderer.context;return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB},getProperty:function getProperty(property){let _gl=Renderer.context;switch(property){case Texture.NEAREST:return _gl.NEAREST;case Texture.LINEAR:return _gl.LINEAR;case Texture.LINEAR_MIPMAP:return _gl.LINEAR_MIPMAP_LINEAR;case Texture.NEAREST_MIPMAP:return _gl.NEAREST_MIPMAP_LINEAR;case Texture.LINEAR_MIPMAP_NEAREST:return _gl.LINEAR_MIPMAP_NEAREST;case Texture.CLAMP_TO_EDGE:return _gl.CLAMP_TO_EDGE;case Texture.REPEAT:return _gl.REPEAT;case Texture.MIRROR_REPEAT:return _gl.MIRRORED_REPEAT}},getType:getType,getFloatParams:function getFloatParams(texture){let _gl=Renderer.context;return{internalformat:function(){if(Renderer.type==Renderer.WEBGL2){switch(texture.type){case Texture.HALF_FLOAT:return texture.format==Texture.RGBAFormat?_gl.RGBA16F:_gl.RGB16F;case Texture.FLOAT:return texture.format==Texture.RGBAFormat?_gl.RGBA32F:_gl.RGB32F}return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB}return texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB}(),format:texture.format==Texture.RGBAFormat?_gl.RGBA:_gl.RGB,type:getType(texture)}}}})),Module((function ShaderCode(){function removeUBO(code,name){let uniforms=code.split(`uniform ${name} {`)[1];uniforms=uniforms.split("};")[0],uniforms=uniforms.split("\n"),uniforms.forEach(u=>{u.length&&(code=code.replace(u,"uniform "+u))});let split=code.split(`uniform ${name} {`);return split[1]=split[1].replace("};",""),code=(code=split.join("")).replace(`uniform ${name} {`,"")}this.exports={convertWebGL1:function convertWebGL1(code){return(code=(code=code.replace("#version 300 es","")).replace("out vec4 FragColor;","")).includes("samplerExternalOES")&&(code=code.replace("samplerExternalOES","sampler2D")),code.includes("uniform global {")&&(code=removeUBO(code,"global")),code.includes("uniform ubo {")&&(code=removeUBO(code,"ubo")),code.includes("uniform lights {")&&(code=removeUBO(code,"lights")),code},convertWebGL2:function convertWebGL2(code,type){return code=code.replace(/texture2D/g,"texture"),!(code="vs"==type?(code=code.replace(/attribute/g,"in")).replace(/varying/g,"out"):(code=code.replace(/varying/g,"in")).replace(/textureCube/g,"texture")).includes("samplerExternalOES")||"android"==Device.system.os&&window.AURA||(code=code.replace("samplerExternalOES","sampler2D")),Renderer.UBO?(code.includes("uniform global {")&&(code=code.replace("uniform global","layout(std140) uniform global")),code.includes("uniform ubo {")&&(code=code.replace("uniform ubo","layout(std140) uniform ubo")),Lighting.UBO?code.includes("uniform lights {")&&(code=code.replace("uniform lights","layout(std140) uniform lights")):code.includes("uniform lights {")&&(code=removeUBO(code,"lights"))):(code.includes("uniform global {")&&(code=removeUBO(code,"global")),code.includes("uniform ubo {")&&(code=removeUBO(code,"ubo")),code.includes("uniform lights {")&&(code=removeUBO(code,"lights"))),code}}}));class UBO{constructor(location,gl=Renderer.context){this.gl=gl,this.arrays=[];for(let i=0;i<30;i++)this.arrays.push([]);this.arrayIndex=0,this.objects=[],this.location=location,this.data=null,this.lastUpdate=0}_getSize(uniform){let obj=uniform.value;return Array.isArray(obj)?uniform.components?obj.length/uniform.components*16:16*obj.length:obj instanceof Vector2?8:obj instanceof Vector3?16:obj instanceof Vector4?16:obj instanceof Color?16:obj instanceof Matrix4?64:obj instanceof Matrix3?48:obj instanceof Quaternion?16:4}_getValues(uniform){let obj=uniform.value;return Array.isArray(obj)?obj:obj instanceof Vector2?this._array(obj.x,obj.y):obj instanceof Vector3?this._array(obj.x,obj.y,obj.z):obj instanceof Matrix4?obj.elements:obj instanceof Matrix3?obj.elements:obj instanceof Color?this._array(obj.r,obj.g,obj.b):obj instanceof Quaternion?this._array(obj.x,obj.y,obj.z,obj.w):this._array(obj)}_array(){this.arrayIndex++>=this.arrays.length-1&&(this.arrayIndex=0);let array=this.arrays[this.arrayIndex];return array.length=0,array.push.apply(array,arguments),array}clear(){for(let i=0;i<this.arrays.length;i++)this.arrays[i].length=0}calculate(){let len=this.objects.length,chunk=16,tsize=0,offset=0,size=0;for(let i=0;i<len;i++){let obj=this.objects[i];size=this._getSize(obj),tsize=chunk-size,tsize<0&&chunk<16?(offset+=chunk,i>0&&(this.objects[i-1].chunkLen+=chunk),chunk=16):tsize<0&&16==chunk||(0==tsize?chunk=16:chunk-=size),obj.offset=offset/4,obj.chunkLen=size/4,obj.dataLen=size/4,offset+=size}return offset%16!=0&&(this.objects[this.objects.length-1].chunkLen+=chunk/4,offset+=chunk),offset/4}compileData(){let i,array=this._array(),len=this.calculate();for(i=0;i<len;i++)array[i]=0;for(i=0;i<this.objects.length;i++){let obj=this.objects[i],values=this._getValues(obj);for(let j=0;j<values.length;j++)array[obj.offset+j]=values[j]}return array}upload(){if(this.data)return;let gl=Renderer.context,array=this.compileData();array.length&&(this.data=new Float32Array(array),this.buffer=gl.createBuffer(),gl.bindBuffer(gl.UNIFORM_BUFFER,this.buffer),gl.bufferData(gl.UNIFORM_BUFFER,this.data,gl.DYNAMIC_DRAW),gl.bindBuffer(gl.UNIFORM_BUFFER,null),gl.bindBufferBase(gl.UNIFORM_BUFFER,this.location,this.buffer))}bind(program,name){this.data||this.upload(),this.needsUpdate&&this.update();let location,gl=Renderer.context;location=program==this.lastProgram&&name==this.lastName&&void 0!==this.lastLocation?this.lastLocation:gl.getUniformBlockIndex(program,name),location>99999||-1==location||(gl.uniformBlockBinding(program,location,this.location),gl.bindBufferBase(gl.UNIFORM_BUFFER,this.location,this.buffer),this.lastProgram=program,this.lastName=name,this.lastLocation=location)}update(){if(this.data||this.upload(),!this.data)return;let gl=Renderer.context,array=this.compileData();try{this.data.set(array),gl.bindBuffer(gl.UNIFORM_BUFFER,this.buffer),gl.bufferSubData(gl.UNIFORM_BUFFER,0,this.data),gl.bindBuffer(gl.UNIFORM_BUFFER,null)}catch(e){}this.needsUpdate=!1}unbind(){}push(){if(this.data)throw"Can't modify UBO after initial upload!";for(let i=0;i<arguments.length;i++)this.objects.push(arguments[i])}destroy(){this.gl.deleteBuffer(this.buffer)}}class VAO{constructor(gl){this.gl=gl,this.WEBGL2=Renderer.type==Renderer.WEBGL2,this.WEBGL2?this.vao=gl.createVertexArray():this.vao=Renderer.extensions.VAO.createVertexArrayOES()}bind(){const gl=this.gl;this.WEBGL2?gl.bindVertexArray(this.vao):Renderer.extensions.VAO.bindVertexArrayOES(this.vao)}unbind(){const gl=this.gl;this.WEBGL2?gl.bindVertexArray(null):Renderer.extensions.VAO.bindVertexArrayOES(null)}destroy(){const gl=this.gl;this.WEBGL2?gl.deleteVertexArray(this.vao):Renderer.extensions.VAO.deleteVertexArrayOES(this.vao),this.vao=null}}class BoxGeometry extends Geometry{constructor(width=1,height=1,depth=1,widthSegments=1,heightSegments=1,depthSegments=1){super(),widthSegments=Math.floor(widthSegments),heightSegments=Math.floor(heightSegments),depthSegments=Math.floor(depthSegments);let indices=[],vertices=[],normals=[],uvs=[],numberOfVertices=0;function buildPlane(u,v,w,udir,vdir,width,height,depth,gridX,gridY,materialIndex){let ix,iy,segmentWidth=width/gridX,segmentHeight=height/gridY,widthHalf=width/2,heightHalf=height/2,depthHalf=depth/2,gridX1=gridX+1,gridY1=gridY+1,vertexCounter=0,vector=new Vector3;for(iy=0;iy<gridY1;iy++){let y=iy*segmentHeight-heightHalf;for(ix=0;ix<gridX1;ix++){let x=ix*segmentWidth-widthHalf;vector[u]=x*udir,vector[v]=y*vdir,vector[w]=depthHalf,vertices.push(vector.x,vector.y,vector.z),vector[u]=0,vector[v]=0,vector[w]=depth>0?1:-1,normals.push(vector.x,vector.y,vector.z),uvs.push(ix/gridX),uvs.push(1-iy/gridY),vertexCounter+=1}}for(iy=0;iy<gridY;iy++)for(ix=0;ix<gridX;ix++){let a=numberOfVertices+ix+gridX1*iy,b=numberOfVertices+ix+gridX1*(iy+1),c=numberOfVertices+(ix+1)+gridX1*(iy+1),d=numberOfVertices+(ix+1)+gridX1*iy;indices.push(a,b,d),indices.push(b,c,d)}numberOfVertices+=vertexCounter}buildPlane("z","y","x",-1,-1,depth,height,width,depthSegments,heightSegments,0),buildPlane("z","y","x",1,-1,depth,height,-width,depthSegments,heightSegments,1),buildPlane("x","z","y",1,1,width,depth,height,widthSegments,depthSegments,2),buildPlane("x","z","y",1,-1,width,depth,-height,widthSegments,depthSegments,3),buildPlane("x","y","z",1,-1,width,height,depth,widthSegments,heightSegments,4),buildPlane("x","y","z",-1,-1,width,height,-depth,widthSegments,heightSegments,5),this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class CircleGeometry extends Geometry{constructor(radius=1,segments=8,thetaStart=0,thetaLength=2*Math.PI){super();var i,s,indices=[],vertices=[],normals=[],uvs=[],vertex=new Vector3,uv=new Vector2;for(vertices.push(0,0,0),normals.push(0,0,1),uvs.push(.5,.5),s=0,i=3;s<=segments;s++,i+=3){var segment=thetaStart+s/segments*thetaLength;vertex.x=radius*Math.cos(segment),vertex.y=radius*Math.sin(segment),vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,0,1),uv.x=(vertices[i]/radius+1)/2,uv.y=(vertices[i+1]/radius+1)/2,uvs.push(uv.x,uv.y)}for(i=1;i<=segments;i++)indices.push(i,i+1,0);this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class CylinderGeometry extends Geometry{constructor(radiusTop=1,radiusBottom=1,height=1,radialSegments=8,heightSegments=1,openEnded=!1,thetaStart=0,thetaLength=2*Math.PI){super(),radialSegments=Math.floor(radialSegments),heightSegments=Math.floor(heightSegments);let indices=[],vertices=[],normals=[],uvs=[],index=0,indexArray=[],halfHeight=height/2;function generateCap(top){let x,centerIndexStart,centerIndexEnd,uv=new Vector2,vertex=new Vector3,radius=!0===top?radiusTop:radiusBottom,sign=!0===top?1:-1;for(centerIndexStart=index,x=1;x<=radialSegments;x++)vertices.push(0,halfHeight*sign,0),normals.push(0,sign,0),uvs.push(.5,.5),index++;for(centerIndexEnd=index,x=0;x<=radialSegments;x++){let theta=x/radialSegments*thetaLength+thetaStart,cosTheta=Math.cos(theta),sinTheta=Math.sin(theta);vertex.x=radius*sinTheta,vertex.y=halfHeight*sign,vertex.z=radius*cosTheta,vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,sign,0),uv.x=.5*cosTheta+.5,uv.y=.5*sinTheta*sign+.5,uvs.push(uv.x,uv.y),index++}for(x=0;x<radialSegments;x++){let c=centerIndexStart+x,i=centerIndexEnd+x;!0===top?indices.push(i,i+1,c):indices.push(i+1,i,c)}}!function generateTorso(){let x,y,normal=new Vector3,vertex=new Vector3,slope=(radiusBottom-radiusTop)/height;for(y=0;y<=heightSegments;y++){let indexRow=[],v=y/heightSegments,radius=v*(radiusBottom-radiusTop)+radiusTop;for(x=0;x<=radialSegments;x++){let u=x/radialSegments,theta=u*thetaLength+thetaStart,sinTheta=Math.sin(theta),cosTheta=Math.cos(theta);vertex.x=radius*sinTheta,vertex.y=-v*height+halfHeight,vertex.z=radius*cosTheta,vertices.push(vertex.x,vertex.y,vertex.z),normal.set(sinTheta,slope,cosTheta).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(u,1-v),indexRow.push(index++)}indexArray.push(indexRow)}for(x=0;x<radialSegments;x++)for(y=0;y<heightSegments;y++){let a=indexArray[y][x],b=indexArray[y+1][x],c=indexArray[y+1][x+1],d=indexArray[y][x+1];indices.push(a,b,d),indices.push(b,c,d)}}(),!1===openEnded&&(radiusTop>0&&generateCap(!0),radiusBottom>0&&generateCap(!1)),this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class ConeGeometry extends CylinderGeometry{constructor(radius,height,radialSegments,heightSegments,openEnded,thetaStart,thetaLength){super(0,radius,height,radialSegments,heightSegments,openEnded,thetaStart,thetaLength)}}class PlaneGeometry extends Geometry{constructor(width=1,height=1,widthSegments=1,heightSegments=1){super();let ix,iy,width_half=width/2,height_half=height/2,gridX=Math.floor(widthSegments)||1,gridY=Math.floor(heightSegments)||1,gridX1=gridX+1,gridY1=gridY+1,segment_width=width/gridX,segment_height=height/gridY,indices=[],vertices=[],normals=[],uvs=[];for(iy=0;iy<gridY1;iy++){let y=iy*segment_height-height_half;for(ix=0;ix<gridX1;ix++){let x=ix*segment_width-width_half;vertices.push(x,-y,0),normals.push(0,0,1),uvs.push(ix/gridX),uvs.push(1-iy/gridY)}}for(iy=0;iy<gridY;iy++)for(ix=0;ix<gridX;ix++){let a=ix+gridX1*iy,b=ix+gridX1*(iy+1),c=ix+1+gridX1*(iy+1),d=ix+1+gridX1*iy;indices.push(a,b,d),indices.push(b,c,d)}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class PolyhedronGeometry extends Geometry{constructor(vertices,indices=[],radius=1,detail=0){super();let vertexBuffer=[],uvBuffer=[];function subdivideFace(a,b,c,detail){var i,j,cols=Math.pow(2,detail),v=[];for(i=0;i<=cols;i++){v[i]=[];var aj=a.clone().lerp(c,i/cols),bj=b.clone().lerp(c,i/cols),rows=cols-i;for(j=0;j<=rows;j++)v[i][j]=0===j&&i===cols?aj:aj.clone().lerp(bj,j/rows)}for(i=0;i<cols;i++)for(j=0;j<2*(cols-i)-1;j++){var k=Math.floor(j/2);j%2==0?(pushVertex(v[i][k+1]),pushVertex(v[i+1][k]),pushVertex(v[i][k])):(pushVertex(v[i][k+1]),pushVertex(v[i+1][k+1]),pushVertex(v[i+1][k]))}}function pushVertex(vertex){vertexBuffer.push(vertex.x,vertex.y,vertex.z)}function getVertexByIndex(index,vertex){let stride=3*index;vertex.x=vertices[stride+0],vertex.y=vertices[stride+1],vertex.z=vertices[stride+2]}function correctUV(uv,stride,vector,azimuth){azimuth<0&&1===uv.x&&(uvBuffer[stride]=uv.x-1),0===vector.x&&0===vector.z&&(uvBuffer[stride]=azimuth/2/Math.PI+.5)}function azimuth(vector){return Math.atan2(vector.z,-vector.x)}!function subdivide(detail){let a=new Vector3,b=new Vector3,c=new Vector3;for(let i=0;i<indices.length;i+=3)getVertexByIndex(indices[i+0],a),getVertexByIndex(indices[i+1],b),getVertexByIndex(indices[i+2],c),subdivideFace(a,b,c,detail)}(detail),function appplyRadius(radius){for(var vertex=new Vector3,i=0;i<vertexBuffer.length;i+=3)vertex.x=vertexBuffer[i+0],vertex.y=vertexBuffer[i+1],vertex.z=vertexBuffer[i+2],vertex.normalize().multiplyScalar(radius),vertexBuffer[i+0]=vertex.x,vertexBuffer[i+1]=vertex.y,vertexBuffer[i+2]=vertex.z}(radius),function generateUVs(){let vertex=new Vector3;for(let i=0;i<vertexBuffer.length;i+=3){vertex.x=vertexBuffer[i+0],vertex.y=vertexBuffer[i+1],vertex.z=vertexBuffer[i+2];let u=azimuth(vertex)/2/Math.PI+.5,v=(vector=vertex,Math.atan2(-vector.y,Math.sqrt(vector.x*vector.x+vector.z*vector.z))/Math.PI+.5);uvBuffer.push(u,1-v)}var vector;(function correctUVs(){let a=new Vector3,b=new Vector3,c=new Vector3,centroid=new Vector3,uvA=new Vector2,uvB=new Vector2,uvC=new Vector2;for(let i=0,j=0;i<vertexBuffer.length;i+=9,j+=6){a.set(vertexBuffer[i+0],vertexBuffer[i+1],vertexBuffer[i+2]),b.set(vertexBuffer[i+3],vertexBuffer[i+4],vertexBuffer[i+5]),c.set(vertexBuffer[i+6],vertexBuffer[i+7],vertexBuffer[i+8]),uvA.set(uvBuffer[j+0],uvBuffer[j+1]),uvB.set(uvBuffer[j+2],uvBuffer[j+3]),uvC.set(uvBuffer[j+4],uvBuffer[j+5]),centroid.copy(a).add(b).add(c).divideScalar(3);let azi=azimuth(centroid);correctUV(uvA,j+0,a,azi),correctUV(uvB,j+2,b,azi),correctUV(uvC,j+4,c,azi)}})(),function correctSeam(){for(let i=0;i<uvBuffer.length;i+=6){let x0=uvBuffer[i+0],x1=uvBuffer[i+2],x2=uvBuffer[i+4],max=Math.max(x0,x1,x2),min=Math.min(x0,x1,x2);max>.9&&min<.1&&(x0<.2&&(uvBuffer[i+0]+=1),x1<.2&&(uvBuffer[i+2]+=1),x2<.2&&(uvBuffer[i+4]+=1))}}()}(),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertexBuffer),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(vertexBuffer.slice()),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvBuffer),2)),0===detail?this.computeVertexNormals():this.normalizeNormals()}}class IcosahedronGeometry extends PolyhedronGeometry{constructor(radius,detail){let t=(1+Math.sqrt(5))/2;super([-1,t,0,1,t,0,-1,-t,0,1,-t,0,0,-1,t,0,1,t,0,-1,-t,0,1,-t,t,0,-1,t,0,1,-t,0,-1,-t,0,1],[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1],radius,detail)}}class RingGeometry extends Geometry{constructor(innerRadius=.5,outerRadius=1,thetaSegments=8,phiSegments=1,thetaStart=0,thetaLength=2*Math.PI){super();var segment,j,i,indices=[],vertices=[],normals=[],uvs=[],radius=innerRadius,radiusStep=(outerRadius-innerRadius)/phiSegments,vertex=new Vector3,uv=new Vector2;for(j=0;j<=phiSegments;j++){for(i=0;i<=thetaSegments;i++)segment=thetaStart+i/thetaSegments*thetaLength,vertex.x=radius*Math.cos(segment),vertex.y=radius*Math.sin(segment),vertices.push(vertex.x,vertex.y,vertex.z),normals.push(0,0,1),uv.x=(vertex.x/outerRadius+1)/2,uv.y=(vertex.y/outerRadius+1)/2,uvs.push(uv.x,uv.y);radius+=radiusStep}for(j=0;j<phiSegments;j++){var thetaSegmentLevel=j*(thetaSegments+1);for(i=0;i<thetaSegments;i++){var a=segment=i+thetaSegmentLevel,b=segment+thetaSegments+1,c=segment+thetaSegments+2,d=segment+1;indices.push(a,b,d),indices.push(b,c,d)}}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class SphereGeometry extends Geometry{constructor(radius=1,widthSegments=8,heightSegments=6,phiStart=0,phiLength=2*Math.PI,thetaStart=0,thetaLength=Math.PI){super(),widthSegments=Math.max(3,Math.floor(widthSegments)),heightSegments=Math.max(2,Math.floor(heightSegments));let ix,iy,thetaEnd=thetaStart+thetaLength,index=0,grid=[],vertex=new Vector3,normal=new Vector3,indices=[],vertices=[],normals=[],uvs=[];for(iy=0;iy<=heightSegments;iy++){let verticesRow=[],v=iy/heightSegments;for(ix=0;ix<=widthSegments;ix++){let u=ix/widthSegments;vertex.x=-radius*Math.cos(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertex.y=radius*Math.cos(thetaStart+v*thetaLength),vertex.z=radius*Math.sin(phiStart+u*phiLength)*Math.sin(thetaStart+v*thetaLength),vertices.push(vertex.x,vertex.y,vertex.z),normal.set(vertex.x,vertex.y,vertex.z).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(u,1-v),verticesRow.push(index++)}grid.push(verticesRow)}for(iy=0;iy<heightSegments;iy++)for(ix=0;ix<widthSegments;ix++){let a=grid[iy][ix+1],b=grid[iy][ix],c=grid[iy+1][ix],d=grid[iy+1][ix+1];(0!==iy||thetaStart>0)&&indices.push(a,b,d),(iy!==heightSegments-1||thetaEnd<Math.PI)&&indices.push(b,c,d)}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}class TorusKnotGeometry extends Geometry{constructor(radius=1,tube=.4,tubularSegments=64,radialSegments=8,p=2,q=3){super();let i,j,indices=[],vertices=[],normals=[],uvs=[],vertex=new Vector3,normal=new Vector3,P1=new Vector3,P2=new Vector3,B=new Vector3,T=new Vector3,N=new Vector3;for(i=0;i<=tubularSegments;++i){let u=i/tubularSegments*p*Math.PI*2;for(calculatePositionOnCurve(u,p,q,radius,P1),calculatePositionOnCurve(u+.01,p,q,radius,P2),T.subVectors(P2,P1),N.addVectors(P2,P1),B.crossVectors(T,N),N.crossVectors(B,T),B.normalize(),N.normalize(),j=0;j<=radialSegments;++j){let v=j/radialSegments*Math.PI*2,cx=-tube*Math.cos(v),cy=tube*Math.sin(v);vertex.x=P1.x+(cx*N.x+cy*B.x),vertex.y=P1.y+(cx*N.y+cy*B.y),vertex.z=P1.z+(cx*N.z+cy*B.z),vertices.push(vertex.x,vertex.y,vertex.z),normal.subVectors(vertex,P1).normalize(),normals.push(normal.x,normal.y,normal.z),uvs.push(i/tubularSegments),uvs.push(j/radialSegments)}}for(j=1;j<=tubularSegments;j++)for(i=1;i<=radialSegments;i++){let a=(radialSegments+1)*(j-1)+(i-1),b=(radialSegments+1)*j+(i-1),c=(radialSegments+1)*j+i,d=(radialSegments+1)*(j-1)+i;indices.push(a,b,d),indices.push(b,c,d)}function calculatePositionOnCurve(u,p,q,radius,position){let cu=Math.cos(u),su=Math.sin(u),quOverP=q/p*u,cs=Math.cos(quOverP);position.x=radius*(2+cs)*.5*cu,position.y=radius*(2+cs)*su*.5,position.z=radius*Math.sin(quOverP)*.5}this.index=new Uint16Array(indices),this.addAttribute("position",new GeometryAttribute(new Float32Array(vertices),3)),this.addAttribute("normal",new GeometryAttribute(new Float32Array(normals),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvs),2))}}Class((function Interaction3D(_camera){Inherit(this,Component);const _this=this;let _hover,_click;var _v3=new Vector3,_input={},_enabled=!0;_this.ID=Utils.timestamp(),_camera=_camera||World.CAMERA;let _ray=_this.initClass(Raycaster,_camera);_ray.testVisibility=!0;let _meshes=[],_test=[];const _event={};function parseMeshes(meshes){Array.isArray(meshes)||(meshes=[meshes]);let output=[];return meshes.forEach((function checkMesh(obj){obj.hitArea&&(obj=function initHitMesh(obj){obj.hitMesh||(obj.hitMesh=new Mesh(obj.hitArea),obj.add(obj.hitMesh));return(obj=obj.hitMesh).isHitMesh=!0,obj.testVisibility=!1,obj.visible=!1,obj}(obj));"boolean"==typeof obj.isHitMesh?(obj.mouseEnabled=function(visible){visible?~_meshes.indexOf(obj)||_meshes.push(obj):_meshes.remove(obj)},output.push(obj)):output.push(obj);obj.children.length&&obj.children.forEach(checkMesh)})),output}function testObjects(){_test.length=0;for(let i=_meshes.length-1;i>-1;i--){let obj=_meshes[i];obj.determineVisible()&&_test.push(obj)}return _test}function start(){if(!_enabled)return;let hit=move();"3d"==_input.type&&_this.events.fire(Interaction3D.EXTERNAL_PRESS),hit?(_click=hit.object,_click.time=Render.TIME):_click=null}function move(){if(!_enabled)return void Interaction3D.requestCursor("auto",_this);let hit;if("2d"==_input.type?hit=_ray.checkHit(testObjects(),_input.position,_input.rect||Stage)[0]:(_v3.set(0,0,-1).applyQuaternion(_input.quaternion),hit=_ray.checkFromValues(testObjects(),_input.position,_v3)[0]),hit){let mesh=hit.object;return mesh.onHitUpdate?(mesh.onHitUpdate(hit),!1):(_input.obj&&_input.obj.setHitPosition&&_input.obj.setHitPosition(hit),_hover!==mesh?(_hover&&triggerHover("out",_hover,hit),_hover=mesh,triggerHover("over",_hover,hit),_hover.__clickCallback?Interaction3D.requestCursor("pointer",_this):Interaction3D.requestCursor("auto",_this)):function triggerMove(mesh,hit){_event.action="move",_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.MOVE,_event,!0),mesh["__moveCallback"+_this.ID]&&mesh["__moveCallback"+_this.ID](_event)}(_hover,hit),hit)}return end(),_input.obj&&_input.obj.setHitPosition&&_input.obj.setHitPosition(!1),!1}function end(){_hover&&(triggerHover("out",_hover,null),_hover=null,Interaction3D.requestCursor(_this.cursor,_this))}function click(e){if("3d"==_input.type&&_this.events.fire(Interaction3D.EXTERNAL_RELEASE),!_this.enabled)return;if(!_click)return;let hit;if("2d"==_input.type){let element=document.elementFromPoint(e.x,e.y);if(element&&"hit"===element.className||GLUI.HIT)return;hit=_ray.checkHit(testObjects(),_input.position,_input.rect)[0]}else _v3.set(0,0,-1).applyQuaternion(_input.quaternion),hit=_ray.checkFromValues(testObjects(),_input.position,_v3)[0];hit&&hit.object===_click&&function triggerClick(mesh,hit){_event.action="click",_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.CLICK,_event,!0),_click.__clickCallback&&_click.__clickCallback(_event)}(_click,hit),_click=null}function triggerHover(action,mesh,hit){_event.action=action,_event.mesh=mesh,_event.hit=hit,_this.events.fire(Interaction3D.HOVER,_event,!0),_hover.__hoverCallback&&_hover.__hoverCallback(_event)}this.cursor="auto",this.set("camera",c=>{_ray.camera=c}),this.add=function(meshes,hover,click,move,seo){let seoRoot;Array.isArray(meshes)||(meshes=parseMeshes(meshes)),move&&"function"!=typeof move&&(seo=move,move=null),seo&&seo.root&&(seoRoot=seo.root,seo=seo.seo),meshes.forEach((mesh,i)=>{if(seo)try{mesh._divFocus=_=>hover({action:"over",mesh:mesh}),mesh._divBlur=_=>hover({action:"out",mesh:mesh}),mesh._divSelect=_=>click({action:"click",mesh:mesh});let{url:url,label:label}=Array.isArray(seo)?seo[i]:seo;GLSEO.objectNode(mesh,seoRoot),mesh.seo.aLink(url,label)}catch(e){Hydra.LOCAL&&console.warn("Could not add SEO to Interaction3D meshes",e)}mesh.hitDestroy=_=>_meshes.remove(mesh),hover&&(mesh.__hoverCallback=hover),click&&(mesh.__clickCallback=click),move&&(mesh["__moveCallback"+_this.ID]=move),_meshes.push(mesh)})},this.remove=function(meshes){Array.isArray(meshes)||(meshes=parseMeshes(meshes)),meshes.forEach(mesh=>{mesh===_hover&&(_hover=null,Interaction3D.requestCursor(_this.cursor,_this)),mesh.seo&&mesh.seo.unlink();for(let i=_meshes.length-1;i>=0;i--)mesh===_meshes[i]&&_meshes.splice(i,1)})},this.set("testVisibility",v=>_ray.testVisibility=v),this.set("input",obj=>{(_input={}).obj=obj,_input.position=obj.group?obj.group.position:obj,_input.quaternion=obj.group?obj.group.quaternion:null,_input.type="number"==typeof _input.position.z?"3d":"2d",_input.rect=obj.rect,"3d"==_input.type?(new Vector3,new Vector3):(new Vector2,new Vector2),obj==Mouse?function addHandlers(){_this.events.sub(Mouse.input,Interaction.START,start),Device.mobile&&_this.events.sub(Mouse.input,Interaction.END,end),_this.events.sub(Mouse.input,Interaction.MOVE,move),_this.events.sub(Mouse.input,Interaction.CLICK,click)}():(!function removeHandlers(){_this.events.unsub(Mouse.input,Interaction.START,start),Device.mobile&&_this.events.unsub(Mouse.input,Interaction.END,end),_this.events.unsub(Mouse.input,Interaction.MOVE,move),_this.events.unsub(Mouse.input,Interaction.CLICK,click)}(),_this.events.sub(obj,VRInput.SELECT_START,start),_this.events.sub(obj,VRInput.SELECT_END,click),_this.startRender(move,24))}),this.get("enabled",_=>_enabled),this.set("enabled",v=>{(_enabled=v)||(_hover&&triggerHover("out",_hover,null),_hover=null)})}),()=>{Interaction3D.HOVER="interaction3d_hover",Interaction3D.CLICK="interaction3d_click",Interaction3D.MOVE="interaction3d_move",Interaction3D.EXTERNAL_PRESS="interaction3d_ext_press",Interaction3D.EXTERNAL_RELEASE="interaction3d_ext_release";var _cursorObj,_map=new Map,_input=Mouse;Interaction3D.find=function(camera){if(camera=camera.camera||camera,!_map.has(camera)){let interaction=new Interaction3D(camera);interaction.input=_input,_map.set(camera,interaction)}return _map.get(camera)},Interaction3D.useInput=function(obj){for(let[camera,interaction]of _map)interaction.input=obj;_input=obj},Interaction3D.requestCursor=function(cursor,obj){"pointer"==cursor&&(_cursorObj=obj,Stage.css("cursor",cursor)),"auto"==cursor&&_cursorObj==obj&&(Stage.css("cursor",cursor),_cursorObj=null)}}),Class((function Lighting(){Inherit(this,Component);const _this=this;var _activeScene,_scenes={};function loop(){if(decomposeLights(_activeScene.lights),_this.UBO){let shader=_activeScene.shaders.start();shader&&(updateArrays(shader),_activeScene.ubo.created?_activeScene.ubo.update():createUBO(shader.uniforms))}else{let shader=_activeScene.shaders.start();for(;shader;)updateArrays(shader),shader=_activeScene.shaders.next()}}function createUBO(uniforms){_activeScene.ubo.created=!0,_activeScene.ubo.push(uniforms.lightPos),_activeScene.ubo.push(uniforms.lightColor),_activeScene.ubo.push(uniforms.lightData),_activeScene.ubo.push(uniforms.lightData2),_activeScene.ubo.push(uniforms.lightData3),_activeScene.ubo.push(uniforms.lightProperties),_activeScene.ubo.upload()}function decomposeLights(lights){for(let i=lights.length-1;i>-1;i--){let light=lights[i];light._decomposedTime&&Render.TIME-light._decomposedTime<8||(light._decomposedTime=Render.TIME,light._parent||light.updateMatrixWorld(),light._world||(light._world=new Vector3),light.lockToLocal?light._world.copy(light.position):light.getWorldPosition(light._world))}}function updateArrays(shader){let lighting=shader.__lighting;lighting.position.length=0,lighting.color.length=0,lighting.data.length=0,lighting.data2.length=0,lighting.data3.length=0,lighting.properties.length=0;for(let i=0;i<_activeScene.lights.length;i++){let light=_activeScene.lights[i];light._world||decomposeLights(_activeScene.lights),lighting.position.push(light._world.x,light._world.y,light._world.z,0),lighting.color.push(light.color.r,light.color.g,light.color.b,0),lighting.data.push(light.data.x,light.data.y,light.data.z,light.data.w),lighting.data2.push(light.data2.x,light.data2.y,light.data2.z,light.data2.w),lighting.data3.push(light.data3.x,light.data3.y,light.data3.z,light.data3.w),lighting.properties.push(light.properties.x,light.properties.y,light.properties.z,light.properties.w)}}function findParentScene(obj3d){if(!obj3d)return _activeScene;if(obj3d._lightingData)return obj3d._lightingData;let scene,p=obj3d._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent;return scene||(scene=_activeScene),scene}this.fallbackAreaToPoint=!1,this.scenes=_scenes,async function(){await Hydra.ready(),_this.createScene("default"),_this.useScene("default")}(),this.createScene=function(name,scene){if(_scenes[name])return this;let obj={lights:[],renderShadows:[],ubo:new(window.Metal?MetalUBO:UBO)(2),shaders:new LinkedList,name:name};return scene&&(scene._lightingData=obj),_scenes[name]=obj,this},this.useScene=function(name){if(!(_activeScene=_scenes[name]))throw`Scene ${name} not found`;return loop(),this},this.destroyScene=function(name){delete _scenes[name]},this.push=this.add=function(light){_this.UBO=Renderer.UBO&&!(window.AURA||RenderManager.type==RenderManager.WEBVR),window.Metal&&(_this.UBO=!0);let scene=findParentScene(light);scene.lights.push(light),light.isAreaLight&&(scene.hasAreaLight=!0),_this.startedLoop||(_this.startedLoop=!0,RenderManager.type==RenderManager.WEBVR?_this.events.sub(RenderManager.BEFORE_RENDER,_=>loop()):Render.onDrawFrame(loop))},this.remove=function(light){_activeScene.lights.remove(light)},this.getLighting=function(shader,force){if(shader.__lighting&&!force)return shader.__lighting;let scene=findParentScene(shader.mesh);scene.shaders.push(shader),window.AreaLightUtil&&scene.hasAreaLight&&AreaLightUtil.append(shader);let lighting=shader.__lighting={position:[],color:[],data:[],data2:[],data3:[],properties:[]},lightUBO=_this.UBO;return shader.uniforms.lightPos={type:"v4v",value:lighting.position,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightColor={type:"v4v",value:lighting.color,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData={type:"v4v",value:lighting.data,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData2={type:"v4v",value:lighting.data2,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightData3={type:"v4v",value:lighting.data3,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},shader.uniforms.lightProperties={type:"v4v",value:lighting.properties,ignoreUIL:!0,lightUBO:lightUBO,components:4,metalIgnore:!0},updateArrays(shader),_this.UBO&&!_activeScene.ubo.created&&createUBO(shader.uniforms),shader.__lighting},this.destroyShader=function(shader){findParentScene(shader.mesh);_activeScene.shaders.remove(shader)},this.sort=function(callback){_activeScene.lights.sort(callback)},this.addToShadowGroup=function(light){findParentScene(light).renderShadows.push(light)},this.removeFromShadowGroup=function(light){findParentScene(light);_activeScene.renderShadows.remove(light)},this.getShadowLights=function(){return _activeScene.renderShadows},this.getShadowCount=function(){return _activeScene.renderShadows.length},this.initShadowShader=function(object,mesh){let scene,shader=object.shader||object;if(shader.mesh){let p=shader.mesh._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent}if(scene||(scene=_activeScene),!World.RENDERER.shadows||0==scene.renderShadows.length)return"";shader._gl||shader.upload();let vsName=shader.vsName,fsName="ShadowDepth";shader.customShadowShader&&(fsName=shader.customShadowShader),shader.shadow=new Shader(vsName,fsName,{receiveLight:shader.receiveLight,UILPrefix:shader.UILPrefix,precision:"high"}),shader.vertexShader&&(shader.shadow.vertexShader=shader.vertexShader),shader.shadow.lights=shader.lights,shader.shadow.isShadow=!0,shader.copyUniformsTo(shader.shadow,!0),shader.shadow.upload()},this.getShadowUniforms=function(shader){let scene;if(shader.mesh){let p=shader.mesh._parent;for(;p;)p instanceof Scene&&p._lightingData&&(scene=p._lightingData),p=p._parent}return scene||(scene=_activeScene),World.RENDERER.shadows&&0!=scene.renderShadows.length?[`\n#define SHADOW_MAPS ${scene.renderShadows.length}`,World.RENDERER.shadows==Renderer.SHADOWS_LOW?"#define SHADOWS_LOW":"",World.RENDERER.shadows==Renderer.SHADOWS_MED?"#define SHADOWS_MED":"",World.RENDERER.shadows==Renderer.SHADOWS_HIGH?"#define SHADOWS_HIGH":"",`uniform sampler2D shadowMap[${scene.renderShadows.length}];`,`uniform mat4 shadowMatrix[${scene.renderShadows.length}];`,`uniform vec3 shadowLightPos[${scene.renderShadows.length}];`,`uniform float shadowSize[${scene.renderShadows.length}];`].join("\n"):""},this.bindUBO=function(shader){_activeScene.ubo.created&&_activeScene.ubo.bind(shader,"lights")},this.fallbackAreaToPointTest=function(){return _this.fallbackAreaToPoint},this.get("activeScene",_=>_activeScene)}),"static");class Shadow{constructor(light){this.light=light,this.camera=new PerspectiveCamera(60,1,.1,50),this.target=new Vector3,this.rt=new RenderTarget(1024,1024),this.rt.createDepthTexture(),this.enabled=!0,this._size=1024,this._fov=60,this._far=50,this._near=.1,light.add(this.camera)}destroy(){this.rt.destroy()}set fov(value){this._fov=value,this.camera.fov=value,this.camera.updateProjectionMatrix(),-1==value&&(this.camera=new OrthographicCamera(-5,5,5,-5,.1,50))}get fov(){return this._fov}set area(value){this._area=value,this.camera.left=-value,this.camera.right=value,this.camera.top=value,this.camera.bottom=-value,this.camera.updateProjectionMatrix()}get area(){return this._area}set far(value){this._far=value,this.camera.far=value,this.camera.updateProjectionMatrix()}get far(){return this._far}set near(value){this._near=value,this.camera.near=value,this.camera.updateProjectionMatrix()}get near(){return this._near}set size(value){this._size=value,this.rt.setSize(value,value)}get size(){return this._size}}class Box2{constructor(min,max){this.min=void 0!==min?min:new Vector2(1/0,1/0),this.max=void 0!==max?max:new Vector2(-1/0,-1/0)}set(min,max){return this.min.copy(min),this.max.copy(max),this}setFromPoints(points){this.makeEmpty();for(let i=0,il=points.length;i<il;i++)this.expandByPoint(points[i]);return this}setFromCenterAndSize(center,size){let v1=this.V1||new Vector2;this.V1=v1;let halfSize=v1.copy(size).multiplyScalar(.5);return this.min.copy(center).sub(halfSize),this.max.copy(center).add(halfSize),this}clone(){return(new Box2).copy(this)}copy(box){return this.min.copy(box.min),this.max.copy(box.max),this}makeEmpty(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y}getCenter(target){return this.isEmpty()?target.set(0,0):target.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(target){return this.isEmpty()?target.set(0,0):target.subVectors(this.max,this.min)}expandByPoint(point){return this.min.min(point),this.max.max(point),this}expandByVector(vector){return this.min.sub(vector),this.max.add(vector),this}expandByScalar(scalar){return this.min.addScalar(-scalar),this.max.addScalar(scalar),this}containsPoint(point){return!(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y)}containsBox(box){return this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y}getParameter(point,target){return target.set((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y))}intersectsBox(box){return!(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y)}clampPoint(point,target){return target.copy(point).clamp(this.min,this.max)}distanceToPoint(point){let v1=this.V1||new Vector2;return this.V1=v1,v1.copy(point).clamp(this.min,this.max).sub(point).length()}intersect(box){return this.min.max(box.min),this.max.min(box.max),this}union(box){return this.min.min(box.min),this.max.max(box.max),this}translate(offset){return this.min.add(offset),this.max.add(offset),this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}}class Box3{constructor(min,max){this.min=void 0!==min?min:new Vector3(1/0,1/0,1/0),this.max=void 0!==max?max:new Vector3(-1/0,-1/0,-1/0)}set(min,max){return this.min.copy(min),this.max.copy(max),this}setFromArray(array){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=array.length;i<l;i+=3){let x=array[i],y=array[i+1],z=array[i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}setFromBufferAttribute(attribute){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=attribute.count;i<l;i++){let x=attribute.array[3*i+0],y=attribute.array[3*i+1],z=attribute.array[3*i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}setFromPoints(points){this.makeEmpty();for(let i=0,il=points.length;i<il;i++)this.expandByPoint(points[i]);return this}setFromCenterAndSize(center,size){let v1=this.V1||new Vector3;this.V1=v1;let halfSize=v1.copy(size).multiplyScalar(.5);return this.min.copy(center).sub(halfSize),this.max.copy(center).add(halfSize),this}setFromObject(object){return this.makeEmpty(),this.expandByObject(object)}clone(){return(new Box3).copy(this)}copy(box){return this.min.copy(box.min),this.max.copy(box.max),this}makeEmpty(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this}isEmpty(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z}getCenter(target){return this.isEmpty()?target.set(0,0,0):target.addVectors(this.min,this.max).multiplyScalar(.5)}getSize(target){return this.isEmpty()?target.set(0,0,0):target.subVectors(this.max,this.min)}expandByPoint(point){return this.min.min(point),this.max.max(point),this}expandByVector(vector){return this.min.sub(vector),this.max.add(vector),this}expandByScalar(scalar){return this.min.addScalar(-scalar),this.max.addScalar(scalar),this}expandByObject(object,local){let scope,i,l,v1=this.V1||new Vector3;return this.V1=v1,scope=this,object.updateMatrixWorld(!0),object.traverse(node=>{let geometry=node.geometry;if(!geometry)return;let attribute=geometry.attributes.position;if(void 0!==attribute)for(i=0,l=attribute.count;i<l;i++)v1.fromBufferAttribute(attribute,i).applyMatrix4(local?node.matrix:node.matrixWorld),scope.expandByPoint(v1)}),this}containsPoint(point){return!(point.x<this.min.x||point.x>this.max.x||point.y<this.min.y||point.y>this.max.y||point.z<this.min.z||point.z>this.max.z)}containsBox(box){return this.min.x<=box.min.x&&box.max.x<=this.max.x&&this.min.y<=box.min.y&&box.max.y<=this.max.y&&this.min.z<=box.min.z&&box.max.z<=this.max.z}getParameter(point,target){return target.set((point.x-this.min.x)/(this.max.x-this.min.x),(point.y-this.min.y)/(this.max.y-this.min.y),(point.z-this.min.z)/(this.max.z-this.min.z))}intersectsBox(box){return!(box.max.x<this.min.x||box.min.x>this.max.x||box.max.y<this.min.y||box.min.y>this.max.y||box.max.z<this.min.z||box.min.z>this.max.z)}intersectsSphere(sphere){let closestPoint=this.V1||new Vector3;return this.V1=closestPoint,this.clampPoint(sphere.center,closestPoint),closestPoint.distanceToSquared(sphere.center)<=sphere.radius*sphere.radius}intersectsPlane(plane){let min,max;return plane.normal.x>0?(min=plane.normal.x*this.min.x,max=plane.normal.x*this.max.x):(min=plane.normal.x*this.max.x,max=plane.normal.x*this.min.x),plane.normal.y>0?(min+=plane.normal.y*this.min.y,max+=plane.normal.y*this.max.y):(min+=plane.normal.y*this.max.y,max+=plane.normal.y*this.min.y),plane.normal.z>0?(min+=plane.normal.z*this.min.z,max+=plane.normal.z*this.max.z):(min+=plane.normal.z*this.max.z,max+=plane.normal.z*this.min.z),min<=plane.constant&&max>=plane.constant}intersectsTriangle(triangle){let v0=this.V0||new Vector3;this.V0=v0;let v1=this.V1||new Vector3;this.V1=v1;let v2=this.V2||new Vector3;this.V2=v2;let f0=this.F0||new Vector3;this.F0=f0;let f1=this.F1||new Vector3;this.F1=f1;let f2=this.F2||new Vector3;this.F2=f2;let testAxis=this.V3||new Vector3;this.V3=testAxis;let center=this.V4||new Vector3;this.V4=center;let extents=this.V5||new Vector3;this.V5=extents;let triangleNormal=this.V6||new Vector3;function satForAxes(axes){let i,j;for(i=0,j=axes.length-3;i<=j;i+=3){testAxis.fromArray(axes,i);let r=extents.x*Math.abs(testAxis.x)+extents.y*Math.abs(testAxis.y)+extents.z*Math.abs(testAxis.z),p0=v0.dot(testAxis),p1=v1.dot(testAxis),p2=v2.dot(testAxis);if(Math.max(-Math.max(p0,p1,p2),Math.min(p0,p1,p2))>r)return!1}return!0}if(this.V6=triangleNormal,this.isEmpty())return!1;this.getCenter(center),extents.subVectors(this.max,center),v0.subVectors(triangle.a,center),v1.subVectors(triangle.b,center),v2.subVectors(triangle.c,center),f0.subVectors(v1,v0),f1.subVectors(v2,v1),f2.subVectors(v0,v2);let axes=[0,-f0.z,f0.y,0,-f1.z,f1.y,0,-f2.z,f2.y,f0.z,0,-f0.x,f1.z,0,-f1.x,f2.z,0,-f2.x,-f0.y,f0.x,0,-f1.y,f1.x,0,-f2.y,f2.x,0];return!!satForAxes(axes)&&(axes=[1,0,0,0,1,0,0,0,1],!!satForAxes(axes)&&(triangleNormal.crossVectors(f0,f1),axes=[triangleNormal.x,triangleNormal.y,triangleNormal.z],satForAxes(axes)))}clampPoint(point,target){return target.copy(point).clamp(this.min,this.max)}distanceToPoint(point){let v1=this.V1||new Vector3;return this.V1=v1,v1.copy(point).clamp(this.min,this.max).sub(point).length()}getBoundingSphere(target=new Sphere){let v1=this.V1||new Vector3;return this.V1=v1,this.getCenter(target.center),target.radius=.5*this.getSize(v1).length(),target}intersect(box){return this.min.max(box.min),this.max.min(box.max),this.isEmpty()&&this.makeEmpty(),this}union(box){return this.min.min(box.min),this.max.max(box.max),this}applyMatrix4(matrix){if(this.isEmpty())return this;let m=matrix.elements,xax=m[0]*this.min.x,xay=m[1]*this.min.x,xaz=m[2]*this.min.x,xbx=m[0]*this.max.x,xby=m[1]*this.max.x,xbz=m[2]*this.max.x,yax=m[4]*this.min.y,yay=m[5]*this.min.y,yaz=m[6]*this.min.y,ybx=m[4]*this.max.y,yby=m[5]*this.max.y,ybz=m[6]*this.max.y,zax=m[8]*this.min.z,zay=m[9]*this.min.z,zaz=m[10]*this.min.z,zbx=m[8]*this.max.z,zby=m[9]*this.max.z,zbz=m[10]*this.max.z;return this.min.x=Math.min(xax,xbx)+Math.min(yax,ybx)+Math.min(zax,zbx)+m[12],this.min.y=Math.min(xay,xby)+Math.min(yay,yby)+Math.min(zay,zby)+m[13],this.min.z=Math.min(xaz,xbz)+Math.min(yaz,ybz)+Math.min(zaz,zbz)+m[14],this.max.x=Math.max(xax,xbx)+Math.max(yax,ybx)+Math.max(zax,zbx)+m[12],this.max.y=Math.max(xay,xby)+Math.max(yay,yby)+Math.max(zay,zby)+m[13],this.max.z=Math.max(xaz,xbz)+Math.max(yaz,ybz)+Math.max(zaz,zbz)+m[14],this}translate(offset){return this.min.add(offset),this.max.add(offset),this}equals(box){return box.min.equals(this.min)&&box.max.equals(this.max)}setFromBufferAttribute(attribute){let minX=1/0,minY=1/0,minZ=1/0,maxX=-1/0,maxY=-1/0,maxZ=-1/0;for(let i=0,l=attribute.count;i<l;i++){let x=attribute.array[3*i+0],y=attribute.array[3*i+1],z=attribute.array[3*i+2];x<minX&&(minX=x),y<minY&&(minY=y),z<minZ&&(minZ=z),x>maxX&&(maxX=x),y>maxY&&(maxY=y),z>maxZ&&(maxZ=z)}return this.min.set(minX,minY,minZ),this.max.set(maxX,maxY,maxZ),this}}class Color{constructor(r,g,b){return null==r&&null==g&&null==b?this.setRGB(1,1,1):void 0===g&&void 0===b?this.set(r):void this.setRGB(r,g,b)}set(value){return value&&value instanceof Color?this.copy(value):"number"==typeof value?this.setHex(value):"string"==typeof value&&this.setStyle(value),this}setScalar(scalar){return this.r=scalar,this.g=scalar,this.b=scalar,this}setHex(hex){return hex=Math.floor(hex),this.r=(hex>>16&255)/255,this.g=(hex>>8&255)/255,this.b=(255&hex)/255,this}setStyle(string){return this.setHex(Number(string.replace("#","0x")))}setRGB(r,g,b){return this.r=r,this.g=g,this.b=b,this}setHSL(h,s,l){function hue2rgb(p,q,t){return t<0&&(t+=1),t>1&&(t-=1),t<1/6?p+6*(q-p)*t:t<.5?q:t<2/3?p+6*(q-p)*(2/3-t):p}if(h=Math.euclideanModulo(h,1),s=Math.clamp(s,0,1),l=Math.clamp(l,0,1),0===s)this.r=this.g=this.b=l;else{let p=l<=.5?l*(1+s):l+s-l*s,q=2*l-p;this.r=hue2rgb(q,p,h+1/3),this.g=hue2rgb(q,p,h),this.b=hue2rgb(q,p,h-1/3)}return this}clone(){return new Color(this.r,this.g,this.b)}copy(color){return this.r=color.r,this.g=color.g,this.b=color.b,this}copyGammaToLinear(color,gammaFactor){return void 0===gammaFactor&&(gammaFactor=2),this.r=Math.pow(color.r,gammaFactor),this.g=Math.pow(color.g,gammaFactor),this.b=Math.pow(color.b,gammaFactor),this}copyLinearToGamma(color,gammaFactor){void 0===gammaFactor&&(gammaFactor=2);let safeInverse=gammaFactor>0?1/gammaFactor:1;return this.r=Math.pow(color.r,safeInverse),this.g=Math.pow(color.g,safeInverse),this.b=Math.pow(color.b,safeInverse),this}convertGammaToLinear(gammaFactor){return this.copyGammaToLinear(this,gammaFactor),this}convertLinearToGamma(gammaFactor){return this.copyLinearToGamma(this,gammaFactor),this}getHex(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0}getHexString(){return"#"+("000000"+this.getHex().toString(16)).slice(-6)}getHSL(){let target=this.target||{};this.target=target;let hue,saturation,r=this.r,g=this.g,b=this.b,max=Math.max(r,g,b),min=Math.min(r,g,b),lightness=(min+max)/2;if(min===max)hue=0,saturation=0;else{let delta=max-min;switch(saturation=lightness<=.5?delta/(max+min):delta/(2-max-min),max){case r:hue=(g-b)/delta+(g<b?6:0);break;case g:hue=(b-r)/delta+2;break;case b:hue=(r-g)/delta+4}hue/=6}return target.h=hue,target.s=saturation,target.l=lightness,target}tween(color,time,ease,delay){const _this=this;_this.tweenObj||(_this.tweenObj={v:0}),_this.tweenObj.v=0;let clone=this.clone();return TweenManager.tween(_this.tweenObj,{v:1},time,ease,delay).onUpdate(_=>{_this.copy(clone).lerp(color,_this.tweenObj.v)})}offsetHSL(h,s,l){let hsl=this.getHSL();return hsl.h+=h,hsl.s+=s,hsl.l+=l,this.setHSL(hsl.h,hsl.s,hsl.l),this}add(color){return this.r+=color.r,this.g+=color.g,this.b+=color.b,this}addColors(color1,color2){return this.r=color1.r+color2.r,this.g=color1.g+color2.g,this.b=color1.b+color2.b,this}addScalar(s){return this.r+=s,this.g+=s,this.b+=s,this}sub(color){return this.r=Math.max(0,this.r-color.r),this.g=Math.max(0,this.g-color.g),this.b=Math.max(0,this.b-color.b),this}multiply(color){return this.r*=color.r,this.g*=color.g,this.b*=color.b,this}multiplyScalar(s){return this.r*=s,this.g*=s,this.b*=s,this}invert(){return this.r=1-this.r,this.g=1-this.g,this.b=1-this.b,this}lerp(color,alpha){return this.r+=(color.r-this.r)*alpha,this.g+=(color.g-this.g)*alpha,this.b+=(color.b-this.b)*alpha,this}equals(c){return c.r===this.r&&c.g===this.g&&c.b===this.b}fromArray(array,offset){return void 0===offset&&(offset=0),this.r=array[offset],this.g=array[offset+1],this.b=array[offset+2],this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.r,array[offset+1]=this.g,array[offset+2]=this.b,array}}class Cylindrical{constructor(radius=1,theta=0,y=0){this.radius=radius,this.theta=theta,this.y=y}set(radius,theta,y){return this.radius=radius,this.theta=theta,this.y=y,this}clone(){return(new this.constructor).copy(this)}copy(other){return this.radius=other.radius,this.theta=other.theta,this.y=other.y,this}setFromVector3(vec3){return this.radius=Math.sqrt(vec3.x*vec3.x+vec3.z*vec3.z),this.theta=Math.atan2(vec3.x,vec3.z),this.y=vec3.y,this}}class Euler{constructor(x,y,z,order){this._x=x||0,this._y=y||0,this._z=z||0,this._order=order||"XYZ",this.isEuler=!0}set x(value){this._x=value,this.onChangeCallback()}get x(){return this._x}set y(value){this._y=value,this.onChangeCallback()}get y(){return this._y}set z(value){this._z=value,this.onChangeCallback()}get z(){return this._z}set order(value){this._order=value,this.onChangeCallback()}get order(){return this._order}set(x,y,z,order){return this._x=x,this._y=y,this._z=z,this._order=order||this._order,this.onChangeCallback(),this}clone(){return new Euler(this._x,this._y,this._z,this._order)}copy(euler){return this._x=euler._x,this._y=euler._y,this._z=euler._z,this._order=euler._order,this.onChangeCallback(),this}setFromRotationMatrix(m,order,update){let clamp=Math.clamp,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10];return"XYZ"===(order=order||this._order)?(this._y=Math.asin(clamp(m13,-1,1)),Math.abs(m13)<.99999?(this._x=Math.atan2(-m23,m33),this._z=Math.atan2(-m12,m11)):(this._x=Math.atan2(m32,m22),this._z=0)):"YXZ"===order?(this._x=Math.asin(-clamp(m23,-1,1)),Math.abs(m23)<.99999?(this._y=Math.atan2(m13,m33),this._z=Math.atan2(m21,m22)):(this._y=Math.atan2(-m31,m11),this._z=0)):"ZXY"===order?(this._x=Math.asin(clamp(m32,-1,1)),Math.abs(m32)<.99999?(this._y=Math.atan2(-m31,m33),this._z=Math.atan2(-m12,m22)):(this._y=0,this._z=Math.atan2(m21,m11))):"ZYX"===order?(this._y=Math.asin(-clamp(m31,-1,1)),Math.abs(m31)<.99999?(this._x=Math.atan2(m32,m33),this._z=Math.atan2(m21,m11)):(this._x=0,this._z=Math.atan2(-m12,m22))):"YZX"===order?(this._z=Math.asin(clamp(m21,-1,1)),Math.abs(m21)<.99999?(this._x=Math.atan2(-m23,m22),this._y=Math.atan2(-m31,m11)):(this._x=0,this._y=Math.atan2(m13,m33))):"XZY"===order&&(this._z=Math.asin(-clamp(m12,-1,1)),Math.abs(m12)<.99999?(this._x=Math.atan2(m32,m22),this._y=Math.atan2(m13,m11)):(this._x=Math.atan2(-m23,m33),this._y=0)),this._order=order,!1!==update&&this.onChangeCallback(),this}setFromQuaternion(q,order,update){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.makeRotationFromQuaternion(q),this.setFromRotationMatrix(matrix,order,update)}setFromVector3(v,order){return this.set(v.x,v.y,v.z,order||this._order)}reorder(newOrder){let q=this.Q1||new Quaternion;return this.Q1=q,q.setFromEuler(this),this.setFromQuaternion(q,newOrder)}lerp(euler,alpha){this._x+=(euler._x-this._x)*alpha,this._y+=(euler._y-this._y)*alpha,this._z+=(euler._z-this._z)*alpha,this.onChangeCallback()}equals(euler){return euler._x===this._x&&euler._y===this._y&&euler._z===this._z&&euler._order===this._order}fromArray(array){return this._x=array[0],this._y=array[1],this._z=array[2],void 0!==array[3]&&(this._order=array[3]),this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array[offset+3]=this._order,array}toVector3(optionalResult){return optionalResult?optionalResult.set(this._x,this._y,this._z):new Vector3(this._x,this._y,this._z)}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}Euler.DefaultOrder="XYZ",Euler.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"];class Frustum{constructor(p0,p1,p2,p3,p4,p5){this.planes=[void 0!==p0?p0:new Plane,void 0!==p1?p1:new Plane,void 0!==p2?p2:new Plane,void 0!==p3?p3:new Plane,void 0!==p4?p4:new Plane,void 0!==p5?p5:new Plane]}set(p0,p1,p2,p3,p4,p5){let planes=this.planes;return planes[0].copy(p0),planes[1].copy(p1),planes[2].copy(p2),planes[3].copy(p3),planes[4].copy(p4),planes[5].copy(p5),this}clone(){return(new Frustum).copy(this)}copy(frustum){let planes=this.planes;for(let i=0;i<6;i++)planes[i].copy(frustum.planes[i]);return this}setFromMatrix(m){let planes=this.planes,me=m.elements,me0=me[0],me1=me[1],me2=me[2],me3=me[3],me4=me[4],me5=me[5],me6=me[6],me7=me[7],me8=me[8],me9=me[9],me10=me[10],me11=me[11],me12=me[12],me13=me[13],me14=me[14],me15=me[15];return planes[0].setComponents(me3-me0,me7-me4,me11-me8,me15-me12).normalize(),planes[1].setComponents(me3+me0,me7+me4,me11+me8,me15+me12).normalize(),planes[2].setComponents(me3+me1,me7+me5,me11+me9,me15+me13).normalize(),planes[3].setComponents(me3-me1,me7-me5,me11-me9,me15-me13).normalize(),planes[4].setComponents(me3-me2,me7-me6,me11-me10,me15-me14).normalize(),planes[5].setComponents(me3+me2,me7+me6,me11+me10,me15+me14).normalize(),this}setFromCamera(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,camera.matrixWorldInverse),this.setFromMatrix(matrix)}intersectsObject(object){let sphere=this.S1||new Sphere;this.S1=sphere;let geometry=object.geometry;return null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere).applyMatrix4(object.matrixWorld),this.intersectsSphere(sphere)}intersectsSphere(sphere){let planes=this.planes,center=sphere.center,negRadius=-sphere.radius;for(let i=0;i<6;i++){if(planes[i].distanceToPoint(center)<negRadius)return!1}return!0}intersectsBox(box){let p1=this.V1||new Vector3,p2=this.V2||new Vector3;this.V1=p1,this.V2=p2;let planes=this.planes;for(let i=0;i<6;i++){let plane=planes[i];p1.x=plane.normal.x>0?box.min.x:box.max.x,p2.x=plane.normal.x>0?box.max.x:box.min.x,p1.y=plane.normal.y>0?box.min.y:box.max.y,p2.y=plane.normal.y>0?box.max.y:box.min.y,p1.z=plane.normal.z>0?box.min.z:box.max.z,p2.z=plane.normal.z>0?box.max.z:box.min.z;let d1=plane.distanceToPoint(p1),d2=plane.distanceToPoint(p2);if(d1<0&&d2<0)return!1}return!0}containsPoint(point){let planes=this.planes;for(let i=0;i<6;i++)if(planes[i].distanceToPoint(point)<0)return!1;return!0}}class Line3{constructor(start=new Vector3,end=new Vector3){this.start=start,this.end=end}set(start,end){return this.start.copy(start),this.end.copy(end),this}clone(){return(new this.constructor).copy(this)}copy(line){return this.start.copy(line.start),this.end.copy(line.end),this}getCenter(target=new Vector3){return target.addVectors(this.start,this.end).multiplyScalar(.5)}delta(target=new Vector3){return target.subVectors(this.end,this.start)}distanceSq(){return this.start.distanceToSquared(this.end)}distance(){return this.start.distanceTo(this.end)}at(t,target=new Vector3){return this.delta(target).multiplyScalar(t).add(this.start)}closestPointToPointParameter(point,clampToLine){let startP=this.V1||new Vector3,startEnd=this.V2||new Vector3;this.V1=startP,this.V2=startEnd,startP.subVectors(point,this.start),startEnd.subVectors(this.end,this.start);let startEnd2=startEnd.dot(startEnd),t=startEnd.dot(startP)/startEnd2;return clampToLine&&(t=Math.clamp(t,0,1)),t}closestPointToPoint(point,clampToLine,target=new Vector3){let t=this.closestPointToPointParameter(point,clampToLine);return this.delta(target).multiplyScalar(t).add(this.start)}applyMatrix4(matrix){return this.start.applyMatrix4(matrix),this.end.applyMatrix4(matrix),this}equals(line){return line.start.equals(this.start)&&line.end.equals(this.end)}}class Matrix3{constructor(){this.elements=new Float32Array([1,0,0,0,1,0,0,0,1])}set(n11,n12,n13,n21,n22,n23,n31,n32,n33){let te=this.elements;return te[0]=n11,te[1]=n21,te[2]=n31,te[3]=n12,te[4]=n22,te[5]=n32,te[6]=n13,te[7]=n23,te[8]=n33,this}identity(){return this.set(1,0,0,0,1,0,0,0,1),this}clone(){return(new Matrix3).fromArray(this.elements)}copy(m){let te=this.elements,me=m.elements;return te[0]=me[0],te[1]=me[1],te[2]=me[2],te[3]=me[3],te[4]=me[4],te[5]=me[5],te[6]=me[6],te[7]=me[7],te[8]=me[8],this}setFromMatrix4(m){let me=m.elements;return this.set(me[0],me[4],me[8],me[1],me[5],me[9],me[2],me[6],me[10]),this}multiply(m){return this.multiplyMatrices(this,m)}premultiply(m){return this.multiplyMatrices(m,this)}multiplyMatrices(a,b){let ae=a.elements,be=b.elements,te=this.elements,a11=ae[0],a12=ae[3],a13=ae[6],a21=ae[1],a22=ae[4],a23=ae[7],a31=ae[2],a32=ae[5],a33=ae[8],b11=be[0],b12=be[3],b13=be[6],b21=be[1],b22=be[4],b23=be[7],b31=be[2],b32=be[5],b33=be[8];return te[0]=a11*b11+a12*b21+a13*b31,te[3]=a11*b12+a12*b22+a13*b32,te[6]=a11*b13+a12*b23+a13*b33,te[1]=a21*b11+a22*b21+a23*b31,te[4]=a21*b12+a22*b22+a23*b32,te[7]=a21*b13+a22*b23+a23*b33,te[2]=a31*b11+a32*b21+a33*b31,te[5]=a31*b12+a32*b22+a33*b32,te[8]=a31*b13+a32*b23+a33*b33,this}multiplyScalar(s){let te=this.elements;return te[0]*=s,te[3]*=s,te[6]*=s,te[1]*=s,te[4]*=s,te[7]*=s,te[2]*=s,te[5]*=s,te[8]*=s,this}determinant(){let te=this.elements,a=te[0],b=te[1],c=te[2],d=te[3],e=te[4],f=te[5],g=te[6],h=te[7],i=te[8];return a*e*i-a*f*h-b*d*i+b*f*g+c*d*h-c*e*g}getInverse(matrix,throwOnDegenerate){let me=matrix.elements,te=this.elements,n11=me[0],n21=me[1],n31=me[2],n12=me[3],n22=me[4],n32=me[5],n13=me[6],n23=me[7],n33=me[8],t11=n33*n22-n32*n23,t12=n32*n13-n33*n12,t13=n23*n12-n22*n13,det=n11*t11+n21*t12+n31*t13;if(0===det){let msg=".getInverse() can't invert matrix, determinant is 0";if(!0===throwOnDegenerate)throw new Error(msg);return this.identity()}let detInv=1/det;return te[0]=t11*detInv,te[1]=(n31*n23-n33*n21)*detInv,te[2]=(n32*n21-n31*n22)*detInv,te[3]=t12*detInv,te[4]=(n33*n11-n31*n13)*detInv,te[5]=(n31*n12-n32*n11)*detInv,te[6]=t13*detInv,te[7]=(n21*n13-n23*n11)*detInv,te[8]=(n22*n11-n21*n12)*detInv,this}transpose(){let tmp,m=this.elements;return tmp=m[1],m[1]=m[3],m[3]=tmp,tmp=m[2],m[2]=m[6],m[6]=tmp,tmp=m[5],m[5]=m[7],m[7]=tmp,this}getNormalMatrix(matrix4){return this.setFromMatrix4(matrix4).getInverse(this).transpose()}setUvTransform(tx,ty,sx,sy,rotation,cx,cy){let c=Math.cos(rotation),s=Math.sin(rotation);this.set(sx*c,sx*s,-sx*(c*cx+s*cy)+cx+tx,-sy*s,sy*c,-sy*(-s*cx+c*cy)+cy+ty,0,0,1)}scale(sx,sy){let te=this.elements;return te[0]*=sx,te[3]*=sx,te[6]*=sx,te[1]*=sy,te[4]*=sy,te[7]*=sy,this}rotate(theta){let c=Math.cos(theta),s=Math.sin(theta),te=this.elements,a11=te[0],a12=te[3],a13=te[6],a21=te[1],a22=te[4],a23=te[7];return te[0]=c*a11+s*a21,te[3]=c*a12+s*a22,te[6]=c*a13+s*a23,te[1]=-s*a11+c*a21,te[4]=-s*a12+c*a22,te[7]=-s*a13+c*a23,this}translate(tx,ty){let te=this.elements;return te[0]+=tx*te[2],te[3]+=tx*te[5],te[6]+=tx*te[8],te[1]+=ty*te[2],te[4]+=ty*te[5],te[7]+=ty*te[8],this}equals(matrix){let te=this.elements,me=matrix.elements;for(let i=0;i<9;i++)if(te[i]!==me[i])return!1;return!0}fromArray(array,offset){void 0===offset&&(offset=0);for(let i=0;i<9;i++)this.elements[i]=array[i+offset];return this}toArray(array,offset){void 0===array&&(array=[]),void 0===offset&&(offset=0);let te=this.elements;return array[offset]=te[0],array[offset+1]=te[1],array[offset+2]=te[2],array[offset+3]=te[3],array[offset+4]=te[4],array[offset+5]=te[5],array[offset+6]=te[6],array[offset+7]=te[7],array[offset+8]=te[8],array}applyToBufferAttribute(attribute){let v1=this.V1||new Vector3;this.V1=v1;for(let i=0,l=attribute.count;i<l;i++)v1.x=attribute.array[3*i+0],v1.y=attribute.array[3*i+1],v1.z=attribute.array[3*i+2],v1.applyMatrix3(this),attribute.array[3*i+0]=v1.x,attribute.array[3*i+1]=v1.y,attribute.array[3*i+2]=v1.z;return attribute}}class Matrix4{constructor(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])}set(n11,n12,n13,n14,n21,n22,n23,n24,n31,n32,n33,n34,n41,n42,n43,n44){let te=this.elements;return te[0]=n11,te[4]=n12,te[8]=n13,te[12]=n14,te[1]=n21,te[5]=n22,te[9]=n23,te[13]=n24,te[2]=n31,te[6]=n32,te[10]=n33,te[14]=n34,te[3]=n41,te[7]=n42,te[11]=n43,te[15]=n44,this}identity(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this}clone(){return(new Matrix4).fromArray(this.elements)}copy(m){let te=this.elements,me=m.elements;return te[0]=me[0],te[1]=me[1],te[2]=me[2],te[3]=me[3],te[4]=me[4],te[5]=me[5],te[6]=me[6],te[7]=me[7],te[8]=me[8],te[9]=me[9],te[10]=me[10],te[11]=me[11],te[12]=me[12],te[13]=me[13],te[14]=me[14],te[15]=me[15],this}copyPosition(m){let te=this.elements,me=m.elements;return te[12]=me[12],te[13]=me[13],te[14]=me[14],this}extractBasis(xAxis,yAxis,zAxis){return xAxis.setFromMatrixColumn(this,0),yAxis.setFromMatrixColumn(this,1),zAxis.setFromMatrixColumn(this,2),this}makeBasis(xAxis,yAxis,zAxis){return this.set(xAxis.x,yAxis.x,zAxis.x,0,xAxis.y,yAxis.y,zAxis.y,0,xAxis.z,yAxis.z,zAxis.z,0,0,0,0,1),this}extractRotation(m){let v1=this.V1||new Vector3;this.V1=v1;let te=this.elements,me=m.elements,scaleX=1/v1.setFromMatrixColumn(m,0).length(),scaleY=1/v1.setFromMatrixColumn(m,1).length(),scaleZ=1/v1.setFromMatrixColumn(m,2).length();return te[0]=me[0]*scaleX,te[1]=me[1]*scaleX,te[2]=me[2]*scaleX,te[4]=me[4]*scaleY,te[5]=me[5]*scaleY,te[6]=me[6]*scaleY,te[8]=me[8]*scaleZ,te[9]=me[9]*scaleZ,te[10]=me[10]*scaleZ,this}makeRotationFromEuler(euler){let te=this.elements,x=euler.x,y=euler.y,z=euler.z,a=Math.cos(x),b=Math.sin(x),c=Math.cos(y),d=Math.sin(y),e=Math.cos(z),f=Math.sin(z);if("XYZ"===euler.order){let ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=-c*f,te[8]=d,te[1]=af+be*d,te[5]=ae-bf*d,te[9]=-b*c,te[2]=bf-ae*d,te[6]=be+af*d,te[10]=a*c}else if("YXZ"===euler.order){let ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce+df*b,te[4]=de*b-cf,te[8]=a*d,te[1]=a*f,te[5]=a*e,te[9]=-b,te[2]=cf*b-de,te[6]=df+ce*b,te[10]=a*c}else if("ZXY"===euler.order){let ce=c*e,cf=c*f,de=d*e,df=d*f;te[0]=ce-df*b,te[4]=-a*f,te[8]=de+cf*b,te[1]=cf+de*b,te[5]=a*e,te[9]=df-ce*b,te[2]=-a*d,te[6]=b,te[10]=a*c}else if("ZYX"===euler.order){let ae=a*e,af=a*f,be=b*e,bf=b*f;te[0]=c*e,te[4]=be*d-af,te[8]=ae*d+bf,te[1]=c*f,te[5]=bf*d+ae,te[9]=af*d-be,te[2]=-d,te[6]=b*c,te[10]=a*c}else if("YZX"===euler.order){let ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e,te[4]=bd-ac*f,te[8]=bc*f+ad,te[1]=f,te[5]=a*e,te[9]=-b*e,te[2]=-d*e,te[6]=ad*f+bc,te[10]=ac-bd*f}else if("XZY"===euler.order){let ac=a*c,ad=a*d,bc=b*c,bd=b*d;te[0]=c*e,te[4]=-f,te[8]=d*e,te[1]=ac*f+bd,te[5]=a*e,te[9]=ad*f-bc,te[2]=bc*f-ad,te[6]=b*e,te[10]=bd*f+ac}return te[3]=0,te[7]=0,te[11]=0,te[12]=0,te[13]=0,te[14]=0,te[15]=1,this}makeRotationFromQuaternion(q){let te=this.elements,x=q._x,y=q._y,z=q._z,w=q._w,x2=x+x,y2=y+y,z2=z+z,xx=x*x2,xy=x*y2,xz=x*z2,yy=y*y2,yz=y*z2,zz=z*z2,wx=w*x2,wy=w*y2,wz=w*z2;return te[0]=1-(yy+zz),te[4]=xy-wz,te[8]=xz+wy,te[1]=xy+wz,te[5]=1-(xx+zz),te[9]=yz-wx,te[2]=xz-wy,te[6]=yz+wx,te[10]=1-(xx+yy),te[3]=0,te[7]=0,te[11]=0,te[12]=0,te[13]=0,te[14]=0,te[15]=1,this}lookAt(eye,target,up){let x=this.V1||new Vector3,y=this.V2||new Vector3,z=this.V3||new Vector3;this.V1=x,this.V2=y,this.V3=z;let te=this.elements;return z.subVectors(eye,target),0===z.lengthSq()&&(z.z=1),z.normalize(),x.crossVectors(up,z),0===x.lengthSq()&&(1===Math.abs(up.z)?z.x+=1e-4:z.z+=1e-4,z.normalize(),x.crossVectors(up,z)),x.normalize(),y.crossVectors(z,x),te[0]=x.x,te[4]=y.x,te[8]=z.x,te[1]=x.y,te[5]=y.y,te[9]=z.y,te[2]=x.z,te[6]=y.z,te[10]=z.z,this}multiply(m){return this.multiplyMatrices(this,m)}premultiply(m){return this.multiplyMatrices(m,this)}multiplyMatrices(ae,be){let a=ae.elements,b=be.elements,out=this.elements,a00=a[0],a01=a[1],a02=a[2],a03=a[3],a10=a[4],a11=a[5],a12=a[6],a13=a[7],a20=a[8],a21=a[9],a22=a[10],a23=a[11],a30=a[12],a31=a[13],a32=a[14],a33=a[15],b0=b[0],b1=b[1],b2=b[2],b3=b[3];return out[0]=b0*a00+b1*a10+b2*a20+b3*a30,out[1]=b0*a01+b1*a11+b2*a21+b3*a31,out[2]=b0*a02+b1*a12+b2*a22+b3*a32,out[3]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[4],b1=b[5],b2=b[6],b3=b[7],out[4]=b0*a00+b1*a10+b2*a20+b3*a30,out[5]=b0*a01+b1*a11+b2*a21+b3*a31,out[6]=b0*a02+b1*a12+b2*a22+b3*a32,out[7]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[8],b1=b[9],b2=b[10],b3=b[11],out[8]=b0*a00+b1*a10+b2*a20+b3*a30,out[9]=b0*a01+b1*a11+b2*a21+b3*a31,out[10]=b0*a02+b1*a12+b2*a22+b3*a32,out[11]=b0*a03+b1*a13+b2*a23+b3*a33,b0=b[12],b1=b[13],b2=b[14],b3=b[15],out[12]=b0*a00+b1*a10+b2*a20+b3*a30,out[13]=b0*a01+b1*a11+b2*a21+b3*a31,out[14]=b0*a02+b1*a12+b2*a22+b3*a32,out[15]=b0*a03+b1*a13+b2*a23+b3*a33,this}multiplyScalar(s){let te=this.elements;return te[0]*=s,te[4]*=s,te[8]*=s,te[12]*=s,te[1]*=s,te[5]*=s,te[9]*=s,te[13]*=s,te[2]*=s,te[6]*=s,te[10]*=s,te[14]*=s,te[3]*=s,te[7]*=s,te[11]*=s,te[15]*=s,this}determinant(){let te=this.elements,n11=te[0],n12=te[4],n13=te[8],n14=te[12],n21=te[1],n22=te[5],n23=te[9],n24=te[13],n31=te[2],n32=te[6],n33=te[10],n34=te[14];return te[3]*(+n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34)+te[7]*(+n11*n23*n34-n11*n24*n33+n14*n21*n33-n13*n21*n34+n13*n24*n31-n14*n23*n31)+te[11]*(+n11*n24*n32-n11*n22*n34-n14*n21*n32+n12*n21*n34+n14*n22*n31-n12*n24*n31)+te[15]*(-n13*n22*n31-n11*n23*n32+n11*n22*n33+n13*n21*n32-n12*n21*n33+n12*n23*n31)}transpose(){let tmp,te=this.elements;return tmp=te[1],te[1]=te[4],te[4]=tmp,tmp=te[2],te[2]=te[8],te[8]=tmp,tmp=te[6],te[6]=te[9],te[9]=tmp,tmp=te[3],te[3]=te[12],te[12]=tmp,tmp=te[7],te[7]=te[13],te[13]=tmp,tmp=te[11],te[11]=te[14],te[14]=tmp,this}setPosition(v){let te=this.elements;return te[12]=v.x,te[13]=v.y,te[14]=v.z,this}getInverse(m,throwOnDegenerate){let te=this.elements,me=m.elements,n11=me[0],n21=me[1],n31=me[2],n41=me[3],n12=me[4],n22=me[5],n32=me[6],n42=me[7],n13=me[8],n23=me[9],n33=me[10],n43=me[11],n14=me[12],n24=me[13],n34=me[14],n44=me[15],t11=n23*n34*n42-n24*n33*n42+n24*n32*n43-n22*n34*n43-n23*n32*n44+n22*n33*n44,t12=n14*n33*n42-n13*n34*n42-n14*n32*n43+n12*n34*n43+n13*n32*n44-n12*n33*n44,t13=n13*n24*n42-n14*n23*n42+n14*n22*n43-n12*n24*n43-n13*n22*n44+n12*n23*n44,t14=n14*n23*n32-n13*n24*n32-n14*n22*n33+n12*n24*n33+n13*n22*n34-n12*n23*n34,det=n11*t11+n21*t12+n31*t13+n41*t14;if(0===det){let msg=".getInverse() can't invert matrix, determinant is 0";if(!0===throwOnDegenerate)throw new Error(msg);return this.identity()}let detInv=1/det;return te[0]=t11*detInv,te[1]=(n24*n33*n41-n23*n34*n41-n24*n31*n43+n21*n34*n43+n23*n31*n44-n21*n33*n44)*detInv,te[2]=(n22*n34*n41-n24*n32*n41+n24*n31*n42-n21*n34*n42-n22*n31*n44+n21*n32*n44)*detInv,te[3]=(n23*n32*n41-n22*n33*n41-n23*n31*n42+n21*n33*n42+n22*n31*n43-n21*n32*n43)*detInv,te[4]=t12*detInv,te[5]=(n13*n34*n41-n14*n33*n41+n14*n31*n43-n11*n34*n43-n13*n31*n44+n11*n33*n44)*detInv,te[6]=(n14*n32*n41-n12*n34*n41-n14*n31*n42+n11*n34*n42+n12*n31*n44-n11*n32*n44)*detInv,te[7]=(n12*n33*n41-n13*n32*n41+n13*n31*n42-n11*n33*n42-n12*n31*n43+n11*n32*n43)*detInv,te[8]=t13*detInv,te[9]=(n14*n23*n41-n13*n24*n41-n14*n21*n43+n11*n24*n43+n13*n21*n44-n11*n23*n44)*detInv,te[10]=(n12*n24*n41-n14*n22*n41+n14*n21*n42-n11*n24*n42-n12*n21*n44+n11*n22*n44)*detInv,te[11]=(n13*n22*n41-n12*n23*n41-n13*n21*n42+n11*n23*n42+n12*n21*n43-n11*n22*n43)*detInv,te[12]=t14*detInv,te[13]=(n13*n24*n31-n14*n23*n31+n14*n21*n33-n11*n24*n33-n13*n21*n34+n11*n23*n34)*detInv,te[14]=(n14*n22*n31-n12*n24*n31-n14*n21*n32+n11*n24*n32+n12*n21*n34-n11*n22*n34)*detInv,te[15]=(n12*n23*n31-n13*n22*n31+n13*n21*n32-n11*n23*n32-n12*n21*n33+n11*n22*n33)*detInv,this}scale(v){let te=this.elements,x=v.x,y=v.y,z=v.z;return te[0]*=x,te[4]*=y,te[8]*=z,te[1]*=x,te[5]*=y,te[9]*=z,te[2]*=x,te[6]*=y,te[10]*=z,te[3]*=x,te[7]*=y,te[11]*=z,this}getMaxScaleOnAxis(){let te=this.elements,scaleXSq=te[0]*te[0]+te[1]*te[1]+te[2]*te[2],scaleYSq=te[4]*te[4]+te[5]*te[5]+te[6]*te[6],scaleZSq=te[8]*te[8]+te[9]*te[9]+te[10]*te[10];return Math.sqrt(Math.max(scaleXSq,scaleYSq,scaleZSq))}makeTranslation(x,y,z){return this.set(1,0,0,x,0,1,0,y,0,0,1,z,0,0,0,1),this}makeRotationX(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(1,0,0,0,0,c,-s,0,0,s,c,0,0,0,0,1),this}makeRotationY(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(c,0,s,0,0,1,0,0,-s,0,c,0,0,0,0,1),this}makeRotationZ(theta){let c=Math.cos(theta),s=Math.sin(theta);return this.set(c,-s,0,0,s,c,0,0,0,0,1,0,0,0,0,1),this}makeRotationAxis(axis,angle){let c=Math.cos(angle),s=Math.sin(angle),t=1-c,x=axis.x,y=axis.y,z=axis.z,tx=t*x,ty=t*y;return this.set(tx*x+c,tx*y-s*z,tx*z+s*y,0,tx*y+s*z,ty*y+c,ty*z-s*x,0,tx*z-s*y,ty*z+s*x,t*z*z+c,0,0,0,0,1),this}makeScale(x,y,z){return this.set(x,0,0,0,0,y,0,0,0,0,z,0,0,0,0,1),this}makeShear(x,y,z){return this.set(1,y,z,0,x,1,z,0,x,y,1,0,0,0,0,1),this}compose(position,quaternion,scale){return this.makeRotationFromQuaternion(quaternion),this.scale(scale),this.setPosition(position),this}decompose(position,quaternion,scale){let vector=this.V1||new Vector3;this.V1=vector;let matrix=this.M1||new Matrix4;this.M1=matrix;let te=this.elements,sx=vector.set(te[0],te[1],te[2]).length(),sy=vector.set(te[4],te[5],te[6]).length(),sz=vector.set(te[8],te[9],te[10]).length();this.determinant()<0&&(sx=-sx),position.x=te[12],position.y=te[13],position.z=te[14],matrix.copy(this);let invSX=1/sx,invSY=1/sy,invSZ=1/sz;return matrix.elements[0]*=invSX,matrix.elements[1]*=invSX,matrix.elements[2]*=invSX,matrix.elements[4]*=invSY,matrix.elements[5]*=invSY,matrix.elements[6]*=invSY,matrix.elements[8]*=invSZ,matrix.elements[9]*=invSZ,matrix.elements[10]*=invSZ,quaternion.setFromRotationMatrix(matrix),scale.x=sx,scale.y=sy,scale.z=sz,this}makePerspective(left,right,top,bottom,near,far){let te=this.elements,x=2*near/(right-left),y=2*near/(top-bottom),a=(right+left)/(right-left),b=(top+bottom)/(top-bottom),c=-(far+near)/(far-near),d=-2*far*near/(far-near);return te[0]=x,te[4]=0,te[8]=a,te[12]=0,te[1]=0,te[5]=y,te[9]=b,te[13]=0,te[2]=0,te[6]=0,te[10]=c,te[14]=d,te[3]=0,te[7]=0,te[11]=-1,te[15]=0,this}makeOrthographic(left,right,top,bottom,near,far){let te=this.elements,w=1/(right-left),h=1/(top-bottom),p=1/(far-near),x=(right+left)*w,y=(top+bottom)*h,z=(far+near)*p;return te[0]=2*w,te[4]=0,te[8]=0,te[12]=-x,te[1]=0,te[5]=2*h,te[9]=0,te[13]=-y,te[2]=0,te[6]=0,te[10]=-2*p,te[14]=-z,te[3]=0,te[7]=0,te[11]=0,te[15]=1,this}equals(matrix){let te=this.elements,me=matrix.elements;return te[0]==me[0]&&(te[1]==me[1]&&(te[2]==me[2]&&(te[3]==me[3]&&(te[4]==me[4]&&(te[5]==me[5]&&(te[6]==me[6]&&(te[7]==me[7]&&(te[8]==me[8]&&(te[9]==me[9]&&(te[10]==me[10]&&(te[11]==me[11]&&(te[12]==me[12]&&(te[13]==me[13]&&(te[14]==me[14]&&te[15]==me[15]))))))))))))))}fromArray(array,offset=0){let te=this.elements;return te[0]=array[0+offset],te[1]=array[1+offset],te[2]=array[2+offset],te[3]=array[3+offset],te[4]=array[4+offset],te[5]=array[5+offset],te[6]=array[6+offset],te[7]=array[7+offset],te[8]=array[8+offset],te[9]=array[9+offset],te[10]=array[10+offset],te[11]=array[11+offset],te[12]=array[12+offset],te[13]=array[13+offset],te[14]=array[14+offset],te[15]=array[15+offset],this}toArray(array,offset){void 0===array&&(array=[]),void 0===offset&&(offset=0);let te=this.elements;return array[offset]=te[0],array[offset+1]=te[1],array[offset+2]=te[2],array[offset+3]=te[3],array[offset+4]=te[4],array[offset+5]=te[5],array[offset+6]=te[6],array[offset+7]=te[7],array[offset+8]=te[8],array[offset+9]=te[9],array[offset+10]=te[10],array[offset+11]=te[11],array[offset+12]=te[12],array[offset+13]=te[13],array[offset+14]=te[14],array[offset+15]=te[15],array}applyToBufferAttribute(attribute){let v1=this.V1||new Vector3;this.V1=v1;for(let i=0,l=attribute.count;i<l;i++)v1.x=attribute.array[3*i+0],v1.y=attribute.array[3*i+1],v1.z=attribute.array[3*i+2],v1.applyMatrix4(this),attribute.array[3*i+0]=v1.x,attribute.array[3*i+1]=v1.y,attribute.array[3*i+2]=v1.z;return attribute}isIdentity(){let te=this.elements;return 0==te[0]&&(0==te[1]&&(0==te[2]&&(1==te[3]&&(0==te[4]&&(0==te[5]&&(0==te[6]&&(1==te[7]&&(0==te[8]&&(0==te[9]&&(0==te[10]&&(1==te[11]&&(0==te[12]&&(0==te[13]&&(0==te[14]&&1==te[15]))))))))))))))}}Matrix4.__IDENTITY__=new Matrix4;class Plane{constructor(normal,constant){this.normal=void 0!==normal?normal:new Vector3(1,0,0),this.constant=void 0!==constant?constant:0}set(normal,constant){return this.normal.copy(normal),this.constant=constant,this}setComponents(x,y,z,w){return this.normal.set(x,y,z),this.constant=w,this}setFromNormalAndCoplanarPoint(normal,point){return this.normal.copy(normal),this.constant=-point.dot(this.normal),this}setFromCoplanarPoints(a,b,c){let v1=this.V1||new Vector3,v2=this.V2||new Vector3;this.V1=v1,this.V2=v2;var normal=v1.subVectors(c,b).cross(v2.subVectors(a,b)).normalize();return this.setFromNormalAndCoplanarPoint(normal,a),this}clone(){return(new Plane).copy(this)}copy(plane){return this.normal.copy(plane.normal),this.constant=plane.constant,this}normalize(){var inverseNormalLength=1/this.normal.length();return this.normal.multiplyScalar(inverseNormalLength),this.constant*=inverseNormalLength,this}negate(){return this.constant*=-1,this.normal.negate(),this}distanceToPoint(point){return this.normal.dot(point)+this.constant}distanceToSphere(sphere){return this.distanceToPoint(sphere.center)-sphere.radius}projectPoint(point,target){return target.copy(this.normal).multiplyScalar(-this.distanceToPoint(point)).add(point)}intersectLine(line,target){let v1=this.V1||new Vector3;this.V1=v1;var direction=line.delta(v1),denominator=this.normal.dot(direction);if(0===denominator)return 0===this.distanceToPoint(line.start)?target.copy(line.start):void 0;var t=-(line.start.dot(this.normal)+this.constant)/denominator;return t<0||t>1?void 0:target.copy(direction).multiplyScalar(t).add(line.start)}intersectsLine(line){var startSign=this.distanceToPoint(line.start),endSign=this.distanceToPoint(line.end);return startSign<0&&endSign>0||endSign<0&&startSign>0}intersectsBox(box){return box.intersectsPlane(this)}intersectsSphere(sphere){return sphere.intersectsPlane(this)}coplanarPoint(target){return target.copy(this.normal).multiplyScalar(-this.constant)}applyMatrix4(matrix,optionalNormalMatrix){let v1=this.V1||new Vector3;this.V1=v1;let m1=this.M1||new Matrix3;this.M1=m1;var normalMatrix=optionalNormalMatrix||m1.getNormalMatrix(matrix),referencePoint=this.coplanarPoint(v1).applyMatrix4(matrix),normal=this.normal.applyMatrix3(normalMatrix).normalize();return this.constant=-referencePoint.dot(normal),this}translate(offset){return this.constant-=offset.dot(this.normal),this}equals(plane){return plane.normal.equals(this.normal)&&plane.constant===this.constant}}class Quaternion{constructor(x,y,z,w){this._x=x||0,this._y=y||0,this._z=z||0,this._w=void 0!==w?w:1}set x(v){this._x=v,this.onChangeCallback&&this.onChangeCallback()}get x(){return this._x}set y(v){this._y=v,this.onChangeCallback&&this.onChangeCallback()}get y(){return this._y}set z(v){this._z=v,this.onChangeCallback&&this.onChangeCallback()}get z(){return this._z}set w(v){this._w=v,this.onChangeCallback&&this.onChangeCallback()}get w(){return this._w}clone(){return new Quaternion(this._x,this._y,this._z,this._w)}copy(quaternion){return this._x=quaternion.x,this._y=quaternion.y,this._z=quaternion.z,this._w=quaternion.w,this.onChangeCallback(),this}set(x,y,z,w){this._x=x,this._y=y,this._z=z,this._w=w,this.onChangeCallback()}setFromEuler(euler,update){let x=euler._x,y=euler._y,z=euler._z,order=euler.order,cos=Math.cos,sin=Math.sin,c1=cos(x/2),c2=cos(y/2),c3=cos(z/2),s1=sin(x/2),s2=sin(y/2),s3=sin(z/2);return"XYZ"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"YXZ"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3):"ZXY"===order?(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"ZYX"===order?(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3):"YZX"===order?(this._x=s1*c2*c3+c1*s2*s3,this._y=c1*s2*c3+s1*c2*s3,this._z=c1*c2*s3-s1*s2*c3,this._w=c1*c2*c3-s1*s2*s3):"XZY"===order&&(this._x=s1*c2*c3-c1*s2*s3,this._y=c1*s2*c3-s1*c2*s3,this._z=c1*c2*s3+s1*s2*c3,this._w=c1*c2*c3+s1*s2*s3),!1!==update&&this.onChangeCallback(),this}setFromAxisAngle(axis,angle){let halfAngle=angle/2,s=Math.sin(halfAngle);return this._x=axis.x*s,this._y=axis.y*s,this._z=axis.z*s,this._w=Math.cos(halfAngle),this.onChangeCallback(),this}setFromRotationMatrix(m){let s,te=m.elements,m11=te[0],m12=te[4],m13=te[8],m21=te[1],m22=te[5],m23=te[9],m31=te[2],m32=te[6],m33=te[10],trace=m11+m22+m33;return trace>0?(s=.5/Math.sqrt(trace+1),this._w=.25/s,this._x=(m32-m23)*s,this._y=(m13-m31)*s,this._z=(m21-m12)*s):m11>m22&&m11>m33?(s=2*Math.sqrt(1+m11-m22-m33),this._w=(m32-m23)/s,this._x=.25*s,this._y=(m12+m21)/s,this._z=(m13+m31)/s):m22>m33?(s=2*Math.sqrt(1+m22-m11-m33),this._w=(m13-m31)/s,this._x=(m12+m21)/s,this._y=.25*s,this._z=(m23+m32)/s):(s=2*Math.sqrt(1+m33-m11-m22),this._w=(m21-m12)/s,this._x=(m13+m31)/s,this._y=(m23+m32)/s,this._z=.25*s),this.onChangeCallback(),this}setFromUnitVectors(vFrom,vTo){let v1=this.V1||new Vector3;this.V1=v1;let r=vFrom.dot(vTo)+1;return r<1e-6?(r=0,Math.abs(vFrom.x)>Math.abs(vFrom.z)?v1.set(-vFrom.y,vFrom.x,0):v1.set(0,-vFrom.z,vFrom.y)):v1.crossVectors(vFrom,vTo),this._x=v1.x,this._y=v1.y,this._z=v1.z,this._w=r,this.normalize()}inverse(){return this.conjugate()}conjugate(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this}dot(v){return this._x*v._x+this._y*v._y+this._z*v._z+this._w*v._w}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)}normalize(){let l=this.length();return 0===l?(this._x=0,this._y=0,this._z=0,this._w=1):(l=1/l,this._x=this._x*l,this._y=this._y*l,this._z=this._z*l,this._w=this._w*l),this.onChangeCallback(),this}multiply(q){return this.multiplyQuaternions(this,q)}premultiply(q){return this.multiplyQuaternions(q,this)}multiplyQuaternions(a,b){let qax=a._x,qay=a._y,qaz=a._z,qaw=a._w,qbx=b._x,qby=b._y,qbz=b._z,qbw=b._w;return this._x=qax*qbw+qaw*qbx+qay*qbz-qaz*qby,this._y=qay*qbw+qaw*qby+qaz*qbx-qax*qbz,this._z=qaz*qbw+qaw*qbz+qax*qby-qay*qbx,this._w=qaw*qbw-qax*qbx-qay*qby-qaz*qbz,this.onChangeCallback(),this}slerp(qb,t,unlocked){if(unlocked||(t=Math.clamp(t*Render.HZ_MULTIPLIER,0,1)),0===t)return this;if(1===t)return this.copy(qb);let x=this._x,y=this._y,z=this._z,w=this._w,cosHalfTheta=w*qb._w+x*qb._x+y*qb._y+z*qb._z;if(cosHalfTheta<0?(this._w=-qb._w,this._x=-qb._x,this._y=-qb._y,this._z=-qb._z,cosHalfTheta=-cosHalfTheta):this.copy(qb),cosHalfTheta>=1)return this._w=w,this._x=x,this._y=y,this._z=z,this;let sinHalfTheta=Math.sqrt(1-cosHalfTheta*cosHalfTheta);if(Math.abs(sinHalfTheta)<.001)return this._w=.5*(w+this._w),this._x=.5*(x+this._x),this._y=.5*(y+this._y),this._z=.5*(z+this._z),this;let halfTheta=Math.atan2(sinHalfTheta,cosHalfTheta),ratioA=Math.sin((1-t)*halfTheta)/sinHalfTheta,ratioB=Math.sin(t*halfTheta)/sinHalfTheta;return this._w=w*ratioA+this._w*ratioB,this._x=x*ratioA+this._x*ratioB,this._y=y*ratioA+this._y*ratioB,this._z=z*ratioA+this._z*ratioB,this.onChangeCallback(),this}equals(quaternion){return quaternion._x===this._x&&quaternion._y===this._y&&quaternion._z===this._z&&quaternion._w===this._w}fromArray(array,offset){return void 0===offset&&(offset=0),this._x=array[offset],this._y=array[offset+1],this._z=array[offset+2],this._w=array[offset+3],this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array[offset+3]=this._w,array}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}class RayManager{constructor(origin,direction,near=0,far=1/0){this.ray=new Ray(origin,direction),this.near=near,this.far=far,this.params={Mesh:{},Points:{threshold:1}}}set(origin,direction){return this.ray.set(origin,direction),this}setFromCamera(coords,camera){camera.isPerspective?(this.ray.origin.setFromMatrixPosition(camera.matrixWorld),this.ray.direction.set(coords.x,coords.y,.5).unproject(camera).sub(this.ray.origin).normalize()):(this.ray.origin.set(coords.x,coords.y,(camera.near+camera.far)/(camera.near-camera.far)).unproject(camera),this.ray.direction.set(0,0,-1).transformDirection(camera.matrixWorld))}_ascSort(a,b){return a.distance-b.distance}_intersectObject(object,raycaster,intersects,recursive){if(!1!==object.visible&&(object.raycast(raycaster,intersects),!0===recursive)){let children=object.children;for(let i=0,l=children.length;i<l;i++)this._intersectObject(children[i],raycaster,intersects,!0)}}intersectObject(object,recursive,optionalTarget){let intersects=optionalTarget||[];return this._intersectObject(object,this,intersects,recursive),intersects.sort(this._ascSort),intersects}intersectObjects(objects,recursive,optionalTarget){let intersects=optionalTarget||[];for(let i=0,l=objects.length;i<l;i++)this._intersectObject(objects[i],this,intersects,recursive);return intersects.sort(this._ascSort),intersects}}class Ray{constructor(origin=new Vector3,direction=new Vector3){this.origin=origin,this.direction=direction}set(origin,direction){return this.origin.copy(origin),this.direction.copy(direction),this}clone(){return(new Ray).copy(this)}copy(ray){return this.origin.copy(ray.origin),this.direction.copy(ray.direction),this}at(t,target=new Vector3){return target.copy(this.direction).multiplyScalar(t).add(this.origin)}lookAt(v){return this.direction.copy(v).sub(this.origin).normalize(),this}recast(t){let v1=this.V1||new Vector3;this.V1=v1,this.origin.copy(this.at(t,v1))}closestPointToPoint(point,target=new Vector3){target.subVectors(point,this.origin);let directionDistance=target.dot(this.direction);return directionDistance<0?target.copy(this.origin):target.copy(this.direction).multiplyScalar(directionDistance).add(this.origin)}distanceToPoint(point){return Math.sqrt(this.distanceSqToPoint(point))}distanceSqToPoint(point){let v1=this.V1||new Vector3;this.V1=v1;let directionDistance=v1.subVectors(point,this.origin).dot(this.direction);return directionDistance<0?this.origin.distanceToSquared(point):(v1.copy(this.direction).multiplyScalar(directionDistance).add(this.origin),v1.distanceToSquared(point))}distanceSqToSegment(v0,v1,optionalPointOnRay,optionalPointOnSegment){let segCenter=this.V1||new Vector3,segDir=this.V2||new Vector3,diff=this.V3||new Vector3;this.V1=segCenter,this.V2=segDir,this.V3=diff,segCenter.copy(v0).add(v1).multiplyScalar(.5),segDir.copy(v1).sub(v0).normalize(),diff.copy(this.origin).sub(segCenter);let s0,s1,sqrDist,extDet,segExtent=.5*v0.distanceTo(v1),a01=-this.direction.dot(segDir),b0=diff.dot(this.direction),b1=-diff.dot(segDir),c=diff.lengthSq(),det=Math.abs(1-a01*a01);if(det>0)if(s0=a01*b1-b0,s1=a01*b0-b1,extDet=segExtent*det,s0>=0)if(s1>=-extDet)if(s1<=extDet){let invDet=1/det;s0*=invDet,s1*=invDet,sqrDist=s0*(s0+a01*s1+2*b0)+s1*(a01*s0+s1+2*b1)+c}else s1=segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;else s1=-segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;else s1<=-extDet?(s0=Math.max(0,-(-a01*segExtent+b0)),s1=s0>0?-segExtent:Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=-s0*s0+s1*(s1+2*b1)+c):s1<=extDet?(s0=0,s1=Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=s1*(s1+2*b1)+c):(s0=Math.max(0,-(a01*segExtent+b0)),s1=s0>0?segExtent:Math.min(Math.max(-segExtent,-b1),segExtent),sqrDist=-s0*s0+s1*(s1+2*b1)+c);else s1=a01>0?-segExtent:segExtent,s0=Math.max(0,-(a01*s1+b0)),sqrDist=-s0*s0+s1*(s1+2*b1)+c;return optionalPointOnRay&&optionalPointOnRay.copy(this.direction).multiplyScalar(s0).add(this.origin),optionalPointOnSegment&&optionalPointOnSegment.copy(segDir).multiplyScalar(s1).add(segCenter),sqrDist}intersectSphere(sphere,target){let v1=this.V1||new Vector3;this.V1=v1,v1.subVectors(sphere.center,this.origin);let tca=v1.dot(this.direction),d2=v1.dot(v1)-tca*tca,radius2=sphere.radius*sphere.radius;if(d2>radius2)return null;let thc=Math.sqrt(radius2-d2),t0=tca-thc,t1=tca+thc;return t0<0&&t1<0?null:t0<0?this.at(t1,target):this.at(t0,target)}intersectsSphere(sphere){return this.distanceToPoint(sphere.center)<=sphere.radius}distanceToPlane(plane){let denominator=plane.normal.dot(this.direction);if(0===denominator)return 0===plane.distanceToPoint(this.origin)?0:null;let t=-(this.origin.dot(plane.normal)+plane.constant)/denominator;return t>=0?t:null}intersectPlane(plane,target){let t=this.distanceToPlane(plane);return null===t?null:this.at(t,target)}intersectsPlane(plane){let distToPoint=plane.distanceToPoint(this.origin);return 0===distToPoint||plane.normal.dot(this.direction)*distToPoint<0}intersectBox(box,target){let tmin,tmax,tymin,tymax,tzmin,tzmax,invdirx=1/this.direction.x,invdiry=1/this.direction.y,invdirz=1/this.direction.z,origin=this.origin;return invdirx>=0?(tmin=(box.min.x-origin.x)*invdirx,tmax=(box.max.x-origin.x)*invdirx):(tmin=(box.max.x-origin.x)*invdirx,tmax=(box.min.x-origin.x)*invdirx),invdiry>=0?(tymin=(box.min.y-origin.y)*invdiry,tymax=(box.max.y-origin.y)*invdiry):(tymin=(box.max.y-origin.y)*invdiry,tymax=(box.min.y-origin.y)*invdiry),tmin>tymax||tymin>tmax?null:((tymin>tmin||tmin!=tmin)&&(tmin=tymin),(tymax<tmax||tmax!=tmax)&&(tmax=tymax),invdirz>=0?(tzmin=(box.min.z-origin.z)*invdirz,tzmax=(box.max.z-origin.z)*invdirz):(tzmin=(box.max.z-origin.z)*invdirz,tzmax=(box.min.z-origin.z)*invdirz),tmin>tzmax||tzmin>tmax?null:((tzmin>tmin||tmin!=tmin)&&(tmin=tzmin),(tzmax<tmax||tmax!=tmax)&&(tmax=tzmax),tmax<0?null:this.at(tmin>=0?tmin:tmax,target)))}intersectsBox(box){let v=this.V1||new Vector3;return this.V1=v,null!==this.intersectBox(box,v)}intersectsTriangle(a,b,c,backfaceCulling,target){let diff=this.V1||new Vector3,edge1=this.V2||new Vector3,edge2=this.V3||new Vector3,normal=this.V4||new Vector3;this.V1=diff,this.V2=edge1,this.V3=edge2,this.V4=normal,edge1.subVectors(b,a),edge2.subVectors(c,a),normal.crossVectors(edge1,edge2);let sign,DdN=this.direction.dot(normal);if(DdN>0){if(backfaceCulling)return null;sign=1}else{if(!(DdN<0))return null;sign=-1,DdN=-DdN}diff.subVectors(this.origin,a);let DdQxE2=sign*this.direction.dot(edge2.crossVectors(diff,edge2));if(DdQxE2<0)return null;let DdE1xQ=sign*this.direction.dot(edge1.cross(diff));if(DdE1xQ<0)return null;if(DdQxE2+DdE1xQ>DdN)return null;let QdN=-sign*diff.dot(normal);return QdN<0?null:this.at(QdN/DdN,target)}applyMatrix4(matrix4){return this.origin.applyMatrix4(matrix4),this.direction.transformDirection(matrix4),this}equals(ray){return ray.origin.equals(this.origin)&&ray.direction.equals(this.direction)}}class Sphere{constructor(center=new Vector3,radius=0){this.center=center,this.radius=radius}set(center,radius){return this.center.copy(center),this.radius=radius,this}setFromPoints(points,optionalCenter){let box=this.V1||new Box3;this.V1=box;let center=this.center;void 0!==optionalCenter?center.copy(optionalCenter):box.setFromPoints(points).getCenter(center);let maxRadiusSq=0;for(let i=0,il=points.length;i<il;i++)maxRadiusSq=Math.max(maxRadiusSq,center.distanceToSquared(points[i]));return this.radius=Math.sqrt(maxRadiusSq),this}clone(){return(new this.constructor).copy(this)}copy(sphere){return this.center.copy(sphere.center),this.radius=sphere.radius,this}empty(){return this.radius<=0}containsPoint(point){return point.distanceToSquared(this.center)<=this.radius*this.radius}distanceToPoint(point){return point.distanceTo(this.center)-this.radius}intersectsSphere(sphere){let radiusSum=this.radius+sphere.radius;return sphere.center.distanceToSquared(this.center)<=radiusSum*radiusSum}intersectsBox(box){return box.intersectsSphere(this)}intersectsPlane(plane){return Math.abs(plane.distanceToPoint(this.center))<=this.radius}clampPoint(point,target=new Vector3){let deltaLengthSq=this.center.distanceToSquared(point);return target.copy(point),deltaLengthSq>this.radius*this.radius&&(target.sub(this.center).normalize(),target.multiplyScalar(this.radius).add(this.center)),target}getBoundingBox(target=new Box3){return target.set(this.center,this.center),target.expandByScalar(this.radius),target}applyMatrix4(matrix){return this.center.applyMatrix4(matrix),this.radius=this.radius*matrix.getMaxScaleOnAxis(),this}translate(offset){return this.center.add(offset),this}equals(sphere){return sphere.center.equals(this.center)&&sphere.radius===this.radius}}class Spherical{constructor(radius=1,phi=0,theta=0){this.radius=radius,this.phi=phi,this.theta=theta}set(radius,phi,theta){return this.radius=radius,this.phi=phi,this.theta=theta,this}clone(){return(new Spherical).copy(this)}copy(other){return this.radius=other.radius,this.phi=other.phi,this.theta=other.theta,this}makeSafe(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this}setFromVector3(vec3){return this.radius=vec3.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(vec3.x,vec3.z),this.phi=Math.acos(Math.clamp(vec3.y/this.radius,-1,1))),this}}class Triangle{constructor(a=new Vector3,b=new Vector3,c=new Vector3){this.a=a,this.b=b,this.c=c}set(a,b,c){return this.a.copy(a),this.b.copy(b),this.c.copy(c),this}setFromPointsAndIndices(points,i0,i1,i2){return this.a.copy(points[i0]),this.b.copy(points[i1]),this.c.copy(points[i2]),this}clone(){return(new Triangle).copy(this)}copy(triangle){return this.a.copy(triangle.a),this.b.copy(triangle.b),this.c.copy(triangle.c),this}getArea(){let v0=this.V0||new Vector3,v1=this.V1||new Vector3;return this.V0=v0,this.V1=v1,v0.subVectors(this.c,this.b),v1.subVectors(this.a,this.b),.5*v0.cross(v1).length()}getMidpoint(target=new Vector3){return target.addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)}getNormal(target){return Triangle.getNormal(this.a,this.b,this.c,target)}getPlane(target=new Vector3){return target.setFromCoplanarPoints(this.a,this.b,this.c)}getBarycoord(point,target){return Triangle.getBarycoord(point,this.a,this.b,this.c,target)}containsPoint(point){return Triangle.containsPoint(point,this.a,this.b,this.c)}intersectsBox(box){return box.intersectsTriangle(this)}equals(triangle){return triangle.a.equals(this.a)&&triangle.b.equals(this.b)&&triangle.c.equals(this.c)}}class Vector2{constructor(x=0,y=0){this.x=x,this.y=y}set(x,y){return this.x=x,this.y=y,this}get width(){return this.x}get height(){return this.y}setScalar(s){return this.x=this.y=s,this}clone(){return new Vector2(this.x,this.y)}copy(v){return this.x=v.x,this.y=v.y,this}add(v){return this.x+=v.x,this.y+=v.y,this}addScalar(s){return this.x+=s,this.y+=s,this}addVectors(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this}addScaledVector(v,s){return this.x+=v.x*s,this.y+=v.y*s,this}sub(v){return this.x-=v.x,this.y-=v.y,this}subScalar(s){return this.x-=s,this.y-=s,this}subVectors(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this}multiply(v){return this.x*=v.x,this.y*=v.y,this}multiplyScalar(scalar){return this.x*=scalar,this.y*=scalar,this}divide(v){return this.x/=v.x,this.y/=v.y,this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}applyMatrix3(m){let x=this.x,y=this.y,e=m.elements;return this.x=e[0]*x+e[3]*y+e[6],this.y=e[1]*x+e[4]*y+e[7],this}min(v){return this.x=Math.min(this.x,v.x),this.y=Math.min(this.y,v.y),this}max(v){return this.x=Math.max(this.x,v.x),this.y=Math.max(this.y,v.y),this}clamp(min,max){return this.x=Math.max(min.x,Math.min(max.x,this.x)),this.y=Math.max(min.y,Math.min(max.y,this.y)),this}clampScalar(minVal,maxVal){let min=new Vector2,max=new Vector2;return min.set(minVal,minVal),max.set(maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this}negate(){return this.x=-this.x,this.y=-this.y,this}dot(v){return this.x*v.x+this.y*v.y}lengthSq(){return this.x*this.x+this.y*this.y}length(){return Math.sqrt(this.x*this.x+this.y*this.y)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)}normalize(){return this.divideScalar(this.length()||1)}angle(){let angle=Math.atan2(this.y,this.x);return angle<0&&(angle+=2*Math.PI),angle}angleTo(a,b){return b||(b=this),Math.atan2(a.y-b.y,a.x-b.x)}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this.x-v.x,dy=this.y-v.y;return dx*dx+dy*dy}manhattanDistanceTo(v){return Math.abs(this.x-v.x)+Math.abs(this.y-v.y)}setLength(length){return this.normalize().multiplyScalar(length)}lerp(v,alpha){return this.x=Math.lerp(v.x,this.x,alpha),this.y=Math.lerp(v.y,this.y,alpha),this}lerpVectors(v1,v2,alpha){return this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}equals(v){return v.x===this.x&&v.y===this.y}setAngleRadius(a,r){return this.x=Math.cos(a)*r,this.y=Math.sin(a)*r,this}addAngleRadius(a,r){return this.x+=Math.cos(a)*r,this.y+=Math.sin(a)*r,this}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array}rotateAround(center,angle){let c=Math.cos(angle),s=Math.sin(angle),x=this.x-center.x,y=this.y-center.y;return this.x=x*c-y*s+center.x,this.y=x*s+y*c+center.y,this}fromBufferAttribute(attribute,index){this.x=attribute.array[2*index+0],this.y=attribute.array[2*index+1]}}class Vector3{constructor(x,y,z){this.x=x||0,this.y=y||0,this.z=z||0}set(x,y,z){return this.x=x||0,this.y=y||0,this.z=z||0,this}setScalar(scalar){return this.x=scalar,this.y=scalar,this.z=scalar,this}clone(){return new Vector3(this.x,this.y,this.z)}copy(v){return this.x=v.x,this.y=v.y,this.z=v.z,this}add(v){return this.x+=v.x,this.y+=v.y,this.z+=v.z,this}addScalar(s){return this.x+=s,this.y+=s,this.z+=s,this}addVectors(a,b){return this.x=a.x+b.x,this.y=a.y+b.y,this.z=a.z+b.z,this}addScaledVector(v){return this.x+=v.x*s,this.y+=v.y*s,this.z+=v.z*s,this}sub(v){return this.x-=v.x,this.y-=v.y,this.z-=v.z,this}subScalar(s){return this.x-=s,this.y-=s,this.z-=s,this}subVectors(a,b){return this.x=a.x-b.x,this.y=a.y-b.y,this.z=a.z-b.z,this}multiply(v){return this.x*=v.x,this.y*=v.y,this.z*=v.z,this}multiplyScalar(scalar){return this.x*=scalar,this.y*=scalar,this.z*=scalar,this}multiplyVectors(a,b){return this.x=a.x*b.x,this.y=a.y*b.y,this.z=a.z*b.z,this}applyEuler(euler){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromEuler(euler))}applyAxisAngle(axis,angle){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromAxisAngle(axis,angle))}applyMatrix3(m){let x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[3]*y+e[6]*z,this.y=e[1]*x+e[4]*y+e[7]*z,this.z=e[2]*x+e[5]*y+e[8]*z,this}applyMatrix4(m){let x=this.x,y=this.y,z=this.z,e=m.elements,w=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);return this.x=(e[0]*x+e[4]*y+e[8]*z+e[12])*w,this.y=(e[1]*x+e[5]*y+e[9]*z+e[13])*w,this.z=(e[2]*x+e[6]*y+e[10]*z+e[14])*w,this}applyQuaternion(q){let x=this.x,y=this.y,z=this.z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this.x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this.y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this.z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this}project(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,matrix.getInverse(camera.matrixWorld)),this.applyMatrix4(matrix)}unproject(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.matrixWorld,matrix.getInverse(camera.projectionMatrix)),this.applyMatrix4(matrix)}transformDirection(m){let x=this.x,y=this.y,z=this.z,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z,this.y=e[1]*x+e[5]*y+e[9]*z,this.z=e[2]*x+e[6]*y+e[10]*z,this.normalize()}divide(v){return this.x/=v.x,this.y/=v.y,this.z/=v.z,this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}min(v){return this.x=Math.min(this.x,v.x),this.y=Math.min(this.y,v.y),this.z=Math.min(this.z,v.z),this}max(v){return this.x=Math.max(this.x,v.x),this.y=Math.max(this.y,v.y),this.z=Math.max(this.z,v.z),this}clamp(min,max){return this.x=Math.max(min.x,Math.min(max.x,this.x)),this.y=Math.max(min.y,Math.min(max.y,this.y)),this.z=Math.max(min.z,Math.min(max.z,this.z)),this}clampScalar(minVal,maxVal){let min=new Vector3,max=new Vector3;return min.set(minVal,minVal,minVal),max.set(maxVal,maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this}ceil(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this}round(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this}roundToZero(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this}negate(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this}dot(v){return this.x*v.x+this.y*v.y+this.z*v.z}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)}manhattanLength(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)}normalize(){return this.divideScalar(this.length()||1)}setLength(length){return this.normalize().multiplyScalar(length)}lerp(v,alpha,unlocked){return unlocked?(this.x+=(v.x-this.x)*alpha,this.y+=(v.y-this.y)*alpha,this.z+=(v.z-this.z)*alpha):(this.x=Math.lerp(v.x,this.x,alpha),this.y=Math.lerp(v.y,this.y,alpha),this.z=Math.lerp(v.z,this.z,alpha)),this}lerpVectors(v1,v2,alpha){return this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}cross(v){return this.crossVectors(this,v)}crossVectors(a,b){let ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this.x=ay*bz-az*by,this.y=az*bx-ax*bz,this.z=ax*by-ay*bx,this}projectOnVector(vector){let scalar=vector.dot(this)/vector.lengthSq();return this.copy(vector).multiplyScalar(scalar)}projectOnPlane(planeNormal){let v1=this.V1||new Vector3;return this.V1=v1,v1.copy(this).projectOnVector(planeNormal),this.sub(v1)}reflect(normal){let v1=this.V1||new Vector3;return this.V1=v1,this.sub(v1.copy(normal).multiplyScalar(2*this.dot(normal)))}angleTo(v){let theta=this.dot(v)/Math.sqrt(this.lengthSq()*v.lengthSq());return Math.acos(Math.clamp(theta,-1,1))}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this.x-v.x,dy=this.y-v.y,dz=this.z-v.z;return dx*dx+dy*dy+dz*dz}manhattanDistanceTo(v){return Math.abs(this.x-v.x)+Math.abs(this.y-v.y)+Math.abs(this.z-v.z)}setFromSpherical(s){let sinPhiRadius=Math.sin(s.phi)*s.radius;return this.x=sinPhiRadius*Math.sin(s.theta),this.y=Math.cos(s.phi)*s.radius,this.z=sinPhiRadius*Math.cos(s.theta),this}setFromCylindrical(c){return this.x=c.radius*Math.sin(c.theta),this.y=c.y,this.z=c.radius*Math.cos(c.theta),this}setFromMatrixPosition(m){let e=m.elements;return this.x=e[12],this.y=e[13],this.z=e[14],this}setFromMatrixScale(m){let sx=this.setFromMatrixColumn(m,0).length(),sy=this.setFromMatrixColumn(m,1).length(),sz=this.setFromMatrixColumn(m,2).length();return this.x=sx,this.y=sy,this.z=sz,this}setFromMatrixColumn(m,index){return this.fromArray(m.elements,4*index)}setAngleRadius(a,r,dir="xy"){return this[dir[0]]=Math.cos(a)*r,this[dir[1]]=Math.sin(a)*r,this}addAngleRadius(a,r,dir="xy"){return this[dir[0]]+=Math.cos(a)*r,this[dir[1]]+=Math.sin(a)*r,this}equals(v){return v.x===this.x&&v.y===this.y&&v.z===this.z}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this.z=array[offset+2],this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array[offset+2]=this.z,array}fromBufferAttribute(attribute,index){return this.x=attribute.array[3*index+0],this.y=attribute.array[3*index+1],this.z=attribute.array[3*index+2],this}}class Vector3D{constructor(x,y,z){this._x=x||0,this._y=y||0,this._z=z||0}get x(){return this._x}set x(v){if(Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._x-v)>1e-4&&this.onChangeCallback(),this._x=v}get y(){return this._y}set y(v){if(Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._y-v)>1e-4&&this.onChangeCallback(),this._y=v}get z(){return this._z}set z(v){if(Hydra.LOCAL&&isNaN(v))return console.trace("Vector3D::NaN");Math.abs(this._z-v)>1e-4&&this.onChangeCallback(),this._z=v}onChangeCallback(){}set(x,y,z){return this._x=x||0,this._y=y||0,this._z=z||0,this.onChangeCallback(),this}setScalar(scalar){return this._x=scalar,this._y=scalar,this._z=scalar,this.onChangeCallback(),this}clone(){return new Vector3(this._x,this._y,this._z)}copy(v){let dirty=Math.abs(this._x-v.x)>1e-4||Math.abs(this._y-v.y)>1e-4||Math.abs(this._z-v.z)>1e-4;return this._x=v.x,this._y=v.y,this._z=v.z,dirty&&this.onChangeCallback(),this}add(v){return this._x+=v.x,this._y+=v.y,this._z+=v.z,this.onChangeCallback(),this}addScalar(s){return this._x+=s,this._y+=s,this._z+=s,this.onChangeCallback(),this}addVectors(a,b){return this._x=a.x+b.x,this._y=a.y+b.y,this._z=a.z+b.z,this.onChangeCallback(),this}addScaledVector(v){return this._x+=v.x*s,this._y+=v.y*s,this._z+=v.z*s,this.onChangeCallback(),this}sub(v){return this._x-=v.x,this._y-=v.y,this._z-=v.z,this.onChangeCallback(),this}subScalar(s){return this._x-=s,this._y-=s,this._z-=s,this.onChangeCallback(),this}subVectors(a,b){return this._x=a.x-b.x,this._y=a.y-b.y,this._z=a.z-b.z,this.onChangeCallback(),this}multiply(v){return this._x*=v.x,this._y*=v.y,this._z*=v.z,this.onChangeCallback(),this}multiplyScalar(scalar){return this._x*=scalar,this._y*=scalar,this._z*=scalar,this.onChangeCallback(),this}multiplyVectors(a,b){return this._x=a.x*b.x,this._y=a.y*b.y,this._z=a.z*b.z,this.onChangeCallback(),this}applyEuler(euler){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromEuler(euler))}applyAxisAngle(axis,angle){let quaternion=this.Q1||new Quaternion;return this.Q1=quaternion,this.applyQuaternion(quaternion.setFromAxisAngle(axis,angle))}applyMatrix3(m){let x=this._x,y=this._y,z=this._z,e=m.elements;return this._x=e[0]*x+e[3]*y+e[6]*z,this._y=e[1]*x+e[4]*y+e[7]*z,this._z=e[2]*x+e[5]*y+e[8]*z,this.onChangeCallback(),this}applyMatrix4(m){let x=this._x,y=this._y,z=this._z,e=m.elements,w=1/(e[3]*x+e[7]*y+e[11]*z+e[15]);return this._x=(e[0]*x+e[4]*y+e[8]*z+e[12])*w,this._y=(e[1]*x+e[5]*y+e[9]*z+e[13])*w,this._z=(e[2]*x+e[6]*y+e[10]*z+e[14])*w,this.onChangeCallback(),this}applyQuaternion(q){let x=this._x,y=this._y,z=this._z,qx=q.x,qy=q.y,qz=q.z,qw=q.w,ix=qw*x+qy*z-qz*y,iy=qw*y+qz*x-qx*z,iz=qw*z+qx*y-qy*x,iw=-qx*x-qy*y-qz*z;return this._x=ix*qw+iw*-qx+iy*-qz-iz*-qy,this._y=iy*qw+iw*-qy+iz*-qx-ix*-qz,this._z=iz*qw+iw*-qz+ix*-qy-iy*-qx,this.onChangeCallback(),this}project(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.projectionMatrix,matrix.getInverse(camera.matrixWorld)),this.applyMatrix4(matrix)}unproject(camera){let matrix=this.M1||new Matrix4;return this.M1=matrix,matrix.multiplyMatrices(camera.matrixWorld,matrix.getInverse(camera.projectionMatrix)),this.applyMatrix4(matrix)}transformDirection(m){let x=this._x,y=this._y,z=this._z,e=m.elements;return this._x=e[0]*x+e[4]*y+e[8]*z,this._y=e[1]*x+e[5]*y+e[9]*z,this._z=e[2]*x+e[6]*y+e[10]*z,this.onChangeCallback(),this.normalize()}divide(v){return this._x/=v.x,this._y/=v.y,this._z/=v.z,this.onChangeCallback(),this}divideScalar(scalar){return this.multiplyScalar(1/scalar)}min(v){return this._x=Math.min(this._x,v.x),this._y=Math.min(this._y,v.y),this._z=Math.min(this._z,v.z),this.onChangeCallback(),this}max(v){return this._x=Math.max(this._x,v.x),this._y=Math.max(this._y,v.y),this._z=Math.max(this._z,v.z),this}clamp(min,max){return this._x=Math.max(min.x,Math.min(max.x,this._x)),this._y=Math.max(min.y,Math.min(max.y,this._y)),this._z=Math.max(min.z,Math.min(max.z,this._z)),this}clampScalar(minVal,maxVal){let min=new Vector3,max=new Vector3;return min.set(minVal,minVal,minVal),max.set(maxVal,maxVal,maxVal),this.clamp(min,max)}clampLength(min,max){let length=this.length();return this.divideScalar(length||1).multiplyScalar(Math.max(min,Math.min(max,length)))}floor(){return this._x=Math.floor(this._x),this._y=Math.floor(this._y),this._z=Math.floor(this._z),this.onChangeCallback(),this}ceil(){return this._x=Math.ceil(this._x),this._y=Math.ceil(this._y),this._z=Math.ceil(this._z),this.onChangeCallback(),this}round(){return this._x=Math.round(this._x),this._y=Math.round(this._y),this._z=Math.round(this._z),this.onChangeCallback(),this}roundToZero(){return this._x=this._x<0?Math.ceil(this._x):Math.floor(this._x),this._y=this._y<0?Math.ceil(this._y):Math.floor(this._y),this._z=this._z<0?Math.ceil(this._z):Math.floor(this._z),this.onChangeCallback(),this}negate(){return this._x=-this._x,this._y=-this._y,this._z=-this._z,this.onChangeCallback(),this}dot(v){return this._x*v.x+this._y*v.y+this._z*v.z}lengthSq(){return this._x*this._x+this._y*this._y+this._z*this._z}length(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z)}manhattanLength(){return Math.abs(this._x)+Math.abs(this._y)+Math.abs(this._z)}normalize(){return this.onChangeCallback(),this.divideScalar(this.length()||1)}setLength(length){return this.onChangeCallback(),this.normalize().multiplyScalar(length)}lerp(v,alpha,unlocked){return unlocked?(this.x+=(v.x-this.x)*alpha,this.y+=(v.y-this.y)*alpha,this.z+=(v.z-this.z)*alpha):(this.x=Math.lerp(v.x,this.x,alpha),this.y=Math.lerp(v.y,this.y,alpha),this.z=Math.lerp(v.z,this.z,alpha)),this.onChangeCallback(),this}lerpVectors(v1,v2,alpha){return this.onChangeCallback(),this.subVectors(v2,v1).multiplyScalar(alpha).add(v1)}cross(v){return this.crossVectors(this,v)}crossVectors(a,b){let ax=a.x,ay=a.y,az=a.z,bx=b.x,by=b.y,bz=b.z;return this._x=ay*bz-az*by,this._y=az*bx-ax*bz,this._z=ax*by-ay*bx,this.onChangeCallback(),this}projectOnVector(vector){let scalar=vector.dot(this)/vector.lengthSq();return this.copy(vector).multiplyScalar(scalar)}projectOnPlane(planeNormal){let v1=this.V1||new Vector3;return this.V1=v1,this.onChangeCallback(),v1.copy(this).projectOnVector(planeNormal),this.sub(v1)}reflect(normal){let v1=this.V1||new Vector3;return this.V1=v1,this.onChangeCallback(),this.sub(v1.copy(normal).multiplyScalar(2*this.dot(normal)))}angleTo(v){let theta=this.dot(v)/Math.sqrt(this.lengthSq()*v.lengthSq());return Math.acos(Math.clamp(theta,-1,1))}distanceTo(v){return Math.sqrt(this.distanceToSquared(v))}distanceToSquared(v){let dx=this._x-v.x,dy=this._y-v.y,dz=this._z-v.z;return dx*dx+dy*dy+dz*dz}manhattanDistanceTo(v){return Math.abs(this._x-v.x)+Math.abs(this._y-v.y)+Math.abs(this._z-v.z)}setFromSpherical(s){let sinPhiRadius=Math.sin(s.phi)*s.radius;return this._x=sinPhiRadius*Math.sin(s.theta),this._y=Math.cos(s.phi)*s.radius,this._z=sinPhiRadius*Math.cos(s.theta),this.onChangeCallback(),this}setFromCylindrical(c){return this._x=c.radius*Math.sin(c.theta),this._y=c.y,this._z=c.radius*Math.cos(c.theta),this.onChangeCallback(),this}setFromMatrixPosition(m){let e=m.elements;return this._x=e[12],this._y=e[13],this._z=e[14],this.onChangeCallback(),this}setFromMatrixScale(m){let sx=this.setFromMatrixColumn(m,0).length(),sy=this.setFromMatrixColumn(m,1).length(),sz=this.setFromMatrixColumn(m,2).length();return this.onChangeCallback(),this._x=sx,this._y=sy,this._z=sz,this}setFromMatrixColumn(m,index){return this.onChangeCallback(),this.fromArray(m.elements,4*index)}equals(v){return v.x===this._x&&v.y===this._y&&v.z===this._z}fromArray(array,offset){return void 0===offset&&(offset=0),this._x=array[offset],this._y=array[offset+1],this._z=array[offset+2],this.onChangeCallback(),this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this._x,array[offset+1]=this._y,array[offset+2]=this._z,array}fromBufferAttribute(attribute,index){this._x=attribute.array[3*index+0],this._y=attribute.array[3*index+1],this._z=attribute.array[3*index+2],this.onChangeCallback()}onChange(callback){this.onChangeCallback=callback}onChangeCallback(){}}class Vector4{constructor(x=0,y=0,z=0,w=0){this.x=x,this.y=y,this.z=z,this.w=w}multiplyScalar(s){return this.x*=s,this.y*=s,this.z*=s,this.w*=s,this}set(x,y,z,w){return this.x=x,this.y=y,this.z=z,this.w=w,this}copy(v){return this.x=v.x,this.y=v.y,this.z=v.z,this.w=v.w,this}dot(v){return this.x*v.x+this.y*v.y+this.z*v.z+this.w*v.w}length(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)}lengthSq(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w}applyMatrix4(m){let x=this.x,y=this.y,z=this.z,w=this.w,e=m.elements;return this.x=e[0]*x+e[4]*y+e[8]*z+e[12]*w,this.y=e[1]*x+e[5]*y+e[9]*z+e[13]*w,this.z=e[2]*x+e[6]*y+e[10]*z+e[14]*w,this.w=e[3]*x+e[7]*y+e[11]*z+e[15]*w,this}toArray(array,offset){return void 0===array&&(array=[]),void 0===offset&&(offset=0),array[offset]=this.x,array[offset+1]=this.y,array[offset+2]=this.z,array[offset+3]=this.w,array}fromArray(array,offset){return void 0===offset&&(offset=0),this.x=array[offset],this.y=array[offset+1],this.z=array[offset+2],this.w=array[offset+3],this}set width(v){this.z=v}set height(v){this.w=v}get width(){return this.z}get height(){return this.w}}class Face3{constructor(a,b,c,normal=new Vector3){this.a=a,this.b=b,this.c=c,this.normal=normal}}Class((function zUtils3D(){var diff,edge1,edge2,normal,v1,v0;Math.euclideanModulo=function(n,m){return(n%m+m)%m},Math.isPowerOf2=function(w,h){let test=value=>0==(value&value-1);return test(w)&&test(h)},Math.floorPowerOf2=function(value){return Math.pow(2,Math.floor(Math.log(value)/Math.LN2))},Geometry.TYPES={SphereGeometry:SphereGeometry,IcosahedronGeometry:IcosahedronGeometry,BoxGeometry:BoxGeometry,PlaneGeometry:PlaneGeometry,CylinderGeometry:CylinderGeometry},Matrix4.prototype.isMatrix4=!0,Matrix3.prototype.isMatrix3=!0,Vector3.prototype.isVector3=!0,Vector2.prototype.isVector2=!0,CameraBase3D.prototype.isCamera=!0,PerspectiveCamera.prototype.isPerspective=!0,window.THREAD&&(Shader={FRONT_SIDE:"shader_front_side",BACK_SIDE:"shader_back_side",DOUBLE_SIDE:"shader_double_side"}),Ray.prototype.intersectTriangle=(diff=new Vector3,edge1=new Vector3,edge2=new Vector3,normal=new Vector3,function intersectTriangle(a,b,c,backfaceCulling,target){edge1.subVectors(b,a),edge2.subVectors(c,a),normal.crossVectors(edge1,edge2);var sign,DdN=this.direction.dot(normal);if(DdN>0){if(backfaceCulling)return null;sign=1}else{if(!(DdN<0))return null;sign=-1,DdN=-DdN}diff.subVectors(this.origin,a);var DdQxE2=sign*this.direction.dot(edge2.crossVectors(diff,edge2));if(DdQxE2<0)return null;var DdE1xQ=sign*this.direction.dot(edge1.cross(diff));if(DdE1xQ<0)return null;if(DdQxE2+DdE1xQ>DdN)return null;var QdN=-sign*diff.dot(normal);return QdN<0?null:this.at(QdN/DdN,target)}),Mesh.prototype.raycast=function(){let inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere,vA=new Vector3,vB=new Vector3,vC=new Vector3,uvA=(new Vector3,new Vector3,new Vector3,new Vector3,new Vector2),uvB=new Vector2,uvC=new Vector2,barycoord=new Vector3,intersectionPoint=new Vector3,intersectionPointWorld=new Vector3;function checkBufferGeometryIntersection(object,raycaster,ray,position,uv,a,b,c){vA.fromBufferAttribute(position,a),vB.fromBufferAttribute(position,b),vC.fromBufferAttribute(position,c);let intersection=function checkIntersection(object,shader,raycaster,ray,pA,pB,pC,point){let intersect;if(intersect=shader.side===Shader.BACK_SIDE?ray.intersectTriangle(pC,pB,pA,!0,point):ray.intersectTriangle(pA,pB,pC,shader.side!==Shader.DOUBLE_SIDE,point),null===intersect)return null;intersectionPointWorld.copy(point),intersectionPointWorld.applyMatrix4(object.matrixWorld);let distance=raycaster.ray.origin.distanceTo(intersectionPointWorld);return distance<raycaster.near||distance>raycaster.far?null:{distance:distance,point:intersectionPointWorld.clone(),object:object}}(object,object.shader,raycaster,ray,vA,vB,vC,intersectionPoint);if(intersection){uv&&(uvA.fromBufferAttribute(uv,a),uvB.fromBufferAttribute(uv,b),uvC.fromBufferAttribute(uv,c),intersection.uv=function uvIntersection(point,p1,p2,p3,uv1,uv2,uv3){return Triangle.getBarycoord(point,p1,p2,p3,barycoord),uv1.multiplyScalar(barycoord.x),uv2.multiplyScalar(barycoord.y),uv3.multiplyScalar(barycoord.z),uv1.add(uv2).add(uv3),uv1.clone()}(intersectionPoint,vA,vB,vC,uvA,uvB,uvC));let face=new Face3(a,b,c);Triangle.getNormal(vA,vB,vC,face.normal),intersection.face=face}return intersection}return function raycast(raycaster,intersects){let intersection,a,b,c,geometry=this.geometry,shader=this.shader,matrixWorld=this.matrixWorld;if(void 0===shader)return;if(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere),sphere.applyMatrix4(matrixWorld),!1===raycaster.ray.intersectsSphere(sphere))return;if(inverseMatrix.getInverse(matrixWorld),ray.copy(raycaster.ray).applyMatrix4(inverseMatrix),null!==geometry.boundingBox&&!1===ray.intersectsBox(geometry.boundingBox))return;let i,l,index=geometry.index,position=geometry.attributes.position,uv=geometry.attributes.uv;if(null!==index)for(i=0,l=index.length;i<l;i+=3)a=index[i],b=index[i+1],c=index[i+2],intersection=checkBufferGeometryIntersection(this,raycaster,ray,position,uv,a,b,c),intersection&&(intersection.faceIndex=Math.floor(i/3),intersects.push(intersection));else if(void 0!==position)for(i=0,l=position.count;i<l;i+=3)a=i,b=i+1,c=i+2,intersection=checkBufferGeometryIntersection(this,raycaster,ray,position,uv,a,b,c),intersection&&(intersection.faceIndex=Math.floor(i/3),intersects.push(intersection))}}(),Triangle.prototype.closestPointToPoint=function(){let plane=new Plane,edgeList=[new Line3,new Line3,new Line3],projectedPoint=new Vector3,closestPoint=new Vector3;return function closestPointToPoint(point,target=new Vector3){let minDistance=1/0;if(plane.setFromCoplanarPoints(this.a,this.b,this.c),plane.projectPoint(point,projectedPoint),!0===this.containsPoint(projectedPoint))target.copy(projectedPoint);else{edgeList[0].set(this.a,this.b),edgeList[1].set(this.b,this.c),edgeList[2].set(this.c,this.a);for(let i=0;i<edgeList.length;i++){edgeList[i].closestPointToPoint(projectedPoint,!0,closestPoint);let distance=projectedPoint.distanceToSquared(closestPoint);distance<minDistance&&(minDistance=distance,target.copy(closestPoint))}}return target}}(),Points.prototype.raycast=function(){let inverseMatrix=new Matrix4,ray=new Ray,sphere=new Sphere;return function raycast(raycaster,intersects){let object=this,geometry=this.geometry,matrixWorld=this.matrixWorld,threshold=raycaster.params.Points.threshold;if(null===geometry.boundingSphere&&geometry.computeBoundingSphere(),sphere.copy(geometry.boundingSphere),sphere.applyMatrix4(matrixWorld),sphere.radius+=threshold,!1===raycaster.ray.intersectsSphere(sphere))return;inverseMatrix.getInverse(matrixWorld),ray.copy(raycaster.ray).applyMatrix4(inverseMatrix);let localThreshold=threshold/((this.scale.x+this.scale.y+this.scale.z)/3),localThresholdSq=localThreshold*localThreshold,position=new Vector3,intersectPoint=new Vector3;function testPoint(point,index){let rayPointDistanceSq=ray.distanceSqToPoint(point);if(rayPointDistanceSq<localThresholdSq){ray.closestPointToPoint(point,intersectPoint),intersectPoint.applyMatrix4(matrixWorld);let distance=raycaster.ray.origin.distanceTo(intersectPoint);if(distance<raycaster.near||distance>raycaster.far)return;intersects.push({distance:distance,distanceToRay:Math.sqrt(rayPointDistanceSq),point:intersectPoint.clone(),index:index,face:null,object:object})}}let index=geometry.index,positions=geometry.attributes.position.array;if(null!==index){let indices=index.array;for(let i=0,il=indices.length;i<il;i++){let a=indices[i];position.fromArray(positions,3*a),testPoint(position,a)}}else for(let i=0,l=positions.length/3;i<l;i++)position.fromArray(positions,3*i),testPoint(position,i)}}(),Object.assign(Triangle,{getNormal:(v0=new Vector3,function getNormal(a,b,c,target=new Vector3){target.subVectors(c,b),v0.subVectors(a,b),target.cross(v0);var targetLengthSq=target.lengthSq();return targetLengthSq>0?target.multiplyScalar(1/Math.sqrt(targetLengthSq)):target.set(0,0,0)}),getBarycoord:function(){var v0=new Vector3,v1=new Vector3,v2=new Vector3;return function getBarycoord(point,a,b,c,target=new Vector3){v0.subVectors(c,a),v1.subVectors(b,a),v2.subVectors(point,a);var dot00=v0.dot(v0),dot01=v0.dot(v1),dot02=v0.dot(v2),dot11=v1.dot(v1),dot12=v1.dot(v2),denom=dot00*dot11-dot01*dot01;if(0===denom)return target.set(-2,-1,-1);var invDenom=1/denom,u=(dot11*dot02-dot01*dot12)*invDenom,v=(dot00*dot12-dot01*dot02)*invDenom;return target.set(1-u-v,v,u)}}(),containsPoint:(v1=new Vector3,function containsPoint(point,a,b,c){return Triangle.getBarycoord(point,a,b,c,v1),v1.x>=0&&v1.y>=0&&v1.x+v1.y<=1})})}),"static"),Class((function FXLayer(_parentNuke,_type,_preventDrawBuffers=!1){Inherit(this,Component);var _nuke,_rt,_this=this,_scene=new Scene,_objects=[],_textureIndex=-1,_visible=!0,_id=Utils.timestamp(),_name=Utils.getConstructorName(_this),_useDrawBuffers=!_preventDrawBuffers;function resizeHandler(){_rt.setSize&&_rt.setSize(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr)}this.resolution=1,this.enabled=!0,this.renderShadows=!0,this.set("visible",v=>_this.scene.visible=_visible=v),this.get("visible",_=>_visible),this.onInvisible=function(){_this.scene.visible=!1},this.onVisible=function(){_this.scene.visible=!0},this.create=function(nuke=World.NUKE,type,rt){if(!nuke)return;let format;_useDrawBuffers=nuke.useDrawBuffers,type&&"object"==typeof type&&("boolean"==typeof type.useDrawBuffers&&(_useDrawBuffers=type.useDrawBuffers),format=type.format,type=type.type),_this.rtType=type||Texture.UNSIGNED_BYTE,_this.rtFormat=format||Texture.RGBFormat,(_this=this).scene=_scene,(_nuke=_this.initClass(Nuke,nuke.stage,{renderer:nuke.renderer,camera:nuke.camera,scene:_scene,dpr:nuke.dpr,useDrawBuffers:!1})).parentNuke=nuke,_parentNuke=nuke,_this.nuke=_nuke,function initRT(rt){if(_useDrawBuffers){let texture=new Texture;texture.minFilter=Texture.LINEAR,texture.magFilter=Texture.LINEAR,texture.format=Texture.RGBAFormat,_this.rtType&&(texture.type=_this.rtType),_this.rtFormat&&(texture.format=_this.rtFormat),texture.wrapS=texture.wrapT=Texture.CLAMP_TO_EDGE,texture.fxLayer=_this,_this.textureIndex=_textureIndex=_parentNuke.attachDrawBuffer(texture),_rt={texture:texture}}else _rt=rt||Utils3D.createRT(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr,_this.rtType||Texture.RGBAFormat);_this.rt=_rt,_this.nuke.setSize(_rt.width,_rt.height)}(rt),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}()},this.addObject=this.add=function(object){if(_nuke)if(_useDrawBuffers)object.shader&&object.shader.fragmentShader&&(!function editDBShader(mesh){const WEBGL2=Renderer.type==Renderer.WEBGL2;let modifyMarker=(fs,name,index)=>{if(WEBGL2&&!fs.includes(`layout(location=${index})`)){let mainAt=(fs=fs.replace("out vec4 FragColor;","")).indexOf("void main()"),before=fs.slice(0,mainAt),after=fs.slice(mainAt);fs=before+`layout(location=${index}) out vec4 ${name};\n`+after}let marker="#drawbuffer "+name;if(fs.includes(marker)){let split=fs.split(marker+" "),finalOut=WEBGL2?name:`gl_FragData[${index}]`;split[1]=split[1].replace("gl_FragColor",finalOut),fs=split[0]+split[1]}for(;fs.includes("#applyShadow");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)fs[i].includes("#applyShadow")&&(fs[i]=fs[i].replace("#applyShadow",""));fs=fs.join("\n")}return fs},shader=mesh.shader,fs=shader.fragmentShader,name=_this.name||_name;WEBGL2&&fs.includes("location=0")||(fs=modifyMarker(fs,"Color",0)),fs=modifyMarker(fs,name,_textureIndex),shader.fragmentShader=fs}(object),object.shader._attachmentData={format:_this.rtFormat,type:_this.rtType,attachments:_parentNuke.attachments});else{let clone=object.clone();for(object["clone_"+_id]=clone,_scene.add(clone),_objects.push(object),object.shader&&function editShader(mesh){let modifyShader=(shader,name)=>{let fs=shader._fragmentShader;if(!fs)return;let marker="#drawbuffer "+name;if(fs.includes(marker)){let split=fs.split(marker+" ");fs=split[0]+split[1]}for(;fs.includes("#drawbuffer");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)fs[i].includes("#drawbuffer")&&(fs[i]="");fs=fs.join("\n")}shader.fragmentShader=fs},applyShadow=(shader,bool)=>{let fs=shader.fragmentShader;if(fs){for(;fs.includes("#applyShadow");){fs=fs.split("\n");for(let i=0;i<fs.length;i++)bool?fs[i].includes("#applyShadow")&&(fs[i]=fs[i].replace("#applyShadow","")):fs[i].includes("#applyShadow")&&(fs[i]="");fs=fs.join("\n")}shader.fragmentShader=fs}};mesh.shader._fragmentShader||(mesh.shader._fragmentShader=mesh.shader.fragmentShader),modifyShader(mesh.shader,"Color");let shader=mesh.shader.clone(!_this.renderShadows,`-${_this.name||_name}`);modifyShader(shader,_this.name||_name),applyShadow(shader,_this.renderShadows),applyShadow(mesh.shader,!0),mesh.shader.copyUniformsTo(shader,!0),mesh.shader=shader}(clone);clone.children.length;)clone.remove(clone.children[0])}},this.removeObject=function(object){_nuke&&(_scene.remove(object["clone_"+_id]),_objects.remove(object),delete object["clone_"+_id])},this.render=this.draw=function(stage,camera){if(_nuke&&_this.enabled&&!_useDrawBuffers&&_parentNuke.enabled&&_objects.length){stage&&(_nuke.stage=stage,_this.setSize(stage.width,stage.height)),_nuke.camera=camera||_nuke.parentNuke.camera,_this.renderShadows||(_nuke.renderer.overridePreventShadows=!0);for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i],clone=obj["clone_"+_id];_this.forceVisible?clone.visible=!0:clone.visible=obj.determineVisible(),clone.visible&&(obj.updateMatrixWorld(),obj.ignoreMatrix||Utils3D.decompose(obj,clone))}_nuke.rtt=_rt,_nuke.render(),RenderStats.update("FXLayer"),_nuke.renderer.overridePreventShadows=!1}},this.addPass=function(pass){_nuke&&_nuke.add(pass)},this.removePass=function(pass){_nuke&&_nuke.remove(pass)},this.setSize=function(width,height){_nuke&&(_rt.width==width&&_rt.height==height||(_this.events.unsub(Events.RESIZE,resizeHandler),_rt&&_rt.setSize(width*_this.resolution*_nuke.dpr,height*_this.resolution*_nuke.dpr),_nuke.setSize(width*_this.resolution*_nuke.dpr,height*_this.resolution*_nuke.dpr)))},this.setDPR=function(dpr){_nuke&&(_nuke.dpr=dpr,resizeHandler())},this.setResolution=function(res){_this.resolution=res,resizeHandler()},this.getObjects=function(){return _objects},this.useRT=function(rt){_rt=_this.rt=rt},this.getName=function(){return _this.name||_name},_parentNuke instanceof Nuke&&this.create(_parentNuke,_type)})),Namespace("FX"),Class((function FXScene(_parentNuke,_type){Inherit(this,Component);var _nuke,_rt,_this=this,_scene=new Scene,_id=Utils.timestamp(),_objects=[],_visible=!0;function resizeHandler(){_rt.setSize&&_rt.setSize(_nuke.stage.width*_this.resolution*_nuke.dpr,_nuke.stage.height*_this.resolution*_nuke.dpr),_this.nuke.setSize(_rt.width,_rt.height),_this.width=_rt.width,_this.height=_rt.height}this.resolution=1,this.autoVisible=!0,this.enabled=!0,this.scene=_scene,this.renderShadows=!0,this.set("visible",v=>{_this.scene&&(_this.scene.visible=_visible=v)}),this.get("visible",_=>_visible),this.onInvisible=function(){this.scene.visible&&(this.scene.visible=!1,_this.flag("needsOnVisible",!0))},this.onVisible=function(){_this.flag("needsOnVisible")&&(this.scene.visible=!0,_this.flag("needsOnVisible",!1))},this.create=function(nuke=World.NUKE,rt,options){rt&&"object"==typeof rt&&(rt.isRT||(options=rt,rt=void 0)),options||(options={}),_this.rtFormat=options.format||Texture.RGBFormat,_this.rtType=options.type||Texture.UNSIGNED_BYTE,(_this=this).scene=_scene,_this.nuke=_nuke=_this.initClass(Nuke,nuke.stage,{renderer:nuke.renderer,camera:nuke.camera,scene:_scene,dpr:nuke.dpr}),_scene.nuke=_nuke,function initRT(rt,options={}){options.type==Texture.FLOAT&&(options.format=Texture.RGBAFormat),_this.width=_nuke.stage.width*_this.resolution*_nuke.dpr,_this.height=_nuke.stage.height*_this.resolution*_nuke.dpr,_rt=rt||new RenderTarget(_this.width,_this.height,Object.assign({minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,generateMipmaps:!1},options)),_this.rt=_rt,_rt.fxscene=_this}(rt,options),rt?_this.flag("recycle_rt",!0):function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),FXScene.onCreate&&FXScene.onCreate(_this)},this.onDestroy=this.fxDestroy=function(){_this.scene.deleted=!0,_this.flag("recycle_rt")||_rt&&_rt.destroy&&_rt.destroy()},this.setSize=function(width,height,exact){_nuke&&(_rt.width==width&&_rt.height==height||(_this.events.unsub(Events.RESIZE,resizeHandler),exact?(_this.width=width,_this.height=height):(_this.width=width*_this.resolution*_nuke.dpr,_this.height=height*_this.resolution*_nuke.dpr),_rt&&_rt.setSize(_this.width,_this.height),_nuke.setSize(_this.width,_this.height)))},this.add=this.addObject=function(object){if(!object)return console.error("FXScene addObject undefined!");let clone=object.clone();for(object["clone_"+_id]=clone,_scene.add(clone),_objects.push(object),object.shader._attachmentData={format:_this.rtFormat,type:_this.rtType,attachments:1};clone.children.length;)clone.remove(clone.children[0]);return clone},this.removeObject=function(object){_scene.remove(object["clone_"+_id]),_objects.remove(object),delete object["clone_"+_id]},this.setScissor=function(x,y,w,h){this.scissor||(this.scissor=new Vector4),this.scissor.x=x*_this.width,this.scissor.y=_this.height-h*_this.height-y*_this.height,this.scissor.width=w*_this.width,this.scissor.height=h*_this.height,this.rt.scissor=this.scissor},this.render=this.draw=function(stage,camera){stage&&(_this.events.unsub(Events.RESIZE,resizeHandler),_this.setSize(stage.width,stage.height),_this.nuke.stage=stage),camera&&(_this.nuke.camera=camera,RenderManager.type==RenderManager.WEBVR&&(_this.vrRT||(_this.vrRT=new Map),_this.vrRT.get(camera)||_this.vrRT.set(camera,_rt.clone())));let clearColor=null,alpha=1;_this.clearColor&&(clearColor=_nuke.renderer.getClearColor().getHex(),_nuke.renderer.setClearColor(_this.clearColor)),_this.clearAlpha>-1&&(alpha=_nuke.renderer.getClearAlpha(),_nuke.renderer.setClearAlpha(_this.clearAlpha)),_this.renderShadows||(_nuke.renderer.overridePreventShadows=!0);for(let i=_objects.length-1;i>-1;i--){let obj=_objects[i],clone=obj["clone_"+_id];_this.forceVisible||obj.cloneVisible?clone.visible="boolean"!=typeof clone.isVisible||clone.isVisible:clone.visible=obj.determineVisible(),clone.visible&&(obj.updateMatrixWorld(!1===obj.visible||void 0),obj.ignoreMatrix||(Utils3D.decompose(obj,clone),clone.overrideScale&&clone.scale.setScalar(clone.overrideScale)))}_this.preventRTDraw||(RenderStats.update("FXScene",1,_this),_nuke.rtt=_rt,camera&&RenderManager.type==RenderManager.WEBVR&&(_nuke.rtt=_this.vrRT.get(camera)),_nuke.render()),_nuke.renderer.overridePreventShadows=!1,_this.clearColor&&_nuke.renderer.setClearColor(clearColor),_this.clearAlpha>-1&&_nuke.renderer.setClearAlpha(_this.clearAlpha)},this.setDPR=function(dpr){return _nuke?(_nuke.dpr=dpr,resizeHandler(),_this):_this},this.addPass=function(pass){_nuke&&_nuke.add(pass)},this.removePass=function(pass){_nuke&&_nuke.remove(pass)},this.setResolution=function(res){return _this.resolution=res,resizeHandler(),this},this.useRT=function(rt){_rt=_this.rt=rt},this.upload=function(){_rt&&_rt.upload()},this.useCamera=function(camera){_this.nuke.camera=camera.camera||camera},this.useScene=function(scene){_this.nuke.scene=scene},this.createDepthTexture=function(useRTTBuffer){return _this.depthTexture?_this.depthTexture:(_this.nuke.passes.length||useRTTBuffer?(_this.nuke.rttBuffer.createDepthTexture(),_this.depthTexture=_this.nuke.rttBuffer.depth):(_this.rt.createDepthTexture(),_this.depthTexture=_this.rt.depth),_this.depthTexture)},_parentNuke instanceof Nuke&&this.create(_parentNuke,_type)})),Class((function BlitPass(_forceNuke){Inherit(this,NukePass);this.uniforms={},this.init("BlitPass"),_forceNuke||(this.blitFramebuffer=!0)})),Class((function Nuke(_stage,_params){Inherit(this,Component);var _width,_height,_nukeMesh,_this=this;_params.renderer||console.error("Nuke :: Must define renderer"),_this.stage=_stage,_this.renderer=_params.renderer,_this.camera=_params.camera,_this.scene=_params.scene,_this.rtt=_params.rtt,_this.enabled=0!=_params.enabled,_this.passes=_params.passes||[],_this.useDrawBuffers=(_=>void 0!==_params.useDrawBuffers?_params.useDrawBuffers:!(Renderer.type!=Renderer.WEBGL2&&!window.Metal)||!Utils.query("noDrawBuffers")&&!Nuke.NO_DRAWBUFFERS&&(Device.graphics.webgl&&Device.graphics.webgl.detect("draw_buffers")))();var _rttPing,_rttPong,_rttBuffer,_dpr=_params.dpr||1,_drawBuffers=[];function resizeHandler(){var width=_this.stage.width*_dpr,height=_this.stage.height*_dpr;_rttPing.setSize(width,height),_rttPong.setSize(width,height),_rttBuffer.setSize(width,height)}_this.scene.nuke=_this,function initNuke(){let width=_this.stage.width*_dpr,height=_this.stage.height*_dpr;_rttPing=Nuke.getRT(width,height,!1,1),_rttPong=Nuke.getRT(width,height,!1,2),_rttBuffer=Nuke.getRT(width,height,_this.useDrawBuffers),(_nukeMesh=new Mesh(World.QUAD,null)).frustumCulled=!1,_nukeMesh.noMatrices=!0,_nukeMesh.transient=!0,_width=width,_height=height}(),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),_this.onBeforeShaderCompile=function(obj){if(!obj)return;let shader=obj.shader;if(!(shader&&shader.fragmentShader&&_this.useDrawBuffers&&_drawBuffers.length))return;const WEBGL2=Renderer.type==Renderer.WEBGL2;let key=WEBGL2?" Color ":"gl_FragData[0]";if(!shader.fragmentShader.includes(key)){let fs=shader.fragmentShader;WEBGL2||(fs="#extension GL_EXT_draw_buffers : require\n"+fs),fs=fs.split("void main() {"),fs=fs[0]+"void main() {\nvec4 tmpFragColor;\n"+fs[1],fs=fs.replace(/gl_FragColor/g,"tmpFragColor");let idx=fs.lastIndexOf("}");fs=fs.slice(0,idx)+"#drawbuffer Color gl_FragColor = tmpFragColor;\n"+fs.slice(idx),shader.fragmentShader=fs}_drawBuffers.forEach((t,i)=>{let name=t.fxLayer.getName(),key=WEBGL2?`${name} =`:`gl_FragData[${i+1}]`;if(!shader.fragmentShader.includes(key)){let fs=shader.fragmentShader,idx=fs.lastIndexOf("}");fs=fs.slice(0,idx)+`#drawbuffer ${name} gl_FragColor = vec4(0.0);\n`+fs.slice(idx),shader.fragmentShader=fs,t.fxLayer.add(obj)}})},_this.add=function(pass,index){"number"!=typeof index?_this.passes.push(pass):_this.passes.splice(index,0,pass)},_this.remove=function(pass){"number"==typeof pass?_this.passes.splice(pass):_this.passes.remove(pass)},_this.render=function(directCallback){if(RenderStats.update("Nuke"),_this.events.fire(Nuke.RENDER,_this,!0),_this.onBeforeRender&&_this.onBeforeRender(),!_this.enabled||!_this.passes.length)return _this.renderer.render(_this.scene,_this.camera,_this.rtt,null,directCallback),_this.onBeforeProcess&&_this.onBeforeProcess(),void(_this.postRender&&_this.postRender());RenderStats.update("NukePass",_this.passes.length),_this.hasRendered=!0,_this.onBeforeProcess&&_this.onBeforeProcess(),_this.renderer.render(_this.scene,_this.camera,_rttBuffer,!0);let usedBuffer=!1,pingPong=!0,count=_this.passes.length;for(var i=0;i<count;i++){if(_this.passes[i].disabled)continue;let shader=_this.passes[i].pass,inTexture=usedBuffer?pingPong?_rttPing.texture:_rttPong.texture:_rttBuffer.texture,outTexture=pingPong?_rttPong:_rttPing;i==count-1&&(outTexture=_this.rtt),_nukeMesh.shader=shader,_nukeMesh.shader.depthTest=!1,_nukeMesh.shader.depthWrite=!1,_nukeMesh.shader.uniforms.tDiffuse.value=inTexture,_this.renderer.renderSingle(_nukeMesh,_this.camera||World.CAMERA,outTexture,i==count-1?directCallback:null),usedBuffer=!0,pingPong=!pingPong}_this.postRender&&_this.postRender()},_this.setSize=function(width,height){width==_width&&height==_height||(_width=width,_height=height,resizeHandler())},_this.attachDrawBuffer=function(texture){if(_this.hasRendered&&console.warn("Attempt to attach draw buffer after first render! Create FXLayer instance before first render."),_drawBuffers.push(texture),_rttBuffer&&_rttBuffer.attachments){_rttBuffer.attachments=[_rttBuffer.attachments[0]];for(let i=0;i<_drawBuffers.length;i++)_rttBuffer.attachments.push(_drawBuffers[i])}return _drawBuffers.length},_this.upload=function(){_this.passes.length&&_this.enabled&&(_rttPing.upload(),_rttPong.upload(),_rttBuffer.upload()),_rttBuffer.depth&&_rttBuffer.depth.upload(),_this.rtt&&_this.rtt.upload()},_this.set("dpr",(function(v){_dpr=v,resizeHandler()})),_this.get("dpr",(function(){return _dpr})),_this.get("output",(function(){return _nukeMesh.shader&&_nukeMesh.shader.uniforms?_nukeMesh.shader.uniforms.tDiffuse.value:null})),_this.get("rttBuffer",(function(){return _rttBuffer})),this.set("rttBuffer",(function(v){_rttBuffer=v})),_this.get("prevFrameRT",(function(){return _rttBuffer&&_rttBuffer.texture?_rttBuffer.texture:null})),_this.get("nukeScene",(function(){return _nukeScene})),_this.get("ping",(function(){return _rttPing})),_this.get("pong",(function(){return _rttPong})),_this.get("attachments",(function(){return _rttBuffer.attachments.length})),this.onDestroy=function(){_rttBuffer.destroy()}}),(function(){Nuke.RENDER="nuke_render";var _rts={};Nuke.getRT=function(width,height,multi,index){let rt,exists=_rts[`${width}_${height}_${multi}_${index}`];return exists||(rt=multi?Utils3D.createMultiRT(width,height):Utils3D.createRT(width,height),index>0&&Nuke.recyclePingPong&&(_rts[`${width}_${height}_${multi}_${index}`]=rt),rt)}})),Class((function NukePass(_fs,_uniforms,_pass){Inherit(this,Component);var _this=this;this.UILPrefix="string"==typeof _fs?_fs:Utils.getConstructorName(_fs),this.init=function(fs,vs){if(_this.pass)return;_this=this;fs||this.constructor.toString().match(/function ([^\(]+)/)[1],Array.isArray(fs)&&fs.join("");if(_this.uniforms=_uniforms||_this.uniforms||{},_this.uniforms.tDiffuse={type:"t",value:null,ignoreUIL:!0},_this.uniforms.unique&&(_this.UILPrefix+="_"+_this.uniforms.unique+"_"),window.UILStorage)for(let key in _this.uniforms)"unique"!==key&&(_this.uniforms[key]=UILStorage.parse(_this.UILPrefix+key,_this.uniforms[key].value)||_this.uniforms[key]);_this.pass=_this.initClass(Shader,vs||"NukePass",fs,Utils.mergeObject(_this.uniforms,{precision:"high"}),(code,type)=>"fs"==type?function prefix(code){if(!code)throw`No shader ${_fs} found`;let pre="";return code.includes("uniform sampler2D tDiffuse")||(pre+="uniform sampler2D tDiffuse;\n",pre+="varying vec2 vUv;\n"),code=pre+code}(code):code),_this.uniforms=_this.pass.uniforms},this.set=function(key,value){TweenManager.clearTween(_this.uniforms[key]),_this.uniforms[key].value=value},this.get=function(key){return void 0===_this.uniforms[key]?null:_this.uniforms[key].value},this.tween=function(key,value,time,ease,delay,callback,update){return tween(_this.uniforms[key],{value:value},time,ease,delay,callback,update)},this.clone=function(){return _this.pass||_this.init(_fs),new NukePass(null,null,_this.pass.clone())},this.upload=function(){_this.pass.upload()},"string"==typeof _fs?_this.init(_fs):_pass&&(_this.pass=_pass,_this.uniforms=_pass.uniforms)})),Class((function Raycaster(_camera){Inherit(this,Component);const _this=this;let _mouse=new Vector3,_raycaster=new RayManager;function ascSort(a,b){return a.distance-b.distance}function intersect(objects){Array.isArray(objects)||(objects=[objects]);let intersects=[];return objects.forEach(object=>{!function intersectObject(object,raycaster,intersects,recursive){let obj=object;for(;obj&&_this.testVisibility;){if(!1===obj.visible&&!obj.forceRayVisible&&!1!==obj.testVisibility)return;obj=obj.parent}if(object.raycast&&(object.raycast(raycaster,intersects),!0===recursive)){let children=object.children;for(let i=0,l=children.length;i<l;i++)intersectObject(children[i],raycaster,intersects,!0)}}(object,_raycaster,intersects,!1)}),intersects.sort(ascSort),intersects}this.testVisibility=!0,this.set("camera",(function(camera){_camera=camera})),this.set("pointsThreshold",(function(value){_raycaster.params.Points.threshold=value})),this.get("ray",()=>_raycaster.ray),this.checkHit=function(objects,mouse,rect=Stage){return mouse=mouse||Mouse,_mouse.x=mouse.x/rect.width*2-1,_mouse.y=-mouse.y/rect.height*2+1,_raycaster.setFromCamera(_mouse,_camera),intersect(objects)},this.checkFromValues=function(objects,origin,direction){return _raycaster.set(origin,direction,0,Number.POSITIVE_INFINITY),intersect(objects)}}),_=>{var _ray,_map=new WeakMap;Raycaster.checkHit=function(objects,mouse){return _ray||(_ray=new Raycaster(World.CAMERA)),_ray.checkHit(objects,mouse)},Raycaster.checkFromValues=function(objects,origin,direction){return _ray||(_ray=new Raycaster(World.CAMERA)),_ray.checkFromValues(objects,origin,direction)},Raycaster.find=function(camera){if(!_map.has(camera)){let ray=new Raycaster(camera);_map.set(camera,ray)}return _map.get(camera)}}),Class((function ScreenProjection(_camera){Inherit(this,Component);var _v3=new Vector3,_v32=new Vector3,_value=new Vector3;_camera=_camera.camera||_camera,this.set("camera",(function(v){_camera=v.camera||v})),this.get("camera",_=>_camera),this.unproject=function(mouse,rect=Stage,distance=0){"number"==typeof rect&&(distance=rect,rect=Stage),_v3.set(mouse.x/rect.width*2-1,-mouse.y/rect.height*2+1,.5),_v3.unproject(_camera);let pos=_camera.getWorldPosition();_v3.sub(pos).normalize();let dist=-pos.z/_v3.z;return _value.copy(pos).add(_v3.multiplyScalar(dist-distance)),_value},this.project=function(pos,screen){return screen=screen||Stage,pos instanceof Base3D?(pos.updateMatrixWorld(),_v32.set(0,0,0).setFromMatrixPosition(pos.matrixWorld)):_v32.copy(pos),_v32.project(_camera),_v32.x=(_v32.x+1)/2*screen.width,_v32.y=-(_v32.y-1)/2*screen.height,_v32}}),_=>{var _screen,_map=new WeakMap;ScreenProjection.unproject=function(mouse,distance){return _screen||(_screen=new ScreenProjection(World.CAMERA)),_screen.unproject(mouse,distance)},ScreenProjection.project=function(pos,screen){return _screen||(_screen=new ScreenProjection(World.CAMERA)),_screen.project(pos,screen)},ScreenProjection.find=function(camera){if(!_map.has(camera)){let projection=new ScreenProjection(camera);_map.set(camera,projection)}return _map.get(camera)}}),Class((function Object3D(){Inherit(this,Component);var _this=this,_visible=!0;this.__element=!0,this.group=new Group,this.group.classRef=this,this.add=function(child){this.group.add(child.group||child)},this.remove=function(child){this.group.remove(child.group||child)},this.onDestroy=function(){this.group.deleted=!0,this.group.classRef=null,this.group&&this.group.parent&&this.group.parent.remove(this.group)},this.set("visible",v=>_this.group.visible=_visible=v),this.get("visible",_=>_visible)})),Class((function Utils3D(){const _this=this;var _emptyTexture,_q,_textures={};window.Vec2=window.Vector2,window.Vec3=window.Vector3,async function(){await Hydra.ready();let threads=Thread.shared(!0);for(let i=0;i<threads.array.length;i++)_this.loadEngineOnThread(threads.array[i])}(),this.decompose=function(local,world){local.matrixWorld.decompose(world.position,world.quaternion,world.scale)},this.createDebug=function(size=1,color){return new Mesh(new IcosahedronGeometry(size,1),_this.getTestShader(color))},this.getTestShader=function(color){return color?new Shader("ColorMaterial",{color:{value:color instanceof Color?color:new Color(color)},alpha:{value:1}}):new Shader("TestMaterial")},this.createMultiRT=function(width,height,type,format){let rt=new MultiRenderTarget(width,height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:format||Texture.RGBFormat,type:type});return rt.texture.generateMipmaps=!1,rt},this.createRT=function(width,height,type,format){let rt=new RenderTarget(width,height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:format||Texture.RGBFormat,type:type});return rt.texture.generateMipmaps=!1,rt},this.getFloatType=function(){return"android"==Device.system.os?Texture.FLOAT:Texture.HALF_FLOAT},this.getTexture=function(path,params={}){if(!Device.graphics.webgl&&!window.AURA){let texture=new Texture;return texture.promise=Promise.resolve(),texture.dimensions={width:0,height:0},texture}if(path.includes("://")){let guard=path.split("://");guard[1]=guard[1].replace(/\/\//g,"/"),path=guard.join("://")}else path=path.replace(/\/\//g,"/");let cacheBust=path.includes("?");if(cacheBust&&(path=path.split("?")[0]),_textures[path])_textures[path].exists++;else{let texture=new Texture;texture.exists=1,texture.loaded=!1,texture.compressed=path.includes("compressedKtx"),texture.promise=Promise.create(),texture._destroy=texture.destroy,texture.destroy=function(){texture.forcePersist||--texture.exists>0||(delete _textures[path],this._destroy())},_textures[path]=texture,texture.format=path.match(/jpe?g/)?Texture.RGBFormat:Texture.RGBAFormat,texture.src=path,!1===params.premultiplyAlpha&&(texture.premultiplyAlpha=!1),_this.onTextureCreated&&_this.onTextureCreated(texture);let cb=imgBmp=>{imgBmp.crossOrigin="anonymous",texture.image=imgBmp,texture.dimensions={width:imgBmp.width,height:imgBmp.height},texture.loaded=!0,texture.needsReupload=!0,Math.isPowerOf2(imgBmp.width,imgBmp.height)||(texture.minFilter=Texture.LINEAR,texture.generateMipmaps=!1),imgBmp.gliFormat&&(texture.minFilter=Texture.LINEAR),texture.onUpdate=function(){!params.preserveData&&imgBmp.close&&imgBmp.close(),texture.onUpdate=null},texture.promise.resolve(),texture.onload&&(texture.onload(),texture.onload=null)},imgPath=cacheBust?path+"?"+Date.now():path;ImageDecoder.decode(imgPath,params).then(cb).catch(e=>{texture.promise.reject(e)})}return _textures[path]},this.getLookupTexture=function(path){let texture=_this.getTexture(path);return texture.minFilter=texture.magFilter=Texture.NEAREST,texture.generateMipmaps=!1,texture},this.clearTextureCache=function(){for(let key in _textures)_textures[key].destroy();_textures={}},this.loadCurve=function(obj){"string"==typeof obj&&((obj=Assets.JSON[obj]).curves=obj.curves[0]);let data=obj.curves,points=[];for(let j=0;j<data.length;j+=3)points.push(new Vector3(data[j+0],data[j+1],data[j+2]));if(!window.CatmullRomCurve)throw"loadCurve requires curve3d module";return new CatmullRomCurve(points)},this.getEmptyTexture=function(){return _emptyTexture||(_emptyTexture=new Texture),_emptyTexture},this.getRepeatTexture=function(src,scale){let texture=_this.getTexture(src,scale);return texture.wrapS=texture.wrapT=Texture.REPEAT,texture},this.findTexturesByPath=function(path){let array=[];for(let key in _textures)key.includes(path)&&array.push(_textures[key]);return array},this.getHeightFromCamera=function(camera,dist){camera=camera.camera||camera,dist||(dist=camera.position.length());let fov=camera.fov;return 2*dist*Math.tan(.5*Math.radians(fov))},this.getPositionFromCameraSize=function(camera,size){camera=camera.camera||camera;let fov=Math.radians(camera.fov);return Math.abs(size/Math.sin(fov/2))},this.loadEngineOnThread=function(thread){["Base3D","CameraBase3D","Mesh","OrthographicCamera","PerspectiveCamera","Geometry","GeometryAttribute","Points","Scene","BoxGeometry","CylinderGeometry","PlaneGeometry","PolyhedronGeometry","IcosahedronGeometry","SphereGeometry","Box2","Box3","Face3","Color","Cylindrical","Euler","Frustum","Line3","Matrix3","Matrix4","Plane","Quaternion","Ray","Sphere","Spherical","Triangle","Vector2","Vector3","Vector4","RayManager","Vector3D","Group"].forEach(name=>{thread.importES6Class(name)}),thread.importCode(`Class(${zUtils3D.constructor.toString()}, 'static')`)},this.billboard=function(mesh,camera=World.CAMERA){_q||(_q=new Quaternion),mesh._parent?(mesh._parent.getWorldQuaternion(_q).inverse(),_q.multiply(camera.quaternion),mesh.quaternion.copy(_q)):mesh.quaternion.copy(World.CAMERA.quaternion)},this.getQuad=function(){let geom=new Geometry,position=new Float32Array([-1,-1,0,3,-1,0,-1,3,0]),uv=new Float32Array([0,0,2,0,0,2]);return geom.addAttribute("position",new GeometryAttribute(position,3)),geom.addAttribute("uv",new GeometryAttribute(uv,2)),geom}}),"static"),window.WebGLRenderingContext&&function(){"use strict";var e={};function r(r,t){var i;e[r]=!0,void 0!==t&&(i=t,window.console&&window.console.error&&window.console.error(i))}var t=function e(r){var t=r.gl;this.ext=r,this.isAlive=!0,this.hasBeenBound=!1,this.elementArrayBuffer=null,this.attribs=new Array(r.maxVertexAttribs);for(var i=0;i<this.attribs.length;i++){var a=new e.VertexAttrib(t);this.attribs[i]=a}this.maxAttrib=0};(t.VertexAttrib=function(e){this.enabled=!1,this.buffer=null,this.size=4,this.type=e.FLOAT,this.normalized=!1,this.stride=16,this.offset=0,this.cached="",this.recache()}).prototype.recache=function(){this.cached=[this.size,this.type,this.normalized,this.stride,this.offset].join(":")};var i=function(r){var t,i,a=this;this.gl=r,i=(t=r).getError,t.getError=function(){do{(r=i.apply(t))!=t.NO_ERROR&&(e[r]=!0)}while(r!=t.NO_ERROR);for(var r in e)if(e[r])return delete e[r],parseInt(r);return t.NO_ERROR};var n=this.original={getParameter:r.getParameter,enableVertexAttribArray:r.enableVertexAttribArray,disableVertexAttribArray:r.disableVertexAttribArray,bindBuffer:r.bindBuffer,getVertexAttrib:r.getVertexAttrib,vertexAttribPointer:r.vertexAttribPointer};r.getParameter=function(e){return e==a.VERTEX_ARRAY_BINDING_OES?a.currentVertexArrayObject==a.defaultVertexArrayObject?null:a.currentVertexArrayObject:n.getParameter.apply(this,arguments)},r.enableVertexAttribArray=function(e){var r=a.currentVertexArrayObject;return r.maxAttrib=Math.max(r.maxAttrib,e),r.attribs[e].enabled=!0,n.enableVertexAttribArray.apply(this,arguments)},r.disableVertexAttribArray=function(e){var r=a.currentVertexArrayObject;return r.maxAttrib=Math.max(r.maxAttrib,e),r.attribs[e].enabled=!1,n.disableVertexAttribArray.apply(this,arguments)},r.bindBuffer=function(e,t){switch(e){case r.ARRAY_BUFFER:a.currentArrayBuffer=t;break;case r.ELEMENT_ARRAY_BUFFER:a.currentVertexArrayObject.elementArrayBuffer=t}return n.bindBuffer.apply(this,arguments)},r.getVertexAttrib=function(e,t){var i=a.currentVertexArrayObject.attribs[e];switch(t){case r.VERTEX_ATTRIB_ARRAY_BUFFER_BINDING:return i.buffer;case r.VERTEX_ATTRIB_ARRAY_ENABLED:return i.enabled;case r.VERTEX_ATTRIB_ARRAY_SIZE:return i.size;case r.VERTEX_ATTRIB_ARRAY_STRIDE:return i.stride;case r.VERTEX_ATTRIB_ARRAY_TYPE:return i.type;case r.VERTEX_ATTRIB_ARRAY_NORMALIZED:return i.normalized;default:return n.getVertexAttrib.apply(this,arguments)}},r.vertexAttribPointer=function(e,r,t,i,s,A){var o=a.currentVertexArrayObject;o.maxAttrib=Math.max(o.maxAttrib,e);var c=o.attribs[e];return c.buffer=a.currentArrayBuffer,c.size=r,c.type=t,c.normalized=i,c.stride=s,c.offset=A,c.recache(),n.vertexAttribPointer.apply(this,arguments)},r.instrumentExtension&&r.instrumentExtension(this,"OES_vertex_array_object"),r.canvas.addEventListener("webglcontextrestored",(function(){window.console&&window.console.log&&window.console.log("OESVertexArrayObject emulation library context restored"),a.reset_()}),!0),this.reset_()};i.prototype.VERTEX_ARRAY_BINDING_OES=34229,i.prototype.reset_=function(){if(void 0!==this.vertexArrayObjects)for(var e=0;e<this.vertexArrayObjects.length;++e)this.vertexArrayObjects.isAlive=!1;var r=this.gl;this.maxVertexAttribs=r.getParameter(r.MAX_VERTEX_ATTRIBS),this.defaultVertexArrayObject=new t(this),this.currentVertexArrayObject=null,this.currentArrayBuffer=null,this.vertexArrayObjects=[this.defaultVertexArrayObject],this.bindVertexArrayOES(null)},i.prototype.createVertexArrayOES=function(){var e=new t(this);return this.vertexArrayObjects.push(e),e},i.prototype.deleteVertexArrayOES=function(e){e.isAlive=!1,this.vertexArrayObjects.splice(this.vertexArrayObjects.indexOf(e),1),this.currentVertexArrayObject==e&&this.bindVertexArrayOES(null)},i.prototype.isVertexArrayOES=function(e){return!!(e&&e instanceof t&&e.hasBeenBound&&e.ext==this)},i.prototype.bindVertexArrayOES=function(e){var t=this.gl;if(!e||e.isAlive){var i=this.original,a=this.currentVertexArrayObject;this.currentVertexArrayObject=e||this.defaultVertexArrayObject,this.currentVertexArrayObject.hasBeenBound=!0;var n=this.currentVertexArrayObject;if(a!=n){a&&n.elementArrayBuffer==a.elementArrayBuffer||i.bindBuffer.call(t,t.ELEMENT_ARRAY_BUFFER,n.elementArrayBuffer);for(var s=this.currentArrayBuffer,A=Math.max(a?a.maxAttrib:0,n.maxAttrib),o=0;o<=A;o++){var c=n.attribs[o],b=a?a.attribs[o]:null;if(a&&c.enabled==b.enabled||(c.enabled?i.enableVertexAttribArray.call(t,o):i.disableVertexAttribArray.call(t,o)),c.enabled){var u=!1;a&&c.buffer==b.buffer||(s!=c.buffer&&(i.bindBuffer.call(t,t.ARRAY_BUFFER,c.buffer),s=c.buffer),u=!0),(u||c.cached!=b.cached)&&i.vertexAttribPointer.call(t,o,c.size,c.type,c.normalized,c.stride,c.offset)}}this.currentArrayBuffer!=s&&i.bindBuffer.call(t,t.ARRAY_BUFFER,this.currentArrayBuffer)}}else r(t.INVALID_OPERATION,"bindVertexArrayOES: attempt to bind deleted arrayObject")},function(){var e=WebGLRenderingContext.prototype.getSupportedExtensions;WebGLRenderingContext.prototype.getSupportedExtensions=function(){var r=e.call(this)||[];return r.indexOf("OES_vertex_array_object")<0&&r.push("OES_vertex_array_object"),r};var r=WebGLRenderingContext.prototype.getExtension;WebGLRenderingContext.prototype.getExtension=function(e){return r.call(this,e)||("OES_vertex_array_object"!==e?null:(this.__OESVertexArrayObject||(console.log("Setup OES_vertex_array_object polyfill"),this.__OESVertexArrayObject=new i(this)),this.__OESVertexArrayObject))}}()}(),window.DebugControls=function(object,domElement){var offset,quat,quatInverse,lastPosition,lastQuaternion;this.object=object,this.domElement=void 0!==domElement?domElement:document,this.enabled=!0,this.target=new Vector3,this.minDistance=0,this.maxDistance=1/0,this.minZoom=0,this.maxZoom=1/0,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.minAzimuthAngle=-1/0,this.maxAzimuthAngle=1/0,this.enableDamping=!0,this.dampingFactor=.1,this.enableZoom=!0,this.zoomSpeed=1,this.enableRotate=!0,this.rotateSpeed=.1,this.enablePan=!0,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.enableKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40},this.mouseButtons={ORBIT:0,ZOOM:2,PAN:1},this.target0=this.target.clone(),this.position0=this.object.position.clone(),this.zoom0=this.object.zoom,this.getPolarAngle=function(){return spherical.phi},this.getAzimuthalAngle=function(){return spherical.theta},this.reset=function(){scope.target.copy(scope.target0),scope.object.position.copy(scope.position0),scope.object.zoom=scope.zoom0,scope.object.updateProjectionMatrix(),scope.update(),state=STATE.NONE},this.update=(offset=new Vector3,quat=(new Quaternion).setFromUnitVectors(object.up,new Vector3(0,1,0)),quatInverse=quat.clone().inverse(),lastPosition=new Vector3,lastQuaternion=new Quaternion,function update(){var position=scope.object.position;return offset.copy(position).sub(scope.target),offset.applyQuaternion(quat),spherical.setFromVector3(offset),scope.autoRotate&&state===STATE.NONE&&rotateLeft(function getAutoRotationAngle(){return 2*Math.PI/60/60*scope.autoRotateSpeed}()),spherical.theta+=sphericalDelta.theta,spherical.phi+=sphericalDelta.phi,spherical.theta=Math.max(scope.minAzimuthAngle,Math.min(scope.maxAzimuthAngle,spherical.theta)),spherical.phi=Math.max(scope.minPolarAngle,Math.min(scope.maxPolarAngle,spherical.phi)),spherical.makeSafe(),spherical.radius*=scale,spherical.radius=Math.max(scope.minDistance,Math.min(scope.maxDistance,spherical.radius)),scope.target.add(panOffset),offset.setFromSpherical(spherical),offset.applyQuaternion(quatInverse),position.copy(scope.target).add(offset),scope.object.lookAt(scope.target),!0===scope.enableDamping?(sphericalDelta.theta*=1-scope.dampingFactor,sphericalDelta.phi*=1-scope.dampingFactor):sphericalDelta.set(0,0,0),scale=1,panOffset.set(0,0,0),!!(zoomChanged||lastPosition.distanceToSquared(scope.object.position)>EPS||8*(1-lastQuaternion.dot(scope.object.quaternion))>EPS)&&(lastPosition.copy(scope.object.position),lastQuaternion.copy(scope.object.quaternion),zoomChanged=!1,!0)}),this.dispose=function(){scope.domElement.removeEventListener("contextmenu",onContextMenu,!1),scope.domElement.removeEventListener("mousedown",onMouseDown,!1),scope.domElement.removeEventListener("mousewheel",onMouseWheel,!1),scope.domElement.removeEventListener("MozMousePixelScroll",onMouseWheel,!1),scope.domElement.removeEventListener("touchstart",onTouchStart,!1),scope.domElement.removeEventListener("touchend",onTouchEnd,!1),scope.domElement.removeEventListener("touchmove",onTouchMove,!1),document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1),window.removeEventListener("keydown",onKeyDown,!1)};var scope=this,STATE={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},state=STATE.NONE,EPS=1e-6,spherical=new Spherical,sphericalDelta=new Spherical,scale=1,panOffset=new Vector3,zoomChanged=!1,rotateStart=new Vector2,rotateEnd=new Vector2,rotateDelta=new Vector2,panStart=new Vector2,panEnd=new Vector2,panDelta=new Vector2,dollyStart=new Vector2,dollyEnd=new Vector2,dollyDelta=new Vector2;function getZoomScale(){return Math.pow(.95,scope.zoomSpeed)}function rotateLeft(angle){sphericalDelta.theta-=angle}function rotateUp(angle){sphericalDelta.phi-=angle}var v,panLeft=(v=new Vector3,function panLeft(distance,objectMatrix){v.setFromMatrixColumn(objectMatrix,0),v.multiplyScalar(-distance),panOffset.add(v)}),panUp=function(){var v=new Vector3;return function panUp(distance,objectMatrix){v.setFromMatrixColumn(objectMatrix,1),v.multiplyScalar(distance),panOffset.add(v)}}(),pan=function(){var offset=new Vector3;return function pan(deltaX,deltaY){var element=scope.domElement===document?scope.domElement.body:scope.domElement;if(scope.object instanceof PerspectiveCamera){var position=scope.object.position;offset.copy(position).sub(scope.target);var targetDistance=offset.length();targetDistance*=Math.tan(scope.object.fov/2*Math.PI/180),panLeft(2*deltaX*targetDistance/element.clientHeight,scope.object.matrix),panUp(2*deltaY*targetDistance/element.clientHeight,scope.object.matrix)}else scope.object instanceof OrthographicCamera?(panLeft(deltaX*(scope.object.right-scope.object.left)/scope.object.zoom/element.clientWidth,scope.object.matrix),panUp(deltaY*(scope.object.top-scope.object.bottom)/scope.object.zoom/element.clientHeight,scope.object.matrix)):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled."),scope.enablePan=!1)}}();function dollyIn(dollyScale){scope.object instanceof PerspectiveCamera?scale/=dollyScale:scope.object instanceof OrthographicCamera?(scope.object.zoom=Math.max(scope.minZoom,Math.min(scope.maxZoom,scope.object.zoom*dollyScale)),scope.object.updateProjectionMatrix(),zoomChanged=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),scope.enableZoom=!1)}function dollyOut(dollyScale){scope.object instanceof PerspectiveCamera?scale*=dollyScale:scope.object instanceof OrthographicCamera?(scope.object.zoom=Math.max(scope.minZoom,Math.min(scope.maxZoom,scope.object.zoom/dollyScale)),scope.object.updateProjectionMatrix(),zoomChanged=!0):(console.warn("WARNING: OrbitControls.js encountered an unknown camera type - dolly/zoom disabled."),scope.enableZoom=!1)}function onMouseDown(event){if(!1!==scope.enabled){if(event.preventDefault(),event.button===scope.mouseButtons.ORBIT){if(!1===scope.enableRotate)return;!function handleMouseDownRotate(event){rotateStart.set(event.clientX,event.clientY)}(event),state=STATE.ROTATE}else if(event.button===scope.mouseButtons.ZOOM){if(!1===scope.enableZoom)return;!function handleMouseDownDolly(event){dollyStart.set(event.clientX,event.clientY)}(event),state=STATE.DOLLY}else if(event.button===scope.mouseButtons.PAN){if(!1===scope.enablePan)return;!function handleMouseDownPan(event){panStart.set(event.clientX,event.clientY)}(event),state=STATE.PAN}state!==STATE.NONE&&(document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("mouseup",onMouseUp,!1))}}function onMouseMove(event){if(!1!==scope.enabled)if(event.preventDefault(),state===STATE.ROTATE){if(!1===scope.enableRotate)return;!function handleMouseMoveRotate(event){rotateEnd.set(event.clientX,event.clientY),rotateDelta.subVectors(rotateEnd,rotateStart);var element=scope.domElement===document?scope.domElement.body:scope.domElement;rotateLeft(2*Math.PI*rotateDelta.x/element.clientWidth*scope.rotateSpeed),rotateUp(2*Math.PI*rotateDelta.y/element.clientHeight*scope.rotateSpeed),rotateStart.copy(rotateEnd),scope.update()}(event)}else if(state===STATE.DOLLY){if(!1===scope.enableZoom)return;!function handleMouseMoveDolly(event){dollyEnd.set(event.clientX,event.clientY),dollyDelta.subVectors(dollyEnd,dollyStart),dollyDelta.y>0?dollyIn(getZoomScale()):dollyDelta.y<0&&dollyOut(getZoomScale()),dollyStart.copy(dollyEnd),scope.update()}(event)}else if(state===STATE.PAN){if(!1===scope.enablePan)return;!function handleMouseMovePan(event){panEnd.set(event.clientX,event.clientY),panDelta.subVectors(panEnd,panStart),pan(panDelta.x,panDelta.y),panStart.copy(panEnd),scope.update(),scope.onChange&&scope.onChange()}(event)}}function onMouseUp(event){!1!==scope.enabled&&(document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1),scope.onChange&&scope.onChange(),state=STATE.NONE)}function onMouseWheel(event){!1===scope.enabled||!1===scope.enableZoom||state!==STATE.NONE&&state!==STATE.ROTATE||(event.preventDefault(),event.stopPropagation(),function handleMouseWheel(event){var delta=0;void 0!==event.wheelDelta?delta=event.wheelDelta:void 0!==event.detail&&(delta=-event.detail),delta>0?dollyOut(getZoomScale()):delta<0&&dollyIn(getZoomScale()),scope.update()}(event),scope.onChange&&scope.onChange())}function onKeyDown(event){!1!==scope.enabled&&!1!==scope.enableKeys&&!1!==scope.enablePan&&function handleKeyDown(event){switch(event.keyCode){case scope.keys.UP:pan(0,scope.keyPanSpeed),scope.update();break;case scope.keys.BOTTOM:pan(0,-scope.keyPanSpeed),scope.update();break;case scope.keys.LEFT:pan(scope.keyPanSpeed,0),scope.update();break;case scope.keys.RIGHT:pan(-scope.keyPanSpeed,0),scope.update()}}(event)}function onTouchStart(event){if(!1!==scope.enabled){switch(event.touches.length){case 1:if(!1===scope.enableRotate)return;!function handleTouchStartRotate(event){rotateStart.set(event.touches[0].pageX,event.touches[0].pageY)}(event),state=STATE.TOUCH_ROTATE;break;case 2:if(!1===scope.enableZoom)return;!function handleTouchStartDolly(event){var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY,distance=Math.sqrt(dx*dx+dy*dy);dollyStart.set(0,distance)}(event),state=STATE.TOUCH_DOLLY;break;case 3:if(!1===scope.enablePan)return;!function handleTouchStartPan(event){panStart.set(event.touches[0].pageX,event.touches[0].pageY)}(event),state=STATE.TOUCH_PAN;break;default:state=STATE.NONE}STATE.NONE}}function onTouchMove(event){if(!1!==scope.enabled)switch(event.preventDefault(),event.stopPropagation(),event.touches.length){case 1:if(!1===scope.enableRotate)return;if(state!==STATE.TOUCH_ROTATE)return;!function handleTouchMoveRotate(event){rotateEnd.set(event.touches[0].pageX,event.touches[0].pageY),rotateDelta.subVectors(rotateEnd,rotateStart);var element=scope.domElement===document?scope.domElement.body:scope.domElement;rotateLeft(2*Math.PI*rotateDelta.x/element.clientWidth*scope.rotateSpeed),rotateUp(2*Math.PI*rotateDelta.y/element.clientHeight*scope.rotateSpeed),rotateStart.copy(rotateEnd),scope.update()}(event);break;case 2:if(!1===scope.enableZoom)return;if(state!==STATE.TOUCH_DOLLY)return;!function handleTouchMoveDolly(event){var dx=event.touches[0].pageX-event.touches[1].pageX,dy=event.touches[0].pageY-event.touches[1].pageY,distance=Math.sqrt(dx*dx+dy*dy);dollyEnd.set(0,distance),dollyDelta.subVectors(dollyEnd,dollyStart),dollyDelta.y>0?dollyOut(getZoomScale()):dollyDelta.y<0&&dollyIn(getZoomScale()),dollyStart.copy(dollyEnd),scope.update()}(event);break;case 3:if(!1===scope.enablePan)return;if(state!==STATE.TOUCH_PAN)return;!function handleTouchMovePan(event){panEnd.set(event.touches[0].pageX,event.touches[0].pageY),panDelta.subVectors(panEnd,panStart),pan(panDelta.x,panDelta.y),panStart.copy(panEnd),scope.update()}(event);break;default:state=STATE.NONE}}function onTouchEnd(event){!1!==scope.enabled&&(scope.onChange&&scope.onChange(),state=STATE.NONE)}function onContextMenu(event){}scope.domElement.addEventListener("contextmenu",onContextMenu,!1),scope.domElement.addEventListener("mousedown",onMouseDown,!1),scope.domElement.addEventListener("mousewheel",onMouseWheel,!1),scope.domElement.addEventListener("MozMousePixelScroll",onMouseWheel,!1),scope.domElement.addEventListener("touchstart",onTouchStart,!1),scope.domElement.addEventListener("touchend",onTouchEnd,!1),scope.domElement.addEventListener("touchmove",onTouchMove,!1),window.addEventListener("keydown",onKeyDown,!1),this.update()},Class((function GeomThread(){Inherit(this,Component);const _this=this;var _cache={},_cacheWait={},_receive={};function computeBounding(data){let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.computeBoundingBox(),geom.computeBoundingSphere(),data.boundingBox=geom.boundingBox,data.boundingSphere=geom.boundingSphere}function loadGeometry(e,id){get(e.path).then(data=>{let buffers=[];for(let key in data)Array.isArray(data[key])?(data[key]=new Float32Array(data[key]),buffers.push(data[key].buffer)):data[key].length>0&&buffers.push(data[key].buffer);computeBounding(data),e.custom&&self[e.custom](data),resolve(data,id,buffers)}).catch(er=>{e.preloading||console.error(er)})}function loadSkinnedGeometry(e,id){get(e.path).then(data=>{let buffers=[];for(let key in data)"bones"!=key&&(Array.isArray(data[key])?(data[key]=new Float32Array(data[key]),buffers.push(data[key].buffer)):data[key].length>0&&buffers.push(data[key].buffer));computeBounding(data),e.custom&&self[e.custom](data),resolve(data,id,buffers)})}function geom_useFn(e){Global.FNS||(Global.FNS=[]),Global.FNS.push(e.name)}this.caching=!0,async function(){await Hydra.ready(),Thread.upload(loadGeometry,loadSkinnedGeometry,geom_useFn,computeBounding)}(),this.loadGeometry=function(path,custom,preloading){if(!Device.graphics.gpu)return Promise.resolve(new PlaneGeometry(1,1));if(_cache[path])return Promise.resolve(_cache[path]);if(path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path)),_this.caching){if(_cacheWait[path])return _cacheWait[path];_cacheWait[path]=Promise.create()}return Thread.shared().loadGeometry({path:path,custom:custom,preloading:preloading}).then(data=>{let geometry;if(custom&&_receive[custom])geometry=_receive[custom](data);else{let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.addAttribute("normal",new GeometryAttribute(data.normal||data.position.length,3)),geom.addAttribute("uv",new GeometryAttribute(data.uv||data.position.length/3*2,2)),data.uv2&&geom.addAttribute("uv2",new GeometryAttribute(data.uv2,2)),geom.boundingBox=new Box3((new Vector3).set(data.boundingBox.min.x,data.boundingBox.min.y,data.boundingBox.min.z),(new Vector3).set(data.boundingBox.max.x,data.boundingBox.max.y,data.boundingBox.max.z)),geom.boundingSphere=new Sphere((new Vector3).set(data.boundingSphere.center.x,data.boundingSphere.center.y,data.boundingSphere.center.z),data.boundingSphere.radius),geometry=geom,geom._src=path}_this.caching&&(_cache[path]=geometry),_cacheWait[path].resolve(geometry)}),_cacheWait[path]},this.loadSkinnedGeometry=function(path,custom){if(!Device.graphics.webgl)return Promise.resolve(new PlaneGeometry(1,1));if(_cache[path])return Promise.resolve(_cache[path]);if(path.includes("assets/geometry/")||(path="assets/geometry/"+path),path.includes(".")||(path+=".json"),path=Thread.absolutePath(Assets.getPath(path)),_this.caching){if(_cacheWait[path])return _cacheWait[path];_cacheWait[path]=Promise.create()}return Thread.shared().loadSkinnedGeometry({path:path,custom:custom}).then(data=>{let geometry;if(custom&&_receive[custom])geometry=_receive[custom](data);else{let geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(data.position,3)),geom.addAttribute("normal",new GeometryAttribute(data.normal||data.position.length,3)),geom.addAttribute("uv",new GeometryAttribute(data.uv||data.position.length/3*2,2)),geom.addAttribute("skinIndex",new GeometryAttribute(data.skinIndex,4)),geom.addAttribute("skinWeight",new GeometryAttribute(data.skinWeight,4)),geom.bones=(data.rig?data.rig.bones:data.bones).slice(0),geom.boundingBox=new Box3((new Vector3).set(data.boundingBox.min.x,data.boundingBox.min.y,data.boundingBox.min.z),(new Vector3).set(data.boundingBox.max.x,data.boundingBox.max.y,data.boundingBox.max.z)),geom.boundingSphere=new Sphere((new Vector3).set(data.boundingSphere.center.x,data.boundingSphere.center.y,data.boundingSphere.center.z),data.boundingSphere.radius),geometry=geom,geom._src=path}_this.caching&&(_cache[path]=geometry),_cacheWait[path].resolve(geometry)}),_cacheWait[path]},this.customFunction=function(fn,receive){let name=Thread.upload(fn);name=name[0],t.geom_useFn({name:name}),_receive[name]=receive}}),"static"),Class((function InstanceMesh(_mesh,_shader,_group,_input){Inherit(this,Component);const _this=this;var _config;function updateShader(shader){shader.customCompile=`${shader.vsName}|${shader.fsName}|instance`,shader.resetProgram();let cached=MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=cached.fragment,void(shader.vertexShader=cached.vertex);let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for batching to work`;vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);"),vsSplit[0]+="\n",vsSplit[1]+="#define INSTANCED 1",vsSplit[0]+="attribute vec3 offset;\n",vsSplit[0]+="attribute vec3 scale;\n",vsSplit[0]+="attribute vec4 orientation;\n",vsSplit[0]+=Shaders.getShader("instance.vs")+"\n",vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),fsSplit=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vsSplit,shader.fragmentShader=fsSplit,MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`]={fragment:shader.fragmentShader,vertex:shader.vertexShader}}!function(){(_config=InputUIL.create("im_"+_input.prefix,_group)).add("json"),_config.setLabel("Instance"),_mesh.visible=!1,_mesh.instanceMeshReady=Promise.create(),_mesh.instanceMeshBeforeReady=Promise.create();let json=_config.get("json");json&&async function createInstanceMesh(json){json.includes("assets/geometry")||(json=`assets/geometry/${json}`);json.includes(".json")||(json+=".json");let geom=(new Geometry).instanceFrom(_mesh.geometry),buffers=await Thread.shared().parseInstanceMesh({url:Thread.absolutePath(Assets.getPath(json))});for(let key in buffers){let b=buffers[key];geom.addAttribute(key,new GeometryAttribute(b.buffer,b.components,1))}let shader=_mesh.shader;updateShader(shader);let mesh=new Mesh(geom,shader);mesh.renderOrder=_mesh.renderOrder,mesh.castShadow=_mesh.castShadow,mesh.frustumCulled=!1,_mesh._parent.add(mesh),_mesh.instanceMesh=mesh,_mesh.instanceMeshReady.resolve(),_this.startRender(_=>{mesh.renderOrder=_mesh.renderOrder,mesh.castShadow=_mesh.castShadow},10)}(json)}(),this.applyToShader=function(shader){updateShader(shader)},this.onDestroy=function(){_mesh.instanceMesh&&_mesh.instanceMesh.destroy()}}),_=>{Thread.upload((function parseInstanceMesh({url:url},id){get(url).then(data=>{let buffers=[];for(let key in data)data[key].buffer=new Float32Array(data[key].buffer),buffers.push(data[key].buffer.buffer);resolve(data,id,buffers)})}))}),Class((function MeshBatch(_input){Inherit(this,Object3D);const _this=this;var _geom,_blankShader,_shader,_mesh,_firstRender,_static,_renderOrder=0,_objects=[],_offset=[],_quaternion=[],_scale=[],_attributes={},_uniformToAttrib=[];async function initFromSceneLayout(){let wildcard=_input.get("wildcard");if(!wildcard||!wildcard.length)return;let groupName=wildcard.split("|")[0],group=await _this.parent.getLayer(groupName);await _this.wait(group.children,"length");let children=[...group.children];children.sort((a,b)=>a.renderOrder-b.renderOrder),children.forEach(mesh=>_this.add(mesh)),wildcard.includes("static")&&(_this.static=!0),_this.group.renderOrder=children[0].renderOrder,group.add(_this.group)}function updateShader(shader){shader.customCompile=`${shader.vsName}|${shader.fsName}|instance`;let cached=MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`];if(cached)return shader.fragmentShader=cached.fragment,shader.vertexShader=cached.vertex,shader.resetProgram();if(shader.vertexShader&&shader.vertexShader.includes("transformPosition"))return;shader.resetProgram();let vsSplit=shader.vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__");if(!vsSplit[1].includes("vec3 pos = position;"))throw`Shader ${shader.vsName} needs to have "vec3 pos = position;" in order for batching to work`;let definitions=[];vsSplit[1].split("\n").forEach(line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" "),uni=data[2].replace(";","");(function uniformToAttrib(key){for(let i=0;i<_uniformToAttrib.length;i++){let val=_uniformToAttrib[i];if(key.includes(val)||val.includes(key))return!0}return!1})(uni)&&(definitions.push(`${uni} = a_${data[2]}`),vsSplit[1]=vsSplit[1].replace(line,`attribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`))}}),vsSplit[1]=vsSplit[1].replace(/vec3 pos = position;/g,"vec3 pos = transformPosition(position, offset, scale, orientation);"),vsSplit[1]=vsSplit[1].replace(/vNormal = normalMatrix \* normal;/g,"vNormal = normalMatrix * transformNormal(normal, orientation);"),vsSplit[1]=vsSplit[1].replace(/vec3 transformedNormal = normal;/g,"vec3 transformedNormal = transformNormal(normal, orientation);");let main=vsSplit[1].split("main() {");main[1]="\n"+definitions.join("\n")+main[1],vsSplit[1]=main.join("main() {"),vsSplit[0]+="\n",vsSplit[0]+="attribute vec3 offset;\n",vsSplit[0]+="attribute vec3 scale;\n",vsSplit[0]+="attribute vec4 orientation;\n",vsSplit[0]+=Shaders.getShader("instance.vs")+"\n",vsSplit=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),fsSplit=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.vertexShader=vsSplit,shader.fragmentShader=fsSplit,MeshBatch.shaders[`${shader.vsName}|${shader.fsName}`]={fragment:shader.fragmentShader,vertex:shader.vertexShader}}function dirty(a,b){for(let i=a.length-1;i>-1;i--)if(a[i]!=b[i])return!0;return!1}function loop(){_static&&_this.stopRender(loop);let first=!_firstRender;_firstRender=!0;for(let i=0;i<_objects.length;i++){let mesh=_objects[i];mesh.updateMatrixWorld(first);let pos=mesh.position,scale=mesh.scale,quaternion=mesh.quaternion,i3=3*i,i4=4*i;if(_offset[i3+0]=pos.x,_offset[i3+1]=pos.y,_offset[i3+2]=pos.z,_scale[i3+0]=scale.x,_scale[i3+1]=scale.y,_scale[i3+2]=scale.z,_quaternion[i4+0]=quaternion.x,_quaternion[i4+1]=quaternion.y,_quaternion[i4+2]=quaternion.z,_quaternion[i4+3]=quaternion.w,mesh.attributes)for(let key in mesh.attributes){let value=mesh.attributes[key];value instanceof Color?(_attributes[key][3*i+0]=value.r,_attributes[key][3*i+1]=value.g,_attributes[key][3*i+2]=value.b):value instanceof Vector3?(_attributes[key][3*i+0]=value.x,_attributes[key][3*i+1]=value.y,_attributes[key][3*i+2]=value.z):value instanceof Vector2?(_attributes[key][2*i+0]=value.x,_attributes[key][2*i+1]=value.y):_attributes[key][i]=mesh.attributes[key]}}if(_mesh){dirty(_quaternion,_geom.attributes.orientation.array)&&(_geom.attributes.orientation.array.set(_quaternion),_geom.attributes.orientation.needsUpdate=!0),dirty(_offset,_geom.attributes.offset.array)&&(_geom.attributes.offset.array.set(_offset),_geom.attributes.offset.needsUpdate=!0),dirty(_scale,_geom.attributes.scale.array)&&(_geom.attributes.scale.array.set(_scale),_geom.attributes.scale.needsUpdate=!0);for(let key in _attributes)dirty(_attributes[key],_geom.attributes[key].array)&&(_geom.attributes[key].array.set(_attributes[key]),_geom.attributes[key].needsUpdate=!0)}else!function initMesh(){_geom.addAttribute("offset",new GeometryAttribute(new Float32Array(_offset),3,1)),_geom.addAttribute("scale",new GeometryAttribute(new Float32Array(_scale),3,1)),_geom.addAttribute("orientation",new GeometryAttribute(new Float32Array(_quaternion),4,1));let box=new Box3;_objects.forEach(mesh=>box.expandByObject(mesh,!0)),_geom.boundingBox=box,_geom.boundingSphere=box.getBoundingSphere(),(_mesh=new Mesh(_geom,_shader)).asyncPromise=Promise.resolve(),_this.mesh=_mesh,_this.group.add(_mesh),_renderOrder&&(_mesh.renderOrder=_renderOrder),_offset=new Float32Array(_offset),_quaternion=new Float32Array(_quaternion),_scale=new Float32Array(_scale);for(let key in _attributes){_attributes[key]=new Float32Array(_attributes[key]);let components=1,mesh=_objects[0];mesh.attributes[key]instanceof Vector3?components=3:mesh.attributes[key]instanceof Color?components=3:mesh.attributes[key]instanceof Vector2&&(components=2),_geom.addAttribute(key,new GeometryAttribute(new Float32Array(_attributes[key]),components,1))}_this.onMeshCreated&&_this.onMeshCreated(_mesh)}()}_input&&_this.parent.ready(!0).then(initFromSceneLayout),(_blankShader=Utils3D.getTestShader()).visible=!1,this.add=function(mesh){if(_mesh)throw"Can't add to MeshBatch after it's been compiled";_objects.push(mesh),mesh.uploadIgnore=!0;let shader=mesh.shader;for(let key in shader.uniforms){let uniform=shader.uniforms[key];(uniform.value instanceof Color||uniform.value instanceof Vector2||uniform.value instanceof Vector3||"number"==typeof uniform.value)&&uniform.batchUnique&&(_uniformToAttrib.push(key),mesh.attributes||(mesh.attributes={}),mesh.attributes["a_"+key]=uniform.value)}_geom||function initGeometry(mesh){if(_geom=(new Geometry).instanceFrom(mesh.geometry),_shader=mesh.shader,_this.geom=_geom,updateShader(_shader),mesh.attributes)for(let key in mesh.attributes)_attributes[key]=[]}(mesh),mesh.shader=_blankShader,_this.startRender(loop)},this.set("static",b=>{_objects.length?(loop(),_this.stopRender(loop)):_static=!0}),this.set("renderOrder",v=>{_renderOrder=v,_mesh&&(_mesh.renderOrder=v)}),this.get("renderOrder",_=>_renderOrder),this.set("frustumCulled",b=>_mesh.frustumCulled=b)}),_=>{MeshBatch.shaders={}}),Class((function MeshMerge(_input){Inherit(this,Object3D);const _this=this;var _mesh,_geom,_pending=[];async function initFromSceneLayout(){let wildcard=_input.get("wildcard");if(!wildcard||!wildcard.length)return;let groupName=wildcard.split("|")[0],group=await _this.parent.getLayer(groupName),children=[...group.children];children.sort((a,b)=>a.renderOrder-b.renderOrder),children.forEach(mesh=>_this.add(mesh)),group.add(_this.group)}"object"==typeof _input&&_this.parent.ready().then(initFromSceneLayout),this.add=function(mesh){if(mesh.uploadIgnore=!0,!mesh.visible)return;mesh.updateMatrixWorld(!0),_mesh||async function initMesh(mesh){(_mesh=new Mesh(World.QUAD,mesh.shader)).asyncPromise=Promise.create(),_this.group.add(_mesh),await defer(),(await Promise.all(_pending)).forEach(data=>{let geom=new Geometry;for(let key in data)"components"!=key&&geom.addAttribute(key,new GeometryAttribute(data[key],data.components[key]));_geom?_geom.merge(geom):_geom=geom}),_mesh.geometry=_geom,_mesh.asyncPromise.resolve(),_this.onMeshCreated&&_this.onMeshCreated(_mesh)}(mesh);let geom=mesh.geometry;if(mesh.attributes)for(let key in mesh.attributes){let attr=mesh.attributes[key];attr instanceof Vector4&&(attr.isVector4=!0),attr instanceof Vector3&&(attr.isVector3=!0),attr instanceof Vector2&&(attr.isVector2=!0),attr instanceof Color&&(attr.isColor=!0)}let data={},components={},buffers=[];for(let key in geom.attributes)data[key]=new Float32Array(geom.attributes[key].array),buffers.push(data[key].buffer),components[key]=geom.attributes[key].itemSize;data.attributes=mesh.attributes,data.components=components,data.matrix="world"==_input?mesh.matrixWorld.elements:mesh.matrix.elements,mesh.visible=!1,_pending.push(Thread.shared().meshMergeTransform(data,buffers))}}),_=>{Thread.upload((function meshMergeTransform(e,id){let geom=new Geometry;for(let key in e)!key.includes(["components","matrix"])&&e[key]instanceof Float32Array&&geom.addAttribute(key,new GeometryAttribute(e[key],e.components[key]));if(e.attributes)for(let key in e.attributes){let components=1,attr=e.attributes[key];attr.isVector4?components=4:attr.isVector3?components=3:attr.isColor?components=3:attr.isVector2&&(components=2);let buffer=new Float32Array(geom.attributes.position.count*components),step=buffer.length/components;for(let i=0;i<step;i++)4==components?(buffer[3*i+0]=attr.x,buffer[3*i+1]=attr.y,buffer[3*i+2]=attr.z,buffer[3*i+3]=attr.w):3==components?(buffer[3*i+0]=attr.x||attr.r||0,buffer[3*i+1]=attr.y||attr.g||0,buffer[3*i+2]=attr.z||attr.b||0):2==components?(buffer[2*i+0]=attr.x,buffer[2*i+1]=attr.y):buffer[i]=attr;geom.addAttribute(key,new GeometryAttribute(buffer,components))}geom.applyMatrix((new Matrix4).fromArray(e.matrix));let data={},buffers=[],components={};for(let key in geom.attributes)data[key]=geom.attributes[key].array,components[key]=geom.attributes[key].itemSize,buffers.push(data[key].buffer);data.components=components,resolve(data,id,buffers)}))}),Class((function RenderCount(){const _this=this;var $container,_map={},_display={};this.active=Utils.query("renderCount");const LOG=_this.active&&Utils.query("log");_this.active&&async function initUIL(){await Hydra.ready(),($container=Stage.create("RenderCount")).css({width:150,height:"auto",paddingBottom:5,bottom:0}).bg("#111").setZ(9999999)}(),this.add=function(name,detail,amt=1){if(_this.active){if(void 0===_map[name]&&(_map[name]=0,$container)){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10}),_display[name]=$wrapper}LOG&&(console.groupCollapsed(name),detail&&console.log(detail),console.trace(),console.groupEnd()),_map[name]+=amt,_display[name].value.text(_map[name]||"0")}},this.remove=function(name,amt=1){_this.active&&_map[name]&&(_map[name]-=amt,_display[name].value.text(_map[name]||"0"))}}),"static"),Class((function RenderStats(){var _trace,$container,_map={},_stats={},_display={};function flush(){for(let key in _map)_stats[key]=_map[key],_display[key]&&_display[key].value.text(_map[key]||"0"),_map[key]=0;_trace=null}this.active=Utils.query("renderStats"),Utils.query("renderStats")&&async function initUIL(){await Hydra.ready(),($container=Stage.create("RenderStats")).css({position:"fixed",width:150,height:"auto",paddingTop:5}).bg("#111").setZ(99999)}(),Render.drawFrame=flush,this.update=function(name,amt=1,detail,detail2){if(_trace==name&&(console.groupCollapsed(name),detail&&console.log("string"==typeof detail?detail:Utils.getConstructorName(detail)),detail2&&console.log(detail2),console.trace(),console.groupEnd()),void 0===_map[name]&&(_map[name]=0,$container)){let $wrapper=$container.create("wrapper");$wrapper.css({position:"relative",width:"100%",height:20}),$wrapper.label=$wrapper.create("label"),$wrapper.label.fontStyle("Arial",12,"#fff").text(name).css({left:10}),$wrapper.value=$wrapper.create("value"),$wrapper.value.fontStyle("Arial",12,"#fff").text(0).css({right:10}),_display[name]=$wrapper}_map[name]+=amt},this.trace=function(name){_trace=name},this.log=function(){for(let key in _stats)console.log(key,_stats[key]);console.log("----")}}),"static");class CurvePath extends Curve3D{constructor(){super(),this.curves=[],this.autoClose=!1}add(curve){this.curves.push(curve)}closePath(){let startPoint=this.curves[0].getPoint(0),endPoint=this.curves[this.curves.length-1].getPoint(1);startPoint.equals(endPoint)||this.curves.push(new LineCurve(endPoint,startPoint))}getPoint(t){let d=t*this.getLength(),curveLengths=this.getCurveLengths(),i=0;for(;i<curveLengths.length;){if(curveLengths[i]>=d){let diff=curveLengths[i]-d,curve=this.curves[i],segmentLength=curve.getLength(),u=0===segmentLength?0:1-diff/segmentLength;return curve.getPointAt(u)}i++}return null}getLength(){let lens=this.getCurveLengths();return lens[lens.length-1]}updateArcLengths(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()}getCurveLengths(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;let lengths=[],sums=0;for(let i=0,l=this.curves.length;i<l;i++)sums+=this.curves[i].getLength(),lengths.push(sums);return this.cacheLengths=lengths,lengths}getSpacedPoints(divisions){void 0===divisions&&(divisions=40);let points=[];for(let i=0;i<=divisions;i++)points.push(this.getPoint(i/divisions));return this.autoClose&&points.push(points[0]),points}getPoints(divisions=12){let last,points=[];for(let i=0,curves=this.curves;i<curves.length;i++){let curve=curves[i],resolution=curve&&curve.isEllipseCurve?2*divisions:curve&&(curve.isLineCurve||curve.isLineCurve3)?1:curve&&curve.isSplineCurve?divisions*curve.points.length:divisions,pts=curve.getPoints(resolution);for(let j=0;j<pts.length;j++){let point=pts[j];last&&last.equals(point)||(points.push(point),last=point)}}return this.autoClose&&points.length>1&&!points[points.length-1].equals(points[0])&&points.push(points[0]),points}copy(source){Curve3D.prototype.copy.call(this,source),this.curves=[];for(let i=0,l=source.curves.length;i<l;i++){let curve=source.curves[i];this.curves.push(curve.clone())}return this.autoClose=source.autoClose,this}toJSON(){let data=Curve3D.prototype.toJSON.call(this);data.autoClose=this.autoClose,data.curves=[];for(let i=0,l=this.curves.length;i<l;i++){let curve=this.curves[i];data.curves.push(curve.toJSON())}return data}fromJSON(json){Curve3D.prototype.fromJSON.call(this,json),this.autoClose=json.autoClose,this.curves=[];for(let i=0,l=json.curves.length;i<l;i++){let curve=json.curves[i];this.curves.push((new Curves[curve.type]).fromJSON(curve))}return this}}Class((function Earcut(){Inherit(this,Component);function linkedList(data,start,end,dim,clockwise){var i,last;if(clockwise===function signedArea(data,start,end,dim){for(var sum=0,i=start,j=end-dim;i<end;i+=dim)sum+=(data[j]-data[i])*(data[i+1]+data[j+1]),j=i;return sum}(data,start,end,dim)>0)for(i=start;i<end;i+=dim)last=insertNode(i,data[i],data[i+1],last);else for(i=end-dim;i>=start;i-=dim)last=insertNode(i,data[i],data[i+1],last);return last&&equals(last,last.next)&&(removeNode(last),last=last.next),last}function filterPoints(start,end){if(!start)return start;end||(end=start);var again,p=start;do{if(again=!1,p.steiner||!equals(p,p.next)&&0!==area(p.prev,p,p.next))p=p.next;else{if(removeNode(p),(p=end=p.prev)===p.next)break;again=!0}}while(again||p!==end);return end}function earcutLinked(ear,triangles,dim,minX,minY,invSize,pass){if(ear){!pass&&invSize&&function indexCurve(start,minX,minY,invSize){var p=start;do{null===p.z&&(p.z=zOrder(p.x,p.y,minX,minY,invSize)),p.prevZ=p.prev,p.nextZ=p.next,p=p.next}while(p!==start);p.prevZ.nextZ=null,p.prevZ=null,function sortLinked(list){var i,p,q,e,tail,numMerges,pSize,qSize,inSize=1;do{for(p=list,list=null,tail=null,numMerges=0;p;){for(numMerges++,q=p,pSize=0,i=0;i<inSize&&(pSize++,q=q.nextZ);i++);for(qSize=inSize;pSize>0||qSize>0&&q;)0!==pSize&&(0===qSize||!q||p.z<=q.z)?(e=p,p=p.nextZ,pSize--):(e=q,q=q.nextZ,qSize--),tail?tail.nextZ=e:list=e,e.prevZ=tail,tail=e;p=q}tail.nextZ=null,inSize*=2}while(numMerges>1);return list}(p)}(ear,minX,minY,invSize);for(var prev,next,stop=ear;ear.prev!==ear.next;)if(prev=ear.prev,next=ear.next,invSize?isEarHashed(ear,minX,minY,invSize):isEar(ear))triangles.push(prev.i/dim),triangles.push(ear.i/dim),triangles.push(next.i/dim),removeNode(ear),ear=next.next,stop=next.next;else if((ear=next)===stop){pass?1===pass?earcutLinked(ear=cureLocalIntersections(ear,triangles,dim),triangles,dim,minX,minY,invSize,2):2===pass&&splitEarcut(ear,triangles,dim,minX,minY,invSize):earcutLinked(filterPoints(ear),triangles,dim,minX,minY,invSize,1);break}}}function isEar(ear){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return!1;for(var p=ear.next.next;p!==ear.prev;){if(pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.next}return!0}function isEarHashed(ear,minX,minY,invSize){var a=ear.prev,b=ear,c=ear.next;if(area(a,b,c)>=0)return!1;for(var minTX=a.x<b.x?a.x<c.x?a.x:c.x:b.x<c.x?b.x:c.x,minTY=a.y<b.y?a.y<c.y?a.y:c.y:b.y<c.y?b.y:c.y,maxTX=a.x>b.x?a.x>c.x?a.x:c.x:b.x>c.x?b.x:c.x,maxTY=a.y>b.y?a.y>c.y?a.y:c.y:b.y>c.y?b.y:c.y,minZ=zOrder(minTX,minTY,minX,minY,invSize),maxZ=zOrder(maxTX,maxTY,minX,minY,invSize),p=ear.prevZ,n=ear.nextZ;p&&p.z>=minZ&&n&&n.z<=maxZ;){if(p!==ear.prev&&p!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;if(p=p.prevZ,n!==ear.prev&&n!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,n.x,n.y)&&area(n.prev,n,n.next)>=0)return!1;n=n.nextZ}for(;p&&p.z>=minZ;){if(p!==ear.prev&&p!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,p.x,p.y)&&area(p.prev,p,p.next)>=0)return!1;p=p.prevZ}for(;n&&n.z<=maxZ;){if(n!==ear.prev&&n!==ear.next&&pointInTriangle(a.x,a.y,b.x,b.y,c.x,c.y,n.x,n.y)&&area(n.prev,n,n.next)>=0)return!1;n=n.nextZ}return!0}function cureLocalIntersections(start,triangles,dim){var p=start;do{var a=p.prev,b=p.next.next;!equals(a,b)&&intersects(a,p,p.next,b)&&locallyInside(a,b)&&locallyInside(b,a)&&(triangles.push(a.i/dim),triangles.push(p.i/dim),triangles.push(b.i/dim),removeNode(p),removeNode(p.next),p=start=b),p=p.next}while(p!==start);return p}function splitEarcut(start,triangles,dim,minX,minY,invSize){var a=start;do{for(var b=a.next.next;b!==a.prev;){if(a.i!==b.i&&isValidDiagonal(a,b)){var c=splitPolygon(a,b);return a=filterPoints(a,a.next),c=filterPoints(c,c.next),earcutLinked(a,triangles,dim,minX,minY,invSize),void earcutLinked(c,triangles,dim,minX,minY,invSize)}b=b.next}a=a.next}while(a!==start)}function compareX(a,b){return a.x-b.x}function eliminateHole(hole,outerNode){if(outerNode=function findHoleBridge(hole,outerNode){var m,p=outerNode,hx=hole.x,hy=hole.y,qx=-1/0;do{if(hy<=p.y&&hy>=p.next.y&&p.next.y!==p.y){var x=p.x+(hy-p.y)*(p.next.x-p.x)/(p.next.y-p.y);if(x<=hx&&x>qx){if(qx=x,x===hx){if(hy===p.y)return p;if(hy===p.next.y)return p.next}m=p.x<p.next.x?p:p.next}}p=p.next}while(p!==outerNode);if(!m)return null;if(hx===qx)return m.prev;var tan,stop=m,mx=m.x,my=m.y,tanMin=1/0;p=m.next;for(;p!==stop;)hx>=p.x&&p.x>=mx&&hx!==p.x&&pointInTriangle(hy<my?hx:qx,hy,mx,my,hy<my?qx:hx,hy,p.x,p.y)&&((tan=Math.abs(hy-p.y)/(hx-p.x))<tanMin||tan===tanMin&&p.x>m.x)&&locallyInside(p,hole)&&(m=p,tanMin=tan),p=p.next;return m}(hole,outerNode)){var b=splitPolygon(outerNode,hole);filterPoints(b,b.next)}}function zOrder(x,y,minX,minY,invSize){return(x=1431655765&((x=858993459&((x=252645135&((x=16711935&((x=32767*(x-minX)*invSize)|x<<8))|x<<4))|x<<2))|x<<1))|(y=1431655765&((y=858993459&((y=252645135&((y=16711935&((y=32767*(y-minY)*invSize)|y<<8))|y<<4))|y<<2))|y<<1))<<1}function getLeftmost(start){var p=start,leftmost=start;do{(p.x<leftmost.x||p.x===leftmost.x&&p.y<leftmost.y)&&(leftmost=p),p=p.next}while(p!==start);return leftmost}function pointInTriangle(ax,ay,bx,by,cx,cy,px,py){return(cx-px)*(ay-py)-(ax-px)*(cy-py)>=0&&(ax-px)*(by-py)-(bx-px)*(ay-py)>=0&&(bx-px)*(cy-py)-(cx-px)*(by-py)>=0}function isValidDiagonal(a,b){return a.next.i!==b.i&&a.prev.i!==b.i&&!function intersectsPolygon(a,b){var p=a;do{if(p.i!==a.i&&p.next.i!==a.i&&p.i!==b.i&&p.next.i!==b.i&&intersects(p,p.next,a,b))return!0;p=p.next}while(p!==a);return!1}(a,b)&&locallyInside(a,b)&&locallyInside(b,a)&&function middleInside(a,b){var p=a,inside=!1,px=(a.x+b.x)/2,py=(a.y+b.y)/2;do{p.y>py!=p.next.y>py&&p.next.y!==p.y&&px<(p.next.x-p.x)*(py-p.y)/(p.next.y-p.y)+p.x&&(inside=!inside),p=p.next}while(p!==a);return inside}(a,b)}function area(p,q,r){return(q.y-p.y)*(r.x-q.x)-(q.x-p.x)*(r.y-q.y)}function equals(p1,p2){return p1.x===p2.x&&p1.y===p2.y}function intersects(p1,q1,p2,q2){return!!(equals(p1,p2)&&equals(q1,q2)||equals(p1,q2)&&equals(p2,q1))||area(p1,q1,p2)>0!=area(p1,q1,q2)>0&&area(p2,q2,p1)>0!=area(p2,q2,q1)>0}function locallyInside(a,b){return area(a.prev,a,a.next)<0?area(a,b,a.next)>=0&&area(a,a.prev,b)>=0:area(a,b,a.prev)<0||area(a,a.next,b)<0}function splitPolygon(a,b){var a2=new Node(a.i,a.x,a.y),b2=new Node(b.i,b.x,b.y),an=a.next,bp=b.prev;return a.next=b,b.prev=a,a2.next=an,an.prev=a2,b2.next=a2,a2.prev=b2,bp.next=b2,b2.prev=bp,b2}function insertNode(i,x,y,last){var p=new Node(i,x,y);return last?(p.next=last.next,p.prev=last,last.next.prev=p,last.next=p):(p.prev=p,p.next=p),p}function removeNode(p){p.next.prev=p.prev,p.prev.next=p.next,p.prevZ&&(p.prevZ.nextZ=p.nextZ),p.nextZ&&(p.nextZ.prevZ=p.prevZ)}function Node(i,x,y){this.i=i,this.x=x,this.y=y,this.prev=null,this.next=null,this.z=null,this.prevZ=null,this.nextZ=null,this.steiner=!1}this.triangulate=function(data,holeIndices,dim){dim=dim||2;var minX,minY,maxX,maxY,x,y,invSize,hasHoles=holeIndices&&holeIndices.length,outerLen=hasHoles?holeIndices[0]*dim:data.length,outerNode=linkedList(data,0,outerLen,dim,!0),triangles=[];if(!outerNode||outerNode.next===outerNode.prev)return triangles;if(hasHoles&&(outerNode=function eliminateHoles(data,holeIndices,outerNode,dim){var i,len,list,queue=[];for(i=0,len=holeIndices.length;i<len;i++)(list=linkedList(data,holeIndices[i]*dim,i<len-1?holeIndices[i+1]*dim:data.length,dim,!1))===list.next&&(list.steiner=!0),queue.push(getLeftmost(list));for(queue.sort(compareX),i=0;i<queue.length;i++)eliminateHole(queue[i],outerNode),outerNode=filterPoints(outerNode,outerNode.next);return outerNode}(data,holeIndices,outerNode,dim)),data.length>80*dim){minX=maxX=data[0],minY=maxY=data[1];for(var i=dim;i<outerLen;i+=dim)(x=data[i])<minX&&(minX=x),(y=data[i+1])<minY&&(minY=y),x>maxX&&(maxX=x),y>maxY&&(maxY=y);invSize=0!==(invSize=Math.max(maxX-minX,maxY-minY))?1/invSize:0}return earcutLinked(outerNode,triangles,dim,minX,minY,invSize),triangles}}),"static");class ExtrudeGeometry extends Geometry{constructor(shapes,options){super();var WorldUVGenerator={generateTopUV:function(geometry,vertices,indexA,indexB,indexC){var a_x=vertices[3*indexA],a_y=vertices[3*indexA+1],b_x=vertices[3*indexB],b_y=vertices[3*indexB+1],c_x=vertices[3*indexC],c_y=vertices[3*indexC+1];return[new Vector2(a_x,a_y),new Vector2(b_x,b_y),new Vector2(c_x,c_y)]},generateSideWallUV:function(geometry,vertices,indexA,indexB,indexC,indexD){var a_x=vertices[3*indexA],a_y=vertices[3*indexA+1],a_z=vertices[3*indexA+2],b_x=vertices[3*indexB],b_y=vertices[3*indexB+1],b_z=vertices[3*indexB+2],c_x=vertices[3*indexC],c_y=vertices[3*indexC+1],c_z=vertices[3*indexC+2],d_x=vertices[3*indexD],d_y=vertices[3*indexD+1],d_z=vertices[3*indexD+2];return Math.abs(a_y-b_y)<.01?[new Vector2(a_x,1-a_z),new Vector2(b_x,1-b_z),new Vector2(c_x,1-c_z),new Vector2(d_x,1-d_z)]:[new Vector2(a_y,1-a_z),new Vector2(b_y,1-b_z),new Vector2(c_y,1-c_z),new Vector2(d_y,1-d_z)]}};shapes=Array.isArray(shapes)?shapes:[shapes];for(var scope=this,xcount=0,vals=[0,1,0,1,1,0],verticesArray=[],uvArray=[],i=0,l=shapes.length;i<l;i++){addShape(shapes[i])}function addShape(shape){var extrudePts,splineTube,binormal,normal,position2,ahole,h,hl,placeholder=[],curveSegments=void 0!==options.curveSegments?options.curveSegments:12,steps=void 0!==options.steps?options.steps:1,depth=void 0!==options.depth?options.depth:100,bevelEnabled=void 0===options.bevelEnabled||options.bevelEnabled,bevelThickness=void 0!==options.bevelThickness?options.bevelThickness:6,bevelSize=void 0!==options.bevelSize?options.bevelSize:bevelThickness-2,bevelOffset=void 0!==options.bevelOffset?options.bevelOffset:0,bevelSegments=void 0!==options.bevelSegments?options.bevelSegments:3,extrudePath=options.extrudePath,uvgen=void 0!==options.UVGenerator?options.UVGenerator:WorldUVGenerator,extrudeByPath=!1;extrudePath&&(extrudePts=extrudePath.getSpacedPoints(steps),extrudeByPath=!0,bevelEnabled=!1,splineTube=extrudePath.computeFrenetFrames(steps,!1),binormal=new Vector3,normal=new Vector3,position2=new Vector3),bevelEnabled||(bevelSegments=0,bevelThickness=0,bevelSize=0,bevelOffset=0);var shapePoints=shape.extractPoints(curveSegments),vertices=shapePoints.shape,holes=shapePoints.holes;if(!ExtrudeUtils.isClockWise(vertices))for(vertices=vertices.reverse(),h=0,hl=holes.length;h<hl;h++)ahole=holes[h],ExtrudeUtils.isClockWise(ahole)&&(holes[h]=ahole.reverse());var faces=ExtrudeUtils.triangulateShape(vertices,holes),contour=vertices;for(h=0,hl=holes.length;h<hl;h++)ahole=holes[h],vertices=vertices.concat(ahole);function scalePt2(pt,vec,size){return vec||console.error("THREE.ExtrudeGeometry: vec does not exist"),vec.clone().multiplyScalar(size).add(pt)}var b,bs,t,z,vert,face,vlen=vertices.length,flen=faces.length;function getBevelVec(inPt,inPrev,inNext){var v_trans_x,v_trans_y,shrink_by,v_prev_x=inPt.x-inPrev.x,v_prev_y=inPt.y-inPrev.y,v_next_x=inNext.x-inPt.x,v_next_y=inNext.y-inPt.y,v_prev_lensq=v_prev_x*v_prev_x+v_prev_y*v_prev_y,collinear0=v_prev_x*v_next_y-v_prev_y*v_next_x;if(Math.abs(collinear0)>Number.EPSILON){var v_prev_len=Math.sqrt(v_prev_lensq),v_next_len=Math.sqrt(v_next_x*v_next_x+v_next_y*v_next_y),ptPrevShift_x=inPrev.x-v_prev_y/v_prev_len,ptPrevShift_y=inPrev.y+v_prev_x/v_prev_len,sf=((inNext.x-v_next_y/v_next_len-ptPrevShift_x)*v_next_y-(inNext.y+v_next_x/v_next_len-ptPrevShift_y)*v_next_x)/(v_prev_x*v_next_y-v_prev_y*v_next_x),v_trans_lensq=(v_trans_x=ptPrevShift_x+v_prev_x*sf-inPt.x)*v_trans_x+(v_trans_y=ptPrevShift_y+v_prev_y*sf-inPt.y)*v_trans_y;if(v_trans_lensq<=2)return new Vector2(v_trans_x,v_trans_y);shrink_by=Math.sqrt(v_trans_lensq/2)}else{var direction_eq=!1;v_prev_x>Number.EPSILON?v_next_x>Number.EPSILON&&(direction_eq=!0):v_prev_x<-Number.EPSILON?v_next_x<-Number.EPSILON&&(direction_eq=!0):Math.sign(v_prev_y)===Math.sign(v_next_y)&&(direction_eq=!0),direction_eq?(v_trans_x=-v_prev_y,v_trans_y=v_prev_x,shrink_by=Math.sqrt(v_prev_lensq)):(v_trans_x=v_prev_x,v_trans_y=v_prev_y,shrink_by=Math.sqrt(v_prev_lensq/2))}return new Vector2(v_trans_x/shrink_by,v_trans_y/shrink_by)}for(var contourMovements=[],i=0,il=contour.length,j=il-1,k=i+1;i<il;i++,j++,k++)j===il&&(j=0),k===il&&(k=0),contourMovements[i]=getBevelVec(contour[i],contour[j],contour[k]);var oneHoleMovements,s,holesMovements=[],verticesMovements=contourMovements.concat();for(h=0,hl=holes.length;h<hl;h++){for(ahole=holes[h],oneHoleMovements=[],i=0,j=(il=ahole.length)-1,k=i+1;i<il;i++,j++,k++)j===il&&(j=0),k===il&&(k=0),oneHoleMovements[i]=getBevelVec(ahole[i],ahole[j],ahole[k]);holesMovements.push(oneHoleMovements),verticesMovements=verticesMovements.concat(oneHoleMovements)}for(b=0;b<bevelSegments;b++){for(t=b/bevelSegments,z=bevelThickness*Math.cos(t*Math.PI/2),bs=bevelSize*Math.sin(t*Math.PI/2)+bevelOffset,i=0,il=contour.length;i<il;i++)v((vert=scalePt2(contour[i],contourMovements[i],bs)).x,vert.y,-z);for(h=0,hl=holes.length;h<hl;h++)for(ahole=holes[h],oneHoleMovements=holesMovements[h],i=0,il=ahole.length;i<il;i++)v((vert=scalePt2(ahole[i],oneHoleMovements[i],bs)).x,vert.y,-z)}for(bs=bevelSize+bevelOffset,i=0;i<vlen;i++)vert=bevelEnabled?scalePt2(vertices[i],verticesMovements[i],bs):vertices[i],extrudeByPath?(normal.copy(splineTube.normals[0]).multiplyScalar(vert.x),binormal.copy(splineTube.binormals[0]).multiplyScalar(vert.y),position2.copy(extrudePts[0]).add(normal).add(binormal),v(position2.x,position2.y,position2.z)):v(vert.x,vert.y,0);for(s=1;s<=steps;s++)for(i=0;i<vlen;i++)vert=bevelEnabled?scalePt2(vertices[i],verticesMovements[i],bs):vertices[i],extrudeByPath?(normal.copy(splineTube.normals[s]).multiplyScalar(vert.x),binormal.copy(splineTube.binormals[s]).multiplyScalar(vert.y),position2.copy(extrudePts[s]).add(normal).add(binormal),v(position2.x,position2.y,position2.z)):v(vert.x,vert.y,depth/steps*s);for(b=bevelSegments-1;b>=0;b--){for(t=b/bevelSegments,z=bevelThickness*Math.cos(t*Math.PI/2),bs=bevelSize*Math.sin(t*Math.PI/2)+bevelOffset,i=0,il=contour.length;i<il;i++)v((vert=scalePt2(contour[i],contourMovements[i],bs)).x,vert.y,depth+z);for(h=0,hl=holes.length;h<hl;h++)for(ahole=holes[h],oneHoleMovements=holesMovements[h],i=0,il=ahole.length;i<il;i++)vert=scalePt2(ahole[i],oneHoleMovements[i],bs),extrudeByPath?v(vert.x,vert.y+extrudePts[steps-1].y,extrudePts[steps-1].x+z):v(vert.x,vert.y,depth+z)}function sidewalls(contour,layeroffset){var j,k;for(i=contour.length;--i>=0;){j=i,(k=i-1)<0&&(k=contour.length-1);var s=0,sl=steps+2*bevelSegments;for(s=0;s<sl;s++){var slen1=vlen*s,slen2=vlen*(s+1);f4(layeroffset+j+slen1,layeroffset+k+slen1,layeroffset+k+slen2,layeroffset+j+slen2)}}}function v(x,y,z){placeholder.push(x),placeholder.push(y),placeholder.push(z)}function f3(a,b,c){addVertex(a),addVertex(b),addVertex(c);var nextIndex=verticesArray.length/3,uvs=uvgen.generateTopUV(scope,verticesArray,nextIndex-3,nextIndex-2,nextIndex-1);addUV(uvs[0]),addUV(uvs[1]),addUV(uvs[2])}function f4(a,b,c,d){addVertex(a),addVertex(b),addVertex(d),addVertex(b),addVertex(c),addVertex(d);var nextIndex=verticesArray.length/3,uvs=uvgen.generateSideWallUV(scope,verticesArray,nextIndex-6,nextIndex-3,nextIndex-2,nextIndex-1);addUV(uvs[0]),addUV(uvs[1]),addUV(uvs[3]),addUV(uvs[1]),addUV(uvs[2]),addUV(uvs[3])}function addVertex(index){verticesArray.push(placeholder[3*index+0]),verticesArray.push(placeholder[3*index+1]),verticesArray.push(placeholder[3*index+2])}function addUV(vector2){let index=xcount++%vals.length;uvArray.push(vals[index]),uvArray.push(vector2.y)}!function buildLidFaces(){verticesArray.length;if(bevelEnabled){var layer=0,offset=vlen*layer;for(i=0;i<flen;i++)f3((face=faces[i])[2]+offset,face[1]+offset,face[0]+offset);for(offset=vlen*(layer=steps+2*bevelSegments),i=0;i<flen;i++)f3((face=faces[i])[0]+offset,face[1]+offset,face[2]+offset)}else{for(i=0;i<flen;i++)f3((face=faces[i])[2],face[1],face[0]);for(i=0;i<flen;i++)f3((face=faces[i])[0]+vlen*steps,face[1]+vlen*steps,face[2]+vlen*steps)}}(),function buildSideFaces(){verticesArray.length;var layeroffset=0;for(sidewalls(contour,layeroffset),layeroffset+=contour.length,h=0,hl=holes.length;h<hl;h++)sidewalls(ahole=holes[h],layeroffset),layeroffset+=ahole.length}()}this.addAttribute("position",new GeometryAttribute(new Float32Array(verticesArray),3)),this.addAttribute("uv",new GeometryAttribute(new Float32Array(uvArray),2))}}Class((function ExtrudeUtils(){Inherit(this,Component);const _this=this;function removeDupEndPts(points){let l=points.length;l>2&&points[l-1].equals(points[0])&&points.pop()}function addContour(vertices,contour){for(let i=0;i<contour.length;i++)vertices.push(contour[i].x),vertices.push(contour[i].y)}!async function(){window.THREAD||(await Hydra.ready(),Thread.shared(!0).array.forEach(thread=>{Curve.loadOnThread(thread),["CurvePath","Path","Shape","LineCurve","ExtrudeGeometry"].forEach(name=>{thread.importES6Class(name)}),thread.importClass(LinkedList),thread.importCode(`Class(${_this.constructor.toString()}, 'static')`),thread.importCode(`Class(${Earcut.constructor.toString()}, 'static')`)}))}(),this.area=function(contour){let n=contour.length,a=0;for(let p=n-1,q=0;q<n;p=q++)a+=contour[p].x*contour[q].y-contour[q].x*contour[p].y;return.5*a},this.isClockWise=function(pts){return _this.area(pts)<0},this.triangulateShape=function(contour,holes){let vertices=[],holeIndices=[],faces=[];removeDupEndPts(contour),addContour(vertices,contour);let holeIndex=contour.length;holes.forEach(removeDupEndPts);for(let i=0;i<holes.length;i++)holeIndices.push(holeIndex),holeIndex+=holes[i].length,addContour(vertices,holes[i]);let triangles=Earcut.triangulate(vertices,holeIndices);for(let i=0;i<triangles.length;i+=3)faces.push(triangles.slice(i,i+3));return faces}}),"static");class LineCurve extends Curve3D{constructor(v1,v2){super(),this.type="LineCurve",this.v1=v1||new Vector2,this.v2=v2||new Vector2,this.isLineCurve=!0}getPoint(t,optionalTarget){var point=optionalTarget||new Vector2;return 1===t?point.copy(this.v2):(point.copy(this.v2).sub(this.v1),point.multiplyScalar(t).add(this.v1)),point}getPointAt(u,optionalTarget){return this.getPoint(u,optionalTarget)}getTangent(){return this.v2.clone().sub(this.v1).normalize()}copy(source){return Curve3D.prototype.copy.call(this,source),this.v1.copy(source.v1),this.v2.copy(source.v2),this}toJSON(){var data=Curve3D.prototype.toJSON.call(this);return data.v1=this.v1.toArray(),data.v2=this.v2.toArray(),data}fromJSON(json){return Curve.prototype.fromJSON.call(this,json),this.v1.fromArray(json.v1),this.v2.fromArray(json.v2),this}}class Path extends CurvePath{constructor(points){super(),this.type="Path",this.currentPoint=new Vector2,points&&this.setFromPoints(points)}setFromPoints(points){this.moveTo(points[0].x,points[0].y);for(let i=1,l=points.length;i<l;i++)this.lineTo(points[i].x,points[i].y)}moveTo(x,y){this.currentPoint.set(x,y)}lineTo(x,y){let curve=new LineCurve(this.currentPoint.clone(),new Vector2(x,y));this.curves.push(curve),this.currentPoint.set(x,y)}quadraticCurveTo(aCPx,aCPy,aX,aY){let curve=new QuadraticBezierCurve(this.currentPoint.clone(),new Vector2(aCPx,aCPy),new Vector2(aX,aY));this.curves.push(curve),this.currentPoint.set(aX,aY)}bezierCurveTo(aCP1x,aCP1y,aCP2x,aCP2y,aX,aY){let curve=new CubicBezierCurve(this.currentPoint.clone(),new Vector2(aCP1x,aCP1y),new Vector2(aCP2x,aCP2y),new Vector2(aX,aY));this.curves.push(curve),this.currentPoint.set(aX,aY)}splineThru(pts){let npts=[this.currentPoint.clone()].concat(pts),curve=new SplineCurve(npts);this.curves.push(curve),this.currentPoint.copy(pts[pts.length-1])}arc(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){let x0=this.currentPoint.x,y0=this.currentPoint.y;this.absarc(aX+x0,aY+y0,aRadius,aStartAngle,aEndAngle,aClockwise)}absarc(aX,aY,aRadius,aStartAngle,aEndAngle,aClockwise){this.absellipse(aX,aY,aRadius,aRadius,aStartAngle,aEndAngle,aClockwise)}ellipse(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation){let x0=this.currentPoint.x,y0=this.currentPoint.y;this.absellipse(aX+x0,aY+y0,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation)}absellipse(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation){let curve=new EllipseCurve(aX,aY,xRadius,yRadius,aStartAngle,aEndAngle,aClockwise,aRotation);if(this.curves.length>0){let firstPoint=curve.getPoint(0);firstPoint.equals(this.currentPoint)||this.lineTo(firstPoint.x,firstPoint.y)}this.curves.push(curve);let lastPoint=curve.getPoint(1);this.currentPoint.copy(lastPoint)}copy(source){return CurvePath.prototype.copy.call(this,source),this.currentPoint.copy(source.currentPoint),this}toJSON(){let data=CurvePath.prototype.toJSON.call(this);return data.currentPoint=this.currentPoint.toArray(),data}fromJSON(json){return CurvePath.prototype.fromJSON.call(this,json),this.currentPoint.fromArray(json.currentPoint),this}}class Shape extends Path{constructor(points){super(points),this.type="Shape",this.holes=[]}getPointsHoles(divisions){let holesPts=[];for(let i=0,l=this.holes.length;i<l;i++)holesPts[i]=this.holes[i].getPoints(divisions);return holesPts}extractPoints(divisions){return{shape:this.getPoints(divisions),holes:this.getPointsHoles(divisions)}}copy(source){Path.prototype.copy.call(this,source),this.holes=[];for(let i=0,l=source.holes.length;i<l;i++){let hole=source.holes[i];this.holes.push(hole.clone())}return this}toJSON(){let data=Path.prototype.toJSON.call(this);data.holes=[];for(let i=0,l=this.holes.length;i<l;i++){let hole=this.holes[i];data.holes.push(hole.toJSON())}return data}fromJSON(json){Path.prototype.fromJSON.call(this,json),this.holes=[];for(let i=0,l=json.holes.length;i<l;i++){let hole=json.holes[i];this.holes.push((new Path).fromJSON(hole))}return this}}Class((function Fullscreen(){Inherit(this,Events);const _this=this;function update(){const isOpen=!!(document.fullscreenElement||document.webkitFullscreenElement||document.mozFullScreenElement||document.msFullscreenElement);isOpen!==_this.isOpen&&(_this.isOpen=isOpen,_this.events.fire(Events.FULLSCREEN,{fullscreen:_this.isOpen}))}this.isOpen=!1,function addHandlers(){["onfullscreenchange","onwebkitfullscreenchange","onmozfullscreenchange","onmsfullscreenchange","onfullscreenerror","onwebkitfullscreenerror","onmozfullscreenerror","onmsfullscreenerror"].forEach(evt=>{void 0!==document[evt]&&(document[evt]=update)})}(),this.open=function(element){element=element||document.body,["requestFullscreen","webkitRequestFullscreen","mozRequestFullScreen","msRequestFullscreen"].every(method=>{if(void 0===element[method])return!0;element[method]({navigationUI:"hide"})})},this.close=function(){["exitFullscreen","webkitExitFullscreen","mozCancelFullScreen","msExitFullscreen"].every(method=>{if(void 0===document[method])return!0;document[method]()})}}),"static"),Class((function FXAA(){Inherit(this,NukePass);this.uniforms={},this.init("FXAA","FXAA")})),Class((function GameCenter(){Inherit(this,Component);let _socket,_coords,_this=this,_id=Utils.timestamp();function getCoords(){if(!_this.useCoordinates)return _coords=[0,0],Promise.resolve();let promise=Promise.create();return navigator.geolocation.getCurrentPosition(data=>{_coords=[data.coords.latitude,data.coords.longitude],_this.events.fire(_this.LOCATED),promise.resolve()},error=>{_this.events.fire(_this.LOCATION_ERROR)}),promise}function connected(){_this.events.fire(_this.CONNECTED),_this.events.sub(_socket,"server_data",handleServerData),_this.flag("connected",!0)}function handleServerData(e){_this.events.fire(_this.SERVER_DATA,e)}this.userData={},this.useCoordinates=!1,this.ports=1,this.CONNECTED="gamecenter_connect",this.DISCONNECTED="gamecenter_disconnected",this.LOCATION_ERROR="gamecenter_location_error",this.LOCATED="gamecenter_located",this.DATA="gamecenter_data",this.START_GAME="gamecenter_start_game",this.END_GAME="gamecenter_end_game",this.LOST_CONNECTION="gamecenter_lost_connection",this.SERVER_DATA="gamecenter_server_data",this.BROADCAST="gamecenter_server_data",this.BLOCKED_ERROR="gamecenter_blocked_error",this.connect=function(server){Math.random(0,this.ports-1);let connectTime=Date.now();_socket=new SocketConnection(server),_this.socket=_socket,_this.events.sub(_socket,SocketConnection.OPEN,connected),_this.events.sub(_socket,SocketConnection.CLOSE,_=>{_this.flag("connected",!1),Date.now()-connectTime<100&&_this.events.fire(_this.BLOCKED_ERROR),_this.events.fire(_this.LOST_CONNECTION,{reconnected:_=>_this.wait("connected")})}),_this.events.sub(_socket,SocketConnection.ERROR,_=>{_this.flag("connected",!1),_this.events.fire(_this.LOST_CONNECTION,{reconnected:_=>_this.wait("connected")})}),_this.events.sub(_socket,"broadcast",e=>{_this.events.fire(_this.BROADCAST,e)})},this.locateUser=function(){getCoords()},this.createRoom=function(type="any",maxInRoom){let promise=Promise.create(),create=function(){let room=new GameCenterRoom(Utils.timestamp(),_socket);room.create(type,maxInRoom),promise.resolve(room)};return _coords?create():getCoords().then(create),promise},this.findRoom=function(type="any",maxInRoom){let promise=Promise.create(),find=function(){_this.roundTrip("findAny",{coords:_coords,type:type},async data=>{let room=new GameCenterRoom(data.id,_socket);type.includes("community")&&room.communityRoom();try{await room.join(maxInRoom),promise.resolve(room)}catch(e){promise.reject()}})};return _coords?find():getCoords().then(find),promise},this.joinRoom=async function(id,maxInRoom){try{let room=new GameCenterRoom(id,_socket);return await room.join(maxInRoom),room}catch(e){throw"Couldn't join!"}},this.findNearby=function(type="any"){let promise=Promise.create();if(!this.useCoordinates)throw"findNearby requires user coords";let find=function(){_this.roundTrip("findNearby",{coords:_coords,type:type},data=>{promise.resolve(data)})};return _coords?find():getCoords().then(find),promise},this.roundTrip=function(evt,data,callback){let receive=e=>{_this.events.unsub(_socket,`${evt}_response`,receive),callback&&callback(e)};_this.events.sub(_socket,`${evt}_response`,receive),_socket.send(evt,data)},this.sendData=function(data={}){_socket&&(data.id=_id,_socket.send("server_data",data))},this.broadcast=function(data={}){_socket.send("broadcast",data)},this.set("coords",v=>{_coords=v}),this.get("coords",_=>_coords)}),"static"),Class((function GameCenterPlayer(_id,_socket,_data,_initiator,_community){Inherit(this,Component);var _this=this,_evt={target:_this,id:_id},_results=[],_messages={},_lastMessage=Render.TIME;function sendPing(){if(_results.length>=3)return;let message={_ping:!0};message.id=Utils.timestamp(),message.outTime=Date.now(),_messages[message.id]=message,_this.emit(message)}function handlePing(data){let outgoing=_messages[data.id];if(console.log(_results),outgoing){let difference=Date.now()-data.inTime;_results.unshift(difference),_this.offset=difference,_results.length<3?sendPing():function calculate(){_this.flag("ready",!0),_this.events.fire(Events.READY),_results.length>3&&(_results=_results.slice(0,3)),_results.sort((a,b)=>a-b),_this.offset=_results[1]}()}else data.inTime=Date.now(),_this.emit(data)}function onMessage(data){if(_this.ping=Render.TIME-_lastMessage,_lastMessage=Render.TIME,data._ping)return handlePing(data);_evt.player=_this,_evt.data=data,_this.events.fire(GameCenter.DATA,_evt)}function ready(e){console.log(e),_this.connection.isNull||(e.socket&&_this.events.fire(GameCenterPlayer.FALLBACK_SOCKET),_this.delayedCall(()=>{sendPing()},10))}this.connection=new(_community?GameCenterNull:GameCenterRTC)(_id,_socket,_initiator,_this),this.id=_id,this.data=_data,this.offset=0,this.ping=0,console.log(_this.connection),function addListeners(){_this.connection.isNull||(_this.events.sub(_this.connection,Events.READY,ready),_this.events.bubble(_this.connection,Events.ERROR),_this.connection.onMessage=onMessage)}(),this.onMessage=onMessage,this.emit=function(data){_this.connection.emit(data.length?data:JSON.stringify(data))},this.disconnect=function(){_this.connection.close(),_this.events.fire(GameCenter.DISCONNECTED)},this.connected=function(){return _this.wait("ready")}}),_=>{GameCenterPlayer.UPDATE_DATA="gcp_update_data",GameCenterPlayer.FALLBACK_SOCKET="gcp_update_data"}),Class((function GameCenterUser(_socket,_community){Inherit(this,Component);this.connection=new(_community?GameCenterSocket:GameCenterNull)(_socket),this.me=!0,this.data=GameCenter.userData,this.id=GameCenter.GCID,this.disconnect=function(){}})),Class((function GameCenterConnection(){Inherit(this,Component);this.establish=function(){},this.emit=function(){},this.wsData=function(){}})),Class((function GameCenterNull(){const prototype=GameCenterNull.prototype;void 0===prototype.establish&&(prototype.isNull=!0,prototype.establish=function(){},prototype.emit=function(){},prototype.wsData=function(){},prototype.close=function(){})})),Class((function GameCenterRTC(_id,_socket,_initiator,_parent){Inherit(this,Component);var _peer,_data,_fallbackSocket,_timeout,_this=this;const MEDIA=window.GameCenterMedia&&GameCenterMedia.p2pStream;async function initStream(){let localStream=await GameCenterMedia.getUserStream();localStream.getTracks().forEach(track=>_peer.addTrack(track,localStream)),_this.events.sub(GameCenterMediaUserStream.UPDATE,async _=>{(await GameCenterMedia.getUserStream()).getTracks().forEach(track=>{_peer.getSenders().forEach(async s=>{s.replaceTrack(track)})})})}function fallbackToSocket(){clearTimeout(_timeout),_socket.send("ws_data",{from:GameCenter.GCID,fallbackToSocket:!0}),_fallbackSocket=!0,_this.events.fire(Events.READY,{socket:!0})}function sendNegotiation(type,sdp){let data={to:_id,type:type,sdp:sdp};_socket.send("establish_rtc",data)}function dataMessage(e){_this.onMessage&&_this.onMessage(JSON.parse(e.data))}function dataOpen(e){_this.events.fire(Events.READY)}function dataClose(e){clearTimeout(_timeout),_this.events.fire(Events.ERROR,{gcID:_id})}function dataError(e){_this.events.fire(Events.ERROR,{gcID:_id})}MEDIA&&function initMedia(){_parent.rtcStream=Promise.create(),_parent.video=document.createElement("video"),_parent.video.autoplay=!0,_parent.videoTexture=_this.initClass(StreamVideoTexture,_parent.video)}(),function initPeerConnection(){_peer=new RTCPeerConnection({sdpSemantics:MEDIA?"unified-plan":void 0,iceServers:[{urls:"stun:stun.l.google.com:19302"}]}),_timeout=_this.delayedCall(fallbackToSocket,7e3),_peer.onicecandidate=e=>{_peer&&e&&e.candidate&&sendNegotiation("candidate",e.candidate)},(_data=_peer.createDataChannel("gamecenter",{ordered:!1,negotiated:!0,id:7})).onmessage=dataMessage,_data.onopen=dataOpen,_data.onclose=dataClose,_data.onerror=dataError,_peer.ondatachannel=e=>{e.channel.onmessage=dataMessage,e.channel.onclose=dataClose,e.channel.onerror=dataError},_peer.onconnectionstatechange=e=>{switch(_peer.iceConnectionState){case"connected":_this.flag("connected",!0),clearTimeout(_timeout);break;case"disconnected":_this.flag("connected",!1)}},_peer.oniceconnectionstatechange=e=>{"failed"==_peer.iceConnectionState&&fallbackToSocket()},MEDIA&&(_peer.ontrack=e=>{_parent.video.srcObject=e.streams[0],_parent.rtcStream.resolve()})}(),_initiator&&async function initConnection(){MEDIA&&await initStream();let sdp=await _peer.createOffer();_peer.setLocalDescription(sdp),sendNegotiation("offer",sdp)}(),this.establish=function(data){if(_peer)switch(data.type){case"candidate":!function processIce(iceCandidate){if(!_this.flag("connected"))try{_peer.addIceCandidate(new RTCIceCandidate(iceCandidate))}catch(e){console.error(e),_this.events.fire(Events.ERROR,{gcID:_id})}}(data.sdp);break;case"offer":!async function processOffer(offer){if(!_this.flag("connected"))try{await _peer.setRemoteDescription(new RTCSessionDescription(offer)),MEDIA&&await initStream();let sdp=await _peer.createAnswer();_peer.setLocalDescription(sdp).catch(e=>_this.events.fire(Events.ERROR,{gcID:_id})),sendNegotiation("answer",sdp)}catch(e){console.error(e)}}(data.sdp);break;case"answer":!async function processAnswer(answer){if(!_this.flag("connected")){try{await _peer.setRemoteDescription(new RTCSessionDescription(answer))}catch(e){console.error(e),_this.events.fire(Events.ERROR,{gcID:_id})}return!0}}(data.sdp)}},this.emit=function(data){if(_fallbackSocket)"string"==typeof data&&(data=JSON.parse(data)),data.to=_id,data.from=GameCenter.GCID,_socket.send("ws_data",data);else{if(_data&&"open"!=_data.readyState)return;try{_data&&_data.send(data)}catch(e){console.log(e)}}},this.wsData=function(data){if(data.fallbackToSocket)return _fallbackSocket=!0,void _this.events.fire(Events.READY,{socket:!0});_this.onMessage&&_this.onMessage(data)},this.close=function(){_peer&&(_peer.close(),_peer.onconnectionstatechange=null,_peer.ondatachannel=null,_peer.oniceconnectionstatechange=null,_peer.onicecandidate=null,_peer=null,clearTimeout(_timeout))}})),Class((function GameCenterSocket(_socket){Inherit(this,Component);this.emit=function(data={}){_socket.send("ws_data",data)}})),Class((function GameCenterRoom(_id,_socket){Inherit(this,Component);var _aliveTimer,_fallbackSocket,_this=this;this.id=_id,this.host=!1,this.players=[];var _playerMap=new Map,_players=_this.players;function createPlayer(id,data,init){let player=new GameCenterPlayer(id,_socket,data,init,_this.isCommunity);return _this.events.sub(player,GameCenter.DATA,playerData),_this.events.sub(player,Events.ERROR,playerDisconnect),_this.events.sub(player,GameCenterPlayer.FALLBACK_SOCKET,fallbackSocket),_this.events.sub(player,Events.READY,async()=>{await defer(),_this.events.fire(GameCenterRoom.PLAYER_READY,{player:player})}),player}function fallbackSocket(){_fallbackSocket=!0}function updateUserData({data:data}){_players.forEach(player=>{player.id==data.gcID&&(player.data=data.data,player.events.fire(GameCenterPlayer.UPDATE_DATA,{player:player,data:player.data}))})}function forceDisconnect(e){_this.events.fire(GameCenterRoom.ERROR)}function closeRoom(){_this.destroy()}function startGame(e){_this.events.fire(GameCenter.START_GAME,e)}function endGame(e){_this.events.fire(GameCenter.END_GAME,e)}function establishRTC(e){var found=!1;if(_players.forEach(player=>{player.id==e.from&&(found=!0,player.connection.establish(e))}),!found){let player=createPlayer(e.from,e.data);_players.push(player),_playerMap.set(e.gcID,player),player.connection.establish(e)}}function playerDisconnect(e){_playerMap.delete(e.gcID),_players.forEach(player=>{player.id==e.gcID&&(player.disconnect(),_players.remove(player),_this.events.fire(GameCenterRoom.PLAYER_DISCONNECT,{player:player}))})}function becomeHost(e){_this.host=!0,_this.events.fire(GameCenterRoom.BECOME_HOST)}function openConnection(e){if(_playerMap.has(e.gcID))return;let player=createPlayer(e.gcID,e.data,!0);_playerMap.set(e.gcID,player),_players.push(player),_this.events.fire(GameCenterRoom.PLAYER_JOIN,{player:player})}function playerData(e){_this.events.fire(GameCenter.DATA,e)}function websocketData(e){let player=_playerMap.get(e.from);player&&player.connection.wsData(e)}function communityData({data:data}){for(let i=(data=JSON.parse(data)).length-1;i>-1;i--){let obj=data[i],player=_playerMap.get(obj.from);player&&player.onMessage(obj)}}function handlePin(e){let player;_players.forEach(p=>{p.id==e.message.playerId&&(player=p)}),_this.events.fire(GameCenterRoom.PIN,{message:e.message,player:player})}function handleUnpin(e){let player;_players.forEach(p=>{p.id==e.message.playerId&&(player=p)}),_this.events.fire(GameCenterRoom.UNPIN,{message:e.message,player:player})}this.onDestroy=function(){this.leave&&this.leave()},this.updateUserData=function(data=GameCenter.userData){GameCenter.userData=data,GameCenter.GCID&&_socket.send("update_user_data",{gcID:GameCenter.GCID,data:data})},this.create=function(type,maxInRoom){_this.host=!0,GameCenter.roundTrip("create",{id:_id,coords:GameCenter.coords,type:type,MAX_IN_ROOM:maxInRoom},_this.join)},this.join=function(maxInRoom,force){if(_this.flag("joined"))return Promise.resolve();_this.flag("joined",!0);let promise=Promise.create();return GameCenter.roundTrip("join",{id:_id,user:GameCenter.userData,force:force,MAX_IN_ROOM:maxInRoom},e=>{if(!e.success)return promise.reject();e.host&&(_this.host=!0),GameCenter.GCID=e.myID,function handlePlayers(players){var player;players.forEach((obj,i)=>{obj.id==GameCenter.GCID?player=new GameCenterUser(_socket,_this.isCommunity):(player=_playerMap.get(obj.id))||(player=createPlayer(obj.id,obj.data),_playerMap.set(obj.id,player)),_players[i]=player})}(e.players),function addListeners(){_this.events.sub(_socket,"player_disconnect",playerDisconnect),_this.events.sub(_socket,"become_host",becomeHost),_this.events.sub(_socket,"open_connection",openConnection),_this.events.sub(_socket,"establish_rtc",establishRTC),_this.events.sub(_socket,"ws_data",websocketData),_this.events.sub(_socket,"community",communityData),_this.events.sub(_socket,"start_game",startGame),_this.events.sub(_socket,"end_game",endGame),_this.events.sub(_socket,"force_disconnect",forceDisconnect),_this.events.sub(_socket,"update_user_data",updateUserData),_this.events.sub(_socket,"pin",handlePin),_this.events.sub(_socket,"unpin",handleUnpin),_this.events.sub(GameCenter.LOST_CONNECTION,closeRoom)}(),_aliveTimer=setInterval(_=>_socket.send("alive"),5e3),promise.resolve()}),promise},this.leave=function(){_this.leave=null,clearTimeout(_aliveTimer),_this.flag("joined",!1),_players.forEach(player=>player.disconnect()),GameCenter.roundTrip("leave",{id:_id,user:GameCenter.userData}),_this.destroy()},this.broadcast=function(data){if(_players.length){data.from=GameCenter.GCID,_fallbackSocket||_this.isCommunity||(data=JSON.stringify(data));for(var i=0;i<_players.length;i++)_players[i].connection.emit(data)}},this.start=function(data){_this.host&&_socket.send("start_game",data)},this.end=function(data){_this.host&&_socket.send("end_game",data)},this.pin=function(data,timeInSeconds=5){data.playerId=GameCenter.GCID,_socket.send("pin",{message:data,time:timeInSeconds,userData:GameCenter.userData,playerId:GameCenter.GCID})},this.unpin=function(data){data.playerId=GameCenter.GCID,_socket.send("unpin",{playerId:GameCenter.GCID,message:data})},this.communityRoom=function(){_this.isCommunity=!0},this.get("me",_=>{for(let i=0;i<_players.length;i++){let player=_players[i];if(player.me)return player}})}),()=>{GameCenterRoom.PLAYER_DISCONNECT="gc_room_player_dc",GameCenterRoom.BECOME_HOST="gc_become_host",GameCenterRoom.PLAYER_JOIN="gc_player_join",GameCenterRoom.PLAYER_READY="gc_player_ready",GameCenterRoom.ERROR="gc_room_error",GameCenterRoom.PIN="gc_room_pin",GameCenterRoom.UNPIN="gc_room_unpin"}),Interaction.Class((function Renderer(_object){var _hydraObject=_object instanceof HydraObject;this.needsUpdate=!!_hydraObject,_hydraObject&&(_object.x=_object.x||0,_object.y=_object.y||0,_object.z=_object.z||0,_object.pos={x:0,y:0,z:0}),this.update=function(){_object.transform()}})),Interaction.Class((function Slider(_object,_direction,_config){Inherit(this,Component);var _input,_values,_renderer,_side,_delta,_addInput,_axis,_views,_dragging,_lockMove,_cacheStart,_this=this,_holdOffset=0;function getFullElapsed(){if(!_this.preventVisible&&(_this.elapsed=Math.abs(_object.x)/Math.abs(-_this[_side]*(_this.maxSlides-1)),_views))for(var i=0;i<_views.length;i++){var view=_views[i],pos=_this[_side]*i,offset=(_object[_axis]+pos)/_this[_side];view.sliderOffset=offset,view.updatePosition&&view.updatePosition(offset,_dragging)}}function copyFromTo(o1,o2){void 0!==o1.x&&(o2.x=o1.x),void 0!==o1.y&&(o2.y=o1.y),void 0!==o1.z&&(o2.z=o1.z)}function tweenObj(_to){var css=_this.cssTransitions;if(_this.needsRender=!0,copyFromTo(_object,_values),tween(_values,_to,_this.easeTime,_this.ease).onUpdate(()=>{copyFromTo(_values,css?_object.pos:_object),!css&&_this.autoRender&&_renderer.needsUpdate&&_renderer.update(),getFullElapsed(),_this.onUpdate&&_this.onUpdate(_this.elapsed)}).onComplete(_=>_this.needsRender=!1),css){var cssTo={};cssTo[_axis]=_to[_axis],_object.tween(cssTo,_this.easeTime,_this.ease)}}function incSlide(dist=1){_this.currentSlide+=dist,_this.repeatable&&_this.currentSlide>_this.maxSlides-1&&(_this.currentSlide=0),!_this.infinite&&_this.currentSlide>_this.maxSlides-1&&(_this.currentSlide=_this.maxSlides-1),!_this.infinite&&_this.currentSlide<0&&(_this.currentSlide=0),onUpdateSlide(_this.currentSlide)}function decSlide(dist=1){_this.currentSlide-=dist,_this.repeatable&&_this.currentSlide<0&&(_this.currentSlide=_this.maxSlides-1),!_this.infinite&&_this.currentSlide>_this.maxSlides-1&&(_this.currentSlide=_this.maxSlides-1),!_this.infinite&&_this.currentSlide<0&&(_this.currentSlide=0),onUpdateSlide(_this.currentSlide)}function onUpdateSlide(slide){_this.events.fire(Events.UPDATE,{slide:slide})}function inputUpdate(e,delta=_input.move,override){!Device.mobile&&!_this.desktopDrag||!_dragging&&!override||_this.preventMovement||_this.preventVisible||(_object[_axis]=-_this[_side]*_this.currentSlide+delta[_axis]*_this.multiplier+_holdOffset,!_this.infinite&&function outOfBounds(){return _object[_axis]>0||_this.currentSlide==_this.maxSlides-1&&_object[_axis]<-_this[_side]*_this.currentSlide}()&&function clampWithFriction(){var val=_object[_axis],max=-_this[_side]*_this.currentSlide;val>0?_object[_axis]=val*_this.friction:val<max&&(_object[_axis]=max+(val-max)*_this.friction)}(),getFullElapsed(),_this.cssTransitions&&_object.stopTween(),e.elapsed=_this.elapsed,_this.events.fire(Interaction.MOVE,e,!0),_this.autoRender&&_renderer.needsUpdate&&(_object.pos[_axis]=_object[_axis],_renderer.update()),_delta=delta)}function lockStart(e){_cacheStart=e}function lockMove(e){Math.abs(_input.move[_axis])>_lockMove&&!_this.flag("overrideLock")&&!_this.flag("preventMove")&&(inputStart(_cacheStart),_this.flag("overrideLock",!0),_this.events.fire(Interaction.Slider.OVERRIDE_LOCK,{action:"start"})),Math.abs(_input.move["x"==_axis?"y":"x"])>_lockMove&&_this.flag("preventMove",!0)}function lockEnd(e){_cacheStart=null,_this.flag("overrideLock")&&_this.events.fire(Interaction.Slider.OVERRIDE_LOCK,{action:"end"}),_this.flag("overrideLock",!1),_this.flag("preventMove",!1)}function inputStart(e){!Device.mobile&&!_this.desktopDrag||"hit"==e.target.className&&1!=_config.allowHit||_this.preventMovement||_this.preventVisible||(_dragging=!0,clearTween(_values),_holdOffset=_values[_axis]+_this[_side]*_this.currentSlide||0,Date.now(),_delta=0,_this.needsRender=!0,_this.events.fire(Interaction.Slider.START_INTERACTION,null,!0))}function inputEnd(e,override){!Device.mobile&&!_this.desktopDrag||!_dragging&&!override||_this.preventMovement||_this.preventVisible||(_this.closestOnRelease?function closestOnRelease(e,override){var velocity=_input.velocity[_axis]*Math.sign(_input.delta[_axis]),dist=(_this[_side],_this.maxSlides,120*velocity),step=Math.round(dist/_this[_side]);_this.currentSlide=Math.round(-_object[_axis]/_this[_side]),step>1&&decSlide(Math.abs(step));step<-1&&incSlide(Math.abs(step));var target={};target[_axis]=-_this[_side]*_this.currentSlide,_dragging=!1,tweenObj(target),_this.events.fire(Interaction.Slider.END_INTERACTION,null,!0)}():function snapOnRelease(e,override){var elapsed=function getElapsed(){if(_delta)return-_delta[_axis]/_this[_side]}(),velocity=_input.velocity[_axis]*Math.sign(_input.delta[_axis]);Date.now();if(Math.abs(velocity)>.1||override){(override||velocity)>0?decSlide():incSlide()}else velocity<0?elapsed>_this.snapPoint&&incSlide():velocity>0&&Math.abs(elapsed)>_this.snapPoint&&decSlide();var target={};target[_axis]=-_this[_side]*_this.currentSlide,_dragging=!1,tweenObj(target),_this.events.fire(Interaction.Slider.END_INTERACTION,null,!0)}(0,override))}this.autoRender=!0,this.currentSlide=0,this.closestOnRelease=!!_config.closestOnRelease,this.maxSlides=_config.slides,this.width=_config.width,this.height=_config.height,this.snapPoint=.3,this.ease="easeOutCubic",this.easeTime=500,this.friction=.3,this.infinite=!1,this.desktopDrag="boolean"!=typeof _config.desktopDrag||_config.desktopDrag,this.preventMovement=!1,this.cssTransitions=!1,this.multiplier=1,this.elapsed=0,function initHelpers(){_input=_this.initClass(Interaction,_config.hit||_object),_this.events.sub(_input,Interaction.MOVE,inputUpdate),_this.events.sub(_input,Interaction.START,inputStart),_this.events.sub(_input,Interaction.END,inputEnd),_this.input=_input,_values={},_renderer=_this.initClass(Interaction.Renderer,_object)}(),function initDirection(){_side=_direction.x?"width":"height",_axis=_direction.x?"x":"y"}(),_this.startRender(_=>{}),this.set("views",(function(v){_views=v,_this.delayedCall(getFullElapsed,50)})),this.set("lockMove",(function(v){_lockMove=v})),this.lockDirection=function(move=50){_lockMove=move,_this.events.unsub(_input,Interaction.START,inputStart),_this.events.sub(_input,Interaction.START,lockStart),_this.events.sub(_input,Interaction.MOVE,lockMove),_this.events.sub(_input,Interaction.END,lockEnd)},this.moveTo=function(slide){_this.infinite||(slide<0&&(slide=0),slide>=_this.maxSlides&&(slide=_this.maxSlides-1)),_this.currentSlide=slide;var target={};target[_axis]=-_this[_side]*_this.currentSlide,tweenObj(target),onUpdateSlide(_this.currentSlide)},this.jumpTo=function(slide){_this.infinite||(slide<0&&(slide=0),slide>=_this.maxSlides&&(slide=_this.maxSlides-1)),_this.currentSlide=slide,_values[_axis]=-_this[_side]*_this.currentSlide,copyFromTo(_values,_object),_this.autoRender&&_renderer.needsUpdate&&(_object.pos[_axis]=_object[_axis],_renderer.update()),getFullElapsed(),onUpdateSlide(_this.currentSlide)},this.next=function(){incSlide();var target={};target[_axis]=-_this[_side]*_this.currentSlide,tweenObj(target)},this.prev=function(){decSlide();var target={};target[_axis]=-_this[_side]*_this.currentSlide,tweenObj(target)},this.clearTween=function(){clearTween(_values)},this.onInvisible=function(){_this.preventVisible=!0},this.onVisible=function(){_this.preventVisible=!1},this.addInput=function(x=0,y=0){if(!_this.flag("preventInput")&&(_addInput||((_addInput={}).delta={}),_addInput.delta.x=x,_addInput.delta.y=y,_addInput.total||(_addInput.total=0),inputUpdate(_addInput,_addInput.delta,!0),Math.abs(_object[_axis])>.2*Math.abs(_this[_side]))){let val=Math.abs(y)>Math.abs(x)?y:x;_this.moveTo(_this.currentSlide+Math.sign(val)),_this.flag("preventInput",!0,_this.easeTime)}}}),_=>{Interaction.Slider.OVERRIDE_LOCK="slider_override_lock",Interaction.Slider.UPDATE="slider_update",Interaction.Slider.START_INTERACTION="slider_start_interaction",Interaction.Slider.END_INTERACTION="slider_end_interaction"}),Class((function GLScreenProjection(_camera=World.CAMERA,_target=new Vector2){Inherit(this,Object3D);var _this=this,_projection=new ScreenProjection(_camera),_m0=new Matrix4,_m1=new Matrix4;function loop(){_this.pos.set(_target.x,_target.y),_this.pos3D.copy(_projection.unproject(_this.pos)),_this.group.updateMatrixWorld(),_m0.copy(_camera.projectionMatrix),_m1.getInverse(_camera.matrixWorld),_this.matrix.multiplyMatrices(_m0,_m1),_this.uniforms.normalMatrix.value.copy(_camera.matrixWorld),_this.uniforms.modelMatrix.value.copy(_this.group.matrixWorld)}this.resolution=new Vector2,this.pos=new Vector2,this.pos3D=new Vector3,this.matrix=new Matrix4,this.uniforms={projMatrix:{type:"m4",value:this.matrix},pos:{type:"v2",value:this.pos},pos3D:{type:"v3",value:this.pos3D},normalMatrix:{type:"m4",value:new Matrix4},modelMatrix:{type:"m4",value:new Matrix4}},this.set("camera",v=>{_camera=v,_projection.camera=_camera}),this.set("target",v=>{_target=v}),this.update=loop,this.start=function(){_this.startRender(loop)},this.stop=function(){_this.stopRender(loop)}})),Class((function GLText({font:font,italic:italic=!1,bold:bold=!1,text:text,width:width=1/0,align:align="left",size:size=1,direction:direction="ltr",letterSpacing:letterSpacing=0,lineHeight:lineHeight=1.4,wordSpacing:wordSpacing=0,wordBreak:wordBreak=!1,langBreak:langBreak=!1,paragraphSpacing:paragraphSpacing=1,color:color=new Color("#000000"),alpha:alpha=1,shader:shader="DefaultText"}){const _this=this;var _override,_promise=Promise.create();const config=GLText.FONT_CONFIG[font];function overrideParams(){if(GLText.overrideParams){_override={letterSpacing:letterSpacing,size:size,wordSpacing:wordSpacing,lineHeight:lineHeight};let obj=GLText.overrideParams({letterSpacing:letterSpacing,size:size,wordSpacing:wordSpacing,lineHeight:lineHeight});letterSpacing=obj.letterSpacing,size=obj.size,wordSpacing=obj.wordSpacing,lineHeight=obj.lineHeight}}function resetOverride(){_override&&(letterSpacing=_override.letterSpacing,size=_override.size,wordSpacing=_override.wordSpacing,lineHeight=_override.lineHeight)}!function init(){overrideParams(),_this.charLength=text.length,_this.text=new GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,config:config}),_this.string=text,resetOverride(),_this.text.loaded.then(({buffers:buffers,image:image,imageBold:imageBold,imageItalic:imageItalic,height:height,numLines:numLines})=>{_this.texture=GLText.getTexture(image),bold&&(_this.textureBold=GLText.getTexture(imageBold)),italic&&(_this.textureItalic=GLText.getTexture(imageItalic)),_this.shader=new Shader(shader,{tMap:{value:_this.texture,ignoreUIL:!0},tMapBold:{value:_this.textureBold||Utils3D.getEmptyTexture(),ignoreUIL:!0},tMapItalic:{value:_this.textureItalic||Utils3D.getEmptyTexture(),ignoreUIL:!0},uColor:{value:color,ignoreUIL:!0},uAlpha:{value:alpha,ignoreUIL:!0},transparent:!0}),_this.onCreateShader&&_this.onCreateShader(_this.shader),function createGeometry(buffers){_this.geometry=new Geometry,_this.geometry.addAttribute("position",new GeometryAttribute(buffers.position,3)),_this.geometry.addAttribute("uv",new GeometryAttribute(buffers.uv,2)),_this.geometry.addAttribute("animation",new GeometryAttribute(buffers.animation,3)),_this.geometry.addAttribute("weight",new GeometryAttribute(buffers.weight,1)),_this.geometry.setIndex(new GeometryAttribute(buffers.index,1)),_this.geometry.boundingBox=buffers.boundingBox,_this.geometry.letterCount=buffers.letterCount+1,_this.geometry.wordCount=buffers.wordCount+1,_this.geometry.lineCount=buffers.lineCount+1}(buffers),_this.mesh=new Mesh(_this.geometry,_this.shader),_this.height=height,_promise.resolve()})}(),void 0===font&&console.log(font,text),this.destroy=function(){_this.mesh&&_this.mesh.destroy&&_this.mesh.destroy()},this.ready=this.loaded=function(){return _promise},this.centerY=function(){_this.mesh.position.y=.5*_this.height,_this.needsCenterY=!0},this.resize=function(options){return this.setText(text,options)},this.tweenColor=function(c,time=300,ease="easeOutCubic"){c&&color.tween(c,time,ease)},this.setColor=function(c){c&&color.set(c)},this.setText=function(txt,options){if((text!=txt||!function match(options){return!options||options.font==font&&(options.italic==italic&&(options.bold==bold&&(options.width==width&&(options.align==align&&(options.direction==direction&&(!(options.wordSpacing>0&&options.wordSpacing!=wordSpacing)&&(options.letterSpacing==letterSpacing&&(options.paragraphSpacing==paragraphSpacing&&(options.size==size&&(options.lineHeight==lineHeight&&!(!0===options.wordBreak&&!options.wordBreak||0==options.wordBreak&&options.wordBreak)))))))))))}(options))&&(text=txt))return function setVars(options){font=options.font||font,bold=options.bold||bold,italic=options.italic||italic,width=options.width||width,align=options.align||align,wordSpacing=options.wordSpacing||wordSpacing,letterSpacing=options.letterSpacing||letterSpacing,paragraphSpacing=options.paragraphSpacing||paragraphSpacing,size=options.size||size,lineHeight=options.lineHeight||lineHeight,wordBreak=options.wordBreak||wordBreak,langBreak=options.langBreak||langBreak,direction=options.direction||direction}(options||{}),overrideParams(),_this.string=text,_this.charLength=text.length,_this.text=new GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,config:config}),resetOverride(),_promise=Promise.create(),_this.text.loaded.then(({buffers:buffers,image:image,imageBold:imageBold,imageItalic:imageItalic,height:height,numLines:numLines})=>{!function updateGeometry(buffers){_this.geometry.attributes.position.setArray(buffers.position),_this.geometry.attributes.uv.setArray(buffers.uv),_this.geometry.attributes.animation.setArray(buffers.animation),_this.geometry.attributes.weight.setArray(buffers.weight),_this.geometry.index=buffers.index,_this.geometry.indexNeedsUpdate=!0,_this.geometry.boundingBox=buffers.boundingBox,_this.geometry.letterCount=buffers.letterCount+1,_this.geometry.wordCount=buffers.wordCount+1,_this.geometry.lineCount=buffers.lineCount+1}(buffers),_this.height=height,_this.needsCenterY&&_this.centerY(),_promise.resolve()}),_promise},this.getData=function(){return{font:font,italic:italic,bold:bold,text:text,width:width,align:align,direction:direction,wordSpacing:wordSpacing,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,size:size,lineHeight:lineHeight,wordBreak:wordBreak,langBreak:langBreak,color:color}}}),_=>{GLText.FONT_CONFIG={};var _map=new Map;GLText.getTexture=function(image){if(!_map.get(image)){let texture=new Texture(image);texture.generateMipmaps=!1,texture.minFilter=Texture.LINEAR,_map.set(image,texture)}return _map.get(image)}}),Class((function GLTextGeometry({font:font,italic:italic,bold:bold,text:text,width:width=1/0,align:align="left",size:size=1,direction:direction="ltr",letterSpacing:letterSpacing=0,paragraphSpacing:paragraphSpacing=1,lineHeight:lineHeight=1.4,wordSpacing:wordSpacing=0,wordBreak:wordBreak=!1,langBreak:langBreak=!1,config:config={}}){let json,image,glyphs,bJson,bImage,bGlyphs,iJson,iImage,iGlyphs,_this=this;_this.loaded=Promise.create(),async function init(){await async function loadFont(){[json,image,glyphs]=await GLTextGeometry.loadFont(font),bold&&([bJson,bImage,bGlyphs]=await GLTextGeometry.loadFont(bold));italic&&([iJson,iImage,iGlyphs]=await GLTextGeometry.loadFont(italic))}(),async function createGeometry(){let buffers=await GLTextThread.generate({font:font,bold:bold,italic:italic,text:text,width:width,align:align,size:size,direction:direction,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,lineHeight:lineHeight,wordSpacing:wordSpacing,wordBreak:wordBreak,langBreak:langBreak,json:json,glyphs:glyphs,bJson:bJson,bGlyphs:bGlyphs,iJson:iJson,iGlyphs:iGlyphs,config:config});_this.buffers=buffers,_this.image=image,_this.imageBold=bImage,_this.imageItalic=iImage,_this.numLines=buffers.lineLength,_this.height=_this.numLines*size*lineHeight,_this.onLayout&&_this.onLayout(buffers,image,_this.height,_this.numLines),_this.loaded.resolve({buffers:buffers,image:image,imageBold:bImage,imageItalic:iImage,height:_this.height,numLines:_this.numLines})}()}()}),_=>{async function loadJSON(font){return await get(getPathTo(font,"json"))}async function loadImage(font){return await new Promise(resolve=>{let img=new Image;img.onload=()=>resolve(img),img.crossOrigin="anonymous",img.src=getPathTo(font,"png")})}function getPathTo(font,ext){let mapped=!1,fontName=function(){for(let key in GLTextGeometry.fontMapping){let mapping=GLTextGeometry.fontMapping[key];if(key==font)return mapped=!0,mapping}return font}(),path=mapped&&GLTextGeometry.fontPath?GLTextGeometry.fontPath:"assets/fonts/";return Assets.getPath(path+fontName+"."+ext+`?${window._CACHE_||Date.now()}`)}let _promises={};GLTextGeometry.fontMapping={},GLTextGeometry.chars={},GLTextGeometry.loadFont=function(font){if(!_promises[font]){let promise=Promise.create();_promises[font]=promise,async function(){let[json,image]=await Promise.all([loadJSON(font),loadImage(font)]);glyphs={},json.chars.forEach(d=>glyphs[d.char]=d),promise.resolve([json,image,glyphs]),GLTextGeometry.chars[font]=json.chars}()}return _promises[font]}}),Class((function GLTextThread(){var _thread;function loadTextGeometry({font:font,bold:bold,italic:italic,text:text,width:width,align:align,size:size,direction:direction,letterSpacing:letterSpacing,paragraphSpacing:paragraphSpacing,lineHeight:lineHeight,wordSpacing:wordSpacing,wordBreak:wordBreak,langBreak:langBreak,json:json,glyphs:glyphs,bJson:bJson,bGlyphs:bGlyphs,iJson:iJson,iGlyphs:iGlyphs,config:config},pid){const newline=/\n/,whitespace=/\s/,langbreak=!!langBreak&&new RegExp(langBreak),dir="rtl"===direction?-1:1;config||(config={}),config.boldBaseOffset=config.boldBaseOffset?config.boldBaseOffset:0,config.italicBaseOffset=config.italicBaseOffset?config.italicBaseOffset:0;let weights=[],weight={0:glyphs,1:bGlyphs,2:iGlyphs};var buffers;function getKernPairOffset(id1,id2){for(let i=0;i<json.kernings.length;i++){let k=json.kernings[i];if(!(k.first<id1)&&!(k.second<id2))return k.first>id1?0:k.first===id1&&k.second>id2?0:k.amount}return 0}!function setWeights(){let i=0,w=0;for(;i<text.length;){let code=text.substring(i,i+3),endcode=text.substring(i,i+4);"<b>"!==code&&"<i>"!==code||(w="<b>"===code?1:2,text=text.substr(0,i)+text.substr(i+3)),"</b>"!==endcode&&"</i>"!==endcode||(w=0,text=text.substr(0,i)+text.substr(i+4)),weights.push(w),i++}}(),function createGeometry(){fontHeight=json.common.lineHeight,baseline=json.common.base,scale=size/baseline;let numChars=text.replace(/[ \n]/g,"").length;buffers={position:new Float32Array(4*numChars*3),uv:new Float32Array(4*numChars*2),animation:new Float32Array(3*numChars*4),index:new Uint16Array(6*numChars),weight:new Float32Array(4*numChars)};for(let i=0;i<numChars;i++)buffers.index.set([4*i,4*i+2,4*i+1,4*i+1,4*i+2,4*i+3],6*i);!function layout(){const lines=[];let cursor=0,wordCursor=0,wordWidth=0,line=newLine();function newLine(br=!1){const line={width:0,glyphs:[]};return lines.last()&&(lines.last().br=br),lines.push(line),wordCursor=cursor,wordWidth=0,line}for(;cursor<text.length;){let prev=text[cursor-1],char=text[cursor];text[cursor+1];if(!line.width&&whitespace.test(char)&&!(prev&&newline.test(char)&&newline.test(prev))){cursor++,wordCursor=cursor,wordWidth=0;continue}if(newline.test(char)){cursor++,line=newLine(!0);continue}let style=weight[weights[cursor]]||weight[0],glyph=style[char];if(glyph||(glyph=style.a),isNaN(parseInt(glyph.char))||(glyph.xadvance=style[0].xadvance,glyph.xoffset=Math.floor(.5*(glyph.xadvance-glyph.width))),glyph.weight=weights[cursor],line.glyphs.length){const prevGlyph=line.glyphs[line.glyphs.length-1][0];let kern=getKernPairOffset(glyph.id,prevGlyph.id)*scale;line.width+=kern,wordWidth+=kern*dir}let gl=Object.assign({},glyph);gl.weight=weights[cursor],line.glyphs.push([gl,line.width]);let advance=0;if(whitespace.test(char)?(wordCursor=cursor,wordWidth=0,advance+=wordSpacing*size):advance+=letterSpacing*size,advance+=glyph.xadvance*scale,line.width+=advance,wordWidth+=advance,line.width>width){if((wordBreak||char&&langBreak&&!langbreak.test(char))&&line.glyphs.length>1){line.width-=advance,line.glyphs.pop(),line=newLine();continue}if(!wordBreak&&wordWidth!==line.width){let numGlyphs=cursor-wordCursor+1;line.glyphs.splice(-numGlyphs,numGlyphs),cursor=wordCursor,line.width-=wordWidth,line=newLine();continue}}cursor++}line.width||lines.pop();!function populateBuffers(lines){const texW=json.common.scaleW,texH=json.common.scaleH;let geom,y=(config.baseOffset?config.baseOffset:.07)*size,j=0,glyphIndex=0,wordIndex=-1,lineId=-1;for(let lineIndex=0;lineIndex<lines.length;lineIndex++){let line=lines[lineIndex];wordIndex++,lineId++;for(let i=0;i<line.glyphs.length;i++){const glyph=line.glyphs[i][0];let x=line.glyphs[i][1];if(-1===dir&&(x=line.width-x),"center"===align?x-=.5*line.width:"right"===align&&(x-=line.width*dir),whitespace.test(glyph.char)){wordIndex++;continue}1===glyph.weight&&(y+=config.boldBaseOffset*scale),2===glyph.weight&&(y+=config.italicBaseOffset*scale),x+=glyph.xoffset*scale*dir,y-=glyph.yoffset*scale,buffers.weight.set([glyph.weight,glyph.weight,glyph.weight,glyph.weight],4*glyphIndex);let w=glyph.width*scale,h=glyph.height*scale;-1===dir?buffers.position.set([x-w,y-h,0,x-w,y,0,x,y-h,0,x,y,0],4*j*3):buffers.position.set([x,y-h,0,x,y,0,x+w,y-h,0,x+w,y,0],4*j*3),buffers.animation.set([glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId,glyphIndex,wordIndex,lineId],3*glyphIndex*4),glyphIndex++;let u=glyph.x/texW,uw=glyph.width/texW,v=1-glyph.y/texH,vh=glyph.height/texH;buffers.uv.set([u,v-vh,u,v,u+uw,v-vh,u+uw,v],4*j*2),1===glyph.weight&&(y-=config.boldBaseOffset*scale),2===glyph.weight&&(y-=config.italicBaseOffset*scale),y+=glyph.yoffset*scale,j++}y-=size*lineHeight*(line.br?paragraphSpacing:1)}window.zUtils3D&&(geom=new Geometry,geom.addAttribute("position",new GeometryAttribute(buffers.position,3)),geom.computeBoundingBox());let backing=[];for(let key in buffers)backing.push(buffers[key].buffer);buffers.lineLength=lines.length,geom&&(buffers.boundingBox=geom.boundingBox);buffers.letterCount=glyphIndex,buffers.lineCount=lineId,buffers.wordCount=wordIndex,resolve(buffers,pid,backing)}(lines)}()}()}!async function(){await Hydra.ready(),(_thread=new Thread).loadFunction(loadTextGeometry)}(),this.generate=async function(obj){return _thread.loadTextGeometry(obj)}}),"static"),Class((function GLUI(){Inherit(this,Component);const _this=this;function loop(){window.Metal||(window.AURA_AR&&AURA_AR.active&&(World.NUKE.postRender=null,AURA_AR.postRender=loop),_this.Scene&&_this.Scene.render(),_this.Stage&&_this.Stage.render())}window.$gl=function(width,height,map){return new GLUIObject(width,height,map)},window.$glText=function(text,fontName,fontSize,options){return new GLUIText(text,fontName,fontSize,options)},this.init=async function(is2D,is3D){_this.initialized||(void 0===is2D&&(is2D=!0,is3D=!0),await AssetLoader.waitForLib("zUtils3D"),is2D&&(_this.Stage=new GLUIStage),is3D&&(_this.Scene=new GLUIStage3D,_this.Scene.interaction.input=Mouse),_this.wait(World,"NUKE",_=>{_this.initialized=!0,_this.Scene&&(World.NUKE.onBeforeRender=_this.Scene.mark),World.NUKE.postRender=loop}))},this.ready=function(){return _this.wait(_this,"initialized")},this.renderDirect=function(render){_this.Scene&&_this.Scene.renderDirect(render),_this.Stage&&_this.Stage.renderDirect(render)}}),"static"),Class((function GLUIElement(){Inherit(this,Component);this.element=$gl(),this.element.name=this.constructor.name,this.create=function(w,h,t){return this.element.create(w,h,t)}})),Class((function GLUIBatch(globalUniforms={}){Inherit(this,Component);const _this=this;var _timer,_geometry,_shader,_objects=[];function loop(){if(_geometry)for(let i=0;i<_objects.length;i++){let obj=_objects[i];obj.mesh.onBeforeRender(),obj._buffers.forEach(buffer=>{let dirty=!1;if(dirty=!buffer.value.equals(buffer.lookup),buffer.value.copy(buffer.lookup),dirty){let attribute=_geometry.attributes[buffer.key],array=attribute.array;switch(buffer.key){case"scale":array[2*i+0]=obj.group.scale.x*obj.mesh.scale.x,array[2*i+1]=obj.group.scale.y*obj.mesh.scale.y;break;case"rotation":array[i]=buffer.lookup.z;break;default:array[2*i+0]=obj.group.position.x,array[2*i+1]=obj.group.position.y}attribute.needsUpdate=!0}}),obj._uniforms.forEach(uniform=>{let dirty=!1;if("f"==uniform.type?(dirty=obj.mesh.shader.uniforms[uniform.key].value!=uniform.value,uniform.value=obj.mesh.shader.uniforms[uniform.key].value):(dirty=!obj.mesh.shader.uniforms[uniform.key].value.equals(uniform.value),uniform.value.copy(obj.mesh.shader.uniforms[uniform.key].value)),dirty){let attribute=_geometry.attributes["a_"+uniform.key],array=attribute.array;"f"==uniform.type?array[i]=uniform.value:uniform.value.toArray(array,i*uniform.components),attribute.needsUpdate=!0}})}}function getTypeFromSize(size){switch(size){case 1:return"float";case 2:return"vec2";case 3:return"vec3";case 4:return"vec4"}}function createMesh(){let shader=_objects[0].mesh.shader;_geometry=(new Geometry).instanceFrom(_objects[0].mesh.geometry.clone());let map={},arrays={};_objects.forEach((obj,i)=>{obj.mesh.onBeforeRender();let buffers=[],uniforms=[];for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform.value instanceof Color&&uniforms.push({key:key,type:"c",components:3}),uniform.value instanceof Vector3&&uniforms.push({key:key,type:"v3",components:3}),uniform.value instanceof Vector2&&uniforms.push({key:key,type:"v",components:2}),"number"==typeof uniform.value&&uniforms.push({key:key,type:"f",components:1})}buffers.push({key:"offset",lookup:obj.group.position,components:2}),buffers.push({key:"scale",lookup:obj.group.scale,components:2}),buffers.push({key:"rotation",lookup:obj.group.rotation,components:1}),uniforms.forEach(uniform=>{arrays["a_"+uniform.key]||(arrays["a_"+uniform.key]=[]),map["a_"+uniform.key]||(map["a_"+uniform.key]=uniform);let value=shader.uniforms[uniform.key].value;"object"==typeof value?(uniform.value=value.clone(),uniform.value.toArray(arrays["a_"+uniform.key],i*uniform.components)):(uniform.value=shader.uniforms[uniform.key].value,arrays["a_"+uniform.key].push(uniform.value))}),buffers.forEach(buffer=>{switch(arrays[buffer.key]||(arrays[buffer.key]=[]),map[buffer.key]||(map[buffer.key]=buffer),buffer.value=buffer.lookup.clone(),buffer.key){case"scale":arrays[buffer.key].push(obj.group.scale.x*obj.mesh.scale.x,obj.group.scale.y*obj.mesh.scale.y);break;case"rotation":arrays[buffer.key].push(buffer.lookup.z);break;default:arrays[buffer.key].push(buffer.lookup.x,buffer.lookup.y)}}),obj._buffers=buffers,obj._uniforms=uniforms,obj.shader.neverRender=!0});let attributes=[],defines=[];for(let key in map)key.includes("a_")&&(attributes.push(`% ${getTypeFromSize(map[key].components)} ${key};`),defines.push(`${key.replace("a_","v_")} = ${key};`));attributes=attributes.join("\n"),defines=defines.join("\n");for(let key in arrays)_geometry.addAttribute(key,new GeometryAttribute(new Float32Array(arrays[key]),map[key].components,1));let vsSplit=(_shader=_this.initClass(Shader,"GLUIBatch",shader.fsName,Object.assign({},{transparent:!0},globalUniforms))).vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=_shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__"),definitions=[];fsSplit[1].split("\n").forEach(line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" ");definitions.push(`${data[2].replace(";","")} = a_${data[2]}`),vsSplit[1]=`\nattribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`+vsSplit[1],vsSplit[1]=vsSplit[1].replace(line,""),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`)}}),vsSplit[1]=vsSplit[1].replace("//vdefines","\n"+definitions.join("\n")),_shader.vertexShader=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),_shader.fragmentShader=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),shader.copyUniformsTo(_shader),_this.mesh=new Mesh(_geometry,_shader),_this.mesh.frustumCulled=!1,_this.group.add(_this.mesh)}this.group=new Group,_this.startRender(loop),this.add=function(obj){clearTimeout(_timer),_timer=_this.delayedCall(createMesh,50),_this.parent.add(obj),_objects.push(obj)},this.onDestroy=function(){_this.mesh.destroy()}})),Class((function GLUIBatchText(globalUniforms={}){Inherit(this,Component);const _this=this;var _geometry,_shader,_timer,_forceUpdate,_promises=[],_toSplice=[],_objects=[],_offset=0;function loop(){if(!_geometry)return;let updated=!1;for(let key in _geometry.attributes){let attrib=_geometry.attributes[key];attrib.updateRange.length&&(attrib.updateRange.length=0)}let len=_objects.length;for(let i=0;i<len;i++){let obj=_objects[i];obj.mesh.onBeforeRender();let offset=obj._offset,count=obj._count,end=offset+count;obj._buffers.forEach(buffer=>{let dirty=!1;if(dirty=!buffer.value.equals(buffer.lookup),buffer.value.copy(buffer.lookup),dirty){let array=_geometry.attributes[buffer.key].array;for(let j=offset;j<end;j++)switch(buffer.components){case 2:array[2*j+0]=buffer.lookup.x,array[2*j+1]=buffer.lookup.y;break;case 1:array[j]=buffer.lookup.z}updated=!0,buffer.updateRange.offset=offset*buffer.components,buffer.updateRange.count=count*buffer.components,_geometry.attributes[buffer.key].updateRange.push(buffer.updateRange),_geometry.attributes[buffer.key].needsUpdate=!0}}),obj._uniforms.forEach(uniform=>{let dirty=!1;if("f"==uniform.type?(dirty=obj.mesh.shader.uniforms[uniform.key].value!=uniform.value,uniform.value=obj.mesh.shader.uniforms[uniform.key].value):(dirty=!obj.mesh.shader.uniforms[uniform.key].value.equals(uniform.value),uniform.value.copy(obj.mesh.shader.uniforms[uniform.key].value)),dirty||_forceUpdate){let array=_geometry.attributes["a_"+uniform.key].array;for(let j=offset;j<end;j++)"f"==uniform.type?array[j]=obj.mesh.shader.uniforms[uniform.key].value:obj.mesh.shader.uniforms[uniform.key].value.toArray(array,j*uniform.components);updated=!0,uniform.updateRange.offset=offset*uniform.components,uniform.updateRange.count=count*uniform.components,_geometry.attributes["a_"+uniform.key].updateRange.push(uniform.updateRange),_geometry.attributes["a_"+uniform.key].needsUpdate=!0}})}if(updated)for(let key in _geometry.attributes){let bottom,attrib=_geometry.attributes[key];if(!attrib.updateRange.length)continue;let toSplice=_toSplice;toSplice.length=0;for(let i=0;i<attrib.updateRange.length;i++){let current=attrib.updateRange[i],prev=attrib.updateRange[i-1];prev?prev.offset+prev.count==current.offset?(bottom.count+=current.count,toSplice.push(i)):bottom=current:bottom=current}for(let i=toSplice.length-1;i>-1;i--)attrib.updateRange.splice(toSplice[i],1)}_forceUpdate=!1}async function createMesh(){if(_this.flag("mesh"))return;_this.flag("mesh",!0),await Promise.all(_promises),await _this.wait(100);let mesh=new Mesh(_geometry,_shader);_this.mesh=mesh,mesh.frustumCulled=!1,_this.group.add(mesh)}this.group=new Group,_this.flag("canLoad",!0),_this.startRender(loop),_this.add=async function(obj){await _this.flag("canLoad"),_this.flag("canLoad",!1),await obj.loaded(),obj.mesh.shader.neverRender=!0,_promises.push(obj.loaded()),function addAttributes(obj,mesh){let{geometry:geometry,shader:shader}=mesh,count=geometry.attributes.uv.count;mesh.onBeforeRender();let buffers=[],uniforms=[];for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform.value instanceof Color&&uniforms.push({key:key,type:"c",components:3}),uniform.value instanceof Vector3&&uniforms.push({key:key,type:"v3",components:3}),uniform.value instanceof Vector2&&uniforms.push({key:key,type:"v",components:2}),"number"==typeof uniform.value&&uniforms.push({key:key,type:"f",components:1})}buffers.push({key:"offset",lookup:obj.group.position,components:2}),buffers.push({key:"scale",lookup:obj.group.scale,components:2}),buffers.push({key:"rotation",lookup:obj.group.rotation,components:1}),uniforms.forEach(uniform=>{uniform.updateRange={},uniform.value=shader.uniforms[uniform.key].value,"object"==typeof uniform.value&&(uniform.value=uniform.value.clone()),uniform.buffer=new Float32Array(count*uniform.components)}),buffers.forEach(buffer=>{buffer.updateRange={},buffer.value=buffer.lookup.clone(),buffer.buffer=new Float32Array(count*buffer.components)});for(let i=0;i<count;i++)buffers.forEach(buffer=>{switch(buffer.components){case 2:buffer.buffer[2*i+0]=buffer.lookup.x,buffer.buffer[2*i+1]=buffer.lookup.y;break;case 1:buffer.buffer[i]=buffer.lookup.z}}),uniforms.forEach(uniform=>{"f"==uniform.type?uniform.buffer[i]=shader.uniforms[uniform.key].value:shader.uniforms[uniform.key].value.toArray(uniform.buffer,i*uniform.components)});buffers.forEach(buffer=>{geometry.addAttribute(buffer.key,new GeometryAttribute(buffer.buffer,buffer.components))}),uniforms.forEach(uniform=>{geometry.addAttribute("a_"+uniform.key,new GeometryAttribute(uniform.buffer,uniform.components))}),obj._offset=_offset,obj._count=count,obj._uniforms=uniforms,obj._buffers=buffers,_objects.push(obj),_offset+=count}(obj,obj.mesh),_this.parent.add(obj),_geometry?_geometry.merge(obj.mesh.geometry):function initGeometry(mesh){let vsSplit=(_shader=_this.initClass(Shader,"GLUIBatchText",mesh.shader.fsName,Object.assign({},{transparent:!0},globalUniforms))).vertexShader.split("__ACTIVE_THEORY_LIGHTS__"),fsSplit=_shader.fragmentShader.split("__ACTIVE_THEORY_LIGHTS__"),definitions=[];fsSplit[1].split("\n").forEach(line=>{if(line.includes("uniform")){if(line.includes("sampler2D"))return;let data=line.split(" ");definitions.push(`${data[2].replace(";","")} = a_${data[2]}`),vsSplit[1]=`\nattribute ${data[1]} a_${data[2]}\nvarying ${data[1]} ${data[2]}`+vsSplit[1],vsSplit[1]=vsSplit[1].replace(line,""),fsSplit[1]=fsSplit[1].replace(line,`varying ${data[1]} ${data[2]}`)}}),vsSplit[1]=vsSplit[1].replace("//vdefines","\n"+definitions.join("\n")),_shader.vertexShader=vsSplit.join("__ACTIVE_THEORY_LIGHTS__"),_shader.fragmentShader=fsSplit.join("__ACTIVE_THEORY_LIGHTS__"),mesh.shader.copyUniformsTo(_shader),_geometry=mesh.geometry.clone();for(let key in _geometry.attributes)_geometry.attributes[key].updateRange=[]}(obj.mesh),_this.flag("canLoad",!0),clearTimeout(_timer),_timer=_this.delayedCall(createMesh,50)},_this.forceUpdate=function(){_forceUpdate=!0},_this.onDestroy=function(){_this.mesh&&_this.mesh.destroy()}})),Class((function GLUIStageInteraction2D(_camera,_scene,_stage){Inherit(this,Component);const _this=this;var _ray,_over,_click,_customTest,_disabled,_blocked,_test=[],_objects=this.objects=[],_hold=new Vector2,_lastTestedPoint=(new Vector2,new Vector2);function cacheTopScene(obj){let p=obj;for(;p;)p instanceof Scene&&(obj.interactionScene=p),p=p._parent}function externalStart(){_this._invisible||start(_lastTestedPoint)}function externalRelease(){_this._invisible||end(_lastTestedPoint)}function move(e){if(UIL&&UIL.loaded&&"CANVAS"!==e.target.tagName)return;if(GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked)return;_ray||((_ray=new Raycaster(_camera)).testVisibility=!1);let objects=function testObjects(){let objects=GLUI.Stage.interaction.objects;_test.length=0;for(let i=objects.length-1;i>-1;i--){let obj=objects[i];obj.interactionScene||cacheTopScene(obj),obj.determineVisible()&&_scene==obj.interactionScene&&_test.push(obj)}return _test}();if(!objects.length)return;let hit=_ray.checkHit(objects,e,_stage);try{if(hit[0]){GLUI.HIT=!0;let obj=hit[0].object.glui;_over||((_over=obj)._onOver({action:"over",object:obj}),Stage.css("cursor","pointer")),_over!=obj&&(_over._onOver({action:"out",object:_over}),(_over=obj)._onOver({action:"over",object:obj}),Stage.css("cursor","pointer"))}else GLUI.HIT=!1,_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.css("cursor","auto"))}catch(e){console.warn(e)}}function start(e){UIL&&UIL.loaded&&"CANVAS"!==e.target.tagName||GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked||((Device.mobile||RenderManager.type==RenderManager.WEBVR)&&move(e),_over&&!_click&&(_click=_over,_hold.copy(e),_hold.time=Date.now()))}function end(e){if(!(UIL&&UIL.loaded&&"CANVAS"!==e.target.tagName||GLUI.PREVENT_INTERACTION||_this._invisible||_disabled||_blocked)){if(_customTest&&Device.mobile&&_click&&null==_over&&(_over=_click),GLUI.HIT=!1,_click){if(Date.now()-_hold.time>750)return _click=null;if(_click==_over)try{_blocked=!0,_this.delayedCall(_=>{_blocked=!1},_this.preventDoubleClickTime),_click._onClick({action:"click",object:_click}),Device.mobile&&_over&&(_over._onOver({action:"out",object:_over}),_over=null,Stage.css("cursor","auto"))}catch(e){console.warn(e)}}_click=null}}this.preventDoubleClickTime=100,function addListeners(){_this.events.sub(Mouse.input,Interaction.MOVE,move),_this.events.sub(Mouse.input,Interaction.START,start),_this.events.sub(Mouse.input,Interaction.END,end),_this.events.sub(Interaction3D.EXTERNAL_PRESS,externalStart),_this.events.sub(Interaction3D.EXTERNAL_RELEASE,externalRelease)}(),_this.startRender(_=>{}),this.add=function(obj){obj&&_objects.push(obj.mesh||obj)},this.remove=function(obj){obj&&_objects.remove(obj.mesh||obj)},this.testWith=function(point,id){point.customTest=!0,_lastTestedPoint.copy(point),_lastTestedPoint.customTest=!0,move(point),Device.mobile&&RenderManager.type!=RenderManager.WEBVR&&_over&&start(point),_customTest||(_customTest=!0,_this.events.unsub(Mouse.input,Interaction.MOVE,move))},this.set("_disabled",v=>{(_disabled=v)&&(_click=null,_over=null)})})),Class((function GLUIStageInteraction3D(){Inherit(this,Component);function onHover(e){e.mesh.glui._onOver({action:e.action,object:e.mesh.glui})}function onClick(e){e.mesh.glui._onClick({action:e.action,object:e.mesh.glui})}this.add=function(obj,camera=World.CAMERA){Interaction3D.find(camera).add(obj.mesh||obj,onHover,onClick)},this.remove=function(group,camera=World.CAMERA){Interaction3D.find(camera).remove(obj.mesh||obj)}})),Class((function GLUICornerPin($obj){Inherit(this,Component);const _this=this;var _geom,_vertices,_last;function loop(){_vertices[0]=_this.tl.x,_vertices[1]=-_this.tl.y,_vertices[3]=_vertices[9]=_this.bl.x,_vertices[4]=_vertices[10]=-_this.bl.y,_vertices[6]=_vertices[15]=_this.tr.x,_vertices[7]=_vertices[16]=-_this.tr.y,_vertices[12]=_this.br.x,_vertices[13]=-_this.br.y,function dirty(){let a=_vertices,b=_last;for(let i=a.length-1;i>-1;i--)if(a[i]!=b[i])return!0;return!1}()&&(_geom.attributes.position.needsUpdate=!0),_last.set(_vertices)}this.tl=new Vector2(0,0),this.tr=new Vector2($obj.width,0),this.bl=new Vector2(0,$obj.height),this.br=new Vector2($obj.width,$obj.height),function initGeometry(){_geom=$obj.mesh.geometry.toNonIndexed(),$obj.useGeometry(_geom),$obj.mesh.scale.set(1,1,1),_vertices=_geom.attributes.position.array,_last=new Float32Array(_vertices)}(),_this.startRender(loop),this.update=function(){this.tl.set(0,0),this.tr.set($obj.width,0),this.bl.set(0,$obj.height),this.br.set($obj.width,$obj.height)},this.tween=function(type,val,time,ease,delay){return val=val instanceof Vector2?val:new Vector2(val.x,val.y),tween(_this[type],val,time,ease,delay)}}));class GLUIObject{constructor(width,height,map){let shader=this.textureShader=new Shader("GLUIObject",{tMap:{value:null},uAlpha:{type:"f",value:1},uHover:{type:"f",value:0},transparent:!0,depthTest:!1});shader.persists=!0,map||(shader.visible=!1),this.usingMap=null!=map&&"empty"!=map&&""!=map,this.tMap=shader.uniforms.tMap,this.group=new Group,this.alpha=1,this.hover=0,this._x=0,this._y=0,this._z=0,this._scaleX=1,this._scaleY=1,this._scale=1,this._rotation=0,this.multiTween=!0,this.children=[],this.dimensions=new Vector3(width,height,1),this._shader=shader,this.mesh=new Mesh(GLUIObject.getGeometry("2d"),shader),this.mesh.glui=this,this.group.add(this.mesh),window.GLSEO&&GLSEO.objectNode(this),this.bg((_=>"string"==typeof map?map.includes(["#","0x"])?map:"empty"===map||""===map?null:Utils3D.getTexture(map,{premultiplyAlpha:!1}):map)());const _this=this;this.mesh.onBeforeRender=_=>{if(!_this.mesh.determineVisible()&&!_this.firstRender)return;let alpha=_this.getAlpha();_this.mesh.shader.uniforms.uAlpha&&(_this.mesh.shader.uniforms.uAlpha.value=alpha);let hover=_this.getHover();if(_this.mesh.shader.uniforms.uHover&&(_this.mesh.shader.uniforms.uHover.value=hover),_this.usingMap){if(0==alpha)return void(_this.mesh.shader.visible=!1);_this.mesh.shader.visible=!0}if(!_this.isDirty&&_this.firstRender)return;RenderStats.active&&RenderStats.update("GLUIObject",1,_this.mesh.shader.vsName+"|"+_this.mesh.shader.fsName,_this.mesh),_this.group.position.x=_this._x,_this.group.position.y=_this._3d?_this._y:-_this._y,_this.group.position.z=_this._z,1!=_this.scale&&(_this.group.position.x+=(_this.dimensions.x-_this.dimensions.x*_this.scale)/2,_this.group.position.y-=(_this.dimensions.y-_this.dimensions.y*_this.scale)/2);_this.mesh.shader;if(_this.calcMask){let v=_this.isMasked;v.copy(v.origin),_this.group.localToWorld(v),v.z=v.width,v.w=v.height}map?_this.corners||(_this.mesh.scale.set(1,1,1).multiply(_this.dimensions),_this.group.scale.x=_this._scaleX*_this._scale,_this.group.scale.y=_this._scaleY*_this._scale):_this.group.scale.set(_this._scaleX*_this._scale,_this._scaleY*_this._scale,1),_this._3d||(_this.group.rotation.z=Math.radians(_this._rotation)),_this.anchor&&_this.anchor._parent?(_this.anchor.position.copy(_this.group.position),_this.anchor.scale.copy(_this.group.scale),_this.anchor.quaternion.setFromEuler(_this._rotation),_this.anchor.isDirty=!0):(_this.group.quaternion.setFromEuler(_this._rotation),_this.group.matrixDirty=!0),_this.firstRender||(_this.group.updateMatrixWorld(!0),_this.firstRender=!0),_this.isDirty=!1},_this.isDirty=!0}get width(){return this.dimensions.x}set width(w){this.dimensions.x=w,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get height(){return this.dimensions.y}set height(h){this.dimensions.y=h,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get x(){return this._x}set x(v){this._x=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get y(){return this._y}set y(v){this._y=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get z(){return this._z}set z(v){this._z=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get scale(){return this._scale}set scale(v){this._scale=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get scaleX(){return this._scaleX}set scaleX(v){this._scaleX=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get scaleY(){return this._scaleY}set scaleY(v){this._scaleY=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}get rotation(){return this._rotation}set rotation(v){this._rotation=v,this.isDirty=!0,this.__internalDirty&&this.__internalDirty()}style(props){for(let prop in props)void 0!==this[prop]&&(this[prop]=props[prop]);return this}size(w,h){return this.width=w,this.height=h,this.corners&&this.corners.update(),this}add($obj){return $obj.parent=this,this.group.add($obj.group),this.children.push($obj),this.isMasked&&$obj.mask(this.isMasked,this.maskShader),this._3d&&!$obj._3d&&$obj.enable3D(),this.deferred&&($obj.deferRender(!0),$obj.anchor&&this.anchor&&this.anchor.add($obj.anchor)),this}interact(over,click,camera=World.CAMERA,url,label){"string"==typeof camera&&(label=url,url=camera,camera=World.CAMERA),this._onOver=over,this._onClick=click,this._interactCamera=camera;let stage=this._3d?GLUI.Scene:GLUI.Stage;if(over?stage.interaction.add(this,camera):stage.interaction.remove(this,camera),"string"==typeof url&&"string"==typeof label){const _this=this;defer(_=>{!_this.seo&&window.GLSEO&&GLSEO.objectNode(_this),_this.seo&&_this.seo.aLink(url,label)})}return this}clearInteract(){if(this._onOver){(this._3d?GLUI.Scene:GLUI.Stage).interaction.remove(this,this._interactCamera),this._onClick=GLUIObject.noop,this._onOver=GLUIObject.noop}return this}remove(){this.children.forEach(child=>child.remove()),this.clearInteract(),this.parent&&(this.parent.children?this.parent.children.remove(this):GLUI.Stage.remove(this)),this.mesh.parent?this.group.parent.remove(this.group):this._3d?GLUI.Scene.remove(this):GLUI.Stage.remove(this);let textureShader=this.textureShader;for(let key in textureShader.uniforms){let uniform=textureShader.uniforms[key];uniform&&uniform.value&&uniform.value.destroy&&uniform.value.destroy()}Utils.nullObject(this)}create(width,height,map){let $obj=$gl(width,height,map);return this.add($obj),this._3d&&$obj.enable3D(),$obj}removeChild(obj){return this.group.remove(obj.group),this}tween(obj,time,ease,delay){return tween(this,obj,time,ease,delay)}enable3D(style2d){this._3d=!0,this.mesh.geometry=GLUIObject.getGeometry(style2d?"2d":"3d"),this.mesh.shader.depthTest=!0,this._rotation=new Euler;const _this=this;return _this._rotation.onChange(_=>{_this.isDirty=!0}),this}loaded(){return!0}setZ(z){return this.mesh.renderOrder=z,this}bg(path){if(void 0!==path)return"string"==typeof path?path.includes(["#","0x"])?(this.colorShader||(this.colorShader=new Shader("GLUIColor",{transparent:!0,uAlpha:{type:"f",value:1},uColor:{value:new Color(path)},uHover:{type:"f",value:0}})),this.colorShader.set("uColor",new Color(path)),this._shader!=this.colorShader&&this.useShader(this.colorShader)):(this.textureShader.uniforms.tMap.value=Utils3D.getTexture(path,{premultiplyAlpha:!1}),this._shader!=this.textureShader&&this.useShader(this.textureShader)):this._shader.uniforms.tMap.value=path,this}show(){return this.group.matrixDirty=!0,this.mesh.matrixDirty=!0,this.group.visible=!0,this}hide(){return this.group.visible=!1,this}useShader(shader){return shader&&(shader!=this.textureShader&&shader!=this.colorShader&&(shader.uniforms.tMap=this.mesh.shader.uniforms.tMap,shader.uniforms.uAlpha=this.mesh.shader.uniforms.uAlpha),shader.depthTest=!1,shader.transparent=!0),this._shader=shader,this.mesh.shader=shader||this._shader,this}depthTest(bool){this.mesh.shader.depthTest=bool}useGeometry(geom){return this.mesh.geometry=geom,this}updateMap(src){this._shader.uniforms.tMap.value="string"==typeof src?Utils3D.getTexture(src):src}mask(d,shaderName){var v;if(d instanceof Vector4?(this.isMasked=!0,v=d):((v=new Vector4(d.x,d.y,0,1)).origin=(new Vector4).copy(v),v.width=d.width,v.height=d.height,this.calcMask=!0,this.isMasked=v),this.maskShader=shaderName,this.usingMap){let shader=new Shader(shaderName||"GLUIObjectMask",{tMap:this.tMap,uAlpha:{value:1},uHover:{value:0},mask:{type:"v4",value:v},transparent:!0,depthWrite:!1,depthTest:!1});this.useShader(shader)}return this.group.traverse(obj=>{obj.glui&&obj.glui!=this&&obj.glui.mask(v,shaderName)}),v}deferRender(parent){this.deferred=!0,parent||(this.anchor=new Group,GLUI.Scene.addDeferred(this))}clearTween(){return this._mathTweens&&this._mathTweens.forEach(t=>{t.tween.stop()}),this}createCorners(){this.corners=new GLUICornerPin(this)}getAlpha(){if(this._gluiParent){let alpha=this._gluiParent.getAlpha();return this.alpha=alpha,alpha}let alpha=this.alpha,$parent=this.parent;for(;$parent;)alpha*=$parent.alpha,$parent=$parent.parent;return alpha}getHover(){return this.hover}get shader(){return this._shader}_divFocus(){this._onOver&&this._onOver({action:"over",object:this}),this.onDivFocus&&this.onDivFocus()}_divBlur(){this._onOver&&this._onOver({action:"out",object:this}),this.onDivBlur&&this.onDivBlur()}_divSelect(){this._onClick&&this._onClick({action:"click",object:this}),this.onDivBlurSelect&&this.onDivSelect()}get _parent(){return this.parent}}!function(){var _geom2d,_geom3d;GLUIObject.getGeometry=function(type){return"2d"==type?(_geom2d||(_geom2d=new PlaneGeometry(1,1)).applyMatrix((new Matrix4).makeTranslation(.5,-.5,0)),_geom2d):(_geom3d||(_geom3d=World.PLANE),_geom3d)},GLUIObject.clear=function(){_geom2d=_geom3d=null},GLUIObject.noop=_=>{}}();class GLUIText{constructor(text,fontName,fontSize,options={}){options.font=fontName||options.font,options.text=text,options.width=options.width,options.align=options.align||"left",options.size=fontSize||options.size,options.lineHeight=options.lineHeight,options.letterSpacing=options.letterSpacing,options.wordSpacing=options.wordSpacing,options.wordBreak=options.wordBreak,options.langBreak=options.langBreak,options.color=new Color(options.color),this.text=new GLText(options),this.group=new Group,this.alpha=1,this._x=0,this._y=0,this._z=0,this._scaleX=1,this._scaleY=1,this._scale=1,this._rotation=0,this.multiTween=!0;const _this=this;defer(_=>text&&_this.seoText(text)),this.text.ready().then(_=>{let mesh=_this.text.mesh;mesh.glui=_this,mesh.shader.visible=!1,_this.mesh=mesh,_this.group.add(mesh),_this._3d&&!_this._style2d&&_this.text.centerY(),_this._3d||(_this.text.mesh.shader.depthTest=!1),mesh.onBeforeRender=_=>{if(!mesh.determineVisible()&&!_this.firstRender)return;let alpha=_this.getAlpha();mesh.shader.uniforms.uAlpha&&(mesh.shader.uniforms.uAlpha.value=alpha),0!=alpha?(mesh.shader.visible=!0,!_this.isDirty&&_this.firstRender||(RenderStats.active&&RenderStats.update("GLUIText",1,mesh.shader.vsName+"|"+mesh.shader.fsName,mesh),_this.group.position.x=_this._x,_this.group.position.y=_this._3d?_this._y:-_this._y,_this.group.position.z=_this._z,_this.group.scale.set(_this._scaleX*_this._scale,_this._scaleY*_this._scale,1),_this._3d?_this.anchor&&_this.anchor._parent?(_this.anchor.position.copy(_this.group.position),_this.anchor.scale.copy(_this.group.scale),_this.anchor.quaternion.setFromEuler(_this._rotation)):_this.group.quaternion.setFromEuler(_this._rotation):_this.group.rotation.z=Math.radians(_this._rotation),_this.firstRender||(_this.group.updateMatrixWorld(!0),_this.firstRender=!0,mesh.shader.visible=!0),_this.onInternalUpdate&&_this.onInternalUpdate(),_this.isDirty=!1)):mesh.shader.visible=!1}})}get x(){return this._x}set x(v){this._x=v,this.isDirty=!0}get y(){return this._y}set y(v){this._y=v,this.isDirty=!0}get z(){return this._z}set z(v){this._z=v,this.isDirty=!0}get scale(){return this._scale}set scale(v){this._scale=v,this.isDirty=!0}get scaleX(){return this._scaleX}set scaleX(v){this._scaleX=v,this.isDirty=!0}get scaleY(){return this._scaleY}set scaleY(v){this._scaleY=v,this.isDirty=!0}get rotation(){return this._rotation}set rotation(v){this._rotation=v,this.isDirty=!0}get dimensions(){return this._dimensions||(this._dimensions={}),this.text&&this.text.geometry&&!this._dimensions.max&&(this._dimensions=this.text.geometry.boundingBox,this._dimensions.width=Math.abs(this._dimensions.min.x-this._dimensions.max.x),this._dimensions.height=Math.abs(this._dimensions.min.y-this._dimensions.max.y)),this._dimensions}interact(over,click,camera=World.CAMERA,seoLink){"string"==typeof camera&&(seoLink=camera,camera=World.CAMERA),this._onOver=over,this._onClick=click,this._interactCamera=camera;let stage=this._3d?GLUI.Scene:GLUI.Stage;const _this=this;return _this.text.ready().then(_=>{if(over){if(_this.text.geometry.boundingBox||_this.text.geometry.computeBoundingBox(),!_this.hitArea){let bb=_this.text.geometry.boundingBox,shader=Utils3D.getTestShader();if(shader.visible=!1,_this.hitArea=new Mesh(World.PLANE,shader),_this.hitArea.glui=_this,_this.hitArea.scale.set(Math.abs(bb.min.x)+Math.abs(bb.max.x),Math.abs(bb.min.y)+Math.abs(bb.max.y),1),_this._3d&&!_this._style2d||(_this.hitArea.position.x=(bb.max.x-bb.min.x)/2),_this.hitArea.position.y=(bb.min.y-bb.max.y)/2,_this._3d)switch(_this.text.getData().align){case"center":_this.hitArea.position.x=0;break;case"right":_this.hitArea.position.x=(bb.min.x-bb.max.x)/2}else switch(_this.text.getData().align){case"center":_this.hitArea.position.x=0;break;case"right":_this.hitArea.position.x=-(bb.max.x-bb.min.x)/2}_this.text.mesh.add(_this.hitArea)}stage.interaction.add(_this.hitArea,camera)}else stage.interaction.remove(_this.hitArea,camera)}),defer(_=>{seoLink&&_this.seo&&_this.seo.aLink(seoLink)}),this}remove(){let stage=this._3d?GLUI.Scene:GLUI.Stage;this.mesh&&this.mesh.parent?this.group.parent.remove(this.group):stage.remove(this),this.hitArea&&stage.interaction.remove(this.hitArea,this._interactCamera),this.text&&this.text.destroy&&this.text.destroy(),Utils.nullObject(this.mesh),Utils.nullObject(this)}tween(obj,time,ease,delay){return tween(this,obj,time,ease,delay)}enable3D(style2d){this._3d=!0,this._style2d=style2d,this._rotation=new Euler;const _this=this;return _this._rotation.onChange(_=>{_this.isDirty=!0}),_this.text.ready().then(_=>{_this.text.mesh.shader.depthTest=!0}),_this.isDirty=!0,this}depthTest(bool){const _this=this;return _this.text.ready().then(_=>{_this.text.mesh.shader.depthTest=bool}),this}setZ(z){const _this=this;return _this.text.ready().then(_=>{_this.text.mesh.renderOrder=z}),this}height(){return this.mesh?this.text.height:0}setText(text,options){text&&(text=text.toString(),this.seoText(text));const _this=this;return this._dimensions=null,_this.text.ready().then(_=>_this.text.setText(text,options)),this}seoText(text){window.GLSEO&&GLSEO.textNode(this,text)}getTextString(){return this.text.string}setColor(color){const _this=this;return _this.text.ready().then(_=>_this.text.setColor(color)),this}tweenColor(color,time,ease,delay){const _this=this;return _this.text.ready().then(_=>_this.text.tweenColor(color,time,ease,delay)),this}resize(options){const _this=this;_this.text.ready().then(_=>_this.text.resize(options))}show(){return this.text.ready().then(_=>{this.text.mesh.visible=!0,this.text.mesh.updateMatrixWorld(!0)}),this}hide(){const _this=this;return _this.text.ready().then(_=>_this.text.mesh.visible=!1),this}loaded(){return this.text.ready()}length(){return this.text.charLength}deferRender(parent){this.deferred=!0,parent||(this.anchor||(this.anchor=new Group),GLUI.Scene.addDeferred(this))}getAlpha(){if(this._gluiParent){let alpha=this._gluiParent.getAlpha();return this.alpha=alpha,alpha}let alpha=this.alpha,$parent=this.parent;for(;$parent;)alpha*=$parent.alpha,$parent=$parent.parent;return alpha}size(){}upload(){const _this=this;return _this.text.ready().then(_=>_this.text.mesh.upload()),this}_divFocus(){this._onOver&&this._onOver({action:"over",object:this}),this.onDivFocus&&this.onDivFocus()}_divBlur(){this._onOver&&this._onOver({action:"out",object:this}),this.onDivBlur&&this.onDivBlur()}_divSelect(){this._onClick&&this._onClick({action:"click",object:this}),this.onDivBlurSelect&&this.onDivSelect()}get _parent(){return this.parent}async useShader(shader){await this.text.ready(),shader.uniforms.tMap=this.text.shader.uniforms.tMap,shader.uniforms.uAlpha=this.text.shader.uniforms.uAlpha,shader.uniforms.uColor=this.text.shader.uniforms.uColor,shader.transparent=!0,(!this._3d||this._3d||this.parent)&&(shader.depthTest=!1),this.text.mesh.shader=shader||text.shader}}Class((function GLUIStage(){Inherit(this,Component);const _this=this;var _scene=new Scene,_camera=new OrthographicCamera(1,1,1,1,.1,1);function resizeHandler(){_camera.left=Stage.width/-2,_camera.right=Stage.width/2,_camera.top=Stage.height/2,_camera.bottom=Stage.height/-2,_camera.near=.01,_camera.far=1e3,_camera.updateProjectionMatrix(),_camera.position.x=Stage.width/2,_camera.position.y=-Stage.height/2}this.interaction=new GLUIStageInteraction2D(_camera,_scene,Stage),this.alpha=1,this.scene=_scene,_scene.disableAutoSort=!0,_camera.position.z=1,function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}(),resizeHandler(),this.add=function($obj){$obj.parent=_this,_scene.add($obj.group||$obj.mesh)},this.remove=function($obj){$obj.parent=null,_scene.remove($obj.group)},this.renderToRT=function(scene,rt){let clearAlpha;rt.fxscene&&rt.fxscene.clearAlpha>-1&&(clearAlpha=World.RENDERER.getClearAlpha(),World.RENDERER.setClearAlpha(0));let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(scene,_camera,rt),World.RENDERER.autoClear=autoClear,clearAlpha&&World.RENDERER.setClearAlpha(clearAlpha)},this.render=function loop(){if(!_scene.children.length)return;let clear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(_scene,_camera,null,!0),World.RENDERER.autoClear=clear},this.renderDirect=callback=>{_scene.children.length&&(_scene.traverse(obj=>{obj.shader&&(obj.shader.depthTest=!1)}),callback(_scene,_camera))}})),Class((function GLUIStage3D(){Inherit(this,Object3D);const _this=this;var _camera,_externalRenders=[],_scene=new Scene,_list=new LinkedList;this.alpha=1,this.interaction=new GLUIStageInteraction3D,this.add=function(obj,parent){obj.parent=_this,obj._gluiParent=parent,obj._3d||obj.enable3D(),obj.deferRender()},this.addDeferred=function(obj){_list.push(obj),_scene.add(obj.group||obj.mesh)},this.remove=function(obj){_scene.remove(obj.group||obj.mesh),_list.remove(obj)},this.disableAutoSort=function(){_scene.disableAutoSort=!0},this.renderToRT=function(scene,camera){camera=camera.camera||camera,scene.traverse(mesh=>{let obj=mesh.glui;obj&&obj.anchor.determineVisible()&&Utils3D.decompose(obj.anchor,obj.group)}),scene._textRenderCamera=camera,_externalRenders.push(scene)},this.renderToRT2=function(scene,rt,camera){let clearAlpha;rt.fxscene&&rt.fxscene.clearAlpha>-1&&(clearAlpha=World.RENDERER.getClearAlpha(),World.RENDERER.setClearAlpha(0));let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.render(scene,camera,rt),World.RENDERER.autoClear=autoClear,clearAlpha&&World.RENDERER.setClearAlpha(clearAlpha)},this.render=function loop(){if(!window.Metal){if(_list.length){let obj=_list.start();for(;obj;)obj._marked&&(obj._marked=!1,Utils3D.decompose(obj.anchor,obj.group)),obj=_list.next();let clear=World.RENDERER.autoClear;Renderer.context.clear(Renderer.context.DEPTH_BUFFER_BIT),World.RENDERER.autoClear=!1,World.RENDERER.render(_scene,_camera||World.CAMERA),World.RENDERER.autoClear=clear}if(_externalRenders.length)for(;_externalRenders.length;){let scene=_externalRenders.shift(),camera=scene._textRenderCamera,clear=World.RENDERER.autoClear;Renderer.context.clear(Renderer.context.DEPTH_BUFFER_BIT),World.RENDERER.autoClear=!1,World.RENDERER.render(scene,camera),World.RENDERER.autoClear=clear}}},this.mark=function mark(){let obj=_list.start();for(;obj;)obj.anchor._parent&&(obj.group.visible=obj.anchor.determineVisible()),obj.mesh&&obj.mesh.determineVisible()&&obj.anchor._parent&&(obj._marked=!0),obj=_list.next()},this.renderDirect=function(callback){if(_list.length){let obj=_list.start();for(;obj;)obj._marked&&(obj._marked=!1,Utils3D.decompose(obj.anchor,obj.group)),obj=_list.next();_scene.traverse(obj=>{obj.shader&&(obj.shader.depthTest=!1)}),callback(_scene,_camera||World.CAMERA)}},this.set("camera",c=>{_camera=c.camera||c})})),Class((function GLUIStageInspector(){Inherit(this,Component);var $container;this.snapshot=function(){!function initContainer(){$container||(($container=$(document.createElement("div"))).attr("class","GLUIStage"),$container.size("100%").invisible(),Stage.add($container)),$container.empty()}(),function traverse(scene,$el){for(let child of scene.children){let isText=!1;if(child.glui){let $child=$(document.createElement("div"));if(child.glui.stageLayout?($child.attr("class","StageLayout"),$child.attr("name",child.glui.stageLayout.name)):child.glui.name&&$child.attr("class",child.glui.name),$child.x=child.glui.x,$child.y=child.glui.y,$child.rotation=-child.glui.rotation,$child.scale=child.glui.scale,$child.scaleX=child.glui.scaleX,$child.scaleY=child.glui.scaleY,$child.css({transformOrigin:"top left"}),child.glui.text){isText=!0;let data=child.glui.text.getData();switch($child.size(data.width,data.height),$child.text(data.text),$child.attr("shader",child.glui.text.mesh.shader.vsName),data.align){case"center":$child.css({marginLeft:.5*-data.width});break;case"right":$child.css({marginLeft:-data.width})}}else $child.size(child.glui.width,child.glui.height),$child.attr("shader",child.glui.mesh.shader.vsName);$child.transform(),$child.div.glui=child.glui,$el.add($child),$el=$child}child.children&&!isText&&traverse(child,$el)}}(GLUI.Stage.scene,$container)}}),"singleton"),Class((function GPU(){Inherit(this,Component);var _this=this,_split={};Hydra.ready(async()=>{for(var key in _this.detect=function(match){if(Device.graphics.gpu)return Device.graphics.gpu.detect(match)},_this.detectAll=function(){if(Device.graphics.gpu){for(var match=!0,i=0;i<arguments.length;i++)Device.graphics.gpu.detect(arguments[i])||(match=!1);return match}},_this.matchGPU=function(str,min,max=99999){let num=function splitGPU(string){if(_split[string])return _split[string];if(!_this.detect(string))return-1;try{var num=Number(_this.gpu.split(string)[1].split(" ")[0]);return _split[string]=num,num}catch(e){return-1}}(str);return num>=min&&num<max},_this.gpu=Device.graphics.gpu?Device.graphics.gpu.identifier:"","apple gpu"==_this.gpu&&(Device.mobile?require("iOSGPUTest")():require("MacOSPerformanceTest")()),_this.BLACKLIST=require("GPUBlacklist").match(),_this.T0=!(Device.mobile||!_this.BLACKLIST&&!_this.detect("radeon(tm) r5")&&!_this.detect("hd graphics family")&&!_this.matchGPU("hd graphics ",1e3,5001)&&!(_this.matchGPU("hd graphics ",0,618)&&Device.pixelRatio>1)&&!(_this.detect(["hd graphics","iris"])&&Math.max(Stage.width,Stage.height)>1800)&&"intel iris opengl engine"!==_this.gpu.toLowerCase()&&!_this.matchGPU("iris(tm) graphics ",1e3)),_this.T1=!(_this.BLACKLIST||Device.mobile||_this.T0||!_this.matchGPU("iris(tm) graphics ",540,1e3)&&!_this.matchGPU("hd graphics ",514,1e3)&&_this.detect(["nvidia","amd","radeon","geforce"])),_this.T2=!_this.BLACKLIST&&!Device.mobile&&!(!_this.detect(["nvidia","amd","radeon","geforce"])||_this.T1||_this.T0),_this.T3=!(_this.BLACKLIST||Device.mobile||!_this.detect(["titan","amd radeon pro","quadro"])&&!_this.matchGPU("gtx ",940)&&!_this.detect("apple m")&&!_this.matchGPU("radeon (tm) rx ",400)&&!_this.matchGPU("radeon rx ",400)&&!_this.matchGPU("radeon pro ",420)),_this.T4=!(_this.BLACKLIST||Device.mobile||!_this.detect(["titan","quadro","vega","radeon vii"])&&!_this.matchGPU("gtx ",1040)&&!_this.matchGPU("rtx")&&!_this.matchGPU("radeon rx ",500)),_this.T5=!(_this.BLACKLIST||Device.mobile||!_this.detect(["titan","vega","radeon vii"])&&!_this.matchGPU("gtx ",1080)&&!_this.matchGPU("rtx ",2060)),_this.MT0=!!Device.mobile&&(!!_this.BLACKLIST||!("ios"!=Device.system.os||!_this.detect("a7"))||!("android"!=Device.system.os||!_this.detect("sgx"))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",0,415):!!_this.detect("mali")&&_this.matchGPU("mali-t",0,628))),_this.MT1=!(!Device.mobile||_this.BLACKLIST||("ios"!=Device.system.os||!_this.detect(["a8","a9"]))&&("android"!=Device.system.os||_this.MT0)),_this.MT2=function(){if(!Device.mobile)return!1;if(_this.BLACKLIST)return!1;if("ios"==Device.system.os&&_this.detect("a10"))return!0;if(_this.detect("nvidia tegra")&&Device.detect("pixel c"))return!0;if(_this.detect("mali-g"))return _this.matchGPU("mali-g",71);if(_this.detect("adreno")){if(_this.matchGPU("adreno (tm) ",600,616))return!0;if(_this.matchGPU("adreno (tm) ",420))return!0}return!!_this.detect("mali-g")}(),_this.MT3=!(!Device.mobile||_this.BLACKLIST||("ios"!=Device.system.os||!_this.detect(["a11","a12"]))&&!_this.matchGPU("adreno (tm) ",530,600)&&(!navigator.platform.toLowerCase().includes(["mac","windows"])||"chrome"!=Device.system.browser)),_this.MT4=!!Device.mobile&&!_this.BLACKLIST&&(!("ios"!=Device.system.os||!_this.detect(["a13","a14","a15","a16","a17","a18"]))||(_this.detect("adreno")?_this.matchGPU("adreno (tm) ",630):!(!navigator.platform.toLowerCase().includes(["mac","windows"])||"chrome"!=Device.system.browser))),_this.lt=function(num){return _this.TIER>-1&&_this.TIER<=num},_this.gt=function(num){return _this.TIER>-1&&_this.TIER>=num},_this.eq=function(num){return _this.TIER>-1&&_this.TIER==num},_this.mobileEq=function(num){return _this.M_TIER>-1&&_this.M_TIER==num},_this.mobileLT=function(num){return _this.M_TIER>-1&&_this.M_TIER<=num},_this.mobileGT=function(num){return _this.M_TIER>-1&&_this.M_TIER>=num},_this)"T"==key.charAt(0)&&!0===_this[key]&&(_this.TIER=Number(key.charAt(1))),"MT"==key.slice(0,2)&&!0===_this[key]&&(_this.M_TIER=Number(key.charAt(2)));!1!==Utils.query("gpu")&&(Device.mobile||Utils.query("gpu").toString().includes("m")?(_this.TIER=-1,_this.M_TIER=Number(Utils.query("gpu").slice(1))):_this.TIER=Number(Utils.query("gpu"))),_this.OVERSIZED=!Device.mobile&&_this.TIER<2&&Math.max(window.innerWidth,window.innerHeight)>1500,"ie"==Device.system.browser&&(_this.OVERSIZED=!0),_this.initialized=!0}),this.ready=function(){return this.wait("initialized")}}),"static"),Module((function MacOSPerformanceTest(){function test(){let results=[];function getPrime(){return function largest_prime_factor(n){return factors(n).filter(primep).pop()}(1e12)}function factors(n){var i,out=[],sqrt_n=Math.sqrt(n);for(i=2;i<=sqrt_n;i++)n%i==0&&out.push(i);return out}function primep(n){return 0===factors(n).length}for(let i=0;i<3;i++){let time=performance.now();getPrime(),results.push(10*(performance.now()-time))}return results.sort((a,b)=>a-b),results[0]}this.exports=function(){let result=test();screen.width<=1440&&screen.height<=900?Device.graphics.webgl.gpu=result>540?"intel iris opengl engine":"safari tier 1":Device.graphics.webgl.gpu=result>475?result>540?"intel iris opengl engine":"safari tier 1":result<375?"amd radeon pro 455 opengl engine":"nvidia geforce 750m opengl engine"}})),Module((function iOSGPUTest(){function test(){let results=[];function getPrime(){return function largest_prime_factor(n){return factors(n).filter(primep).pop()}(1e11)}function factors(n){var i,out=[],sqrt_n=Math.sqrt(n);for(i=2;i<=sqrt_n;i++)n%i==0&&out.push(i);return out}function primep(n){return 0===factors(n).length}for(let i=0;i<3;i++){let time=performance.now();getPrime(),results.push(10*(performance.now()-time))}return results.sort((a,b)=>a-b),results[0]}this.exports=function(){let res=Math.min(screen.width,screen.height)+"x"+Math.max(screen.width,screen.height),time=test();switch(res){case"320x480":Device.graphics.webgl.gpu="legacy";break;case"320x568":Device.graphics.webgl.gpu=time<=400?"apple a8":time<=500?"apple a7":"legacy";break;case"375x812":case"414x896":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":"apple a11";break;default:case"414x736":case"375x667":case"768x1024":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":time<=250?"apple a10":time<=360?"apple a9":time<=400?"apple a8":time<=600?"apple a7":"legacy";break;case"834x1112":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":"apple a10";break;case"834x1194":Device.graphics.webgl.gpu="apple a12";break;case"1024x1366":Device.graphics.webgl.gpu=time<=160?"apple a13":time<=180?"apple a12":time<=220?"apple a11":time<=250?"apple a10":"apple a9"}}})),Module((function GPUBlacklist(){this.exports={match:function(){return!Device.graphics.gpu||Device.graphics.gpu.detect(["radeon hd 6970m","radeon hd 6770m","radeon hd 6490m","radeon hd 6630m","radeon hd 6750m","radeon hd 5750","radeon hd 5670","radeon hd 4850","radeon hd 4870","radeon hd 4670","geforce 9400m","geforce 320m","geforce 330m","geforce gt 130","geforce gt 120","geforce gtx 285","geforce 8600","geforce 9600m","geforce 9400m","geforce 8800 gs","geforce 8800 gt","quadro fx 5","quadro fx 4","radeon hd 2600","radeon hd 2400","radeon hd 2600","radeon r9 200","mali-4","mali-3","mali-2","google swiftshader","sgx543","legacy","sgx 543"])}}})),Class((function Initializer3D(){Inherit(this,Component);const _this=this;let _loader,_working,_promises=[],_queue=[];async function resolve(){await Promise.all(_promises),clearTimeout(_this.fire),_this.fire=_this.delayedCall(_=>{_this.events.fire(_this.READY),_this.resolved=!0,Utils3D.onTextureCreated=null,_loader&&_loader.trigger(50)},100)}async function workQueue(){clearTimeout(_this.warningTimer),_working=!0;let promise=_queue.shift();if(!promise)return _working=!1;promise.resolve(workQueue),Hydra.LOCAL&&(_this.warningTimer=_this.delayedCall(_=>{console.warn("Long running queue has taken more than 5 seconds.")},5e3))}function incCompleted(){_loader&&_loader.trigger(1)}this.READY="initializer_ready",this.bundle=function(){return new function PromiseBundler(){const promises=[],ready=Promise.create();let timer;function run(){clearTimeout(timer),timer=_this.delayedCall(_=>{Promise.all(promises).then(_=>ready.resolve())},100)}this.capture=function(promise){promises.push(promise),run()},this.ready=function(){return run(),ready}}},this.promise=this.capture=function(promise){return _loader&&_loader.add(1),promise.then(incCompleted),_promises.push(promise),clearTimeout(_this.timer),_this.timer=_this.delayedCall(resolve,100),promise},this.ready=this.loaded=function(){return _this.wait(_this,"resolved")},this.createWorld=async function(){await Promise.all([AssetLoader.waitForLib("zUtils3D"),Shaders.ready(),UILStorage.ready()]),World.instance()},this.linkSceneLayout=function(loader){_this.captureTextures(),SceneLayout.initializer=_this.capture,_loader=loader},this.queue=function(immediate){if(immediate)return Promise.resolve(_=>{});let promise=Promise.create();return _queue.push(promise),_working||workQueue(),promise},this.captureTextures=function(){Utils3D.onTextureCreated=texture=>{_this.promise(texture.promise)}},this.uploadAll=async function(group){if(!group)throw"Undefined passed to uploadAll";let sceneLayout;if(group instanceof SceneLayout||window.StageLayout&&group instanceof StageLayout){if(sceneLayout=group,sceneLayout.uploaded)return;sceneLayout.uploaded=!0,await sceneLayout.loadedAllLayers(),group=group.group}let promises=[],layouts=[],textures=[];sceneLayout&&(sceneLayout.textures=textures),group.traverse(obj=>{if(obj.sceneLayout&&obj!=group&&layouts.push(obj.sceneLayout),obj.stageLayout&&obj!=group&&layouts.push(obj.stageLayout),!obj.uploadIgnore&&0!=obj.visible){if(obj.shader)for(let key in obj.shader.uniforms){let uniform=obj.shader.uniforms[key];uniform&&uniform.value&&uniform.value.promise&&(textures.push(uniform.value),promises.push(uniform.value.promise.then(_=>uniform.value.upload.bind(uniform.value)).catch(e=>{})))}obj.asyncPromise?promises.push(obj.asyncPromise.then(_=>obj.upload.bind(obj))):obj.upload&&obj.upload()}}),await Promise.catchAll(promises),textures.forEach(t=>t.upload());for(let i=0;i<layouts.length;i++)await _this.uploadAll(layouts[i]);sceneLayout&&sceneLayout._completeInitialization&&sceneLayout._completeInitialization(!0)},this.uploadAllDistributed=this.uploadAllAsync=async function(group){if(!group)throw"Undefined passed to uploadAllDistributed";let sceneLayout;if(group instanceof SceneLayout||window.StageLayout&&group instanceof StageLayout){if(sceneLayout=group,sceneLayout.uploaded)return;sceneLayout.uploaded=!0,await sceneLayout.loadedAllLayers(),group=group.group}let uploads=[],_async=[],promises=[],layouts=[],textures=[];sceneLayout&&(sceneLayout.textures=textures),group.traverse(obj=>{if(obj.sceneLayout&&obj!=group&&layouts.push(obj.sceneLayout),obj.stageLayout&&obj!=group&&layouts.push(obj.stageLayout),!obj.uploadIgnore&&0!=obj.visible){if(obj.shader)for(let key in obj.shader.uniforms){let uniform=obj.shader.uniforms[key];uniform&&uniform.value&&uniform.value.promise&&(textures.push(uniform.value),promises.push(uniform.value.promise.then(_=>uploads.push(uniform.value.upload.bind(uniform.value))).catch(e=>{})))}if(obj.asyncPromise)promises.push(obj.asyncPromise.then(_=>{obj.geometry&&(obj.geometry.distributeBufferData=!0),uploads.push(obj.upload.bind(obj)),obj.geometry&&_async.push(obj.geometry.uploadBuffersAsync.bind(obj.geometry))}));else if(obj.upload){if(obj.geometry){if(obj.geometry._gl&&obj.geometry._gl.uploaded)return;obj.geometry.distributeBufferData=!0}uploads.push(obj.upload.bind(obj)),obj.geometry&&_async.push(obj.geometry.uploadBuffersAsync.bind(obj.geometry))}}});let canFinish=!1,promise=Promise.create(),worker=new Render.Worker(_=>{let upload=uploads.shift();upload?upload():canFinish?((async _=>{for(let i=0;i<_async.length;i++)await _async[i]();for(let i=0;i<layouts.length;i++)await _this.uploadAllAsync(layouts[i]);promise.resolve()})(),worker.stop()):worker.pause()},1);return Promise.catchAll(promises).then(_=>{worker.resume(),canFinish=!0}),sceneLayout&&sceneLayout._completeInitialization&&sceneLayout._completeInitialization(!1),promise},this.detectUploadAll=function(group,sync){return sync?_this.uploadAll(group):_this.uploadAllDistributed(group)},this.detectUploadNuke=function(nuke,sync){return sync?_this.uploadNukeAsync(nuke):_this.uploadNuke(nuke)},this.uploadNuke=async function(nuke){for(let i=0;i<nuke.passes.length;i++){let pass=nuke.passes[i],uniforms=pass.uniforms;for(let key in uniforms)uniforms[key].promise&&await uniforms[key].promise,uniforms[key].upload&&uniforms[key].upload();pass.upload()}},this.uploadNukeAsync=function(nuke){return this.uploadNuke(nuke)},this.set("loader",loader=>{_loader=loader})}),"static"),Class((function KeyboardUtil(){Inherit(this,Component);var _this=this;function addListeners(){__window.keydown(keydown),__window.keyup(keyup),__window.keypress(keypress)}function keydown(e){_this.events.fire(_this.DOWN,e)}function keyup(e){_this.events.fire(_this.UP,e)}function keypress(e){_this.events.fire(_this.PRESS,e)}_this.DOWN="keyboard_down",_this.PRESS="keyboard_press",_this.UP="keyboard_up",Hydra.ready(addListeners)}),"static"),Class((function AreaLightUtil(){Inherit(this,Component);var _init,_loaded=Promise.create(),_textures=[];this.append=async function(shader){Lighting.fallbackAreaToPoint||(_init||async function load(){_init=!0;let data=await fetch(Assets.getPath("assets/images/_lighting/arealights.json")),json=await data.json();_textures[0]=new DataTexture(new Float32Array(json.LTC1),64,64,Texture.RGBAFormat,Texture.FLOAT),_textures[1]=new DataTexture(new Float32Array(json.LTC2),64,64,Texture.RGBAFormat,Texture.FLOAT),_loaded.resolve()}(),shader.uniforms.tLTC1={type:"t",value:null},shader.uniforms.tLTC2={type:"t",value:null},await _loaded,shader.set("tLTC1",_textures[0]),shader.set("tLTC2",_textures[1]))}}),"static"),Class((function Light(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_folder,_debug,prefix=`L_${_input.prefix}`,_light=this.light=new BaseLight;function loop(){_light.position.copy(_this.group.position),_light.rotation.copy(_this.group.rotation)}function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light[key];if(_folder){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onChange(e=>{_light[key]=e,_this.events.fire(Light.UPDATE,{prefix:prefix,key:key,val:e,group:_this})}),number.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_folder.add(number)}_light[key]=initValue}function update(e){e.prefix==prefix&&e.group!=_this&&(e.color?_light[e.key].set(e.val):_light[e.key]=e.val)}!function(){if(!1===_input.get("visible"))return;!async function initConfig(){(_config=InputUIL.create(prefix+"_config",_group)).setLabel("Config"),_config.addSelect("type",[{label:"Null",value:"-1"},{label:"Directional",value:"0"},{label:"Point",value:"1"},{label:"Spot",value:"2"},{label:"Area",value:"3"}]),await defer();let setup=_=>{_light.properties.w=_config.getNumber("type")+1,_group&&Utils.query("debugLight")&&(_debug&&_debug.destroy(),_debug=_this.initClass(LightDebug,_config.getNumber("type"),_light,_folder))};setup(),function initSpecificUIL(type){switch(type){case 0:break;case 2:_light.radius=1,_light.feather=0,_light.rotation.set(0,Math.radians(90),0),initNumber("radius"),initNumber("feather"),_light.data.set(_light.rotation.z,_light.rotation.y,_light.rotation.x,_light.radius),_light.data2.x=_light.feather,_group&&_this.startRender(_=>{_light.data2.x=_light.feather,_light.data.set(_light.rotation.z,_light.rotation.y,_light.rotation.x,_light.radius)});break;case 3:_light._overridePos=new Vector3,_light.width=1,_light.height=1,_light.roughness=.5,_light.isAreaLight=!0,initNumber("width"),initNumber("height"),initNumber("roughness");let pos=new Vector3,matrix4=new Matrix4,matrix42=new Matrix4,halfWidth=new Vector3,halfHeight=new Vector3,camera=World.CAMERA,p=_this.group._parent;for(;p;)p instanceof Scene&&p.nuke&&(camera=p.nuke.camera),p=p._parent;let updateProperties=_=>{_light.updateMatrixWorld(!0),pos.setFromMatrixPosition(_light.matrixWorld),pos.applyMatrix4(camera.matrixWorldInverse),_light.data.x=pos.x,_light.data.y=pos.y,_light.data.z=pos.z,_light.data.w=_light.roughness,matrix42.identity(),matrix4.copy(_light.matrixWorld),matrix4.premultiply(camera.matrixWorldInverse),matrix42.extractRotation(matrix4),halfWidth.set(.5*_light.width,0,0),halfHeight.set(0,.5*_light.height,0),halfWidth.applyMatrix4(matrix42),halfHeight.applyMatrix4(matrix42),_light.data2.x=halfWidth.x,_light.data2.y=halfWidth.y,_light.data2.z=halfWidth.z,_light.data3.x=halfHeight.x,_light.data3.y=halfHeight.y,_light.data3.z=halfHeight.z};RenderManager.type==RenderManager.WEBVR?_this.events.sub(RenderManager.EYE_RENDER,e=>{_this.invisible||(camera=e.camera,updateProperties())}):_this.startRender(updateProperties)}}(_config.getNumber("type")),_config.onUpdate=setup}(),_group&&(_folder=function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:"Params",closed:!0});return _group.add(folder),folder}(),function addListeners(){_this.events.sub(Light.UPDATE,update)}()),initNumber("intensity"),initNumber("distance"),initNumber("bounce"),function initColor(key){let initValue=UILStorage.get(`${prefix}${key}`);if(_folder){let color=new UILControlColor(`${prefix}${key}`,{label:key,value:initValue});color.onChange(e=>{_light[key].set(e),_this.events.fire(Light.UPDATE,{prefix:prefix,key:key,val:e,color:!0,group:_this})}),color.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_folder.add(color)}initValue&&_light[key].set(initValue)}("color");let p=_this.parent.group._parent;for(;p;)p instanceof Scene&&p._lightingData&&(_light._lightingData=p._lightingData),p=p._parent;Lighting.add(_light),_this.startRender(loop)}(),this.onDestroy=function(){_light.destroy()}}),_=>{Light.UPDATE="light_update"}),Class((function LightDebug(_type,_light,_folder){Inherit(this,Object3D);const _this=this;function createLight(){let geom=World.SPHERE,shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.depthTest=!1,shader.transparent=!0;let mesh=new Mesh(geom,shader);mesh.scale.setScalar(.5),_this.add(mesh)}!function(){switch(_type){case-1:case 1:!function initPoint(){createLight();let geom=new IcosahedronGeometry(1,1),shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.wireframe=!0,shader.transparent=!0,shader.set("alpha",.2);let mesh=new Mesh(geom,shader);mesh.scale.setScalar(_light.distance),_this.add(mesh),_this.startRender(_=>mesh.scale.setScalar(_light.distance))}();break;case 2:!function initSpot(){createLight()}();break;case 3:!function initArea(){let geom=World.PLANE,shader=Utils3D.getTestShader(_light.color);shader.set("color",_light.color),shader.transparent=!0,shader.side=Shader.DOUBLE_SIDE;let mesh=new Mesh(geom,shader);_this.add(mesh),_this.startRender(_=>mesh.scale.set(_light.width,_light.height,1))}()}}(),this.onDestroy=function(){_this.parent.group.remove(_this.group)}})),Class((function ShadowLight(_input,_group){Inherit(this,Object3D);const _this=this;var _light,_timer;!async function(){(_light=new BaseLight).prefix=_input.prefix,_this.add(_light),_light.silentShadow=ShadowLight.LOCKED,_this.light=_light;let p=_this.parent.group._parent;for(;p;)p instanceof Scene&&p._lightingData&&(_light._lightingData=p._lightingData),p=p._parent;if(_light.castShadow=!0,ShadowUIL.add(_light,_group).setLabel("Shadows"),ShadowLight.LOCKED)return;_this.startRender(_=>{}),await defer();let scene=function findScene(){let p=_this.group._parent;for(;p;){if(p instanceof Scene)return p;p=p._parent}}();if(!scene)return console.warn("Shadow light has no parent scene");scene.hasShadowLight=!0,scene.bindSceneChange(_=>{_light.static&&(_light.shadow.frozen=!1,clearTimeout(_timer),_timer=_this.delayedCall(_=>_light.shadow.frozen=!0,250))})}(),this.onVisible=async function(){await defer(),_light.static&&(_light.shadow.frozen=!1,clearTimeout(_timer),_timer=_this.delayedCall(_=>_light.shadow.frozen=!0,250))},this.onDestroy=function(){_light.destroy()}})),Class((function Webcam(_width,_height,_audio){Inherit(this,Component);var _this=this;let _stream,_cameras={},_config={},_back=!1,_attempts=0;function establishWebcam(){if(_attempts>=2||!navigator.mediaDevices)return error();(function lookupDevices(){let promise=Promise.create();return Device.mobile?(navigator.mediaDevices.enumerateDevices().then(devices=>{devices.forEach(device=>{device.label.includes("front")&&(_cameras.front={deviceId:{exact:device.deviceId}}),device.label.includes("back")&&(_cameras.back={deviceId:{exact:device.deviceId}},_back=!0)}),_cameras.front||(_cameras.front={facingMode:"user"}),_cameras.back||(_cameras.back={facingMode:"environment"},_back=!1),promise.resolve()}),promise):Promise.resolve()})().then(()=>{_stream&&_config.back&&_stream.getTracks()[0].stop(),Device.mobile.phone&&(_cameras&&_cameras.back&&(_cameras.back.frameRate={ideal:60}),_cameras&&_cameras.front&&(_cameras.front.frameRate={ideal:60})),navigator.mediaDevices.getUserMedia({video:_config.back?_cameras.back:_cameras.front||!0,audio:_audio}).then(success).catch(error)}),_attempts+=1}function success(stream){_this.denied=!1,_stream=stream,_config.back&&!_back?establishWebcam():(_this.div.srcObject=stream,_this.events.fire(Events.READY,null,!0))}function error(){_this.denied=!0,_this.events.fire(Events.ERROR,null,!0)}_this.facing="back",function createVideo(){_this.div=window.AURA?document.createElement():document.createElement("video"),_this.div.width=_width,_this.div.height=_height,_this.div.autoplay=!0,_this.div.controls=!0,_this.div.playsinline=!0,_this.div.setAttribute("playsinline",!0),_this.div.setAttribute("controls",!0),Stage.add(_this.div),_this.element=$(_this.div),_this.element.transformPoint(0,0).transform({scaleX:Device.mobile?1:-1,scale:.25}).setZ(-1)}(),function initNavigator(){navigator.getUserMedia=navigator.getUserMedia||navigator.webkitGetUserMedia||navigator.mozGetUserMedia||navigator.msGetUserMedia}(),this.createStream=function(config={}){_attempts=0,_config=config,establishWebcam()},this.flip=function(){if(!_back)return;let direction;"front"===_this.facing?(_this.facing="back",direction=_cameras.back):(_this.facing="front",direction=_cameras.front),_stream.getTracks()[0].stop(),navigator.getUserMedia({video:direction||!0,audio:_audio},success,error)},this.get("width",(function(){return _width})),this.get("height",(function(){return _height})),this.size=function(w,h){_this.div.width=_width=w,_this.div.height=_height=h,_this.element.size(w,h)},this.getPixels=function(width=_width,height=_height){return _this.canvas||(_this.canvas=document.createElement("canvas"),_this.canvas.width=width,_this.canvas.height=height,_this.canvas.context=_this.canvas.getContext("2d")),_this.canvas.context.drawImage(_this.div,0,0,width,height),_this.canvas.context.getImageData(0,0,width,height)},this.getCanvas=function(){return _this.canvas||(_this.canvas=document.createElement("canvas"),_this.canvas.width=_width,_this.canvas.height=_height,_this.canvas.context=_this.canvas.getContext("2d")),_this.canvas.context.drawImage(_this.div,0,0,_width,_height),_this.canvas},this.ready=function(){return _this.div.readyState>0},this.end=function(){_this.active=!1,_this.div.pause(),_stream&&(_stream.getTracks()[0].enabled=!1)},this.restart=function(){_this.div.play(),_stream&&(_stream.getTracks()[0].enabled=!0),_this.active=!0},this.deviceCount=async function(kind){if(!navigator.mediaDevices)return 0;let devices=await navigator.mediaDevices.enumerateDevices(),count=0;return devices.forEach(d=>{d.kind.includes(kind)&&count++}),count}})),Namespace("FX"),FX.Class((function Mirror(_mesh,_params={}){Inherit(this,FXScene);const _this=this;var _renderer;function loop({stage:stage,camera:camera}){if(!_this.visible||!_this.enabled)return;stage&&(_renderer.camera=camera,_this.nuke.camera=camera,_this.nuke.stage=stage),_this.draw(),_mesh.matrixWorld.decompose(_renderer.position,_renderer.quaternion,_renderer.scale),World.RENDERER.overridePreventShadows=!0;let clearAlpha=World.RENDERER.getClearAlpha();World.RENDERER.setClearAlpha(0),_renderer.render(_this.scene),World.RENDERER.setClearAlpha(clearAlpha),World.RENDERER.overridePreventShadows=!1,_this.postRender&&_this.postRender()}this.visible=!0,this.enabled="boolean"!=typeof _params.enabled||_params.enabled,_params.shader||(_params.shader=_mesh.shader),_this.create(_params.nuke||World.NUKE),_this.preventRTDraw=!0,function initMirror(){let width=_params.width||512,height=_params.height||512;_params.size&&(width=height=_params.size),_renderer=new MirrorRenderer(_this.nuke.camera,{width:width,height:height,clipBias:_params.clipBias||.01,format:_params.format})}(),function decorateShader(){if(!_mesh)throw"Mesh passed to Mirror needs a shader";_params.shader.uniforms.tMirrorReflection={value:_renderer.renderTarget.texture},_params.shader.uniforms.uMirrorMatrix={value:_renderer.textureMatrix}}(),this.onDestroy=function(){_renderer.destroy()},this.start=function(obj){RenderManager.type!=RenderManager.VR?_this.startRender(loop,obj):_this.events.sub(RenderManager.RENDER,loop)},this.stop=function(){RenderManager.type!=RenderManager.VR?_this.stopRender(loop):_this.events.unsub(RenderManager.RENDER,loop)},this.decorate=function(shader){shader.uniforms.tMirrorReflection={value:_renderer.renderTarget.texture},shader.uniforms.uMirrorMatrix={value:_renderer.textureMatrix}},this.useCamera=function(camera){camera=camera.camera||camera,_renderer.camera=camera,_this.nuke.camera=camera},this.set("clipBias",v=>_renderer.clipBias=v)}));class MirrorRenderer extends Base3D{constructor(camera,options={}){super(),this._camera=camera,this.width=options.width||512,this.height=options.height||512,this.clipBias=options.clipBias||0,this.renderer=World.RENDERER,this.mirrorPlane=new Plane,this.normal=new Vector3(0,0,1),this.mirrorWorldPosition=new Vector3,this.cameraWorldPosition=new Vector3,this.rotationMatrix=new Matrix4,this.lookAtPosition=new Vector3(0,0,-1),this.clipPlane=new Vector4,this.textureMatrix=new Matrix4,this.mirrorCamera=this._camera.clone(),this.renderTarget=new RenderTarget(this.width,this.height,{minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:options.format||Texture.RGBFormat}),this.viewVec=new Vector3,this.targetVec=new Vector3,this.q=new Quaternion,this.updateTextureMatrix()}updateTextureMatrix(){this.updateMatrixWorld(),this._camera.updateMatrixWorld(),this.mirrorWorldPosition.setFromMatrixPosition(this.matrixWorld),this.cameraWorldPosition.setFromMatrixPosition(this._camera.matrixWorld),this.rotationMatrix.extractRotation(this.matrixWorld),this.normal.set(0,0,1),this.normal.applyMatrix4(this.rotationMatrix),this.viewVec.copy(this.mirrorWorldPosition).sub(this.cameraWorldPosition),this.viewVec.reflect(this.normal).negate(),this.viewVec.add(this.mirrorWorldPosition),this.rotationMatrix.extractRotation(this._camera.matrixWorld),this.lookAtPosition.set(0,0,-1),this.lookAtPosition.applyMatrix4(this.rotationMatrix),this.lookAtPosition.add(this.cameraWorldPosition),this.targetVec.copy(this.mirrorWorldPosition).sub(this.lookAtPosition),this.targetVec.reflect(this.normal).negate(),this.targetVec.add(this.mirrorWorldPosition),this.up.set(0,-1,0),this.up.applyMatrix4(this.rotationMatrix),this.up.reflect(this.normal).negate(),this.mirrorCamera.position.copy(this.viewVec),this.mirrorCamera.up=this.up,this.mirrorCamera.lookAt(this.targetVec),this.mirrorCamera.updateMatrixWorld(),this.mirrorCamera.projectionMatrix.copy(this._camera.projectionMatrix),this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.mirrorCamera.projectionMatrix),this.textureMatrix.multiply(this.mirrorCamera.matrixWorldInverse),this.mirrorPlane.setFromNormalAndCoplanarPoint(this.normal,this.mirrorWorldPosition),this.mirrorPlane.applyMatrix4(this.mirrorCamera.matrixWorldInverse),this.clipPlane.set(this.mirrorPlane.normal.x,this.mirrorPlane.normal.y,this.mirrorPlane.normal.z,this.mirrorPlane.constant);let projectionMatrix=this.mirrorCamera.projectionMatrix,q=this.q;q.x=(Math.sign(this.clipPlane.x)+projectionMatrix.elements[8])/projectionMatrix.elements[0],q.y=(Math.sign(this.clipPlane.y)+projectionMatrix.elements[9])/projectionMatrix.elements[5],q.z=-1,q.w=(1+projectionMatrix.elements[10])/projectionMatrix.elements[14];let c=this.clipPlane.multiplyScalar(2/this.clipPlane.dot(q));projectionMatrix.elements[2]=c.x,projectionMatrix.elements[6]=c.y,projectionMatrix.elements[10]=c.z+1-this.clipBias,projectionMatrix.elements[14]=c.w}render(scene){this.updateTextureMatrix(),this.renderer.render(scene,this.mirrorCamera,this.renderTarget)}destroy(){this.renderTarget.destroy()}set camera(c){this._camera=c,this.mirrorCamera=c.clone()}}Class((function MouseFlowMap({size:size=512,radius:radius=.15,falloff:falloff=1,speed:speed=0,velocity:velocity=!0,autoStart:autoStart=!0,hitMesh:hitMesh,numStamps:numStamps=4,stampAlpha:stampAlpha=1,decay:decay=.93,fps:fps=60,multitouch:multitouch=!1,hideMouse:hideMouse=!1,autoFade:autoFade=!1,interaction:interaction=null,stage:stage=Stage}={}){Inherit(this,MouseFlowMapRenderer,size);const _this=this;let _stampShader;const _stamps=[],_stampPos=new Vector2;var _interaction=interaction,_touches=[],_touchMap={},_mouse=Device.mobile&&multitouch||hideMouse?null:new MouseFlowMapTouch;function draw(touch){touch.render(decay,numStamps),velocity&&_stampShader.uniforms.uVelocity.value.copy(touch.velocity),(touch!=_mouse||Mouse.velocity.length()>.05)&&!_this.disabled?(_stampPos.copy(touch.pos),_stamps.forEach(stamp=>{_stampPos.add(touch.step),stamp.position.x=_stampPos.x,stamp.position.y=_stampPos.y})):_stamps.forEach(stamp=>stamp.position.x=9999999),touch.ticks<5?touch.ticks++:_this.draw()}function loop(){_stampShader.set("uAspect",stage.width/stage.height),_mouse&&(mouseMove(Mouse),draw(_mouse));for(let i=0;i<_touches.length;i++){let touch=_touches[i];touch.disabled||draw(touch)}_this.clear()}function addHandlers(){multitouch&&(window.addEventListener("touchstart",touchStart,{passive:!1}),window.addEventListener("touchmove",touchMove,{passive:!1}),window.addEventListener("touchend",touchEnd,{passive:!1})),hideMouse||hitMesh||(window.addEventListener("mousedown",mouseStart),window.addEventListener("touchmove",mouseMove),window.addEventListener("mouseup",mouseEnd)),document.body.addEventListener("mouseleave",out,!1),_interaction&&_interaction.add([hitMesh],null,null,hitMeshMove)}function mouseStart(e){_this.isDragging=!0}function touchStart(e){e.preventDefault&&e.preventDefault();for(let i=0;i<e.changedTouches.length;i++){let touch=e.changedTouches[i];_touchMap[touch.identifier]=new MouseFlowMapTouch,_touches.push(_touchMap[touch.identifier])}}function mouseEnd(e){defer(()=>{_this.isDragging=!1,(e.x<0||e.y<0||e.x>Stage.width||e.y>Stage.width)&&(_mouse.isMouseLeft=!0)})}function touchEnd(e){for(let i=0;i<e.changedTouches.length;i++){let touch=e.changedTouches[i];_touches.remove(_touchMap[touch.identifier]),delete _touchMap[touch.identifier]}}function out(e){e.toElement||_this.isDragging||(_this.isMouseLeft=!0)}function mouseMove(e){_mouse&&_mouse.move(Mouse)}function touchMove(e){e.preventDefault&&e.preventDefault();for(let i=0;i<e.touches.length;i++){let touch=e.touches[i];touch.x=touch.pageX,touch.y=touch.pageY,_touchMap[touch.identifier]&&_touchMap[touch.identifier].move(touch)}}function hitMeshMove(e){_mouse&&_mouse.move(e.hit.uv,!0)}this.disabled=!1,this.touches=_touches,function initPass(){_this.setShader(_this.initClass(Shader,"MouseFlowMapBlend",{uStamp:{value:_this.rt.texture},uSpeed:{value:Math.pow(Math.clamp(speed,0,1),3)},uTexture:{value:null},uFirstDraw:{value:1}}))}(),function initStamps(){let geometry=new PlaneGeometry(1,1);_stampShader=_this.initClass(Shader,"MouseFlowMapStamp",{uVelocity:{value:new Vector2(1,1)},uFalloff:{value:Math.clamp(falloff,0,1)},uAlpha:{value:Math.clamp(stampAlpha,0,1)},uAspect:{value:stage.width/stage.height},transparent:!0,depthWrite:!1,depthTest:!1});for(let i=0;i<numStamps;i++){let stamp=new Mesh(geometry,_stampShader);stamp.frustumCulled=!1,stamp.scale.setScalar(radius),_this.add(stamp),_stamps.push(stamp)}}(),addHandlers(),autoStart&&defer(()=>_this.start()),this.start=function(){_this.isStarted||(_this.isStarted=!0,addHandlers(),_this.startRender(loop,fps))},this.stop=function(){_this.isStarted&&(_this.isStarted=!1,function removeHandlers(){window.removeEventListener("touchstart",touchStart),window.removeEventListener("mousedown",mouseStart),window.removeEventListener("touchmove",touchMove),window.removeEventListener("mouseup",mouseEnd),window.removeEventListener("touchend",touchEnd),document.body.removeEventListener("mouseleave",out,!1),_interaction&&_interaction.remove([hitMesh])}(),_this.stopRender(loop))},this.render=function(){loop()}})),Class((function MouseFlowMapRenderer(_size){Inherit(this,Component);const _this=this;let _shader;const _scene1=new Scene,_scene2=new Scene,_camera=new OrthographicCamera(0,1,1,0,.1,2);let _count=0;const _rtPing=Utils3D.createRT(_size,_size),_rtPong=Utils3D.createRT(_size,_size);this.rt=Utils3D.createRT(_size,_size,null,Texture.RGBAFormat),this.textureUniform={type:"t",value:null,ignoreUIL:!0},function init(){_camera.position.z=1}(),_scene1.disableAutoSort=!0,_scene2.disableAutoSort=!0,this.add=function(mesh){_scene1.add(mesh)},this.setShader=function(shader){_shader=shader;let mesh=new Mesh(World.QUAD,shader);_scene2.add(mesh)},this.draw=function(){if(!_shader)return;let autoClear=World.RENDERER.autoClear;World.RENDERER.autoClear=!1,World.RENDERER.renderSingle(_scene1.children[0],_camera,_this.rt),World.RENDERER.autoClear=autoClear,_this.textureUniform.value=_this.rt.texture},this.clear=function(){if(!_shader)return;_count++;const clearAlphaCache=Renderer.CLEAR[3];Renderer.CLEAR[3]=0,_count%2==0?(_shader.uniforms.uTexture.value=_rtPing.texture,World.RENDERER.renderSingle(_scene2.children[0],_camera,_rtPong),_this.textureUniform.value=_rtPong.texture):(_shader.uniforms.uTexture.value=_rtPong.texture,World.RENDERER.renderSingle(_scene2.children[0],_camera,_rtPing),_this.textureUniform.value=_rtPing.texture),_shader.uniforms.uFirstDraw.value=0,Renderer.CLEAR[3]=clearAlphaCache,Renderer.context.bindFramebuffer(Renderer.context.FRAMEBUFFER,_this.rt._gl),Renderer.context.clear(Renderer.context.COLOR_BUFFER_BIT),Renderer.context.bindFramebuffer(Renderer.context.FRAMEBUFFER,null)},this.upload=async function(){let uploads=[_rtPing,_rtPong,_this.rt];_shader&&uploads.push(_shader);for(let i=0;i<uploads.length;i++)uploads[i].upload(),await defer()}})),Class((function MouseFlowMapTouch(){Inherit(this,Component);const _this=this;new Vector2;var _touch=new Vector2,_touchLast=new Vector2,_touchStep=new Vector2,_velocity=new Vector2,_current=new Vector2,_delta={x:0,y:0},_last=new Vector2;this.velocity=new Vector2,this.ticks=0,this.render=function(decay,numStamps){_velocity.multiplyScalar(decay),_this.velocity.lerp(_velocity,.5),_touch.lerp(_current,.4),_touchStep.copy(_touch).sub(_touchLast).multiplyScalar(1/numStamps),_touchLast.copy(_touch)},this.move=function(e,hitMesh){_this.isMouseLeft&&(_this.isMouseLeft=!1,_touch.copy(Mouse.inverseNormal),_touchLast.copy(_touch)),e.x!=_last.x&&(hitMesh?(_current.x=e.x,_current.y=e.y):(_current.x=e.x/Stage.width,_current.y=1-e.y/Stage.height),_delta.x=e.x-_last.x,_delta.y=e.y-_last.y,_last.x=e.x,_last.y=e.y,_velocity.copy(_delta).multiplyScalar(.03/16))},this.get("step",_=>_touchStep),this.get("pos",_=>_touch)})),Mobile.Class((function BaseModule(){Inherit(this,Component);var _name,_this=this,_callbacks={};function prune(){let now=Date.now();for(let key in _callbacks)_callbacks[key].time&&now-_callbacks.time>1e4&&delete _callbacks[key]}_name=_this.constructor.toString().match(/function ([^\(]+)/)[1],Mobile.NativeCore.register(_name,_this),defer(()=>{_this.flag("initialized")||_this.send("init"),setInterval(prune,5e3)}),this.init=function(bool){if(_this.flag("initialized",!0),0!=bool)return _this.send("init")},this.send=function(fn,data={},callback){let promise=Promise.create();if("object"==typeof fn&&(callback=data,fn=(data=fn).fn),"function"!=typeof data&&"boolean"!=typeof data||(callback=data,data={}),callback&&promise.then(callback),!_name)throw"Must call init on module before sending data";return data._id=Utils.timestamp(),data.fn=fn,data.nativeModule=_name,promise.time=Date.now(),_callbacks[data._id]=promise,Mobile.NativeCore.send(data),promise},this.receive=function(data){var id=data._id,callback=_callbacks[id];callback?(callback.resolve?callback.resolve(data):callback(data),delete _callbacks[id]):_this.incoming(data)},this.incoming=function(){}})),Mobile.Class((function NativeCore(){Inherit(this,Component);var _api,_this=this,_references={};this.active=!1,function initAPI(){window.nativeHydra&&(_api=window.nativeHydra),window.webkit&&window.webkit.messageHandlers&&(_api=window.webkit.messageHandlers.nativeHydra),_api&&(_this.active=!0)}(),this.send=function(data){this.active&&(data=JSON.stringify(data),_api&&_api&&_api.postMessage&&_api.postMessage(data))},this.receive=function(data){data.jsModule&&_references[data.jsModule].receive(data)},this.register=function(name,ref){_references[name]=ref}}),"Static"),Mobile.Class((function NativeServiceWorker(){Inherit(this,Component);const _this=this;var _offlineQueue=[];function safe(cmd={}){return"string"!=typeof cmd&&(cmd=JSON.stringify(cmd)),cmd=(cmd=(cmd=(cmd=(cmd=(cmd=(cmd=(cmd=(cmd=(cmd=(cmd=cmd.replace(/:/g,"")).replace(/-/g,"")).replace(/_/g,"")).replace(/\//g,"")).replace(/&/g,"")).replace(/{/g,"")).replace(/}/g,"")).replace(/\./g,"")).replace(/"/g,"")).replace(/\?/g,"")).replace(/ /g,"")}function override(fn){const _fn=window[fn];window[fn]=function(url,body,options){"get"==fn&&(options=body,body=null);let cacheOffline=options&&options.cacheOffline;if(options&&delete options.cacheOffline,Mobile.System.CONNECTIVITY&&!cacheOffline||!url.includes("http")||function isLANRequest(url){return url.includes(["local","192.168","10.0"])}(url))return"get"==fn?_fn(url,options):_fn(url,body,options);let promise=Promise.create(),fileName=`${safe(url)}_${safe(options)}.json`;if(Mobile.System.CONNECTIVITY){("get"==fn?_fn(url,options):_fn(url,body,options)).then(data=>{Mobile.Files.write(fileName,data),promise.resolve(data)}).catch(e=>promise.reject(e))}else!Mobile.System.CONNECTIVITY&&cacheOffline&&"post"==fn?(cacheOffline&&(options.cacheOffline=!0),_offlineQueue.push({url:url,body:body,options:options}),promise.resolve("PENDING"),Mobile.Storage.set("sw_offline_queue",_offlineQueue)):Mobile.Files.read(fileName).then(data=>{data?promise.resolve(data):promise.reject("OFFLINE")});return promise}}function addListeners(){Mobile.Storage.get("sw_offline_queue",q=>{q&&(_offlineQueue=q),Mobile.System.CONNECTIVITY&&_offlineQueue.length&&connectivity({connected:!0})}),_this.events.sub(Mobile.Events.INTERNET_STATUS,connectivity)}function connectivity(e){e.connected&&(_offlineQueue.forEach(obj=>{post(obj.url,obj.body,obj.options)}),_offlineQueue.length=0,Mobile.Storage.set("sw_offline_queue",_offlineQueue))}Mobile.NativeCore.active&&(override("get"),override("post"),Hydra.ready(addListeners))}),"static"),Mobile.Class((function Events(){this.ACTIVE_STATUS="mobile_active_status",this.RESIGN_ACTIVE="mobile_resign_active",this.NOTIFICATION="mobile_notification",this.DEEPLINK="mobile_deeplink",this.INTERNET_STATUS="mobile_internet_status",this.GEOLOCATION_STATUS="mobile_geo_status",this.GEOLOCATION_AUTH="mobile_geo_auth",this.GEOLOCATION_ERROR="mobile_geo_error",this.GEOLOCATION_UPDATE="mobile_geo_update",this.GEOLOCATION_HEADING="mobile_geo_heading"}),"Static"),Mobile.Class((function Fetch(){Inherit(this,Mobile.BaseModule);var _this=this;_this.init(!window.AURA),location.protocol.includes("file")&&!window.AURA&&"ios"==Device.system.os&&function iOSPolyfill(){window.fetch=function(url,options){options=options||{};const promise=Promise.create(),method=(options.method||"get").toUpperCase(),body=options.body||"",contentType=options.headers&&options.headers["content-type"]||"text/plain";function response(responseText){let header,keys=[],all=[],headers={};return"".replace(/^(.*?):\s*([\s\S]*?)$/gm,(m,key,value)=>{keys.push(key=key.toLowerCase()),all.push([key,value]),header=headers[key],headers[key]=header?`${header},${value}`:value}),{ok:1,status:200,statusText:"OK",url:url,clone:response,text:()=>Promise.resolve(responseText),json:()=>Promise.resolve(responseText).then(JSON.parse),xml:()=>Promise.resolve("XML NOT SUPPORTED"),blob:()=>Promise.resolve(new Blob([responseText])),headers:{keys:()=>keys,entries:()=>all,get:n=>headers[n.toLowerCase()],has:n=>n.toLowerCase()in headers}}}return location.protocol.includes("http")&&(url=location.href+url),url.includes("?")&&(url=url.split("?")[0]),_this.send("exec",{url:url,method:method,body:body,contentType:contentType},e=>{e.error?promise.error():promise.resolve(response(e.data))}),promise}}()}),"static"),Mobile.Class((function Files(){Inherit(this,Mobile.BaseModule);var _this=this,_downloaders={};_this.init(),this.write=function(file,content,callback){let promise=Promise.create();return callback||(callback=promise.resolve),"string"!=typeof content&&(content=JSON.stringify(content)),this.send("writeFile",{file:file,content:content},(function(data){callback&&callback(data.success)})),promise},this.read=function(file,callback){let promise=Promise.create();return callback||(callback=promise.resolve),this.send("readFile",{file:file},(function(data){try{data.content&&file.includes("json")&&(data.content=JSON.parse(data.content))}catch(e){}callback(data.content)})),promise},this.unlink=function(file,callback){let promise=Promise.create();return callback||(callback=promise.resolve),this.send("deleteFile",{file:file},(function(data){callback&&callback(data.success)})),promise},this.getPath=function(file,callback){let promise=Promise.create();return callback||(callback=promise.resolve),this.send("getPath",{file:file},(function(data){callback(data.path)})),promise},this.download=function(url,path=""){let downloader=new function Downloader(){Inherit(this,Component);let dir=path.split("/"),name=dir.pop();dir=dir.join("/"),this.id=Utils.timestamp(),_this.send("downloadFile",{url:url,path:path,dir:dir,name:name,id:this.id})};return _downloaders[downloader.id]=downloader,downloader},this.incoming=function(e){switch(e.fn){case"downloadComplete":_downloaders[e.id].events.fire(Events.COMPLETE,null,!0),delete _downloaders[e.id];break;case"downloadProgress":_downloaders[e.id].events.fire(Events.PROGRESS,Number(e.percent)/100,!0)}}}),"Static"),Mobile.Class((function Geolocation(){Inherit(this,Mobile.BaseModule);var _this=this;function getLastLocation(){_this.send("getLastLocation",data=>{data.error||(_this.COORDS.latitude=data.lat,_this.COORDS.longitude=data.lng,_this.events.fire(Mobile.Events.GEOLOCATION_UPDATE,_this.COORDS))})}function handlePermission(e){_this.ACTIVE="ALLOWED"==e.status,_this.TYPE=e.type}this.COORDS={},this.HEADING={magnetic:0,trueHeading:0},this.BEST="ACCURACY_BEST",this.BEST_NAV="ACCURACY_BEST_NAV",this.NEAREST_TEN="ACCURACY_NEAREST_TEN",this.HUNDRED="ACCURACY_HUNDRED",this.KILOMETER="ACCURACY_KILOMETER",this.THREE_KILOMETER="ACCURACY_THREE_KILOMETER",getLastLocation(),this.set("accuracy",(function(val){if(!val)throw"Accuracy not defined!";this.send("setAccuracy",{accuracy:val||"ACCURACY_BEST"})})),this.set("distanceFilter",distance=>{this.send("setDistanceFilter",{distance:distance})}),this.activate=function(always){this.send("activate",{always:!!always})},this.requestPermission=function(always){this.send("requestPermission",{always:!!always})},this.stop=function(){this.send("stop")},this.activateHeading=function(){this.send("activateHeading")},this.stopHeading=function(){this.send("stopHeading")},this.requestLocation=function(){getLastLocation(),this.send("requestLocation")},this.checkPermission=function(callback){let promise=Promise.create();return callback||(callback=promise.resolve),this.send("permission",(function(data){handlePermission(data),callback&&callback({type:data.type,enabled:"ALLOWED"==data.status})})),promise},this.incoming=function(e){switch(e.fn){case"status":!function handleStatus(e){_this.events.fire(Mobile.Events.GEOLOCATION_STATUS,{type:e.locationStatus})}(e);break;case"authorization":!function handleAuth(e){_this.ACTIVE="ALLOWED"==e.status,_this.events.fire(Mobile.Events.GEOLOCATION_AUTH,{status:e.status})}(e);break;case"failError":!function handleError(e){_this.events.fire(Mobile.Events.GEOLOCATION_ERROR)}();break;case"permission":handlePermission(e);break;case"update":!function handleUpdate(e){_this.COORDS.latitude=e.lat,_this.COORDS.longitude=e.lng,_this.COORDS.altitude=e.altitude,_this.events.fire(Mobile.Events.GEOLOCATION_UPDATE,_this.COORDS)}(e);break;case"updateHeading":!function handleUpdateHeading(e){_this.HEADING.magnetic=e.magneticHeading,_this.HEADING.trueHeading=e.trueHeading,_this.events.fire(Mobile.Events.GEOLOCATION_HEADING,_this.HEADING)}(e)}}}),"static"),Mobile.Class((function Social(){Inherit(this,Mobile.BaseModule),this.init(),this.sharePrompt=function(text,url,callback){let promise=Promise.create();return callback||(callback=promise.resolve),this.send("prompt",{text:text,url:url},callback),promise},this.shareMail=function(params,callback){let promise=Promise.create();return callback||(callback=promise.resolve),(params=params||{}).subject||(params.subject=""),params.body||(params.body=""),this.send("email",{params:params},callback),promise}}),"Static"),Mobile.Class((function Storage(){Inherit(this,Mobile.BaseModule);this.set=function(key,value){Mobile.NativeCore.active?this.send("set",{key:key,value:JSON.stringify(value)}):window.Storage.set(key,value)},this.get=function(key,callback){let promise=Promise.create();return callback&&promise.then(callback),Mobile.NativeCore.active?this.send("get",{key:key},data=>{promise.resolve(JSON.parse(data.data))}):promise.resolve(window.Storage.get(key)),promise},Mobile.NativeCore.active&&(window.Storage=this)}),"static"),Mobile.Class((function System(){Inherit(this,Mobile.BaseModule);var _this=this,_reachable={fn:"reachability"};function domReady(){_this.send({fn:"domReady"}),Device.mobile.native||"boolean"!=typeof navigator.onLine||(window.addEventListener("online",progressiveOffline),window.addEventListener("offline",progressiveOffline))}function checkConnection(){_this.send(_reachable,connectionStatus),setTimeout(checkConnection,2e3)}function deactivate(){_this.events.fire(Mobile.Events.ACTIVE_STATUS,{type:"inactive"}),_this.background=!0}function connectionStatus(e){let connectivity=_this.CONNECTIVITY;_this.CONNECTIVITY=e.reachable,connectivity&&!e.reachable?_this.events.fire(Mobile.Events.INTERNET_STATUS,{connected:!1}):e.reachable&&!connectivity&&_this.events.fire(Mobile.Events.INTERNET_STATUS,{connected:!0})}function progressiveOffline(){var reachable=navigator.onLine;_this.CONNECTIVITY=reachable,_this.CONNECTIVITY&&!reachable?_this.events.fire(Mobile.Events.INTERNET_STATUS,{connected:!1}):reachable&&!_this.CONNECTIVITY&&_this.events.fire(Mobile.Events.INTERNET_STATUS,{connected:!0})}this.ANY=0,this.LANDSCAPE=1,this.PORTRAIT=2,this.DARK_STATUS=0,this.LIGHT_STATUS=1,this.CONNECTIVITY="boolean"!=typeof navigator.onLine||navigator.onLine,this.background=!1,_this.init(),function updateNative(){Mobile.NativeCore.active&&(window.open=function(url,target){_this.send({fn:"openURL",params:url})})}(),checkConnection(),Hydra.ready(domReady),this.set("hideStatusBar",(function(bool){this.send("toggleStatusBar",{params:!bool})})),this.set("statusBarColor",(function(c){this.send("statusBarColor",{params:"iOS"==Mobile.os?function hexToInt(rrggbb){var bbggrr=rrggbb.substr(4,2)+rrggbb.substr(2,2)+rrggbb.substr(0,2);return parseInt(bbggrr,16)}(c):c})})),this.set("statusBarText",(function(val){if("number"!=typeof val)throw"Mobile.System.statusBarText must be a number";this.send("statusBarText",{params:val})})),this.set("orientation",(function(val){this.send("orientation",{params:val})})),this.incoming=function(data){switch(data.fn){case"deviceInfo":!function deviceInfo(data){for(var i in delete data.jsModule,delete data.fn,data)_this[i]=data[i]}(data);break;case"appActive":!function activate(){_this.events.fire(Mobile.Events.ACTIVE_STATUS,{type:"active"}),_this.background=!1}();break;case"appInBackground":case"appTerminating":case"appResignActive":deactivate();break;case"_error":throw data.message}},this.vibrate=function(time){this.send("vibrate",{params:time})},this.hideKeyboard=function(){this.send("hideKeyboard")},this.detectDevice=function(str){return!!_this.model&&(_this.model.toLowerCase().includes(str)||_this.name.toLowerCase().includes(str))},this.openSettings=function(){this.send("openSettings")},this.getHardwareStatus=async function(){let data=await this.send("getHardwareStatus");return delete data._id,delete data.jsModule,data}}),"Static"),Class((function ParticleDistributor(){Inherit(this,Component);var _initialized;function distributeParticles(e,id){let{position:position,count:count}=e,vertices=position.length/3,v3=new Vector3,output=new Float32Array(3*count);for(let i=0;i<count;i++){let j=3*Math.random(0,vertices/3);v3.set(Math.random(0,100),Math.random(0,100),Math.random(0,100));let m=1/(v3.x+v3.y+v3.z);v3.set(v3.x*m,v3.y*m,v3.z*m),output[3*i+0]=position[3*j+0]*v3.x+position[3*j+3]*v3.y+position[3*j+6]*v3.z,output[3*i+1]=position[3*j+1]*v3.x+position[3*j+4]*v3.y+position[3*j+7]*v3.z,output[3*i+2]=position[3*j+2]*v3.x+position[3*j+5]*v3.y+position[3*j+8]*v3.z}resolve({output:output},id,[output.buffer])}this.generate=async function(geom,count){_initialized||(_initialized=!0,Thread.upload(distributeParticles));let position=new Float32Array(geom.attributes.position.array);return(await Thread.shared().distributeParticles({transfer:!0,msg:{position:position,count:count,buffer:[position.buffer]}})).output}}),"static"),Class((function PBRShader(_vertexShader,_fragmentShader,_params){const _this=this;function defineSetter(prop){Object.defineProperty(_this,prop,{set:function(v){_this.shader[prop]=v},get:function(){return _this.shader[prop]}})}"object"==typeof _vertexShader&&(_params=_vertexShader,_vertexShader=_fragmentShader="PBR"),"object"==typeof _fragmentShader&&(_params=_fragmentShader,_fragmentShader=_vertexShader),_vertexShader||(_vertexShader=_fragmentShader="PBR"),function initShader(){let lookup=Utils3D.getLookupTexture("assets/images/pbr/lut.png");lookup.forcePersist=!0,_this.shader=new Shader(_vertexShader,_fragmentShader,Utils.mergeObject(_params||{},{tBaseColor:{value:null,getTexture:Utils3D.getRepeatTexture},tMRO:{value:null,getTexture:Utils3D.getRepeatTexture},tNormal:{value:null,getTexture:Utils3D.getRepeatTexture},tEnvDiffuse:{value:null,premultiplyAlpha:!1},tEnvSpecular:{value:null,premultiplyAlpha:!1},uMRO:{value:new Vector3(1,1,1)},uHDR:{value:0,ignoreUIL:!0},uNormalScale:{value:new Vector2(1,1)},tLUT:{value:lookup,ignoreUIL:!0},uEnv:{value:new Vector2(1,0)},uLight:{value:new Vector4(1,1,1,1)},receiveLight:!0})),_this.lights=_this.shader.lights,_this.uniforms=_this.shader.uniforms,["side","blending","polygonOffset","polygonOffsetFactor","polygonOffsetUnits","receiveShadow","vertexShader","fragmentShader","depthTest","depthWrite","wireframe","transparent","visible","persists","material","customShadowShader"].forEach(defineSetter)}()}),_=>{const prototype=PBRShader.prototype;prototype.set=function(key,value){return void 0!==value&&(this.shader.uniforms[key].value=value),this.shader.uniforms[key].value},prototype.get=function(key){return this.shader.uniforms[key].value},prototype.tween=function(key,value,time,ease,delay,callback,update){return tween(this.shader.uniforms[key],{value:value},time,ease,delay,callback,update)},prototype.setPBR=prototype.setOverride=function(key,value,src){switch(this.set(key,value),key){case"tEnvDiffuse":case"tEnvSpecular":case"tLUT":value.generateMipmaps=!1,value.minFilter=Texture.LINEAR}value.wrapS=value.wrapT=Texture.REPEAT,src||(src=value.src),src&&src.toLowerCase().includes("rgbm")&&this.shader.set("uHDR",1)},prototype.destroy=function(){this.shader.destroy()},prototype.copyUniformsTo=function(shader,linked){for(let key in this.uniforms)shader.uniforms[key]=linked?this.uniforms[key]:{type:this.uniforms[key].type,value:this.uniforms[key].value}},prototype.addUniforms=function(uniforms){uniforms.UILPrefix&&(this.UILPrefix=uniforms.UILPrefix,delete uniforms.UILPrefix);for(let key in uniforms)this.uniforms[key]=uniforms[key]}}),Class((function Performance(){Inherit(this,Component);var _overrides=Storage.get("performance_override")||{};function save(key,value){_overrides[key]=value,Storage.set("performance_override",_overrides)}function convert(tier){if(GPU.BLACKLIST)return"F";switch(tier){case 5:return"A++";case 4:return"A+";case 3:return"A";case 2:return"B";case 1:return"C";case 0:return"D"}}!async function(){if(Utils.query("performance")&&Utils.query("edit")||Utils.query("custom")){await Hydra.ready();for(let key in _overrides)Tests[key]=_=>_overrides[key]}}(),this.displayResults=async function(){let editing=Utils.query("edit");await GPU.ready(),__body.bg("#000");let $results=__body.create("PerformanceResults");__body.css({overflowY:"scroll"}),$results.fontStyle("Arial",18,"#fff").css({marginLeft:50,marginRight:50,"user-select":"auto",paddingBottom:60}),Mobile.allowNativeScroll(),CSS.style(".PerformanceResults *",{position:"relative","user-select":"auto"});Tests.constructor.toString();let tests="";for(let key in Tests){let result=Tests[key]();tests+=`<p><b>${key}:</b> `,editing?("number"==typeof result&&(tests+=`<input class="${key}" value="${result.toString()}" /></p>`),"boolean"==typeof result&&(tests+=`<input class="${key}" type="checkbox" ${result?"checked":""}/></p>`)):tests+=result+"</p>"}let html=`<h1>Performance Results</h1>\n                    <p><b>GPU:</b> ${Device.graphics.webgl?Device.graphics.webgl.gpu:"WEBGL UNAVAILABLE"}</p>\n                    <p><b>WebGL Version:</b> ${Device.graphics.webgl?Device.graphics.webgl.version:"WEBGL UNAVAILABLE"}</p>\n                    <p><b>GPU Tier:</b> ${Device.mobile?convert(GPU.M_TIER):convert(GPU.TIER)} [${Device.mobile?GPU.M_TIER:GPU.TIER}]</p>\n                    <p><b>Mobile:</b> ${JSON.stringify(Device.mobile).split(":").join(": ")}</p>\n                    <p><b>System:</b> ${JSON.stringify(Device.system).split(":").join(": ")}</p>\n                    <p><b>User Agent:</b> ${Device.agent}</p>\n                    <p><b>DPR:</b> ${Device.pixelRatio}</p>\n                    <p><b>Screen Size:</b> ${screen.width} x ${screen.height}</p>\n                    <p><b>Stage Size:</b> ${Stage.width} x ${Stage.height}</p>\n                    \n                    <h2>Project-Specific Tests</h2>\n                    ${editing?'<button class="resetBtn">Reset All</button>':""}\n                    ${tests}\n        `;if($results.html(html),editing){await defer(),document.querySelector(".resetBtn").onclick=_=>{Storage.set("performance_override",null),location.reload()};for(let key in Tests){!function(div,key){div.onchange=_=>{let value=div.value;value=isNaN(value)?div.checked:Number(value),save(key,value)}}(document.querySelector(`.${key}`),key)}}if(!editing&&Device.mobile){let $copy=$(document.createElement("button"));$copy.size("100%",60).bg("#fff").css({position:"fixed",bottom:0,left:0,right:0}).setZ(99999999),$copy.text("Copy to Clipboard"),__body.add($copy),$copy.interact(null,_=>{Utils.copyToClipboard($results.div.innerText)&&$copy.text("Copied to Clipboard")})}}}),"static"),Class((function PhysicalLink(_id){const _this=this;var _events={},_globalLinks=[],_globalEvents=[];this.initLink=function(id){_id=id,PhysicalSync.createInstanceLink(_this,id)},this.bindLink=function(obj,id){if(obj instanceof GLUIObject){let gluiObject=obj;obj=new Group,_this.startRender(_=>{let stage=_this.stage||Stage;_id?(gluiObject.x=obj.position.x*stage.width,gluiObject.y=obj.position.y*stage.height):(obj.position.x=gluiObject.x/stage.width,obj.position.y=gluiObject.y/stage.height)})}_id?PhysicalSync.createRemoteLink(obj,_id,id):PhysicalSync.createLocalLink(obj,id)},this.bindEvent=function(name,callback){_events[name]=callback,PhysicalSync.createRemoteEvent(name,_id,callback)},this.bindGlobal=function(obj,id){PhysicalSync.createGlobalLink(obj,id),_globalLinks.push(id)},this.bindGlobalEvent=function(name,callback){PhysicalSync.createGlobalEvent(name,callback),_globalEvents.push(name)},this.fireEvent=function(name,data={}){PhysicalSync.fireLocalEvent(name,data),_events[name]&&_events[name](data)},this.destroyLink=function(){PhysicalSync.deleteInstanceLink(_id),_globalLinks.forEach(id=>PhysicalSync.deleteGlobalLink(id)),_globalEvents.forEach(id=>PhysicalSync.deleteGlobalEvent(id))},defer(_=>{_this&&_this._bindOnDestroy&&_this._bindOnDestroy(_=>{_this.destroyLink()})}),_id&&_this.initLink(_id)})),Class((function PhysicalSync(){Inherit(this,Component);const _this=this;var _room,_playerQueue,_matrix=new Matrix4,_instances={},_instanceBackup={},_objects={},_global={},_globalEvents={},_eventMap={},_events=[],_transmit={},_globalTransmit={},_handledEvents={},_receivedGlobals=[],_evt={physicalSync:"transmit_data",events:[]};function startSync(){_room.host&&_room.broadcast({physicalSync:"perform_sync",pos:World.CAMERA.position.toArray(),quaternion:World.CAMERA.quaternion.toArray()})}function optimize(obj){for(let i=0;i<3;i++)obj.p[i]=Number(obj.p[i].toFixed(3));for(let i=0;i<4;i++)obj.q[i]=Number(obj.q[i].toFixed(3))}function shouldHandle(event){return!_handledEvents[event.id]&&(_handledEvents[event.id]=!0,_this.delayedCall(_=>{delete _handledEvents[event.id]},1e3),!0)}function transmit(){if(_objects.local&&_room){for(let key in _objects.local){let obj=_objects.local[key];obj.preventSync?_transmit[key]&&delete _transmit[key]:(_transmit[key]||(_transmit[key]={p:[],q:[]}),_objects.local[key].position.toArray(_transmit[key].p),_objects.local[key].quaternion.toArray(_transmit[key].q),optimize(_transmit[key]),obj.extraData&&(_transmit[key].extraData||(_transmit[key].extraData=obj.extraData)))}for(let key in _global){let obj=_global[key];obj.broadcastSync||obj.forceBroadcastSync?(_globalTransmit[key]||(_globalTransmit[key]={p:[],q:[],f:obj.forceBroadcastSync}),obj.position.toArray(_globalTransmit[key].p),obj.quaternion.toArray(_globalTransmit[key].q),optimize(_globalTransmit[key])):_globalTransmit[key]&&delete _globalTransmit[key]}_evt.events.length=0;for(let i=0;i<_events.length;i++){let event=_events[i];Render.TIME-event.time<500?_evt.events.push(event.evt):_events.splice(i,1)}_evt.objects=_transmit,_evt.global=_globalTransmit,_room&&_room.broadcast&&_room.broadcast(_evt)}}function loop(){for(let player in _objects){if("local"==player)continue;let playerObj=_objects[player];for(let key in playerObj){let obj=playerObj[key],lerp=_this.baseLerp*obj.lerpMult;obj.positionTarget&&!obj.preventSync&&(obj.position.lerp(obj.positionTarget,lerp),obj.quaternion.slerp(obj.quaternionTarget,lerp))}}if(_receivedGlobals.length){for(let i=0;i<_receivedGlobals.length;i++){let key=_receivedGlobals[i],obj=_global[key];if(obj.positionTarget&&!obj.preventSync){let lerp=obj.forced?1:_this.baseLerp*obj.lerpMult;obj.position.lerp(obj.positionTarget,lerp),obj.quaternion.slerp(obj.quaternionTarget,lerp)}}_receivedGlobals.length=0}if(_playerQueue.length){for(let i=0;i<10;i++){let obj=_playerQueue.shift();obj&&_this.events.fire(_this.CONNECTION,obj)}}}function handleEvent({evtData:evtData,evtName:evtName,from:from}){let callbacks=_eventMap[from];if(callbacks){let callback=callbacks[evtName];callback&&callback(evtData)}let callback=_globalEvents[evtName];callback&&callback(evtData)}function playerJoin(e){if(_room.isCommunity?_playerQueue.push({id:e.player.id,userData:e.player.data,player:e.player}):_this.events.fire(_this.CONNECTION,{id:e.player.id,userData:e.player.data,player:e.player}),_room.host&&!_room.isCommunity){for(let key in _global)_global[key].forceBroadcastSync=e.player.id;_this.delayedCall(_=>{for(let key in _global)_global[key].forceBroadcastSync=!1},500)}}function playerDisconnect(e){let obj=_instances[e.player.id]||_instanceBackup[e.player.id];obj&&(console.log(obj),_this.events.fire(_this.DISCONNECTION,{id:e.player.id,userData:e.player.data}),obj.onDisconnect?obj.onDisconnect():obj.destroy&&obj.destroy()),delete _instances[e.player.id],delete _instanceBackup[e.player.id],delete _eventMap[e.player.id];for(let i=0;i<_playerQueue.length;i++)_playerQueue[i].player==e.player&&_playerQueue.splice(i,1)}function roomError(){_room&&_room.players&&_room.players.forEach(player=>{playerDisconnect({player:player})})}function data({data:data,player:player}){if(data.physicalSync)switch(data.physicalSync){case"start_sync":startSync();break;case"perform_sync":!function performSync({pos:pos,quaternion:quaternion}){let remotePos=(new Vector3).fromArray(pos),cameraQuat=World.CAMERA.quaternion,cameraPos=World.CAMERA.position,localQuaternion=World.SCENE.quaternion,localScene=World.SCENE.position,orientedRemotePos=((new Quaternion).fromArray(quaternion),(new Vector3).copy(remotePos).applyQuaternion(cameraQuat)),localOrigin=(new Vector3).copy(cameraPos),remoteOrigin=(new Vector3).copy(orientedRemotePos).multiplyScalar(-1);localScene.copy(localOrigin).add(remoteOrigin),localQuaternion.copy(cameraQuat)}(data);break;case"transmit_data":!function transmitData({objects:objects,from:from,global:global,events:events},player){let lerpMultiplier=_this.compensateLag?Math.range(player.ping,50,200,1,.1,!0):1;for(let key in global){let obj=_global[key];obj&&(obj.lerpMult=lerpMultiplier,obj.positionTarget||(obj.positionTarget=new Vector3,obj.quaternionTarget=new Quaternion),global[key].p&&(_receivedGlobals.push(key),global[key].f==GameCenter.GCID&&(obj.physics&&(void 0===obj.physics.stashKinematic&&(obj.physics.stashKinematic=obj.physics.kinematic,obj.physics.kinematic=!0),clearTimeout(obj.physics.timer),obj.physics.timer=_this.delayedCall(_=>{obj.physics.kinematic=obj.physics.stashKinematic},100)),obj.forced=!0),obj.positionTarget.fromArray(global[key].p),obj.quaternionTarget.fromArray(global[key].q),global[key].extraData&&(obj.extraData=global[key].extraData)))}if(_objects[from])for(let key in objects){let obj=_objects[from][key];obj&&(obj.lerpMult=lerpMultiplier,obj.positionTarget||(obj.positionTarget=new Vector3,obj.quaternionTarget=new Quaternion),objects[key].p&&(obj.positionTarget.fromArray(objects[key].p),obj.quaternionTarget.fromArray(objects[key].q)))}if(events)for(let i=events.length-1;i>-1;i--){let event=events[i];shouldHandle(event)&&(event.from=from,handleEvent(event))}}(data,player);break;case"event":handleEvent(data)}}this.CONNECTION="physical_sync_connection",this.DISCONNECTION="physical_sync_disconnection",this.baseLerp=.15,this.transmitFPS=30,this.compensateLag=!0,this.connect=async function(server){GameCenter.ports=this.ports||1,GameCenter.userData=this.userData||{},GameCenter.connect(server);try{_room=await GameCenter.findRoom(),_this.events.sub(_room,GameCenterRoom.PLAYER_JOIN,playerJoin),_this.events.sub(_room,GameCenterRoom.PLAYER_DISCONNECT,playerDisconnect),_this.events.sub(_room,GameCenter.DATA,data)}catch(e){console.error(e)}_room.players.forEach(player=>{player.me||_this.events.fire(_this.CONNECTION,{id:player.id,userData:player.data,player:player})})},this.useRoom=function(room){if(null==room&&_room&&_room.players&&_room.players.forEach(player=>{player.me||playerDisconnect({player:player})}),_room=room,_playerQueue=[],_this.startRender(loop),_room){try{_this.events.sub(_room,GameCenterRoom.PLAYER_JOIN,playerJoin),_this.events.sub(_room,GameCenterRoom.PLAYER_DISCONNECT,playerDisconnect),_this.events.sub(_room,GameCenterRoom.ERROR,roomError),_this.events.sub(_room,GameCenter.DATA,data)}catch(e){console.error(e)}_room.players.forEach(player=>{player.me||(_room.isCommunity?_playerQueue.push({id:player.id,userData:player.data,player:player}):_this.events.fire(_this.CONNECTION,{id:player.id,userData:player.data,player:player}))})}},this.sync=function(){_room.host?startSync():_room.broadcast({physicalSync:"start_sync"})},this.createInstanceLink=function(obj,id){_instances[id]=obj,_instanceBackup[id]=obj},this.deleteInstanceLink=function(id){id&&(delete _instances[id],delete _objects[id],delete _eventMap[id])},this.createLocalLink=function(obj,id){_objects.local||(_objects.local={}),_objects.local[id]=obj,_this.startRender(transmit,_this.transmitFPS)},this.deleteLocalLink=function(id){delete _objects.local[id]},this.createRemoteEvent=function(name,id,callback){_eventMap[id]||(_eventMap[id]={}),_eventMap[id][name]=callback},this.createGlobalEvent=function(id,callback){_globalEvents[id]=callback},this.deleteGlobalEvent=function(id){delete _globalEvents[id]},this.fireLocalEvent=function(name,data={}){_events.push({evt:{evtData:data,evtName:name,id:Utils.uuid()},time:Render.TIME})},this.createGlobalLink=function(obj,id){_global[id]=obj},this.deleteGlobalLink=function(id){delete _global[id]},this.createRemoteLink=function(obj,playerId,id){_objects[playerId]||(_objects[playerId]={}),_objects[playerId][id]=obj,_this.startRender(loop)},this.alignLocally=function(yOffset=0){World.SCENE.quaternion.copy(World.CAMERA.quaternion),World.SCENE.rotation.z=0,World.SCENE.rotation.x=0,World.SCENE.position.copy(World.CAMERA.position),World.SCENE.position.y+=yOffset,World.SCENE.updateMatrixWorld(!0),_matrix.getInverse(World.SCENE.matrix),_this.flag("aligned",!0)},this.realignObject=function(obj){_this.flag("aligned")&&obj.applyMatrix(_matrix)}}),"static"),Class((function Proton(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_size,_antimatter;const prefix=this.prefix=`P_${_input.prefix}`;async function initConfig(){(_config=_this.uilConfig=InputUIL.create(prefix+"_config",_group)).setLabel("Config"),_config.addButton("load-values",{actions:[{title:"Save Values",callback:saveValues}],hideLabel:!0}),_config.addButton("save-values",{actions:[{title:"Load Values",callback:loadValues}],hideLabel:!0}),_config.addButton("save",{actions:[{title:"Save Configuration",callback:saveConfig}],hideLabel:!0}),_config.addButton("load",{actions:[{title:"Load Configuration",callback:loadConfig}],hideLabel:!0}),_config.addButton("load-shader",{actions:[{title:"Load Shader",callback:_=>loadShader()}],hideLabel:!0}),_config.addButton("load-behavior",{actions:[{title:"Load Behavior",callback:_=>loadBehavior()}],hideLabel:!0});_config.addSelect("type",[{label:"Permanent",value:"permanent"},{label:"Lifecycle",value:"lifecycle"}]),_config.add("particleCount",1e3);let output=[{label:"Particles",value:"particles"},{label:"Custom",value:"custom"}];window.ProtonTubes&&output.push({label:"Tubes",value:"tubes"}),_config.addSelect("output",output),_config.add("shader"),_config.get("shader")&&_config.addTextarea("uniforms"),_config.add("class");_config.get("type");try{if(!1===_input.get("visible"))throw"Layer set to invisible";_this.particleCount=_size=getSize(),initAntimatter()}catch(e){console.warn("Proton skipped",e),_this.disabled=!0}}function saveConfig(){let name=prompt("Name of configuration to be saved");UILStorage.setWrite(`proton_config_${name}`,prefix)}function saveValues(){let name=prompt("Name of values to be saved"),store=(shader,to)=>{for(let key in shader.uniforms){if(shader.uniforms[key].ignoreUIL)continue;let uilValue=UILStorage.get(shader.UILPrefix+key);void 0!==uilValue&&(to[key]=uilValue)}},output={behavior:{},shader:{}};store(_this.behavior,output.behavior),store(_this.shader,output.shader),_this.customClass&&_this.customClass.saveValues&&(output.custom={},store(_this.customClass.saveValues(),output.custom)),UILStorage.setWrite(`proton_values_${name}`,JSON.stringify(output))}function loadValues(){let name=prompt("Name of values to be loaded"),data=UILStorage.get(`proton_values_${name}`);data||alert(`No values ${name} found`),data=JSON.parse(data);let apply=(shader,obj)=>{for(let key in obj)UILStorage.set(shader.UILPrefix+key,obj[key])};apply(_this.behavior,data.behavior),apply(_this.shader,data.shader),_this.customClass&&_this.customClass.saveValues&&apply(_this.customClass.saveValues(),data.custom),alert("Values imported. Save and refresh.")}function loadShader(toLoad){let shouldNotify=!toLoad;if(!toLoad){let name=prompt("Name of shader to be loaded");toLoad=UILStorage.get(`proton_config_${name}`)}let copyConfig=InputUIL.create(toLoad+"_config",null);_config.copyFrom(copyConfig,["shader","uniforms"]),(_config.get("uniforms")||"").split("\n").forEach(line=>{if(!line.includes(":"))return;let name=(line=line.replace(/ /g,"")).split(":")[0],shaderName=copyConfig.get("shader"),store=`${shaderName}/${shaderName}/${prefix}/`,lookup=`${shaderName}/${shaderName}/${toLoad}/`,val=UILStorage.get(lookup+name);val?UILStorage.set(store+name,val):(val=UILStorage.get(lookup+"_tx_"+name),val&&UILStorage.set(store+"_tx_"+name,val))}),shouldNotify&&alert("Loaded. Save and refresh")}function loadBehavior(toLoad){let shouldNotify=!toLoad;if(!toLoad){let name=prompt("Name of behavior to be loaded");toLoad=UILStorage.get(`proton_config_${name}`)}let copyConfig=InputUIL.create(toLoad+"_config",null);_config.copyFrom(copyConfig,["type","particleCount","output","class"]);let copyBehavior=InputUIL.create(toLoad+"_behavior",null);InputUIL.create(prefix+"_behavior",null).copyFrom(copyBehavior,["uniforms","data","codeCount"]);let data=copyBehavior.get("data")||[],buniformString=copyBehavior.get("uniforms")+"\n";ListUIL.create(prefix+"_code",null).internalAddItems(data.length),data.forEach(postfix=>{let toCode=InputUIL.create(prefix+postfix,null),fromCode=InputUIL.create(toLoad+postfix,null);toCode.copyFrom(fromCode,["name","code","uniforms","preset"]),buniformString+=fromCode.get("uniforms")+"\n"}),buniformString.split("\n").forEach(line=>{if(!line.includes(":"))return;let name=(line=line.replace(/ /g,"")).split(":")[0],lookup="am_ProtonAntimatter_"+toLoad,store="am_ProtonAntimatter_"+prefix,val=UILStorage.get(lookup+name);val&&UILStorage.set(store+name,val)});let className=copyConfig.get("class");className&&(_this.customClass=_this.parent.initClass(window[className],_this,_group,_input),_this.customClass.loadConfig&&_this.customClass.loadConfig(toLoad,prefix)),shouldNotify&&alert("Loaded. Save and refresh")}function loadConfig(){let name=prompt("Name of configuration to be loaded"),toLoad=UILStorage.get(`proton_config_${name}`);loadBehavior(toLoad),loadShader(toLoad),alert("Loaded. Save and refresh")}function getSize(){let size=_config.getNumber("particleCount");if(isNaN(size))try{size=eval(_config.get("particleCount"))}catch(e){throw"Proton particleCount is not a number or valid test function"}if(isNaN(size))throw"Proton particleCount is falsy!";return _this.particleCount=size,size}async function initCustomClass(){_this.shader.addUniforms({DPR:{value:World.DPR,ignoreUIL:!0}});let className=_config.get("class");className&&(_this.customClass=_this.parent.initClass(window[className],_this,_group,_input))}function parseUniforms(text,predefined){if(!text)return{};let split=text.split("\n"),output={};return split.forEach(line=>{if(!(line=line.replace(/ /g,"")).length||!line.includes(":"))return;let split=line.split(":"),name=split[0],val=split[1];if(val.includes("[")){let array=JSON.parse(val);switch(array.length){case 2:output[name]={value:(new Vector2).fromArray(array)};break;case 3:output[name]={value:(new Vector3).fromArray(array)};break;case 4:output[name]={value:(new Vector4).fromArray(array)};break;default:throw`Unknown uniform type ${line}`}}else"C"==val.charAt(0)?predefined[name]=val.slice(1):"T"===val?output[name]={value:null}:val.includes(["0x","#"])?output[name]={value:new Color(val)}:output[name]={value:Number(val)}}),output}function getUniformGLSLType(obj){return"number"==typeof obj.value?"float":null===obj.value?"sampler2D":obj.value instanceof Vector2?"vec2":obj.value instanceof Vector3?"vec3":obj.value instanceof Vector4?"vec4":void 0}async function initBehavior(behavior){let glsl=[],predefinedUniforms={},input=InputUIL.create(prefix+"_behavior",_group);input.setLabel("Behavior Uniforms"),input.addTextarea("uniforms"),input.add("data","hidden"),input.add("codeCount","hidden");let map={},list=[],count=input.getNumber("codeCount")||0,data=input.get("data")||[],panel=ListUIL.create(prefix+"_code",_group);panel.setLabel("Behavior Code"),panel.onAdd((name,input,index)=>{list[index]||addCode(),input.group.add(list[index].group),list[index].mapId=name,map[name]=list[index],input.setLabel(map[name].get("name")||"Code")}),panel.onRemove(name=>{let postfix=map[name].postfix;list.remove(map[name]),data.remove(postfix),input.setValue("data",JSON.stringify(data))}),panel.onSort(array=>{let arr=[];array.forEach(name=>{arr.push(map[name].postfix)}),data=arr,input.setValue("data",JSON.stringify(data))});let uniforms=parseUniforms(input.get("uniforms")),createCode=postfix=>{let input=InputUIL.create(prefix+postfix,_group,!0);if(input.prefix=prefix+postfix,input.postfix=postfix,input.setLabel("Editor"),input.add("name","hidden"),Proton.ignorePresets&&Proton.ignorePresets.includes(input.get("name")))return;ProtonPresets.bind(input),input.customPresetCallback&&input.customPresetCallback(_this);let code=input.get("code")||"";if(!input.disabled&&code.length){for(uniforms=Utils.mergeObject(uniforms,parseUniforms(input.get("uniforms"),predefinedUniforms));code.includes("#test ");)try{let test=code.split("#test ")[1],name=test.split("\n")[0],glsl=code.split("#test "+name+"\n")[1].split("#endtest")[0];eval(name)||(code=code.replace(glsl,"")),code=code.replace("#test "+name+"\n",""),code=code.replace("#endtest","")}catch(e){throw"Error parsing test :: "+e}glsl.push(code)}list.push(input)};data.forEach(createCode);let addCode=_=>{count++,data.push(`code_${count}`),input.setValue("data",JSON.stringify(data)),input.setValue("codeCount",count),createCode(`code_${count}`)};behavior instanceof AntimatterPass&&(behavior.addInput("tOrigin",_antimatter.vertices),behavior.addInput("tAttribs",_antimatter.attribs),behavior.addUniforms(uniforms));let filledRequire=[],insertUniform=(code,line)=>code.split("//uniforms").join(line+"\n//uniforms"),insertCode=(code,line)=>code.split("//code").join(line+"\n//code"),insertRequire=(code,line)=>{let name=line.split("require(")[1].split(")")[0];return filledRequire.includes(name)?code:(filledRequire.push(name),code.split("//require").join(Shaders.getShader(name)+"\n//require"))},insertGLSL=(code,line)=>{if(line.includes("#require")){let split=line.split("\n");for(let l of split)code=l.includes("#require")?insertRequire(code,l):insertCode(code,l);return code}return insertCode(code,line)};behavior.onCreateShader=code=>{for(let name in uniforms)code=insertUniform(code,`uniform ${getUniformGLSLType(uniforms[name])} ${name};`);for(let name in predefinedUniforms)code=insertUniform(code,`uniform ${predefinedUniforms[name]} ${name};`);for(let str of glsl)code=insertGLSL(code,str);return _this.tubes&&(code=_this.tubes.overrideShader(code)),Renderer.type==Renderer.WEBGL2&&(code=code.replace(/gl_FragColor/g,"FragColor")),code},behavior.uniforms.uMaxCount={value:_this.particleCount,ignoreUIL:!0},ShaderUIL.add(behavior,_group).setLabel("Behavior Shader")}function completeShader(shader){let transparent=_input.get("transparent"),depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest"),blending=_input.get("blending"),castShadow=_input.get("castShadow"),receiveShadow=_input.get("receiveShadow");"boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),"boolean"==typeof castShadow&&(_this.mesh.castShadow=castShadow),"boolean"==typeof receiveShadow&&(shader.receiveShadow=receiveShadow),blending&&(shader.blending=blending),shader.uniforms.tRandom={value:_antimatter.attribs}}function update(){_antimatter.update()}async function initAntimatter(){let lifecycle="lifecycle"==_config.get("type");_config.addVector("width",[-1,1]),_config.addVector("height",[-1,1]),_config.addVector("depth",[-1,1]);let dimensions={w:_config.get("width")||[-1,1],h:_config.get("height")||[-1,1],d:_config.get("depth")||[-1,1]};_antimatter=_this.initClass(Antimatter,_size,dimensions),Proton.forceCloneVertices.includes(_config.get("class"))&&(_antimatter.cloneVertices=!0),_this.antimatter=_antimatter,await _antimatter.ready();let output=_config.get("output");"tubes"==output&&(_this.tubes=_this.initClass(ProtonTubes,_this));let overrideShader,wildcard=_input.get("wildcard");if(wildcard&&wildcard.includes(".behavior")){let layer=await _this.parent.getLayer(wildcard.split(".")[0]);await _this.wait(layer,"behavior"),_this.behavior=layer.behavior}else{let behavior=_this.initClass(AntimatterPass,`ProtonAntimatter${lifecycle?"Lifecycle":""}`,{unique:prefix,customCompile:prefix});_this.behavior=behavior,initBehavior(behavior)}let shaderName=_config.get("shader");if(shaderName)if(shaderName.includes(".shader")){let layer=await _this.parent.getLayer(shaderName.split(".")[0]);await _this.wait(layer,"shader"),overrideShader=layer.shader}else{let uniforms=parseUniforms(_config.get("uniforms"));uniforms.unique=prefix+(_this.onGenerateUniqueShader?_this.onGenerateUniqueShader():""),_antimatter.useShader(shaderName,uniforms)}_antimatter.addPass(_this.behavior),_this.mesh=_antimatter.getMesh(),_this.onCreateMesh&&_this.onCreateMesh(_this.mesh),output&&"particles"!=output||_this.delayedCall(_=>{_this.add(_antimatter.mesh)},480),Utils.query("uilOnly")||_this.startRender(update),shaderName&&!shaderName.includes(".shader")&&(ShaderUIL.add(_antimatter.shader,_group).setLabel("Shader"),completeShader(_antimatter.shader)),overrideShader&&_antimatter.overrideShader(overrideShader),_this.shader=_antimatter.shader,_this.initialized=!0,lifecycle&&(_this.spawn=_this.initClass(AntimatterSpawn,_this,_group,_input)),initCustomClass()}this.uilInput=_input,this.uilGroup=_group,this.prefix=prefix,initConfig(),this.parseUniforms=parseUniforms,this.ready=function(){return this.wait(this,"initialized")},this.applyToInstancedGeometry=function(geometry){geometry.addAttribute("lookup",new GeometryAttribute(_antimatter.getLookupArray(),3,1)),geometry.addAttribute("random",new GeometryAttribute(_antimatter.getRandomArray(),4,1))},this.applyToShader=function(shader){shader.addUniforms({tPos:_antimatter.getOutput(),tPrevPos:_antimatter.getPrevOutput()})},this.upload=async function(){if(!_this.disabled){_this.group.visible=!1,await this.ready(),await _antimatter.upload(),_this.spawn&&await _this.spawn.upload();for(let key in _this.classes)_this.classes[key]instanceof MouseFlowMap&&await _this.classes[key].upload();_this.group.visible=!0}},this.uploadSync=async function(){_this.disabled||(await this.ready(),await _antimatter.uploadSync())},this.stopUpdating=function(){_this.stopRender(update)},this.set("renderOrder",async v=>{await _this.ready(),await _antimatter.ready(),_antimatter.mesh.renderOrder=v}),this.get("renderOrder",v=>_antimatter.mesh.renderOrder)}),_=>{Proton.forceCloneVertices=[],Proton.ignore=function(name){Proton.ignorePresets||(Proton.ignorePresets=[]),Proton.ignorePresets.push(name)}}),Class((function ProtonPresets(){const _this=this,LIST=[{label:"Custom Code",value:"custom"},{label:"Curl Noise",value:"curl"},{label:"Mouse Flowmap",value:"flowmap"},{label:"Plane Shape",value:"planeshape"},{label:"3D Shape",value:"3dshape"},{label:"Force",value:"force"},{label:"Follow",value:"follow"}],CALLBACKS={custom:customCode,curl:curlNoise,flowmap:flowmap,planeshape:planeShape,"3dshape":shape3D,force:force,follow:follow};function customCode(input){input.setValue("name","Custom Code"),input.setLabel("Custom Code")}function curlNoise(input){input.setValue("name","Curl Noise"),input.setLabel("Curl Noise");input.setValue("uniforms","\n        uCurlNoiseScale: 1\n        uCurlTimeScale: 0\n        uCurlNoiseSpeed: 0\n        "),input.get("code")&&input.get("code").includes("uCurlNoise")||input.setValue("code","#require(curl.glsl)\n        \nvec3 curl = curlNoise(pos * uCurlNoiseScale*0.1 + (time * uCurlTimeScale * 0.1));\npos += curl * uCurlNoiseSpeed * 0.01;")}function flowmap(input){input.setValue("name","Mouse Flowmap"),input.setLabel("Mouse Flowmap");let code="#require(glscreenprojection.glsl)\n#require(flowmap.fs)\n\nvec3 mpos = vec3(uModelMatrix * vec4(pos, 1.0));\nvec2 screenUV = getProjection(mpos, uProjMatrix);\nvec3 flow = vec3(getFlow(tFlowmap, screenUV), 0.0);\napplyNormal(flow, uProjNormalMatrix);\nfloat hit = 0.0;\nfloat fvelX = crange(flow.x, -1.0, 1.0, 0.0, 1.0);\nfloat fvelY = crange(flow.y, -1.0, 1.0, 0.0, 1.0);\nif (fvelX > 0.505 || fvelX < 0.495) hit = 1.0;\nif (fvelY > 0.505 || fvelY < 0.495) hit = 1.0;\npos += flow * uMouseStrength * hit;",uniforms="\n        uProjMatrix: Cmat4\n        uProjNormalMatrix: Cmat4\n        uModelMatrix: Cmat4\n        tFlowmap: Csampler2D\n        uMouseStrength: 1\n        ";input.setValue("uniforms",uniforms),input.get("code")&&input.get("code").includes("getFlow")||input.setValue("code",code),input.add("useExisting"),input.add("size",512),input.add("radius",.15),input.add("falloff",1),input.add("speed",0),input.add("decay",.93),input.addToggle("multitouch"),input.addToggle("hideMouse");let findCamera=proton=>{let camera=World.CAMERA,p=proton.group._parent;for(;p;)p instanceof Scene&&p.nuke&&(camera=p.nuke.camera),p=p._parent;return camera};input.customPresetCallback=async proton=>{let useExistingFlowmap=input.get("useExisting"),flowmap,projection;if(useExistingFlowmap)if(useExistingFlowmap.includes("."))flowmap=eval(useExistingFlowmap),projection=flowmap.projection;else{let layer=await proton.parent.getLayer(useExistingFlowmap);await proton.wait(layer,"flowmap"),flowmap=proton.flowmap=layer.flowmap,projection=flowmap.projection}else{flowmap=proton.initClass(MouseFlowMap,{size:input.getNumber("size"),radius:input.getNumber("radius"),falloff:input.getNumber("falloff"),speed:input.getNumber("speed"),decay:input.getNumber("decay"),multitouch:input.get("multitouch")||!1,hideMouse:input.get("hideMouse")||!1}),proton.flowmap=flowmap;let camera=findCamera(proton);projection=proton.initClass(GLScreenProjection,camera),projection.start(),flowmap.projection=projection}proton.behavior?proton.behavior.addUniforms({uProjMatrix:projection.uniforms.projMatrix,uModelMatrix:projection.uniforms.modelMatrix,uProjNormalMatrix:projection.uniforms.normalMatrix,tFlowmap:flowmap.textureUniform}):proton.wait("behavior").then(_=>{proton.behavior.addUniforms({uProjMatrix:projection.uniforms.projMatrix,uModelMatrix:projection.uniforms.modelMatrix,uProjNormalMatrix:projection.uniforms.normalMatrix,tFlowmap:flowmap.textureUniform})})}}function planeShape(input){input.setValue("name","Plane Shape"),input.setLabel("Plane Shape");input.setValue("uniforms","\n        uTakePlaneShape: 1\n        uPlaneScale: 1\n        tPlaneTexture: Csampler2D\n        "),input.get("code")&&input.get("code").includes("uPlaneScale")||input.setValue("code","vec2 planeLookup = texture2D(tPlaneTexture, uv).xy;\nvec3 plane;\nplane.x = uPlaneScale * 0.5 * range(planeLookup.x, 0.0, 1.0, -1.0, 1.0);\nplane.y = uPlaneScale * 0.5 * -range(planeLookup.y, 0.0, 1.0, -1.0, 1.0);\nif (uTakePlaneShape > 0.5) pos = plane;"),input.customPresetCallback=proton=>{proton.behavior.addUniforms({tPlaneTexture:{value:null}})}}function shape3D(input){input.setValue("name","3D Shape"),input.setLabel("3D Shape"),input.add("geometry");let geometry=input.get("geometry");input.setValue("uniforms","\n        tShape3D: Csampler2D\n        uTake3DShape: 1\n        u3DShapeScale: 1\n        "),input.get("code")&&input.get("code").includes("shape3d")||input.setValue("code","vec3 shape3d = texture2D(tShape3D, uv).xyz * u3DShapeScale;\nif (uTake3DShape > 0.5) pos = shape3d;"),input.customPresetCallback=proton=>{let create=async g=>{let geom=await GeomThread.loadGeometry(g),distribution=await ParticleDistributor.generate(geom,Math.pow(proton.particleCount,2)),attribute=new AntimatterAttribute(distribution,3);proton.behavior.addInput("tShape3D",attribute)};geometry&&create(geometry),proton.set3DShape=create}}function force(input){input.setValue("name","Force"),input.setLabel("Force");input.setValue("uniforms","\n        uForceDir: [0, 1, 0]\n        uForceScale: 1\n        "),input.setValue("code","vec3 force = normalize(uForceDir) * uForceScale * 0.1;\npos += force;")}function follow(input){input.setValue("name","Follow"),input.setLabel("Follow");input.setValue("uniforms","\n        uFollowPos: [0, 0, 0]\n        uFollowRadius: 2\n        uFollowLerp: 0.7\n        "),input.get("code")&&input.get("code").includes("followPos")||input.setValue("code","float speed = range(random.x, 0.0, 1.0, 0.5, 1.5);\nvec3 followPos = uFollowPos;\nfollowPos.x += range(random.y, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\nfollowPos.y += range(random.z, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\nfollowPos.z += range(random.w, 0.0, 1.0, -1.0, 1.0) * uFollowRadius;\npos += (followPos - pos) * (uFollowLerp*0.1*speed);")}this.register=function(name,callback){let key=name.replace(/ /g,"").toLowerCase();LIST.push({label:name,value:key}),CALLBACKS[key]=callback},this.bind=function(input){input.add("code","hidden");input.add("uniforms","hidden"),input.addSelect("preset",LIST);let callback=CALLBACKS[input.get("preset")];callback&&callback(input),input.addButton("btn",{actions:[{title:"Edit Code",callback:_=>{let editor=new UILExternalEditor(input.get("name")||"Code",300);editor.setCode(input.get("code"),"c"),editor.onSave=value=>input.setValue("code",value),UIL.add(editor)}}],hideLabel:!0})}}),"static"),Class((function ProtonTubes(_proton){Inherit(this,Object3D);const _this=this;var _config,_segments,_textureSize,_count,_shader,_geom;this.padding=150,async function(){!function initConfig(){(_config=InputUIL.create("tubes_"+_proton.prefix,_proton.uilGroup)).setLabel("Tubes"),_config.add("segments",5),_config.add("sides",4),_config.add("lerp",.2),_config.onUpdate=key=>{"lerp"==key&&_proton.behavior.setUniform("uLerp",_config.getNumber("lerp"))}}(),await async function initBuffers(){let segments=_config.getNumber("segments"),indexBuffer=await _proton.antimatter.createFloatArrayAsync(4,!0),count=indexBuffer.length/4;for(let i=0;i<count;i++)indexBuffer[4*i+0]=i%segments,indexBuffer[4*i+1]=Math.floor(i/segments),indexBuffer[4*i+2]=i%segments==0?1:0,indexBuffer[4*i+3]=1;_textureSize=Math.sqrt(count),_segments=segments,_count=count/segments;let indices=_this.initClass(AntimatterAttribute,indexBuffer,4);_proton.behavior.addInput("tIndices",indices),_proton.behavior.addUniforms({uLerp:{value:_config.getNumber("lerp"),ignoreUIL:!0},textureSize:{value:_textureSize,ignoreUIL:!0},lineSegments:{value:segments,ignoreUIL:!0}})}(),await _this.wait(_proton.spawn,"lifeOutput"),function initGeometry(){let shape=function generate(numSides=8,subdivisions=50,openEnded=!1){let geom=new CylinderGeometry(1,1,1,numSides,subdivisions,openEnded);geom.applyMatrix((new Matrix4).makeRotationZ(Math.PI/2)),require("BufferToVertices").toVertices(geom);let tmpVec=new Vector2,xPositions=[],angles=[],uvs=[],vertices=geom.vertices,faceVertexUvs=geom.faceVertexUvs[0],indices=[];geom.faces.forEach((face,i)=>{let{a:a,b:b,c:c}=face,verts=[vertices[a],vertices[b],vertices[c]],faceUvs=faceVertexUvs[i];verts.forEach((v,j)=>{tmpVec.set(v.y,v.z).normalize();let angle=Math.atan2(tmpVec.y,tmpVec.x);angles.push(angle),xPositions.push(v.x),uvs.push(faceUvs[j].toArray()),indices.push(Math.abs(Math.round(Math.range(v.x,-.5,.5,0,subdivisions-1))))})});let posArray=new Float32Array(xPositions),angleArray=new Float32Array(angles),uvArray=new Float32Array(2*uvs.length);for(let i=0;i<posArray.length;i++){let[u,v]=uvs[i];uvArray[2*i+0]=u,uvArray[2*i+1]=v}let geometry=new Geometry;return geometry.addAttribute("position",new GeometryAttribute(new Float32Array(3*posArray.length),3)),geometry.addAttribute("angle",new GeometryAttribute(angleArray,1)),geometry.addAttribute("cIndex",new GeometryAttribute(new Float32Array(indices),1)),geometry.addAttribute("tuv",new GeometryAttribute(uvArray,2)),geometry.indexLookup=indices,geom.destroy(),geometry}(_config.getNumber("sides"),_segments-1,!1),geom=new Geometry;geom.addAttribute("cNumber",new GeometryAttribute(new Float32Array(_count),1,1));for(let key in shape.attributes)geom.addAttribute(key,shape.attributes[key]);for(let i=0;i<_count;i++)geom.attributes.cNumber.array[i]=i;_geom=geom}(),function initShader(){let shaderName=_proton.uilConfig.get("shader");if((_shader=_this.initClass(shaderName&&shaderName.includes("PBR")?PBRShader:Shader,"ProtonTube",shaderName||"ProtonTube",{noAttributes:!0,unique:shaderName,thickness:{type:"f",value:1},textureSize:{type:"f",value:_textureSize,ignoreUIL:!0},lineSegments:{type:"f",value:_segments,ignoreUIL:!0},radialSegments:{type:"f",value:_config.getNumber("sides"),ignoreUIL:!0},taper:{type:"f",value:0},tLife:{type:"t",value:_proton.spawn.lifeOutput,ignoreUIL:!0}})).addUniforms(_proton.parseUniforms(_proton.uilConfig.get("uniforms"))),ShaderUIL.add(_shader,_proton.uilGroup).setLabel("Tube Shader"),shaderName&&_shader.vertexShader){let vs=Shaders.getShader(shaderName+".vs");if(vs){vs=vs.split("void main() {");let params=vs[0].split("\n"),main=vs[1].split("}")[0],paramOutput=[];for(let line of params)_shader.vertexShader.includes(line)&&"}"!=line&&"};"!=line||paramOutput.push(line);_shader.vertexShader=_shader.vertexShader.replace("//neutrinoparams",paramOutput.join("\n")),_shader.vertexShader=_shader.vertexShader.replace("//neutrinovspost",main)}}_proton.applyToShader(_shader),_this.shader=_shader,function completeShader(shader){let transparent=_proton.uilInput.get("transparent"),depthWrite=_proton.uilInput.get("depthWrite"),depthTest=_proton.uilInput.get("depthTest"),blending=_proton.uilInput.get("blending"),castShadow=_proton.uilInput.get("castShadow"),receiveShadow=_proton.uilInput.get("receiveShadow");"boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite);"boolean"==typeof depthTest&&(shader.depthTest=depthTest);"boolean"==typeof transparent&&(shader.transparent=transparent);"boolean"==typeof castShadow&&defer(_=>_this.mesh.castShadow=castShadow);"boolean"==typeof receiveShadow&&(shader.receiveShadow=receiveShadow);blending&&(shader.blending=blending)}(_shader)}(),function initMesh(){let mesh=new Mesh(_geom,_shader);mesh.frustumCulled=!1,_this.add(mesh),_this.mesh=mesh}(),_this.canEmit=!0}(),this.overrideShader=function(code){let uniforms=Shaders.getShader("ProtonTubesUniforms.fs"),main=Shaders.getShader("ProtonTubesMain.fs"),movement=(code=code.replace("//uniforms",uniforms)).split("//abovespawn")[1].split("//code")[0];return main=main.replace("//main",movement),main=main.split("main() {")[1].slice(0,-1),code=code.replace(movement,main)},this.release=function(pos,count=1,radius=0,velocity){if(!_this.canEmit)return;let positions=[],velocities=velocity?[]:null;_proton.spawn.index>_proton.spawn.total-_this.padding&&(_proton.spawn.index=-1);for(let i=0;i<count;i++){let x=pos.x+Math.random(-1,1,4)*radius,y=pos.y+Math.random(-1,1,4)*radius,z=pos.z+Math.random(-1,1,4)*radius;for(let j=0;j<_segments;j++)positions.push(x,y,z),velocities&&velocities.push(velocity.x,velocity.y,velocity.z)}_proton.spawn.emit(positions,velocities)}})),Class((function RenderManager(){Inherit(this,Component);const _this=this;var _dpr=null;function resizeHandler(){_this.renderer&&_this.renderer.setSize(Stage.width,Stage.height)}function getDPR(){return window.AURA?Device.pixelRatio:GPU.OVERSIZED?1:GPU.lt(0)?Math.min(1.3,Device.pixelRatio):GPU.lt(1)?Math.min(1.8,Device.pixelRatio):GPU.mobileLT(2)?Math.min(1.5,Device.pixelRatio):GPU.gt(4)?Math.min(1.5,Device.pixelRatio):Math.max(1.25,Device.pixelRatio)}function directRenderCallback(render){window.GLUI&&window.Metal&&GLUI.renderDirect(render)}this.NORMAL="normal",this.MAGIC_WINDOW="magic_window",this.VR=this.WEBVR="webvr",this.AR=this.WEBAR="webar",this.RENDER="RenderManager_render",this.POST_RENDER="RenderManager_post_render",this.EYE_RENDER="RenderManager_eye_render",this.READY="render_gl_ready",_this.events.sub(Events.RESIZE,resizeHandler),this.get("DPR",v=>getDPR()),this.initialize=function(type,params={}){if(_this.camera&&_this.camera.destroy(),_this.renderer&&_this.renderer.destroy(),type!=_this.WEBVR&&type!=_this.WEBAR||(params.xrCompatible=!0),!_this.gl){let camera=new PerspectiveCamera(45,Stage.width/Stage.height,.01,200);_this.gl=function(){"safari"==Device.system.browser&&Device.system.browserVersion<13&&delete params.powerPreference,Utils.query("compat")&&(params.forceWebGL1=!0);let renderer=new(window.Metal?MetalRenderer:Renderer)(params);return renderer.setSize(Stage.width,Stage.height),renderer.setPixelRatio(getDPR()),renderer}(),_this.scene=new Scene,_this.nuke=_this.initClass(Nuke,Stage,Object.assign({renderer:_this.gl,scene:_this.scene,camera:camera,dpr:World.DPR},params))}switch(_dpr=_dpr||World.DPR||1,type){case _this.WEBVR:_this.renderer=_this.initClass(VRRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(VRCamera);break;case _this.WEBAR:_this.renderer=_this.initClass(window.Metal?MetalARRenderer:ARRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(ARCamera);break;case _this.MAGIC_WINDOW:_this.renderer=_this.initClass(MagicWindowRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(VRCamera);break;case _this.NORMAL:_this.renderer=_this.initClass(RenderManagerRenderer,_this.gl,_this.nuke),_this.camera=_this.initClass(RenderManagerCamera)}_this.type=type,_this.nuke.camera=_this.camera.worldCamera},this.render=function(scene,camera,renderTarget,forceClear){_this.renderer.render(scene||_this.scene,camera||_this.camera.worldCamera,renderTarget,forceClear,directRenderCallback),_this.events.fire(_this.POST_RENDER)},this.startRender=function(){Render.start(_this.render)},this.stopRender=function(){Render.stop(_this.render)},this.requestPresent=function(bool){_this.renderer.requestPresent&&_this.renderer.requestPresent(bool)},this.setSize=function(width,height){_this.events.unsub(Events.RESIZE,resizeHandler),_this.renderer.setSize(width,height)},this.set("onRenderEye",callback=>{_this.renderer.onRenderEye=callback})}),"static"),Class((function RenderManagerCamera(){Inherit(this,Component);const _this=this;this.worldCamera=window.THREE?new THREE.PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3):new PerspectiveCamera(30,Stage.width/Stage.height,.1,1e3),_this.events.sub(Events.RESIZE,()=>{_this.worldCamera.aspect=Stage.width/Stage.height,_this.worldCamera.updateProjectionMatrix()})})),Class((function RenderManagerRenderer(_renderer,_nuke){Inherit(this,Component);const _this=this;var _evt={};_nuke.onBeforeProcess=_=>{_evt.stage=Stage,_evt.camera=_nuke.camera,_this.events.fire(RenderManager.RENDER,_evt)},this.render=function(scene,camera,_1,_2,directRender){_nuke.camera=camera,_nuke?_nuke.render(directRender):_renderer.render(scene,camera,null,null,directRender)},this.setSize=function(width,height){_renderer.setSize(width,height)}})),Class((function RTPool(_options={},_size=3){Inherit(this,Component);const _this=this;var _pool;this.nullRT=Utils3D.createRT(2,2);var _array=[];function createRT(){let rt=Utils3D.createRT(Stage.width*World.DPR,Stage.height*World.DPR,_options.type,_options.format);return rt.index=_pool.length(),rt}function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler)}function resizeHandler(){_array.forEach(rt=>{rt.setSize(Stage.width*World.DPR,Stage.height*World.DPR)})}!function initPool(){_pool=new ObjectPool;for(let i=0;i<_size;i++){let rt=createRT();_pool.put(rt),_array.push(rt)}}(),defer(addListeners),this.get("array",_=>_array),this.getRT=function(){return _pool.get()||createRT()},this.putRT=function(rt){_pool.put(rt)},this.setSize=function(width,height){_this.events.unsub(Events.RESIZE,resizeHandler),_array.forEach(rt=>{rt.setSize(width,height)})},this.onDestroy=function(){let p=_pool.get();for(;p;)p.dispose(),p=_pool.get()},this.clone=function(options){return new RTPool(options)}}),"singleton"),Class((function SceneLayout(_name,_options={}){Inherit(this,Object3D);const _this=this;var _dataStore,_data,_timeline,_breakpoint;const ZERO=new Vector3;var _initializers=[],_promises=[],_breakpoints=[],_folders={},_groups={},_custom={},_meshes={},_exists={},_layers={},_uil=UIL.sidebar,_graph,_config,_groupIndex=0;function initialize(promise){_promises.push(promise)}function createFolder(name){let folder=new UILFolder(`sl_${_name}_${name}`,{label:name,closed:!0});return folder.hide(),_folders[`sl_${_name}_${name}`]=folder,folder}async function initConfig(){let input=InputUIL.create(`CONFIG_sl_${_name}`,_uil);input.add("Animation"),input.add("Layout"),input.add("Cinema Config"),_graph&&_graph.addSpecial("Config",`Config (${_name})`,"Config"),input.setLabel("Config");let animation=input.get("Animation"),layout=input.get("Layout");if(animation){if(await ready(),animation=animation.replace(/^\//g,""),_this.animation=_this.initClass(HierarchyAnimation,animation,linkObjects),_timeline)_this.startRender(_=>{_this.animation.elapsed=_timeline.elapsed,_this.animation.update()});else if(_uil){let range=new UILControlRange("Animation",{min:0,max:1,step:.001});range.onChange(val=>{_this.animation.elapsed=val,_this.animation.update()}),_uil.add(range)}await _this.animation.ready(),_this.animation.update()}layout&&(await ready(),_this.layout=_this.initClass(HierarchyLayout,layout,linkObjects),await _this.layout.ready()),_config=input,await defer(),_this.configured=!0}async function linkObjects(data){let array=[];for(let i=0;i<data.length;i++){let name=data[i].name,exists=_this.exists(name);exists||"null"==name.toLowerCase()||console.warn(`linkAnimation :: ${name} does not exist`);let group=new Group,mesh=exists?await _this.getLayer(name):null;mesh&&(_this.layout&&mesh instanceof Mesh?(mesh._parent.add(group),group.add(mesh)):group=mesh.group||mesh),group.name=name,array.push(group)}return array}async function initGraph(){if(_options.noGraph||!window.UILGraph||SceneLayout.noGraph)return _uil=null;(_graph=UILGraph.instance().getGraph(_name,_this))&&(UIL.sidebar.element.show(),await _this.ready(),_graph.syncVisibility(_layers),_graph.syncGroupNames(_groups,_folders),Global.PLAYGROUND&&Utils.getConstructorName(_this.parent)==Global.PLAYGROUND&&_graph.open())}function initParams(){if(_options.rootPath?"/"!=_options.rootPath.charAt(_options.rootPath.length-1)&&(_options.rootPath+="/"):_options.rootPath="",_this.timeline=_timeline=_options.timeline,_timeline&&(_timeline.add({v:0},{v:1},100,"linear"),_uil)){let range=new UILControlRange("Timeline",{min:0,max:1,step:.001});range.onChange(val=>{_timeline.elapsed=val,_timeline.update()}),_uil.add(range),range.hide(),_graph&&_graph.addSpecial("Timeline","Timeline")}_this.baseRenderOrder=_options.baseRenderOrder||0,_this.data=_options.data,_breakpoint=_options.breakpoint||SceneLayout.breakpoint,_options.breakpoint&&(_this.localBreakpoint=!0),_options.uil&&(_uil=_options.uil)}async function initData(){if(await UILStorage.ready(),_dataStore=InputUIL.create(`scenelayout_${_name}`,null),void 0===(_data=JSON.parse(_dataStore.get("data")||"{}")).layers&&(_data.layers=-1),_options.perFrame)_data.layers>0&&createLayers();else{for(let i=0,c=_data.layers+1;i<c;i++)initialize(createLayer(i));_this.loaded=!0}}function createLayers(){let index=0,renderWorker=new Render.Worker((function(){initialize(createLayer(index)),index++==_data.layers&&(renderWorker.stop(),_this.loaded=!0)}),_options.perFrame)}function getGroup(name){if(!name)return _this.group;if(name==_name)return _this.group;if(!_groups[name]){let uilGroup=_uil?createFolder(name):null;uilGroup&&(uilGroup.setLabel(`${name} (Group)`),_uil.add(uilGroup),_graph&&_graph.addGroup(uilGroup.id,name));let config=InputUIL.create(`GROUP_${_name}_${name}`,uilGroup);config.setLabel("Parameters"),_timeline&&config.add("tween"),config.addToggle("billboard"),config.add("breakpoints"),config.add("name","hidden");let breakpoints=config.get("breakpoints");breakpoints&&(breakpoints=breakpoints.replace(/ /g,"").split(","));let breakpoint=breakpoints&&_breakpoint?"-"+_breakpoint:"";"-"==breakpoint.charAt(breakpoint.length-1)&&(breakpoint="");let group=new Group;_groups[name]=group,_layers[name]=group,_exists[name]="group",group.prefix=`${name}_${_name}${breakpoint}`,MeshUIL.add(group,uilGroup).setLabel("Mesh"),_this.add(group),uilGroup&&(uilGroup.params=config),breakpoints&&_breakpoints.push(group),config.get("billboard")&&_this.startRender(_=>Utils3D.billboard(group)),config.get("tween")&&applyTween(group,name,uilGroup)}return _groupIndex++,_groups[name]}async function applyTween(mesh,id,group,shader){let config=TweenUIL.create(`Element_${id}_${_name}`,group),a=config.add(tween(mesh.position,mesh.position.clone(),100,"linear",0,null,!0),"position"),b=config.add(tween(mesh.rotation,mesh.rotation.clone(),100,"linear",0,null,!0),"rotation"),c=config.add(tween(mesh.scale,mesh.scale.clone(),100,"linear",0,null,!0),"scale"),d=shader&&shader.uniforms.uAlpha?config.add(tween(shader.uniforms.uAlpha,{value:1},100,"linear",0,null,!0),"alpha"):null;await defer(),await defer(),config.setLabel("Tween"),mesh.position.equals(a.props)||0==a.props.x&&0==a.props.y&&0==a.props.z||_timeline.add(a),mesh.rotation.equals(b.props)||0==b.props.x&&0==b.props.y&&0==b.props.z||_timeline.add(b),mesh.scale.equals(c.props)||1==c.props.x&&1==c.props.y&&1==c.props.z||_timeline.add(c),d&&shader.uniforms.uAlpha.value!=d.props.uAlpha&&_timeline.add(d),mesh.tweens={position:a,rotation:b,scale:c,alpha:d}}async function createLayer(index,groupName){let id="number"==typeof index?index:++_data.layers,graphGroupName=groupName;if(graphGroupName){let nameLabel=UILStorage.get(`INPUT_GROUP_${_name}_${groupName}_name`);nameLabel&&(groupName=nameLabel)}if(UILStorage.get(`sl_${_name}_${id}_deleted`))return;if(_this.preventLayerCreation&&_this.preventLayerCreation(UILStorage.get(`INPUT_Config_${id}_${_name}_name`)))return;let group=_uil?createFolder(id):null,shader,mesh,input=InputUIL.create(`Config_${id}_${_name}`,group);input.setLabel("Parameters"),input.add("name","hidden").add("geometry").addToggle("visible",!0).addToggle("transparent").addToggle("depthWrite",!0).addToggle("depthTest",!0).addToggle("castShadow").addToggle("receiveShadow").addToggle("receiveLight").addToggle("billboard").add("shader").add("customClass").add("scriptClass").add("wildcard").add("renderOrder","hidden").add("group","hidden").add("breakpoints").addSelect("side",[{label:"Front Side",value:"shader_front_side"},{label:"Back Side",value:"shader_back_side"},{label:"Double Side",value:"shader_double_side"}]).addSelect("blending",[{label:"Normal",value:"shader_normal_blending"},{label:"Additive",value:"shader_additive_blending"}]),input.name=_name,input.prefix=`Element_${id}_${_name}`,input.id=id,group&&(group.params=input),_timeline&&input.addToggle("tween"),_options.physics&&(input.addToggle("physics"),input.add("physicsCode"));let name=input.get("name")||id,shaderName=input.get("shader")||"SceneLayout",geomPath=input.get("geometry"),visible=input.get("visible"),transparent=input.get("transparent"),depthWrite=input.get("depthWrite"),depthTest=input.get("depthTest"),billboard=input.get("billboard"),doTween=input.get("tween"),renderOrder=input.getNumber("renderOrder"),blending=input.get("blending"),side=input.get("side"),physics=input.get("physics"),castShadow=input.get("castShadow"),receiveShadow=input.get("receiveShadow"),receiveLight=input.get("receiveLight"),breakpoints=input.get("breakpoints");breakpoints&&(breakpoints=breakpoints.replace(/ /g,"").split(","));let breakpoint=breakpoints&&_breakpoint?"-"+_breakpoint:"";"-"==breakpoint.charAt(breakpoint.length-1)&&(breakpoint=""),name&&group&&group.setLabel(name),groupName&&input.setValue("group",groupName);let groupParent=getGroup(input.get("group"));if(group){let groupName=input.get("group"),groupId=groupName?`sl_${_name}_${graphGroupName||groupName}`:void 0;_graph&&_graph.addLayer(group.id,name||id+"",groupId)}if(_uil&&_uil.add(group),"ignore"==name)return;let customClass=input.get("customClass"),scriptClass=input.get("scriptClass");if(_exists[name]=customClass?"custom":"mesh",customClass){if(!window[customClass])return console.warn(`Tried to initialize ${customClass} but it doesn't  exist!`);let obj=_this.initClass(window[customClass],input,group,id,null);if(mesh=obj.group,"boolean"==typeof visible&&mesh&&(mesh.visible=visible),doTween&&obj.group&&applyTween(obj.group,id,group),_custom[name]=obj,_layers[name]=obj,_this.onCreateLayer){let capture=cb=>(_this.delayedCall(_=>cb(obj,name),32),!0);if(_this.onCreateLayer(name,capture))return}return obj.group&&groupParent.add(obj.group),obj.renderOrder=_this.baseRenderOrder+renderOrder,void(mesh&&(mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group).setLabel("Mesh"),_breakpoints.push(mesh),scriptClass&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(","),scriptClass.forEach(script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,shader,group,input))):console.warn(`scriptClass ${script} not found`)})):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,shader,group,input):console.warn(`scriptClass ${scriptClass} not found`))))}if(_this.onCreateLayer){let capture=cb=>{let mesh=new Group;return mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group),doTween&&applyTween(mesh,id,group,{uniforms:{uAlpha:{value:1}}}),_meshes[name]=mesh,_layers[name]=mesh,_this.delayedCall(_=>cb(mesh,name),32),!0};if(_this.onCreateLayer(name,capture))return}let geom=World.PLANE;if(geomPath&&geomPath.includes(["World","SceneLayout"])&&(geom=eval(geomPath),geomPath=null),shaderName.includes(".shader")){let shaderLayer=shaderName.split(".shader")[0],layer=await _this.getLayer(shaderLayer);shader=layer.shader,shader._copied=layer}else if(shaderName.includes("PBR"))shader=_this.initClass(PBRShader,shaderName,{unique:`Element_${id}_${_name}`});else{let texturePath=input.getImage("texture");texturePath?texturePath.includes("assets/images")||(texturePath=_options.rootPath+texturePath):texturePath="assets/images/_scenelayout/uv.jpg",shader=_this.initClass(Shader,shaderName,{unique:`Element_${id}_${_name}`}),"SceneLayout"!=shaderName&&window[shaderName]||shader.addUniforms({tMap:{value:Utils3D.getTexture(texturePath)},uAlpha:{value:1}}),defer(_=>{for(let key in shader.uniforms){let uniform=shader.uniforms[key];uniform.value instanceof Texture&&initialize(uniform.value.promise)}})}if("boolean"==typeof depthWrite&&(shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&(shader.depthTest=depthTest),"boolean"==typeof transparent&&(shader.transparent=transparent),geomPath&&(geom=await GeomThread.loadGeometry(geomPath)),mesh=new Mesh(geom,shader),"boolean"==typeof _options.frustumCulled&&(mesh.frustumCulled=_options.frustumCulled),"boolean"==typeof visible&&(mesh.visible=visible),groupParent.add(mesh),mesh.prefix=`Element_${id}_${_name}${breakpoint}`,MeshUIL.add(mesh,group).setLabel("Mesh"),physics){let obj=Physics.instance().create(mesh);obj.prefix=`Physics_${id}_${_name}`,PhysicsUIL.add(obj,group).setLabel("Physics");let code=input.get("physicsCode");code&&_this.initClass(window[code],obj,mesh,group,input)}_meshes[name]=mesh,_layers[name]=mesh,breakpoints&&_breakpoints.push(mesh),mesh.renderOrder=_this.baseRenderOrder+(renderOrder||0),billboard&&_this.startRender(_=>Utils3D.billboard(mesh)),doTween&&applyTween(mesh,id,group,shader),"SceneLayout"!=shaderName&&window[shaderName]&&(mesh.shaderClass=_this.initClass(window[shaderName],mesh,shader,group,input)),shader._copied||shader!==mesh.shader&&!shaderName.includes("PBR")||ShaderUIL.add(shader,group).setLabel("Shader"),shader._copied&&shader._copied.shaderClass&&shader._copied.shaderClass.applyClone&&shader._copied.shaderClass.applyClone(mesh),"number"!=typeof index&&_dataStore.setValue("data",JSON.stringify(_data)),blending&&(shader.blending=blending),side&&(shader.side=side),castShadow&&(mesh.castShadow=castShadow),receiveShadow&&(shader.receiveShadow=receiveShadow),receiveLight&&(shader.receiveLight=receiveLight),scriptClass&&(scriptClass.includes(",")?(scriptClass=scriptClass.replace(/ /g,"").split(","),scriptClass.forEach(script=>{window[script]?(mesh.scriptClass=mesh.scriptClass||[],mesh.scriptClass.push(_this.initClass(window[script],mesh,shader,group,input))):console.warn(`scriptClass ${script} not found`)})):window[scriptClass]?mesh.scriptClass=_this.initClass(window[scriptClass],mesh,shader,group,input):console.warn(`scriptClass ${scriptClass} not found`)),input.onUpdate=key=>{switch(key){case"name":group.setLabel(input.get(key));break;case"visible":mesh.visible=input.get(key);break;case"renderOrder":mesh.renderOrder=_this.baseRenderOrder+input.getNumber(key);break;case"transparent":shader.transparent=input.get(key);break;case"depthWrite":shader.depthWrite=input.get(key);break;case"depthTest":shader.depthTest=input.get(key);break;case"side":shader.side=input.get(key);break;case"blending":shader.blending=input.get(key)}}}function addListeners(){_this.events.sub(SceneLayout.BREAKPOINT,e=>_this.localBreakpoint?null:setBreakpoint(e))}function setBreakpoint({value:value}){value!=_breakpoint&&(_breakpoint=value,_breakpoints.forEach(mesh=>{mesh.prefix=mesh.prefix.split("-")[0]+"-"+_breakpoint,"-"==mesh.prefix.charAt(mesh.prefix.length-1)&&(mesh.prefix=mesh.prefix.slice(0,-1)),new MeshUILConfig(mesh)}))}async function ready(){await _this.wait(_this,"loaded"),UIL.sidebar&&UIL.sidebar.toolbar.hideAll()}function copyFolderProps(from,to){let mesh,params,shader;to.forEachFolder(child=>{switch(child.label){case"Parameters":params=child;break;case"Mesh":mesh=child;break;case"Shader":shader=child}});let allowed=["Parameters","Mesh","Shader"];from.forEachFolder(child=>{if(!(allowed.indexOf(child.label)<0))switch(child.toClipboard(),child.label){case"Parameters":params.fromClipboard();break;case"Mesh":mesh.fromClipboard();break;case"Shader":shader.fromClipboard()}})}this.isSceneLayout=!0,this.name=_name,async function(){_this.group.sceneLayout=_this,await initialize(defer()),SceneLayout.getTexture||(SceneLayout.getTexture=Utils3D.getTexture),initGraph(),initParams(),initialize(initConfig()),initData(),addListeners(),ready()}(),this.ready=async function(early){if(await _this.wait(_this,"loaded"),await _this.wait(_this,"configured"),early)return!0;await defer(),await defer()},this.getLayer=async function(name){let timer;return Hydra.LOCAL&&(timer=_this.delayedCall(_=>{_exists[name]||console.warn(`${name} doesn't exist in SceneLayout ${_name}`)},1e3)),await _this.wait(_layers,name),timer&&clearTimeout(timer),_layers[name]},this.getLayers=async function(){let array=[];for(let i=0;i<arguments.length;i++)array.push(_this.getLayer(arguments[i]));return Promise.all(array)},this.getAllLayers=async function(){return await this.ready(),await this.loadedAllLayers(),_layers},this.exists=function(name){return _exists[name]},this._createLayer=function(parentId){createLayer(null,parentId)},this._createGroup=function(parentId){getGroup(`group_${_groupIndex}`,parentId)},this._rename=function(id,name,value){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];folder&&(folder.setLabel(value),folder.params&&folder.params.setValue("name",value),[_groups,_custom,_meshes,_exists,_layers].forEach((function(store){store[name]&&(store[value]=store[name],store[name]=null,delete store[name])})))},this._deleteLayer=function(id,name){id.includes("_")&&(id=(id=id.split("_"))[id.length-1]);let folder=_folders[id]||_folders[`sl_${_name}_${id}`],layer=_layers[id]||_layers[name];return layer&&layer.isGroup&&layer.length>1?(alert("Can't delete a group that has nested layers."),!1):!!confirm("Are you sure you want to delete this layer?")&&(layer&&layer._parent&&(layer._parent.remove(layer),layer._parent=null),folder&&folder.parent&&folder.parent.remove(folder),UILStorage.set(`sl_${_name}_${id}_deleted`,!0),!0)},this._changeParent=function(childId,childName,parentId,parentName){let child=_layers[childId]||_layers[childName],parent=_layers[parentId]||_layers[parentName]||_this;if(!child)return;let folder=_folders[childId]||_folders[`sl_${_name}_${childName}`];folder&&folder.params&&folder.params.setValue("group",parentName||null);let parentObject=parent.group||parent,childObject=child.group||child;parentObject.isObject3D&&childObject.isObject3D&&parentObject.add(childObject),child.updateMatrix&&child.updateMatrix()},this._visible=function(name,visible){let mesh=_layers[name];mesh&&(mesh.group&&(mesh=mesh.group),mesh.visible=visible)},this._focus=function(name){UIL.sidebar.toolbar.filterSingle(name)},this._blur=function(name){let folder=_folders[name]||_folders[`sl_${_name}_${name}`];folder&&folder.forEachFolder&&(folder.forEachFolder(f=>f.close()),folder.close())},this._sort=function(order){order.forEach((label,index)=>{label.children&&label.children.forEach((function(child,j,all){let folder=_folders[child];if(!folder||!folder.params)return;let renderOrder=_this.baseRenderOrder+index+(j+1)/(all.length+1);folder.params.setValue("renderOrder",renderOrder-_this.baseRenderOrder);let mesh=_layers[child]||_layers[folder.label];mesh&&(mesh.renderOrder=renderOrder)}));let folder=_folders[label];if(!folder||!folder.params)return;let renderOrder=_this.baseRenderOrder+index;folder.params.setValue("renderOrder",renderOrder-_this.baseRenderOrder);let mesh=_layers[label]||_layers[folder.label];mesh&&(mesh.renderOrder=renderOrder)})},this._duplicateLayer=function(id,parentId){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];folder&&(createLayer(null,parentId),copyFolderProps(folder,Object.values(_folders).last()))},this._duplicateGroup=function(id,children){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;let copyId=`group_${_groupIndex+1}`;getGroup(copyId),copyFolderProps(folder,Object.values(_folders).last()),children.forEach(childId=>{_this._duplicateLayer(childId,copyId)})},this._getCinemaConfig=async function(){let _cinemaConfig=_config.get("Cinema Config").replace(".json","");return await get(Assets.getPath(`assets/geometry/${_cinemaConfig}.json`))},this._applyCinemaConfig=function(id,params){let folder=_folders[id]||_folders[`sl_${_name}_${id}`];if(!folder)return;let mesh=folder.getAll().filter(sub=>"Mesh"==sub.label)[0];if(params.geometry&&folder.params.setValue("geometry",params.geometry.replace("assets/geometry/","")),["position","quaternion","scale"].forEach(transform=>{if(params[transform]){let value=JSON.parse(params[transform]);if("quaternion"==transform){let quat=(new Quaternion).fromArray(value);value=(new Euler).setFromQuaternion(quat).toArray().slice(0,3).map(angle=>180*angle/Math.PI),transform="rotation"}mesh.getAll().filter(control=>control.label==transform)[0].force(value)}}),params.visible&&"false"===params.visible&&!params.geometry&&(folder.params.setValue("geometry","World.PLANE"),folder.params.setValue("side","shader_double_side"),!Global.PLAYGROUND)){_meshes[folder.params.get("name")].shader.neverRender=!0}params.shader&&folder.params.setValue("shader",params.shader)},this.loadedAllLayers=async function(){return await _this.ready(),Promise.all(_promises)},this.set("breakpoint",value=>{_this.localBreakpoint=!0,setBreakpoint({value:value})}),this.get("breakpoint",_=>_breakpoint),this.get("layers",_=>_layers),this.get("layerCount",_=>_data.layers),this.onDestroy=function(){_this.textures&&!_options.persistTextures&&_this.textures.forEach(t=>{t.destroy&&t.destroy()})},this.addInitializer=function(callback){_initializers.push(callback)},this._completeInitialization=async function(sync){if(!_initializers.length)return!0;for(let i=0;i<_initializers.length;i++)await _initializers[i](sync);_initializers.length=0}}),_=>{SceneLayout.BREAKPOINT="sl_breakpoint",SceneLayout.setBreakpoint=function(value){SceneLayout.breakpoint!==value&&(SceneLayout.breakpoint=value,Events.emitter._fireEvent(SceneLayout.BREAKPOINT,{value:value}))}}),Class((function SceneLayoutPreloader(_name){Inherit(this,Component);function findMatch(src){for(let i=ASSETS.length-1;i>-1;i--)if(ASSETS[i].includes(src))return!0;return!1}this.load=function(name){let ext,promise=Promise.create(),array=[],settings_dxt=!!Renderer.extensions.s3tc,settings_etc=!!Renderer.extensions.etc1,settings_pvrtc=!!Renderer.extensions.pvrtc,settings_astc=!!Renderer.extensions.astc;settings_dxt?ext="dxt":settings_etc?ext="astc":settings_pvrtc?ext="pvrtc":settings_astc&&(ext="astc");let keys=UILStorage.getKeys(),i=0,worker=new Render.Worker(_=>{let key=keys[i];if(!key)return worker.stop(),void Promise.all(array).then(promise.resolve);if(key.includes(name)){let val=UILStorage.get(key);if(!val.includes)return i++;if(val.includes(".json"))key.includes("geometry")?findMatch(val.split("assets/")[1])&&array.push(GeomThread.loadGeometry(val,null,!0)):(val.includes("assets/")||(val="assets/geometry/"+val),findMatch(val.split("assets/")[1])&&array.push(fetch(val).catch(e=>{})));else if(val.includes("src")){let obj=JSON.parse(val),src=obj.src;obj.compressed&&(src=src.split(".")[0]+"-"+ext+".kxt"),findMatch(src.split("assets/")[1])&&array.push(fetch(src).catch(e=>{}))}}i++},1);return promise}}),"static"),Class((function Scroll(_object,_params){Inherit(this,Component);const _this=this;this.x=0,this.y=0,this.max={x:0,y:0},this.delta={x:0,y:0},this.enabled=!0;const _scrollTarget={x:0,y:0},_scrollInertia={x:0,y:0};let _axes=["x","y"];var _lastDelta,_deltaChange=0;function loop(){_this.object&&(Math.round(_this.object.div.scrollLeft)===Math.round(_this.x)&&Math.round(_this.object.div.scrollTop)===Math.round(_this.y)||(_this.x=_scrollTarget.x=_this.object.div.scrollLeft,_this.y=_scrollTarget.y=_this.object.div.scrollTop,stopInertia())),_axes.forEach(axis=>{_this.isInertia&&(_scrollInertia[axis]*=.9,_scrollTarget[axis]+=_scrollInertia[axis]),_this.limit&&(_scrollTarget[axis]=Math.max(_scrollTarget[axis],0)),_this.limit&&(_scrollTarget[axis]=Math.min(_scrollTarget[axis],_this.max[axis]/_this.scale)),_this.delta[axis]=_this.flag("block")?0:.5*(_scrollTarget[axis]*_this.scale-_this[axis]),_this[axis]+=_this.delta[axis],Math.abs(_this.delta[axis])<.01&&(_this.delta[axis]=0),Math.abs(_this[axis])<.001&&(_this[axis]=0),_this.flag("block")&&(_scrollTarget[axis]=0,_this.delta[axis]=0,_this[axis]=0),_this.object&&("x"==axis&&(_this.object.div.scrollLeft=Math.round(_this.x)),"y"==axis&&(_this.object.div.scrollTop=Math.round(_this.y)))})}function stopInertia(){_this.isInertia=!1,clearTween(_scrollTarget)}function edgeScroll(e){"touch"===e.pointerType&&_this.enabled&&(e.preventDefault&&e.preventDefault(),_axes.forEach(axis=>{let dir=axis.toUpperCase(),delta=`offset${dir}`,diff=(_this[`ieDelta${dir}`]||e[delta])-e[delta];_scrollTarget[axis]+=diff,_scrollInertia[axis]=diff,_this.isInertia=!0,_this[`ieDelta${dir}`]=e[delta]}),_this.onUpdate&&_this.onUpdate(),_this.events.fire(Events.UPDATE,_scrollInertia))}function edgeScrollEnd(){_this.ieDeltaX=!1,_this.ieDeltaY=!1}function scroll(e){if(!_this.enabled)return;if(e.preventDefault&&e.preventDefault(),!_this.mouseWheel)return;stopInertia();let newDelta=0;_axes.forEach(axis=>{let delta="delta"+axis.toUpperCase();if("mac"==Device.system.os){if("firefox"==Device.system.browser)return 1===e.deltaMode?(_scrollTarget[axis]+=4*e[delta],_scrollInertia[axis]=4*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])):void(_scrollTarget[axis]+=e[delta]);if(Device.system.browser.includes(["chrome","safari"]))return _scrollTarget[axis]+=.33*e[delta],_scrollInertia[axis]=.33*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}if("windows"==Device.system.os){if("firefox"==Device.system.browser&&1===e.deltaMode)return _scrollTarget[axis]+=10*e[delta],_scrollInertia[axis]=10*e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis]);if(Device.system.browser.includes(["chrome"])){let s=.025;return _scrollTarget[axis]+=e[delta]*s,_scrollInertia[axis]=e[delta]*s,_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}if("ie"==Device.system.browser)return _scrollTarget[axis]+=e[delta],_scrollInertia[axis]=e[delta],_this.isInertia=!0,void(newDelta=_scrollInertia[axis])}_scrollTarget[axis]+=e[delta],newDelta=_scrollInertia[axis]}),newDelta=Math.abs(newDelta),newDelta!=_lastDelta&&_deltaChange++,_this.flag("hardBlock")||(_deltaChange>3?newDelta>_lastDelta&&_this.flag("block",!1):newDelta>=_lastDelta&&_this.flag("block",!1)),_lastDelta=newDelta,_this.onUpdate&&_this.onUpdate(),_this.events.fire(Events.UPDATE,_scrollInertia)}function down(){_this.enabled&&stopInertia()}function drag(){_this.enabled&&(_axes.forEach(axis=>{let newDelta=Math.abs(Mouse.delta[axis]);_this.flag("hardBlock")||newDelta>_lastDelta&&_this.flag("block",!1),_lastDelta=newDelta,_scrollTarget[axis]-=Mouse.delta[axis]}),_this.events.fire(Events.UPDATE))}function up(){if(!_this.enabled||_this.preventInertia)return;const m="android"==Device.system.os?35:25,obj={};_axes.forEach(axis=>{obj[axis]=_scrollTarget[axis]-Mouse.delta[axis]*m}),tween(_scrollTarget,obj,2500,"easeOutQuint")}function resize(){if(!_this.enabled)return;if(stopInertia(),!_this.object)return;const p={};Device.mobile&&_axes.forEach(axis=>p[axis]=_this.max[axis]?_scrollTarget[axis]/_this.max[axis]:0),void 0===_params.height&&(_this.max.y=_this.object.div.scrollHeight-_this.object.div.clientHeight),void 0===_params.width&&(_this.max.x=_this.object.div.scrollWidth-_this.object.div.clientWidth),Device.mobile&&_axes.forEach(axis=>_this[axis]=_scrollTarget[axis]=p[axis]*_this.max[axis])}!function initParams(){_object&&_object.div||(_params=_object,_object=null),_params||(_params={}),_this.object=_object,_this.hitObject=_params.hitObject||_this.object,_this.max.y=_params.height||0,_this.max.x=_params.width||0,_this.scale=_params.scale||1,_this.drag=void 0!==_params.drag?_params.drag:!!Device.mobile,_this.mouseWheel=!1!==_params.mouseWheel,_this.limit="boolean"==typeof _params.limit&&_params.limit,Array.isArray(_params.axes)&&(_axes=_params.axes)}(),_this.object&&function style(){_this.object.css({overflow:"auto"})}(),function addHandlers(){if(Device.mobile||("ie"===Device.system.browser&&Device.system.browserVersion>=17&&(document.body.addEventListener("pointermove",edgeScroll,!0),document.body.addEventListener("pointerup",edgeScrollEnd,!0)),"ie"==Device.system.browser?document.body.addEventListener("wheel",scroll,!0):__window.bind("wheel",scroll)),_this.drag){_this.hitObject&&_this.hitObject.bind("touchstart",e=>e.preventDefault());let input=_this.hitObject?_this.initClass(Interaction,_this.hitObject):Mouse.input;_this.events.sub(input,Interaction.START,down),_this.events.sub(input,Interaction.DRAG,drag),_this.events.sub(input,Interaction.END,up)}_this.events.sub(Events.RESIZE,resize)}(),resize(),_this.startRender(loop),this.reset=function(){return _this.object&&_this.object.div&&(_this.object.div.scrollLeft=_this.x=0,_this.object.div.scrollTop=_this.y=0),_scrollTarget.x=_scrollTarget.y=0,_scrollInertia.x=_scrollInertia.y=0,stopInertia(),this},this.onDestroy=function(){__window.unbind("wheel",scroll)},this.resize=resize,this.scrollTo=function(value,axis="y"){let values={};values[axis]=value,tween(_scrollTarget,values,800,"easeInOutCubic")},this.blockUntilNewScroll=function(){return _this.reset(),_this.flag("block",!0),_this.flag("hardBlock",!0,200),this},this.stopInertia=stopInertia}),_=>{var _scroll;Scroll.createUnlimited=Scroll.getUnlimited=function(options){return _scroll||(_scroll=new Scroll({limit:!1,drag:Device.mobile})),_scroll}}),Class((function SentryDebug(){!async function(){window.Sentry&&(await Hydra.ready(),await GPU.ready(),Sentry.configureScope((function(scope){if(scope.setExtra("gpu",`${Device.graphics.webgl?Device.graphics.webgl.gpu:"WEBGL UNAVAILABLE"}`),scope.setExtra("gpu_tier",`${Device.mobile?GPU.M_TIER:GPU.TIER}`),scope.setExtra("webgl_version",`${Device.graphics.webgl?Device.graphics.webgl.version:"WEBGL UNAVAILABLE"}`),scope.setExtra("mobile",`${JSON.stringify(Device.mobile).split(":").join(": ")}`),scope.setExtra("system",`${JSON.stringify(Device.system).split(":").join(": ")}`),scope.setExtra("user_agent",Device.agent),scope.setExtra("dpr",Device.pixelRatio),scope.setExtra("refresh_rate",Render.REFRESH_RATE),scope.setExtra("user_agent",Device.agent),scope.setExtra("screen_size",`${screen.width} x ${screen.height}`),scope.setExtra("stage_size",`${Stage.width} x ${Stage.height}`),Tests)for(let key in Tests)scope.setExtra("test_"+key,Tests[key]())})))}()}),"static"),Class((function Shaders(){Inherit(this,Component);var _this=this;function parseSingleShader(code,fileName){let uniforms=code.split("#!UNIFORMS")[1].split("#!")[0],varyings=code.split("#!VARYINGS")[1].split("#!")[0],attributes=code.split("#!ATTRIBUTES")[1].split("#!")[0];for(;code.includes("#!SHADER");){let split=(code=code.slice(code.indexOf("#!SHADER"))).split("#!SHADER")[1],br=split.indexOf("\n"),name=split.slice(0,br).split(": ")[1];name.slice(0,6).includes("Vertex")&&(name=fileName.split(".")[0]+".vs"),name.slice(0,8).includes("Fragment")&&(name=fileName.split(".")[0]+".fs");let glsl=split.slice(br);glsl=name.includes(".vs")?attributes+uniforms+varyings+glsl:uniforms+varyings+glsl;let splitName=name.split(".");_this[splitName[0]+(splitName[1].includes("vs")?".vs":".fs")]=glsl,code=code.replace("#!SHADER","$")}}function parseCompiled(shaders){var split=shaders.split("{@}");split.shift();for(var i=0;i<split.length;i+=2){var name=split[i],text=split[i+1];text.includes("#!UNIFORMS")?parseSingleShader(text,name):_this[name]=text}}function parseRequirements(){for(var key in _this){var obj=_this[key];"string"==typeof obj&&(_this[key]=require(obj))}}function require(shader){if(!shader.includes("require"))return shader;for(shader=shader.replace(/# require/g,"#require");shader.includes("#require");){var name=shader.split("#require(")[1].split(")")[0];if(name=name.replace(/ /g,""),!_this[name])throw"Shader required "+name+", but not found in compiled shaders.\n"+shader;shader=shader.replace("#require("+name+")",_this[name])}return shader}this.parse=function(code,file){code.includes("{@}")?(parseCompiled(code),parseRequirements()):(file=(file=file.split("/"))[file.length-1],_this[file]=code),_this.shadersParsed=!0},this.onReady=this.ready=function(callback){let promise=Promise.create();return callback&&promise.then(callback),_this.wait(()=>promise.resolve(),_this,"shadersParsed"),promise},this.getShader=function(string){_this.FALLBACKS&&_this.FALLBACKS[string]&&(string=_this.FALLBACKS[string]);var code=_this[string];if(!code)throw`No shader ${string} found`;for(;code.includes("#test ");)try{var test=code.split("#test ")[1],name=test.split("\n")[0],glsl=code.split("#test "+name+"\n")[1].split("#endtest")[0];eval(name)||(code=code.replace(glsl,"")),code=code.replace("#test "+name+"\n",""),code=code.replace("#endtest","")}catch(e){throw"Error parsing test :: "+string}return code}}),"static"),Class((function Share(){const _this=this,DOWNLOAD_FILENAME="download.png";function url(u){return u||`${location.protocol}//${location.host}${location.pathname}`}this.native=function(u,text){Track.event("Share","click","native");let obj={url:url(u)};if(text&&(obj.text=text),_this.supports.native)return window.navigator.share(obj)},this.facebook=function(u){Track.event("Share","click","facebook"),open(`https://www.facebook.com/sharer?u=${url(u)}`,"_blank","height=555,width=577,scrollbars=yes")},this.twitter=function(u,text){Track.event("Share","click","twitter"),open(`https://twitter.com/share?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url(u))}`,"_blank","height=555,width=577,scrollbars=yes")},this.email=function(subject,body,u){Track.event("Share","click","email"),window.location.href=`mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body+url(u))}`},this.copy=function(url){Track.event("Share","click","link"),Utils.copyToClipboard(url)},this.download=async function(image){return Track.event("Share","click","download"),Device.mobile||"ie"===Device.system.browser?open(image):function download(image){var link=document.createElement("a");link.setAttribute("href",image),link.setAttribute("target","_blank"),link.setAttribute("download",DOWNLOAD_FILENAME),link.style.display="none","firefox"===Device.system.browser?(document.body.appendChild(link),link.click(),document.body.removeChild(link)):link.click()}(image)},this.supports={native:!!window.navigator.share&&Device.mobile},this.imageLinkToDataURL=async function(src){let promise=Promise.create(),image=new Image;return image.crossOrigin="anonymous",image.src=src,image.onload=function(){var canvas=document.createElement("canvas");canvas.width=1200,canvas.height=628,canvas.getContext("2d").drawImage(image,0,0);var dataURL=canvas.toDataURL("image/png");promise.resolve(dataURL)},promise}}),"static"),Class((function StageLayout(_name,_options={}){Inherit(this,Component);const _this=this;var _dataStore,_data,$create;const GLUI=_options.glui;var _uil=getTopLevelUIL(),_folders={},_layers={},_exists={},_resize=[],_graph,_config;function getTopLevelUIL(){let uil=UIL.sidebar;return!_options.uil&&_this.parent&&uil&&Utils.getConstructorName(_this.parent)!=Global.PLAYGROUND&&(uil=new UILFolder(`stl_${_name}_nested`,{label:`${_name.capitalize()} (Nested)`,closed:!0}),UIL.sidebar&&UIL.sidebar.add(uil)),uil}function createFolder(name){let folder=new UILFolder(`stl_${_name}_${name}`,{label:name,closed:!0});return _folders[`stl_${_name}_${name}`]=folder,folder}async function initGraph(){_options.noGraph||!window.UILGraph||StageLayout.noGraph||(_graph=UILGraph.instance().getGraph(_name,_this,!!GLUI))&&(UIL.sidebar.element.show(),Global.PLAYGROUND&&(Utils.getConstructorName(_this.parent),Global.PLAYGROUND),_graph.open())}function initParams(){_options.rootPath?"/"!=_options.rootPath.charAt(_options.rootPath.length-1)&&(_options.rootPath+="/"):_options.rootPath="",_this.baseZ=_options.baseZ||0,_this.data=_options.data,_options.uil&&(_uil=_options.uil),GLUI?(_this.element=$gl(1,1),_this.element.stageLayout=_this):(_this.element=$("StageLayout_"+_name),_this.element.size("100%"))}async function initData(){if(await UILStorage.ready(),_dataStore=InputUIL.create(`stagelayout_${_name}`,null),void 0===(_data=JSON.parse(_dataStore.get("data")||"{}")).layers&&(_data.layers=-1),_options.perFrame)_data.layers>0&&createLayers();else{for(let i=0,c=_data.layers+1;i<c;i++)createLayer(i);_this.loaded=!0}}function initRoot(){let name=_name+"Root",group=_uil?createFolder(name):null,$obj=_this.element,input=InputUIL.create(`Config_${name}_${_name}`,group);if(input.setLabel("Parameters"),input.add("size").addTextarea("fontStyle").addTextarea("css",GLUI?"hidden":void 0).add("onResize","hidden"),input.add("compiled","hidden"),input.add("Figma Config"),_config=input,!group)return createCompiledLayer(`${name}_${_name}`,input);StageLayoutUtil.create(`${name}_${_name}`),group.hide(),group.setLabel(name);let size=input.get("size"),css=input.get("css"),resizeCode=(input.get("fontStyle"),input.get("onResize")),doCSS=change=>{if(GLUI)return;css=css||"";let obj={},objSave={};css=css.split("\n"),css.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1],valSave=val;val&&(val=parseData(val.replace(/ /g,""))),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),valSave&&(valSave=valSave.replace(/ /g,"")),objSave[key]=isNaN(Number(valSave))?valSave:Number(valSave))}),change&&StageLayoutUtil.save("css",objSave,input),$obj.css(obj)},doSize=change=>{if(size){let s=parseData(size).replace(/ /g,"").split(","),s0=s[0].includes("%")?s[0]:Number(s[0])||s[0],s1=s[1].includes("%")?s[1]:Number(s[1])||s[1];$obj.size(s0,s1),change&&StageLayoutUtil.save("size",[s0,s1],input)}else $obj.size(100,100)},doResize=change=>{if(resizeCode){let fn=new Function("$this",resizeCode);_resize.push({fn:fn,$obj:$obj}),fn($obj)}},doFont=change=>{let fontStyle=parseData(input.get("fontStyle"));fontStyle&&(fontStyle=fontStyle.split("\n"),$obj.fontStyle(fontStyle[0],Number(fontStyle[1]),fontStyle[2],fontStyle[3]),change&&StageLayoutUtil.save("fontStyle",fontStyle,input))};doCSS(),doSize(),doFont(),doResize(),input.onUpdate=key=>{switch(key){case"css":css=input.get("css"),doCSS(!0);break;case"size":size=input.get("size"),doSize(!0);break;case"onResize":resizeCode=input.get("onResize"),doResize();break;case"fontStyle":doFont(!0)}},group.params=input,_graph&&_graph.addSpecial(group.id,name,"Root"),_uil.add(group),(_=>{let folder=new UILFolder(`stl_${_name}_${name}_resize`,{label:"Resize Logic",closed:!0}),button=new UILControlButton("button",{actions:[{title:"Open Editor",callback:_=>{let editor=new UILWindow(_name,{label:"Resize Logic",height:"auto",drag:!0}),text=new UILControlTextarea(`stl_${_name}_${name}_resize`,{label:"Resize",value:input.get("onResize"),monospace:!0,rows:10,resize:"both",minWidth:400,hideLabel:!0,tab:!0});editor.add(text),text.onFinishChange(value=>input.setValue("onResize",value)),UIL.add(editor)}}],hideLabel:!0});folder.add(button),group.add(folder)})()}function createLayers(){let index=0,renderWorker=new Render.Worker((function(){createLayer(index),index++==_data.layers&&(renderWorker.stop(),_this.loaded=!0)}),_options.perFrame)}function parseData(text){if(!text||"string"!=typeof text||!text.includes("$DATA"))return text;for(;text.includes("$DATA");){let code=text.split("$DATA")[1].split(" ")[0].split("\n")[0],line="$DATA"+code;text=text.replace(line,eval(line.replace("$DATA","_options.data")))}return text}async function createCompiledLayer(key,input){let compiled=StageLayoutUtil.getCompiled(key);if(!compiled)return;let $obj,name=input.get("name"),text=input.get("text");GLUI?($obj=text?$glText(parseData(text),null,null,compiled.fontStyle):$gl(1,1,parseData(input.get("bg"))),$obj.name=name):$obj=key==`${_name}Root_${_name}`?_this.element:$(name||"Layer",parseData(input.get("type")||"div"));let nestedGroup=input.get("group");if(nestedGroup){let layer;layer=nestedGroup===_name?_this.element:await _this.getLayer(nestedGroup),layer.add($obj)}else _this.element!=$obj&&_this.element.add($obj);if(Global.PLAYGROUND&&($obj._input=input),_layers[name]=$obj,_exists[name]=!0,compiled.css&&$obj.css){for(let key in compiled.css)compiled.css[key]=parseData(compiled.css[key]);$obj.css(compiled.css)}if(compiled.transform){for(let key in compiled.transform)$obj[key]=compiled.transform[key];$obj.transform&&$obj.transform()}if(compiled.size&&$obj.size(compiled.size[0],compiled.size[1]),compiled.attributes&&$obj.attr)for(let key in compiled.attributes)$obj.attr(key,parseData(compiled.attributes[key]));if(!GLUI){let bg=input.get("bg");bg&&$obj.bg(parseData(bg)||"#ff0000")}if(!GLUI){if(text){text=parseData(text);let helper=compiled.helper;if(helper){let helperName=helper.split("(")[0],args=helper.split("(")[1];args?(args=args.replace(")","").replace(/,\ /g,",").split(","),args.forEach((function(arg,i){"$text"==arg&&(args[i]=text)})),args.indexOf(text)<0&&args.unshift(text)):args=[text];let helperFn=_options[helperName]||StageLayout.helpers[helperName];return helperFn?void $obj.html(helperFn.apply(null,args)):console.warn(`No helper function ${helperName} found.`)}text.includes(["</","/>"])?$obj.html(text):$obj.text(text)}let fs=compiled.fontStyle;fs&&$obj.fontStyle(fs[0],Number(fs[1]),fs[2],fs[3])}let zIndex=input.getNumber("zIndex");"number"==typeof zIndex&&$obj&&$obj.setZ&&!isNaN(zIndex)&&$obj.setZ(zIndex),compiled.resize&&(_resize.push({$obj:$obj,fn:compiled.resize}),compiled.resize($obj));let customClass=input.get("customClass");if(customClass){let Class=window[customClass];if(customClass.includes(".")){let split=customClass.split(".");Class=window[split[0]]&&window[split[0]][split[1]]}if(!Class)return console.warn(`No custom class ${customClass} found.`);_layers[name]=_this.initClass(Class,$obj,_options.data,input)}}async function createLayer(index,groupName){let id="number"==typeof index?index:++_data.layers;if(UILStorage.get(`stl_${_name}_${id}_deleted`))return;let $obj,group=_uil?createFolder(id):null,input=InputUIL.create(`Config_${id}_${_name}`,group);if(input.setLabel("Parameters"),input.add("name").add("type",GLUI?"hidden":void 0).add("bg").add("size").add("group").add("customClass").add("wildcard").add("helper",GLUI?"hidden":void 0).add("zIndex","hidden").addTextarea("attributes",GLUI?"hidden":void 0).addTextarea("text").addTextarea("fontStyle").addTextarea("css",GLUI?"hidden":void 0).addTextarea("transform").add("onResize","hidden"),input.add("compiled","hidden"),!group)return createCompiledLayer(`${id}_${_name}`,input);StageLayoutUtil.create(`${id}_${_name}`),groupName&&input.setValue("group",groupName);let name=input.get("name")||id+"",size=input.get("size"),bg=input.get("bg"),css=input.get("css"),transform=input.get("transform"),type=input.get("type"),attributes=input.get("attributes"),text=input.get("text"),nestedGroup=(input.get("fontStyle"),input.get("group")),resizeCode=input.get("onResize"),zIndex=input.getNumber("zIndex"),customClass=input.get("customClass"),helper=input.get("helper");input.get("wildcard");group.setLabel(name),group.params=input;let getGLUIFontObject=_=>{let font=input.get("fontStyle")||"",obj={};return font=font.split("\n"),font.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),"false"===val&&(obj[key]=!1),"true"===val&&(obj[key]=!0))}),obj};if($obj=GLUI?text?$glText(parseData(text),null,null,getGLUIFontObject()):$gl(1,1,(_=>bg?parseData(bg):bg||name?void 0:"assets/images/_scenelayout/uv.jpg")()):$(name||"Layer",parseData(type)),$obj._uil=group,nestedGroup){let layer;layer=nestedGroup===_name?_this.element:await _this.getLayer(nestedGroup),layer.add&&layer.add($obj),group&&_uil.add(group)}else _this.element.add($obj),group&&_uil.add(group);_graph&&_graph.addGroup(group.id,name||id+"",nestedGroup),(_=>{let folder=new UILFolder(`stl_${_name}_${name}_resize`,{label:"Resize Logic",closed:!0}),button=new UILControlButton("button",{actions:[{title:"Open Editor",callback:_=>{let editor=new UILWindow(_name,{label:"Resize Logic",height:"auto",drag:!0}),text=new UILControlTextarea(`stl_${_name}_${name}_resize`,{label:"Resize",value:input.get("onResize"),monospace:!0,rows:10,resize:"both",minWidth:400,hideLabel:!0,tab:!0});editor.add(text),text.onFinishChange(value=>input.setValue("onResize",value)),UIL.add(editor)}}],hideLabel:!0});folder.add(button),group.add(folder)})(),Global.PLAYGROUND&&($obj._input=input),_layers[name]=$obj,_exists[name]=!0;let doBG=change=>{GLUI?change&&$obj.bg(parseData(bg)):(bg||!bg&&!name)&&$obj.bg(parseData(bg)||"#ff0000")},doType=change=>{GLUI||change&&StageLayoutUtil.save("type",{type:type},input)},doCSS=change=>{if(GLUI)return;css=css||"";let obj={};css=css.split("\n"),css.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=parseData(val.replace(/ /g,""))),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val))}),change&&StageLayoutUtil.save("css",obj,input),$obj.css(obj)},doTransform=change=>{transform=transform||"";let obj={};transform=transform.split("\n"),transform.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=$obj[key]=isNaN(Number(val))?val:Number(val))}),change&&StageLayoutUtil.save("transform",obj,input),GLUI||$obj.transform()},doResize=change=>{if(resizeCode){let fn=new Function("$this",resizeCode);_resize.push({fn:fn,$obj:$obj}),fn($obj)}},doSize=change=>{if(size){let s=parseData(size).replace(/ /g,"").split(","),s0=Number(s[0])||s[0],s1=Number(s[1])||s[1];$obj.size(s0,s1),change&&StageLayoutUtil.save("size",[s0,s1],input)}else $obj.size(100,100)},doAttributes=change=>{if(GLUI)return;attributes=attributes||"";let obj={};attributes.split("\n").forEach((function(line,i){let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),obj[key]=val,val=parseData(val),$obj.attr(key,val)})),change&&StageLayoutUtil.save("attributes",obj,input)},doText=change=>{if(text=parseData(text),GLUI){if(!text)return $obj;if($obj instanceof GLUIObject)return $obj;let fontStyle=getGLUIFontObject();change&&StageLayoutUtil.save("fontStyle",fontStyle,input),$obj.setText(text,fontStyle),fontStyle.color&&$obj.setColor(fontStyle.color)}else{let fontStyle=parseData(input.get("fontStyle"));if(fontStyle?(fontStyle=fontStyle.split("\n"),$obj.fontStyle(fontStyle[0]||"",Number(fontStyle[1]),fontStyle[2],fontStyle[3]),change&&StageLayoutUtil.save("fontStyle",fontStyle,input)):change&&StageLayoutUtil.save("fontStyle","",input),!text)return;if(helper){let helperName=helper.split("(")[0],args=helper.split("(")[1];args?(args=args.replace(")","").replace(/,\ /g,",").split(","),args.forEach((function(arg,i){"$text"==arg&&(args[i]=text)})),args.indexOf(text)<0&&args.unshift(text)):args=[text];let helperFn=_options[helperName]||StageLayout.helpers[helperName];return helperFn?($obj.html(helperFn.apply(null,args)),void StageLayoutUtil.save("helper",helper,input)):console.warn(`No helper function ${helperName} found.`)}text.includes(["</","/>"])?$obj.html(text):$obj.text(text)}},doZ=_=>{"number"==typeof zIndex&&$obj.setZ(zIndex)};if(doType(),doCSS(),doBG(),doSize(),doAttributes(),doTransform(),doText(),doResize(),doZ(),input.onUpdate=key=>{switch(key){case"name":group.setLabel(input.get("name"));break;case"type":type=input.get("type"),doType(!0);break;case"css":css=input.get("css"),doCSS(!0);break;case"size":size=input.get("size"),doSize(!0);break;case"attributes":attributes=input.get("attributes"),doAttributes(!0);break;case"transform":transform=input.get("transform"),doTransform(!0);break;case"onResize":resizeCode=input.get("onResize"),doResize();break;case"text":case"fontStyle":text=input.get("text"),doText(!0);break;case"bg":bg=input.get("bg"),doBG(!0);break;case"zIndex":zIndex=input.getNumber("zIndex")||0,doZ()}},customClass){let Class=window[customClass];if(customClass.includes(".")){let split=customClass.split(".");Class=window[split[0]]&&window[split[0]][split[1]]}if(!Class)return console.warn(`No custom class ${customClass} found.`);_layers[name]=_this.initClass(Class,$obj,_options.data,input,group)}return"number"!=typeof index&&_dataStore.setValue("data",JSON.stringify(_data)),$obj}function resizeHandler(){_resize.forEach(({$obj:$obj,fn:fn})=>fn($obj))}function sortChild(label,index=0,parent,baseZ,step){let folder=_folders[label.id||label];if(!folder||!folder.params)return;let zIndex=0;zIndex=GLUI&&baseZ!=_this.baseZ?baseZ+(index+1)*step:baseZ+index,folder.params.setValue("zIndex",zIndex),label.children&&label.children.forEach((function(child,j,all){sortChild(child,j,all,zIndex,step/(parent.length+1))}))}function copyFolderProps(from,to){let params;to.forEachFolder(child=>{switch(child.label){case"Parameters":params=child}});let allowed=["Parameters"];from.forEachFolder(child=>{if(!(allowed.indexOf(child.label)<0))switch(child.toClipboard(),child.label){case"Parameters":params.fromClipboard()}})}this.isStageLayout=!0,this.name=_name,_this.onResize(resizeHandler),initParams(),initGraph(),initData(),defer(()=>{initRoot()}),this._createLayer=function(parentId){return createLayer(null,parentId)},this._createGroup=function(parentId){createLayer(null,parentId)},this._rename=function(id,name,value){if(name==value)return;let folder=_folders[id]||_folders[`stl_${_name}_${name}`];folder&&(folder.setLabel(value),folder.params&&folder.params.setValue("name",value),Object.values(_layers).filter(layer=>layer._uil.params.get("group")==name).forEach(layer=>layer._uil.params.setValue("group",value)),[_exists,_layers].forEach((function(store){store[name]&&(store[value]=store[name],store[name]=null,delete store[name])})))},this._deleteLayer=function(id,name){let $obj=_layers[name];if(!$obj)return!1;if($obj.div&&$obj.div.children.length)return alert("Can't delete a group that has nested layers."),!1;if(!confirm("Are you sure you want to delete this layer?"))return;let folder=_folders[id];return _uil.remove(folder),($obj.element||$obj).remove(),UILStorage.set(`${id}_deleted`,!0),!0},this._changeParent=function(childId,childName,parentId,parentName){let child=_layers[childId]||_layers[childName],parent=_layers[parentId]||_layers[parentName]||_this;if(!child)return;child=child.element||child,parent==_this&&(parent=_this.element);let folder=_folders[childId]||_folders[`sl_${_name}_${childName}`];folder&&folder.params&&folder.params.setValue("group",parentName||null),("function"==typeof child.parent?child.parent():child.parent).removeChild(child,!0),parent.add(child)},this._visible=function(name,visible){let $obj=_layers[name];$obj&&$obj.css&&(visible?$obj.css({opacity:1}):$obj.css({opacity:0}))},this._focus=function(name){UIL.sidebar.toolbar.filterSingle(name)},this._blur=function(name){let folder=_folders[name];folder&&folder.forEachFolder&&(folder.forEachFolder(f=>f.close()),folder.close())},this._sort=function(order){order.forEach((function(item,i,all){sortChild(item,i,all,_this.baseZ,1)}))},this._duplicateLayer=function(id,parentId){let folder=_folders[id];if(!folder)return;createLayer(null,parentId);let copy=Object.values(_folders).last();copyFolderProps(folder,copy),parentId&&copy.params.setValue("group",parentId)},this._duplicateGroup=function(id,children,parentId){_this._duplicateLayer(id,parentId);let pid=_data.layers;children.forEach(childId=>{_this._duplicateGroup(childId,_graph.listChildren(childId),pid)})},this._getFigmaConfig=async function(){let _figmaConfig=_config.get("Figma Config").replace(".json","");return await get(Assets.getPath(`assets/data/${_figmaConfig}.json`))},this._applyFigmaConfig=function(id,params,$obj){if("TEXT"===params.type){$obj._input.setValue("text",params.characters);let fontStyle="",align=params.textAlignHorizontal.toLowerCase(),fontName=StageLayout.FIGMA_FONT.DEFAULT,fontScale=1,ptToPixel=.75;console.log(params);let family=StageLayout.FIGMA_FONT[params.fontName.family];if(family){let font=family[params.fontName.style.toLowerCase()];font&&(fontName=font.name,font.scale&&(fontScale=font.scale))}fontName&&(fontStyle+=`font: ${fontName}\n`);params.fontSize;fontStyle+=`size: ${params.fontSize*ptToPixel*fontScale}\n`,fontStyle+=`align: ${align}\n`,"PERCENT"===params.letterSpacing.unit&&params.letterSpacing.value&&(fontStyle+=`letterSpacing: ${params.letterSpacing.value/100*fontScale}\n`),"PERCENT"===params.lineHeight.unit&&params.lineHeight.value&&(fontStyle+=`lineHeight: ${params.lineHeight.value/100}\n`),fontStyle+=`width: ${params.width}\n`,fontStyle+=`height: ${params.height}\n`;let fill=params.fills[0];if(fill&&fill.color){let c=fill.color;fontStyle+=`color: ${new Color(c.r,c.g,c.b).getHexString()}\n`}$obj._input.setValue("fontStyle",fontStyle);let x=params.x;"center"===align?x+=params.width/2:"right"===align&&(x+=params.width);let transform=`x: ${x}\ny: ${params.y}`;params.rotation&&(transform+=`\nrotation: ${params.rotation}`),$obj._input.setValue("transform",transform)}else if("RECTANGLE"===params.type){$obj._input.setValue("size",`${params.width}, ${params.height}`);let fill=params.fills[0];if(!fill)return;if("IMAGE"===fill.type)$obj._input.setValue("bg","assets/images/_scenelayout/uv.jpg");else if("SOLID"===fill.type){let c=fill.color,color=new Color(c.r,c.g,c.b);$obj._input.setValue("bg",color.getHexString())}let transform=`x: ${params.x}\ny: ${params.y}`;params.rotation&&(transform+=`\nrotation: ${params.rotation}`),$obj._input.setValue("transform",transform)}},this.getLayer=async function(name){let timer;return Hydra.LOCAL&&(timer=_this.delayedCall(_=>{_exists[name]||"mockup"===name||console.warn(`${name} doesn't exist in StageLayout ${_name}`)},1e3)),await _this.wait(_layers,name),timer&&clearTimeout(timer),_layers[name]},this.getLayers=async function(){let array=[];for(let i=0;i<arguments.length;i++)array.push(_this.getLayer(arguments[i]));return Promise.all(array)},this.getAllLayers=async function(){return await this.ready(),_layers},this.ready=async function(){await _this.wait(_this,"loaded"),await defer()}}),()=>{StageLayout.FIGMA_FONT={},StageLayout.helpers={}}),Class((function StageLayoutCapture(_layout,_w,_h,_rtPool){Inherit(this,Component);const _this=this;var _rt,_camera,_hitCamera,_interaction,$glObj,_scene=new Scene,_mouse=new Vector2,_stage=new Vector2,_enabled=!0,_width=_w,_height=_h;function loop(force){if(!_enabled&&!force)return;let clearAlpha=World.RENDERER.getClearAlpha();World.RENDERER.setClearAlpha(0),World.RENDERER.render(_scene,_camera,_rt),World.RENDERER.setClearAlpha(clearAlpha)}function noop(){}function hitUpdate(hit){let x=hit.uv.x*_width,y=(1-hit.uv.y)*_height;_mouse.set(x,y),_enabled&&_interaction.testWith(_mouse)}this.scene=_scene,function(){let dpr=RenderManager.DPR;_rtPool?_this.rt=_rtPool.nullRT:(_rt=Utils3D.createRT(_width*dpr,_height*dpr,null,Texture.RGBAFormat),_this.rt=_rt),_scene.add(_layout.element.group),(_camera=new OrthographicCamera).setViewport(_width,_height),_camera.position.z=1,_camera.position.x=_width/2,_camera.position.y=-_height/2,_stage.set(_width,_height),function findHitCamera(){let p=_this.parent;for(;p;)p instanceof FXScene&&(_hitCamera=p.camera),p=p.parent;_hitCamera=World.CAMERA}(),_interaction=_this.initClass(GLUIStageInteraction2D,_camera,_scene,_stage),_this.startRender(_=>loop())}(),this.onVisible=function(){_rtPool&&(_rt=_this.rt=_rtPool.getRT())},this.onInvisible=function(){_rtPool&&_rtPool.putRT(_rt)},this.setSize=function(width,height){_width=width,_height=height,_camera.setViewport(_width,_height),_camera.position.z=1,_camera.position.x=_width/2,_camera.position.y=-_height/2,_stage.set(width,height)},this.render=function(force){loop(force)},this.set("object3d",gl=>{($glObj=gl).mesh.onHitUpdate=hitUpdate,_hitCamera&&Interaction3D.find(_hitCamera).add($glObj.mesh,noop,noop)}),this.set("hitCamera",camera=>{camera!=_hitCamera&&($glObj&&Interaction3D.find(_hitCamera).remove($glObj.mesh),_hitCamera=camera,$glObj&&Interaction3D.find(_hitCamera).add($glObj.mesh,noop,noop))}),this.set("enabled",v=>{_interaction._disabled=!v,_enabled=v}),this.get("enabled",_=>_enabled),this.set("layout",layout=>{_layout&&_scene.remove(_layout.element.group),_scene.add(layout.element.group),_layout=layout}),this.get("layout",_=>_layout)}),_=>{StageLayoutCapture.createRTPool=function(width,height){let pool=RTPool.instance().clone({format:Texture.RGBAFormat}),dpr=RenderManager.DPR;return pool.setSize(width*dpr,height*dpr),pool}}),Class((function StageLayoutUtil(){Inherit(this,Component);var _data;const KEY="stagelayoututil_keys";var _compiled={};async function init(){await UILStorage.ready(),_data=JSON.parse(UILStorage.get(KEY)||"[]"),function compile(){_data.forEach(key=>{_compiled[key]=JSON.parse(UILStorage.get(`INPUT_Config_${key}_compiled`)||"{}");let resizeCode=UILStorage.get(`INPUT_Config_${key}_onResize`);resizeCode&&(_compiled[key].resize=new Function("$this",resizeCode))})}()}!async function(){await Hydra.ready(),window.Platform&&Platform.isPlatform||init()}(),this.save=function(key,data,input){let compiled=JSON.parse(input.get("compiled")||"{}");compiled[key]=data,input.setValue("compiled",JSON.stringify(compiled))},this.create=function(key){_data.includes(key)||(_data.push(key),UILStorage.set(KEY,JSON.stringify(_data)))},this.getCompiled=function(key){return _compiled[key]},this.reload=function(){return init()}}),"static"),Class((function Text3D(_input,_group){Inherit(this,Object3D);const _this=this;var _config,_fontObject,$text;function initUIL(){(_config=InputUIL.create(_input.prefix+"_text3d",_group)).setLabel("Text3D"),_config.addTextarea("text").addTextarea("fontStyle"),_config.addToggle("anchor2D",!1),_config.addToggle("renderRetina",!1),_config.add("data","hidden"),UIL.sidebar&&(_config.onUpdate=key=>{if("data"!=key){let text=parseData(_config.get("text")),obj=getFontObject();_config.setValue("data",JSON.stringify(obj)),$text&&($text.setText(text,obj),obj.color&&$text.setColor(obj.color)),_this.onUpdate&&_this.onUpdate()}})}function parseData(text){if(!text||!text.includes("$DATA"))return text;for(;text.includes("$DATA");){let code=text.split("$DATA")[1].split(" ")[0].split("\n")[0],line="$DATA"+code;text=text.replace(line,eval(line.replace("$DATA","_this.parent.data")))}return text}function getFontObject(){let font=_config.get("fontStyle")||"",obj={};return font=font.split("\n"),font.forEach(line=>{let key=(line=line.split(":"))[0],val=line[1];val&&(val=val.replace(/ /g,"")),key.length&&(obj[key]=isNaN(Number(val))?val:Number(val),"false"===val&&(obj[key]=!1),"true"===val&&(obj[key]=!0))}),obj}function initText(){if(!(_fontObject=JSON.parse(_config.get("data")||"{}")).size)return;Text3D.FONT_CONFIG&&(_fontObject.config=Text3D.FONT_CONFIG),Text3D.LANG_BREAK&&(_fontObject.langBreak=Text3D.LANG_BREAK),_fontObject.shader||(_fontObject.shader="Text3D");let text=parseData(_config.get("text"));text&&createText(text,_fontObject)}async function overrideLocalize(text,fontObject,cb){if(!text)return;_this.localized=!0,fontObject.text=text,_this.text&&_this.text.destroy&&_this.text.destroy(),_this.text=new Text3D.FallbackText,_this.text.setColor(_fontObject.color),_this.text.onSetText=text=>_this.setText(text);Text3D.createFallbackTexture(text,fontObject).then(texture=>{_this.text.setColor(fontObject.color);let geom=new PlaneGeometry(texture.width,texture.height);for(geom.computeBoundingBox(),"center"!=fontObject.align&&geom.applyMatrix((new Matrix4).makeTranslation(texture.width/2,0,0));_this.group.children.length;)_this.group.remove(_this.group.children[0]);return _this.text.createMesh(geom,texture),_this.add(_this.text.group),_this.text})}function createText(text,fontObject){if((fontObject.localize||_input.forceLocalize)&&Text3D.missingChars(text,fontObject))return overrideLocalize(text,fontObject);($text=$glText(text,null,null,fontObject)).enable3D(_config.get("anchor2D")),_config.get("renderRetina")?($text.anchor||($text.anchor=new Group),_this.add($text.anchor),GLUI.Scene.add($text)):_this.add($text.group),$text.text.onCreateShader=shader=>{let shaderName=_input.get("shader");shaderName&&(shader.fragmentShader=shader.fragmentShader.split("void main")[0]+"\n"+Shaders.getShader(shaderName+".fs"),shader.customCompile=shaderName),$text.text3d=_this,window[shaderName]&&(_this.shaderClass=_this.parent.initClass(window[shaderName],$text,shader,_group,_input),ShaderUIL.add(shader,_group).setLabel("Shader"))},_this.text=$text;let setText=$text.setText.bind($text);$text.setText=function(text,obj){if(obj)for(let key in obj)_fontObject[key]=obj[key];_fontObject.text=text,setText(text,_fontObject),_this.events.fire(Events.UPDATE),defer(setUniforms)},$text.loaded().then(_=>{$text&&(_this.shader=$text.mesh.shader,_this.shader.addUniforms({uTransition:{value:5,ignoreUIL:!0},uTranslate:{value:_this.translate,ignoreUIL:!0},uRotate:{value:_this.rotate,ignoreUIL:!0},uWordCount:{value:0,ignoreUIL:!0},uLetterCount:{value:0,ignoreUIL:!0},uLineCount:{value:0,ignoreUIL:!0},uByWord:{value:0,ignoreUIL:!0},uByLine:{value:0,ignoreUIL:!0},uPadding:{value:.3,ignoreUIL:!0},uBoundingMin:{value:(new Vector3).copy($text.dimensions.min)},uBoundingMax:{value:(new Vector3).copy($text.dimensions.max)}}),Text3D.onCreateShader&&Text3D.onCreateShader(_this.shader))}),setUniforms()}async function setUniforms(){if(await _this.wait(_this,"shader"),await $text.loaded(),_input&&_input.get){let depthWrite=_input.get("depthWrite"),depthTest=_input.get("depthTest");"boolean"==typeof depthWrite&&($text.mesh.shader.depthWrite=depthWrite),"boolean"==typeof depthTest&&($text.mesh.shader.depthTest=depthTest);let blending=_input.get("blending");blending&&($text.mesh.shader.blending=blending)}_this.shader.set("uWordCount",$text.mesh.geometry.wordCount),_this.shader.set("uLetterCount",$text.mesh.geometry.letterCount),_this.shader.set("uLineCount",$text.mesh.geometry.lineCount),_this.shader.set("uBoundingMin",(new Vector3).copy($text.dimensions.min)),_this.shader.set("uBoundingMax",(new Vector3).copy($text.dimensions.max))}this.translate=new Vector3,this.rotate=new Vector3,_this.wildcard=_input.get("wildcard"),async function(){_this.group.text=_this,initUIL(),initText(),Text3D.onCreate&&Text3D.onCreate(_this)}(),this.get("fontObject",_=>_fontObject),this.setProperties=function(obj=_fontObject){return $text?($text.setText(obj.text,obj),setUniforms()):createText(obj.text,obj),_this.text.loaded()},this.setPropertiesCheck=function(obj,force){let applyProperties=!1;for(const key in obj)_fontObject[key]!==obj[key]&&(applyProperties=!0,_fontObject[key]=obj[key]);return applyProperties||force?_this.setProperties():Promise.resolve()},this.setText=function(text){if(_fontObject.text=text,$text){if(_fontObject.localize&&Text3D.missingChars(text,_fontObject))return _this.group.remove($text.group),_this.shader=void 0,$text=null,void createText(text,_fontObject);$text.setText(text),setUniforms(),$text.mesh&&($text.mesh.onBeforeRender(),$text.mesh.updateMatrixWorld(!0))}else createText(text,_fontObject)},this.setColor=function(color){_fontObject.color=color,_this.text&&_this.text.setColor(color)},this.set("animateByWord",async bool=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uByWord",bool?1:0))}),this.set("animateByLine",async bool=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uByLine",bool?1:0))}),this.set("animationPadding",async p=>{_this.localized||(await _this.wait(_this,"shader"),_this.shader.set("uPadding",p))}),this.set("transition",async v=>{if(_this.localized)return _this.text.alpha=v;await _this.wait(_this,"shader"),_this.shader.set("uTransition",v>0?1.5:-.5)}),this.tween=async function(val,time,ease,delay){return _this.localized?_this.text.tween(val,time,ease,delay):(await _this.wait(_this,"shader"),_this.shader.tween("uTransition",val>0?1.5:-.5,time,ease,delay))},this.upload=function(){$text&&$text.upload()},this.ready=function(){return _this.wait(_this,"shader")},this.set("renderOrder",v=>{$text&&$text.setZ(v)}),this.getDimensions=async _=>(await $text.loaded(),await $text.text.ready(),$text.dimensions)}),_=>{var _projection;Text3D.missingChars=function(){return!1},Text3D.measureScreen=async function($text,camera=World.CAMERA,z=0){_projection||(_projection=new ScreenProjection(World.CAMERA)),$text instanceof Text3D&&($text=$text.text),await $text.loaded(),$text.mesh.onBeforeRender(),$text.mesh.updateMatrixWorld(!0),await defer(),_projection.camera=camera;let bb=new Box3;bb.setFromObject($text.mesh),bb.min.z=bb.max.z=z;let min=_projection.project(bb.min).clone(),max=_projection.project(bb.max).clone();return{width:Math.abs(min.x-max.x),height:Math.abs(min.y-max.y)}}}),Class((function Track(){Inherit(this,Model);const DEBUG=Utils.query("debug");!async function(){}(),this.page=function(path,title){let data={};title&&(data.page_title=title),path&&(data.page_path=path),window.gtag&&gtag("config",Config.ANALYTICS_ID,data),DEBUG&&(window.gtag||console.log("no gtag"),Config.ANALYTICS_ID||console.log("Config.ANALYTICS_ID required"),console.log(`>>> track page: '${JSON.stringify(data)}'`))},this.event=function(category,action,label,value,params){let data={event:"event"};category&&(data.event_category=category),action&&(data.event_action=action),label&&(data.event_label=label),value&&(data.value=value),params&&(data=Object.assign(params,data)),window.gtag&&gtag("event",action,data),DEBUG&&(window.gtag||console.log("no gtag"),console.log(`>>> track event: '${action}', '${JSON.stringify(data)}'`))}}),"Static"),Class((function UIL(){Inherit(this,Component);const _this=this;let _style,$el,_ui={};Hydra.ready(async _=>{if(!Utils.query("editMode")&&(!Hydra.LOCAL||Device.mobile||window._BUILT_||!location.search.includes("uil")&&!Device.detect("hydra")))return function doNotLoad(){Hydra.LOCAL&&Utils.query("remoteUIL")&&(_this.sidebar=_this.global=new UILPanel("null"))}();!function init(){(function initContainer(){$el=$("UIL"),$el.css({position:"fixed",contain:"strict"}).size("100%","100%").mouseEnabled(!1),document.body.insertAdjacentElement("beforeend",$el.div),$el.setZ(9999)})(),function initStyle(){let style=document.head.appendChild(document.createElement("style"));style.type="text/css",style.id="uil-style",style.appendChild(document.createTextNode("\n            .UIL ::-webkit-scrollbar { width:2px; }\n            .UIL ::-webkit-scrollbar-track { background:#161616; }\n            .UIL ::-webkit-scrollbar-thumb { background:#37A1EF; }\n        ")),_style=style}(),function initSidebar(){_this.add(new UILPanel("sidebar")),_this.add(new UILPanel("global",{side:"left"}))}(),function initGraph(){if(!_this.sidebar)return;let parent=_ui.sidebar.element.div;parent.insertBefore(UILGraph.instance().element.div,parent.firstChild)}()}(),_this.loaded=!0}),this.ready=function(){return _this.wait(_this,"loaded")},this.add=function(panel){return _ui[panel.id]=panel,_this[panel.id]=panel,$el.add(panel),_this},this.remove=function(id){let $panel=_ui[id];return $panel.eliminate&&$panel.eliminate(),$panel.destroy(),delete _ui[id],delete _this[id],_this},this.find=function(id){return Object.values(_ui).reduce((acc,el)=>acc.concat(el.find(id)),[])},this.enableSorting=function(id,enable){let el=_this.find(id)[0];return el&&el.enableSorting&&el.enableSorting(enable),_this},this.addCSS=function(control,style){if(control.styled)return;let node=document.createTextNode(style);return _style&&_style.appendChild(node),control.styled=!0,_this},this.REORDER="uil_reorder"}),"static"),Class((function CameraUIL(){this.UPDATE="camera_uil_update",this.add=function(light,group){return new CameraUILConfig(light,null===group?null:group||UIL.global)}}),"static"),Class((function CameraUILConfig(_camera,_uil){const _this=this;if(!_camera.prefix)throw"camera.prefix required when using MeshUIL";var prefix="CAMERA_"+_camera.prefix,_group=_uil?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_camera.prefix,closed:!0});return _uil.add(folder),folder}():null;function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_camera[key].toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange(e=>{_group&&Events.emitter._fireEvent(CameraUIL.UPDATE,{prefix:prefix,key:key,val:e,vec:!0,group:_this}),_camera[key].fromArray(e)}),vector.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(vector)}_camera[key].fromArray(initValue)}function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||(void 0===_camera[key]?9999:_camera[key]);if(_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onChange(e=>{_camera[key]=e,_group&&Events.emitter._fireEvent(CameraUIL.UPDATE,{prefix:prefix,key:key,val:e,number:!0,group:_this})}),number.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(number)}_camera[key]=initValue}function update(e){e.prefix==prefix&&e.group!=_this&&(e.fov&&_camera.setFOV(e.val),e.number&&(_camera[e.key]=e.val),e.rotation&&_camera.group[e.key].fromArray(e.val),e.vec&&_camera[e.key].fromArray(e.val))}_camera.position&&initVec("position"),_camera.group&&(_camera.groupPos=_camera.group.position,initVec("groupPos"),function initRotation(){let key="rotation",toRadians=array=>array?(array.length=3,array.map(x=>Math.radians(x))):[0,0,0],toDegrees=array=>array?(array.length=3,array.map(x=>Math.degrees(x))):[0,0,0],initValue=toRadians(UILStorage.get(`${prefix}${key}`));if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:toDegrees(initValue)});vector.onChange(e=>{_group&&Events.emitter._fireEvent(CameraUIL.UPDATE,{prefix:prefix,key:key,val:toRadians(e),rotation:!0,group:_this}),_camera.group[key].fromArray(toRadians(e))}),vector.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(vector)}_camera.group[key].fromArray(initValue)}()),function initFOV(key){let initValue=UILStorage.get(`${prefix}${key}`)||_camera.camera.fov||9999;if(_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onFinishChange(e=>{_group&&Events.emitter._fireEvent(CameraUIL.UPDATE,{prefix:prefix,key:key,val:e,fov:!0,group:_this}),_camera.setFOV(e),UILStorage.set(`${prefix}${key}`,e)}),_group.add(number)}defer(_=>{_camera.setFOV(initValue)})}("fov"),_camera.moveXY&&(initVec("moveXY"),initVec("lookAt"),initNumber("lerpSpeed"),initNumber("lerpSpeed2"),initNumber("deltaRotate"),initNumber("deltaLerp"),initNumber("wobbleSpeed"),initNumber("wobbleStrength"),initNumber("wobbleZ")),_group&&function addListeners(){Events.emitter._addEvent(CameraUIL.UPDATE,update,_this)}(),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function InputUIL(){this.UPDATE="inputUil_Update",this.create=function(name,group,decoupled){return new InputUILConfig(name,null===group?null:group||UIL.global,decoupled)}}),"static"),Class((function InputUILConfig(_name,_uil,_decoupled,_slim){var _this=this;const prefix="INPUT_"+_name;var _group=_uil?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(_name,{closed:!0});_decoupled||(_uil.add(folder),_uil==UIL.sidebar&&folder.hide());return folder}():null,_fields=_uil?{}:null;function externalUpdate(e){e.prefix==prefix&&e.group!=_this&&(UILStorage.set(`${prefix}_${e.key}`,e.value),_this.onUpdate&&_this.onUpdate(e.key))}_this.group=_group,_this.id=_name,_uil&&function addListeners(){Events.emitter._addEvent(InputUIL.UPDATE,externalUpdate,_this)}(),this.get=function(key){let val=UILStorage.get(`${prefix}_${key}`);return"boolean"==typeof val?val:val&&""!=val?"true"===val||"false"!==val&&(val.charAt&&"["==val.charAt(0)?JSON.parse(val):val):void 0},this.getNumber=function(key){return Number(this.get(key))},_slim||(this.add=function(key,initValue,uil=window.UILControlText,options,params={}){if(!_group||"hidden"==initValue||!UIL.sidebar)return this;let value=UILStorage.get(`${prefix}_${key}`);"true"===value&&(value=!0),"false"===value&&(value=!1),uil==UILControlVector&&"string"==typeof value&&(value=JSON.parse(value)),void 0===value&&(value=initValue),"string"==typeof value&&uil==UILControlImage&&(value=JSON.parse(value));let change=(val,fromInit)=>{val="string"==typeof val?val:JSON.stringify(val),UILStorage.set(`${prefix}_${key}`,val),_this.onUpdate&&_this.onUpdate(key,val),fromInit||Events.emitter._fireEvent(InputUIL.UPDATE,{prefix:prefix,key:key,value:val,group:_this})};"string"!=typeof initValue&&"number"!=typeof initValue&&uil!=UILControlVector||UILStorage.get(`${prefix}_${key}`)||change(initValue,!0);let opts=Utils.mergeObject(params,{label:key,value:value,options:options});uil==window.UILControlButton&&(opts=options);let config=new uil(`${prefix}_${key}`,opts);return config.onFinishChange(change),uil!=UILControlVector&&uil!=UILControlRange||config.onChange(change),_group.add(config),_fields[key]=config,this},this.addToggle=function(key,initValue){return UIL.sidebar?this.add(key,initValue,UILControlCheckbox):this},this.addSelect=function(key,options){return UIL.sidebar?this.add(key,null,UILControlSelect,options):this},this.addImage=function(key,options){return UIL.sidebar?this.add(key,null,UILControlImage,null,options):this},this.addRange=function(key,initValue,options){return UIL.sidebar?this.add(key,initValue,UILControlRange,null,options):this},this.addNumber=function(key,initValue,step){return UIL.sidebar?this.add(key,initValue,UILControlNumber,null,{step:step}):this},this.addColor=function(key,initValue=new Color){return UIL.sidebar?this.add(key,initValue.getHexString(),UILControlColor):this},this.addTextarea=function(key,initValue){return UIL.sidebar?this.add(key,initValue,UILControlTextarea,null,{monospace:!0,rows:4}):this},this.addButton=function(key,options){return UIL.sidebar?this.add(key,null,UILControlButton,options):this},this.addVector=function(key,initValue,options){return UIL.sidebar?(options||(options={step:.05}),this.add(key,initValue,UILControlVector,null,options)):this},this.getImage=function(key){let data=this.get(key);if(data)return JSON.parse(data).src},this.setValue=function(key,value){if(UILStorage.set(`${prefix}_${key}`,value),_this.onUpdate&&_this.onUpdate(key),_fields){let field=_fields[key];field&&(field.value=value,field.update&&field.update())}return this},this.copyFrom=function(input,fields){fields.forEach(key=>{let val=input.get(key);void 0!==val&&("string"!=typeof val&&(val=JSON.stringify(val)),_this.setValue(key,val))})},this.setLabel=function(name){_group&&_group.setLabel(name)},this.getField=function(key){if(_fields)return _fields[key]})})),Class((function ListUIL(){Inherit(this,Component);const _this=this;var _panel,_created={};function removePanel(){_panel&&_panel.destroy&&(_this.events.unsub(_panel,Events.COMPLETE,removePanel),_panel=_panel.destroy())}this.create=function(id,version=1,group){"number"!=typeof version&&(group=version,version=1),group=null===group?null:group||UIL.global;let config=new ListUILConfig(id,version,UIL.global&&!_created[id]);return UIL.global&&(_created[id]||(_created[id]=config,null!=group&&config.appendUILGroup(group||UIL.global))),config},this.openPanel=function(id,name,template){return removePanel(),_panel=new ListUILEditor(id,name,template),_this.events.sub(_panel,Events.COMPLETE,removePanel),_panel},this.set=function(){},this.get=function(){},this.getPanel=function(){return _panel}}),"static"),Class((function ListUILConfig(_id,_version=1,_store){Inherit(this,Component);const _this=this;var _items,_folder,_config,_template={onSort:_=>{},onAdd:_=>{},onRemove:_=>{}},_name="";function name(){return`LIST_${_id}_config`}function updateConfig(){_config.version=_version,UILStorage.setWrite(name(),_config)}function edit(){let panel=ListUIL.openPanel(_id,_name,_this.template);_this.events.bubble(panel,Events.UPDATE),_this.events.fire(ListUIL.OPEN)}_store&&(_items=[]),function initConfig(){(_config=UILStorage.get(name()))?_config.version!=_version&&(updateConfig(),UILStorage.clearMatch(name().split("_config")[0])):(_config={},updateConfig())}(),this.add=function(item){return _items&&_items.push(item),item},this.template=function(config){return"function"==typeof config&&(_template=config),_template},this.appendUILGroup=function(uil){let folder=new UILFolder("LIST_"+_id,{closed:!0}),button=new UILControlButton("button",{actions:[{title:"Edit List",callback:edit}],hideLabel:!0});folder.add(button),uil.add(folder),_folder=folder},this.setLabel=function(name){_folder&&_folder.setLabel(name),_name=name},this.onAdd=function(cb){_template.onAdd=cb},this.onRemove=function(cb){_template.onRemove=cb},this.onSort=function(cb){_template.onSort=cb},this.internalAddItems=function(count){if(!count)return;let array=[];for(let i=0;i<count;i++){let id=`${_id}_${Utils.timestamp()}`;array.push(id)}UILStorage.set(`${_id}_list_items`,JSON.stringify(array))}}),_=>{ListUIL.OPEN="list_uil_open"}),Class((function ListUILEditor(_id,_name,_template){Inherit(this,Component);const _this=this,PANEL_CONFIG={label:_name||"List",width:"400px",height:"auto",drag:!0};var _gui,_list,_add,_items,_tabs=[],_index=0;function initList(){!function read(){let data=UILStorage.get(`${_id}_list_items`);void 0===data&&(data="[]");_items=JSON.parse(data)}(),(_list=new UILFolder(`${_id}_list`,{hideTitle:!0})).enableSorting(_id),_gui.add(_list);for(let id of _items){let view=new ListUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view)}}function initAdd(){!function initButton(title,callback){_add=new UILControlButton("button",{actions:[{title:title,callback:callback}],hideLabel:!0}),_gui.add(_add)}("Add Item",add)}function add(){let id=`${_id}_${Utils.timestamp()}`,view=new ListUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view),_items.push(id),write()}function reorder(e){let order=[];for(let item of e.order)order.push(item.split("_folder")[0]);_items=order,_template().onSort(_items),write(),_this.events.fire(Events.UPDATE,{order:order})}function close(){_this.events.fire(Events.COMPLETE)}function remove(e){_items.remove(e.id),write(),refresh()}function write(){let data=JSON.stringify(_items);UILStorage.set(`${_id}_list_items`,data)}function refresh(){_index=0,_list&&_list.destroy&&(_list=_list.destroy()),_add&&_add.destroy&&(_add=_add.destroy()),initList(),initAdd()}!function initPanel(){_this.gui=_gui=new UILWindow(_id,PANEL_CONFIG),_this.gui.onClose=close,UIL.add(_gui)}(),refresh(),this.onDestroy=function(){_gui.destroy()},this.add=function(){add()}})),Class((function ListUILItem(_id,_parent,_template,_index){Inherit(this,Component);const _this=this;var _folder;function onDelete(){if(!confirm("You sure you want to delete this?"))return;let id=_id;_template().onRemove(id),_this.events.fire(Events.END,{id:id})}function onReorder(e){_this.events.fire(Events.UPDATE,e)}!async function initFolder(){(_folder=InputUIL.create(`${_id}_folder`,_parent)).setLabel("Item"),_folder.group.draggable(!0),_this.events.sub(_folder.group,UIL.REORDER,onReorder),_folder.listUILItem=_this}(),function initTemplate(){let id=_id;(0,_template().onAdd)(id,_folder,_index)}(),function initUI(){let actions=[{title:"Delete",callback:onDelete}];_folder.addButton("delete",{actions:actions,hideLabel:!0})}(),this.setLabel=function(label){_folder.setLabel(label)},this.forceSort=function(index){_folder.group.forceSort(index)},this.open=function(){_folder.group.open(),_folder.group.openChildren()},this.close=function(){_folder.group.close()}})),Class((function MeshUIL(){Inherit(this,Component);this.exists={},this.UPDATE="mesh_uil_update",this.add=function(mesh,group){return new MeshUILConfig(mesh,null===group?null:group||UIL.global)}}),"static"),Class((function MeshUILConfig(_mesh,_uil){const _this=this;if(!_mesh.prefix)throw"mesh.prefix required when using MeshUIL";var prefix="MESH_"+_mesh.prefix,_group=_uil&&!MeshUIL.exists[prefix]?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_mesh.prefix,closed:!0});return _uil.add(folder),folder}():null,_controls=_group?{}:null;function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_mesh[key].toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange(e=>{_mesh[key].fromArray(e),_group&&Events.emitter._fireEvent(MeshUIL.UPDATE,{prefix:prefix,key:key,val:e,group:_this})}),vector.onFinishChange(save),_group.add(vector),_controls[key]=vector}_mesh[key].fromArray(initValue)}function save(){for(let key in _controls){let value=_controls[key].value;UILStorage.set(`${prefix}${key}`,value)}}function update(e){e.prefix==prefix&&e.group!=_this&&_mesh[e.key].fromArray(e.val)}this.group=_group,MeshUIL.exists[prefix]=!0,initVec("position"),initVec("scale"),function initRotation(){let key="rotation",toRadians=array=>array?(array.length=3,array.map(x=>Math.radians(x))):[0,0,0],toDegrees=array=>array?(array.length=3,array.map(x=>Math.degrees(x))):[0,0,0],initValue=toRadians(UILStorage.get(`${prefix}${key}`));if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:toDegrees(initValue)});vector.onChange(e=>{_mesh[key].fromArray(toRadians(e)),_group&&Events.emitter._fireEvent(MeshUIL.UPDATE,{prefix:prefix,key:key,val:toRadians(e),group:_this})}),vector.onFinishChange(save),_group.add(vector),_controls[key]=vector}_mesh[key].fromArray(initValue)}(),_group&&function addListeners(){Events.emitter._addEvent(MeshUIL.UPDATE,update,_this)}(),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function ShaderUIL(){this.exists={},this.UPDATE="shader_update",this.TEXTURE_UPDATE="shader_texture_update",this.add=function(shader,group){return new ShaderUILConfig(shader.shader||shader,null===group?null:group||UIL.global)}}),"static"),Class((function ShaderUILConfig(_shader,_uil){var _textures,_this=this;const prefix=_shader.UILPrefix;var _group=_uil&&!ShaderUIL.exists[prefix]?function createFolder(){if(!UIL.sidebar)return null;let label=function getName(){let split=_shader.UILPrefix.split("/");return split.length>2?split[0]+"_"+split[2]:split[0]}();"_"==label.charAt(label.length-1)&&(label=label.slice(0,-1));let folder=new UILFolder(prefix+label,{label:label,closed:!0});return _uil.add(folder),folder}():null;function createVector(obj,key){let initValue=UILStorage.get(`${prefix}${key}`)||obj.value.toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange(val=>{obj.value.fromArray(val),_shader.ubo&&(_shader.ubo.needsUpdate=!0),Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:prefix,key:key,val:val,group:_this,vector:!0})}),vector.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(vector)}obj.value.fromArray(initValue)}function createTexture(obj,key){_group&&!_textures&&(_textures={});const getTexture=obj.getTexture||ShaderUIL.getTexture||Utils3D.getTexture,set=_shader.parent&&_shader.parent.setOverride?_shader.parent.setOverride:_shader.set||_shader.setUniform,get=_shader.get||_shader.getUniform;let prefix=_shader.UILPrefix+"_tx",data=UILStorage.get(`${prefix}_${key}`);data&&(data=JSON.parse(data));let value=data?data.src:null,change=data=>{let val=data.src,cleanPath=val.includes("?")?val.split("?")[0]:val;data.compressed&&(val+="-compressedKtx"),_textures&&(_textures[cleanPath]=change),data.src=cleanPath,UILStorage.set(`${prefix}_${key}`,JSON.stringify(data)),set(key,getTexture(val,{premultiplyAlpha:obj.premultiplyAlpha,scale:obj.scale}),_shader),_group&&Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:_shader.UILPrefix,key:key,val:val,texture:get(key,_shader),group:_this})};if(value&&value.length&&change(data),_group){let img=new UILControlImage(prefix+key,{label:key,value:data});img.onFinishChange(change),_group.add(img)}}function createNumber(obj,key){let initValue=UILStorage.get(`${prefix}${key}`);if(void 0===initValue&&(initValue=obj.value),_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onChange(val=>{_shader.ubo&&(_shader.ubo.needsUpdate=!0),Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:prefix,key:key,val:val,group:_this}),obj.value=val}),number.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(number)}obj.value=initValue}function createColor(obj,key){let initValue=UILStorage.get(`${prefix}${key}`);if(_group){let color=new UILControlColor(`${prefix}${key}`,{label:key,value:initValue});color.onChange(val=>{obj.value.set(val),_shader.ubo&&(_shader.ubo.needsUpdate=!0),_group&&Events.emitter._fireEvent(ShaderUIL.UPDATE,{prefix:prefix,key:key,val:val,color:!0,group:_this})}),color.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(color)}initValue&&obj.value.set(initValue)}function textureUpdate(e){if(!_textures)return;let cleanPath=e.file.split("?")[0];for(let key in _textures)cleanPath==key&&_textures[key]({src:e.file})}function update(e){if(e.prefix==_shader.UILPrefix&&e.group!=_this)if(e.color){let val=e.val,obj=_shader.uniforms[e.key];Array.isArray(val)?obj.value.setRGB(val[0],val[1],val[2]):obj.value.set(val)}else e.texture?"remote"!=e.texture&&_shader.set(e.key,e.texture):e.vector?_shader.uniforms[e.key].value.fromArray(e.val):_shader.uniforms[e.key].value=e.val}this.group=_group,ShaderUIL.exists[_shader.UILPrefix]=!0,function initItems(){for(var key in _shader.uniforms){let obj=_shader.uniforms[key];obj&&!obj.ignoreUIL&&(obj.value instanceof Color&&createColor(obj,key),"number"==typeof obj.value&&createNumber(obj,key),(null===obj.value||obj.value instanceof Texture)&&createTexture(obj,key),obj.value instanceof Vector2&&createVector(obj,key),obj.value instanceof Vector3&&createVector(obj,key),obj.value instanceof Vector4&&createVector(obj,key))}}(),_group&&function addListeners(){Events.emitter._addEvent(ShaderUIL.UPDATE,update,_this),Events.emitter._addEvent(ShaderUIL.TEXTURE_UPDATE,textureUpdate,_this)}(),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function ShadowUIL(){this.add=function(light,group){return new ShadowUILConfig(light,null===group?null:group||UIL.global)}}),"static"),Class((function ShadowUILConfig(_light,_uil){if(!_light.prefix)throw"light.prefix required when using MeshUIL";var prefix="SHADOW_"+_light.prefix,_group=_uil?function createFolder(){if(!UIL.sidebar)return null;let folder=new UILFolder(prefix,{label:_light.prefix,closed:!0});return _uil.add(folder),folder}():null;function initNumber(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light.shadow[key];if(_group){let number=new UILControlNumber(`${prefix}${key}`,{label:key,value:initValue,step:.05});number.onFinishChange(e=>{_light.shadow[key]=e,UILStorage.set(`${prefix}${key}`,e)}),_group.add(number)}_light.shadow[key]=initValue}function initVec(key){let initValue=UILStorage.get(`${prefix}${key}`)||_light[key].toArray();if(_group){let vector=new UILControlVector(`${prefix}${key}`,{label:key,value:initValue,step:.05});vector.onChange(e=>{_light[key].fromArray(e),"target"==key&&_light.shadow.camera.lookAt(_light.target)}),vector.onFinishChange(e=>UILStorage.set(`${prefix}${key}`,e)),_group.add(vector)}_light[key].fromArray(initValue)}_light.target=_light.shadow.target,initVec("position"),initVec("target"),initNumber("fov"),initNumber("size"),initNumber("area"),initNumber("near"),initNumber("far"),function initTick(key){let initValue=UILStorage.get(`${prefix}${key}`);if(_group){let tick=new UILControlCheckbox(`${prefix}${key}`,{label:key,value:initValue});tick.onFinishChange(e=>{_light[key]=e,UILStorage.set(`${prefix}${key}`,e)}),_group.add(tick)}_light[key]=initValue}("static"),this.setLabel=function(name){_group&&_group.setLabel(name)}})),Class((function TimelineUIL(){Inherit(this,Component);const _this=this;var _panel,_created={};function removePanel(){_panel&&_panel.destroy&&(_this.events.unsub(_panel,Events.COMPLETE,removePanel),_panel=_panel.destroy())}this.create=function(id,version=1,group){"number"!=typeof version&&(group=version,version=1),group=null===group?null:group||UIL.global;let config=new TimelineUILConfig(id,version,UIL.global&&!_created[id]);return UIL.global&&(_created[id]||(_created[id]=config,null!=group&&config.appendUILGroup(group||UIL.global))),config},this.openPanel=function(id,name,template){return removePanel(),_panel=new TimelineUILEditor(id,name,template),_this.events.sub(_panel,Events.COMPLETE,removePanel),_panel},this.set=function(){},this.get=function(){}}),"static"),Class((function TimelineUILConfig(_id,_version=1,_store){Inherit(this,Component);const _this=this;var _items,_folder,_config,_template={onSort:_=>{},onAdd:_=>{},onRemove:_=>{}},_name="";function name(){return`TL_${_id}_config`}function updateConfig(){_config.version=_version,UILStorage.setWrite(name(),_config)}function edit(){let panel=TimelineUIL.openPanel(name(),_name,_this.template);_this.events.bubble(panel,Events.UPDATE),_this.events.fire(TimelineUIL.OPEN)}this.model=new TimelineUILModel(name()),_store&&(_items=[]),function initConfig(){(_config=UILStorage.get(name()))?_config.version!=_version&&(updateConfig(),UILStorage.clearMatch(name().split("_config")[0])):(_config={},updateConfig())}(),this.add=function(item){return _items&&_items.push(item),item},this.template=function(config){return"function"==typeof config&&(_template=config),_template},this.appendUILGroup=function(uil){let folder=new UILFolder("TL_"+_id,{closed:!0}),button=new UILControlButton("button",{actions:[{title:"Edit Timeline",callback:edit}],hideLabel:!0});folder.add(button),uil.add(folder),_folder=folder},this.setLabel=function(name){_folder&&_folder.setLabel(name),_name=name},this.onAdd=function(cb){_template.onAdd=cb},this.onRemove=function(cb){_template.onRemove=cb},this.onSort=function(cb){_template.onSort=cb},this.internalAddItems=function(count){if(!count)return;let array=[];for(let i=0;i<count;i++){let id=`${_id}_${Utils.timestamp()}`;array.push(id)}UILStorage.set(`${_id}_list_items`,JSON.stringify(array))}}),_=>{TimelineUIL.OPEN="list_uil_open"}),Class((function TimelineUILEditor(_id,_name,_template){Inherit(this,Component);const _this=this,PANEL_CONFIG={label:"Timeline Editor",width:"800px",height:"auto",drag:!0};var _gui,_list,_add,_config,_items,_tabs=[],_index=0;function initList(){!function read(){let data=UILStorage.get(`${_id}_list_items`);void 0===data&&(data="[]");_items=JSON.parse(data)}(),_list=new UILFolder(`${_id}_list`,{hideTitle:!0}),_gui.add(_list);for(let id of _items){let view=_this.initClass(TimelineUILItem,id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view)}_config.rails&&function attachRails(){_tabs.forEach((t,i)=>{t.onUpdate=v=>{_tabs.forEach((t2,j)=>{t2!=t&&(j<i&&t.getValue()<t2.getValue()&&t2.setValue(t.getValue()),j>i&&t.getValue()>t2.getValue()&&t2.setValue(t.getValue()))})}})}()}function initButton(title,callback){let btn=new UILControlButton("button",{actions:[{title:title,callback:callback}],hideLabel:!0});return _gui.add(btn),btn}function spaceEvenly(){_tabs.forEach((t,i)=>{let perc=Math.range(i,0,_tabs.length-1,0,1);t.setValue(perc)})}function add(){let id=`${_id}_${Utils.timestamp()}`,view=new TimelineUILItem(id,_list,_template,_index++);_this.events.sub(view,Events.UPDATE,reorder),_this.events.sub(view,Events.END,remove),_tabs.push(view),_items.push(id),write()}function reorder(e){let order=[];for(let item of e.order)order.push(item.split("_folder")[0]);_items=order,_template().onSort(_items),write(),_this.events.fire(Events.UPDATE,{order:order})}function remove(e){_items.remove(e.id),write(),refresh()}function write(){let data=JSON.stringify(_items);UILStorage.set(`${_id}_list_items`,data)}function refresh(){_index=0,_list&&_list.destroy&&(_list=_list.destroy()),_add&&_add.destroy&&(_add=_add.destroy()),initList(),function initAdd(){_config.lock||(_add=initButton("Add Item",add)).element.css({width:"20%"}),initButton("Space Evenly",spaceEvenly).element.css({width:"20%"})}()}_this.config=_config=JSON.parse(UILStorage.get(`${_id}_config`)||"{}"),function initPanel(){_this.gui=_gui=new UILWindow(_id,PANEL_CONFIG),UIL.add(_gui)}(),refresh(),this.onDestroy=function(){_gui.destroy()}})),Class((function TimelineUILItem(_id,_parent,_template,_index){Inherit(this,Component);const _this=this;var _folder;function onDelete(){if(!confirm("You sure you want to delete this?"))return;let id=_id;_template().onRemove(id),_this.events.fire(Events.END,{id:id})}function onReorder(e){_this.events.fire(Events.UPDATE,e)}!async function initFolder(){(_folder=InputUIL.create(`${_id}_folder`,_parent)).setLabel("Item"),_this.parent&&_this.parent.config.lock||_folder.group.draggable(!0),_this.events.sub(_folder.group,UIL.REORDER,onReorder),_folder.group.open()}(),function initTemplate(){let id=_id;(0,_template().onAdd)(id,_folder,_index)}(),function initUI(){_folder.add("label",_this.parent&&_this.parent.config.lock?"hidden":void 0),_folder.addRange("keyframe"),_folder.add("percent","hidden"),_folder.getField("keyframe").force(Math.round(100*_folder.getNumber("percent"))||0),_folder.onUpdate=key=>{if("keyframe"==key){let val=_folder.getNumber(key)/100;_folder.setValue("percent",val),_this.onUpdate&&_this.onUpdate(val)}};let label=_folder.get("label");if(label&&_folder.setLabel(label),!_this.parent||!_this.parent.config.lock){let actions=[{title:"Delete",callback:onDelete}],hideLabel=!0,btn=(_folder.addButton("delete",{actions:actions,hideLabel:hideLabel}),_folder.getField("delete"));btn&&btn.$content.css({width:"20%"})}}(),this.setLabel=function(label){_folder.setLabel(label)},this.getValue=function(value){return _folder.getNumber("percent")},this.setValue=function(value){_folder.setValue("percent",value),_folder.getField("keyframe").force(Math.round(100*value)||0)}})),Class((function TimelineUILModel(_id){var _items,_config,_data=[],_map={};!function initItems(){_config=JSON.parse(UILStorage.get(`${_id}_config`)||"{}"),_items=JSON.parse(UILStorage.get(`${_id}_list_items`)||"[]")}(),function initData(){_items.forEach((item,i)=>{let input=InputUIL.create(`${item}_folder`,null,null,!!UIL.global),data={};data.label=input.get("label")||"Item",data.value=input.getNumber("percent")||0,data.arbitrary=input.get("arbitrary"),_data.push(data),_map[data.label]=data,UIL.global&&Render.start(_=>{data.label=input.get("label")||"Item",data.value=input.getNumber("percent")||0},10)})}(),this.setState=function(array){for(let i=0;i<array.length;i++)_items[i]||_items.push(`${_id}_${Utils.timestamp()}`);_items.length>array.length&&(_items=_items.slice(0,array.length)),_items.forEach((item,i)=>{let data=array[i],input=InputUIL.create(`${item}_folder`,null);input.setValue("label",data.label),data.percent&&input.setValue("percent",data.percent),data.arbitrary&&input.setValue("percent",data.arbitrary)}),UILStorage.set(`${_id}_list_items`,JSON.stringify(_items))},this.lock=function(){return _config.lock?this:(_config.lock=!0,UIL.global&&UILStorage.set(`${_id}_config`,JSON.stringify(_config)),this)},this.rails=function(){return _config.rails?this:(_config.rails=!0,UIL.global&&UILStorage.set(`${_id}_config`,JSON.stringify(_config)),this)},this.getData=function(){return _data},this.get=function(key){return _map[key]}})),Class((function TweenUIL(){Inherit(this,Component);const _this=this;var _editor,_data={},_created={};function removeEditor(){_editor=_editor.destroy()}this.create=function(name,version=1,group){"number"!=typeof version&&(group=version,version=1);let config=new TweenUILConfig(name,version,UIL.global&&!_created[name]);return UIL.global&&(_created[name]||(_created[name]=config,config.appendUILGroup(group||UIL.global))),config},this.openEditor=function(name,tweens){_editor&&_editor.destroy(),_editor=new TweenUILEditor(name,tweens),_this.events.sub(_editor,Events.COMPLETE,removeEditor)},this.set=function(key,value){_data[key]=value},this.get=function(key){return _data[key]}}),"static"),Class((function TweenUILConfig(_name,_version=1,_store){var _tweens,_folder,_config=UILStorage.get("TWEEN_"+_name+"_config");function updateConfig(){_config.version=_version,UILStorage.setWrite("TWEEN_"+_name+"_config",_config)}function override(tween,object,props,time,ease,delay){let key="TWEEN_"+_name+"_"+tween._id,storage=UILStorage.get(key),obj={props:props,time:time,ease:ease,delay:delay};for(let key in storage)obj[key]=storage[key];return TweenUIL.set(key,obj),obj}function edit(){TweenUIL.openEditor(_name,_tweens)}_store&&(_tweens=[]),_config?_config.version!=_version&&(updateConfig(),UILStorage.clearMatch("TWEEN_"+_name)):(_config={},updateConfig()),this.add=function(tween,name){return tween._id=name,tween.overrideValues=override,_tweens&&_tweens.push(tween),tween},this.appendUILGroup=function(uil){let folder=new UILFolder("TWEEN_"+_name,{closed:!0}),button=new UILControlButton("button",{actions:[{title:"Edit",callback:edit}],hideLabel:!0});folder.add(button),uil.add(folder),_folder=folder},this.setLabel=function(name){_folder&&_folder.setLabel(name)}})),Class((function TweenUILEditor(_name,_tweens){Inherit(this,Component);const _this=this;var _gui=new UILWindow(_name,{label:"Tween Editor",width:"400px",height:"auto",drag:!0});function createGroup(tween){let obj=TweenUIL.get("TWEEN_"+_name+"_"+tween._id),group=new UILFolder(tween._id);_gui.add(group);let lookup="TWEEN_"+_name+"_"+tween._id;for(let key in obj)if("props"==key)switch(tween._id){case"position":case"scale":createVector(obj,key,group,lookup);break;case"rotation":createRotation(obj,key,group,lookup);break;default:createNumber(obj,key,group,lookup)}else createString(obj,key,group,lookup)}function createString(obj,key,group,lookup){let value=obj[key],text=new UILControlText(lookup+key,{label:key,value:value.toString(),monospace:!0});text.onFinishChange(val=>{"time"!=key&&"delay"!=key||(val=Number(val)),write(lookup,key,val)}),group.add(text)}function createNumber(obj,key,group,lookup){let{props:props}=obj,keys=Object.keys(props);if(keys.length>1)throw"TweenUIL can't deal with a basic Object with more than one key. Define position/rotation/scale or create a tween for each property.";let number=new UILControlNumber(`${lookup}${key}`,{label:key,value:props[keys[0]]});number.onFinishChange(val=>{let output={};output[keys[0]]=val,write(lookup,key,output)}),group.add(number)}function createVector(obj,key,group,lookup){let{props:props}=obj,vector=new UILControlVector(`${lookup}${key}`,{label:key,value:[props.x,props.y,props.z],step:.05});vector.onFinishChange(val=>{write(lookup,key,{x:val[0],y:val[1],z:val[2]})}),group.add(vector)}function createRotation(obj,key,group,lookup){let{props:props}=obj,v=(array=>array?(array.length=3,array.map(x=>Math.degrees(x))):[0,0,0])([props.x,props.y,props.z]),vector=new UILControlVector(`${lookup}${key}`,{label:key,value:v});vector.onFinishChange(val=>{let output=(array=>array?(array.length=3,array.map(x=>Math.radians(x))):[0,0,0])(val);write(lookup,key,{x:output[0],y:output[1],z:output[2]})}),group.add(vector)}function write(lookup,key,value){let obj=UILStorage.get(lookup)||{};obj[key]=value,UILStorage.set(lookup,obj)}function exit(){_this.events.fire(Events.COMPLETE)}this.gui=_gui,function(){UIL.add(_gui);for(let tween of _tweens)createGroup(tween);let button=new UILControlButton("button",{actions:[{title:"Exit",callback:exit}],hideLabel:!0});_gui.add(button)}(),this.onDestroy=function(){_gui.destroy()}})),Class((function UILFile(_offline){Inherit(this,Component);this.load=async function(){let path=window.UIL_STATIC_PATH||Config.CDN+"assets/data/uil.json";try{return await get(path)}catch(e){return{}}},this.save=async function(sessionData,data){if(Dev.writeFile(window.UIL_STATIC_PATH||"assets/data/uil.json",data),_offline){let partial={};try{partial=await get("assets/data/uil-partial.json",data);for(let key in sessionData)partial[key]=sessionData[key]}catch(e){partial=sessionData}Dev.writeFile("assets/data/uil-partial.json",partial),Storage.set("uil_update_partial",!0)}}})),Class((function UILStorage(){Inherit(this,Component);const _this=this;var _fs,_keys,_data={},_dataSession={};this.SAVE="uil_save";const OFFLINE_FIREBASE=Utils.query("offlineFB");function clearOfflineData(){Storage.set("uil_update_partial",!1),Dev.writeFile("assets/data/uil-partial.json",{})}async function init(){if(_fs&&_fs.destroy(),_fs=_this.initClass(uilFile()?UILFile:UILRemote,OFFLINE_FIREBASE),_data=await _fs.load(),_this.loaded=!0,!OFFLINE_FIREBASE&&Storage.get("uil_update_partial")&&!uilFile()){if(!confirm("Looks like you have UIL data captured offline, do you want to sync it to Firebase?"))return clearOfflineData();let data=await get("assets/data/uil-partial.json");for(let key in data)_this.set(key,data[key]);write(!0,!0),clearOfflineData()}}async function write(direct,silent){let prevent=!1,e={prevent:_=>prevent=!0};_this.events.fire(_this.SAVE,e),!direct&&(e.wait&&await e.wait(),prevent)||(_fs.save(_dataSession,_data),_dataSession={},silent||(__body.css({display:"none"}),_this.delayedCall(()=>{__body.css({display:"block"})},100)))}function uilFile(){return!Utils.query("editMode")&&(!Hydra.LOCAL||(!!Device.mobile||(!!OFFLINE_FIREBASE||(!!window._BUILT_||(!!window.AURA||(!!window._UIL_FILE_||(!window._FIREBASE_UIL_&&!window.UIL_ID||!Device.detect("hydra")&&!location.search.includes("uil"))))))))}Hydra.ready(async _=>{window.Platform&&window.Platform.isPlatform||init(),(Utils.query("editMode")||Hydra.LOCAL&&!Device.mobile&&!window._BUILT_&&(location.search.includes("uil")||Device.detect("hydra")))&&__window.bind("keydown",e=>{(e.ctrlKey||e.metaKey)&&83==e.keyCode&&(e.preventDefault(),write())})}),this.reload=function(id,path){_this.loaded=!1,window.UIL_ID=id,window.UIL_STATIC_PATH=path,init()},this.set=function(key,value){null===value?(delete _data[key],delete _dataSession[key]):(_data[key]=value,_dataSession[key]=value)},this.setWrite=function(key,value){this.set(key,value),write(!0)},this.clearMatch=function(string){for(let key in _data)key.includes(string)&&delete _data[key];write(!0)},this.write=function(silent){write(!0,silent)},this.get=function(key){return _data[key]},this.ready=function(){return _this.wait(_this,"loaded")},this.getKeys=function(){return _keys||(_keys=Object.keys(_data)),_keys},this.parse=function(key,hint){let data=_data[key];if(void 0===data)return null;if(Array.isArray(data)){if(hint instanceof Vector2)return{value:(new Vector2).fromArray(data)};if(hint instanceof Vector3)return{value:(new Vector3).fromArray(data)};if(hint instanceof Vector4)return{value:(new Vector4).fromArray(data)}}else if("string"==typeof data&&"#"===data.charAt(0))return{value:new Color(data)};return{value:data}}}),"static"),Class((function UILControl(){Inherit(this,Element);const _this=this;let $this,$label,$content,$view,_value,_previous,_label,_opts,_visible=!0,_onChange=()=>{},_onFinishChange=()=>{};function isEqual(a,b){return Array.isArray(a)||Array.isArray(b)?a+""==b+"":"object"==typeof a||"object"==typeof b?JSON.stringify(a)===JSON.stringify(b):a===b}function clone(value){return Array.isArray(value)?[...value]:"object"==typeof value?Object.assign({},value):value}!function initHTML(){$this=_this.element,$this.size("100%","auto"),$this.css({position:"relative",display:"inline-block",borderBottom:"1px solid #161616",padding:"2px 0",boxSizing:"border-box"}),$this.attr("data-type","UILControl"),$this.div._this=_this}(),function initLabel(){$label=$this.create("label"),$label.size("100px","auto").fontStyle("sans-serif",12,"#9B9C9B"),$label.css({paddingLeft:4,paddingTop:2,boxSizing:"border-box",verticalAlign:"top",float:"left"}),_this.$label=$label}(),function initContent(){$content=$this.create("content"),$content.size("calc(100% - 100px)","auto").css({float:"left"}),_this.$content=$content}(),this.init=function(id,opts={}){_this.id=id,_opts=opts,_this.setLabel(opts.label||id),_value=clone(opts.value),_previous=clone(_value),$this.attr("data-id",id)},this.finish=function(history=!0){_onFinishChange(_value),isEqual(_value,_previous)||(history&&UILHistory.set(_this,_previous),UILLocalStorage.set(_this.id,_value),_previous=clone(_value))},this.force=function(value){_this.value=clone(value),_this.finish(!1)},this.debounce=function(callback,time=250){let interval;return(...args)=>{clearTimeout(interval),interval=setTimeout(()=>{interval=null,callback(...args)},time)}},this.onChange=function(cb){return _onChange=cb,_this},this.onFinishChange=function(cb){return _onFinishChange=cb,_this},this.get("value",()=>_value),this.set("value",value=>{isEqual(value,_value)||(_value=clone(value),_this.update&&_this.update(_value),_onChange(_value))}),this.get("view",()=>$view),this.set("view",view=>{$view&&$view.destroy(),$view=view,$content.add($view)}),this.hide=function(){return _visible=!1,$this.css({display:"none"}),_this},this.show=function(){return _visible=!0,$this.css({display:"inline-block"}),_this},this.isVisible=function(){return _visible},this.setLabel=function(label){_label=label,_this.label=label,$label.text(label),$label.attr("title",label)}})),Class((function UILFolder(_id,_opts={drag:!0}){Inherit(this,Element);const _this=this;let $this,$header,$container,$toggle,$drag,$title,_children={},_open=!_opts.closed,_visible=!0,_order=[],_draggable=!1,_sortableChildren=!1,_headerDrag=!1;var _hasClipboard=!1;_this.id=_id,_this.label=`${_opts.label||_id}`,_this.level=-1;const RECURSIVE_CLOSE=!0;function removeDragHandlers(){$this.div.removeEventListener("dragstart",dragStart,!1),$this.div.removeEventListener("dragover",dragOver,!1),$this.div.removeEventListener("drop",drop,!1)}function matchItem(str,item){return UILFuzzySearch.search(str,item.id.toLowerCase())||UILFuzzySearch.search(str,item.label.toLowerCase())}function dragStart(e){if(!UILFolder.DragLock){if(!_headerDrag)return e.preventDefault(),void e.stopPropagation();UILFolder.DragLock=_this.id,e.dataTransfer.setData("text/plain",_this.id),e.dataTransfer.effectAllowed="move",$this.css({opacity:.5})}}function dragOver(e){e.preventDefault(),e.dataTransfer.dropEffect="move"}function drop(e){if(!UILFolder.DragLock)return;if(e.dataTransfer.items)for(var i=0;i<e.dataTransfer.items.length;i++)if("file"===e.dataTransfer.items[i].kind)return;e.preventDefault(),_headerDrag=!1;let target=e.currentTarget._this,dragging=_this.parent.get(UILFolder.DragLock);UILFolder.DragLock=null,target&&target.parent&&dragging&&(dragging.element.css({opacity:1}),dragging.parent.get(target.id)&&(e.stopPropagation(),target.parent.container.insertBefore(dragging.element.div,target.element.div),_order=[...target.parent.container.childNodes].map(el=>el._this.id),_this.events.fire(UIL.REORDER,{order:[..._order]}),function saveSort(){UILStorage.set(`UIL_${UIL.sortKey}_${_this.parent.id}_order`,JSON.stringify(_order))}()))}function getUrlID(){return`${Global.PLAYGROUND||"Global"}_folder_${_id}`}function saveFolderState(){sessionStorage.setItem(getUrlID(),JSON.stringify({open:_open}))}function open(keepClosed=!1){_open=!0,$container.css({display:"flex"}),$toggle&&$toggle.text("▼"),RECURSIVE_CLOSE&&1!=keepClosed&&forEachFolder(f=>f.close()),saveFolderState(),_this.onOpen&&_this.onOpen()}function close(){_open=!1,$container.css({display:"none"}),$toggle&&$toggle.text("▶"),saveFolderState()}function onToggle(e){_open?close():open()}function onMouseDown(e){_headerDrag=!0,$header.div.addEventListener("mouseup",onMouseUp)}function onMouseUp(e){_headerDrag=!1,$header.div.removeEventListener("mouseup",onMouseUp)}function onKeydown(e){13===e.which&&(_open?close():open())}function onKeyup(e){_hasClipboard&&("c"==e.key&&e.metaKey?function onCopy(){UILClipboard.copy(_children)}():"v"==e.key&&e.metaKey&&function onPaste(){UILClipboard.paste(_children)}())}function onFocus(){$this.css({border:"1px solid #37a1ef"}),$this.div.classList.add("active"),_hasClipboard=!0}function onBlur(){$this.css({border:"none",border:"1px solid #161616"}),$this.div.classList.remove("active"),_hasClipboard=!1}function forEachFolder(cb){return Object.values(_children).forEach(el=>{el instanceof UILFolder&&(cb(el),el.forEachFolder(cb))}),_this}!function init(){$this=_this.element,$this.size("100%","auto").bg(_opts.background||"#272727"),$this.css({position:"relative",border:"1px solid #161616",boxSizing:"border-box",maxHeight:_opts.maxHeight||"none"}),$this.attr("data-id",_id),$this.attr("data-type","UILFolder"),$this.div._this=_this}(),function style(){UIL.addCSS(UILFolder,"\n            .UILFolder *:focus { outline: none; }\n            .UILFolder input:focus { border-color:#37a1ef!important; }\n            .UILFolder button:focus { border-color:#37a1ef!important; }\n            .UILFolder .UILFolder .UILFolder .toggle {margin-left:8px; }\n            .UILFolder .UILFolder .UILFolder .UILFolder .toggle {margin-left:16px; }\n            .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .toggle {margin-left:24px; }\n            .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .toggle {margin-left:32px; }\n            .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .UILFolder .toggle {margin-left:40px; }\n        ")}(),function initHeader(){_opts.hideTitle||($header=$this.create("title","a"),$header.attr("tabindex","0"),$header.size("100%","auto").bg("#272727"),$header.css({display:"block",padding:"4px 4px",boxSizing:"border-box",fontWeight:"bold",userSelect:"none",borderBottom:"1px solid #161616"}),$header.fontStyle("sans-serif",11,"#B1B1B1"),$header.div.addEventListener("keydown",onKeydown,!1),$header.div.addEventListener("click",onToggle,!1),$header.div.addEventListener("mousedown",onMouseDown),$header.div.addEventListener("focus",onFocus,!1),$header.div.addEventListener("blur",onBlur,!1),$header.div.addEventListener("keydown",onKeyup,!1),$toggle=$header.create("toggle"),$toggle.text(_open?"▼":"▶").css({fontSize:8,display:"inline-block",verticalAlign:"middle"}),$drag=$header.create("drag"),$drag.text("☰").css({position:"absolute",right:7,top:3,display:"inline-block",pointerEvents:"none"}),$drag.hide(),$title=$header.create("title"),$title.text(_this.label).css({display:"inline-block",marginLeft:4}))}(),function initContainer(){$container=$this.create("container"),$container.size("100%","100%").css({display:"flex",flexDirection:"column",position:"relative",overflowY:"auto"}),_open||$container.css({display:"none"}),_this.container=$container.div}(),function restoreFolderState(){let json=JSON.parse(sessionStorage.getItem(getUrlID()));json&&(json.open?open():close())}(),this.add=function(child){return child.draggable&&child.draggable(_sortableChildren),child.parent=_this,_children[child.id]=child,$container.add(child),_this},this.remove=function(x){let id="string"==typeof x?x:x.id,child=_children[id];return child.eliminate&&child.eliminate(),child.destroy(),_order&&(_order=_order.filter(child=>child!==id)),delete _children[id],_this},this.get=function(id){return _children[id]},this.getAll=function(){return Object.values(_children)},this.getVisible=function(){return Object.values(_children).filter(x=>x.isVisible())},this.find=function(id){return id===_id?_this:Object.values(_children).reduce((acc,item)=>item.id===id?acc.concat(item):item instanceof UILFolder?acc.concat(item.find(id)):acc,[])},this.filter=function(str){return function filter(str,match=!1){str=str.toLowerCase();let result=[],haystack=Object.values(_children);for(let el of haystack)if(el instanceof UILFolder){let matches=el.filter(str,!0);matches.length?(result.concat(matches),el.show(),el.open()):matchItem(str,el)?(result.push(el),el.show(),el.showChildren(),el.close()):el.getVisible().length?el.show():el.hide()}else matchItem(str,el)?(result.push(el),el.show()):el.hide();return result}(str)},this.filterSingle=function filterSingle(str){str=str.toLowerCase();let haystack=Object.values(_children);for(let el of haystack)el instanceof UILFolder?(el.filterSingle(str),str==el.label.toLowerCase()||str==el.id.toLowerCase()?(el.show(),el.showChildren(),el.open(!0)):el.getVisible().length?el.show():el.hide()):matchItem(str,el)?(el.show(),el.open&&el.open(!0)):el.hide();return[]},this.open=function(keepClosed){return open(keepClosed),_this},this.close=function(){return close(),_this},this.setLabel=function(label){return _this.label=`${label}`,$title.text(label),_this},this.hide=function(){return _visible=!1,$this.css({display:"none"}),_this},this.show=function(){return _visible=!0,$this.css({display:"block"}),_this},this.showChildren=function(){return Object.values(_children).forEach(el=>el instanceof UILFolder?el.showChildren():el.show()),_this.show(),_this},this.isOpen=function(){return _open},this.isVisible=function(){return _visible},this.forEachFolder=function(cb){return forEachFolder(cb)},this.forEachControl=function(cb){return Object.values(_children).forEach(el=>{el instanceof UILFolder?el.forEachControl(cb):cb(el)}),_this},this.enableSorting=function(key){_sortableChildren=!0,UIL.sortKey=key,Object.values(_children).forEach(el=>{el instanceof UILFolder&&el.draggable(!0)});let order=function getSort(){let sort=UILStorage.get(`UIL_${UIL.sortKey}_${_id}_order`);if(sort)return JSON.parse(sort)}();return order&&(_order=order,function restoreSort(){_order.forEach(id=>{_children[id]&&$container.add(_children[id])})}()),_this},this.draggable=function(enable){_draggable=enable,$this.attr("draggable",enable),enable?(!function addDragHandlers(){$this.div.addEventListener("dragstart",dragStart,!1),$this.div.addEventListener("dragover",dragOver,!1),$this.div.addEventListener("drop",drop,!1)}(),$drag&&$drag.show()):(removeDragHandlers(),$drag&&$drag.hide())},this.toClipboard=function(){UILClipboard.copy(_children)},this.fromClipboard=function(){UILClipboard.paste(_children)},this.eliminate=function(){_opts.hideTitle||($header.div.removeEventListener("keydown",onToggle,!1),$header.div.removeEventListener("click",onToggle,!1),$header.div.removeEventListener("mousedown",onMouseDown),$header.div.removeEventListener("focus",onFocus,!1),$header.div.removeEventListener("blur",onBlur,!1)),_draggable&&removeDragHandlers()},this.forceSort=function(index){_this.parent.container.insertBefore(_this.element.div,_this.parent.container.children[index]),_order=[..._this.parent.container.childNodes].map(el=>el._this.id),_this.events.fire(UIL.REORDER,{order:[..._order]})},this.openChildren=function(){Object.values(_children).forEach(el=>el instanceof UILFolder?el.open():null)}})),Class((function UILPanel(_title,_opts={}){Inherit(this,Element);const _this=this;let $this,_folder,_toolbar,_hidden=!1;function onKeydown(e){if(e.ctrlKey||e.metaKey){if(72==e.keyCode&&e.shiftKey){if(`${document.activeElement.type}`.includes(["textarea","input","number"]))return;e.preventDefault(),_hidden?function show(){$this.visible(),_hidden=!1}():function hide(){$this.invisible(),_hidden=!0}()}37==e.keyCode&&e.shiftKey&&(e.preventDefault(),$this.css({left:0,right:"auto"})),39==e.keyCode&&e.shiftKey&&(e.preventDefault(),$this.css({left:"auto",right:0})),67==e.which&&e.shiftKey&&(e.preventDefault(),_folder.forEachFolder(f=>f.close())),79==e.which&&e.shiftKey&&(e.preventDefault(),_folder.forEachFolder(f=>f.open()))}}function undim(){$this.css({opacity:1})}function dim(){$this.css({opacity:.3})}_this.id=_title,function initHTML(){$this=_this.element,$this.size(_opts.width||"300px",_opts.height||"auto").bg("#161616").mouseEnabled(!0),"left"===_opts.side?$this.css({left:0}):$this.css({right:0}),$this.css({top:0,maxHeight:_opts.maxHeight||"100%",position:"absolute",userSelect:"none",padding:4,overflowY:"auto",borderRadius:4}),$this.hide()}(),function initToolbar(){_toolbar=_this.toolbar=_this.initClass(UILPanelToolbar)}(),function initGroup(){_folder=_this.initClass(UILFolder,_title,{hideTitle:!0,drag:!1,background:"#161616"}),_this.folder=_folder}(),function addHandlers(){document.addEventListener("keydown",onKeydown,!1),_opts.hide&&($this.div.addEventListener("mouseover",undim,!1),$this.div.addEventListener("mouseleave",dim,!1))}(),this.add=function(child){return $this.show(),_folder.add(child),_this},this.remove=function(x){return _folder.remove(x.id),_this},this.get=function(id){return _folder.get(id)},this.find=function(id){return _folder.find(id)},this.filter=function(str){return _folder.filter(str)},this.enableSorting=function(key){return _folder.enableSorting&&_folder.enableSorting(key),_this},this.eliminate=function(){_toolbar.eliminate(),$this.div.removeEventListener("mouseover",undim,!1),$this.div.removeEventListener("mouseleave",dim,!1),document.removeEventListener("keydown",onKeydown,!1)}})),Class((function UILControlButton(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,_buttons=[];!function init(){_this.init(_id,_opts),_opts.hideLabel&&(_this.$label.css({display:"none"}),_this.$content.css({width:"100%"}))}(),function initActions(){$view=$("inputs");let config=[].concat(_opts.actions);_buttons=[].concat(_opts.actions).map(({title:title,callback:callback})=>{let btn=$view.create(`btn btn-${title}`,"button");return btn.text(title).bg("#1d1d1d"),btn.css({width:`calc(100% / ${config.length||1}`,border:"1px solid #2e2e2e",color:"#37a1ef",position:"relative"}),btn.interact(e=>(function hover(btn,e){"over"===e.action?btn.css({border:"1px solid #9b9c9b"}):btn.css({border:"1px solid #2e2e2e"})})(btn,e)),btn.click(e=>(function click(e,title,callback){_this.value=title,callback&&callback(title,e),_this.finish()})(e,title,callback)),btn}),_this.view=$view}(),this.setTitle=function(text){_buttons.forEach(btn=>{btn.text(text)})}})),Class((function UILControlCheckbox(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,$label,$checkbox,$slider;function toggle(){$checkbox.attr("checked",_this.value),$slider.css({right:_this.value?0:"auto"}),$label.bg(_this.value?"#37a1ef":"#1d1d1d")}function click(){_this.value=!_this.value,toggle(),_this.finish()}function focus(){$label.css({border:"1px solid #37a1ef"})}function blur(){$label.css({border:"1px solid #2e2e2e"})}!function init(){_opts.value=_opts.value||!1,_this.init(_id,_opts)}(),function initView(){$view=$("view"),$label=$view.create("label","label"),$label.size(30,15).css({position:"relative",display:"inline-block",borderRadius:15,border:"1px solid #2e2e2e"}).bg(_this.value?"#37a1ef":"#1d1d1d"),$checkbox=$label.create("checkbox","input"),$checkbox.attr("type","checkbox"),$checkbox.attr("checked",_this.value),$checkbox.css({opacity:0,width:"100%",position:"absolute"}),$slider=$label.create("slider"),$slider.size(15,15).css({borderRadius:15,position:"absolute",right:_this.value?0:"auto",boxSizing:"border-box"}).bg("#ffffff"),_this.view=$view}(),function addHandlers(){$checkbox.div.addEventListener("focus",focus,!1),$checkbox.div.addEventListener("blur",blur,!1),$checkbox.div.addEventListener("click",click,!1),$checkbox.div.addEventListener("keypress",click,!1)}(),this.update=function(){toggle()},this.onDestroy=function(){$checkbox.div.removeEventListener("focus",focus,!1),$checkbox.div.removeEventListener("blur",blur,!1),$checkbox.div.removeEventListener("click",click,!1),$checkbox.div.removeEventListener("keypress",click,!1)}})),Class((function UILControlColor(_id,_opts={}){Inherit(this,UILControl);const _this=this;var $display,_input;function onDisplayClick(){_input&&(_this.events.unsub(_input,Events.UPDATE,onChange),_input=_input.destroy()),_input=_this.initClass(UILExternalColor,_opts.label||_id,_this.value),_this.events.sub(_input,Events.UPDATE,onChange)}function onChange({value:value}){_this.value=value,$display.bg(_this.value),$display.hex.css({color:_this.value}).text(_this.value),finishChange()}function finishChange(){_this.finish()}!function init(){_opts.value=_opts.value||"#ffffff",_this.init(_id,_opts)}(),function initInput(){let $view=$("color");$view.css({position:"relative"}).css({padding:1}),($display=$view.create("color")).size("100%","100%").bg(_this.value),$display.css({border:"1px solid #2E2E2E",boxSizing:"border-box"}),$display.hex=$display.create("hex"),$display.hex.text(_this.value),$display.hex.css({color:_this.value,filter:"invert(100%)",fontSize:12,fontFamily:"sans-serif",padding:1}),_this.view=$view}(),function addHandlers(){$display.interact(null,onDisplayClick),finishChange=_this.debounce(finishChange,250)}(),this.update=function(){$display.bg(_this.value),$display.hex.css({color:_this.value}).text(_this.value)},this.onDestroy=function(){}})),Class((function UILControlFile(_id,_opts={value:{}}){Inherit(this,UILControl);const _this=this;let $view,$picker,$preview,$img,$input,$$copy,_value;async function change(e){let file=$picker.div.files[0];file&&(_value.filename=file.name,_value.relative=function getRelative(){return _value.relative.includes(_value.prefix)?_value.relative.replace(`${_value.prefix}`,""):_value.relative}(),_value.src=function getSrc(){return`${_value.prefix?_value.prefix+"/":""}${_value.relative?_value.relative+"/":""}${_value.filename}`}(),await function fileExists(url){return fetch(url).then(e=>404!=e.status).catch(e=>console.warn("UILControlImage image url validation failed",e))}(_value.src)?(_this.value=Object.assign({},_value),$img.attr("title",_value.src),$$copy.text(_value.filename),_this.finish()):($picker.div.value="",console.warn("UIL: Could not find file",_value),alert(`"${_value.src}" not found!\nMake sure "relative path" is correct.`)))}function focus(){$img.css({border:"1px solid #37a1ef"})}function blur(){$img.css({border:"1px dotted #2e2e2e"})}function inputChange(){_value.relative=$input.div.value}!function init(){_opts.value=Object.assign({src:"",relative:_opts.relative||"",prefix:_opts.prefix,filename:""},_opts.value),_value=Object.assign({},_opts.value),_this.init(_id,_opts)}(),function initView(){$view=$("view"),$view.css({position:"relative",padding:5}),$input=$view.create("path","input"),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",border:"1px solid #2E2E2E",color:"#37A1EF",marginBottom:5}),_this.value.relative?$input.div.value=_this.value.relative:$input.attr("placeholder","Relative Path"),$preview=$view.create("preview"),$preview.size("100%",60),$preview.css({boxSizing:"border-box",position:"relative",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}),$img=$preview.create("img"),$img.size("100%"),$img.css({position:"absolute",top:0,right:0,bottom:0,left:0,backgroundSize:"cover",backgroundRepeat:"no-repeat",backgroundPosition:"center",border:"1px dotted #2e2e2e",boxSizing:"border-box"}),$picker=$preview.create("picker","input"),$picker.attr("type","file"),$picker.css({opacity:0,position:"absolute",top:0,right:0,bottom:0,left:0}),$$copy=$preview.create("copy"),$$copy.html("Drag file here<br><small>or Click to Select</small>"),$$copy.fontStyle("sans-serif",11,"#9B9C9B").css({textAlign:"center"}),_this.view=$view}(),function addHandlers(){$picker.div.addEventListener("change",change,!1),$picker.div.addEventListener("focus",focus,!1),$picker.div.addEventListener("blur",blur,!1),$input.div.addEventListener("change",inputChange,!1)}(),this.force=function(value){_value=Object.assign({},value),$input.div.value=_value.relative,$img.attr("title",_value.src),$$copy.text(_value.filename)},this.onDestroy=function(){$picker.div.removeEventListener("change",change,!1),$picker.div.removeEventListener("focus",focus,!1),$picker.div.removeEventListener("blur",blur,!1),$input.div.removeEventListener("change",inputChange,!1)}})),Class((function UILControlImage(_id,_opts={value:{}}){Inherit(this,UILControl);const _this=this;let $view,$picker,$preview,$img,$input,$check,$compress,_value;async function compressClick(){if(_value.src&&!_this.flag("compressPending")){_this.flag("compressPending",!0),$compress.bg("#f4ee42").text("---");try{"Error"==await Dev.execUILScript("compressktx",{src:_value.src})?$compress.bg("#f44141").html("Failed"):$compress.bg("#46f441").html("Success")}catch(e){$compress.bg("#f44141").html("Failed"),console.error(e)}_this.flag("compressPending",!1)}}function checkChange(){_this.value.compressed=_value.compressed=!!$check.div.checked,_this.finish(!1)}async function change(e){let file=$picker.div.files[0];file&&(_value.filename=file.name,_value.relative=function getRelative(){return _value.relative.includes(_value.prefix)?_value.relative.replace(`${_value.prefix}`,""):_value.relative}(),_value.src=function getSrc(){return`${_value.prefix?_value.prefix+"/":""}${_value.relative?_value.relative+"/":""}${_value.filename}`}(),_value.compressed=!!$check.div.checked,await function imageExists(url){return fetch(url).then(e=>404!=e.status).catch(e=>console.warn("UILControlImage image url validation failed",e))}(_value.src)?(_this.value=Object.assign({},_value),$img.attr("title",_value.src),$img.css({backgroundImage:`url(${_value.src})`}),_this.finish()):($picker.div.value="",console.warn("UIL: Could not find image",_value),alert(`"${_value.src}" not found!\nMake sure "relative path" is correct.`)))}function focus(){$img.css({border:"1px solid #37a1ef"})}function blur(){$img.css({border:"1px dotted #2e2e2e"})}function inputChange(){_value.relative=$input.div.value}!function init(){_opts.value=Object.assign({src:"",relative:_opts.relative||"",prefix:_opts.prefix||"assets/images",filename:""},_opts.value),_value=Object.assign({},_opts.value),_this.init(_id,_opts)}(),function initView(){$view=$("view"),$view.css({position:"relative",padding:5}),$input=$view.create("path","input"),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",border:"1px solid #2E2E2E",color:"#37A1EF",marginBottom:5}),_this.value.relative?$input.div.value=_this.value.relative:$input.attr("placeholder","Relative Path"),$compress=$view.create("compress"),$compress.text("Compress").bg("#fff").css({top:3,width:70,height:15,textAlign:"center",borderRadius:5,position:"relative",float:"left",paddingTop:2}).fontStyle("sans-serif",11,"#000"),$check=$view.create("#compressed","input"),$check.attr("type","checkbox"),$check.size(20,20),$check.css({boxSizing:"border-box",position:"relative"}),$check.div.checked=!!_this.value.compressed;let $label=$view.create("compressed-label","label");$label.attr("for","compressed"),$label.text("Use Compressed").fontStyle("sans-serif",9,"#9B9C9B").css({top:-6,position:"relative"}),$preview=$view.create("preview"),$preview.size("100%",60),$preview.css({boxSizing:"border-box",position:"relative",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"}),$img=$preview.create("img"),$img.size("100%"),$img.css({position:"absolute",top:0,right:0,bottom:0,left:0,backgroundSize:"cover",backgroundRepeat:"no-repeat",backgroundPosition:"center",border:"1px dotted #2e2e2e",boxSizing:"border-box"}),_this.value.src&&$img.css({backgroundImage:`url('${_this.value.src}')`}),$picker=$preview.create("picker","input"),$picker.attr("type","file"),$picker.attr("accept","image/*"),$picker.css({opacity:0,position:"absolute",top:0,right:0,bottom:0,left:0});let copy=$preview.create("copy");copy.html("Drag image here<br><small>or Click to Select</small>"),copy.fontStyle("sans-serif",11,"#9B9C9B").css({textAlign:"center"}),_this.view=$view}(),function addHandlers(){$picker.div.addEventListener("change",change,!1),$picker.div.addEventListener("focus",focus,!1),$picker.div.addEventListener("blur",blur,!1),$input.div.addEventListener("change",inputChange,!1),$compress.div.onclick=compressClick,$check.div.onchange=checkChange}(),this.force=function(value,isClipboard){_value=Object.assign({},value),!0===isClipboard&&(_this.value=_value),$input.div.value=_value.relative,$img.attr("title",_value.src),$img.css({backgroundImage:`url('${_value.src}')`}),$check.div.checked=_value.compressed},this.onDestroy=function(){$picker.div.removeEventListener("change",change,!1),$picker.div.removeEventListener("focus",focus,!1),$picker.div.removeEventListener("blur",blur,!1),$input.div.removeEventListener("change",inputChange,!1)}})),Class((function UILControlNumber(_id,_opts={}){Inherit(this,UILControl);const _this=this;let _input;!function init(){_opts.value=_opts.value||0,_this.init(_id,_opts)}(),function initInput(){_input=_this.initClass(UILInputNumber,Object.assign(_opts,{value:_this.value})),_input.onInput(v=>_this.value=v),_input.onFinish(v=>_this.finish()),_this.view=_input.input}(),this.update=function(value){_input.value=_this.value||0}})),Class((function UILControlRange(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,$slider,_max=_opts.max||100,_min=_opts.min||0,_step=_opts.step||1;function change(){_this.finish()}function input(e){_this.value=Number($slider.div.value)}function focus(){$slider.css({border:"1px solid #37a1ef"})}function blur(){$slider.css({border:"1px solid #2e2e2e"})}!function init(){_opts.value=_opts.value||0,_this.init(_id,_opts)}(),function style(){UIL.addCSS(UILControlRange,"\n            .UILControlRange input { -webkit-appearance:none; appearance:none; }\n            .UILControlRange input::-webkit-slider-thumb { -webkit-appearance: none; }\n            .UILControlRange input::-webkit-slider-thumb { \n                -webkit-appearance:none; appearance:none;\n                width:15px; height:15px;\n                background:#FFF;\n                border-radius:15px;\n            }\n            .UILControlRange input::-moz-slider-thumb { \n                -webkit-appearance:none; appearance:none;\n                width:15px; height:15px;\n                background:#FFF;\n                border-radius:15px;\n            }\n        ")}(),function initView(){$view=$("view"),$slider=$view.create("range","input"),$slider.attr("type","range"),$slider.attr("max",_max),$slider.attr("min",_min),$slider.attr("step",_step),$slider.div.value=_this.value,$slider.css({width:"100%",margin:0,padding:0,background:"#1d1d1d",height:4,borderRadius:15,border:"1px solid #2e2e2e",boxSizing:"border-box"}),_this.view=$view}(),function addHandlers(){$slider.div.addEventListener("change",change,!1),$slider.div.addEventListener("input",input,!1),$slider.div.addEventListener("focus",focus,!1),$slider.div.addEventListener("blur",blur,!1)}(),this.force=function(value){_this.value=value,$slider.div.value=value,_this.finish(!1)},this.onDestroy=function(){$slider.div.removeEventListener("change",change,!1),$slider.div.removeEventListener("input",input,!1),$slider.div.removeEventListener("focus",focus,!1),$slider.div.removeEventListener("blur",blur,!1)}})),Class((function UILControlSelect(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,$select,_options;function change(){_this.finish()}function input(){let i=$select.div.selectedIndex;_this.value=_options[i].value}function focus(){$select.css({border:"1px solid #37a1ef"})}function blur(){$select.css({border:"1px solid #2e2e2e"})}!function init(){if(!_opts.options)throw"UILControlSelect is missing select options";_opts.value=_opts.value||_opts.options[0].value,_this.init(_id,_opts)}(),function style(){UIL.addCSS(UILControlSelect,"\n            .UILControlSelect select { -webkit-appearance:none; appearance:none; }\n        ")}(),function initView(){$view=$("view"),$view.css({position:"relative"}),$select=$view.create("dropdown","select"),$select.css({width:"100%",margin:0,padding:0,background:"#1d1d1d",height:15,border:"1px solid #2e2e2e",boxSizing:"border-box",color:"#37a1ef",borderRadius:0,height:17}),$select.div.value=_this.value,$view.create("arrow").text("▼").css({color:"#37a1ef",fontSize:6,position:"absolute",right:8,top:7,pointerEvents:"none"}),_this.view=$view}(),function initOptions(){_options=_opts.options.map(({value:value,label:label})=>{let el=document.createElement("option");return el.setAttribute("value",value),_this.value===value&&el.setAttribute("selected",!0),el.text=label||value,el.value=value,$select.add(el),el})}(),function addHandlers(){$select.div.addEventListener("change",change,!1),$select.div.addEventListener("input",input,!1),$select.div.addEventListener("focus",focus,!1),$select.div.addEventListener("blur",blur,!1)}(),this.force=function(value){$select.div.value=value,_this.value=value},this.onDestroy=function(){$select.div.removeEventListener("change",change,!1),$select.div.removeEventListener("input",input,!1),$select.div.removeEventListener("focus",focus,!1),$select.div.removeEventListener("blur",blur,!1)}})),Class((function UILControlText(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $input,_timeout;function onChange(v){clearTimeout(_timeout),0===$input.div.value.trim().length&&void 0===_this.value||(_timeout=setTimeout(onFinishChange,400),_this.value=$input.div.value)}function onFinishChange(){null!==_timeout&&(clearTimeout(_timeout),_timeout=null,_this.finish())}_this.init(_id,_opts),function initInput(){$input=$("input","input"),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",border:"1px solid #2E2E2E",color:"#37A1EF"}),_this.value&&($input.div.value=_this.value||""),_this.view=$input}(),function addHandlers(){$input.div.addEventListener("input",onChange,!1),$input.div.addEventListener("change",onFinishChange,!1),$input.div.addEventListener("blur",onChange,!1),$input.div.addEventListener("keyup",onChange,!1)}(),this.update=function(){$input.div.value=_this.value||""},this.onDestroy=function(){$input.div.removeEventListener("input",onChange,!1),$input.div.removeEventListener("change",onFinishChange,!1),$input.div.removeEventListener("blur",onChange,!1),$input.div.removeEventListener("keyup",onChange,!1)}})),Class((function UILControlTextarea(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $input,_timeout;function onChange(v){clearTimeout(_timeout),0===$input.div.value.trim().length&&void 0===_this.value||(_timeout=setTimeout(onFinishChange,400),_this.value=$input.div.value)}function onFinishChange(){null!==_timeout&&(clearTimeout(_timeout),_timeout=null,_this.finish())}_this.init(_id,_opts),function initInput(){$input=$("input","textarea"),$input.attr("maxlength",_opts.max||1/0),$input.attr("minlength",_opts.min||-1/0),$input.attr("rows",_opts.rows||2),$input.attr("readonly",_opts.readonly||!1),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",resize:_opts.resize||"vertical",minWidth:_opts.minWidth||0,border:"1px solid #2E2E2E",color:"#37A1EF"}),(_opts.monospace||_opts.editor)&&$input.css({fontFamily:"monospace"}),_this.value&&($input.div.value=_this.value||""),_this.view=$input}(),_opts.editor&&function enableTab(){$input.div.onkeydown=function(e){if(9===e.keyCode){let val=this.value,start=this.selectionStart,end=this.selectionEnd;this.value=val.substring(0,start)+"\t"+val.substring(end),this.selectionStart=this.selectionEnd=start+1,e.preventDefault()}}}(),function addHandlers(){$input.div.addEventListener("mousedown",onChange,!1),$input.div.addEventListener("keyup",onChange,!1),$input.div.addEventListener("input",onChange,!1),$input.div.addEventListener("change",onFinishChange,!1),$input.div.addEventListener("blur",onChange,!1)}(),this.update=function(){$input.div.value=_this.value||""},this.onDestroy=function(){$input.div.removeEventListener("mousedown",onChange,!1),$input.div.removeEventListener("keyup",onChange,!1),$input.div.removeEventListener("input",onChange,!1),$input.div.removeEventListener("change",onFinishChange,!1),$input.div.removeEventListener("blur",onChange,!1)}})),Class((function UILControlVector(_id,_opts={}){Inherit(this,UILControl);const _this=this;let $view,_length,_inputs=[],_vector=[];function onInput(value,index,master){master?_vector=_vector.map(v=>value):_vector[index]=value,_this.value=[..._vector]}function onFinish(value,index,master){_this.finish()}!function init(){if(_opts.value)_length=_vector.length;else{if(!_opts.components)throw'UILControlVector: Cannot detect vector type. Define "options.components" count or init with a initial value';_opts.value=new Array(_opts.components).fill(0)}_length=_opts.value.length,_this.init(_id,_opts),_vector=[..._this.value]}(),function initInputs(){$view=$("inputs");for(let i=0;i<_length;i++){let input=_this.initClass(UILInputNumber,_opts);input.value=_this.value[i],input.onInput((v,m)=>onInput(v,i,m)),input.onFinish((v,m)=>onFinish(v,i,m)),input.input.css({display:"inline-block",width:`calc(100% / ${_length})`}),_inputs.push(input),$view.add(input.input)}_this.view=$view}(),this.force=function(value){_vector=[...value],_this.value=[..._vector],_inputs.forEach((input,index)=>input.value=_this.value[index]),_this.finish(!1)},this.update=function(){_inputs.forEach((input,index)=>input.value=_this.value[index])}})),Class((function UILInputNumber(_opts={}){Inherit(this,Component);const _this=this;let $input,_timeout,_distance,_onMouseDownValue,_editing=!1,_precision=_opts.precision||3,_step=_opts.step||1,_min=_opts.min||-1/0,_max=_opts.max||1/0,_value=_opts.value||0,_pointer=[0,0],_prevPointer=[0,0],_onInputCB=()=>{},_onFinishCB=()=>{};function setValue(value){(value=parseFloat(value)||0)<_min&&(value=_min),value>_max&&(value=_max),_value=value,_onInputCB(value,_this.master)}function onBlur(){onFinishChange(),$input.div.value=parseFloat(_value).toFixed(_precision)}function onKeyUp(e){13===e.keyCode&&e.altKey&&(_this.master=!0,onInput())}function onInput(e){_timeout=setTimeout(onFinishChange,400),_editing=!0,setValue(parseFloat($input.div.value))}function onFinishChange(){_editing&&(_editing=!1,clearTimeout(_timeout),_onFinishCB(_value,_this.master),_this.master=!1)}function onMouseDown(e){(1===e.button||0===e.button&&e.metaKey||e.ctrlKey)&&(e.preventDefault(),$input.css({cursor:"col-resize"}),_distance=0,_onMouseDownValue=_value,_prevPointer=[e.screenX,e.screenY],document.addEventListener("mousemove",onMouseMove,!1),document.addEventListener("mouseup",onMouseUp,!1))}function onMouseMove(e){clearTimeout(_timeout),_editing=!0;let currentValue=_value;_pointer=[e.screenX,e.screenY],_distance+=_pointer[0]-_prevPointer[0]-(_pointer[1]-_prevPointer[1]);let value=_onMouseDownValue+_distance/(e.shiftKey?5:50)*_step;value=Math.min(_max,Math.max(_min,value)),_this.master=e.altKey,currentValue!==value&&function setValueDrag(value){void 0===value&&value===$input.div.value||(setValue(value),$input.div.value=_value.toFixed(_precision))}(value),_prevPointer=[e.screenX,e.screenY]}function onMouseUp(e){onFinishChange(),$input.css({cursor:""}),document.removeEventListener("mousemove",onMouseMove,!1),document.removeEventListener("mouseup",onMouseUp,!1)}!function initInput(){$input=$("input","input"),$input.attr("type","number"),$input.attr("step",_step),$input.size("100%").bg("#1D1D1D"),$input.css({boxSizing:"border-box",border:"1px solid #2E2E2E",color:"#37A1EF",boxShadow:"none"}),$input.div.value=parseFloat(_value).toFixed(_precision),_this.input=$input}(),function addHandlers(){$input.div.addEventListener("mousedown",onMouseDown,!1),$input.div.addEventListener("keyup",onKeyUp,!1),$input.div.addEventListener("change",onFinishChange,!1),$input.div.addEventListener("blur",onBlur,!1),$input.div.addEventListener("input",onInput,!1)}(),this.set("value",value=>{_value=value,_editing||($input.div.value=parseFloat(value).toFixed(_precision))}),this.get("value",()=>_value),this.onInput=cb=>_onInputCB=cb,this.onFinish=cb=>_onFinishCB=cb,this.onDestroy=function(){$input.div.removeEventListener("mousedown",onMouseDown,!1),$input.div.removeEventListener("change",onFinishChange,!1),$input.div.removeEventListener("blur",onBlur,!1),$input.div.removeEventListener("input",onInput,!1)}})),Class((function UILExternalColor(_title,_value){Inherit(this,Component);const _this=this;var _window;function onReload(){_this.onDestroy()}(_window=window.open("http://localhost/hydra/editor/color/index.html",`hydra_color_${_title}`,"width=480,height=220,left=200,top=100,location=no")).window.onload=_=>{_window.window.initPicker(_title,_value,_this)},window.addEventListener("beforeunload",onReload),this.update=function(value){_this.events.fire(Events.UPDATE,{value:value})},this.onDestroy=function(){window.removeEventListener("beforeunload",onReload),_window&&_window.window&&_window.window.close()}})),Class((function UILExternalEditor(_title,_height=500){Inherit(this,Component);const _this=this;var _window,_code,_language;_window=window.open("http://localhost/hydra/editor/code/index.html","_blank",`width=700,height=${_height},left=200,top=100`),_this.events.sub(Events.UNLOAD,_=>_window.close()),_window.window.onload=_=>{_window.window.initEditor(_title,_code,_language,_this)},this.setCode=function(code,language){_code=code,_language=language},this.saved=async function(code){_this.onSave&&_this.onSave(code),await defer(),UILStorage.write()}})),Class((function UILPanelToolbar(){Inherit(this,Element);const _this=this;let $this,$filter,_state=new Map;function restoreFolderState(){_this.parent.folder.forEachFolder(folder=>{_state.get(folder)?folder.open():folder.close()}),_state.clear()}function onInput(e){if(!$filter.div.value.length)return restoreFolderState(),_this.parent.folder.showChildren();_this.parent.folder.filter($filter.div.value)}function onFocus(){!function saveFolderState(){_this.parent.folder.forEachFolder(folder=>{_state.set(folder,folder.isOpen())})}(),$filter.css({border:"1px solid #37a1ef"})}function onBlur(){$filter.css({border:"1px solid #2e2e2e"})}function onKeyPressed(e){if(27===e.keyCode)return $filter.div.value="",restoreFolderState(),_this.parent.folder.showChildren()}!function initHTML(){$this=_this.element,$this.size("100%","auto").bg("#272727"),$this.css({padding:4,boxSizing:"border-box",marginBottom:4})}(),function initFilter(){$filter=$this.create("filter","input"),$filter.div.addEventListener("input",onInput,!1),$filter.div.addEventListener("keydown",onKeyPressed,!1),$filter.div.addEventListener("focus",onFocus,!1),$filter.div.addEventListener("blur",onBlur,!1),$filter.size("100%","auto").bg("#161616"),$filter.css({color:"#B1B1B1",border:"1px solid #2e2e2e",outline:"none",padding:2,boxSizing:"border-box"})}(),this.eliminate=function(){$filter.div.removeEventListener("input",onInput,!1),$filter.div.removeEventListener("keydown",onKeyPressed,!1),$filter.div.removeEventListener("focus",onFocus,!1),$filter.div.removeEventListener("blur",onBlur,!1)},this.filter=function(text){$filter.div.value=text,onInput()},this.filterSingle=function(text){$filter.div.value=text,_this.parent.folder.filterSingle($filter.div.value)},this.hideAll=function(){_this.flag("init")||(_this.flag("init",!0),this.filterSingle("xxxxxx"))}})),Class((function RGBCombine(){Inherit(this,Component);!function(){let r,g,b,folder=new UILFolder("rgbcombine",{label:"RGBCombine",closed:!1});UIL.global.add(folder);let red=new UILControlImage("file",{label:"Red"});red.onFinishChange(e=>{r=e.src}),folder.add(red);let green=new UILControlImage("file",{label:"Green"});green.onFinishChange(e=>{g=e.src}),folder.add(green);let blue=new UILControlImage("file",{label:"Blue"});blue.onFinishChange(e=>{b=e.src}),folder.add(blue);let button=new UILControlButton("button",{actions:[{title:"Run",callback:async _=>{if("ERROR"==await Dev.execUILScript("rgbcombine",{img0:r,img1:g,img2:b}))return"Failed to combine rgb";console.log("RGBCombine complete!")}}],hideLabel:!0});folder.add(button)}()})),Namespace("FX"),FX.Class((function UnrealBloom(_nuke,options,_unique){Inherit(this,Component);var _triangleGeometry,_luminosityShader,_compositeShader,_mesh,_inputTexture,_this=this;"string"==typeof options?(_unique=_params,options={},_nuke=World.NUKE):"string"==typeof _nuke?(_unique=_nuke,options={},_nuke=World.NUKE):!_nuke||_nuke instanceof Nuke?(_nuke=_nuke||World.NUKE,options=options||{},_unique=_unique||""):(options=_nuke,_nuke=World.NUKE);var _oldClearColor=new Color,_oldClearAlpha=1,_renderTargetsHorizontal=[],_renderTargetsVertical=[],_separableBlurShaders=[],_nMips=options.nMips||5,_DPR=_nuke.dpr,_blurDirectionX=new Vector2(_DPR,0),_blurDirectionY=new Vector2(0,_DPR),_kernelSizeArray=options.kernelSizeArray||[3,5,7,9,11],_bloomFactors=options.bloomFactors||[1,.8,.6,.4,.2];function render(){if(!_this.enabled||!1===_this.visible)return;let renderer=_nuke.renderer;_oldClearColor.copy(renderer.getClearColor()),_oldClearAlpha=renderer.getClearAlpha();let oldAutoClear=renderer.autoClear;renderer.autoClear=!0,renderer.setClearColor(_this.clearColor,0),_luminosityShader.uniforms.tDiffuse.value=_inputTexture||_nuke.rttBuffer.texture,_mesh.shader=_luminosityShader,renderer.renderSingle(_mesh,_nuke.camera,_this.renderTargetBright);let inputRenderTarget=_this.renderTargetBright;for(let i=0;i<_nMips;i++)_mesh.shader=_separableBlurShaders[i],_separableBlurShaders[i].uniforms.colorTexture.value=inputRenderTarget.texture,_separableBlurShaders[i].uniforms.direction.value=_blurDirectionX,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsHorizontal[i]),_separableBlurShaders[i].uniforms.colorTexture.value=_renderTargetsHorizontal[i].texture,_separableBlurShaders[i].uniforms.direction.value=_blurDirectionY,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsVertical[i]),inputRenderTarget=_renderTargetsVertical[i];_mesh.shader=_compositeShader,renderer.renderSingle(_mesh,_nuke.camera,_renderTargetsHorizontal[0]),renderer.setClearColor(_oldClearColor,_oldClearAlpha),renderer.autoClear=oldAutoClear}function resizeHandler(){_this.resolution.set(_nuke.stage.width,_nuke.stage.height).multiplyScalar(_DPR),_blurDirectionX.x=_DPR,_blurDirectionY.y=_DPR;let resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);_this.renderTargetBright.setSize(resx,resy);for(var i=0;i<_nMips;i++)_renderTargetsHorizontal[i].setSize(resx,resy),_renderTargetsVertical[i].setSize(resx,resy),_separableBlurShaders[i].uniforms.texSize.value=new Vector2(resx,resy),resx=Math.round(resx/2),resy=Math.round(resy/2)}this.uniforms={tUnrealBloom:{value:null},unique:_unique},this.resolution=new Vector2(_nuke.stage.width*_DPR,_nuke.stage.height*_DPR),this.clearColor=new Color(0,0,0),this.enabled="boolean"!=typeof options.enabled||options.enabled,this.outputTexture=null,function initRTs(){let pars={minFilter:Texture.LINEAR,magFilter:Texture.LINEAR,format:Texture.RGBAFormat},resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);_this.renderTargetBright=new RenderTarget(resx,resy,pars),_this.renderTargetBright.texture.generateMipmaps=!1;for(let i=0;i<_nMips;i++){let renderTargetHorizonal=new RenderTarget(resx,resy,pars);renderTargetHorizonal.texture.generateMipmaps=!1,_renderTargetsHorizontal.push(renderTargetHorizonal);let renderTargetVertical=new RenderTarget(resx,resy,pars);renderTargetVertical.texture.generateMipmaps=!1,_renderTargetsVertical.push(renderTargetVertical),resx=Math.round(resx/2),resy=Math.round(resy/2)}_this.outputTexture=_renderTargetsHorizontal[0].texture,_this.uniforms.tUnrealBloom.value=_renderTargetsHorizontal[0].texture}(),function initScene(){_triangleGeometry=World.QUAD,_luminosityShader=_this.initClass(Shader,"UnrealBloomLuminosity",{tDiffuse:{value:null,ignoreUIL:!0},luminosityThreshold:{value:1},smoothWidth:{value:.01,ignoreUIL:!0},defaultColor:{value:new Color(0),ignoreUIL:!0},defaultOpacity:{value:0,ignoreUIL:!0},unique:_unique}),(_mesh=new Mesh(_triangleGeometry,_luminosityShader)).frustumCulled=!1}(),function initBlurShaders(){let resx=Math.round(_this.resolution.x/2),resy=Math.round(_this.resolution.y/2);for(let i=0;i<_nMips;i++){let shader=_this.initClass(Shader,"UnrealBloomGaussian",{unique:_unique,colorTexture:{value:null},texSize:{value:new Vector2(resx,resy)},direction:{value:new Vector2(.5,.5)}},null,glsl=>`\n#define KERNEL_RADIUS ${_kernelSizeArray[i]}\n#define SIGMA ${_kernelSizeArray[i]}\n${glsl}`,`gaussian${i}`);_separableBlurShaders.push(shader),resx=Math.round(resx/2),resy=Math.round(resy/2)}}(),function initCompositeShader(){let uniforms={bloomStrength:{value:1},bloomTintColor:{value:new Color("#ffffff")},bloomRadius:{value:0},unique:_unique};for(let i=0;i<_nMips;i++)uniforms[`blurTexture${i+1}`]={value:_renderTargetsVertical[i].texture,ignoreUIL:!0};(_compositeShader=_this.initClass(Shader,"UnrealBloomComposite",uniforms,null,(glsl,type)=>{if("vs"===type)return glsl;let compositeUniforms="",compositeMain="";for(let i=0;i<_nMips;i++)compositeUniforms+=`uniform sampler2D blurTexture${i+1};\n`,compositeMain+=`lerpBloomFactor(${_bloomFactors[i].toFixed(4)}) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture${i+1}, vUv) ${i<_nMips-1?"+ ":""}`;return(glsl=glsl.replace("uniform sampler2D blurTexture1;",compositeUniforms)).replace("lerpBloomFactor(1.0) * vec4(bloomTintColor, 1.0) * texture2D(blurTexture1, vUv)",compositeMain)})).needsUpdate=!0}(),function initPass(){_this.pass=_this.initClass(NukePass,"UnrealBloomPass",_this.uniforms)}(),function addListeners(){_this.events.sub(Events.RESIZE,resizeHandler),_this.events.sub(RenderManager.POST_RENDER,render)}(),ShaderUIL.add(_luminosityShader).setLabel("UnrealBloom Luminosity"),ShaderUIL.add(_compositeShader).setLabel("UnrealBloom Composite"),this.set("texture",texture=>{_inputTexture=texture}),this.set("dpr",dpr=>{_DPR=dpr,resizeHandler()}),this.renderBloom=render,this.renderMesh=_mesh,this.onDestroy=function(){_renderTargetsHorizontal.forEach(r=>r.destroy()),_renderTargetsVertical.forEach(r=>r.destroy()),_this.renderTargetBright&&_this.renderTargetBright.destroy()}})),Class((function VelocityTracker(_vector){Inherit(this,Component);var _this=this,Vector="number"==typeof _vector.z?Vector3:Vector2,_velocity=new Vector,_last=new Vector;function loop(){_velocity.subVectors(_vector,_last),_last.copy(_vector)}this.value=_velocity,this.start=function(){_this.startRender(loop)},this.onDestroy=this.stop=function(){_this.stopRender(loop)},this.copy=function(){_last.copy(_vector)},this.update=loop})),Class((function Video(_params){Inherit(this,Component);const _this=this;let $video,_video,_loadingState,_handlers,_ready=Promise.create(),_loaded=Promise.create(),_initialPlay=!0;function startPreload(){return _loadingState=!0,_ready}async function startPlayback(){_this.playing||(_loadingState=!1,await _ready,_this.playing||(_initialPlay&&(_initialPlay=!1,_video.currentTime=_params.currentTime),_this.playing=!0,_video.play()))}function getSource(src=""){return src.includes(["webm","mp4","ogv"])||(src+="."+Device.media.video),src}function progress(e){_this.events.fire(Video.PROGRESS,e)}function timeupdate(e){_this.events.fire(Video.UPDATE,e)}function play(e){if(_loadingState)return _loadingState=!1;_this.events.fire(Video.PLAY,e)}function pause(e){_this.events.fire(Video.PAUSE,e)}function playing(e){_this.events.fire(Video.PLAYING,e)}function ended(e){_this.events.fire(Video.ENDED,e)}function waiting(e){_this.events.fire(Video.WAITING,e)}function canplay(e){loadeddata(),_this.events.fire(Video.CANPLAY,e)}function loadeddata(e){_video.readyState>=2&&_ready.resolve(),_video.readyState>=4&&_loaded.resolve()}!function initParam(){_params=Object.assign({muted:!0,loop:!1,autoplay:!1,inline:!0,controls:!1,currentTime:0,playback:1,preload:!1,width:640,height:360,events:[]},_params)}(),function init(){return _video=document.createElement("video"),_video.src=getSource(_params.src),_video.setAttribute("crossorigin","anonymous"),_video.autoplay=_params.autoplay,_video.loop=_params.loop,_video.controls=_params.controls,_video.height=_params.height,_video.width=_params.width,_video.defaultMuted=_params.muted,_video.defaultPlaybackRate=_params.playback,_video.preload=_params.preload,_video.muted=_params.autoplay||_params.muted,_video.setAttribute("webkit-playsinline",_params.inline),_video.setAttribute("playsinline",_params.inline),_video.setAttribute("autoplay",_params.autoplay),_video.setAttribute("muted",_params.muted),_params.loop&&_video.setAttribute("loop",_params.loop),_this.div=_video,$video=$(_video),_params.autoplay?startPlayback():_params.preload?startPreload():void 0}(),function addHandlers(){_params.events.push("loadeddata"),_handlers={play:play,pause:pause,ended:ended,playing:playing,progress:progress,waiting:waiting,timeupdate:timeupdate,loadeddata:loadeddata,canplay:canplay},_params.events.forEach(ev=>_video.addEventListener(ev,_handlers[ev],!0))}(),this.set("loop",bool=>_video.loop=bool),this.get("loop",()=>_video.loop),this.set("src",src=>{src!==_video.src&&(_video.src=getSource(src))}),this.get("src",()=>_video.currentSrc),this.set("volume",v=>{_video.muted=0===v,_video.volume=v}),this.get("volume",()=>_video.volume),this.set("muted",bool=>_video.muted=bool),this.get("muted",()=>_video.muted),this.set("controls",bool=>_video.controls=bool),this.get("controls",()=>_video.controls),this.get("duration",()=>_video.duration),this.get("ended",()=>_video.ended),this.get("playback",()=>_video.playbackRate),this.get("time",()=>_video.currentTime),this.get("canRender",()=>_video.readyState>=2),this.get("canPlayThrough",()=>_video.readyState>=4),this.get("paused",()=>_video.paused),this.get("element",()=>$video),this.get("object",()=>$video),this.get("video",()=>_video),this.get("bufferedSeconds",_=>_video.readyState<2?0:_video.buffered.end(0)-_video.buffered.start(0)),this.load=async function(){return startPreload()},this.play=async function(){return startPlayback()},this.pause=function(){_this.playing=!1,_video.pause()},this.stop=function(){_this.playing=!1,_video.pause(),_this.seek(0)},this.seek=function(t){if(_video.fastSeek)return _video.fastSeek(t);_video.currentTime=t},this.seekExact=function(t){_video.currentTime=t},this.ready=function(){return _ready},this.loaded=function(){return _loaded},this.onDestroy=function(){_this.stop(),_video.src="",function removeListeners(){_params.events.forEach(ev=>_video.removeEventListener(ev,_handlers[ev],!0))}(),_video=null}}),()=>{Video.PLAY="hydra_video_play",Video.CANPLAY="hydra_video_can_play",Video.PAUSE="hydra_video_pause",Video.PROGRESS="hydra_video_progress",Video.UPDATE="hydra_video_update",Video.PLAYING="hydra_video_playing",Video.ENDED="hydra_video_ended",Video.WAITING="hydra_video_waiting"}),Class((function VideoTexture(_path,{loop:loop=!0,preload:preload=!0,autoplay:autoplay=!0,muted:muted=!0,firstFrame:firstFrame=!1}={}){Inherit(this,Component);const _this=this;let _video;function update(){_video.canRender&&(_this.videoTexture&&(_this.texture.destroy(),_this.texture=_this.videoTexture,delete _this.videoTexture),_this.texture.image||(_this.texture.image=_video.video,_this.texture.upload()),_this.texture.loaded=_this.texture.needsUpdate=!0)}!function(){if(_path.includes(["jpg","png"])){let noop=_=>{};_this.texture=Utils3D.getTexture(_path),_this.video={play:noop,pause:noop}}else _video=_this.initClass(Video,{src:_path,loop:loop,preload:preload,autoplay:autoplay,muted:muted,events:["timeupdate","playing","ended"]}),_this.texture=new Texture,_this.texture.format=Texture.RGBFormat,_this.texture.minFilter=_this.texture.magFilter=Texture.LINEAR,_this.texture.generateMipmaps=!1,_this.texture.loaded=!1,_this.video=_video,_this.events.bubble(_video,Video.PLAYING),firstFrame&&(_this.videoTexture=_this.texture,_this.texture=Utils3D.getTexture(firstFrame))}(),this.set("src",src=>_video.src=src),this.start=async function(){_video&&(_this.active=!0,await _video.play(),_this.startRender(update))},this.stop=function(){_video&&(_this.active=!1,_video.pause(),_this.stopRender(update))},this.seek=function(time){_video&&_video.seek(time)},this.onInvisible=function(){},this.onVisible=function(){},this.onDestroy=function(){_this.texture.destroy(),VideoTexture.element().removeChild(_this.video.object,!0)}}),_=>{var $element;VideoTexture.element=function(){return $element||(($element=Stage.create("VideoTextures")).setZ(-1),Stage.add($element)),$element}}),Namespace("FX"),FX.Class((function VolumetricLight(_nuke=World.NUKE,_unique,_options={}){Inherit(this,Component);const _this=this;var _scene,_layer,_volume,_light,_invisible,_obj={},_blurs=[],_projection=new ScreenProjection(_nuke.camera),_lightPos=new Vector3;function render({stage:stage,camera:camera}){if(!_light||!_this.enabled||_invisible)return;_scene.nuke.setSize(stage.width,stage.height),_scene.nuke.stage=stage,_scene.nuke.camera=camera,_projection.camera=camera,_lightPos.setFromMatrixPosition(_light.matrixWorld);let screen=_projection.project(_lightPos,stage);screen.x/=stage.width,screen.y/=stage.height,_volume.uniforms.lightPos.value.set(screen.x,1-screen.y),screen.x>-.1&&screen.x<1.1&&screen.y>-.1&&screen.y<1.1&&_scene.render()}!function polymorph(){"object"==typeof _unique&&(_options=_unique,_unique=void 0),_this.enabled="boolean"!=typeof _options.enabled||_options.enabled}(),function initLayer(){(_layer=_this.initClass(_options.useFXScene?FXScene:FXLayer,_nuke,_options)).name="VolumetricLight",_this.startRender(_=>_layer.render()),_layer.setDPR(1),_this.fxLayer=_layer}(),function initScene(){_scene=_this.initClass(FXScene,_nuke),_layer.setDPR(1),_this.rt=_scene.rt;let shader=_this.initClass(Shader,_options.screenQuadShader||"ScreenQuad",{tMap:{value:_layer},depthWrite:!1}),mesh=new Mesh(World.QUAD,shader);mesh.frustumCulled=!1,_scene.scene.add(mesh),_this.screenQuadMesh=mesh,_this.fxScene=_scene}(),function initPasses(){[new Vector2(1.5*_nuke.dpr,0),new Vector2(0,1.5*_nuke.dpr)].forEach(dir=>{let pass=new NukePass("LightBlur",{uDir:{value:dir}});_blurs.push(pass),_scene.nuke.add(pass)}),_volume=new NukePass("VolumetricLight",{unique:_unique,lightPos:{value:new Vector2},fExposure:{type:"f",value:.2},fDecay:{type:"f",value:.93},fDensity:{type:"f",value:.96},fWeight:{type:"f",value:.4},fClamp:{type:"f",value:1}}),_scene.nuke.add(_volume),ShaderUIL.add(_volume).setLabel("Volumetric Light"),_this.volumeShader=_volume}(),function addListeners(){_this.events.sub(_nuke,Nuke.RENDER,render)}(),this.add=function(mesh,light){_layer.add(mesh),light&&(_light=mesh)},this.set("resolution",v=>{_layer.setResolution(v),_scene.setResolution(v)}),this.set("dpr",v=>{_layer.setDPR(v),_scene.setDPR(v)}),this.onInvisible=function(){_invisible=!0},this.onVisible=function(){_invisible=!1},this.setComposite=function(texture){_this.screenQuadMesh.shader.set("tMap",texture)},this.render=function(stage,camera){_this.events.unsub(_nuke,Nuke.RENDER,render),_obj.stage=stage,_obj.camera=camera,render(_obj)}})),Class((function SocketConnection(_server,_channel){Inherit(this,Component);var _socket,_this=this,_fail=0;const PING="ping",PONG="pong";function connect(){_this.pending=!1,(_socket=new WebSocket(_server)).onopen=open,_socket.onmessage=message,_socket.onclose=close,_socket.onerror=close}function open(e){_fail=0,_this.connected=!0,_this.events.fire(SocketConnection.OPEN,{socket:_this},!0),_channel&&_this.send("register",{channel:_channel})}function message(e){if(e.data==PING)return _socket.send(PONG);let data=JSON.parse(e.data),evt=data._evt;delete data._evt,_this.events.fire(evt,data,!0)}function close(e){_this.pending||_fail++>25||(_this.connected=!1,_this.pending=!0,_this.events.fire(SocketConnection.CLOSE,{socket:_this},!0),_this.delayedCall(connect,250))}this.connected=!1,async function(){try{connect()}catch(e){await defer(),_this.events.fire(SocketConnection.ERROR,{socket:_this}),_this.delayedCall(connect,250)}}(),this.send=function(evt,data={}){if(!_this.connected)return _this.delayedCall(_=>_this.send(evt,data),100);data._evt=evt,_socket&&_socket.send(JSON.stringify(data)),"start_game"===evt&&console.log("starting game"),"end_game"===evt&&console.log("ending game")}}),_=>{SocketConnection.OPEN="socket_connection_open",SocketConnection.CLOSE="socket_connection_close",SocketConnection.ERROR="socket_connection_error"}),Class((function CarEnvOverrides(_name,_layers,_env,_uil){Inherit(this,Component);var _config;const KEYS=["uMRO","uEnv","uLight","uClearCoat","uEnvReflection","uColor"];function applyOrigin(key){_layers.forEach(mesh=>{mesh.shader.origin[key]&&mesh.shader.set(key,mesh.shader.origin[key])})}function applyCustom(key,val){_layers.forEach(mesh=>{mesh.shader.uniforms[key]&&(val&&val.includes&&val.includes("#")?mesh.shader.uniforms[key].value.set(val):Array.isArray(val)?mesh.shader.uniforms[key].value.fromArray(val):mesh.shader.uniforms[key].value=val)})}function update(){KEYS.forEach(key=>{let val=_config.get(key);val&&val.includes&&val.includes("#")?"#ffffff"==val?applyOrigin(key):applyCustom(key,val):Array.isArray(val)?!function arrayIsOne(array){for(let i=0;i<array.length;i++)if(1!=array[i])return!1;return!0}(val)?applyCustom(key,val):applyOrigin(key):1==val?applyOrigin(key):applyCustom(key,val)})}(_config=InputUIL.create(_name+_env+"override",_uil)).setLabel(_name+" Overrides"),_config.addVector("uMRO",[1,1,1]),_config.addVector("uEnv",[1,1]),_config.addVector("uLight",[1,1,1,1]),_config.addVector("uClearCoat",[1,1,1]),_config.addNumber("uEnvReflection",1),_config.addColor("uColor",new Color("#ffffff")),_config.onUpdate=update,function setOrigin(){KEYS.forEach(key=>{_layers.forEach(mesh=>{if(mesh.shader.origin||(mesh.shader.origin={}),mesh.shader.uniforms[key]){let value=mesh.shader.get(key);mesh.shader.origin[key]="function"==typeof value.clone?value.clone():value}})})}(),update()})),Class((function EnvCapture(_name){Inherit(this,Object3D);const _this=this;var _camera,_debug;_debug=Utils3D.createDebug(1),_this.add(_debug),_this.group.prefix="EnvCapture_"+_name,MeshUIL.add(_this.group),_camera=new CubeCamera(.1,2e3,1024),_this.add(_camera),Dev.expose("capture",async _=>{_this.parent.cars.group.visible=!1,await _this.wait(100),_camera.render(_this.parent.nuke.scene),_this.initClass(CubemapToEquirectangular,1024,_camera.rt).toBlob(),_this.parent.cars.group.visible=!0})})),Class((function MaxAnisotropy(_mesh,_shader){!function(){let baseColor=_shader.get("tBaseColor"),normal=_shader.get("tNormal"),mro=_shader.get("tMRO");baseColor&&(baseColor.anisotropy=World.RENDERER.getMaxAnisotropy()),normal&&(normal.anisotropy=World.RENDERER.getMaxAnisotropy()),mro&&(mro.anisotropy=World.RENDERER.getMaxAnisotropy())}()})),Class((function Numbers(){Inherit(this,Component),this.formatTime=function(seconds=0){if(!seconds)return"--:--.---";seconds=parseFloat(seconds);let pos=Math.abs(seconds)===seconds,ms=(seconds=Math.abs(seconds))-Math.floor(seconds);seconds-=ms;let minutes=Math.floor(seconds/60);for(seconds-=60*minutes,ms=Math.floor(1e3*ms).toString();ms.length<3;)ms=`0${ms}`;for(seconds=seconds.toString();seconds.length<2;)seconds=`0${seconds}`;for(minutes=minutes.toString();minutes.length<2;)minutes=`0${minutes}`;return`${pos?"":"-"}${minutes}:${seconds}.${ms}`},this.KMPHtoMPH=function(kmph=0){return.621371*kmph},this.MPHtoKMPH=function(mph=0){return 1.60934*mph},this.numberToPlace=function(number){switch(number){case 1:return"1ST";case 2:return"2ND";case 3:return"3RD"}return`${number}TH`}}),"static"),Class((function RandomAttributes(_mesh,_shader){!async function(){await _mesh.instanceMeshReady;let geom=_mesh.instanceMesh.geometry,count=geom.attributes.offset.count,buffer=new Float32Array(4*count);for(let i=0;i<count;i++)buffer[4*i+0]=Math.random(0,1,4),buffer[4*i+1]=Math.random(0,1,4),buffer[4*i+2]=Math.random(0,1,4),buffer[4*i+3]=Math.random(0,1,4);geom.addAttribute("random",new GeometryAttribute(buffer,4,1))}()})),Class((function ShadowLockOnCar(_mesh,_shader){Inherit(this,Component);const _this=this;!function(){let car=_this.parent.findParent("Gameplay").cars.player;_this.startRender(_=>{car.group&&_mesh&&_mesh.position.copy(car.group.position)})}()})),Class((function ControlUtil(){Inherit(this,Component);const _this=this;function fireLeft(){let fire=_=>{_this.events.fire(GameplayControls.LEFT,{type:"down"}),_this.leftTimer=_this.delayedCall(fire,80)};fire()}function fireRight(){let fire=_=>{_this.events.fire(GameplayControls.RIGHT,{type:"down"}),_this.rightTimer=_this.delayedCall(fire,80)};fire()}function keyDown(e){switch(e.key){case"ArrowLeft":case"a":_this.events.fire(GameplayControls.LEFT,{type:"down"});break;case"ArrowRight":case"d":_this.events.fire(GameplayControls.RIGHT,{type:"down"});break;case" ":case"s":case"ArrowDown":_this.events.fire(GameplayControls.BRAKE,{type:"down"})}}function keyUp(e){switch(e.key){case"ArrowLeft":case"a":_this.events.fire(GameplayControls.LEFT,{type:"up"});break;case"ArrowRight":case"d":_this.events.fire(GameplayControls.RIGHT,{type:"up"});break;case" ":case"s":case"ArrowDown":_this.events.fire(GameplayControls.BRAKE,{type:"up"})}}function pressDown(e){clearTimeout(_this.steerTime),_this.steerTime=_this.delayedCall(_=>{e.changedTouches[0].pageX<Stage.width/2?(clearTimeout(_this.leftTimer),fireLeft(),_this.flag("lastSteer","left")):(_this.flag("lastSteer","right"),clearTimeout(_this.rightTimer),fireRight())},30),e.touches.length>=2&&!_this.flag("braking")&&(_this.flag("braking",!0),clearTimeout(_this.steerTime),_this.events.fire(GameplayControls.BRAKE,{type:"down"})),2!=e.touches.length||_this.flag("brake_touch")||_this.flag("brake_touch",!0)}function pressUp(e){let reapplySteer=!1;_this.flag("braking")&&e.touches.length<2&&(_this.flag("brake_touch",!1),_this.flag("braking",!1),_this.events.fire(GameplayControls.BRAKE,{type:"up"}),reapplySteer=!0);for(let i=0;i<e.changedTouches.length;i++)e.changedTouches[i].pageX<Stage.width/2?(clearTimeout(_this.leftTimer),_this.events.fire(GameplayControls.LEFT,{type:"up"})):(clearTimeout(_this.rightTimer),_this.events.fire(GameplayControls.RIGHT,{type:"up"}));if(reapplySteer)for(let i=0;i<e.touches.length;i++)e.touches[0].pageX<Stage.width/2?(clearTimeout(_this.leftTimer),fireLeft()):(clearTimeout(_this.rightTimer),fireRight())}!async function(){await Hydra.ready(),function addListeners(){Device.mobile?(__window.bind("touchstart",pressDown),__window.bind("touchend",pressUp)):(_this.events.sub(KeyboardUtil.DOWN,keyDown),_this.events.sub(KeyboardUtil.UP,keyUp))}()}(),this.reset=function(){clearTimeout(_this.leftTimer),clearTimeout(_this.rightTimer),clearTimeout(_this.steerTime)}}),"static"),Class((function ID(){const PUSH_CHARS="-0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ_abcdefghijklmnopqrstuvwxyz";var lastPushTime=0,lastRandChars=[];this.generate=function(){var now=(new Date).getTime(),duplicateTime=now===lastPushTime;lastPushTime=now;for(var timeStampChars=new Array(8),i=7;i>=0;i--)timeStampChars[i]=PUSH_CHARS.charAt(now%64),now=Math.floor(now/64);if(0!==now)throw new Error("We should have converted the entire timestamp.");var id=timeStampChars.join("");if(duplicateTime){for(i=11;i>=0&&63===lastRandChars[i];i--)lastRandChars[i]=0;lastRandChars[i]++}else for(i=0;i<12;i++)lastRandChars[i]=Math.floor(64*Math.random());for(i=0;i<12;i++)id+=PUSH_CHARS.charAt(lastRandChars[i]);if(20!=id.length)throw new Error("Length should be 20.");return id}}),"static"),Class((function GenerateMaps(){Inherit(this,Component);const _this=this,PATH="assets/images/maps/";!async function(){Utils.query("generateMaps")&&Hydra.LOCAL&&(await Data.ready(),await async function render(){if(Utils.query("race_data")){let name=Utils.query("race_data"),src=`assets/data/${name}.json`,data=await get(src),renderer=_this.initClass(RenderMap);for(let[i,point]of data.entries())data[i]=parseFloat(data[i]);let img=await renderer.render(data);Dev.writeFile(`assets/data/${name}.png`,img)}else{let tracks=Data.tracks,renderer=_this.initClass(RenderMap);for(let track in tracks){let data=await renderer.render(track);Dev.writeFile(`${PATH}${track}.png`,data)}}}())}(),this.get("PATH",_=>PATH)}),"static"),Class((function RenderMap(){Inherit(this,Component);const _this=this;let RESOLUTION,TRACK_SCALE,WIDTH;var $canvas,_ctx,_track,_name;function applySettings(){switch(_name){case"old_nsx":RESOLUTION=64,TRACK_SCALE=.5,WIDTH=1;break;case"type_s":case"new_nsx":RESOLUTION=512,TRACK_SCALE=.2,WIDTH=9;break;default:RESOLUTION=512,TRACK_SCALE=.5,WIDTH=15}}function renderPath(width,isRace){let center=.5*RESOLUTION,scale=TRACK_SCALE*(RESOLUTION/1024);_ctx.moveTo(center,center),_ctx.strokeStyle=`rgba(255,255,255,${isRace||1===width?1:.05})`,_ctx.lineWidth=width,_ctx.beginPath();for(let i=0;i+3<_track.length;i+=isRace?7:3){let x=center+_track[i+0]*scale,y=center+_track[i+2]*scale;_ctx.lineTo(x,y)}_ctx.stroke()}this.render=async function(name){let raceData="string"!=typeof name;return raceData?(_track=name,applySettings()):(_name=name,applySettings(),await async function initData(){await Data.ready();let layout=_this.initClass(SceneLayout,`track_${_name}`),line=await layout.getLayers("line");_track=(_track=await line[0].getData()).curves,layout.ready().then(_=>{_this.delayedCall(_=>{layout=layout.destroy()},1e3)})}()),function initCanvas(){$canvas&&($canvas=$canvas.destroy()),($canvas=$(document.createElement("canvas"))).attr("width",RESOLUTION),$canvas.attr("height",RESOLUTION),$canvas.size(RESOLUTION,RESOLUTION),_ctx=$canvas.div.getContext("2d")}(),function fillBG(){_ctx.fillStyle="#000000",_ctx.fillRect(0,0,RESOLUTION,RESOLUTION)}(),function renderPaths(isRace){let width=isRace?1:WIDTH;for(;width>0;)renderPath(width--,isRace)}(raceData),function imgData(){return $canvas.div.toDataURL()}()}})),Class((function ShareImage(){Inherit(this,Component);const PATH="assets/images/share/",WIDTH=1920,HEIGHT=1080;var $canvas,$c;this.generate=async function({seconds:seconds,level:level}){return function initCanvas(){return $canvas&&$canvas.destroy&&($canvas=$canvas.destroy()),($canvas=$(document.createElement("canvas"))).size(WIDTH,HEIGHT),$canvas.attr("height",WIDTH),$canvas.attr("width",WIDTH),$c=$canvas.getContext("2d"),$canvas}(),await async function renderImage(level){let $img=$(document.createElement("img")),loaded=Promise.create();$img.div.onload=loaded.resolve,$img.attr("src",`${PATH}${level}.png`),await loaded,$c.drawImage($img.div,0,0,WIDTH,HEIGHT),$img=$img.destroy()}(level),function renderTime(seconds){$c.fontFamily="sans-serif",$c.textAlign="center",$c.fontSize=32}(),output(canvas)}})),Class((function UserStorage(){this.set=function(key,value){Storage.set(key,value)},this.get=async function(key,value){return Storage.get(key)}}),"static"),Class((function Tests(){const _this=this;this.fallback=function(){return!Device.detect(["bot","googlebot","crawl","spider"])&&(!!Utils.query("fallback")||(!Device.graphics.webgl||("safari"===Device.system.browser&&Device.system.browserVersion<10||("ie"===Device.system.browser&&Device.system.browserVersion<=11||("ios"===Device.system.os&&Device.system.version<10||"android"===Device.system.os&&Device.system.version<5)))))},this.getDPR=function(){return GPU.OVERSIZED?.8:Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3)?1:GPU.lt(0)?1:GPU.lt(1)?Math.min(Device.pixelRatio,1):GPU.lt(2)?Math.min(Device.pixelRatio,1.15):GPU.lt(3)?Math.min(Device.pixelRatio,1.3):GPU.lt(5)?2:GPU.mobileLT(0)?.8:GPU.mobileLT(1)?Math.min(Device.pixelRatio,1):GPU.mobileLT(2)?Math.min(Device.pixelRatio,1):GPU.mobileLT(3)?Math.min(Device.pixelRatio,1.2):GPU.mobileLT(4)?Math.min(Device.pixelRatio,1.35):1},this.garageDPR=function(){return GPU.mobileLT(0)?.8:GPU.mobileLT(2)?Math.min(Device.pixelRatio,1):GPU.mobileLT(3)?Math.min(Device.pixelRatio,1.3):Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3)?1:this.getDPR()},this.renderSpeedBlur=function(){return!GPU.lt(1)&&(!GPU.mobileLT(3)&&!(Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3)))},this.renderRGBShift=function(){return!GPU.lt(3)&&!Device.mobile},this.carReflection=function(){return!GPU.lt(0)&&!GPU.mobileLT(2)},this.renderRetroWater=function(){return!GPU.lt(0)&&!GPU.mobileLT(2)},this.arxVolumetricLight=function(){return!(Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3))&&(!GPU.lt(1)&&!GPU.mobileLT(4))},this.arxBloom=function(){return!GPU.OVERSIZED&&(!(Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3))&&(!Utils.query("orbit")&&(!GPU.lt(1)&&!GPU.mobileLT(3))))},this.rdxBloom=function(){return this.arxBloom()},this.renderShadows=function(){return!GPU.lt(0)&&(!GPU.OVERSIZED&&!GPU.mobileLT(1))},this.snowParticles=function(){return GPU.mobileLT(1)?0:GPU.mobileLT(2)?5e4:GPU.mobileLT(3)?5e4:GPU.mobileLT(4)?7e4:GPU.lt(0)?1e4:GPU.lt(1)?5e4:GPU.lt(2)?1e5:GPU.lt(3)?15e4:2e5},this.renderRDXFog=function(){return!(Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3))&&(!GPU.lt(1)&&!GPU.mobileLT(2))},this.tireFX=function(){return!GPU.mobileLT(1)},this.arxBloomRes=function(){return 1},this.rdxBloomRes=function(){return this.arxBloomRes()},this.fxaa=function(){return!GPU.OVERSIZED&&(Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3)?.8:!GPU.lt(0)&&!GPU.mobileLT(2))},this.renderGarageMirror=function(){return!_this.renderGarageMirrorBlur()&&(!GPU.OVERSIZED&&(!GPU.lt(0)&&!GPU.mobileLT(2)))},this.renderGarageMirrorBlur=function(){return!!GPU.gt(3)||!!GPU.mobileGT(4)},this.airStreamParticles=function(){return GPU.lt(0)?0:GPU.mobileLT(2)?0:4096},this.socialBrowser=function(){return Device.agent.includes("instagram")?"instagram":Device.agent.includes("FBAN")?"facebook":Device.agent.includes("FBAV")?"facebook":Device.agent.includes("fb")?"facebook":Device.agent.includes("twitter")?"twitter":Device.agent.includes("Twitter")?"twitter":!!document.referrer.includes("//t.co/")&&"twitter"},this.fallbackSocialBrowser=function(){if(Utils.query("socialBrowser"))return!0;switch(_this.socialBrowser()){case"instagram":return!0;case"facebook":return!Config.FACEBOOK;default:return!1}},this.getSocialArrowPosition=function(){return"br"},this.getRDXDPR=function(){return GPU.OVERSIZED?_this.getDPR()*(GPU.gt(1)?.85:.7):Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3)?.8:GPU.lt(0)?.9*_this.getDPR():GPU.lt(1)?_this.getDPR():GPU.mobileLT(1)?.7*_this.getDPR():1},this.getARXDPR=function(){return GPU.OVERSIZED?_this.getDPR()*(GPU.gt(1)?.85:.7):Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3)?1:GPU.lt(0)?.9*_this.getDPR():GPU.lt(1)?_this.getDPR():GPU.mobileLT(1)?.7*_this.getDPR():_this.getDPR()},this.getNSXDPR=function(){return GPU.OVERSIZED?_this.getDPR()*(GPU.gt(1)?.85:.7):Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3)?1:GPU.lt(0)?.75*_this.getDPR():GPU.lt(1)?.9*_this.getDPR():GPU.lt(3)?Math.min(_this.getDPR(),1.2):GPU.mobileLT(1)?.66*_this.getDPR():GPU.mobileLT(2)?.85*_this.getDPR():GPU.mobileLT(3)?.9*_this.getDPR():_this.getDPR()},this.getTypeSDPR=function(){return GPU.OVERSIZED?_this.getDPR()*(GPU.gt(1)?.85:.7):Math.max(Stage.width,Stage.height)>1600&&GPU.lt(3)?1:GPU.lt(0)?.75*_this.getDPR():GPU.lt(1)?.9*_this.getDPR():GPU.mobileLT(1)?.66*_this.getDPR():GPU.mobileLT(2)?.85*_this.getDPR():GPU.mobileLT(3)?.9*_this.getDPR():GPU.lt(3)?Math.min(_this.getDPR(),1.2):_this.getDPR()},this.getFar=function(name){return GPU.mobileLT(1)?250:GPU.mobileLT(2)?400:GPU.lt(0)?350:500},this.renderRain=function(){return!GPU.OVERSIZED&&(!GPU.lt(0)&&!GPU.mobileLT(2))},this.canToggleUI=function(){return!Config.PROD&&!(!Utils.query("toggleUI")&&!Hydra.LOCAL)},this.lowMemory=function(){if("ios"==Device.system.os){if("1024x768"==Math.min(screen.width,screen.height)+"x"+Math.max(screen.width,screen.height))return GPU.mobileLT(2)}return GPU.mobileLT(1)},this.canUseShortcuts=function(){return!Config.PROD&&!(!Utils.query("shortcuts")&&!Hydra.LOCAL)},this.allowsMultiplayer=function(){return!!Utils.query("allowMultiplayer")||!Utils.query("preventMultiplayer")&&(!!Utils.query("join")||!_this.lowMemory())}}),"static"),Class((function URLUtil(){this.removeParam=function(url,param){let u=url.split("?");if(u.length>=2){let prefix=encodeURIComponent(param)+"=",pars=u[1].split(/[&;]/g);for(let i=pars.length;i-- >0;)-1!==pars[i].lastIndexOf(prefix,0)&&pars.splice(i,1);return url=u[0]+(pars.length>0?"?"+pars.join("&"):"")}return url},this.addParam=function(url,param,value){let u=url.split("?"),addedParam=encodeURIComponent(param)+"="+value,pars=u[1]?u[1].split(/[&;]/g):[];return pars.push(addedParam),url=u[0]+(pars.length>0?"?"+pars.join("&"):"")}}),"static"),Class((function DataTrack(_name){Inherit(this,Model);const _this=this;var _current;this.isUnlocked=async function(){let unlocked=!0,current=Config.TRACKS.indexOf(_name),previous=Config.TRACKS[current-1],qualified=await UserStorage.get(`track_${previous}_has_qualified`);return await async function previousTracksUnlocked(){let tracks=[],current=Data.tracks[_name].index;for(let id in Data.tracks)tracks.push(Data.tracks[id]);tracks=tracks.sort((a,b)=>a.index-b.index).slice(0,current);let previous=[];tracks.map(track=>previous.push(track.isUnlocked())),previous=await Promise.all(previous);let unlocked=!0;return previous.map(isUnlocked=>isUnlocked?null:unlocked=!1),unlocked}()||(unlocked=!1),current>0&&!qualified&&(unlocked=!1),(Utils.query("unlock_all")&&!Config.PROD||Utils.query("awd"))&&(unlocked=!0),_this.isAvailable()||(unlocked=!1),unlocked},this.isAvailable=function(){return!0},this.getLeaderboard=async function(daily=!1){return await Data.Leaderboard.get({track:Data.getTrackNumberByName(_name),daily:daily})},this.getBestTime=function(){return UserStorage.get(`track_${_name}_best_time`)},this.getQualifyingTime=function(){return Qualifying[_name].time},this.qualified=function(time,ghost){return time<(ghost?ghost.score/1e3:_this.getQualifyingTime())},this.saveResults=async function(gameplay){let id=gameplay.state.get("playId"),timeUnformatted=gameplay.state.get("lapTimeUnformatted"),timeFormatted=Numbers.formatTime(timeUnformatted/1e3),best=_this.getBestTime();(!best||timeUnformatted<best.unformatted)&&UserStorage.set(`track_${_name}_best_time`,{formatted:timeFormatted,unformatted:timeUnformatted}),_current={id:id,score:timeUnformatted,score_display:timeFormatted,track:Data.getTrackNumberByName(_name)},Hydra.LOCAL&&(_current.debug=!0)},this.saveGhost=async function(data,checkpoints,frames,boosted){_current.data=JSON.stringify(data),_current.checkpoints=JSON.stringify(checkpoints),_current.frames=frames,_current.boosted=boosted,await Data.Race.save(_current)},this.share=function(type){let data={id:_current.id,track:_name},encoded=Data.encodeQuery(data);Data.Race.share(encoded,type)},this.shareTrack=async function(type="facebook"){if(Config.FACEBOOK&&"native"===type&&"ios"!==Device.system.os){let level=Data.getTrackNumberByName(_name),image=await Share.imageLinkToDataURL(`${Assets.CDN}assets/meta/level/${level}${Config.LEVEL_IMAGE_CACHE}.png`);return Track.event("Share","click","instant-game"),void(await FBInstant.shareAsync({intent:"REQUEST",image:image,text:Copy.SHARE_TITLE,data:{level:level}}))}const URL=Config.SHARE_LEVEL.replace(":levelid",Data.getTrackNumberByName(_name));return Share.supports.native||"native"===type?Share.native(URL,Copy.SHARE_TITLE):"twitter"===type?Share.twitter(URL,Copy.SHARE_TITLE):"email"===type?Share.email(Copy.SHARE_TITLE,"",URL):"copy"===type?Share.copy(URL):Share.facebook(URL)},this.reset=function(gameplay){gameplay&&gameplay.state.set("playId",ID.generate()),Data.Race.reset(),_current=null}})),Class((function Fb(){Inherit(this,Model);!function(){let query=Utils.query("source");query&&query.includes&&query.includes("fbinstant")&&window.location!==window.parent.location&&Hydra.LOCAL&&(!function initFB(mock){let tag=document.createElement("script");tag.src=mock?"assets/mock/lib/fbinstant.6.0.mock.js":"https://connect.facebook.net/en_US/fbinstant.6.3.js";let firstScriptTag=document.getElementsByTagName("script")[0];firstScriptTag.parentNode.insertBefore(tag,firstScriptTag)}(),Config.FACEBOOK=!0)}()}),"static"),Data.Class((function Leaderboard(){Inherit(this,Model);const _this=this,EMPTY={id:null,username:"---",score:0};async function retrieve(params){if(!params)throw new Error("No params defined");if(!params.track)throw new Error("Track id not provided");const type=params.daily?"daily":"all",url=`${Config.LEADERBOARD}/${params.track}/${type}.json?${Date.now()}`;return await get(url)}this.get=async function(params){let leaderboard=[];try{leaderboard=(await retrieve(params)).leaderboard}catch(e){console.warn(e)}for(;leaderboard.length<10;)leaderboard.push(EMPTY);return leaderboard},this.getTopScore=async function(params){return(await retrieve(params)).leaderboard[0].score/1e3},this.getTopGhost=async function(track){let response=await retrieve({track:track});return(await Data.Race.get(response.leaderboard[0].id)).data},this.getTopCheckpoints=async function(track){let response=await retrieve({track:track}),race=await Data.Race.get(response.leaderboard[0].id),checkpoints=[];return race.checkpoints&&(checkpoints=JSON.parse(race.checkpoints)),checkpoints},this.print=async function(params){let response=await _this.get(params);console.table(response)}}),"static"),Class((function MultiplayerSession(){Inherit(this,Component);const _this=this;function addHandlers(){_this.events.sub(GarageCamera.UPDATE,onGarageUpdate)}function onGarageUpdate(e){_this.flag("slide",e.slide+1)}!async function(){await Hydra.ready(),defer(addHandlers)}(),this.toggle=function(state){_this.flag("selectionMade",state)},this.ready=function(){return _this.wait("selectionMade")},this.create=function(){_this.ROOM.length>0||(_this.ROOM=parseInt(Utils.timestamp()).toString(36))},this.clear=function(){_this.ROOM=""},this.ROOM=(_=>{let join=Utils.query("join");return join&&_this.flag("selectionMade",!0),join||""})(),this.HOST=!1,this.INTENT=!1,this.WON=null,this.STEP=0,this.FINISH_TIME=null,this.get("TYPE",_=>_this.flag("selectionMade")?_this.ROOM.length>0?"1v1":"random":null),this.get("LINK",_=>{const qs=`?join=${_this.ROOM}&level=${Data.getTrackNumberByName(Global.CURRENT_TRACK)}`;return Config.FACEBOOK?`https://playbeatthat.acura.com/${qs}`:`${window.location.protocol}//${window.location.host}${window.location.pathname}${qs}`})}),"static"),Class((function Preloader(){Inherit(this,Component);var _loaded={};this.load=async function(name){if(_loaded[name])return;_loaded[name]=!0;let release=await Initializer3D.queue();await SceneLayoutPreloader.load(`gameplay_env_${name}`),await SceneLayoutPreloader.load(`track_${name}`),release()}}),"static"),Data.Class((function Race(){Inherit(this,Model);const _this=this,HEADERS={headers:{"Content-Type":"application/json; charset=utf-8"}},insecureConsole=require("ConsoleSecurity");let _current,_result,_shareImage,_resultCopy,_shareCopy,_shareCode;_this.flag("resultReady",!1),_this.flag("usernameReady",!1),_this.flag("saveReady",!1),_this.UNLOCKED_COOKIE=`unlocked_shared_${Config.TOTAL_LEVELS}`,(Utils.query("unlock_all")||Utils.query("awd"))&&Storage.set(_this.UNLOCKED_COOKIE,null),this.get=async function(id,field){if(!Hydra.LOCAL&&insecureConsole())return;let url,response;url=`${Config.STORAGE}/race/${id}.json`;try{response=await get(url)}catch(error){console.log("ignore error above. data is not available in storage, load from db..."),url=Config.RACE.replace(":raceid",id),response=await get(url)}return response.data=JSON.parse(response.data),field?response[field]:response},this.post=async function(data){if(!Hydra.LOCAL&&insecureConsole())return;const URL=Config.RACE.replace(":raceid",data.id);try{_result=await post(URL,{_v:_enc(data)},HEADERS),_result.qualified.all&&window.Sentry&&(Sentry.configureScope((function(scope){scope.setExtra("track",data.track),scope.setExtra("username",data.username)})),Sentry.captureMessage(`leaderboard-all-${data.track}-${data.username}`)),_result.qualified.daily&&window.Sentry&&(Sentry.configureScope((function(scope){scope.setExtra("track",data.track),scope.setExtra("username",data.username)})),Sentry.captureMessage("leaderboard-daily"))}catch(error){Sentry&&Sentry.captureException(error),_result={qualified:{all:!1,daily:!1},percentile:100,username:data.username||"NSX"}}return _result.success||console.warn(_result.message),_result&&_result.username&&(_current.username=_result.username),_this.flag("resultReady",!0),_result},this.save=async function(data){!Hydra.LOCAL&&insecureConsole()||(_current=data,_this.flag("saveReady",!0))},this.updateUsername=async function(username){if(!Hydra.LOCAL&&insecureConsole())return;await _this.wait("saveReady"),_current.username=username,username&&Storage.set("username",username),delete _current.boosted,_current.cache=window._CACHE_||Date.now();let response=await _this.post(_current);response&&response.username&&Storage.set("username",response.username),_this.flag("usernameReady",!0),await _this.upload(_current.id)},this.reset=function(){_shareImage=null,_shareCopy=null,_shareCode=null,_resultCopy=null,_current=null,_this.dataReady=!1,_this.flag("resultReady",!1),_this.flag("usernameReady",!1),_this.flag("saveReady",!0)},this.current=function(){return _current},this.results=async function(){await _this.wait("resultReady");let qualified=(null!==MultiplayerSession.FINISH_TIME?Math.min(MultiplayerSession.FINISH_TIME,_current.score):_current.score)<=1e3*Qualifying[Data.getTrackNameByNumber(_current.track)].time;qualified&&Data.setQualified(_current.track),Track.event("Race",`qualified-level${_current.track}`,qualified?"yes":"no"),_resultCopy=await async function resultCopy(){if(await Data.allTracksQualified()){if(!Storage.get(_this.UNLOCKED_COOKIE))return Copy.RESULT.unlocked}let qualified=_current.score<=1e3*Qualifying[Data.getTrackNameByNumber(_current.track)].time,beat_percentile=100-_result.percentile,ghost=await Data.getGhost();if(ghost)return _current.score<=ghost.score?Copy.RESULT.beat_challenge.replaceAll("{challenger}",ghost.username||"AAA"):Copy.RESULT.lose_challenge.replace("{challenger}",ghost.username||"AAA");return qualified?1===_result.qualified.all?Copy.RESULT.leaderboard_all_first:_result.qualified.all?Copy.RESULT.leaderboard_all.replace("{position}",Numbers.numberToPlace(_result.qualified.all)):1===_result.qualified.daily?Copy.RESULT.leaderboard_daily_first:_result.qualified.daily?Copy.RESULT.leaderboard_daily.replace("{position}",Numbers.numberToPlace(_result.qualified.daily)):qualified&&beat_percentile>25?Copy.RESULT.qualified_beat.replace("{percentage}",beat_percentile+"%"):qualified&&_current.track<Config.TOTAL_LEVELS?Copy.RESULT.qualified_next:qualified?Copy.RESULT.qualified:Copy.RESULT.default:Copy.TIPS.random().toUpperCase()}();let s=await async function shareCopy(){if(await Data.allTracksQualified()){if(!Storage.get(_this.UNLOCKED_COOKIE))return{copy:Copy.SHARE.unlocked,code:"u"}}let qualified=_current.score<=1e3*Qualifying[Data.getTrackNameByNumber(_current.track)].time,ghost=(_result.percentile,await Data.getGhost());return qualified?ghost&&_current.score<=ghost.score?{copy:Copy.SHARE.beat_challenge,code:"b"}:_result.qualified.all?{copy:Copy.SHARE.leaderboard_all.replace("{position}",Numbers.numberToPlace(_result.qualified.all)),code:`a${_result.qualified.all}`}:_result.qualified.daily?{copy:Copy.SHARE.leaderboard_daily.replace("{position}",Numbers.numberToPlace(_result.qualified.daily)),code:`d${_result.qualified.daily}`}:qualified?{copy:Copy.SHARE.qualified,code:"q"}:{copy:Copy.SHARE.default,code:"n"}:{copy:Copy.SHARE.not_qualified,code:"n"}}();return _shareCopy=s.copy,_shareCode=s.code,"u"===s.code&&Storage.set(_this.UNLOCKED_COOKIE,!0),{shareCopy:_shareCopy,resultCopy:_resultCopy,result:_result,current:_current}},this.username=async function(){return await _this.wait("usernameReady"),_current.username||"AAA"},this.upload=async function(id){if(!Hydra.LOCAL&&insecureConsole())return;let image=await ShareCard.getImage({scale:.5,type:_result.qualified.all?"all":_result.qualified.daily?"daily":"dynamic",level:""+_current.track,copy:_shareCopy,rank:_result.qualified.all||_result.qualified.daily,username:_current.username,time:_current.score_display});if(Config.FACEBOOK)return _shareImage=image,void(_this.dataReady=!0);let{success:success,message:message,permalink:permalink}=await post(Config.UPLOAD,{id:id,image:image},HEADERS);if(_this.dataReady=!0,success)return permalink;console.warn(message)},this.share=async function(id,type="facebook"){if(Hydra.LOCAL||!insecureConsole()){if(!Config.FACEBOOK||"ios"===Device.system.os){id=Data.appendShareData(id,_shareCode);let url=Config.SHARE.replace(":raceid",id);return Share.supports.native||"native"===type?Share.native(url,_shareCopy):"twitter"===type?Share.twitter(url,_shareCopy.replaceAll("\n"," ")):"email"===type?Share.email(Copy.SHARE_TITLE,`${_shareCopy}\n\n`,url):"copy"===type?Share.copy(url):Share.facebook(url)}Track.event("Share","click","instant-game"),await FBInstant.shareAsync({intent:"CHALLENGE",image:_shareImage,text:_shareCopy,data:{id:id}})}};const _0x6cc6=["rTRHd","data","now","ykLEr","stringify","7ipavmdtU9","assign","Dimvl","kfqYv","javKS","XFcHT","floor","CNYWgl9JRn","Oq9QvejcfQ","WBNKZ","rqeRP","OSQts2Ol6t","TbeIG"];var _0x34a2f8,_0x50af1f;_0x34a2f8=_0x6cc6,_0x50af1f=409,function(_0x191919){for(;--_0x191919;)_0x34a2f8.push(_0x34a2f8.shift())}(++_0x50af1f);const _0x19d1=function(_0x34a2f8,_0x50af1f){return _0x6cc6[_0x34a2f8-=0]};function _enc(_0x233e4b){const _0x1a03f0={Dimvl:function(_0x3f1d1a,_0x1f4303){return _0x3f1d1a*_0x1f4303}};_0x1a03f0[_0x19d1("0x1")]=function(_0x459300,_0x314e67){return _0x459300*_0x314e67},_0x1a03f0.XFcHT=function(_0x59320e,_0x43a57a){return _0x59320e/_0x43a57a},_0x1a03f0[_0x19d1("0x4")]=function(_0x4a6319,_0x1b3333){return _0x4a6319+_0x1b3333},_0x1a03f0[_0x19d1("0x2")]=function(_0x222b85,_0x305f7f){return _0x222b85+_0x305f7f},_0x1a03f0[_0x19d1("0x5")]=function(_0x19065f,_0x3c86f2){return _0x19065f+_0x3c86f2},_0x1a03f0[_0x19d1("0xd")]=function(_0x29da70,_0x298775){return _0x29da70(_0x298775)},_0x1a03f0[_0x19d1("0xe")]=function(_0x55f9a5,_0x59944e){return _0x55f9a5(_0x59944e)},_0x1a03f0[_0x19d1("0x8")]="NYlcxSleyB"+_0x19d1("0x3")+_0x19d1("0x11")+"RdbTJ3D7qw"+_0x19d1("0xa")+_0x19d1("0x0");let _0x3f8a37=Object[_0x19d1("0xb")]({},_0x233e4b);delete _0x3f8a37[_0x19d1("0x6")];let _0x2ab9e5=_0x1a03f0[_0x19d1("0xc")](_0x1a03f0[_0x19d1("0x1")](5,60),1e3),_0x3b49c7=Math[_0x19d1("0x10")](_0x1a03f0[_0x19d1("0xf")](Date[_0x19d1("0x7")](),_0x2ab9e5));return _0x1a03f0[_0x19d1("0x4")](_0x1a03f0[_0x19d1("0x2")](_0x1a03f0[_0x19d1("0x5")](_0x1a03f0[_0x19d1("0x5")](_0x1a03f0[_0x19d1("0x5")](_0x1a03f0[_0x19d1("0xd")](btoa,JSON[_0x19d1("0x9")](_0x3f8a37)),":"),_0x1a03f0.javKS(btoa,_0x233e4b[_0x19d1("0x6")]))+":",_0x1a03f0[_0x19d1("0x8")]),":"),_0x1a03f0[_0x19d1("0xe")](btoa,_0x3b49c7))}}),"static"),Class((function AudioController(){Inherit(this,Component);const _this=this;this._isDev=!1,this._isInited=!1,this._gear=0,this._lastGearChangeTime=0,this._accelerating=!1,this._acceleration=0,this._generalFadeTime=.2,this._rpm=0,this._lastRpmTime=0,this._lastRpm=0,this._mph=0,this._topMph=0,this._enableMusic=!0,this._enableSfx=!0,this._isPaused=!1,this._isDrifting=!1,this._isTurning=!1,this._fastAccPlaying=!1,this._switchEngines=!0,this._usePitch=!0,this._raceOngoing=!1,this._musicVolume=.7,this._musicVolumeGarage=.2,this._accTimer=null,this._posMin=.01,this._enabled=!0,this.carSettings={old_nsx:{name:"old_nsx",gearChangeFactor:.2,engineVolume:.23,brakeFadeTime:.1,raceMusic:"drive_loop_old_nsx",brakeLoop:{name:"brake_loop",playbackRate:1},idleLoop:{name:"old_nsx_idle",playbackRate:1},pitch:{time:.05,max:1.5,min:.8,loopMid:"old_nsx_pitch_integraeq"},startAcc:{name:"old_nsx_fast_acc",volume:.2}},integra:{name:"integra",gearChangeFactor:.2,engineVolume:.4,gearChangeDelay:.1,brakeFadeTime:.1,raceMusic:"drive_loop_integra",brakeLoop:{name:"brake_loop",playbackRate:1},idleLoop:{name:"integra_idle",playbackRate:1},pitch:{time:.1,max:1.2,min:.7,loopMid:"integra_pitch_mid"},startAcc:{name:"integra_fast_acc",volume:.4}},rdx:{name:"rdx",gearChangeFactor:.2,engineVolume:.25,gearChangeDelay:.1,brakeFadeTime:.1,raceMusic:"drive_loop_rdx",brakeLoop:{name:"brake_loop_gravel",playbackRate:1},idleLoop:{name:"rdx_idle",playbackRate:1},pitch:{time:.01,max:1.2,min:.8,loopMid:"rdx_pitch_mid"},startAcc:{name:"rdx_fast_acc",volume:.18}},arx:{name:"arx",gearChangeFactor:.2,engineVolume:.35,gearChangeDelay:.1,brakeFadeTime:.1,raceMusic:"drive_loop_arx",brakeLoop:{name:"brake_loop",playbackRate:1},idleLoop:{name:"arx_idle",playbackRate:1},pitch:{time:.1,max:1.2,min:.8,loopMid:"arx_pitch_mid"},startAcc:{name:"arx_fast_acc",volume:.3}},new_nsx:{name:"new_nsx",gearChangeFactor:.2,engineVolume:.3,gearChangeDelay:.1,brakeFadeTime:.1,raceMusic:"drive_loop_new_nsx",brakeLoop:{name:"brake_loop",playbackRate:1},idleLoop:{name:"nsx_idle",playbackRate:1},pitch:{time:.1,max:1.1,min:.6,loopMid:"new_nsx_pitch_mid"},startAcc:{name:"new_nsx_fast_acc",volume:.35}},type_s:{name:"type_s",gearChangeFactor:.2,engineVolume:.26,gearChangeDelay:.1,brakeFadeTime:.1,raceMusic:"drive_loop_type_s",brakeLoop:{name:"brake_loop",playbackRate:1},idleLoop:{name:"old_nsx_idle",playbackRate:1},pitch:{time:.1,max:1.1,min:.6,loopMid:"new_nsx_pitch_mid"},startAcc:{name:"type_s_fast_acc",volume:.4}}};let loadedGroups={};function onViewControllerChange(e){if(_this._enabled)switch(e.view){case"Garage":Klang.$("reverb_bus").effects[0].setActive(!1),Klang.$("music_bus").effects[0].setActive(!1),Klang.$("music_bus").effects[0].wet.setTargetAtTime(.4,Klang.Util.now(),.4),Klang.$("music_bus").input.gain.setTargetAtTime(_this._musicVolumeGarage,Klang.Util.now(),.8),Klang.$("music_bus").output.gain.setTargetAtTime(_this._musicVolumeGarage,Klang.Util.now(),.8),this._raceOngoing=!1,_this.stopAllSFX(!0);break;case"Gameplay":this._raceOngoing=!1,Klang.$("reverb_bus").effects[0].setActive(!1),Klang.$("music_bus").effects[0].setActive(!1)}}function normalizeBetweenTwoRanges(val,minVal,maxVal,newMin,newMax){return newMin+(val-minVal)*(newMax-newMin)/(maxVal-minVal)}!function addHandlers(){_this._enabled&&_this.events.sub(ViewController.CHANGE,onViewControllerChange).bind(this)}(),this.loaded=function(){return this._initialLoadPromise},this.loadAudio=async function(){return this._initialLoadPromise=new Promise(async(resolve,reject)=>{this._isDev&&(Klang.loggingEnabled=!0),Klang.init(Assets.getPath("assets/sound/config.js"),()=>{resolve()})}),this._initialLoadPromise},this.preload=async function(groups){let promise=new Promise(async(resolve,reject)=>{resolve()});return loadedGroups[groups]=promise,promise},this.unloadScene=function(scene){_this._enabled&&Klang.free(scene)},this.initRace=function(name){_this._enabled&&(this._isDev&&console.log("initRace: ",name),Utils.query("no_music_ingame")&&(this._enableMusic=!1),this.freeReferences(),this.settings=this.carSettings[name],this.idleLoop=Klang.$(this.settings.idleLoop.name),this.windLoop=Klang.$("wind_loop"),this.raceMusic=Klang.$(this.settings.raceMusic),this.brakeLoop=Klang.$(this.settings.brakeLoop.name),this.pitchLoop=Klang.$(this.settings.pitch.loopMid),this.windBus=Klang.$("wind_loop_bus"),this.windBus.output.gain.setValueAtTime(0,Klang.Util.now()),this.brakeBus=Klang.$("brake_bus"),this.engineBus=Klang.$("engine_bus"),this.engineBus.output.gain.setTargetAtTime(this.settings.engineVolume,Klang.Util.now(),.1),this.musicBus=Klang.$("music_bus"),this.accBus=Klang.$("acc_bus"),this.settings.accVolume=this.settings.startAcc.volume,"none"!=this.settings.startAcc.name&&(this.startAcc=Klang.$(this.settings.startAcc.name)),this.pitchLoop&&this.pitchLoop.fadeOutAndStop(.01),this.windLoop&&this.windLoop.fadeOutAndStop(.01),this.idleLoop&&this.idleLoop.fadeInAndPlay(.2),this._raceOngoing=!1,this._isPaused=!1,this._accTimer&&(clearInterval(this._accTimer),this._accTimer=null),this.stopMusic())},this.raceStart=function(isTutorial){_this._enabled&&(this._isDev&&console.log("raceStart: "),this._raceOngoing=!0,this.raceMusic&&this._enableMusic&&this.raceMusic.fadeInAndPlay(.1),this._enableSfx&&!Klang.isMobile&&this.windLoop.fadeInAndPlay(this._generalFadeTime),this._usePitch&&this.pitchLoop.play(),this.settings&&(this.engineBus.output.gain.setTargetAtTime(this.settings.engineVolume,Klang.Util.now(),.1),this.accBus.output.gain.setTargetAtTime(this.settings.accVolume,Klang.Util.now(),.1),this.brakeBus.output.gain.setTargetAtTime(0,Klang.Util.now(),.1),this.brakeLoop.fadeInAndPlay(.2),this.musicBus.input.gain.setTargetAtTime(this._musicVolume,Klang.Util.now(),.01),this.musicBus.output.gain.setTargetAtTime(this._musicVolume,Klang.Util.now(),.01),this.musicBus.effects[0].wet.setTargetAtTime(0,Klang.Util.now(),.1)),this.idleLoop&&this.idleLoop.fadeOutAndStop(.2),this._fastAccPlaying=!0,this.engineBus.output.gain.setTargetAtTime(0,Klang.Util.now(),this._posMin),this._accTimer&&(clearInterval(this._accTimer),this._accTimer=null),this._gear=0)},this.changeAcceleration=function(action,acceleration){if(_this._enabled&&this._enableSfx&&this.settings)if("throttling"==action){if(0==this._gear&&this.startAcc){Math.random(),Math.random();this._accTimer=setTimeout(()=>{_this.startAcc.fadeOutAndStop(.5),_this._fastAccPlaying=!1,this._isDev&&console.log("now!")},1e3*(this.startAcc.duration-.7)),this.startAcc.fadeInAndPlay(.2),this._fastAccPlaying=!0,this._isDev&&console.log("playing start acc")}this._accelerating=!0}else"braking"==action&&(this.startAcc,this._isTurning||this._isPaused||!this._raceOngoing||(clearTimeout(this._accTimer),this.startAcc.fadeOutAndStop(.2),this._fastAccPlaying=!1,"rdx"!=this.settings.name&&(this._isDev&&console.log("brake one shot"),Klang.trigger("brake_oneshot"))),this._accelerating=!1)},this.onAcceleration=function(acceleration){_this._enabled&&this._enableSfx&&(this.windBus&&!this._isPaused&&acceleration>0&&(this._mph>60&&!Klang.isMobile?this.windBus.output.gain.setTargetAtTime(isFinite(acceleration),Klang.Util.now(),.4):this.windBus.output.gain.setTargetAtTime(0,Klang.Util.now(),.5)),this._acceleration=acceleration)},this.onCollision=function(){_this._enabled&&this._enableSfx&&(this._isPaused||(Klang.trigger("collision"),this.startAcc&&(this.startAcc.fadeOutAndStop(.2),this._fastAccPlaying=!1)))},this.handleBraking=function(braking){_this._enabled&&this._enableSfx&&(this.startAcc.fadeOutAndStop(.2),this._fastAccPlaying=!1,"rdx"==this.settings.name&&(this._isDev&&console.log("rdx blowout"),Klang.trigger("rdx_blowout")))},this.turning=function(isTurning){_this._enabled&&(this._isTurning=isTurning)},this.changeGear=function(gear){_this._enabled&&this._enableSfx&&this.settings&&(this._usePitch&&this._raceOngoing&&"arx"==this.settings.name&&Klang.trigger("arx_gearshift"),this._gear=gear)},this.stopMusic=function(){_this._enabled&&Klang.trigger("stop_all_music")},this.onPause=function(){_this._enabled&&(this.engineBus.output.gain.setTargetAtTime(0,Klang.Util.now(),.1),this.windBus.output.gain.setTargetAtTime(0,Klang.Util.now(),.1),this.brakeBus.output.gain.setTargetAtTime(0,Klang.Util.now(),.1),this.musicBus.output.gain.setTargetAtTime(.2,Klang.Util.now(),.5),this.accBus.output.gain.setTargetAtTime(0,Klang.Util.now(),.1),this._isPaused=!0)},this.onResume=function(){_this._enabled&&(this.engineBus.output.gain.setTargetAtTime(this.settings.engineVolume,Klang.Util.now(),.1),this.accBus.output.gain.setTargetAtTime(this.settings.accVolume,Klang.Util.now(),.1),this.musicBus.output.gain.setTargetAtTime(this._musicVolume,Klang.Util.now(),.5),this._isPaused=!1)},this.mute=function(){_this._enabled&&(_this.muted=!0,Klang.trigger("sound_off"))},this.unmute=function(){_this._enabled&&(_this.muted=!1,Klang.trigger("sound_on"))},this.maxGear=function(maxGear){_this._enabled&&(this._maxGear=maxGear)},this.setRpm=function(rpm){if(_this._enabled){if(this._rpm=rpm,this._usePitch&&this.pitchLoop&&this.settings&&this._raceOngoing){let rate=normalizeBetweenTwoRanges(rpm,0,1,this.settings.pitch.min,this.settings.pitch.max);this.pitchLoop.curvePlaybackRate(rate,this.settings.pitch.time,Klang.Util.now()),this._fastAccPlaying&&this._switchEngines?this.engineBus.output.gain.setTargetAtTime(0,Klang.Util.now(),.2):this.engineBus.output.gain.setTargetAtTime(this.settings.engineVolume,Klang.Util.now(),.3)}performance.now()-this._lastRpmTime>0&&(this._lastRpm,this._lastRpm=rpm,this._lastRpmTime=performance.now())}},this.setMph=function(mph){_this._enabled&&(mph>80&&this._isDrifting&&this.brakeBus&&!this._isPaused?(this._isDev&&console.log("drifting sfx"),this.brakeBus.output.gain.setTargetAtTime(normalizeBetweenTwoRanges(mph,0,this._topMph,0,.8),Klang.Util.now(),.5)):this.brakeBus.output.gain.setTargetAtTime(0,Klang.Util.now(),.4),this._mph=mph)},this.changeCar=function(carIndex,shouldPlay){if(!_this._enabled||"Garage"==Global.PLAYGROUND)return;if(!this._enableMusic)return;Klang.$("music_bus").effects[0].wet.setTargetAtTime(.3,Klang.Util.now(),.2),Klang.$("music_bus").input.gain.setTargetAtTime(.25,Klang.Util.now(),.2);let loops=Klang.$("drive_loops").content;if(!loops.length)return;let currentIndex=carIndex;for(let i=0;i<loops.length;i++){let loop=loops[i];i==currentIndex&&shouldPlay?loop.fadeInAndPlay(.5):loop.fadeOutAndStop(.5)}},this.countDown=function(number){_this._enabled&&Klang.trigger("countdown",number)},this.isDrifting=function(bool){_this._enabled&&(this._isDrifting=bool)},this.stopAllSFX=function(stopIdle){_this._enabled&&(this.brakeLoop&&this.brakeLoop.fadeOutAndStop(.6),this.idleLoop&&stopIdle&&this.idleLoop.fadeOutAndStop(.6),this.windLoop&&this.windLoop.fadeOutAndStop(.6),this.pitchLoop&&this.pitchLoop.fadeOutAndStop(.6),this.startAcc&&this.startAcc.fadeOutAndStop(.6))},this.finishRace=function(qualified){this._isDev&&console.log("qualified: ",qualified),_this._enabled&&(this._raceOngoing=!1,Klang.trigger("finish_race"),"rdx"!=this.settings.name&&Klang.trigger("brake_oneshot"),this.stopAllSFX(!1),Klang.$("music_bus").output.gain.setTargetAtTime(_this._musicVolumeGarage,Klang.Util.now(),.4),this.idleLoop&&this.idleLoop.fadeInAndPlay(.3))},this.handleResults=function(passed){this._isDev&&console.log("handleResults: ",passed),_this._enabled&&(this.raceMusic&&this.raceMusic.fadeOutAndStop(2),passed&&Klang.trigger("beat_time_success"),this.idleLoop&&this.idleLoop.fadeOutAndStop(.6))},this.checkPoint=function(index){_this._enabled&&("old_nsx"==_this.settings.name||"integra"==_this.settings.name?Klang.trigger("checkpoint_retro",index):Klang.trigger("checkpoint_modern",index))},this.powerUp=function(_){_this._enabled&&Klang.trigger("powerup")},this.topMph=function(topMph){_this._enabled&&(this._topMph=topMph)},this.startCar=function(carname){_this._enabled&&Klang&&Klang.$("engine_bus")&&(Klang.$("engine_bus").output.gain.setTargetAtTime(.4,Klang.Util.now(),this._posMin),Klang.trigger("start_"+carname))},this.initWebAudio=function(index){_this._enabled&&(this._isDev&&console.log("initWebAudio"),Klang&&(Klang.trigger("silence"),Klang.initIOS()))},this.freeReferences=function(){this.stopAllSFX(!0),this.idleLoop=null,this.windLoop=null,this.raceMusic=null,this.brakeLoop=null,this.pitchLoop=null,this.windBus=null,this.brakeBus=null,this.engineBus=null,this.musicBus=null,this.startAcc=null,this.accBus=null,this._accTimer=null}}),"singleton"),Class((function CarManager(){Inherit(this,Object3D);const _this=this;var _config,_cars={};!async function(){if(function initConfig(){(_config=InputUIL.create("CarManagerConfig","CarManager"==Global.PLAYGROUND?void 0:null)).addTextarea("names")}(),Utils.query("car")){let view=_this.initClass(CarView,Utils.query("car"));(await view.getLayers()).forEach(l=>{l.shader.addUniforms({tMatcap:{value:Utils3D.getTexture("assets/images/environment/garage/00-1.jpg")},uGarageDeselect:{value:0}})})}else!function initCars(){_config.get("names").split("\n").forEach(name=>{let key=layout=name;name.includes(":")&&([key,layout]=name.split(":")),_cars[key]=_this.initClass(CarView,layout,null)})}()}(),this.getList=function(){return _config.get("names").split("\n").map(l=>l.includes(":")?l.split(":")[0]:l)},this.getCarProxy=function(name,instance){return instance.initClass(CarProxy,instance.initClass(CarView,name))},this.getGhostCar=function(name){return _this.initClass(CarView,name)},this.ready=async function(sync){let array=[];for(let key in _cars)array.push(_cars[key].loaded(sync));return Promise.all(array)},this.remapName=function(name){let list=_config.get("names").split("\n");for(let i=0;i<list.length;i++)if(list[i].includes(name))return list[i].includes(":")?list[i].split(":")[1]:name},this.getNext=function(name){let list=_config.get("names").split("\n");for(let i=0;i<list.length;i++)if(list[i].includes(name))return list[i+1]&&list[i+1].includes(":")?list[i+1].split(":")[1]:name}}),"singleton"),Class((function Container(){Inherit(this,Element);const _this=this,$this=this.element;async function loadKlang(){await AssetLoader.waitForLib("Klang"),await AudioController.instance().loadAudio()}!function initHTML(){Stage.add($this),$this.css({position:"static"})}(),async function loadView(){let loaderView=_this.initClass(LoaderView),loader=_this.initClass(AssetLoader,Assets.list().filter(["shaders","data","lib"])),loaded=Promise.create();loader.add(5),_this.events.sub(loader,Events.PROGRESS,loaderView.progress),_this.events.sub(loader,Events.COMPLETE,()=>{loaderView.animateOut(()=>{loaderView=loaderView.destroy(),Config.FACEBOOK&&(Stage.width=window.innerWidth,Stage.height=window.innerHeight,_this.events.fire(Events.RESIZE)),loaded.resolve()})}),await Promise.all([loadKlang(),Initializer3D.createWorld()]),async function initView(){World.instance(),$this.add(World.ELEMENT),await UIConfig.ready(),await defer(),ViewController.instance()}(),loader.trigger(4),await ViewController.instance().splashLoaded(),loader.trigger(1)}()}),"singleton"),Class((function Gameplay(_name=Utils.query("name")){Inherit(this,FXScene);const _this=this;var _loading;function render(){_this.render()}function gameEnd(){Data.tracks[_name].saveResults(_this)}function gameReset(){Data.tracks[_name].reset(_this)}function gameReplay(){_this.gameState.replay()}!function(){if(Lighting.createScene(_name,_this.scene).useScene(_name),_this.create(),_this.worldCamera=Camera.instance().createLocal(),Utils.query("orbit")||_this.useCamera(_this.worldCamera.worldCamera),_this.worldCamera.worldCamera.far=Tests.getFar(_name),_this.worldCamera.worldCamera.updateProjectionMatrix(),_this.state=AppState.createLocal(),_this.state.set("playId",ID.generate()),_this.vfx=_this.initClass(GameplayVFX,_name,_this.nuke),_this.track=_this.initClass(GameplayTrack,_name),_this.checkPoints=_this.initClass(GameplayCheckpoints,_name,_this.track),_this.powerups=_this.initClass(GameplayPowerups,_name,_this.track),_this.cars=_this.initClass(GameplayCars,_name),_this.camera=_this.initClass(GameplayCamera,_name,_this.cars.player),_this.environment=_this.initClass(GameplayEnvironment,_name),_this.collision=_this.initClass(GameplayCollision,_name,_this.cars.player,_this.track),_this.controls=_this.initClass(GameplayControls,_name,Utils.query("car_version")||"",_this.cars.player,_this.collision),_this.timer=_this.initClass(GameplayTimer,_name,_this.collision),_this.gameState=_this.initClass(GameplayState,_name,_this.controls,_this.timer,_this.cars,_this),_this.multiplayer=_this.initClass(GameplayMultiplayer,_this,_name),"Gameplay"!==Global.PLAYGROUND&&(_this.ui=_this.initClass(GameplayUI,_name,_this)),_this.sound=_this.initClass(GameplaySound,_name,_this),Utils.query("capture")){let capture=_this.initClass(EnvCapture,_name);_this.scene.add(capture.group)}_this.scene.add(_this.track.group),_this.scene.add(_this.cars.group),_this.scene.add(_this.environment.group),_this.scene.add(_this.checkPoints.group),_this.scene.add(_this.powerups.group),_this.startRender(render,World.NUKE),function addListeners(){_this.events.sub(Gameplay.END,gameEnd),_this.events.sub(Gameplay.RESET,gameReset),_this.events.sub(Gameplay.REPLAY,gameReplay),Config.FACEBOOK&&FBInstant.onPause(()=>{_this.gameState&&_this.gameState.isPlaying&&_this.gameState.pause()})}(),Global.CURRENT_TRACK=_name}(),this.loaded=async function(sync){if(_loading)return _loading;_loading=Promise.create(),await Promise.all([_this.track.loaded(sync),_this.cars.loaded(sync),_this.environment.loaded(sync),_this.checkPoints.loaded(sync),_this.powerups.loaded(sync),_this.sound.loaded(sync),_this.vfx.loaded(sync)]),_this.delayedCall(_=>{Preloader.load(Data.getTrackNameByNumber(Data.getTrackNumberByName(_name)+1))},5e3),_this.visible=!0,_loading.resolve()},this.releaseLighting=function(){Lighting.destroyScene(_name),_this.multiplayer.destroy()},this.onDestroy=function(){Lighting.destroyScene(_name),_this.fxDestroy()},this.releaseLowMem=function(){_this.track.destroy(),_this.environment.destroy(),_this.vfx.destroy(),_this.checkPoints.destroy(),_this.sound.destroy(),_this.powerups.destroy()},this.get("name",_=>_name)}),_=>{Gameplay.START="gameplay_start",Gameplay.RESET="gameplay_reset",Gameplay.REPLAY="gameplay_replay",Gameplay.END="gameplay_end",Gameplay.SHARE="gameplay_share",Gameplay.RESULT="gameplay_result"}),Class((function Garage(){Inherit(this,FXScene);const _this=this;var _layout,_promise;Lighting.createScene("garage",_this.scene),_this.create(),_this.startRender(_=>_this.render()),_this.setDPR(Tests.garageDPR()),_layout=_this.initClass(SceneLayout,"garage"),_this.scene.add(_layout.group),Global.PLAYGROUND||_this.initClass(GarageUI),_this.camera=_this.initClass(GarageCamera,_layout),Utils.query("orbit")||Utils.query("camera")||_this.useCamera(_this.camera.worldCamera),_this.vfx=_this.initClass(GarageVFX,_this.nuke),this.loaded=function(sync){return _promise||(_promise=Promise.create(),Initializer3D.detectUploadAll(_layout,sync).then(_promise.resolve),_promise)},this.onVisible=function(){Track.page("/garage"),Lighting.useScene("garage")},this.reset=function(){for(let key in _layout.layers){let obj=_layout.layers[key];obj instanceof GarageCar&&obj.deactivate()}}})),Class((function Leaderboard(){Inherit(this,Component);const _this=this;var _view=null;function onClick({value:value}){ViewController.instance().hideLeaderboard()}this.animateIn=function(name="old_nsx"){_view||function initView(name){(_view=_this.initClass(LeaderboardUI,name)).animateIn(),_this.events.sub(_view,Events.CLICK,onClick)}(name)},this.animateOut=async function(){_view&&(await _view.animateOut(),_this.events.unsub(_view,Events.CLICK,onClick),_view=_view.destroy?_view.destroy():null)}})),Class((function Loading(){Inherit(this,Component);const _this=this;var _view;this.animateIn=function(name="old_nsx"){!async function initView(name){_view&&(_view=_view.destroy()),(_view=_this.initClass(LoadingUI,name)).animateIn()}(name)},this.animateOut=function(){_view&&_view.animateOut()}})),Class((function Multiplayer(){Inherit(this,Component);const _this=this;var _view,_currTrack;this.animateIn=function(name){!async function initView(name){_currTrack!==Global.CURRENT_TRACK&&(_currTrack=Global.CURRENT_TRACK,_view&&(_view.destroy(),_view=null)),_view||(_view=_this.initClass(MultiplayerUI,Global.CURRENT_TRACK)),_view.animateIn(name)}(name)},this.animateOut=function(){_view&&_view.animateOut()}}),_=>{Multiplayer.SELECTION="multiplayer_selection"}),Class((function Playground(){Inherit(this,Component);const _this=this;let _view;!async function(){await UILStorage.ready(),Global.PLAYGROUND=location.search.split("p=")[1].split("&")[0],function initThree(){World.instance(),Stage.add(World.ELEMENT)}(),await UIConfig.ready(),function initView(){let request=Global.PLAYGROUND.split("/")[0],view=window["Playground"+request]||window[request]||null;if(!view)throw`No Playground class ${request} found.`;_view=view.instance?view.instance():_this.initClass(view),_view.element&&Stage.add(_view.element);if(_view.rt&&_view.scene&&_view.nuke){let shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:_view}}),mesh=new Mesh(World.QUAD,shader);mesh.frustumCulled=!1,World.SCENE.add(mesh)}else World.SCENE.add(_view.group||_view.mesh||_view.object3D||new Group);Dev.expose("view",_view)}(),defer(window.onresize)}()}),"singleton"),Class((function GLTextTest(){Inherit(this,GLUIElement);const _this=this;!async function(){await async function initText(){_this.layout=new StageLayout("gltexttest",{glui:!0}),_this.layers=await _this.layout.getAllLayers()}()}()})),Class((function PlaygroundGameplayStateFinishedInput(){Inherit(this,GLUIElement);const _this=this,SIZE=90;var $this,_first,_second,_third;function onClick(e){for(let[i,view]of[_first,_second,_third].entries())i!==e.index&&view.lock()}function resize(){for(let[i,view]of[_first,_second,_third].entries())view.element.x=.5*Stage.width+(i-1.5)*SIZE*1.1,view.element.y=.5*Stage.height-SIZE}!function initGL(){$this=_this.element,GLUI.Stage.add($this)}(),function initSelects(){let views=[],size=SIZE;for(;views.length<3;){let view=_this.initClass(GameplayStateFinishedInput,{size:size});_this.events.sub(view,Events.CLICK,onClick),view.index=views.length,views.push(view)}[_first,_second,_third]=views}(),function addHandlers(){_this.onResize(resize)}(),this.get("first",_=>_first),this.get("second",_=>_second),this.get("third",_=>_third)})),Class((function ViewController(){Inherit(this,Object3D);const _this=this;let _mesh,_shader,_garage,_splash,_leaderboard,_rotate,_loader,_audio,_multiplayer,_1v1,_activeView,_firstData,_state,_transitions={};async function transition(nextView,transitionName="BasicTransition",data){_transitions[transitionName]=_this.initClass(window[transitionName],data);let t=_transitions[transitionName];if(!t.shader)throw`Transition ${transitionName} does not have .shader property`;let lastView=_activeView;_mesh.shader=t.shader,"BasicTransition"==transitionName&&(_activeView.visible=!1,nextView.visible=!0),_state=nextView.constructor.name,_this.events.fire(ViewController.CHANGE,{view:_state}),UIConfig.resetBackground(),await t.play(_activeView,nextView),_this.events.fire(ViewController.CHANGE,{view:_state}),_activeView=nextView,lastView.visible=!1,_shader.set("tMap",_activeView),_mesh.shader=_shader,lastView instanceof Gameplay&&lastView.destroy&&lastView.destroy()}function onKey({key:key}){if(Tests.canToggleUI())switch(key){case"u":GLUI.Stage.alpha=1===GLUI.Stage.alpha?0:1}}function onChange({view:view}){"Garage"===view&&Data.clearGhost()}!async function(){World.SCENE.add(_this.group),await async function findFirstRoute(){await Data.ready();let hasPlayed=await UserStorage.get("hasPlayed"),level=Data.levelDeepLink(),levelDeeplinked=!!level&&parseInt(level)-1,track="old_nsx";Utils.query("testIntro")&&(hasPlayed=!1);_firstData=Data.decodeQuery(),_firstData&&Track.event("Deeplink","challenge",`level${Data.getTrackNumberByName(track)}`);if(!1===levelDeeplinked||_firstData)hasPlayed?_firstData||_this.flag("canStartGameplay",!0):(_firstData={track:"old_nsx"},UserStorage.set("hasPlayed",!0));else{track=Config.TRACKS[levelDeeplinked];let unlocked=await Data.tracks[track].isUnlocked(),joined=Utils.query("join");(unlocked||joined)&&(_firstData={track:track},joined&&(Global.ONLINE=!0,MultiplayerSession.HOST=!1,_this.events.fire(GameplayMultiplayer.ONLINE)))}level&&Track.event("Deeplink","level",`level${level}`)}(),function initMesh(){_shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:null}}),_mesh=new Mesh(World.QUAD,_shader),_this.add(_mesh)}(),function initViews(){if("Gameplay"===Global.PLAYGROUND)return;_garage=_this.initClass(Garage),_firstData?(_splash=_this.initClass(SplashScreen),_shader.set("tMap",_splash),_activeView=_splash,_garage.visible=!1,Track.page("/splash")):(_activeView=_garage,_garage.visible=!0);_shader.set("tMap",_activeView),Tests.allowsMultiplayer()&&(_1v1=_this.initClass(MultiplayerButton,_garage),_multiplayer=_this.initClass(Multiplayer));_leaderboard=_this.initClass(Leaderboard),_rotate=_this.initClass(RotateUI),_loader=_this.initClass(Loading),_audio=_this.initClass(AudioInteractionUI)}(),function initTransitions(){_this.initClass(CRTTransition),_this.initClass(CRTTransition2),_this.initClass(GameTransition),_this.initClass(GarageTransition)}(),await async function initFirstView(){if(_this.flag("initialized",!0),_audio.animateIn(),_firstData&&_firstData.track){await _splash.loaded(!0);let game=_this.initClass(Gameplay,CarManager.instance().remapName(_firstData.track));game.visible=!1,await game.loaded(!0),await _splash.animateOut(),await transition(game,"CRTTransition",!0),_splash.visible=!1,await CarManager.instance().ready(),_garage.loaded()}else await CarManager.instance().ready(!0),await _garage.loaded(!0),_garage.visible=!0;_state=_activeView.constructor.name,_this.events.fire(ViewController.CHANGE,{view:_state})}(),function addHandlers(){_this.events.sub(KeyboardUtil.PRESS,onKey),_this.events.sub(ViewController.CHANGE,onChange)}(),function displayVersion(){return void Config.FACEBOOK}()}(),this.playTrack=async function(name){GLUI.PREVENT_INTERACTION=!0,_this.flag("canStartGameplay",!1);let game=_this.initClass(Gameplay,CarManager.instance().remapName(name));game.visible=!1,await game.loaded(!0),_this.hideLoader(),await transition(game,"GameTransition"),_this.flag("canStartGameplay",!1,50),GLUI.PREVENT_INTERACTION=!1,_garage.reset()},this.nextTrack=async function(name){GLUI.PREVENT_INTERACTION=!0,_this.flag("canStartGameplay",!1),_activeView.visible=!1,_activeView.releaseLighting&&_activeView.releaseLighting(),Tests.lowMemory()&&_activeView.releaseLowMem(),await _this.wait(32),Data.clearGhost();let nextNumber=Data.getTrackNumberByName(name)+1;nextNumber>Object.keys(Data.tracks).length&&(nextNumber=1);let next=Data.getTrackNameByNumber(nextNumber),game=_this.initClass(Gameplay,CarManager.instance().getNext(next));game.visible=!1,await game.loaded(!0),_this.hideLoader(),await transition(game,"CRTTransition2"),GLUI.PREVENT_INTERACTION=!1},this.exitGame=async function(){GLUI.PREVENT_INTERACTION=!0,_activeView.visible=!1,_garage.visible=!0,await _this.wait(50),_this.hideLeaderboard(),await transition(_garage,"GarageTransition"),GLUI.PREVENT_INTERACTION=!1},this.showLeaderboard=function(name){_leaderboard.animateIn(name)},this.hideLeaderboard=function(){_leaderboard.animateOut()},this.showLoader=function(name){_loader.animateIn(name)},this.hideLoader=function(){_loader.animateOut()},this.showMultiplayer=function(name){_multiplayer&&_multiplayer.animateIn(name)},this.hideMultiplayer=function(){_multiplayer&&_multiplayer.animateOut()},this.canBeginGame=function(){return _this.wait("canStartGameplay")},this.splashLoaded=async function(){return await _this.wait("initialized"),_splash?_splash.loaded(!0):_garage.loaded(!0)},this.showPresents=function(){return!0},this.get("state",_=>_state)}),"singleton",_=>{ViewController.CHANGE="view_controller_change"}),Class((function World(){Inherit(this,Component);const _this=this;let _renderer,_scene,_camera,_nuke,_controls,_snap;function resize(){_renderer.setSize(Stage.width,Stage.height),_camera.aspect=Stage.width/Stage.height,_camera.updateProjectionMatrix()}function loop(t,delta){_controls&&_controls.enabled&&_controls.update(),RenderManager.render(),_snap&&(_this.snapshot=_renderer.canvas.toDataURL("image/png"),_snap=!1)}World.DPR=Tests.getDPR(),function initWorld(){World.PLANE=new PlaneGeometry(1,1),World.QUAD=Utils3D.getQuad(),World.BOX=World.CUBE=new BoxGeometry(1,1,1),World.SPHERE=new SphereGeometry(1,16,16),RenderManager.initialize(RenderManager.NORMAL,{powerPreference:"high-performance"}),_renderer=RenderManager.gl,_scene=RenderManager.scene,_camera=RenderManager.camera.worldCamera,_nuke=RenderManager.nuke,(GPU.mobileLT(2)||GPU.lt(1))&&(Render.capFPS=31),World.SCENE=_scene,World.RENDERER=_renderer,World.ELEMENT=$(_renderer.domElement),World.CAMERA=_camera,World.NUKE=_nuke,Tests.renderShadows()||(_renderer.shadows=!1)}(),function initControls(){window.DebugControls&&(_controls=new DebugControls(_camera,World.ELEMENT.div),RenderManager.type==RenderManager.NORMAL?(_camera.position.set(0,0,6),_camera.target=new Vector3(0,0,0),_camera.lookAt(_camera.target),_controls.target=_camera.target):_controls.enabled=!1,World.CONTROLS=_controls)}(),function addHandlers(){_this.events.sub(Events.RESIZE,resize)}(),Utils.query("uilOnly")||Render.onDrawFrame(loop),RenderManager.type==RenderManager.NORMAL&&Camera.instance(_camera),_this.snap=async function(){return _this.snapshot=null,_snap=!0,await _this.wait(_this,"snapshot"),_this.snapshot}}),(function(){var _instance;World.instance=function(){return _instance||(_instance=new World),_instance}})),Class((function SceneView(){Inherit(this,Object3D);const _this=this;!function initMesh(){let mesh=new Mesh(new BoxGeometry(1,1,1),Utils3D.getTestShader());_this.add(mesh),_this.startRender(t=>{mesh.position.y=.3*Math.sin(.002*t),mesh.rotation.y+=.01,mesh.rotation.x+=.004}),World.SCENE.add(_this.group);let camera=_this.initClass(GazeCamera);camera.moveXY.set(8,4),camera.position.set(0,0,6),camera.lerpSpeed=.07,camera.lookAt=new Vector3,camera.lock()}()})),Class((function CarBounding(_mesh){Inherit(this,Component);const _this=this;var _nulls=[];function loop(){for(let i=0;i<4;i++)_nulls[i].getWorldPosition(_this.vectors[i])}this.vectors=[],function(){_mesh.geometry.computeBoundingBox(),_mesh.geometry.computeBoundingSphere(),_this.mesh=_mesh;let bb=_mesh.geometry.boundingBox.clone();bb.setFromObject(_mesh),_this.sphere=_mesh.geometry.boundingSphere;for(let i=0;i<4;i++){let group=new Group;_nulls.push(group),_this.parent.add(group),_this.vectors.push(new Vector3)}_nulls[0].position.set(bb.max.x,.5,bb.max.z),_nulls[1].position.set(bb.min.x,.5,bb.max.z),_nulls[2].position.set(bb.max.x,.5,bb.min.z),_nulls[3].position.set(bb.min.x,.5,bb.min.z),_this.startRender(loop)}()})),Class((function CarCommonShader(_shader){Inherit(this,Component);_shader.addUniforms({tMatcap:{value:null,ignoreUIL:!0},uGarageDeselect:{value:0,ignoreUIL:!0},tLookup:{value:null,getTexture:Utils3D.getLookupTexture},uEnvRotation:{value:new Vector4},uClearCoat:{value:new Vector3(.7,.75,.1)},uEnvReflection:{value:1},uColor:{value:new Color}}),defer(_=>(function setAnisotropy(array){array.forEach(key=>{let texture=_shader.get(key);texture&&(texture.anisotropy=World.RENDERER.getMaxAnisotropy())})})(["tBaseColor","tMRO","tNormal"]))})),Class((function CarProxy(_car){Inherit(this,Object3D);const _this=this;_this.startRender(_=>{}),_this.car=_car,this.onVisible=function(){_car.car&&(_car.car.group.rotation.set(0,0,0),_car.car.setEnvRotationSpeed(new Vector3,0)),_this.add(_car.group)}})),Class((function CarView(_name){Inherit(this,Object3D);const _this=this;var _layout,_wheels,_nose,_bb,_center,_body,_brake,_wheelRotation=0,_steering=0,_roll=0,_lift=0,_layers=[];this.name=_name,async function(){_layout=_this.initClass(SceneLayout,`car_${_name}`,{noGraph:!Utils.query("car"),persistTextures:!0}),await _layout.loadedAllLayers(),[_wheels,_nose,_bb,_center,_body]=await Promise.all([_layout.getLayers("wheel_fr","wheel_fl","wheel_rr","wheel_rl"),_layout.getLayer("nose"),_layout.getLayer("bounding_box"),_layout.getLayer("center"),_layout.getLayer("body_group")]),_layout.exists("lights")&&(_brake=await _layout.getLayer("lights")),function nestWheels(array){array.forEach(wheel=>{let parent=wheel._parent,group=new Group;group.add(wheel),parent.add(group),group.position.copy(wheel.position),wheel.position.set(0,0,0)})}([_wheels[0],_wheels[1]]),_bb.shader.visible=!1,_nose.shader.visible=!1,_center.shader.visible=!1,_brake&&(_brake.visible=!1),_this.bounding=_this.initClass(CarBounding,_bb);let layers=await _layout.getAllLayers();for(let key in layers){let layer=layers[key];layer.visible&&(layer.castShadow=!0,layer.shader&&layer.shader.visible&&(layer.shader.receiveShadow=!0,_layers.push(layer)))}if(_this.flag("isReady",!0),_this.findParent("Garage")){let release=await Initializer3D.queue();await Initializer3D.uploadAllAsync(_layout),release()}}(),this.ready=function(){return _this.wait("isReady")},this.loaded=function(sync){return Initializer3D.detectUploadAll(_layout,sync)},this.get("center",_=>_center),this.get("nose",_=>_nose),this.get("wheels",_=>_wheels),this.set("steering",v=>{_steering=v,_wheels&&(_wheels[0]._parent.rotation.y=v,_wheels[1]._parent.rotation.y=v)}),this.get("steering",_=>_steering),this.set("wheelRotation",v=>{_wheelRotation=v,_wheels&&_wheels.forEach(w=>w.rotation.x=v)}),this.get("wheelRotation",_=>_wheelRotation),this.set("roll",v=>{_roll=v,_body&&(_body.rotation.z=v)}),this.get("roll",_=>_roll),this.set("lift",v=>{_lift=v,_body&&(_body.rotation.x=v)}),this.set("brake",v=>{_brake&&(_brake.visible=v)}),this.get("lift",_=>_lift),this.get("boundingPoints",_=>void 0),this.setEnvRotationSpeed=function(vec,speed){for(let key in _layers){let shader=_layers[key].shader;shader&&shader.uniforms.uEnvRotation&&(shader.uniforms.uEnvRotation.value.x=vec.x,shader.uniforms.uEnvRotation.value.y=vec.y,shader.uniforms.uEnvRotation.value.z=vec.z,shader.uniforms.uEnvRotation.value.w+=.01*Render.DT*speed)}},this.getLayers=async function(){return await _this.wait("isReady"),_layers}})),Class((function PBRARX(_mesh,_shader){Inherit(this,CarCommonShader,_shader)})),Class((function CarLightPBR(_mesh,_shader){Inherit(this,Component);_shader.addUniforms({uAlpha:{value:1}})})),Class((function PBRIntegra(_mesh,_shader){Inherit(this,CarCommonShader,_shader);_shader.addUniforms({uLightBounce:{value:0},uAttenuation:{value:0}})})),Class((function OldNSX(_mesh,_shader){_shader.addUniforms({tMap:{value:null},tNormal:{value:null},uColor:{value:new Color},uEnvReflection:{value:0}})})),Class((function PBROldNSX(_mesh,_shader){Inherit(this,CarCommonShader,_shader)})),Class((function PBRRDX(_mesh,_shader){Inherit(this,CarCommonShader,_shader);_shader.addUniforms({uBlend:{value:1}})})),Class((function PBRTypeS(_mesh,_shader){Inherit(this,CarCommonShader,_shader)})),Class((function ARXVolumetricLight(){Inherit(this,Component);const _this=this;var _farScene,_nearScene,_volumetricLight,_gameplay=_this.findParent("Gameplay"),_environment=_gameplay.environment,_sky=_environment.sky;function loop(){_farScene.draw(),_nearScene.draw(),_volumetricLight.render(_farScene.nuke.stage,_sky.camera),World.RENDERER.render(_farScene.scene,_sky.camera,_farScene.rt),World.RENDERER.autoClear=!1,World.RENDERER.render(_nearScene.scene,_gameplay.worldCamera.worldCamera,_farScene.rt),World.RENDERER.autoClear=!0}!async function(){let enabled=Tests.arxVolumetricLight();if((_farScene=_this.initClass(FXScene,World.NUKE)).preventRTDraw=!0,_farScene.setDPR(1),_farScene.setResolution(.5),(_nearScene=_this.initClass(FXScene,World.NUKE,_farScene.rt)).preventRTDraw=!0,(_volumetricLight=_this.initClass(FX.VolumetricLight,_gameplay.nuke,"ARX",{useFXScene:!0,enabled:enabled})).resolution=.5,_volumetricLight.dpr=1,_volumetricLight.setComposite(_farScene.rt),_this.rt=_volumetricLight,!enabled)return;let sun=await _sky.layout.getLayer("sun");_farScene.add(sun),_volumetricLight.add(sun,!0);let layers=await _environment.layout.getLayers("grandstand","tree","pb1","pb2","pb3");await Promise.all(layers.map(l=>l.instanceMeshReady));let cached=MeshBatch.shaders[`${layers[0].shader.vsName}|${layers[0].shader.fsName}`],vs=cached?cached.vertex:layers[0].shader.vertexShader,shader=_this.initClass(Shader,"VolumetricMaskShader");layers.forEach(layer=>{shader.vertexShader=vs,_nearScene.add(layer.instanceMesh).shader=shader}),_this.startRender(loop,_gameplay.nuke)}()})),Class((function StreamSpawn(_proton){Inherit(this,Component);const _this=this;var _car,_radius,_state,_velocity=new Vector3(0,0,1),_extra=new Vector3(0,0,1),_angle=new Vector3;function loop(){let acceleration=_state.get("acceleration"),line=_state.get("line");_proton.behavior.setUniform("uFlyMultiplier",Math.range(acceleration,.6,1,.1,.2));let num=Math.floor(Math.range(acceleration,.3,.7,1,4))*Render.HZ_MULTIPLIER,alpha=.3+.4*line*Math.range(acceleration,.2,.4,0,1,!0);_proton.tubes.shader.uniforms.uAlpha.value=Math.lerp(alpha,_proton.tubes.shader.uniforms.uAlpha.value,.1);for(let i=0;i<num;i++){let pos=_car.center.getWorldPosition();pos.add(_extra.set(0,0,6).applyQuaternion(_car.group.quaternion)),_angle.setAngleRadius(Math.radians(Math.random(10,170)),_radius*Math.random(.8,1.2,4)).applyQuaternion(_car.group.quaternion),pos.add(_angle),_velocity.set(0,0,1).applyQuaternion(_car.group.quaternion),_proton.tubes.release(pos,1,0,_velocity)}}!async function(){_proton.padding=1e3;let gameplay=_this.findParent("Gameplay");_state=gameplay.state,_car=gameplay.cars.player,await _this.wait(_car,"boundingBox"),_radius=1.175*_car.boundingBox.sphere.radius,await _proton.tubes.wait("shader"),_this.startRender(loop),gameplay.state.bind("paused",value=>{1==value?_this.pause():_this.resume()}),_proton.tubes.mesh.renderOrder=9999}(),_this.pause=function(){_proton.visible=!1,_this.stopRender(loop)},_this.resume=function(){_proton.visible=!0,_this.startRender(loop)}})),Class((function GameplayCamera(_name,_car){Inherit(this,Object3D);const _this=this;var _camera,_fovorigin,_defaultWobbleStrength,_tick=0,_target=new Vector3,_offset=new Vector3;function loop(){let lerpSpeed=_this.parent.controls?_this.parent.controls.config.getNumber("cameraLerp"):.2;lerpSpeed*=1*_this.parent.controls.fpsAdjust,isNaN(lerpSpeed)&&(lerpSpeed=.2),_camera.group.position.z=Math.range(_this.parent.controls.acceleration,0,1,0,_this.parent.controls.config.getNumber("cameraAdjust"),!0),_camera.wobbleStrength=_defaultWobbleStrength*_this.parent.controls.config.getNumber("cameraShake")*Math.range(_this.parent.controls.acceleration,.3,.7,0,1),_tick++<30&&(lerpSpeed=1),_target.copy(_car.group.position).add(_offset),_this.group.position.lerp(_target,lerpSpeed),_this.group.quaternion.slerp(_car.group.quaternion,lerpSpeed),_this.group.updateMatrixWorld(!0)}function deltaAcceleration(v){v}(_camera=_this.initClass(GazeCamera)).prefix=`gameplay_camera_${_name}`,CameraUIL.add(_camera).setLabel("Camera"),_defaultWobbleStrength=_camera.wobbleStrength,_this.add(_camera.group),_this.camera=_camera,defer(_=>{_this.fov=_camera.camera.fov}),_camera.oY=_camera.position.y,_this.startRender(loop),_camera.lock(_this.parent.worldCamera),_this.parent.state.bind("deltaAcceleration",deltaAcceleration),_this.parent.state.bind("paused",value=>{1==value?_this.pause():_this.resume()}),this.reset=function(){_tick=0,_this.group.position.copy(_car.group.position),_this.group.quaternion.copy(_car.group.quaternion),_camera.lock(_this.parent.worldCamera),_this.startRender(loop)},this.pause=function(){_camera.wobbleStrength=0,_this.stopRender(loop)},this.resume=function(){_this.startRender(loop)},this.animateIn=function(){_offset.z=-8,tween(_offset,{z:0},4e3,"easeOutCubic")},this.powerup=function(){_fovorigin||(_fovorigin=_camera.camera.fov),tween(_camera.camera,{fov:_fovorigin+10},300,"easeInOutCirc",_=>{tween(_camera.camera,{fov:_fovorigin},2e3,"easeInOutCubic",300)})}})),Class((function GameplayControls(_name,_version,_car,_collision){Inherit(this,Component);const _this=this;var _config,_brakingPromise,_lineRange,_gearCurve,_fpsAdjust=1,_acceleration=0,_force=0,_gear=1,_gearValue=0,_steerTime=0,_allowedSpeed=0,_forward=new Vector3(0,0,1),_steering=new Euler,_steeringQuaternion=new Quaternion,_penalty={value:0},_prev=new Vector3,_collisionRotation=new Euler;Tests.lowMemory();(function(){switch(_name){case"arx":return 2.75;case"new_nsx":case"type_s":;}})(),function(){switch(_name){case"new_nsx":case"type_s":;}}();function loop(){let fpsAdjust=_fpsAdjust,penalty=1-_penalty.value;if(_this.flag("braking"))_acceleration-=.008*_config.getNumber("braking")*Render.HZ_MULTIPLIER*_allowedSpeed*fpsAdjust;else{let gearRange2=_config.get("gearRange2"),speedRange=_config.get("speedLineRange"),lineRange=_lineRange=Math.range(_collision.visualLineDistance,1+speedRange[0],speedRange[1],1,0,!0);isNaN(lineRange)&&(_lineRange=lineRange=1);let speedCurve=1-Math.pow(Math.interpolate(0,1,_acceleration,_gearCurve),Math.mix(gearRange2[0],gearRange2[1],1-Math.interpolate(0,gearRange2[2],_acceleration,_gearCurve))),lineMultiplier=1;(_acceleration+=.004*_config.getNumber("accel")*lineMultiplier*Render.HZ_MULTIPLIER*penalty*speedCurve*_allowedSpeed*fpsAdjust)>.8&&(_acceleration-=.002*_collision.incline*Render.HZ_MULTIPLIER*1*fpsAdjust);let field=_config.getField("lineDebug");field&&(field.value=Math.round(100*lineRange))}let isSteering=!1,steerBrakeStrength=Math.range(Date.now()-_steerTime,0,_config.getNumber("steeringBrakeTime"),1,_config.getNumber("steeringBrakeStrength")),brakeSteerMult=_this.flag("braking")&&_config.getNumber("brakeSteerMult")||1;_this.flag("left")&&(_acceleration>.1?(isSteering=!0,_acceleration>.1&&(_acceleration-=.002*_config.getNumber("steeringSlow")*steerBrakeStrength*Render.HZ_MULTIPLIER*fpsAdjust),_steering.y+=.025*_config.getNumber("steering")*Render.HZ_MULTIPLIER*_allowedSpeed*1*brakeSteerMult*fpsAdjust):_this.flag("left",!1)),_this.flag("right")&&(_acceleration>.1?(isSteering=!0,_acceleration>.1&&(_acceleration-=.002*_config.getNumber("steeringSlow")*steerBrakeStrength*Render.HZ_MULTIPLIER*fpsAdjust),_steering.y-=.025*_config.getNumber("steering")*Render.HZ_MULTIPLIER*_allowedSpeed*1*brakeSteerMult*fpsAdjust):_this.flag("right",!1)),_acceleration=Math.clamp(_acceleration,0,1),_this.parent.state.set("acceleration",_acceleration),_this.parent.state.set("drifting",isSteering&&_config.getNumber("steeringDrift")>0),_gearValue=Math.min(Math.range(_acceleration,0,1,1,_config.getNumber("gears")+2)-1,_config.getNumber("gears"));let newGear=Math.floor(_gearValue);newGear!=_gear&&(newGear>_gear&&_car.changeGear(),_gear=newGear,_this.parent.state.set("gear",_gear)),_this.parent.state.set("rpm",_gearValue-_gear||(_acceleration>.01?1:0)),_this.parent.state.set("acceleration",_acceleration),_force=Math.lerp(_acceleration,_force,.07*fpsAdjust),_steeringQuaternion.slerp(_car.group.quaternion,Math.range(_config.getNumber("steeringDrift"),1,10,1,.01,!0)),_prev.copy(_car.group.position),_car.group.position.add(_forward.set(0,0,1).multiplyScalar(.1*_config.getNumber("topSpeed")*_force*penalty*Render.HZ_MULTIPLIER*_allowedSpeed*1*fpsAdjust).applyQuaternion(_steeringQuaternion)),_car.group.rotation.lerp(_steering,.07*_config.getNumber("steerSensitivity")*_allowedSpeed*1*fpsAdjust),_brakingPromise&&_force<.001&&_brakingPromise.resolve()}function update(){_this.parent.state.set("mph",Math.round(_acceleration*_config.getNumber("topSpeedMPH"))),_this.parent.state.set("line",_lineRange)}function left(e){0!=_allowedSpeed&&(_this.flag("left")||"down"!=e.type||(_steerTime=Date.now()),_this.flag("left","down"==e.type),_this.parent.state.set("left","down"==e.type),"down"==e.type&&_this.flag("right",!1))}function right(e){0!=_allowedSpeed&&(_this.flag("right")||"down"!=e.type||(_steerTime=Date.now()),_this.flag("right","down"==e.type),_this.parent.state.set("right","down"==e.type),"down"==e.type&&_this.flag("left",!1))}function brake(e){0!=_allowedSpeed&&(_this.flag("overrideBrake")||(_acceleration-=.04*_config.getNumber("braking"),_acceleration=Math.clamp(_acceleration,0,1),_car.brake="down"==e.type,_this.flag("braking","down"==e.type),_this.parent.state.set("braking","down"==e.type),e.type))}function wrapEuler(vec){for(;vec.y<0;)vec.y+=2*Math.PI;for(;vec.y>=2*Math.PI;)vec.y-=2*Math.PI}!function initConfig(){let name=`Controls_${_name}${_version}`;(_config=InputUIL.create(name)).addNumber("accel",1),_config.addNumber("topSpeed",1),_config.addNumber("steering",1),_config.addNumber("steerSensitivity",1),_config.addNumber("steeringSlow",1),_config.addNumber("steeringBrakeTime",250),_config.addNumber("steeringBrakeStrength",2),_config.addNumber("steeringDrift",1),_config.addNumber("braking",1),_config.addNumber("brakeSteerMult",1),_config.addNumber("roll",1),_config.addNumber("gears",5),_config.add("gearCurve","cubic-bezier(.4,.04,.85,.81)"),_config.addVector("gearRange2",[.03,.5,.5]),_config.addNumber("lineSlowMult",1),_config.addNumber("topSpeedMPH",140),_config.addNumber("cameraLerp",.2),_config.addNumber("cameraAdjust",1),_config.addNumber("cameraShake",1),_config.addVector("speedLineRange",[0,4]),_config.addNumber("collisionDeceleration",.75),_config.addNumber("collisionStep",1),_config.addNumber("powerupKick",0),_config.addVector("collisionDecelerationRange",[1,5]),_config.add("lineDebug",1),_this.config=_config,_gearCurve=`${_name}Gear`,TweenManager.addCustomEase({name:_gearCurve,curve:_config.get("gearCurve")||"cubic-bezier(0,.99,.93,1)"}),_this.parent.state.set("topSpeedMPH",_config.getNumber("topSpeedMPH")),_car.collisionStep=(isNaN(_config.get("collisionStep"))?1:_config.get("collisionStep"))/1e3}(),function addListeners(){_this.events.sub(GameplayControls.LEFT,left),_this.events.sub(GameplayControls.RIGHT,right),_this.events.sub(GameplayControls.BRAKE,brake)}(),_this.startRender(loop),_this.startRender(update,12),_car.controls=_this,_collision.controls=_this,_this.parent.state.set("gear",1),_this.parent.state.set("gears",_config.getNumber("gears")),_this.parent.state.bind("paused",value=>{1==value?_this.pause():_this.resume()}),this.applyCollisionForce=function(point,angle,distance,linePoint){let oaccel=_acceleration,decelerationRange=_config.get("collisionDecelerationRange");_acceleration/=Math.range(oaccel,0,.75,decelerationRange[0],decelerationRange[1]);let mult=.00325*(oaccel>.7&&_config.get("topSpeedMPH")>180?Math.range(oaccel,.7,1,1,5):1);if(_car.group.position.lerp(point,distance*mult),TweenManager.clearTween(_penalty),angle){_collisionRotation.copy(_steering),_collisionRotation.y=Math.radians(angle),Math.abs(_collisionRotation.y-_steering.y)>Math.PI&&(wrapEuler(_collisionRotation),wrapEuler(_steering),wrapEuler(_car.group.rotation));Math.range(oaccel,0,.75,.25,1,!0);_steering.lerp(_collisionRotation,.85*(1-_acceleration))}_this.parent.state.set("collision",1),_this.delayedCall(_=>_this.parent.state.set("collision",0),100)},this.pause=function(){_this.stopRender(loop),_allowedSpeed=0,_this.parent.state.set("paused",!0)},this.resume=function(){_this.startRender(loop),_allowedSpeed=1,_this.parent.state.set("paused",!1),_this.flag("braking",!1),_this.flag("left",!1),_this.flag("right",!1),ControlUtil.reset()},this.stop=function(){_allowedSpeed=0,_this.parent.state.set("started",!1)},this.start=function(){_this.flag("braking",!1),_this.flag("left",!1),_this.flag("right",!1),ControlUtil.reset(),_steeringQuaternion.set(0,0,0,1),_car.group.quaternion.set(0,0,0,1),_force=0,_steering.y=0,_acceleration=.15,_allowedSpeed=1,_this.startRender(loop),_this.parent.state.set("started",!0)},this.get("acceleration",_=>_force),this.get("roll",_=>_config.getNumber("roll")*_allowedSpeed),this.setPositionAndLookAt=function(pos,rotation){_car.group.position.copy(pos),_steering.y=Math.radians(90),_car.group.rotation.copy(_steering)},this.brakeToStop=async function(){_brakingPromise=Promise.create(),_this.flag("overrideBrake",!0),_this.flag("braking",!0),await _brakingPromise,_brakingPromise=null,_this.flag("braking",!1),_this.flag("overrideBrake",!1),_allowedSpeed=0},this.reset=async function(){_this.flag("hasReset")||await _car.ready(),_this.flag("hasReset",!0),_this.stopRender(loop),_car.brake=!1,_car.steering=0,_car.wheelRotation=0,_allowedSpeed=0,_steering.y=0,_force=0,_acceleration=0,_car.group.position.set(0,0,-_car.nose.position.z),_car.group.rotation.set(0,0,0),_prev.copy(_car.group.position),_this.flag("braking",!1),_this.flag("left",!1),_this.flag("right",!1),ControlUtil.reset(),_this.parent.state.set("acceleration",0)},this.powerup=function(){_acceleration+=_config.getNumber("powerupKick")||0,_this.parent.camera.powerup(_config.getNumber("powerupKick")||0)},this.get("fpsAdjust",_=>_fpsAdjust)}),_=>{GameplayControls.LEFT="controls_left",GameplayControls.RIGHT="controls_right",GameplayControls.BRAKE="controls_brake"}),Class((function GameplaySound(_name,_gameplay){Inherit(this,Component);const _this=this;var _throttling=!1,_lastAcceleration=0,turningLeft=!1,turningRight=!1;function handleDrifting(drifting){AudioController.instance().isDrifting(drifting)}function handleTutorial(action){switch(action){case"begin":AudioController.instance().initRace(_name),AudioController.instance().raceStart(!0)}}function handleCountdown(time){AudioController.instance().countDown(time)}function onAcceleration(_acceleration){let _accelerationRounded=Math.round(100*_acceleration)/100;_lastAcceleration>_accelerationRounded&&_throttling?(AudioController.instance().changeAcceleration("braking",_accelerationRounded),_throttling=!1):_lastAcceleration<_accelerationRounded&&!_throttling&&(AudioController.instance().changeAcceleration("throttling",_accelerationRounded),_throttling=!0),AudioController.instance().onAcceleration(_acceleration),_lastAcceleration=_accelerationRounded}function handleRestart(e){}function handleRpm(rpm){AudioController.instance().setRpm(rpm)}function handleMph(mph){AudioController.instance().setMph(mph)}function handleBraking(braking){AudioController.instance().handleBraking(braking)}function handleLeft(left){(turningLeft=left)||turningRight?AudioController.instance().turning(!0):turningLeft||turningRight||AudioController.instance().turning(!1)}function handleRight(right){turningRight=right,turningLeft||turningRight?AudioController.instance().turning(!0):turningLeft||turningRight||AudioController.instance().turning(!1)}function onCollision(v){1==v&&AudioController.instance().onCollision()}function onGearChange(_gear){AudioController.instance().changeGear(_gear)}function handleStartStop(started){}function handlePause(paused){paused?AudioController.instance().onPause():AudioController.instance().onResume()}function handleResults(passed){console.log(passed),AudioController.instance().handleResults(passed)}!function(){if(Global.PLAYGROUND)return;_gameplay.state.bind("rpm",handleRpm),_gameplay.state.bind("gear",onGearChange),_gameplay.state.bind("mph",handleMph),_gameplay.state.bind("collision",onCollision),_gameplay.state.bind("acceleration",onAcceleration),_gameplay.state.bind("started",handleStartStop),_gameplay.state.bind("paused",handlePause),_gameplay.state.bind("braking",handleBraking),_gameplay.state.bind("left",handleLeft),_gameplay.state.bind("right",handleRight),_gameplay.state.bind("tutorial",handleTutorial),_gameplay.state.bind("countdown",handleCountdown),_gameplay.state.bind("drifting",handleDrifting),_gameplay.state.bind("results_audio",handleResults),_gameplay.state.bind("restart",handleRestart);let maxGear=_gameplay.state.get("gears"),topSpeedMPH=_gameplay.state.get("topSpeedMPH");AudioController.instance().maxGear(maxGear),AudioController.instance().topMph(topSpeedMPH),AudioController.instance().startCar(_name),_this.events.sub(GameplayPowerups.TRIGGER,_=>{AudioController.instance().powerUp(_)}),_this.events.sub(GameplayCheckpoints.TRIGGER,index=>{AudioController.instance().checkPoint(index)}),_this.events.sub(Gameplay.RESULT,({success:success})=>{console.log(success),AudioController.instance().finishRace(success)}),_this.events.sub(Gameplay.START,()=>{"Gameplay"!=Global.PLAYGROUND&&AudioController.instance().raceStart(!1)}),AudioController.instance().initRace(_name)}(),this.loaded=function(sync){return AudioController.instance().preload(_name)}})),Class((function GameplayTimer(_name,_collision){Inherit(this,Component);const _this=this;this.lap=0,this.lapTimes=[];var _completed=0,_time=0;function loop(tsl,dt){_collision.linePercent>_completed&&_collision.linePercent-_completed<.1&&(_completed=_collision.linePercent),_time+=dt,_completed>=.995&&(_this.lap++,_completed=0,_this.lapTimes.push(_time),_this.events.fire(Events.COMPLETE,{lap:_this.lap}))}function update(){_this.parent.state.set("lapTimeUnformatted",_time)}function update2(){_this.parent.state.set("lapTime",function format(time){return(_time/1e3).toFixed(2)}())}_this.parent.state.set("lapTime",0),_this.parent.state.bind("paused",value=>{1==value?_this.pause():_this.resume()}),this.start=this.resume=function(){_this.startRender(loop),_this.startRender(update,24),_this.startRender(update2,17)},this.stop=this.pause=function(){_this.stopRender(loop),_this.stopRender(update),_this.stopRender(update2)},this.reset=function(){_this.lap=0,_this.lapTimes.length=0,_time=0,_completed=0}})),Class((function GameplayCarGhost(_name,_data,_totalTime){Inherit(this,FXScene);const _this=this;var _view,_fps,_frames,_betweenTime=0,_updateTime=0,_frame=0,_target=new Group,_target2=new Group,_target3=new Group;function loop(tsl,dt){let playPercent=_updateTime/1e3/_totalTime,f0=Math.round(playPercent*_frames);f0!=_frame&&(_betweenTime=0,_frame=f0);let f1=f0+1;if(!_data[7*f1])return _view.visible=!1;_target.position.set(Number(_data[7*f0+0]),Number(_data[7*f0+1]),Number(_data[7*f0+2])),_target.quaternion.set(Number(_data[7*f0+3]),Number(_data[7*f0+4]),Number(_data[7*f0+5]),Number(_data[7*f0+6])),_target2.position.set(Number(_data[7*f1+0]),Number(_data[7*f1+1]),Number(_data[7*f1+2])),_target2.quaternion.set(Number(_data[7*f1+3]),Number(_data[7*f1+4]),Number(_data[7*f1+5]),Number(_data[7*f1+6]));let a=Math.range(_betweenTime,0,1e3/_fps,0,1,!0);_target3.position.lerp(_target.position,.1).lerp(_target2.position,a),_target3.quaternion.copy(_target.quaternion).slerp(_target2.quaternion,a),_this.group.position.lerp(_target3.position,.2),_this.group.quaternion.slerp(_target3.quaternion,.2),_betweenTime+=dt,_updateTime+=dt,_view.wheelRotation-=.6}function start(){_updateTime=0,_view.visible=!0,_this.startRender(loop)}this.group=new Group,function(){_frames=_data.length/7,_fps=1e3/24,_totalTime/=1e3,_totalTime+=1,_this.create(_this.findParent("Gameplay").nuke),_this.startRender(_=>_this.render()),_this.setDPR(1),defer(_=>{_this.scene.add(_this.group)}),_view=CarManager.instance().getGhostCar(_name),_this.group.add(_view.group),function addListeners(){_this.events.sub(Gameplay.START,start)}(),_view.visible=!1,_view.ready().then(_=>{_view.visible=!0;let shader=_this.initClass(Shader,"GhostNormal");_view.group.traverse(obj=>{obj.shader&&obj.shader.visible&&(shader.uniforms.tNormal||shader.addUniforms({tNormal:obj.shader.uniforms.tNormal}),obj.shader=shader),obj.castShadow=!1})});_this.group.position.set(Number(_data[0]),Number(_data[1]),Number(_data[2])),_this.group.quaternion.set(Number(_data[3]),Number(_data[4]),Number(_data[5]),Number(_data[6])),_this.findParent("Gameplay").vfx.registerGhost(_this)}(),this.pause=function(){_this.stopRender(loop)},this.resume=function(){_this.startRender(loop)}})),Class((function GameplayCarRecorder(_name,_player){Inherit(this,Component);const _this=this;var _recording=[],_checkpoints=[],_frames=0;function capture(){let p=_player.group.position,q=_player.group.getWorldQuaternion();_recording.push(p.x.toFixed(4),p.y.toFixed(4),p.z.toFixed(4),q.x.toFixed(4),q.y.toFixed(4),q.z.toFixed(4),q.w.toFixed(4)),_frames++}function checkPoint({index:index}){let time=_this.parent.parent.state.get("lapTimeUnformatted");_checkpoints.push(time)}function start(e){_this.startRender(capture,24)}function end(){_this.delayedCall(_=>{_this.stopRender(capture),Data.tracks[_name].saveGhost(_recording,_checkpoints,_frames,_this.findParent("Gameplay").controls.flag("gotFPSBoost")),_recording.length=0,_checkpoints.length=0},1e3)}!function addListeners(){_this.events.sub(Gameplay.START,start),_this.events.sub(Gameplay.END,end),_this.events.sub(GameplayCheckpoints.TRIGGER,checkPoint)}(),this.pause=function(){_this.stopRender(capture,24)},this.resume=function(){_this.startRender(capture,24)},this.reset=function(){_this.stopRender(capture),_recording.length=0,_checkpoints.length=0,_frames=0}})),Class((function GameplayCarRemoteGhost(_name,_id){Inherit(this,FXScene),Inherit(this,PhysicalLink,_id);const _this=this;var _view;this.group=new Group,_this.create(_this.findParent("Gameplay").nuke),_this.setDPR(1),defer(_=>{_this.scene.add(_this.group)}),_view=CarManager.instance().getGhostCar(_name),_this.group.add(_view.group),_view.visible=!1,_view.ready().then(_=>{_this.delayedCall(_=>{_view.visible=!0},1e3);let shader=_this.initClass(Shader,"GhostNormal");_view.group.traverse(obj=>{obj.shader&&obj.shader.visible&&(shader.uniforms.tNormal||shader.addUniforms({tNormal:obj.shader.uniforms.tNormal}),obj.shader=shader),obj.castShadow=!1})}),_this.findParent("Gameplay").vfx.registerGhost(_this),_this.bindLink(_this.group,"car"),_this.startRender(_=>{_view.wheelRotation-=.6,_this.render()}),this.hide=function(){_view.visible=!1},this.onDisconnect=function(){}})),Class((function GameplayCars(_name){Inherit(this,Object3D);const _this=this;function onRemoteConnection(e){_this.remoteGhost=_this.initClass(GameplayCarRemoteGhost,_name,e.id)}!async function(){_this.player=_this.initClass(GameplayCarsPlayer,_name),_this.recorder=_this.initClass(GameplayCarRecorder,_name,_this.player);let ghost=await Data.getGhost();ghost&&(_this.ghost=_this.initClass(GameplayCarGhost,_name,ghost.data,ghost.score)),_this.events.sub(PhysicalSync.CONNECTION,onRemoteConnection),_this.parent.state.bind("paused",value=>{1==value?_this.pause():_this.resume()})}(),this.loaded=function(){return _this.player.car.loaded()},this.pause=function(){_this.player.pause(),_this.recorder.pause(),_this.ghost&&_this.ghost.pause()},this.resume=function(){_this.player.resume(),_this.recorder.resume(),_this.ghost&&_this.ghost.resume()},this.restart=async function(){_this.recorder.reset();try{_this.ghost&&_this.ghost.destroy(),_this.remoteGhost&&_this.remoteGhost.destroy()}catch(e){}let ghost=await Data.getGhost();ghost&&(_this.ghost=_this.initClass(GameplayCarGhost,_name,ghost.data,ghost.score))}})),Class((function GameplayCarsPlayer(_name){Inherit(this,Object3D),Inherit(this,PhysicalLink);const _this=this;var _proxy,_controls,_config,_gameplay,_lastAcceleration=0,_accelerating=0,_gear={value:0},_envDirection=new Vector3;function loop(){let deltaAcceleration=_controls.acceleration-_lastAcceleration;_lastAcceleration=_controls.acceleration,Math.sign(deltaAcceleration)<0?deltaAcceleration>-1e-4&&(deltaAcceleration=0):deltaAcceleration<1e-4&&(deltaAcceleration=0);let lift=0;Math.sign(deltaAcceleration)<0?(_accelerating=0,lift=Math.range(100*deltaAcceleration,-1,-.8,1,0,!0)*Math.radians(2)):(lift=Math.range(100*deltaAcceleration,-.3,.3,1,-1,!0)*Math.radians(2),lift*=Math.range(_accelerating++,60,120,1,0,!0)),lift+=_gear.value,_gameplay.state.set("deltaAcceleration",deltaAcceleration),_proxy.car.lift=Math.lerp(lift,_proxy.car.lift,.07),_proxy.car.wheelRotation-=1.5*_controls.acceleration*Render.HZ_MULTIPLIER;let roll=0,steer=0;_controls.flag("left")?(steer=Math.radians(20),roll=Math.radians(4)*_controls.roll):_controls.flag("right")&&(steer=Math.radians(-20),roll=Math.radians(-4)*_controls.roll),roll*=_controls.acceleration,_proxy.car.roll=Math.lerp(roll,_proxy.car.roll,.07),_proxy.car.steering=Math.lerp(steer,_proxy.car.steering,.1),_envDirection.x=-1,_envDirection.y=Math.degrees(_this.group.rotation.y)%360*.0025,_proxy.car.setEnvRotationSpeed(_envDirection,_controls.acceleration)}!async function(){_proxy=CarManager.instance().getCarProxy(_name,_this),_this.add(_proxy.group),_this.car=_proxy.car,await _proxy.car.ready(),_this.startRender(loop),_gameplay=_this.findParent("Gameplay"),async function initConfig(){(_config=InputUIL.create(`${_name}_car_env_config`)).setLabel("Environment"),_config.addImage("tEnvDiffuse"),_config.addImage("tEnvSpecular"),_config.addImage("tLightmap");let diffuse=_config.getImage("tEnvDiffuse")||"assets/images/_scenelayout/mask.jpg",specular=_config.getImage("tEnvSpecular")||"assets/images/_scenelayout/mask.jpg",lightmap=_config.getImage("tLightmap")||"assets/images/_scenelayout/mask.jpg",layers=await _proxy.car.getLayers();_this.initClass(CarEnvOverrides,_name,layers,"gameplay"),layers.forEach(l=>{l.shader.addUniforms({tEnvDiffuse:{value:Utils3D.getRepeatTexture(diffuse)},tEnvSpecular:{value:Utils3D.getRepeatTexture(specular)},tLightmap:{value:Utils3D.getRepeatTexture(lightmap)}})})}(),_gameplay.vfx.setupCar(_proxy.car),_this.bindLink(_this.group,"car")}(),this.ready=async function(){await _proxy.car.ready(),await _this.wait(250)},this.changeGear=function(){_gear.value=-.035,tween(_gear,{value:0},250,"easeOutSine")},this.pause=function(){_this.stopRender(loop)},this.resume=function(){_this.startRender(loop)},this.get("center",_=>_proxy.car.center),this.get("nose",_=>_proxy.car.nose),this.get("bounding",_=>_proxy.car.bounding.vectors),this.get("boundingBox",_=>_proxy.car.bounding),this.get("collisionStep",_=>_proxy.car.collisionStep),this.set("controls",c=>_controls=c),this.set("brake",c=>_proxy.car.brake=c),this.set("collisionStep",c=>_proxy.car.collisionStep=c)})),Class((function ChevronCheckpoint(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null},uRotSpeed:{value:.5},uAlpha:{value:1},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color},uFogRange:{value:new Vector2},uFogColor:{value:new Color}})})),Class((function FogCheckpoint(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogRange:{value:new Vector2},uFogColor:{value:new Color},tMap:{value:null},uTint:{value:new Color}})})),Class((function GameplayCheckpoint(_name=Utils.query("name")){var _layout;Inherit(this,Object3D),_layout=this.initClass(SceneLayout,"gameplay_checkpoint_"+_name,{noGraph:"GameplayCheckpoint"!=Global.PLAYGROUND}),this.trigger=async function(){if(_layout.exists("animation")){(await _layout.getLayer("animation")).trigger()}}})),Class((function GameplayCheckpoints(_name,_track){Inherit(this,Object3D);const _this=this;var _curve,_config,_car,_list=new LinkedList,_box=new Box3;function createAt(r,i){let pos=_curve.getPoint(r),lookAt=_curve.getPoint(r-.01),mesh=new Mesh(World.PLANE,Utils3D.getTestShader());mesh.scale.set(20,20,20),mesh.shader.side=Shader.DOUBLE_SIDE,mesh.position.copy(pos),mesh.lookAt(lookAt),mesh.updateMatrixWorld(!0),mesh.plane=(new Box3).setFromObject(mesh),mesh.index=i,mesh.visual=_this.initClass(GameplayCheckpoint,_name),mesh.visual.group.position.copy(pos),mesh.visual.group.quaternion.copy(mesh.quaternion),_list.push(mesh)}function loop(){if(_this.flag("tutorial"))return;let p=_list.start();for(;p;)p.triggered||(_box.setFromObject(_car.boundingBox.mesh),p.plane.intersectsBox(_box)&&(p.triggered=!0,_this.events.fire(GameplayCheckpoints.TRIGGER,{index:p.index}),p.visual.trigger())),p=_list.next()}!async function(){!function initConfig(){(_config=InputUIL.create("checkpoints_"+_name)).setLabel("Checkpoints"),_config.add("count",5),_config.add("padding",.2)}();let line=await _track.getLine();_curve=await line.getCurve(),_car=_this.parent.cars.player,await _this.wait(_car,"boundingBox"),await _this.wait(_car.boundingBox,"mesh"),await function initPlacement(){let padding=_config.getNumber("padding"),count=_config.getNumber("count"),step=(1-2*padding)/(count-1),r=padding;for(let i=0;i<count;i++)createAt(1-r,i),r+=step}(),_this.flag("initialized",!0),_this.startRender(loop,30)}(),this.loaded=function(){return _this.wait("initialized")},this.startTutorial=function(){_this.flag("tutorial",!0)},this.reset=function(){_this.flag("tutorial",!1);let p=_list.start();for(;p;)p.triggered=!1,p=_list.next()}}),_=>{GameplayCheckpoints.TRIGGER="checkpoint_trigger"}),Class((function GameplayEnvironment(_name){Inherit(this,Object3D);const _this=this;var _layout;!function(){_layout=_this.initClass(SceneLayout,`gameplay_env_${_name}`);let sky=_this.initClass(GameplayEnvironmentSky,_name);sky.mesh&&_this.add(sky.mesh),_this.sky=sky,_this.layout=_layout}(),this.loaded=async function(sync){await _this.sky.loaded(sync),await Initializer3D.detectUploadAll(_layout,sync);for(let key in _layout.layers){let layer=_layout.layers[key];layer.uploadSync&&(sync?await layer.uploadSync():await layer.upload())}}})),Class((function GameplayEnvironmentSky(_name){Inherit(this,FXScene);const _this=this;var _camera,_sceneCamera,_gameplay;function loop(){_camera.quaternion.copy(_sceneCamera.quaternion),_camera.far=2e3,_camera.fov=_gameplay.camera.fov,_camera.aspect=Stage.width/Stage.height,_camera.updateProjectionMatrix(),_this.render()}!async function(){let nuke=_this.findParent("Gameplay").nuke;_this.create(nuke),_sceneCamera=_this.nuke.camera,_camera=_this.nuke.camera.clone();let gameplay=_gameplay=_this.findParent("Gameplay");_this.startRender(loop,gameplay.worldCamera),_camera.position.set(0,0,0),_this.useCamera(_camera);let layout=_this.initClass(SceneLayout,`gameplay_env_sky_${_name}`);_this.scene.add(layout.group),_this.layout=layout,Utils.query("capture")?_this.parent.group.add(layout.group):function initMesh(){let shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:_this},depthWrite:!1});_this.mesh=new Mesh(World.QUAD,shader),_this.mesh.renderOrder=-1,_this.mesh.frustumCulled=!1}(),await layout.ready()}(),this.get("camera",_=>_camera),this.loaded=function(sync){return Initializer3D.detectUploadAll(_this.layout,sync)}})),Class((function GameplayMultiplayer(_gameplay,_name){Inherit(this,Component);const _this=this,IDLE=3e4;var _roomID,_room=null,_version=1;async function initRoom(){if(null!==_room)return _room;!function initRoomID(){_roomID=`${_name}${_version}${MultiplayerSession.ROOM}${Hydra.LOCAL&&Utils.query("dev")?"dev":""}`}(),_room=await GameCenter.findRoom(_roomID,2),Global.ROOM=_room,MultiplayerSession.INTENT=!1,MultiplayerSession.FINISH_TIME=null,_this.events.sub(_room,GameCenterRoom.PLAYER_JOIN,playerJoin),_this.events.sub(_room,GameCenterRoom.PLAYER_DISCONNECT,playerDisconnect),_this.events.sub(_room,GameCenter.DATA,gameData),PhysicalSync.useRoom(_room),PhysicalSync.transmitFPS=60,PhysicalSync.baseLerp=.085,_this.flag("remoteFinishTime",!1),_this.flag("localFinishTime",!1),console.log(_room.id)}function fireStart(offset=0){_this.delayedCall(_=>{_this.flag("canStart",!0)},2e3-offset)}function onVisibility({type:type}){switch(type){case"blur":clearTimeout(_this.blurTimer),Global.ONLINE&&(_this.blurTimer=setTimeout(idleDisconnect,IDLE));break;case"focus":clearTimeout(_this.blurTimer)}}function idleDisconnect(){Global.ONLINE=!1,_this.events.fire(GameplayMultiplayer.ONLINE),ViewController.instance().exitGame()}function finishRace({time:time}){_this.flag("localFinishTime",time),_room&&_room.broadcast&&_room.broadcast({finished:!0,time:time}),"1v1"!==MultiplayerSession.TYPE&&_this.delayedCall(_this.disconnect,3e3)}function onlineToggle(e){Global.ONLINE?_room||initRoom():(_room&&_room.leave&&_room.leave(),PhysicalSync.useRoom(null),_this.flag("canStart",!0),_gameplay.cars.remoteGhost&&_gameplay.cars.remoteGhost.hide&&_gameplay.cars.remoteGhost.hide())}function playerJoin(){_room.players.length>1&&_room.host&&(_room.start(),console.log(_room.players),_room.players.forEach(async player=>{if(!player.me){console.log("awaiting other player connected");let timeout=Promise.create();_this.timeoutConnection=_this.delayedCall(_=>{console.log("timer resolved"),timeout.resolve()},1e4),await Promise.race([player.connected(),timeout]),clearTimeout(_this.timeoutConnection),_room&&_room.broadcast&&_room.broadcast({start:!0}),fireStart()}}))}function onIntent({action:action}){MultiplayerSession.HOST&&"random"!==MultiplayerSession.TYPE&&("replay"===action?MultiplayerSession.STEP++:MultiplayerSession.STEP=0,console.log(action,MultiplayerSession.STEP),_room&&_room.broadcast&&_room.broadcast({intent:action}),_room&&_room.leave&&_room.leave())}function onReconnect(){_this.flag("needsReconnect",!0)}function playerDisconnect(){_this.flag("canStart",!1)}function gameData(e){if(e.data.finished)if(_this.flag("remoteFinishTime",e.data.time),"1v1"!==MultiplayerSession.TYPE)_this.delayedCall(_this.disconnect,3e3);else{let time=Math.min(e.data.time,parseFloat(_gameplay.state.get("lapTime")));MultiplayerSession.FINISH_TIME=time}if(e.data.start&&(console.log(e.player.ping),fireStart(e.player.ping)),e.data.intent){console.log(e.data.intent);let intent=e.data.intent;MultiplayerSession.INTENT=intent,"replay"===intent?MultiplayerSession.STEP++:MultiplayerSession.STEP=0,console.log(intent,MultiplayerSession.STEP),_room&&_room.leave&&_room.leave()}}!async function(){await defer(),function addListeners(){_this.events.sub(Events.VISIBILITY,onVisibility),_this.events.sub(GameplayMultiplayer.ONLINE,onlineToggle),_this.events.sub(GameplayMultiplayer.RECONNECT,onReconnect),_this.events.sub(GameplayMultiplayer.INTENT,onIntent),_this.events.sub(Gameplay.END,finishRace)}(),Dev.expose("multiplayer",_this)}(),this.ready=async function(){return await _this.wait("canStart"),"ready"},this.reconnect=async function(){return await _this.wait("needsReconnect"),"reconnect"},this.connect=function(){if(Global.ONLINE)return initRoom()},this.disconnect=async function(){_this.flag("canStart",!1),_this.flag("needsReconnect",!1),Global.ONLINE&&(_room&&_room.leave&&(_room=_room.leave()),_room=null,PhysicalSync.useRoom(null),await _this.wait(1500))},this.restart=async function(){if(await _this.disconnect(),Global.ONLINE)return initRoom()},this.localWinner=function(){let remote=_this.flag("remoteFinishTime"),local=_this.flag("localFinishTime");return console.log(local,remote),!1===remote||local<remote},this.isHost=function(){if(_room)return _room.host},this.sendInstructions=function(data={}){_room.broadcast({instructions:data})},this.onDestroy=function(){_room&&(_room.leave&&_room.leave(),PhysicalSync.useRoom(null))},this.get("room",_=>_room)}),_=>{GameplayMultiplayer.ONLINE="gm_online",GameplayMultiplayer.RECONNECT="gm_reconnect",GameplayMultiplayer.INTENT="gm_intent"}),Class((function GameplayPowerup(_name=Utils.query("name")){Inherit(this,Object3D);const _this=this;var _arrows;this.name=_name,async function(){let layout=_this.initClass(SceneLayout,"gameplay_powerup",{noGraph:"GameplayPowerup"!=Global.PLAYGROUND});(_arrows=await layout.getLayer("arrows")).originalColor=_arrows.shader.get("uColor").clone()}(),this.trigger=function(){_arrows.shader.set("uColor",new Color("#ffffff"))},this.reset=function(){_arrows.shader.set("uColor",_arrows.originalColor)}})),Class((function GameplayPowerups(_name,_track){Inherit(this,Object3D);const _this=this;var _curve,_config,_car,_list=new LinkedList,_box=new Box3;function loop(){if(_this.flag("tutorial"))return;let p=_list.start();for(;p;)p.triggered||(_box.setFromObject(_car.boundingBox.mesh),p.plane.intersectsBox(_box)&&(p.triggered=!0,_this.findParent("Gameplay").controls.powerup(),p.visual.trigger(),_this.events.fire(GameplayPowerups.TRIGGER))),p=_list.next()}!async function(){!function initConfig(){(_config=InputUIL.create("powerups_"+_name)).setLabel("Powerups"),_config.add("placement","")}();let line=await _track.getLine();_curve=await line.getCurve(),_car=_this.parent.cars.player,await _this.wait(_car,"boundingBox"),await _this.wait(_car.boundingBox,"mesh"),await function initPlacement(){JSON.parse("["+(_config.get("placement")||"")+"]").forEach((r,i)=>{!function createAt(r,i){let pos=_curve.getPoint(r),lookAt=_curve.getPoint(r-.001),mesh=new Mesh(World.BOX,Utils3D.getTestShader());mesh.scale.set(4,12,3),mesh.shader.side=Shader.DOUBLE_SIDE,mesh.position.copy(pos),mesh.lookAt(lookAt),mesh.updateMatrixWorld(!0),mesh.plane=(new Box3).setFromObject(mesh),mesh.index=i,mesh.visual=_this.initClass(GameplayPowerup,_name),mesh.visual.group.position.copy(pos),mesh.visual.group.quaternion.copy(mesh.quaternion),_this.add(mesh.visual.group),_list.push(mesh)}(1-r,i)})}(),_this.flag("initialized",!0),_this.startRender(loop,30)}(),this.loaded=async function(sync){return await _this.wait("initialized"),Initializer3D.detectUploadAll(_this.group,sync)},this.startTutorial=function(){_this.flag("tutorial",!0),_this.group.visible=!1},this.reset=function(){_this.group.visible=!0,_this.flag("tutorial",!1);let p=_list.start();for(;p;)p.triggered=!1,p.visual.reset(),p=_list.next()}}),_=>{GameplayPowerups.TRIGGER="powerup_trigger"}),Class((function PowerupShader(_mesh,_shader,_group){const _this=this;!function(){_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uScaleY:{value:1},uTimeScale:{value:1},uAlpha:{value:1},uColor:{value:new Color,ignoreUIL:!0}});let config=InputUIL.create("powerup_config"+_this.parent.parent.name,_group);config.setLabel("Override"),config.addColor("color",new Color("#ffffff")),config.addNumber("alpha",1),config.onUpdate=_=>{_shader.get("uColor").set(config.get("color")),_shader.set("uAlpha",config.get("alpha"))},config.onUpdate()}()})),Class((function GameplayState(_name,_controls,_timer,_cars,_gameplay){Inherit(this,Component);const _this=this;var _tutorial,_countdown,_config,_finish,_pause;async function init(){_gameplay.track.racingLine.hide();let doneTutorial=await UserStorage.get("tutorial");(Utils.query("show_tutorial")||Utils.query("testIntro"))&&(doneTutorial=!1),doneTutorial?beginCountdown():(UserStorage.set("tutorial",!0),beginTutorial(),console.log("do the tutorial"))}async function beginCountdown(){Global.ONLINE&&await async function awaitOnline(){switch(MultiplayerSession.TYPE){case null:ViewController.instance().showMultiplayer("select");break;case"random":ViewController.instance().showMultiplayer("connecting");break;case"1v1":ViewController.instance().showMultiplayer("1v1")}console.log("awaiting ready"),await MultiplayerSession.ready(),console.log("awaiting restart"),await _gameplay.multiplayer.restart(),await _this.wait(1e3);let quit=Promise.create();if(Global.ONLINE||quit.resolve(),console.log("awaiting ready or reconnect"),"ready"!==await Promise.race([_gameplay.multiplayer.ready(),_gameplay.multiplayer.reconnect(),quit])&&Global.ONLINE)return console.log("awaiting disconnect"),await _gameplay.multiplayer.disconnect(),console.log("resetting"),await awaitOnline();console.log("connection success"),ViewController.instance().hideMultiplayer()}(),_gameplay.track.racingLine.hide(),_gameplay.ui&&_gameplay.ui.hide(),_this.flag("paused",!1),_this.parent.state.set("totalLaps",_config.getNumber("laps")),_countdown&&await _countdown.play(),_gameplay.camera.reset(),_controls.start(),_timer.start();let name="Race",type="start";Global.ONLINE&&(name="1v1",type="race start"),Track.event(name,type,`level${Data.getTrackNumberByName(_name)}`),_gameplay.ui&&_gameplay.ui.show(),_this.events.fire(Gameplay.START),_gameplay.track.racingLine.displayNormal(1e3),Track.page(`/game/level${Data.getTrackNumberByName(_name)}`),_this.flag("playing",!0)}async function beginTutorial(){_this.flag("playing",!1),_this.flag("paused",!1),_gameplay.powerups.startTutorial(),_gameplay.checkPoints.startTutorial(),await _tutorial.play(),await _controls.brakeToStop(),await _controls.reset(),_gameplay.camera.reset(),_gameplay.checkPoints.reset(),_gameplay.powerups.reset(),beginCountdown()}async function complete(){_this.flag("playing",!1),_this.flag("paused",!1);let time=parseFloat(_this.parent.state.get("lapTimeUnformatted"))/1e3,qualified=await async function setQualifiedState(finishTime){let time=null!==MultiplayerSession.FINISH_TIME?Math.min(MultiplayerSession.FINISH_TIME,finishTime):finishTime,ghost=await Data.getGhost(),qualified=await Data.tracks[_name].qualified(time,ghost),timeQualified=await Data.tracks[_name].qualified(time),previous=Config.TRACKS[Config.TRACKS.indexOf(_name)-1];previous&&!(await Data.tracks[previous].isUnlocked())||!timeQualified||await UserStorage.set(`track_${_name}_has_qualified`,!0);return qualified}(time);_this.events.fire(Gameplay.END,{qualified:qualified,time:time});let name="Race",type="complete";Global.ONLINE&&(name="1v1",type="race complete"),Track.event(name,type,`level${Data.getTrackNumberByName(_name)}`),_finish&&_finish.play(),_gameplay.ui&&_gameplay.ui.hide(),_this.wait(1e3).then(_=>{MultiplayerSession.WON=_gameplay.multiplayer.localWinner();let success=Global.ONLINE?MultiplayerSession.WON:qualified;_this.events.fire(Gameplay.RESULT,{success:success})}),await _controls.brakeToStop()}async function replay(tutorial=!1){_pause&&_pause.animateOut(),_this.parent.state.set("paused",!1),_this.flag("paused",!1),_this.parent.state.set("currentLap",0),UIConfig.resetBackground(),AudioController.instance().initRace(_name),_gameplay.cars.remoteGhost&&_gameplay.cars.remoteGhost.hide&&_gameplay.cars.remoteGhost.hide(),_gameplay.checkPoints.reset(),_gameplay.powerups.reset(),_timer.stop(),_timer.reset(),_cars.restart(),_gameplay.camera.reset(),_finish&&_finish.reset(),tutorial?beginTutorial():(_controls.reset(),beginCountdown())}function exitGame(){_this.flag("paused",!1),_gameplay.multiplayer.disconnect(),ViewController.instance().exitGame(),_pause.animateOut()}function pause(){_this.flag("playing")&&(_this.flag("paused")?(_this.flag("paused",!1),_this.parent.state.set("paused",!1),_this.parent.ui&&_this.parent.ui.show(),_pause&&_pause.animateOut()):(_this.flag("paused",!0),_this.parent.state.set("paused",!0),_this.parent.ui&&_this.parent.ui.hide(),_pause&&_pause.animateIn()))}function lapComplete({lap:lap}){_this.parent.state.set("currentLap",lap),_config.getNumber("laps")==lap&&complete()}function keypress(e){e.target&&"INPUT"==e.target.nodeName||("t"==e.key&&beginCountdown(),"T"==e.key&&beginTutorial(),"c"==e.key&&complete(),"r"==e.key&&replay(),"b"==e.key&&exitGame(),"p"==e.key&&pause())}_this.parent.state.set("currentLap",0),_controls.reset(),function initConfig(){(_config=InputUIL.create(`Config_${_name}`)).add("laps",1)}(),function initViews(){_tutorial=_this.initClass(GameplayStateTutorial,_name,_gameplay),_finish=_this.initClass(GameplayStateFinish,_name,_cars.player,_gameplay.camera),_countdown=_this.initClass(GameplayStateCountdown,_name),"Gameplay"!==Global.PLAYGROUND&&(_pause=_this.initClass(GameplayStatePauseUI,_name))}(),function addListeners(){_this.events.sub(_timer,Events.COMPLETE,lapComplete)}(),function addDebugListeners(){Tests.canUseShortcuts()&&_this.events.sub(KeyboardUtil.PRESS,keypress)}(),Global.PLAYGROUND?Device.mobile&&defer(_=>{_gameplay.loaded().then(beginCountdown)}):defer(_=>{Promise.all([ViewController.instance().canBeginGame(),_gameplay.loaded()]).then(init)}),this.get("isPlaying",_=>_this.flag("playing")&&!_this.flag("paused")),this.keypress=function(key){keypress({key:key})},this.replay=function(){replay()},this.playTutorial=function(){replay(!0)},this.pause=function(){pause()},this.exitGame=function(){exitGame()}})),Class((function GameplayStateCountdown(_name){Inherit(this,Object3D);const _this=this;var _ui,_track;"Gameplay"!=Global.PLAYGROUND&&(_ui=_this.initClass(GameplayStateCountdownUI,_name)),_track=_this.initClass(CameraTrack,"countdown0"),this.play=async function(){return _ui&&_ui.play(),_track.camera.lock(_this.findParent("Gameplay").worldCamera),_track.play(),_this.wait(3300)}})),Class((function GameplayStateFinish(_name,_car){Inherit(this,Object3D);const _this=this;var _camera,_inputUI,_resultsUI,_shareUI,_track;function loop(){_this.group&&_car.group&&(_this.group.position.lerp(_car.group.position,.2),_this.group.quaternion.slerp(_car.group.quaternion,.2),_this.group.updateMatrixWorld(!0))}async function onInputComplete({value:value}){_this.events.unsub(_inputUI,Events.COMPLETE,onInputComplete),await _resultsUI.play(),_inputUI.reset(),_this.events.sub(_resultsUI,Gameplay.SHARE,showShare)}function showShare({playerQualified:playerQualified}){_resultsUI.animateOut(),_shareUI.animateIn(playerQualified),_this.events.sub(_shareUI,Events.COMPLETE,hideShare)}function hideShare(){_this.events.unsub(_shareUI,Events.COMPLETE,hideShare),_shareUI.animateOut(),_resultsUI.animateIn()}!async function(){_track=_this.initClass(CameraTrack,"finishline"),_this.parent.parent.scene.add(_track.group),await _car.ready();let wrapper=new Group;wrapper.add(_track.camera.group),_this.group.add(wrapper),wrapper.position.z=_car.nose.position.z,(_camera=_this.initClass(GazeCamera)).useAccelerometer=!0,_camera.prefix="gameplay_finish_camera_test",CameraUIL.add(_camera).setLabel("Finish Camera"),_this.add(_camera.group),_camera.still(),"Gameplay"!==Global.PLAYGROUND&&(_inputUI=_this.initClass(GameplayStateFinishUI,_name,_this.parent),_resultsUI=_this.initClass(GameplayStateQualifiedUI,_name,_this.parent),_shareUI=_this.initClass(ShareUI,_name)),_this.startRender(loop)}(),this.play=async function(){await async function raceFinishAnimation(){let worldCamera=_this.findParent("Gameplay").worldCamera;_track.camera.lock(worldCamera),_track.play();let $top=$gl(Stage.width,.125*Stage.height,"#000000"),$bottom=$gl(Stage.width,.125*Stage.height,"#000000");$bottom.y=Stage.height,$top.y=-$top.height,GLUI.Stage.add($top),GLUI.Stage.add($bottom),tween($top,{y:0},2e3,"easeOutCubic"),tween($bottom,{y:Stage.height-$bottom.height},2e3,"easeOutCubic"),await _this.wait(2100),tween($top,{y:-Stage.height},500,"easeOutCubic"),tween($bottom,{y:Stage.height},500,"easeOutCubic").onComplete(_=>{$top.remove(),$bottom.remove()}),_camera.transition(5e3,"easeOutCubic",worldCamera),_this.delayedCall(_=>_camera.orbit(3e3),1500)}(),function showEndUI(){_inputUI&&(_inputUI.play(),_this.events.sub(_inputUI,Events.COMPLETE,onInputComplete))}()},this.reset=function(){_inputUI&&_resultsUI&&(ViewController.instance().hideLeaderboard(),_inputUI.reset(),_resultsUI.reset())}})),Class((function GameplayStateTutorial(_name,_gameplay){Inherit(this,Component);const _this=this;var _ui;Render.createTimeMultiplier();!async function(){"Gameplay"===Global.PLAYGROUND&&UIL.global||(_ui=_this.initClass(GameplayStateTutorialUI,_name)),await _gameplay.cars.player.ready()}(),this.play=async function(){_gameplay.controls.start(),_gameplay.track.racingLine.hide();_ui&&await _ui.animateIn(),_gameplay.state.set("tutorial","begin"),Track.event("Tutorial","step","begin"),_ui&&await _ui.showAccelerate(),await _this.wait(2e3),_ui&&await _ui.hideAccelerate(),await _this.wait(500),_gameplay.state.set("tutorial","steer"),Track.event("Tutorial","step","1"),_ui&&await _ui.showSteer(),await _this.wait(2e3),await function getSteer(){let promise=Promise.create(),steer=_=>{promise.resolve(),_this.events.unsub(GameplayControls.RIGHT,steer),_this.events.unsub(GameplayControls.LEFT,steer)};return _this.events.sub(GameplayControls.RIGHT,steer),_this.events.sub(GameplayControls.LEFT,steer),promise}(),_ui&&await _ui.hideSteer(),await _this.wait(3e3),_gameplay.track.racingLine.displayAll(),_gameplay.state.set("tutorial","line"),Track.event("Tutorial","step","2"),_ui&&await _ui.showLine(),await _this.wait(5e3),_ui&&await _ui.hideLine(),_gameplay.state.set("tutorial","brake"),Track.event("Tutorial","step","3"),_ui&&await _ui.showBrake(),await function getBrake(){let promise=Promise.create(),brake=_=>{promise.resolve(),_this.events.unsub(GameplayControls.BRAKE,brake)};return _this.events.sub(GameplayControls.BRAKE,brake),promise}(),_ui&&await _ui.hideBrake(),_ui&&await _ui.animateOut(),Track.event("Tutorial","step","complete"),_gameplay.state.set("tutorial","complete")}})),Class((function TestLayout(type,orientation,_data,_img,_colors,_pagename=null){Inherit(this,Object3D);const _this=this;let _layout;!async function(){!async function initLayout(){_this.layout=_layout=_this.initClass(StageLayout,"test_pat",{glui:!0}),_this.add(_this.layout.element.group)}()}()})),Class((function GameplayStateCountdownUI(_name=Utils.query("level_id")){Inherit(this,GLUIElement);const _this=this;var $this,_view;!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name?(defer(_=>_this.play()),World.RENDERER.setClearColor("#666666",1),GLUI.Stage.add($this)):($this.hide(),_this.wait(GLUI.Stage,"GameLayer").then(_=>{GLUI.Stage.GameLayer.add($this)}))}(),function initView(){let view="Debug";switch(_name){case"rdx":view="RDX";break;case"arx":view="ARX";break;case"integra":view="Integra";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:case"old_nsx":view="OldNSX"}view=`GameplayStateCountdown${view}`,_view=_this.initClass(window[view],_name)}(),this.play=async function(){await _view.ready(),await async function animateCountdown(){$this.show(),_view.element.show();let gameplay=_this.findParent("Gameplay");gameplay&&gameplay.state.set("countdown",3),_view.animate&&_view.animate("three"),await _this.wait(1100),gameplay&&gameplay.state.set("countdown",2),_view.animate&&_view.animate("two"),await _this.wait(1100),gameplay&&gameplay.state.set("countdown",1),_view.animate&&_view.animate("one"),await _this.wait(1100),gameplay&&gameplay.state.set("countdown",0),_view.animate&&_view.animate("go"),_view.element.hide(),$this.hide()}()},this.onDestroy=function(){$this.remove()}})),Class((function GameplayStateCountdownARX(_name){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("GameplayStateCountdownARX"),await function initLayers(){for(let id in _this.layers){let layer=_this.layers[id];"closed-course"!==id&&(layer.alpha=1e-5)}}()}(),this.animate=function(number){for(let id of["three","two","one"])id===number?_this.layers[id].show():_this.layers[id].hide();let layer=_this.layers[number];layer&&(layer.alpha=1e-5,layer.scale=.5,layer.y=layer.origin.y+40,tween(layer,{alpha:1,scale:1,y:layer.origin.y},500,"easeOutCubic",0).onComplete(_=>{tween(layer,{alpha:1e-5,scale:2,y:layer.origin.y-80},500,"easeInCubic",600)}))}})),Class((function GameplayStateCountdownDebug(_name){Inherit(this,GLUIElement);const _this=this;var $this,_layers;function resize(){numbers()}function numbers(){let[$three,$two,$one]=[_layers.three,_layers.two,_layers.one];for(let $number of[$three,$two,$one])$number.x=.5*(Stage.width-$number.dimensions.width),$number.y=.5*(Stage.height-$number.dimensions.height)}!async function(){!function initGL(){$this=_this.element,"GameplayStateCountdownDebug"!==Global.PLAYGROUND&&$this.hide()}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"GameplayStateCountdownDebug",{glui:!0}),_layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),await async function initLayers(){for(let id in _layers){_layers[id]}await Promise.all([])}(),function addHandlers(){_this.onResize(resize)}(),_this.flag("isReady",!0)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.play=async function(){$this.show();let[$three,$two,$one]=[_layers.three,_layers.two,_layers.one];for(let $layer of[$three,$two,$one])$layer.hide();$three.show(),defer(numbers),await _this.wait(500),$three.hide(),$two.show(),numbers(),await _this.wait(500),$two.hide(),$one.show(),numbers(),await _this.wait(500),$one.hide(),$this.hide()}})),Class((function GameplayStateCountdownIntegra(_name){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("GameplayStateCountdownIntegra"),await function initLayers(){for(let id in _this.layers){let layer=_this.layers[id];"closed-course"!==id&&(UIFigmaStyles.IntegraTitleText(layer),layer.alpha=1e-5)}}()}(),this.animate=function(number){for(let id of["three","two","one"])id===number?_this.layers[id].show():_this.layers[id].hide();let layer=_this.layers[number];layer&&(layer.alpha=1e-5,layer.y=layer.origin.y+30,tween(layer,{alpha:1,y:layer.origin.y},400,"easeOutCubic",0).onComplete(_=>{tween(layer,{alpha:1e-5,y:layer.origin.y-40},400,"easeInCubic",600)}))}})),Class((function GameplayStateCountdownNewNSX(_name){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("GameplayStateCountdownNewNSX"),await function initLayers(){for(let id in _this.layers){let layer=_this.layers[id];"closed-course"!==id&&(layer.alpha=1e-5);let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}(),await defer(),_this.flag("isReady",!0)}(),this.animate=function(number){for(let id of["three","two","one"])id===number?_this.layers[id].show():_this.layers[id].hide();let layer=_this.layers[number];layer&&(layer.alpha=1e-5,layer.scale=.5,layer.y=layer.origin.y+40,tween(layer,{alpha:1,scale:1,y:layer.origin.y},500,"easeOutCubic",0).onComplete(_=>{tween(layer,{alpha:1e-5,scale:2,y:layer.origin.y-80},500,"easeInCubic",600)}))}})),Class((function GameplayStateCountdownOldNSX(_name){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("GameplayStateCountdownOldNSX"),await function initLayers(){for(let id in _this.layers){let layer=_this.layers[id];"closed-course"!==id&&(layer.alpha=1e-5)}}()}(),this.animate=function(number){for(let id of["three","two","one"])id===number?_this.layers[id].show():_this.layers[id].hide();let layer=_this.layers[number];layer&&(layer.alpha=1e-5,tween(layer,{alpha:1},20,"linear",100).onComplete(_=>{tween(layer,{alpha:1e-5},20,"linear",900)}))}})),Class((function GameplayStateCountdownRDX(_name){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("GameplayStateCountdownRDX"),await function initLayers(){for(let id in _this.layers){let layer=_this.layers[id];"closed-course"!==id&&(layer.alpha=1e-5)}}()}(),this.animate=function(number){for(let id of["three","two","one"])id===number?_this.layers[id].show():_this.layers[id].hide();let layer=_this.layers[number];layer&&(layer.alpha=1e-5,layer.scale=.5,layer.y=layer.origin.y+40,tween(layer,{alpha:1,scale:1,y:layer.origin.y},500,"easeOutCubic",0).onComplete(_=>{tween(layer,{alpha:1e-5,scale:2,y:layer.origin.y-80},500,"easeInCubic",600)}))}})),Class((function GameplayStateCountdownTypeS(_name){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("GameplayStateCountdownTypeS"),await function initLayers(){for(let id in _this.layers){let layer=_this.layers[id];"closed-course"!==id&&(layer.alpha=1e-5);let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}()}(),this.animate=function(number){for(let id of["three","two","one"])id===number?_this.layers[id].show():_this.layers[id].hide();let layer=_this.layers[number];layer&&(layer.alpha=1e-5,layer.scale=.5,layer.y=layer.origin.y+40,tween(layer,{alpha:1,scale:1,y:layer.origin.y},500,"easeOutCubic",0).onComplete(_=>{tween(layer,{alpha:1e-5,scale:2,y:layer.origin.y-80},500,"easeInCubic",600)}))}})),Class((function GameplayStateFinishUI(_name=Utils.query("level_id")){Inherit(this,GLUIElement);const _this=this;var $this,_view,_i=0;function onSubmit(){_this.flag("clicked")||(_this.flag("clicked",!0),async function loading(){_view.layers["icon-check"].alpha=1e-6,_view.layers.save.alpha=1e-6,_view.layers.submitting.alpha=1,_this.startRender(render,3)}(),_this.delayedCall(_=>{let value=_view.input.value;Data.Race.updateUsername(value),_this.events.fire(Events.COMPLETE,{value:value})},100))}function render(n){let layer=_view.layers.submitting,text=`SUBMITTING${new Array(_i).fill(".").join("")}`;layer.setText(text),++_i>3&&(_i=0)}!async function(){!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name?(defer(_=>_this.play()),World.RENDERER.setClearColor("#222222",1),GLUI.Stage.add($this)):(GLUI.Stage.GameLayer.add($this),$this.hide())}(),await async function initView(){let view="Debug";switch(_name){case"integra":view="Integra";break;case"rdx":view="RDX";break;case"arx":view="Arx";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;case"old_nsx":default:view="OldNSX"}view=`GameplayStateFinish${view}`,_view=_this.initClass(window[view],_name),await _view.ready()}(),function addHandlers(){_this.events.sub(_view,Events.CLICK,onSubmit)}()}(),this.play=async function(){$this.hide(),await _view.ready(),_this.flag("clicked",!1),$this.show(),$this.alpha=1e-4,$this.tween({alpha:1},1e3,"easeOutSine");let name=await Storage.get("username");await _this.wait(_view,"input"),_view.input&&_view.input.animateIn(name,750),_view.animateIn&&_view.animateIn(),UIConfig.showBackground(),await TransitionUtils.autoAnimateIn(_view,_name),Track.page("/game/username")},this.reset=async function(){$this.tween({alpha:0},600,"easeOutSine").onComplete(_=>{_this.stopRender(render),_this.element.hide(),_view.animateOut&&_view.animateOut(),_view.layers.submitting.alpha=0,_view.layers["icon-check"].alpha=1,_view.layers.save.alpha=1})},this.onDestroy=function(){$this.remove()}})),Class((function GameplayStateFinishArx(_name){Inherit(this,UIFigma);const _this=this;function hover(e){}function click(){_this.events.fire(Events.CLICK)}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level4_finish"),function initInput(){_this.input=_this.initClass(GameplayStateFinishInputs,_this.layers)}(),function addHandlers(){!function save(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["save-button"])&&_this.registerButton("ArxButton",hover,click,layer),id.includes(["initial-box"])?(UIFigmaStyles.ArxButton(layer,id),layer.setZ(-1)):id.includes(["arrow-top","arrow-bottom"])&&(UIFigmaStyles.ArxIcon(layer,id),layer.setZ(100)),id.includes("icon")&&UIFigmaStyles.ArxIcon(layer,id)}}()}()}()})),Class((function GameplayStateFinishInput(_config={}){Inherit(this,GLUIElement);const _this=this,CHARS="ABCDEFGHIJKLMNOPQRSTUVWXYZ".split(""),HEIGHT=_config.height=_config.height||60,WIDTH=_config.width=_config.width||45,ZERO=new Vector2;var $this,$a,$b,_position=new Vector2,_target=new Vector2,_delta=new Vector2,_index=(new Vector2,null),_last=null,_pressing=!1;function loop(){!function applyDelta(){let touching=Mouse.input.isTouching;if(touching){if(touching&&!_pressing){(function isInside(){let scale=1,xOffset=0,yOffset=0;if(_config.box){let container=$this.parent.parent;scale=container.scale,xOffset=container.x,yOffset=container.y}let xMin=$this.x*scale+xOffset,xMax=xMin+$this.width*scale,yMin=$this.y*scale+yOffset,yMax=yMin+$this.height*scale;return xMin<Mouse.x&&xMax>Mouse.x&&yMin<Mouse.y&&yMax>Mouse.y})()&&(_pressing=!0)}}else _pressing=!1;_pressing&&(_delta.y=Mouse.delta.y/150);_delta.lerp(ZERO,.05),Math.abs(_delta.y)<.005&&!_pressing&&(_delta.y=0,_target.y=Math.round(_position.y)+1e-6,_position.lerp(_target,.05),_position.distanceTo(_target)<.001&&_position.copy(_target));_position.y+=_delta.y}(),function setIndex(){if(_index=Math.floor(Math.mod(-_position.y,CHARS.length)),_last!==_index){_last=_index;let a=CHARS[Math.floor(Math.mod(_index-0,CHARS.length))],b=CHARS[Math.floor(Math.mod(_index-1,CHARS.length))];$a.value=a,$b.value=b,$a.copy.setText(a),$b.copy.setText(b)}}(),function render(){let dist=.8*HEIGHT;$a.copy.alpha=Math.range(Math.abs($a.y),0,.45*dist,.9999,1e-4,!0),$b.copy.alpha=Math.range(Math.abs($b.y),0,.45*dist,.9999,1e-4,!0),$a.x=0,$a.y=Math.mod(_position.y*dist,dist),$b.x=0,$b.y=$a.y-dist}()}!function initGL(){($this=_this.element).width=_config.width,$this.height=_config.height,_config.box?($this.x=_config.box.x,$this.y=_config.box.y):$this.create(WIDTH,HEIGHT,"#ff0000").setZ(1)}(),function initItems(){let[width,height]=[WIDTH,HEIGHT],config=_config.font||{color:"#ffffff",width:width,height:height,align:"center"},name=_config.font&&_config.font.name?_config.font.name:"HelveticaNeue-Medium",size=_config.font&&_config.font.size?_config.font.size:.666*_config.height;_config.box.setZ(1),($a=$gl(width,height)).copy=$glText(CHARS[0],name,size,config),$a.copy.x=.5*width,$a.copy.y=.5*(height-size),$a.add($a.copy),$this.add($a),($b=$gl(width,height)).copy=$glText(CHARS[1],name,size,config),$b.copy.x=.5*width,$b.copy.y=.5*(height-size),$b.add($b.copy),$this.add($b),$a.copy.setZ(2),$b.copy.setZ(2),_config.style&&UIFigmaStyles[_config.style]($a.copy),_config.style&&UIFigmaStyles[_config.style]($b.copy)}(),_this.startRender(loop),this.lock=function(){},this.get("value",_=>$a.copy.alpha>$b.copy.alpha?$a.value:$b.value),this.set("value",v=>{v=v.toUpperCase();let y=CHARS.length-CHARS.findIndex(l=>l===v)-1;tween(_position,{y:y},500,"easeOutCubic")}),this.inc=function(){_position.y--},this.dec=function(){_position.y++}})),Class((function GameplayStateFinishInputs(_layers){Inherit(this,GLUIElement);const _this=this;var _first,_second,_third,_char=0;function onPress(e){let letter=e.key.toUpperCase();if("ABCDEFGHIJKLMNOPQRSTUVWXYZ".indexOf(letter)<0)return;let value=_this.value.split("");value[_char]=letter,value=value.join(""),[_first,_second,_third][_char].value=value[_char],++_char>2&&(_char=0),clearTimeout(_this.resetChar),_this.resetChar=_this.delayedCall(_=>_char=0,3e3)}function hover(e){switch(e.action){case"over":tween(e.object,{alpha:.9,scale:1.04,hover:1},150,"easeOutBack");break;case"out":tween(e.object,{alpha:1,scale:1,hover:0},400,"easeOutBack")}}function click(e){e.object.clearTween(),e.object.scale=.96,e.object.alpha=.9,e.object.hover=1,tween(e.object,{alpha:1,scale:1,hover:0},500,"easeOutSine")}!async function(){await defer(),function initGL(){_this.element.setZ(200)}(),function initInputs(){let views=[],style=_layers["initial-1"].text.getData(),config={width:_layers["initial-box-1"].width,height:_layers["initial-box-1"].height,style:_layers["initial-1"].uiStyle,font:{name:style.font,size:style.size,color:style.color.getHexString(),align:"center"}};_layers["initial-1"].alpha=0,_layers["initial-2"].alpha=0,_layers["initial-3"].alpha=0;for(;views.length<3;){config.box=_layers[`initial-box-${views.length+1}`];let view=_this.initClass(GameplayStateFinishInput,config);view.index=views.length,views.push(view)}[_first,_second,_third]=views;for(let[i,view]of views.entries())_layers[`arrow-top-box-${i+1}`].interact(hover,e=>{click(e),view.dec()}),_layers[`arrow-bottom-box-${i+1}`].interact(hover,e=>{click(e),view.inc()});defer(_=>{_this.value="AAA"})}(),function addHandlers(){_this.events.sub(KeyboardUtil.PRESS,onPress)}()}(),this.get("value",_=>`${_first.value}${_second.value}${_third.value}`),this.set("value",(v="AAA")=>{v=v.toUpperCase().split(""),_first.value=v[0],_second.value=v[1],_third.value=v[2]}),this.animateIn=function(name,delay=0){_first.element.alpha=1e-5,_second.element.alpha=1e-5,_third.element.alpha=1e-5,_first.element.tween({alpha:1},250,"easeOutCubic",delay),_second.element.tween({alpha:1},250,"easeOutCubic",delay),_third.element.tween({alpha:1},250,"easeOutCubic",delay),_this.delayedCall(_=>{_this.value=name},delay)}})),Class((function GameplayStateFinishDebug(){Inherit(this,GLUIElement);const _this=this,EDGE=30;var $this,_layers;function hover(e){}function click(e){let id=e.object.id;e.object.disabled||_this.events.fire(Events.CLICK,{id:id})}function resize(){!function time(){let $time=_layers.time;$time.x=.5*Stage.width,$time.y=.5*Stage.height-$time.dimensions.height-.5*EDGE}(),function garage(){let $garage=_layers.garage;$garage.x=.5*Stage.width,$garage.y=.5*Stage.height+1*EDGE}(),function replay(){let $replay=_layers.replay;$replay.x=.5*Stage.width,$replay.y=.5*Stage.height+2*EDGE}(),function share(){let $share=_layers.share;$share.x=.5*Stage.width,$share.y=.5*Stage.height+3*EDGE}()}!async function(){!function initGL(){$this=_this.element,"GameplayStateFinishDebug"!==Global.PLAYGROUND?$this.hide():GLUI.Stage.add($this)}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"GameplayStateFinishDebug",{glui:!0}),_layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),await async function initLayers(){let tasks=[];for(let id in _layers){let layer=_layers[id];layer.id=id,"background"===id?(layer.setZ(1),layer.alpha=.8):layer.setZ(2),layer.text&&tasks.push(layer.text.ready())}await Promise.all(tasks)}(),function addHandlers(){for(let $layer of[_layers.garage,_layers.share,_layers.replay])$layer.interact(hover,click);_this.onResize(resize)}(),_this.flag("isReady",!0)}(),this.set("time",v=>{let $time=_layers.time;$time.setText(v),$time.loaded().then(resize)}),this.resetShare=function(){_layers.share.disabled=!0,_layers.share.alpha=.25},this.enableShare=function(){_layers.share.disabled=!1,_layers.share.alpha=1}})),Class((function GameplayStateFinishIntegra(_name){Inherit(this,UIFigma);const _this=this;function hover(e){}function click(){_this.events.fire(Events.CLICK)}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level2_finish"),function initInput(){_this.input=_this.initClass(GameplayStateFinishInputs,_this.layers)}(),function addHandlers(){!function save(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["save-button"])&&_this.registerButton("IntegraButton",hover,click,layer),id.includes(["initial-box"])?(UIFigmaStyles.IntegraButton(layer,id),layer.setZ(-1)):id.includes(["arrow-top","arrow-bottom"])&&(UIFigmaStyles.IntegraIcon(layer,id),layer.setZ(100)),id.includes("icon")&&UIFigmaStyles.IntegraIcon(layer,id),id.includes(["save-your-initials","initial-1","initial-2","initial-3"])&&UIFigmaStyles.IntegraTitleText(layer),id.includes("sparkle")&&UIFigmaStyles.IntegraShine(layer)}}()}()}()})),Class((function GameplayStateFinishNewNSX(_name){Inherit(this,UIFigma);const _this=this;function hover(e){}function click(){_this.events.fire(Events.CLICK)}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level5_finish"),function initInput(){_this.input=_this.initClass(GameplayStateFinishInputs,_this.layers)}(),function addHandlers(){!function save(){for(let id in _this.layers){let layer=_this.layers[id];if(id.includes(["save-button"])&&_this.registerButton("NewNSXButton",hover,click,layer),id.includes(["initial-box"])?(UIFigmaStyles.NewNSXButton(layer,id),layer.setZ(-1)):id.includes(["arrow-top","arrow-bottom"])&&(UIFigmaStyles.NewNSXIcon(layer,id),layer.setZ(100)),id.includes("icon")&&UIFigmaStyles.NewNSXIcon(layer,id),!id.includes("background")){let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}}()}()}()})),Class((function GameplayStateFinishOldNSX(_name){Inherit(this,UIFigma);const _this=this;function hover(e){}function click(){_this.events.fire(Events.CLICK)}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level1_finish"),function initInput(){_this.input=_this.initClass(GameplayStateFinishInputs,_this.layers)}(),function addHandlers(){!function save(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["save-button"])&&_this.registerButton("OldNSXButton",hover,click,layer),id.includes(["arrow-bottom-box","arrow-top-box","initial-box"])?(UIFigmaStyles.OldNSXButton(layer,id),layer.setZ(-1)):id.includes(["arrow-top","arrow-bottom"])&&(UIFigmaStyles.OldNSXIcon(layer,id),layer.setZ(100)),id.includes("icon")&&UIFigmaStyles.OldNSXIcon(layer,id)}}()}()}()})),Class((function GameplayStateFinishRDX(_name){Inherit(this,UIFigma);const _this=this;function hover(e){}function click(){_this.events.fire(Events.CLICK)}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level3_finish"),function initInput(){_this.input=_this.initClass(GameplayStateFinishInputs,_this.layers)}(),function addHandlers(){!function save(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["save-button"])&&_this.registerButton("RDXButton",hover,click,layer),id.includes(["initial-box"])?(UIFigmaStyles.RDXButton(layer,id),layer.setZ(-1)):id.includes(["arrow-top","arrow-bottom"])&&(UIFigmaStyles.RDXIcon(layer,id),layer.setZ(100)),id.includes("icon")&&UIFigmaStyles.RDXIcon(layer,id)}}()}()}()})),Class((function GameplayStateFinishTypeS(_name){Inherit(this,UIFigma);const _this=this;function hover(e){}function click(){_this.events.fire(Events.CLICK)}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level6_finish"),function initInput(){_this.input=_this.initClass(GameplayStateFinishInputs,_this.layers)}(),function addHandlers(){!function save(){for(let id in _this.layers){let layer=_this.layers[id];if(id.includes(["save-button"])&&_this.registerButton("TypeSButton",hover,click,layer),id.includes(["initial-box"])?(UIFigmaStyles.TypeSButton(layer,id),layer.setZ(-1)):id.includes(["arrow-top","arrow-bottom"])&&(UIFigmaStyles.TypeSIcon(layer,id),layer.setZ(100)),id.includes("icon")&&UIFigmaStyles.TypeSIcon(layer,id),!id.includes("background")){let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}}()}()}()})),Class((function GameplayStatePauseUI(_name=Utils.query("level_id"),_options={}){Inherit(this,GLUIElement);const _this=this;var $this,_view,_share,_hasShare=!1;async function onClick({type:type}){if(!_this.flag("clicked"))switch(type){case"resume":_this.flag("clicked",!0),Track.event("Pause","click","resume"),_this.findParent("GameplayState").pause();break;case"restart":_this.flag("clicked",!0),Track.event("Pause","click","replay"),_this.findParent("GameplayState").replay();break;case"garage":_this.flag("clicked",!0),_this.animateOut(),Track.event("Pause","click","garage"),ViewController.instance().exitGame();break;case"leaderboard":Track.event("Pause","click","leaderboard"),ViewController.instance().showLeaderboard(_name);break;case"share":Track.event("Pause","click","share"),Config.FACEBOOK||Share.supports.native?Data.tracks[_name].shareTrack("native"):function showShare(){_hasShare=!0,_view.animateOut&&_view.animateOut();_share.animateIn()}();break;case"sound":let muted=AudioController.instance().muted;Track.event("Pause","click",muted?"sound-on":"sound-off"),muted?AudioController.instance().unmute():AudioController.instance().mute(),applySoundButtonState();break;case"tutorial":Track.event("Pause","click","tutorial"),_this.flag("clicked",!0),_this.findParent("GameplayState").playTutorial()}}function applySoundButtonState(){let muted=AudioController.instance().muted,$btn=_view.layers["icon-sound-image"]?_view.layers["icon-sound-image"]:_view.layers["icon-sound"];if(!$btn.tMap.value)return console.warn("bypassed applySoundButtonState error");let src=$btn.tMap.value.src;src=muted?src.replace("-on","-off"):src.replace("-off","-on"),$btn.bg(src)}function closeShare(){_hasShare=!1,_share.animateOut(),_view.animateIn&&_view.animateIn()}function onChange({view:view}){switch(view){case"Garage":$this.hide()}}!async function(){!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name?(GLUI.Stage.add($this),defer(_=>_this.animateIn()),World.RENDERER.setClearColor("#222222",1)):_this.wait(GLUI.Stage,"GameLayer").then(_=>{GLUI.Stage.GameLayer.add($this)})}(),await async function initView(){let view="Debug";switch(_name){case"arx":view="ARX";break;case"rdx":view="RDX";break;case"integra":view="Integra";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:case"old_nsx":view="OldNSX"}view=`GameplayStatePauseUI${view}`,_view=_this.initClass(window[view],_name),_share=_this.initClass(ShareUI,_name,{track:!0}),await _view.ready(),applySoundButtonState()}(),function addHandlers(){_this.events.sub(_view,Events.CLICK,onClick),_this.events.sub(_share,Events.COMPLETE,closeShare),_this.events.sub(ViewController.CHANGE,onChange)}()}(),this.animateIn=async function(){await _view.ready(),_this.events.fire(GameplayStatePauseUI.VISIBILITY,{visible:!0}),_this.flag("clicked",!1),_hasShare=!1,$this.show(),$this.alpha=1e-4,$this.tween({alpha:1},1e3,"easeOutSine"),_view.animateIn&&_view.animateIn(),UIConfig.showBackground(),TransitionUtils.autoAnimateIn(_view,_name),Track.page("/game/pause")},this.animateOut=async function(){$this.tween({alpha:1e-4},500,"easeOutSine"),_this.events.fire(GameplayStatePauseUI.VISIBILITY,{visible:!1}),await _view.ready(),UIConfig.hideBackground(),_hasShare&&_share.animateOut(),_hasShare=!1,_view.animateOut&&await _view.animateOut()},this.onDestroy=function(){$this.remove()}}),_=>{GameplayStatePauseUI.VISIBILITY="gameplay_state_pause_ui_visibility"}),Class((function GameplayStatePauseUIARX(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0);function hover(e){}function click(e){let type;switch(e.object.id){case"garage-button":type="garage";break;case"leader-board-button":type="leaderboard";break;case"restart-button":type="restart";break;case"tutorial-button":type="tutorial";break;case"resume-button":type="resume";break;case"icon-sound":type="sound";break;case"icon-share":type="share"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level4_pause"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];"background"===id?(layer.alpha=.5,layer.setZ(1)):(layer.setZ(layer.text||"icon-play"===id?3:2),id.includes("-image")&&layer.setZ(4),id.includes(["button","share","sound"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton("ArxButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.ArxIcon(layer,id))}}()}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuint",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1})},this.animateOut=function(){return tween(_animation,{x:0},400,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x)}).onComplete(_=>{$this.hide()}).promise()}})),Class((function GameplayStatePauseUIDebug(){Inherit(this,GLUIElement);const _this=this;var $this,_layers;function hover(e){}function click(e){let type=e.object.id;_this.events.fire(Events.CLICK,{type:type})}function resize(){$this.x=Stage.width/2-120,$this.y=Stage.height/2-40;let $bg=_layers.background;$bg.x=-$this.x,$bg.y=-$this.y,$bg.width=Stage.width,$bg.height=Stage.height}!async function(){!function initGL(){($this=_this.element).hide()}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"GameplayStatePauseUIDebug",{glui:!0}),_layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),function addHandlers(){for(let id in _layers){let layer=_layers[id];"background"===id?(layer.alpha=.5,layer.setZ(1)):(layer.id=id,layer.interact(hover,click),layer.setZ(2))}_this.onResize(resize)}(),_this.flag("isReady",!0)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()}})),Class((function GameplayStatePauseUIIntegra(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0);function hover(e){}function click(e){let type;switch(e.object.id){case"garage-button":type="garage";break;case"leader-board-button":type="leaderboard";break;case"restart-button":type="restart";break;case"tutorial-button":type="tutorial";break;case"resume-button":type="resume";break;case"icon-sound":type="sound";break;case"icon-share":type="share"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level2_pause"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];"background"===id?(layer.alpha=.5,layer.setZ(1)):(layer.setZ(layer.text||"icon-play"===id?3:2),id.includes("-image")&&layer.setZ(4),id.includes(["button","share","sound"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton(!!id.includes(["button"])&&"IntegraButton",hover,click,layer),layer.text&&UIFigmaStyles.IntegraText(layer,layer.text.getData().color),id.includes("icon")&&UIFigmaStyles.IntegraIcon(layer,id),id.includes("pause")&&UIFigmaStyles.IntegraTitleText(layer),id.includes("sparkle")&&UIFigmaStyles.IntegraShine(layer))}}()}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuint",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1})},this.animateOut=function(){return tween(_animation,{x:0},400,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x)}).onComplete(_=>{$this.hide()}).promise()}})),Class((function GameplayStatePauseUINewNSX(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0);function hover(e){}function click(e){let type;switch(e.object.id){case"garage-button":type="garage";break;case"leader-board-button":type="leaderboard";break;case"restart-button":type="restart";break;case"tutorial-button":type="tutorial";break;case"resume-button":type="resume";break;case"icon-sound":type="sound";break;case"icon-share":type="share"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level5_pause"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];if("background"===id)layer.alpha=.5,layer.setZ(1);else{if((layer.element?layer.element:layer).setZ(layer.text||"icon-play"===id?3:2),id.includes("-image")&&layer.setZ(4),id.includes(["button","share","sound"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton("NewNSXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.NewNSXIcon(layer,id),!id.includes("background")){let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}}}()}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuint",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1})},this.animateOut=function(){return tween(_animation,{x:0},400,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x)}).onComplete(_=>{$this.hide()}).promise()}})),Class((function GameplayStatePauseUIOldNSX(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0);function hover(e){}function click(e){let type;switch(e.object.id){case"garage-button":type="garage";break;case"leader-board-button":type="leaderboard";break;case"restart-button":type="restart";break;case"tutorial-button":type="tutorial";break;case"resume-button":type="resume";break;case"icon-sound":type="sound";break;case"icon-share":type="share"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level1_pause"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];"background"===id?(layer.alpha=.5,layer.setZ(1)):(layer.setZ(layer.text||"icon-play"===id?3:2),id.includes("-image")&&layer.setZ(4),layer.text&&_this.applyStyle("OldNSXOutlineText",layer),id.includes(["button","share","sound"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton("OldNSXButton",hover,click,layer))}}()}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuint",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1})},this.animateOut=function(){return tween(_animation,{x:0},400,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x)}).onComplete(_=>{$this.hide()}).promise()}})),Class((function GameplayStatePauseUIRDX(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0);function hover(e){}function click(e){let type;switch(e.object.id){case"garage-button":type="garage";break;case"leader-board-button":type="leaderboard";break;case"restart-button":type="restart";break;case"tutorial-button":type="tutorial";break;case"resume-button":type="resume";break;case"icon-sound":type="sound";break;case"icon-share":type="share"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level3_pause"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];"background"===id?(layer.alpha=.5,layer.setZ(1)):(layer.setZ(layer.text||"icon-play"===id?3:2),id.includes("-image")&&layer.setZ(4),id.includes(["button","share","sound"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton(!!id.includes(["button"])&&"RDXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.RDXIcon(layer,id))}}()}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuint",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1})},this.animateOut=function(){return tween(_animation,{x:0},400,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x)}).onComplete(_=>{$this.hide()}).promise()}})),Class((function GameplayStatePauseUITypeS(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0);function hover(e){}function click(e){let type;switch(e.object.id){case"garage-button":type="garage";break;case"leader-board-button":type="leaderboard";break;case"restart-button":type="restart";break;case"tutorial-button":type="tutorial";break;case"resume-button":type="resume";break;case"icon-sound":type="sound";break;case"icon-share":type="share"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level6_pause"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];if("background"===id)layer.alpha=.5,layer.setZ(1);else if(layer.setZ&&layer.setZ(layer.text||"icon-play"===id?3:2),id.includes("-image")&&layer.setZ(4),id.includes(["button","share","sound"])&&!id.includes(["glow","icon-sound-image","icon-share-image"])&&_this.registerButton("TypeSButton",hover,click,layer),id.includes("icon")&&!id.includes("glow")&&UIFigmaStyles.TypeSIcon(layer,id),!id.includes("background")){let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}}()}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuint",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1})},this.animateOut=function(){return tween(_animation,{x:0},400,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x)}).onComplete(_=>{$this.hide()}).promise()}})),Class((function GameplayStateQualifiedUI(_name=Utils.query("level_id"),_state){Inherit(this,GLUIElement);const _this=this;var $this,_view,_results;const HOST_BUTTON_CONFIG={old_nsx:{"garage-button":[32,234],"replay-button":[289,234],"next-level-button":[545,234],shader:($layer,shader)=>{let border=3/$layer.width,edge=new Vector2(1*border,$layer.width/$layer.height*border);console.log(border,edge),shader.set("uEdge",edge)}},integra:{"garage-button":[32,234],"replay-button":[289,234],"next-level-button":[545,234],shader:($layer,shader)=>{let border=2/$layer.width,edge=new Vector2(1*border,$layer.width/$layer.height*border);shader.set("uEdge",edge)}},rdx:{"garage-button":[26,233],"replay-button":[292,233],"next-level-button":[555,233],shader:($layer,shader)=>{shader.set("uAspect",new Vector2($layer.width/$layer.height,1))}},arx:{"garage-button":[33,234],"replay-button":[289,234],"next-level-button":[545,234],shader:($layer,shader)=>{let border=1/$layer.width,inset=3/$layer.width;shader.set("uEdge",new Vector2(border,$layer.width/$layer.height*border)),shader.set("uInset",new Vector2(inset,$layer.width/$layer.height*inset))}},new_nsx:{"garage-button":[33,234],"replay-button":[289,234],"next-level-button":[545,234],shader:($layer,shader)=>{let border=1.6/$layer.width;shader.set("uEdge",new Vector2(border,$layer.width/$layer.height*border))}},type_s:{"garage-button":[33,234],"replay-button":[289,234],"next-level-button":[545,234],shader:($layer,shader)=>{let border=1.1/$layer.width,corner=6/$layer.width;shader.set("uEdge",new Vector2(border,$layer.width/$layer.height*border)),shader.set("uCorner",new Vector2(corner,$layer.width/$layer.height*corner))}}},BUTTONS_CONFIG={"garage-button":["garage"],"replay-button":["replay"],"next-level-button":["next-level","icon-play"]};async function initView(){_view&&_view.destroy&&(_this.events.unsub(_view,Events.CLICK,onClick),_view.element.remove(),_view=_view.destroy());let view="Debug";switch(_name){case"arx":view="ARX";break;case"rdx":view="RDX";break;case"integra":view="Integra";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:case"old_nsx":view="OldNSX"}view=`GameplayStateQualified${view}`,_view=_this.initClass(window[view],_name),_this.events.sub(_view,Events.CLICK,onClick),await _view.ready()}async function applyOnlineState(){await _view.ready(),_this.flag("isVisible")&&(clearTimeout(_this.waitingTimer),Global.ONLINE?(!function applyOnlineVisibility(){_view.layers.share.hide(),_view.layers["share-button"].hide(),_view.layers.garage.setText("EXIT")}(),function arrangeHostButtons(){for(let id of["garage-button","replay-button","next-level-button"]){let $layer=_view.layers[id],shader=$layer.shader,car=HOST_BUTTON_CONFIG[_name];if(!car)continue;let config=car[id],x=config[0],width=config[1];$layer.origin.x=x,$layer.x=x,$layer.width=width,car.shader($layer,shader)}}(),function arrangeHostButtonText(){for(let bId in BUTTONS_CONFIG){let layers=BUTTONS_CONFIG[bId],$button=_view.layers[bId];for(let[i,id]of layers.entries()){let $layer=_view.layers[id],$first=_view.layers[layers[0]];if(0===i){let x=$button.x+.5*$button.width;$layer.origin.x=x,$layer.x=x}else $layer.x=$first.x+($layer._origin.x-$first._origin.x)}}}(),MultiplayerSession.HOST||"random"===MultiplayerSession.TYPE?function applyHostVisibility(){_view.layers.waiting.hide();for(let id of["replay","replay-button","next-level","next-level-button","icon-play"]){_view.layers[id].show()}}():(!function applyGuestVisibility(){_view.layers.waiting.show();for(let id of["replay","replay-button","next-level","next-level-button","icon-play"]){_view.layers[id].hide()}}(),function animateWaiting(layer,tick=0){clearTimeout(_this.waitingTimer),tick>3&&(tick=0);let ellipsis=0===tick?"":new Array(tick).fill(".").join("");layer.setText(`WAITING FOR FRIEND${ellipsis}`),tick++,_this.waitingTimer=_this.delayedCall(_=>animateWaiting(layer,tick),500)}(_view.layers.waiting),async function awaitHost(){let message=_this.wait(MultiplayerSession,"INTENT"),delay=Promise.create();if(clearTimeout(_this.delayTimer),_this.delayTimer=_this.delayedCall(delay.resolve,3e3),await Promise.all([delay,message]),!Global.ONLINE||MultiplayerSession.HOST||!_this||!_this.element)return;switch(MultiplayerSession.INTENT){case"replay":_this.flag("clicked",!0),_state.replay(),UIConfig.resetBackground();break;case"next":_this.flag("clicked",!0),ViewController.instance().showLoader(_name),_this.parent.reset(),_this.delayedCall(_=>{ViewController.instance().nextTrack(_name)},500);break;case"exit":_this.flag("clicked",!0),_this.animateOut().then(_=>{ViewController.instance().exitGame(),Track.event("Results","click","garage")})}}())):(!function applyOfflineVisibility(){_view.layers.garage.setText("GARAGE"),_view.layers.waiting.hide();for(let id of["share","share-button","replay","replay-button","next-level","next-level-button","icon-play"]){_view.layers[id].show()}}(),function arrangeOfflineElements(){for(let id of["share","share-button","replay","replay-button","next-level","next-level-button","icon-play"]){let $layer=_view.layers[id];for(let key of["x","width"]){let value=$layer._origin[key];isNaN(value)||($layer[key]=value,$layer.origin[key]=value)}}}(),function applyOfflineButtonShaders(){for(let id of["garage-button","replay-button","next-level-button"]){let $layer=_view.layers[id],shader=$layer.shader,car=HOST_BUTTON_CONFIG[_name];car&&car.shader($layer,shader)}}()),_view.layers["next-level"].alpha=1,_view.resize())}function onClick({id:id}){if(!_this.flag("clicked"))switch(id){case"replay-button":{_this.flag("clicked",!0),Global.ONLINE&&_this.events.fire(GameplayMultiplayer.INTENT,{action:"replay"}),_state.replay(),UIConfig.resetBackground();let name="Results",type="click",action=`replay-level${Data.getTrackNumberByName(_name)}`;Global.ONLINE&&(name="1v1",type="end screen",action=`replay-level${Data.getTrackNumberByName(_name)}`),Track.event(name,type,action),Track.page(`/game/level${Data.getTrackNumberByName(_name)}`);break}case"garage-button":_this.flag("clicked",!0),Global.ONLINE&&_this.events.fire(GameplayMultiplayer.INTENT,{action:"exit"}),_this.animateOut().then(_=>{ViewController.instance().exitGame();let name="Results",type="click",action="garage";Global.ONLINE&&(name="1v1",type="end screen",action="exit"),Track.event(name,type,action)});break;case"view-leader-board-button":ViewController.instance().showLeaderboard(_name),Track.event("Results","click","leaderboard");break;case"share-button":{if(null===_results)return;let playerQualified=_results;Track.event("Results","click","share"),Config.FACEBOOK||Share.supports.native?playerQualified?Data.tracks[_name].share("native"):Data.tracks[_name].shareTrack("native"):_this.events.fire(Gameplay.SHARE,{playerQualified:playerQualified});break}case"next-level-button":{_this.flag("clicked",!0);let name="Results",type="click",action="next";Global.ONLINE&&(name="1v1",type="end screen",action=`next-level${Data.getTrackNumberByName(_name)}`),Track.event(name,type,action),Global.ONLINE&&_this.events.fire(GameplayMultiplayer.INTENT,{action:"next"}),ViewController.instance().showLoader(_name),_this.parent.reset(),_this.delayedCall(_=>{ViewController.instance().nextTrack(_name)},500);break}}}function onChange({view:view}){switch(view){case"Garage":$this.hide()}}async function setQualifiedState(results,score){let toBeat,ghost=await Data.getGhost();score=null!==MultiplayerSession.FINISH_TIME?Math.min(1e3*MultiplayerSession.FINISH_TIME,score):score,ghost&&ghost.score&&(toBeat=ghost.score),toBeat?toBeat/=1e3:toBeat=Qualifying[_name].time;let playerBeatThat=score/1e3<=toBeat,playerQualified=score/1e3<=Qualifying[_name].time;_this.findParent("Gameplay").state.set("results",playerQualified),_this.findParent("Gameplay").state.set("results_audio",Global.ONLINE?MultiplayerSession.WON:playerQualified);let displayTime=Numbers.formatTime(toBeat),yourTime=results.current.score_display,next=Config.TRACKS[Config.TRACKS.indexOf(_name)+1];if(next){let unlocked=await Data.tracks[next].isUnlocked();_view.unlocked=unlocked}else _view.unlocked=!0;Global.ONLINE?_view.header=MultiplayerSession.WON?"YOU WON!":"YOU LOST":_view.header=playerBeatThat?Copy.QUALIFIED:Copy.TRY_AGAIN,_view.result=results.resultCopy,_view.time=yourTime,clearTimeout(_this.swapTimer),playerBeatThat?(_view.label=Copy.YOUR_TIME,_view.color="qualified"):function cycleAnimation(yourTime,qualifyTime){let showing=_this.flag("showing")?_this.flag("showing"):"qualifying";showing="qualifying"===showing?"yours":"qualifying","yours"===showing?(_view.label=Copy.YOUR_TIME,_view.time=yourTime,_view.color="qualified"):(_view.label=Copy.BEAT_THAT_TIME,_view.time=qualifyTime,_view.color="disqualified"),_this.flag("showing",showing),clearTimeout(_this.swapTimer),_this.swapTimer=_this.delayedCall(_=>{cycleAnimation(yourTime,qualifyTime)},2e3)}(yourTime,displayTime),_results=playerBeatThat}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name?(GLUI.Stage.add($this),_this.delayedCall(_=>{_this.animateIn()},100),World.RENDERER.setClearColor("#222222",1)):($this.hide(),GLUI.Stage.GameLayer.add($this))}(),initView(),function addHandlers(){_this.events.sub(ViewController.CHANGE,onChange),Dev.expose("applyOnlineState",applyOnlineState)}(),this.animateIn=async function(){await _view.ready(),$this.show(),_view.animateIn&&_view.animateIn(),$this.tween({alpha:1},600,"easeOutSine"),clearTimeout(_this.waitingTimer),clearTimeout(_this.swapTimer),clearTimeout(_this.delayTimer),_this.flag("isVisible",!0);for(let id in _view.layers){let $layer=_view.layers[id];$layer.element&&($layer=$layer.element);let origin=$layer.origin;origin||(origin=new Vector2($layer.x,$layer.y)),origin.alpha="next-level"===id?1:$layer.alpha,origin.width=$layer.width,origin.height=$layer.height,$layer._origin=JSON.parse(JSON.stringify(origin)),$layer.origin=origin}let blacklist=[];Global.ONLINE?(blacklist.push("share","share-button"),MultiplayerSession.HOST?blacklist.push("waiting"):blacklist.push("replay","replay-button","next-level","next-level-button","icon-play")):blacklist.push("waiting"),applyOnlineState(),TransitionUtils.autoAnimateIn(_view,_name,blacklist)},this.animateOut=async function(){clearTimeout(_this.waitingTimer),clearTimeout(_this.swapTimer),clearTimeout(_this.delayTimer),$this.tween({alpha:1e-4},600,"easeOutSine"),_this.flag("isVisible",!1),await _view.ready(),_view.animateOut&&_view.animateOut()},this.play=async function(){_this.flag("clicked",!1),initView(),await _view.ready(),_results=null,clearTimeout(_this.waitingTimer),clearTimeout(_this.swapTimer),clearTimeout(_this.delayTimer);let results=await Data.Race.results(),username=await Data.Race.username(),score=results.current.score;await async function generateLeaderboardPreview(results,username,score){let leaderboard=await Data.Leaderboard.get({track:Data.getTrackNumberByName(_name)}),match=leaderboard.findIndex(i=>results.current.id===i.id),position=leaderboard.findIndex(i=>score<i.score);for(match>-1?leaderboard[match].username=username:position>-1?leaderboard.splice(position,0,{score:score,username:username,highlight:!0}):leaderboard.length<3&&leaderboard.push({score:score,username:username,highlight:!0});leaderboard.length<3;)leaderboard.push({score:null,username:"AAA"});_view.topThree=[leaderboard[0],leaderboard[1],leaderboard[2]]}(results,username,score),Track.page("/game/results"),_this.delayedCall(async _=>{_this.element.show(),_view.element.show(),await setQualifiedState(results,score),_view.animateIn&&_view.animateIn();let blacklist=[];Global.ONLINE?(blacklist.push("share","share-button"),MultiplayerSession.HOST?blacklist.push("waiting"):blacklist.push("replay","replay-button","next-level","next-level-button","icon-play")):blacklist.push("waiting"),_this.flag("isVisible",!0);for(let id in _view.layers){let $layer=_view.layers[id];$layer.element&&($layer=$layer.element);let origin=$layer.origin;origin||(origin=new Vector2($layer.x,$layer.y)),origin.alpha="next-level"===id?1:$layer.alpha,origin.width=$layer.width,origin.height=$layer.height,$layer._origin=JSON.parse(JSON.stringify(origin)),$layer.origin=origin}applyOnlineState(),TransitionUtils.autoAnimateIn(_view,_name,blacklist),_this.delayedCall(_=>{for(let id of blacklist){_view.layers[id].hide()}},100)},500)},this.reset=async function(){_this.events.fire(Gameplay.RESET),clearTimeout(_this.waitingTimer),clearTimeout(_this.swapTimer),clearTimeout(_this.delayTimer),_this.flag("isVisible",!1),_this.element.hide(),_view&&_view.resetShare&&_view.resetShare(),_view.animateOut&&_view.animateOut(),UIConfig.hideBackground(),await Data.Race.ready(),_this&&_this.flag&&_this.flag("clicked",!1),_view&&_view.enableShare&&_view.enableShare()},this.onDestroy=function(){clearTimeout(_this.waitingTimer),clearTimeout(_this.swapTimer),clearTimeout(_this.delayTimer),$this.remove()}})),Class((function GameplayStateQualifiedARX(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0),_qualifiedColor=new Color("#FFFFFF"),_disqualifiedColor=new Color("#FF2E00"),_nextLevelUnlocked=!1;function hover(e){}function click(e){let id=e.object.id;("next-level-button"!==id||_nextLevelUnlocked)&&_this.events.fire(Events.CLICK,{id:id})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level4_qualified"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button"])&&_this.registerButton("ArxButton",hover,click,layer),id.includes("leader-board-box")&&UIFigmaStyles.ARXOutline(layer),id.includes("icon")&&UIFigmaStyles.ArxIcon(layer,id)}}(),_this.unlocked=_nextLevelUnlocked}(),this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuad",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x,{blacklist:["next-level","next-level-button","icon-play"]}),$this.alpha=1;let alpha=_animation.x*(_nextLevelUnlocked?1:.5);_this.layers["next-level"].alpha=_animation.x,_this.layers["next-level-button"].alpha=alpha,_this.layers["icon-play"].alpha=alpha})},this.animateOut=function(){tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1}).onComplete(_=>{$this.hide()})},this.set("unlocked",state=>{_nextLevelUnlocked=state;let layer=_this.layers["next-level-button"];state?(_this.layers["next-level"].alpha=1,_this.layers["next-level-button"].alpha=1,_this.layers["icon-play"].alpha=1,_this.registerButton("ArxButton",hover,click,layer)):(layer.clearInteract(),_this.layers["next-level"].alpha=.5,_this.layers["next-level-button"].alpha=.5,_this.layers["icon-play"].alpha=.5)}),this.set("label",async v=>{await _this.ready();let $label=_this.layers["your-time-label"];$label&&$label.setText(v)}),this.set("time",async v=>{await _this.ready();let $time=_this.layers["your-time-number"];$time&&$time.setText(v)}),this.set("header",async v=>{await _this.ready();let $header=_this.layers.header;$header&&($header.setText(v),await $header.text.ready())}),this.set("result",async v=>{await _this.ready();let $result=_this.layers["result-text"];$result&&($result.setText(v),await $result.text.ready(),tween($result,{alpha:1},250,"easeOutCubic"))}),this.set("color",state=>{let color="qualified"===state?_qualifiedColor:_disqualifiedColor,$time=_this.layers["your-time-number"];$time&&$time.setColor(color)}),this.set("topThree",async v=>{let[$1t,$1a,$2t,$2a,$3t,$3a]=[_this.layers["time-1"],_this.layers["initials-1"],_this.layers["time-2"],_this.layers["initials-2"],_this.layers["time-3"],_this.layers["initials-3"]];$1t.setText(Numbers.formatTime(v[0].score/1e3)),$2t.setText(Numbers.formatTime(v[1].score/1e3)),$3t.setText(Numbers.formatTime(v[2].score/1e3)),$1a.setText(v[0].username),$2a.setText(v[1].username),$3a.setText(v[2].username)})})),Class((function GameplayStateQualifiedUIDebug(_name){Inherit(this,GLUIElement);const _this=this,EDGE=30;var $this,_layers;function resize(){!function background(){let $bg=_layers.background;$bg.width=Stage.width,$bg.height=Stage.height,$bg.x=0,$bg.y=0}(),function title(){let $title=_layers.title;$title.x=EDGE,$title.y=Stage.height/2-$title.dimensions.height-.5*EDGE}(),function cta(){let $cta=_layers.cta;$cta.x=EDGE,$cta.y=Stage.height/2+.5*EDGE}(),function save(){let $save=_layers.save;$save.x=Stage.width-EDGE-$save.dimensions.width,$save.y=Stage.height/2+.5*EDGE}()}!async function(){!function initGL(){$this=_this.element,"GameplayStateQualifiedUIDebug"!==Global.PLAYGROUND&&$this.hide()}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"GameplayStateQualifiedUIDebug",{glui:!0}),_layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),await async function initLayers(){let tasks=[];for(let id in _layers){let layer=_layers[id];"background"===id?(layer.setZ(1),layer.alpha=.8):layer.setZ(2),layer.text&&tasks.push(layer.text.ready())}await Promise.all(tasks)}(),function addHandlers(){_this.onResize(resize)}(),_this.flag("isReady",!0)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=function(){$this.show(),resize()},this.animateOut=function(){$this.hide()}})),Class((function GameplayStateQualifiedIntegra(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0),_qualifiedColor=new Color("#FFFFFF"),_disqualifiedColor=new Color("#FF332D"),_nextLevelUnlocked=!1;function hover(e){}function click(e){let id=e.object.id;("next-level-button"!==id||_nextLevelUnlocked)&&_this.events.fire(Events.CLICK,{id:id})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level2_qualified"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button"])&&_this.registerButton("IntegraButton",hover,click,layer),id.includes(["header","your-time-number"])&&UIFigmaStyles.IntegraTitleText(layer),id.includes("sparkle")&&UIFigmaStyles.IntegraShine(layer),layer.text,id.includes("icon")&&UIFigmaStyles.IntegraIcon(layer,id)}}(),_this.unlocked=_nextLevelUnlocked}(),this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuad",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x,{blacklist:["next-level","next-level-button","icon-play"]}),$this.alpha=1;let alpha=_animation.x*(_nextLevelUnlocked?1:.5);_this.layers["next-level"].alpha=alpha,_this.layers["next-level-button"].alpha=alpha,_this.layers["icon-play"].alpha=alpha})},this.animateOut=function(){tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1}).onComplete(_=>{$this.hide()})},this.set("unlocked",state=>{_nextLevelUnlocked=state;let layer=_this.layers["next-level-button"];state?(_this.layers["next-level"].alpha=1,_this.layers["next-level-button"].alpha=1,_this.layers["icon-play"].alpha=1,_this.registerButton("IntegraButton",hover,click,layer)):(layer.clearInteract(),_this.layers["next-level"].alpha=.5,_this.layers["next-level-button"].alpha=.5,_this.layers["icon-play"].alpha=.5)}),this.set("label",async v=>{await _this.ready();let $label=_this.layers["your-time-label"];$label&&$label.setText(v)}),this.set("time",async v=>{await _this.ready();let $time=_this.layers["your-time-number"];$time&&$time.setText(v)}),this.set("header",async v=>{await _this.ready();let $header=_this.layers.header;$header&&($header.setText(v),await $header.text.ready())}),this.set("result",async v=>{await _this.ready();let $result=_this.layers["result-text"];$result&&($result.setText(v),await $result.text.ready(),tween($result,{alpha:1},250,"easeOutCubic"))}),this.set("color",state=>{let color="qualified"===state?_qualifiedColor:_disqualifiedColor,$time=_this.layers["your-time-number"];$time&&$time.setColor(color)}),this.set("topThree",async v=>{let[$1t,$1a,$2t,$2a,$3t,$3a]=[_this.layers["time-1"],_this.layers["initials-1"],_this.layers["time-2"],_this.layers["initials-2"],_this.layers["time-3"],_this.layers["initials-3"]];$1t.setText(Numbers.formatTime(v[0].score/1e3)),$2t.setText(Numbers.formatTime(v[1].score/1e3)),$3t.setText(Numbers.formatTime(v[2].score/1e3)),$1a.setText(v[0].username),$2a.setText(v[1].username),$3a.setText(v[2].username)})})),Class((function GameplayStateQualifiedNewNSX(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0),_qualifiedColor=new Color("#FFFFFF"),_disqualifiedColor=new Color("#FF2E00"),_nextLevelUnlocked=!1;function hover(e){}function click(e){let id=e.object.id;("next-level-button"!==id||_nextLevelUnlocked)&&_this.events.fire(Events.CLICK,{id:id})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level5_qualified"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];if(id.includes(["-button"])&&_this.registerButton("NewNSXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.NewNSXIcon(layer,id),id.includes("leader-board-box")&&UIFigmaStyles.NewNSXButton(layer),!id.includes("background")){let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}}(),_this.unlocked=_nextLevelUnlocked}(),this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuad",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x,{blacklist:["next-level","next-level-button","icon-play"]}),$this.alpha=1;let alpha=_animation.x*(_nextLevelUnlocked?1:.5);_this.layers["next-level"].alpha=_animation.x,_this.layers["next-level-button"].alpha=alpha,_this.layers["icon-play"].alpha=alpha})},this.animateOut=function(){tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1}).onComplete(_=>{$this.hide()})},this.set("unlocked",state=>{Config.TOTAL_LEVELS<=5&&(state=!1),_nextLevelUnlocked=state;let layer=_this.layers["next-level-button"],text=_this.layers["next-level"],icon=_this.layers["icon-play"];state?(layer.alpha=1,text.alpha=1,icon.alpha=1,_this.registerButton("NewNSXButton",hover,click,layer)):(layer.clearInteract(),layer.alpha=.5,text.alpha=.5,icon.alpha=.5)}),this.set("label",async v=>{await _this.ready();let $label=_this.layers["your-time-label"];$label&&$label.setText(v)}),this.set("time",async v=>{await _this.ready();let $time=_this.layers["your-time-number"];$time&&$time.setText(v)}),this.set("header",async v=>{await _this.ready();let $header=_this.layers.header;$header&&($header.setText(v),await $header.text.ready())}),this.set("result",async v=>{await _this.ready();let $result=_this.layers["result-text"];$result&&($result.setText(v),await $result.text.ready(),tween($result,{alpha:1},250,"easeOutCubic"))}),this.set("color",state=>{let color="qualified"===state?_qualifiedColor:_disqualifiedColor,$time=_this.layers["your-time-number"];$time&&$time.setColor(color)}),this.set("topThree",async v=>{let[$1t,$1a,$2t,$2a,$3t,$3a]=[_this.layers["time-1"],_this.layers["initials-1"],_this.layers["time-2"],_this.layers["initials-2"],_this.layers["time-3"],_this.layers["initials-3"]];$1t.setText(Numbers.formatTime(v[0].score/1e3)),$2t.setText(Numbers.formatTime(v[1].score/1e3)),$3t.setText(Numbers.formatTime(v[2].score/1e3)),$1a.setText(v[0].username),$2a.setText(v[1].username),$3a.setText(v[2].username)})})),Class((function GameplayStateQualifiedOldNSX(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0),_qualifiedColor=new Color("#FFF500"),_disqualifiedColor=new Color("#FF332D"),_nextLevelUnlocked=!1;function hover(e){}function click(e){let id=e.object.id;("next-level-button"!==id||_nextLevelUnlocked)&&_this.events.fire(Events.CLICK,{id:id})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level1_qualified"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];layer.text&&_this.applyStyle("OldNSXOutlineText",layer),id.includes(["-button"])&&_this.registerButton("OldNSXButton",hover,click,layer),id.includes("leader-board-bounding-box")&&_this.applyStyle("OldNSXOutlineBox",layer)}}(),_this.unlocked=_nextLevelUnlocked}(),this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuad",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x,{blacklist:["next-level","next-level-button","icon-play"]}),$this.alpha=1;let alpha=_animation.x*(_nextLevelUnlocked?1:.5);_this.layers["next-level"].alpha=1,_this.layers["next-level-button"].alpha=alpha,_this.layers["icon-play"].alpha=alpha}).onComplete(async _=>{_this.layers["next-level"].alpha=1})},this.animateOut=function(){tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1}).onComplete(_=>{$this.hide()})},this.set("unlocked",state=>{_nextLevelUnlocked=state;let layer=_this.layers["next-level-button"];state?(_this.layers["next-level"].alpha=1,_this.layers["next-level-button"].alpha=1,_this.layers["icon-play"].alpha=1,_this.registerButton("OldNSXButton",hover,click,layer)):(layer.clearInteract(),_this.layers["next-level"].alpha=1,_this.layers["next-level-button"].alpha=.5,_this.layers["icon-play"].alpha=.5)}),this.set("label",async v=>{await _this.ready();let $label=_this.layers["your-time-label"];$label&&$label.setText(v)}),this.set("time",async v=>{await _this.ready();let $time=_this.layers["your-time-number"];$time&&$time.setText(v)}),this.set("header",async v=>{await _this.ready();let $header=_this.layers.header;$header&&($header.setText(v),await $header.text.ready())}),this.set("result",async v=>{await _this.ready();let $result=_this.layers["result-text"];$result&&($result.setText(v),await $result.text.ready(),tween($result,{alpha:1},250,"easeOutCubic"))}),this.set("color",state=>{let color="qualified"===state?_qualifiedColor:_disqualifiedColor,$time=_this.layers["your-time-number"];$time&&$time.setColor(color)}),this.set("topThree",async v=>{let[$1t,$1a,$2t,$2a,$3t,$3a]=[_this.layers["time-1"],_this.layers["initials-1"],_this.layers["time-2"],_this.layers["initials-2"],_this.layers["time-3"],_this.layers["initials-3"]];$1t.setText(Numbers.formatTime(v[0].score/1e3)),$2t.setText(Numbers.formatTime(v[1].score/1e3)),$3t.setText(Numbers.formatTime(v[2].score/1e3)),$1a.setText(v[0].username),$2a.setText(v[1].username),$3a.setText(v[2].username)})})),Class((function GameplayStateQualifiedRDX(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0),_qualifiedColor=new Color("#62DF4E"),_disqualifiedColor=new Color("#F34144"),_nextLevelUnlocked=!1;function hover(e){}function click(e){let id=e.object.id;("next-level-button"!==id||_nextLevelUnlocked)&&_this.events.fire(Events.CLICK,{id:id})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level3_qualified"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button"])&&_this.registerButton("RDXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.RDXIcon(layer,id)}}(),_this.unlocked=_nextLevelUnlocked}(),this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuad",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x,{blacklist:["next-level","next-level-button","icon-play"]}),$this.alpha=1;let alpha=_animation.x*(_nextLevelUnlocked?1:.5);_this.layers["next-level"].alpha=alpha,_this.layers["next-level-button"].alpha=alpha,_this.layers["icon-play"].alpha=alpha})},this.animateOut=function(){tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1}).onComplete(_=>{$this.hide()})},this.set("unlocked",state=>{_nextLevelUnlocked=state;let layer=_this.layers["next-level-button"];state?(_this.layers["next-level"].alpha=1,_this.layers["next-level-button"].alpha=1,_this.layers["icon-play"].alpha=1,_this.registerButton("RDXButton",hover,click,layer)):(layer.clearInteract(),_this.layers["next-level"].alpha=.5,_this.layers["next-level-button"].alpha=.5,_this.layers["icon-play"].alpha=.5)}),this.set("label",async v=>{await _this.ready();let $label=_this.layers["your-time-label"];$label&&$label.setText(v)}),this.set("color",state=>{let color="qualified"===state?_qualifiedColor:_disqualifiedColor,$time=_this.layers["your-time-number"];$time&&$time.setColor(color)}),this.set("time",async v=>{await _this.ready();let $time=_this.layers["your-time-number"];$time&&$time.setText(v)}),this.set("header",async v=>{await _this.ready();let $header=_this.layers.header;$header&&($header.setText(v),await $header.text.ready())}),this.set("result",async v=>{await _this.ready();let $result=_this.layers["result-text"];$result&&($result.setText(v),await $result.text.ready(),tween($result,{alpha:1},250,"easeOutCubic"))}),this.set("topThree",async v=>{let[$1t,$1a,$2t,$2a,$3t,$3a]=[_this.layers["time-1"],_this.layers["initials-1"],_this.layers["time-2"],_this.layers["initials-2"],_this.layers["time-3"],_this.layers["initials-3"]];$1t.setText(Numbers.formatTime(v[0].score/1e3)),$2t.setText(Numbers.formatTime(v[1].score/1e3)),$3t.setText(Numbers.formatTime(v[2].score/1e3)),$1a.setText(v[0].username),$2a.setText(v[1].username),$3a.setText(v[2].username)})})),Class((function GameplayStateQualifiedTypeS(_name){Inherit(this,UIFigma);const _this=this;var $this,_animation=new Vector2(0,0),_qualifiedColor=new Color("#FFFFFF"),_disqualifiedColor=new Color("#FF2E00"),_nextLevelUnlocked=!1;function hover(e){}function click(e){let id=e.object.id;("next-level-button"!==id||_nextLevelUnlocked)&&_this.events.fire(Events.CLICK,{id:id})}!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level6_qualified"),function applyStyle(){for(let id in _this.layers){let layer=_this.layers[id];if(!id.includes("background")){let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}}(),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button"])&&_this.registerButton("TypeSButton",hover,click,layer),id.includes("leader-board-box")&&UIFigmaStyles.TypeSOutline(layer),id.includes("icon")&&UIFigmaStyles.TypeSIcon(layer,id)}}(),_this.unlocked=_nextLevelUnlocked}(),this.animateIn=function(){$this.alpha=1e-5,_animation.x=0,$this.show(),tween(_animation,{x:1},600,"easeOutQuad",100).onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x,{blacklist:["next-level","next-level-button","icon-play"]}),$this.alpha=1;let alpha=_animation.x*(_nextLevelUnlocked?1:.5);_this.layers["next-level"].alpha=_animation.x,_this.layers["next-level-button"].alpha=alpha,_this.layers["icon-play"].alpha=alpha})},this.animateOut=function(){tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{TransitionUtils.update(_this.layers,_animation.x),$this.alpha=1}).onComplete(_=>{$this.hide()})},this.set("unlocked",state=>{_nextLevelUnlocked=state;let layer=_this.layers["next-level-button"];state?(_this.layers["next-level"].alpha=1,_this.layers["next-level-button"].alpha=1,_this.layers["icon-play"].alpha=1,_this.registerButton("TypeSButton",hover,click,layer)):(layer.clearInteract(),_this.layers["next-level"].alpha=.5,_this.layers["next-level-button"].alpha=.5,_this.layers["icon-play"].alpha=.5)}),this.set("label",async v=>{await _this.ready();let $label=_this.layers["your-time-label"];$label&&$label.setText(v)}),this.set("time",async v=>{await _this.ready();let $time=_this.layers["your-time-number"];$time&&$time.setText(v)}),this.set("header",async v=>{await _this.ready();let $header=_this.layers.header;$header&&($header.setText(v),await $header.text.ready())}),this.set("result",async v=>{await _this.ready();let $result=_this.layers["result-text"];$result&&($result.setText(v),await $result.text.ready(),tween($result,{alpha:1},250,"easeOutCubic"))}),this.set("color",state=>{let color="qualified"===state?_qualifiedColor:_disqualifiedColor,$time=_this.layers["your-time-number"];$time&&$time.setColor(color)}),this.set("topThree",async v=>{let[$1t,$1a,$2t,$2a,$3t,$3a]=[_this.layers["time-1"],_this.layers["initials-1"],_this.layers["time-2"],_this.layers["initials-2"],_this.layers["time-3"],_this.layers["initials-3"]];$1t.setText(Numbers.formatTime(v[0].score/1e3)),$2t.setText(Numbers.formatTime(v[1].score/1e3)),$3t.setText(Numbers.formatTime(v[2].score/1e3)),$1a.setText(v[0].username),$2a.setText(v[1].username),$3a.setText(v[2].username)})})),Class((function GameplayStateTutorialUI(_name=Utils.query("level_id")){Inherit(this,GLUIElement);const _this=this;var $this,_view;const COPY={accelerate:{"optimal-racing":"Car will\nauto accelerate"},steer:{"brake-header":"Steering","brake-text":Device.mobile?"Tap and hold left or right to steer":"Press and hold left or right arrows to steer"},brake:{"brake-header":"Braking","brake-text":Device.mobile?"Hold down both areas to brake":"Press space bar to brake"},line:{"optimal-racing":"Find the optimal\nracing line"}},ICONS={steer:{desktop:["icon-keyboard-left","icon-keyboard-right"],mobile:["right-turn-icon","left-turn-icon","brake-left-hit","brake-right-hit"]},brake:{desktop:["icon-space-bar"],mobile:["brake-left-icon","brake-right-icon","brake-left-hit","brake-right-hit"]}};async function applyCopy(state){let tasks=[];for(let id in COPY[state]){let layer=_view.layers[id];layer.setText(COPY[state][id].toUpperCase()),tasks.push(layer.text.ready())}await Promise.all(tasks)}!async function(){!function initGL(){if($this=_this.element,Global.PLAYGROUND===_this.constructor.name){World.RENDERER.setClearColor("#666666",1);let steps=["Accelerate","Steer","Line","Brake"],i=-1;_this.events.sub(KeyboardUtil.PRESS,e=>32===e.keyCode?(steps[i]&&_this[`hide${steps[i]}`](),i++,i>steps.length-1&&(i=0),void(steps[i]&&_this[`show${steps[i]}`]())):null),defer(_=>{_this.animateIn(),GLUI.Stage.add($this)})}else $this.hide()}(),await async function initView(){let view="Debug";switch(_name){case"integra":view="Integra";break;case"rdx":view="RDX";break;case"arx":view="ARX";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:case"old_nsx":view="OldNSX"}view=`GameplayStateTutorial${view}`,_view=_this.initClass(window[view],_name),await _view.ready(),await defer()}(),function assignLayers(){for(let id in _view.layers){let layer=_view.layers[id],z=1;id&&id.includes("hit")&&(z=0),id&&id.includes("icon")&&(z=2),layer.setZ(z),layer.alpha=0}_view.accelerate=[],_view.steer=[],_view.brake=[],_view.optimal=[];for(let id of["icon-space-bar","icon-keyboard-left","icon-keyboard-right","brake-left-icon","brake-right-icon","right-turn-icon","left-turn-icon","brake-left-hit","brake-right-hit"])_view.layers[id].alpha=0;for(let id of["optimal-racing"])_view.accelerate[id]=_view.layers[id];let steer=["brake-header","brake-text"];for(let id of ICONS.steer[Device.mobile?"mobile":"desktop"])steer.push(id);for(let id of steer)_view.steer[id]=_view.layers[id];let brake=["brake-header","brake-text"];for(let id of ICONS.brake[Device.mobile?"mobile":"desktop"])brake.push(id);for(let id of brake)_view.brake[id]=_view.layers[id];for(let id of["optimal-racing"])_view.optimal[id]=_view.layers[id];_view.layers["right-turn-icon"].x=_view.layers["brake-right-icon"].x,_view.layers["right-turn-icon"].y=_view.layers["brake-right-icon"].y,_view.layers["right-turn-icon"].origin=new Vector2(_view.layers["right-turn-icon"]),_view.layers["left-turn-icon"].x=_view.layers["brake-left-icon"].x,_view.layers["left-turn-icon"].y=_view.layers["brake-left-icon"].y,_view.layers["left-turn-icon"].origin=new Vector2(_view.layers["left-turn-icon"])}()}(),this.animateIn=async function(){await _view.ready(),Global.PLAYGROUND===_this.constructor.name?GLUI.Stage.add($this):GLUI.Stage.GameLayer.add($this),$this.show(),_view.animateIn&&_view.animateIn()},this.animateOut=async function(){await _view.ready(),_view.animateOut&&_view.animateOut(),$this.hide()},this.showAccelerate=async function(){await applyCopy("accelerate"),_view.setVisibility(_view.accelerate,!0),await _this.wait(500)},this.hideAccelerate=function(){_view.setVisibility(_view.accelerate,!1)},this.showSteer=async function(){await applyCopy("steer"),_view.setVisibility(_view.steer,!0),await _this.wait(500)},this.hideSteer=function(){_view.setVisibility(_view.steer,!1)},this.showLine=async function(){await applyCopy("line"),_view.setVisibility(_view.optimal,!0),await _this.wait(500)},this.hideLine=function(){_view.setVisibility(_view.optimal,!1)},this.showBrake=async function(){await applyCopy("brake"),_view.setVisibility(_view.brake,!0),await _this.wait(500)},this.hideBrake=function(){_view.setVisibility(_view.brake,!1)},this.onDestroy=function(){$this.remove()}})),Class((function GameplayStateTutorialARX(){Inherit(this,UIFigma);const _this=this;var $this;!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level4_tutorial"),function formatHitAreas(){let layers=["right-turn-hit","left-turn-hit","brake-right-hit","brake-left-hit"];for(let id of layers){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialARXHit",{uColor:{value:new Color("#FF2E00")},uFill:{value:.75},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}let hits=["left-turn-icon","brake-left-icon","right-turn-icon","brake-right-icon"];for(let[i,id]of hits.entries()){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialIcon",{uDirection:{value:i<2?-1:1},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}}(),_this.flag("isReady",!0)}(),this.setVisibility=function(pattern,state){let delay=0;for(let id in pattern){let $layer=_this.layers[id];if($layer){if(state){let scale=$layer.scale;$layer.scale*=1.2,$layer.tween({alpha:1,scale:scale},1500,"easeOutQuart",200+delay)}else $layer.tween({alpha:0,scale:.94*$layer.scale},400,"easeOutCubic");delay+=100}}},this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()}})),Class((function GameplayStateTutorialDebug(){Inherit(this,GLUIElement);const _this=this;var $this,_layers;function resize(){}!async function(){!function initGL(){$this=_this.element,"GameplayStateTutorialDebug"!==Global.PLAYGROUND&&$this.hide()}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"GameplayStateTutorialDebug",{glui:!0}),_layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),await async function initLayers(){let tasks=[];for(let id in _layers){let layer=_layers[id];"background"===id?(layer.setZ(1),layer.alpha=.8):layer.setZ(2),layer.text&&tasks.push(layer.text.ready())}await Promise.all(tasks)}(),function addHandlers(){_this.onResize(resize)}(),_this.flag("isReady",!0)}()})),Class((function GameplayStateTutorialIntegra(){Inherit(this,UIFigma);const _this=this;var $this;!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level2_tutorial"),function formatHitAreas(){let layers=["right-turn-hit","left-turn-hit","brake-right-hit","brake-left-hit"];for(let id of layers){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialIntegraHit",{uColor:{value:new Color("#000000")},uFill:{value:.35},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}let hits=["left-turn-icon","brake-left-icon","right-turn-icon","brake-right-icon"];for(let[i,id]of hits.entries()){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialIcon",{uDirection:{value:i<2?-1:1},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}for(let id in _this.layers){let layer=_this.layers[id];layer.text&&id.includes(["brake-header","optimal-racing"])&&UIFigmaStyles.IntegraTitleText(layer)}}(),_this.flag("isReady",!0)}(),this.setVisibility=function(pattern,state){let delay=0;for(let id in pattern){let $layer=_this.layers[id];if($layer){if(state){let scale=$layer.scale;$layer.scale*=1.2,$layer.tween({alpha:1,scale:scale},1500,"easeOutQuart",200+delay)}else $layer.tween({alpha:0,scale:.94*$layer.scale},400,"easeOutCubic");delay+=100}}},this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()}})),Class((function GameplayStateTutorialNewNSX(){Inherit(this,UIFigma);const _this=this;var $this;!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level5_tutorial"),function formatHitAreas(){let layers=["right-turn-hit","left-turn-hit","brake-right-hit","brake-left-hit"];for(let id of layers){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialNewNSXHit",{uColor:{value:new Color("#FFBE41")},uDist:{value:.4},uWeight:{value:.01},uFeather:{value:.015},uGlow:{value:.25},uAlpha:{value:0},blending:Shader.ADDITIVE_BLENDING,transparent:!0});$layer.useShader(shader)}let hits=["left-turn-icon","brake-left-icon","right-turn-icon","brake-right-icon"];for(let[i,id]of hits.entries()){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialIcon",{uDirection:{value:i<2?-1:1},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}for(let id in _this.layers){let layer=_this.layers[id],shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}(),_this.flag("isReady",!0)}(),this.setVisibility=function(pattern,state){let delay=0;for(let id in pattern){let $layer=_this.layers[id];if($layer){if(state){let scale=$layer.scale;$layer.scale*=1.2,$layer.tween({alpha:1,scale:scale},1500,"easeOutQuart",200+delay)}else $layer.tween({alpha:0,scale:.94*$layer.scale},400,"easeOutCubic");delay+=100}}},this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()}})),Class((function GameplayStateTutorialOldNSX(){Inherit(this,UIFigma);const _this=this;var $this;!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level1_tutorial"),function formatHitAreas(){let layers=["right-turn-hit","left-turn-hit","brake-right-hit","brake-left-hit"];for(let id of layers){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialOldNSXHit",{uColor:{value:new Color("#FFF500")},uFill:{value:.35},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}let hits=["left-turn-icon","brake-left-icon","right-turn-icon","brake-right-icon"];for(let[i,id]of hits.entries()){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialIcon",{uDirection:{value:i<2?-1:1},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}}(),_this.flag("isReady",!0)}(),this.setVisibility=function(pattern,state){let delay=0;for(let id in pattern){let $layer=_this.layers[id];if($layer){if(state){let scale=$layer.scale;$layer.scale*=1.2,$layer.tween({alpha:1,scale:scale},1500,"easeOutQuart",200+delay)}else $layer.tween({alpha:0,scale:.94*$layer.scale},400,"easeOutCubic");delay+=100}}},this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()}})),Class((function GameplayStateTutorialRDX(){Inherit(this,UIFigma);const _this=this;var $this;!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level3_tutorial"),function formatHitAreas(){let layers=["right-turn-hit","left-turn-hit","brake-right-hit","brake-left-hit"];for(let id of layers){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialRDXHit",{uColor:{value:new Color("#62DF4E")},uFill:{value:.35},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}let hits=["left-turn-icon","brake-left-icon","right-turn-icon","brake-right-icon"];for(let[i,id]of hits.entries()){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialIcon",{uDirection:{value:i<2?-1:1},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}}(),_this.flag("isReady",!0)}(),this.setVisibility=function(pattern,state){let delay=0;for(let id in pattern){let $layer=_this.layers[id];if($layer){if(state){let scale=$layer.scale;$layer.scale*=1.2,$layer.tween({alpha:1,scale:scale},1500,"easeOutQuart",200+delay)}else $layer.tween({alpha:0,scale:.94*$layer.scale},400,"easeOutCubic");delay+=100}}},this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()}})),Class((function GameplayStateTutorialTypeS(){Inherit(this,UIFigma);const _this=this;var $this;!async function(){!function initGL(){($this=_this.element).hide()}(),await _this.initLayout("level6_tutorial"),function formatHitAreas(){let layers=["right-turn-hit","left-turn-hit","brake-right-hit","brake-left-hit"];for(let id of layers){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialTypeSHit",{uColor:{value:new Color("#92F2FF")},uDist:{value:.4},uWeight:{value:.005},uFeather:{value:.025},uGlow:{value:.25},uAlpha:{value:0},blending:Shader.ADDITIVE_BLENDING,transparent:!0});$layer.useShader(shader)}let hits=["left-turn-icon","brake-left-icon","right-turn-icon","brake-right-icon"];for(let[i,id]of hits.entries()){let $layer=_this.layers[id],shader=_this.initClass(Shader,"TutorialIcon",{uDirection:{value:i<2?-1:1},uAlpha:{value:0},transparent:!0});$layer.useShader(shader)}for(let id in _this.layers){let layer=_this.layers[id],shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}(),_this.flag("isReady",!0)}(),this.setVisibility=function(pattern,state){let delay=0;for(let id in pattern){let $layer=_this.layers[id];if($layer){if(state){let scale=$layer.scale;$layer.scale*=1.2,$layer.tween({alpha:1,scale:scale},1500,"easeOutQuart",200+delay)}else $layer.tween({alpha:0,scale:.94*$layer.scale},400,"easeOutCubic");delay+=100}}},this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()}})),Class((function GameplayCollision(_name,_car,_track){Inherit(this,Component);const _this=this;var _thread,_controls;const UP=new Vector3(0,1,0);var _normal=new Vector3,_quaternion=new Quaternion,_euler=new Euler,_vec=new Vector3;function loop(){if(!_car.center)return;let center=_car.center.getWorldPosition(),bounding=_car.bounding,nose=_car.nose.getWorldPosition(),step=_car.collisionStep;_thread.hitTest({center:center,bounding:bounding,nose:nose,step:step},getCollisionData)}function getCollisionData({normal:normal,point:point,linePoint:linePoint,lineRotate:lineRotate,lineDistance:lineDistance,linePercent:linePercent,colliding:colliding,visualLineDistance:visualLineDistance}){if(_car.group&&_car.group.position)if(_this.visualLineDistance=visualLineDistance||0,_this.lineDistance=lineDistance||0,_this.linePercent=linePercent||0,point&&(_car.group.position.y=point.y),_this.incline=0,colliding){if(normal){_normal.copy(normal),_quaternion.setFromUnitVectors(UP,_normal.applyQuaternion(_car.group.quaternion)),_euler.setFromQuaternion(_quaternion);let direction=Math.abs(Math.degrees(_car.group.rotation.y))%360;direction>75&&direction<120&&(_euler.x=-_euler.x),direction>250&&direction<290&&(_euler.x=-_euler.x),_euler.x<0&&(_this.incline=Math.range(Math.degrees(_euler.x),-10,0,1.35,0,!0)),_car.car.group.rotation.lerp(_euler,.2)}}else if(lineRotate){_vec.set(lineRotate.x,lineRotate.y,lineRotate.z);let center=_car.center.getWorldPosition(),angle=180*Math.atan2(_vec.x-center.x,_vec.z-center.z)/Math.PI;_vec.set(linePoint.x,linePoint.y,linePoint.z),_controls.applyCollisionForce(_vec,angle,lineDistance,visualLineDistance)}}this.lineDistance=0,this.linePercent=0,this.incline=0,async function(){await async function initThread(){GameplayCollision.sharedThread?_thread=GameplayCollision.sharedThread:(_thread=new Thread(GameplayCollisionThread),Utils3D.loadEngineOnThread(_thread),Curve.loadOnThread(_thread),_thread.importClass(LinkedList),GameplayCollision.sharedThread=_thread);let mesh=await _track.getMesh(),{position:position,normal:normal}=mesh.geometry.attributes,pos=new Float32Array(position.array),n=new Float32Array(normal.array);if(_thread.init({position:pos,normal:n},[pos.buffer,n.buffer]),await _track.useGeneratedLine()){let array=await _track.getLineArray();_thread.loadVisualLine({array:array})}let lineJSON=await _track.getLineJSONPath();lineJSON&&_thread.loadLine({json:Thread.absolutePath(Assets.getPath(lineJSON))});_this.flag("hasLineJSON",!0)}(),_this.startRender(loop)}(),this.set("controls",c=>_controls=c),this.findTutorialStart=async function(pos){return await _this.wait("hasLineJSON"),_thread.findTutorialStart({pos:pos})}})),Class((function GameplayCollisionThread(){var _geom,_ray,_dir,_mesh,_line,_visualLine;function findClosestPointToLine(c,line=_line){let p=line.start(),closest=p;for(;p;){p.distance=0;let dx=p.x-c.x,dy=p.y-c.y,dz=p.z-c.z,distance=dx*dx+dy*dy+dz*dz;distance<closest.distance&&(closest=p),p.distance=distance,p=line.next()}return!!closest&&{distance:closest.distanceTo(c),percent:closest.percent,p:closest}}function findNextPercentPoint(percent,line=_line){let p=line.start();for(;p;){if(p.percent>percent&&p.percent-percent<.01)return p;p=line.next()}}this.init=function({position:position,normal:normal}){(_geom=new Geometry).addAttribute("position",new GeometryAttribute(position,3)),_geom.addAttribute("normal",new GeometryAttribute(normal,3)),_geom.addAttribute("uv",new GeometryAttribute(new Float32Array(position.length/3*2),2)),_geom.computeBoundingSphere(),_geom.computeBoundingBox(),_mesh=new Mesh(_geom,{side:Shader.FRONT_SIDE}),_ray=new RayManager,_dir=new Vector3(0,-1,0)},this.hitTest=function({center:center,nose:nose,bounding:bounding,step:step=.001},id){_ray.set(center,_dir,0,Number.POSITIVE_INFINITY);let[hit]=_ray.intersectObject(_mesh),obj={};if(_line){let line=findClosestPointToLine(nose,_line),visual=findClosestPointToLine(nose,_visualLine);if(line){let p1=findNextPercentPoint(line.percent+step,_line);if(p1||(p1=findNextPercentPoint(line.percent-step,_line)),!p1)return;obj.linePoint={x:line.p.x,y:line.p.y,z:line.p.z},obj.lineRotate={x:p1.x,y:p1.y,z:p1.z},obj.lineDistance=line.distance,obj.linePercent=line.percent,obj.visualLineDistance=visual.distance}}if(hit){obj.normal=hit.face.normal,obj.point=hit.point,obj.boxMisses=[],obj.angle=0;for(let i=0;i<bounding.length;i++){_ray.set(bounding[i],_dir,0,Number.POSITIVE_INFINITY);let[miss]=_ray.intersectObject(_mesh);miss||obj.boxMisses.push(i)}}obj.colliding=!(obj.boxMisses&&obj.boxMisses.length>0||!hit),resolve(obj,id)},this.loadLine=function({json:json}){!async function initLine(json){_line=new LinkedList;let data=await get(json),curve=new Curve(data);for(let i=0;i<5e3;i++){let p=curve.getPointAt(i/5e3);p.percent=1-i/5e3,_line.push(p)}}(json)},this.loadVisualLine=function({array:array}){!function initLineFromArray(data){_visualLine=new LinkedList;let curve=new Curve(data);for(let i=0;i<5e3;i++){let p=curve.getPointAt(i/5e3);p.percent=1-i/5e3,_visualLine.push(p)}}(array)},this.findTutorialStart=function({pos:pos},id){let p0=findClosestPointToLine(pos),p1=findNextPercentPoint(p0.percent);resolve({position:(new Vector3).copy(p0.p),lookAt:(new Vector3).copy(p1)},id)}})),Class((function GameplayTrack(_name=Utils.query("name")){Inherit(this,Object3D);const _this=this;var _layout,_racingLine;!async function(){_layout=_this.initClass(SceneLayout,`track_${_name}`),_racingLine=_this.initClass(GameplayTrackRacingLine,_name),_this.racingLine=_racingLine;let[track,line]=await _layout.getLayers("track","line");line.group.position.y=.5,track.shader.receiveShadow=!0}(),this.getMesh=async function(){await _layout.ready();let name="hitMesh";return _layout.exists(name)||(console.warn(`Track ${_name} missing hitMesh -- add one for optimization. Falling back to track mesh`),name="track"),_layout.getLayer(name)},this.getTrackMesh=function(){return _layout.getLayer("track")},this.getTutorialStart=function(){return _layout.getLayer("tutorial_start")},this.getLineJSONPath=async function(){return(await _layout.getLayer("line")).getJSONPath()},this.getLine=function(){return _layout.getLayer("line")},this.loaded=async function(sync){return await _racingLine.ready(),Initializer3D.detectUploadAll(_layout,sync)},this.useGeneratedLine=async function(){return await _racingLine.ready(),!_racingLine.noData},this.getLineArray=async function(){return await _racingLine.ready(),_racingLine.curvePoints}})),Class((function GameplayTrackRacingLine(_name){Inherit(this,Object3D);const _this=this;var _shader,_target=0;function loop(){_shader.uniforms.uAccuracy.value=Math.lerp(_target,_shader.uniforms.uAccuracy.value,.07)}function updateLine(val){_target=val}!async function(){let data;try{data=await Data.Leaderboard.getTopGhost(Data.getTrackNumberByName(_name))}catch(e){return _this.flag("loaded",!0),_this.noData=!0}let frames=data.length/7,points=[];for(let i=0;i<frames;i++){let x=Number(data[7*i+0]),y=Number(data[7*i+1]),z=Number(data[7*i+2]);points.push([x,y,z])}_this.curvePoints=points;let extrude=await Thread.shared().generateRacingLineGeom({points:points,name:_name}),geom=new Geometry;geom.addAttribute("position",new GeometryAttribute(extrude.position,3)),geom.addAttribute("uv",new GeometryAttribute(extrude.uv,2));let gameplay=_this.findParent("Gameplay");_shader=_this.initClass(Shader,"RacingLineShader",{unique:_name,tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uAlpha:{value:1},uSpeed:{value:1},uScale:{value:100},uAccuracy:{value:0},uHide:{value:1,ignoreUIL:!0},uPos:{value:gameplay.cars.player.group.position,ignoreUIL:!0},uVisibility:{value:new Vector2(50,10)},uVisMultiplier:{value:0,ignoreUIL:!0},uTint:{value:new Color},transparent:!0}),ShaderUIL.add(_shader);let mesh=new Mesh(geom,_shader);_this.add(mesh),mesh.position.y=.005;let map=_shader.get("tMap");map&&(map.anisotropy=World.RENDERER.getMaxAnisotropy()),gameplay.state.bind("line",updateLine),_this.startRender(loop),_shader.set("uHide",0),_this.flag("loaded",!0)}(),this.ready=async function(sync){return await _this.wait("loaded"),Initializer3D.detectUploadAll(_this.group,sync)},this.hide=function(){_shader&&(_shader.set("uHide",0),_shader.set("uVisMultiplier",0))},this.displayNormal=function(delay){_shader&&(_shader.tween("uHide",1,1e3,"easeOutSine",delay),_shader.tween("uVisMultiplier",0,1e3,"easeOutSine",delay))},this.displayAll=function(){_shader&&(_shader.tween("uHide",1,1e3,"easeOutSine"),_shader.tween("uVisMultiplier",1,1e3,"easeOutSine"))}}),_=>{Thread.upload((function generateRacingLineGeom({points:points,name:name},id){let curve=new Curve(points),extrudeSettings={steps:200,bevelEnabled:!1,extrudePath:curve.curve},pts=[new Vector2(0,.5),new Vector2(0,-.5)],shape=new Shape(pts),geom=new ExtrudeGeometry(shape,extrudeSettings),position=geom.attributes.position.array,uv=geom.attributes.uv.array,count=geom.attributes.uv.count,spline=new LinkedList;for(let i=0;i<500;i++){let p=curve.getPoint(i/500);p.index=i/500,spline.push(p)}let v=new Vector3,findClosest=v=>{let point,dist=999999,p=spline.start();for(;p;){let ndist=v.distanceToSquared(p);ndist<dist&&(point=p,dist=ndist),p=spline.next()}return point};for(let i=0;i<count;i++){v.set(position[3*i+0],position[3*i+1],position[3*i+2]);let point=findClosest(v);uv[2*i+1]=point.index}resolve({position:position,uv:uv},id,[position.buffer,uv.buffer])}))}),Class((function GameplayUI(_name=Utils.query("level_id")){Inherit(this,GLUIElement);const _this=this,IS_PLAYGROUND=Global.PLAYGROUND===_this.constructor.name;var $this,_view,_offset=new Vector2;function onOnline(){_view.resize()}function onPauseHover(e){let layer=e.object;switch(e.action){case"over":tween(layer,{alpha:.9,scale:1.07,hover:1},150,"easeOutBack");break;case"out":tween(layer,{alpha:1,scale:1,hover:0},400,"easeOutBack")}}function onPauseClick(){_this.findParent("Gameplay").gameState.pause()}async function onReset(){await Data.ready();let ghost=await Data.getGhost();_view.timeToBeat=ghost?ghost.score/1e3:Qualifying[_name].time}function onAcceleration(v){_offset.y=500*v}function onLapTime(v){_view.time=v}function onMPH(v){_view.mph=v}function onRPM(v){_view.rpm=v}function onLeft(v){_offset.x=3*v}function onRight(v){_offset.x=-3*v}function onGear(v){_view.gear=v}function loop(){UIConfig.gameOffset(_offset)}!async function(){!function initHTML(){$this=_this.element,IS_PLAYGROUND?($this.hide(),World.RENDERER.setClearColor("#222222",1),GLUI.Stage.add($this)):($this.hide(),_this.wait(GLUI.Stage,"GameLayer").then(_=>{GLUI.Stage.GameLayer.add($this)}))}(),await async function initLayout(){let view="";if(Utils.query("debugUI"))view="Debug";else switch(_name){case"old_nsx":view="OldNSX";break;case"integra":view="Integra";break;case"rdx":view="RDX";break;case"arx":view="Arx";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:view="FigmaTest"}view=`GameplayUI${view}`,_view=_this.initClass(window[view],_name),$this.add(_view.element),await _view.ready(),"GameplayUI"==Global.PLAYGROUND&&_this.show()}(),await function addHandlers(){!async function applyBindings(){if(onReset(),IS_PLAYGROUND)return;_this.events.sub(GameplayMultiplayer.ONLINE,onOnline),_view.pause.interact(onPauseHover,onPauseClick),_this.events.sub(Gameplay.RESET,onReset),_this.parent.state.bind("lapTime",onLapTime),_this.parent.state.bind("deltaAcceleration",onAcceleration),_this.parent.state.bind("mph",onMPH),_this.parent.state.bind("rpm",onRPM),_this.parent.state.bind("left",onLeft),_this.parent.state.bind("right",onRight),_this.parent.state.bind("gear",onGear),_this.startRender(loop)}()}()}(),this.hide=async function(){$this.tween({alpha:1e-5},500,"easeOutCubic"),_view.animateOut&&await _view.animateOut(),$this.hide()},this.show=async function(){$this.show(),_view.animateIn&&_view.animateIn(),$this.tween({alpha:1},250,"easeOutCubic")},this.onDestroy=function(){$this.remove()}})),Class((function GameplayUIArx(_name){Inherit(this,GameplayUIView);const _this=this;var H_EDGE,V_EDGE,WIDTH,HEIGHT,SCALE,$this,_layout,_layers,_map,_speedometer,_animation=new Vector2(0,0);function updateMap(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let player=gameplay.cars.player.group,ghost=!!gameplay.cars.ghost&&gameplay.cars.ghost.group;_map.x=player.position.x,_map.y=player.position.z,ghost?(_map.ghostX=ghost.position.x,_map.ghostY=ghost.position.z):_map.ghostX=9999,_map.rotation=Math.degrees(player.rotation.y)}function updateSpeedometer(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let speed=gameplay.controls.acceleration;_speedometer.speed=speed}function positionRelativeTo($a,$b){$a.x=$b.x+($a.origin.x-$b.origin.x),$a.y=$b.y+($a.origin.y-$b.origin.y)}function resize(){!function scale(){const height=Config.UI_SCALE;SCALE=Stage.height/height,HEIGHT=height,WIDTH=Stage.width/Stage.height*HEIGHT,H_EDGE=30*SCALE,V_EDGE=20*SCALE,$this.scale=SCALE}(),function map(){_map.element.x=H_EDGE,_map.element.y=HEIGHT-V_EDGE-_map.scale-15+Math.range(_animation.x,0,1,.2*Stage.height,0,!0)}(),function speedometer(){_speedometer.element.x=WIDTH-H_EDGE-.85*_speedometer.width,_speedometer.element.y=HEIGHT-V_EDGE-.9*_speedometer.height+Math.range(_animation.x,0,1,.2*Stage.height,0,!0);let label=_layers["speed-label"],number=_layers["speed-number"];label.x=WIDTH-H_EDGE-60,label.y=HEIGHT-V_EDGE-34+Math.range(_animation.x,0,1,.2*Stage.height,0,!0),positionRelativeTo(number,label)}(),function pause(){let pause=_layers.pause,x=Global.ONLINE?H_EDGE-(pause.width+H_EDGE):H_EDGE;x-=Math.range(_animation.x,0,1,.2*Stage.width,0,!0),pause.x=H_EDGE,pause.y=V_EDGE,pause.scale=Global.ONLINE?0:1}(),function level(){let pause=_layers.pause,label=_layers["level-label"],number=_layers["level-number"],labelBox=_layers["level-label-box"],box=_layers["level-box"];positionRelativeTo(label,pause),positionRelativeTo(number,pause),positionRelativeTo(labelBox,pause),positionRelativeTo(box,pause)}(),function timer(){let label=_layers["your-time-label"],number=_layers["your-time-number"],labelBox=_layers["your-time-label-box"];labelBox.x=.425*WIDTH-5,labelBox.y=V_EDGE-Math.range(_animation.x,0,1,.2*Stage.height,0,!0),positionRelativeTo(number,labelBox),positionRelativeTo(label,labelBox),label.y+=3}(),function beat(){let label=_layers["beat-that-label"],number=_layers["beat-that-number"],labelBox=_layers["beat-that-label-box"];labelBox.x=WIDTH-H_EDGE-labelBox.width,labelBox.y=V_EDGE-Math.range(_animation.x,0,1,.2*Stage.height,0,!0),positionRelativeTo(label,labelBox),positionRelativeTo(number,labelBox)}(),function closed(){let label=_layers["closed-course"];label.x=.5*WIDTH,label.y=HEIGHT-2*V_EDGE,label.alpha=0,label.scale=0}()}!async function(){!function initGL(){$this=_this.element}(),await async function initLayout(){_layout=_this.initClass(StageLayout,"level4",{glui:!0}),_layers=await _layout.getAllLayers();let tasks=[];for(let id in _layers){let layer=_layers[id];if(layer.origin=new Vector2(layer.x,layer.y),layer.text){let str=layer.text.string?layer.text.string:"";str=str.toUpperCase(),layer.setText(str),tasks.push(layer.text.ready())}id.includes("lap-")&&(layer.alpha=0)}await Promise.all(tasks);for(let id of["bg-placeholder","map","countdown-number","speed-dial"])_layers[id].alpha=0;$this.add(_layout.element)}(),await TransitionUtils.initUIShaders(_layers,_name,{blacklist:["speed-dial","speed-label-box"],params:{tMask:{value:Utils3D.getRepeatTexture("assets/images/transitions/arx.png")}}}),function initMap(){_map=_this.initClass(GameplayUIArxMap,_name),_this.startRender(updateMap)}(),function initSpeedometer(){_speedometer=_this.initClass(GameplayUIArxSpeedometer),_this.startRender(updateSpeedometer)}(),function initCheckpoint(){let $timer=_layers["your-time-number"],$label=_layers["your-time-label"];_this.initClass(GameplayUICheckpoint,$timer,$label)}(),function addHandlers(){(function exposeInputs(){_this.speedometer=_layers["speed-number"],_this.currentStage=_layers["level-number"],_this.currentTime=_layers["your-time-number"],_this.beatTime=_layers["beat-that-number"],_this.pauseButton=_layers.pause})(),_this.onResize(resize)}(),_this.isReady=!0}(),this.resize=_=>resize(),this.onRPM=function(v){_speedometer.rpm=v},this.animateIn=function(){$this.alpha=0,$this.x=.02*-Stage.width,$this.y=.02*-Stage.height;let scale=$this.scale;$this.scale*=1.04,$this.tween({alpha:1,scale:scale,x:0,y:0},2e3,"easeOutQuart"),_animation.x=0,tween(_animation,{x:1},2e3,"easeOutQuart").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x,{blacklist:["lap-label-box","lap-slash","lap-total-count","lap-count","lap-label","lap-box"]}),$this.alpha=1})},this.animateOut=function(){return tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x,{blacklist:["lap-label-box","lap-slash","lap-total-count","lap-count","lap-label","lap-box"]})}).promise()}})),Class((function GameplayUIArxMap(_name){Inherit(this,GLUIElement);const _this=this,SCALE=95,ZOOM=4,WORLD_TO_MAP_SCALE=2/ZOOM*.0013,NAME=_name||"arx";var $this,$rotate,$map,$player,$decor,_shader,_player=new Vector2(.5,.5),_ghost=new Vector2(.5,.5),_x=.5,_y=.5,_gx=.5,_gy=.5,_rotation=0;function applyPosition(){let s=WORLD_TO_MAP_SCALE;_player.set(.5+_x*s,.5-_y*s),_ghost.set(.5+_gx*s,.5-_gy*s),$rotate.rotation=180-_rotation}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),World.RENDERER.setClearColor("#666666",1),_this.startRender(_=>_this.y+=.1),_this.onResize(_=>{$this.x=.5*(Stage.width-SCALE),$this.y=.5*(Stage.height-SCALE)}))}(),function initRotate(){($rotate=$this.create(0,0)).x=.5*SCALE,$rotate.y=.5*SCALE}(),function initMap(){($map=$rotate.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg")).x=.5*-SCALE,$map.y=.5*-SCALE,_shader=_this.initClass(Shader,"GameplayUIArxMap",{uPlayerColor:{value:new Color("#62DF4E")},uGhostColor:{value:new Color("#ff0000")},uTrackColor:{value:new Color("#00ffff")},tMapMask:{value:Utils3D.getTexture(`${GenerateMaps.PATH}${NAME}.png`)},tMask:{value:Utils3D.getRepeatTexture("assets/images/transitions/arx.png")},uPlayerPosition:{value:_player},uGhostPosition:{value:_ghost},uZoom:{value:ZOOM},transparent:!0}),$map.useShader(_shader)}(),function initPlayer(){($player=$this.create(12,12,"assets/images/maps/decor/arx/player.png")).x=.5*SCALE-6,$player.y=.5*SCALE-6,$player.setZ(2)}(),function initDecor(){let size=1.4*SCALE;($decor=$rotate.create(size,size,"assets/images/maps/decor/arx/border.png")).rotation=180,$decor.x=.5*size,$decor.y=.5*size,$decor.setZ(2)}(),applyPosition(),this.get("x",_=>_x),this.get("y",_=>_y),this.get("ghostX",_=>_gx),this.get("ghostY",_=>_gy),this.get("rotation",_=>_rotation),this.get("scale",_=>SCALE),this.set("x",v=>{_x=v,applyPosition()}),this.set("y",v=>{_y=v,applyPosition()}),this.set("rotation",v=>{_rotation=v,applyPosition()}),this.set("ghostX",v=>{_gx=v,applyPosition()}),this.set("ghostY",v=>{_gy=v,applyPosition()}),this.set("alpha",v=>{$map.alpha=v,$decor.alpha=v,$player.alpha=v})})),Class((function GameplayUIArxSpeedometer(){Inherit(this,GLUIElement);const _this=this,SCALE=175;var $this,$meter,$dial,$rotation,_shader,_values=new Vector2,_display=new Vector2;function loop(){_display.lerp(_values,.15),_shader.set("uValue",1-_display.y);let angle=Math.range(_display.x,0,1,130,-20);$rotation.rotation=angle}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),_this.startRender(t=>{let speed=Math.range(Math.sin(.001*t),-1,1,0,1);_this.speed=speed,_this.rpm=(1-speed)%.25*4}))}(),function initMeter(){$meter=$this.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg"),_shader=_this.initClass(Shader,"GameplayUIArxSpeedometer",{uMax:{value:new Color("#FF2E00")},uFill:{value:new Color("#FFFFFF")},tMeter:{value:Utils3D.getTexture("assets/images/speedometers/arx/speedometer.png")},tMask:{value:Utils3D.getRepeatTexture("assets/images/transitions/arx.png")},uValue:{value:0},transparent:!0}),$meter.useShader(_shader)}(),function initDial(){($rotation=$this.create(0,0)).x=.5*SCALE,$rotation.y=.5*SCALE;let height=.245*SCALE,width=height*(72/347);($dial=$rotation.create(width,height,"assets/images/speedometers/arx/dial.png")).x=.5*-width,$dial.y=.9*-height}(),_this.startRender(loop),this.set("speed",v=>{_values.x=v}),this.set("rpm",v=>{_values.y=v}),this.get("width",_=>SCALE),this.get("height",_=>SCALE),this.set("alpha",alpha=>{$meter.alpha=alpha,$dial.alpha=alpha})})),Class((function GameplayUICheckpoint($timer,$label){Inherit(this,GLUIElement);const _this=this;var _data=[];async function render(delta){if(!$timer||!$label)return;_this.parent.currentTime=!1;let originalColor=$timer.mesh.shader.uniforms.uColor.value.getHexString();$timer.setText(Numbers.formatTime(delta/1e3)),$label.setText("SPLIT TIME"),$timer.mesh.shader.set("uColor",new Color(delta>0?"#ff0000":"#00ff00")),await async function blink(n=0){for(;n>0;)await flash(),n--}(3),_this.parent.currentTime=$timer,$label.setText("YOUR TIME"),$timer.mesh.shader.set("uColor",new Color(originalColor))}async function flash(){await _this.wait(250),$timer.alpha=0,await _this.wait(250),$timer.alpha=1}function onCheckpoint({index:index}){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let currentTime=gameplay.state.get("lapTimeUnformatted"),checkpointTime=_data[index];checkpointTime&&render(currentTime-checkpointTime)}!function initGL(){_this.element}(),async function initData(){let gameplay=_this.findParent("Gameplay");try{if(!gameplay)return;Data.getTrackNumberByName(gameplay.name);let ghost=await Data.getGhost();_data=ghost&&ghost.checkpoints?JSON.parse(ghost.checkpoints):Qualifying[gameplay.name].splits}catch(e){}}(),function addHandlers(){_this.events.sub(GameplayCheckpoints.TRIGGER,onCheckpoint)}()})),Class((function GameplayUIView(){Inherit(this,GLUIElement);const _this=this;this.set("stage",v=>{_this.currentStage&&_this.currentStage.setText(v),_this.onCurrentStage&&_this.onCurrentStage(v)}),this.set("mph",v=>{_this.speedometer&&_this.speedometer.setText(v),_this.onMPH&&_this.onMPH(v)}),this.set("rpm",v=>{_this.rpmMeter&&_this.rpmMeter.setText(v),_this.onRPM&&_this.onRPM(v)}),this.set("time",v=>{let time=Numbers.formatTime(parseFloat(v));_this.currentTime&&_this.currentTime.setText(time),_this.onTime&&_this.onTime(parseFloat(v))}),this.set("timeToBeat",v=>{_this.beatTime&&_this.beatTime.setText(Numbers.formatTime(v)),_this.onBeatTime&&_this.onBeatTime(v)}),this.get("pause",_=>_this.pauseButton?_this.pauseButton:{interact:_=>{}}),this.getShader=function($layer){return $layer.shader?$layer.shader:$layer.mesh&&$layer.mesh.shader?$layer.mesh.shader:null},this.ready=function(){return _this.wait(_this,"isReady")}})),Class((function GameplayUIDebug(){Inherit(this,GameplayUIView);const _this=this;var $this;!function initGL(){var $time,$laps,$mph,$rpm,$gear,$line;$this=_this.element,$time=$glText("Time: $(lapTime)","HelveticaNeue-Medium",24,{color:"#ffffff"}),$laps=$glText("Laps: $(currentLap) / $(totalLaps)","HelveticaNeue-Medium",24,{color:"#ffffff"}),$mph=$glText("MPH: $(mph)","HelveticaNeue-Medium",24,{color:"#ffffff"}),$rpm=$gl(200,10,"#ff0000"),$gear=$glText("Gear: $(gear)","HelveticaNeue-Medium",24,{color:"#ffffff"}),$line=$glText("Line: $(line)","HelveticaNeue-Medium",24,{color:"#ffffff"}),_this.findParent("Gameplay").state.bind("lapTime",$time),_this.findParent("Gameplay").state.bind("mph",$mph),_this.findParent("Gameplay").state.bind("gear",$gear),_this.findParent("Gameplay").state.bind("line",$line),_this.findParent("Gameplay").state.bind(["currentLap","totalLaps"],$laps),_this.findParent("Gameplay").state.bind("rpm",{onStateChange:val=>{$rpm.scaleX=val}}),$this.add($time),$this.add($laps),$this.add($mph),$this.add($rpm),$this.add($gear),$this.add($line),$laps.y=40,$mph.y=80,$rpm.y=130,$gear.y=160,$line.y=200}(),_this.isReady=!0})),Class((function GameplayUIFigmaTest(_name){Inherit(this,GameplayUIView);const _this=this,EDGE=26;var $this,_layout,_layers,_map,_speedometer;function updateMap(){let player=_this.findParent("Gameplay").cars.player.group,ghost=!!_this.findParent("Gameplay").cars.ghost&&_this.findParent("Gameplay").cars.ghost.group;_map.x=player.position.x,_map.y=player.position.z,ghost?(_map.ghostX=ghost.position.x,_map.ghostY=ghost.position.z):_map.ghostX=9999,_map.rotation=Math.degrees(player.rotation.y)}function updateSpeedometer(){let speed=_this.findParent("Gameplay").controls.acceleration;_speedometer.speed=speed}function resize(){!function map(){let el=_layers.map;el.x=EDGE,el.y=Stage.height-el.height-EDGE,el.alpha=0,_map.element.x=el.x+.5*el.width-.5*_map.scale,_map.element.y=el.y+.5*el.height-.5*_map.scale}(),function pause(){let el=_layers.pause;el.x=EDGE,el.y=EDGE}(),function stage(){let[pause,stage]=[_layers.pause,_layers["stage-number"]];stage.x=pause.x+pause.width+10,stage.y=pause.y+.5*(pause.height-28)}(),async function elapsed(){let[label,number]=[_layers.elapsed,_layers["elapsed-time"]];await label.text.ready(),label.x=.5*Stage.width,label.y=EDGE,number.x=.5*Stage.width,number.y=label.y+label.dimensions.height+5}(),async function beat(){let[label,number]=[_layers["to-beat"],_layers["to-beat-time"]];await label.text.ready(),label.x=Stage.width-EDGE,label.y=EDGE,number.x=Stage.width-EDGE,number.y=label.y+label.dimensions.height+5}(),async function speedometer(){let[shape,number,label]=[_layers.odometer,_layers["speed-number"],_layers.mph];shape.x=Stage.width-shape.width-EDGE,shape.y=Stage.height-shape.height-EDGE,shape.alpha=0,_speedometer.element.x=Stage.width-1.2*_speedometer.width-EDGE,_speedometer.element.y=Stage.height-1*_speedometer.height-EDGE,await Promise.all([number.text.ready(),label.text.ready()]),number.x=shape.x+.66*shape.width,number.y=shape.y+.66*shape.height-.5*number.dimensions.height,label.x=shape.x+.66*shape.width,label.y=number.y+number.dimensions.height+7}()}!async function(){!function initGL(){$this=_this.element}(),await async function initLayout(){_layout=_this.initClass(StageLayout,"figmatest",{glui:!0}),_layers=await _layout.getAllLayers(),$this.add(_layout.element)}(),function initMap(){_map=_this.initClass(GameplayUIFigmaTestMap,_name),_this.startRender(updateMap)}(),function initSpeedometer(){_speedometer=_this.initClass(GameplayUIFigmaTestSpeedometer),_this.startRender(updateSpeedometer)}(),function addHandlers(){(function exposeInputs(){_this.speedometer=_layers["speed-number"],_this.currentStage=_layers["stage-number"],_this.currentTime=_layers["elapsed-time"],_this.beatTime=_layers["to-beat-time"],_this.pauseButton=_layers.pause})(),_this.onResize(resize)}(),_this.isReady=!0}(),this.onRPM=function(v){_speedometer.rpm=v}})),Class((function GameplayUIFigmaTestMap(_name){Inherit(this,GLUIElement);const _this=this,SCALE=120,WORLD_TO_MAP_SCALE=975e-6,ZOOM=2;var $this,$rotate,$map,_shader,_player=new Vector2(.5,.5),_ghost=new Vector2(.5,.5),_x=.5,_y=.5,_gx=.5,_gy=.5,_rotation=0;function applyPosition(){let s=WORLD_TO_MAP_SCALE;_player.set(.5+_x*s,.5-_y*s),_ghost.set(.5+_gx*s,.5-_gy*s),$rotate.rotation=180-_rotation}!function initGL(){$this=_this.element,"GameplayUIMap"===Global.PLAYGROUND&&GLUI.Stage.add($this)}(),function initRotate(){($rotate=$this.create(0,0)).x=.5*SCALE,$rotate.y=.5*SCALE}(),function initMap(){($map=$rotate.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg")).x=.5*-SCALE,$map.y=.5*-SCALE,_shader=_this.initClass(Shader,"GameplayUIFigmaTestMap",{uPlayerColor:{value:new Color("#ff0000")},uGhostColor:{value:new Color("#00ff00")},uTrackColor:{value:new Color("#00ffff")},tMapMask:{value:Utils3D.getTexture(`${GenerateMaps.PATH}${_name}.png`)},uPlayerPosition:{value:_player},uGhostPosition:{value:_ghost},uZoom:{value:ZOOM},transparent:!0}),$map.useShader(_shader)}(),applyPosition(),this.get("x",_=>_x),this.get("y",_=>_y),this.get("ghostX",_=>_gx),this.get("ghostY",_=>_gy),this.get("rotation",_=>_rotation),this.get("scale",_=>SCALE),this.set("x",v=>{_x=v,applyPosition()}),this.set("y",v=>{_y=v,applyPosition()}),this.set("rotation",v=>{_rotation=v,applyPosition()}),this.set("ghostX",v=>{_gx=v,applyPosition()}),this.set("ghostY",v=>{_gy=v,applyPosition()})})),Class((function GameplayUIFigmaTestSpeedometer(){Inherit(this,GLUIElement);const _this=this,SCALE=120;var $this,$meter,_shader,_values=new Vector2,_display=new Vector2;function loop(){_display.lerp(_values,.15),_shader.set("uValue",_display.y)}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),_this.startRender(t=>{if(!_shader)return;let v=Math.range(Math.sin(.001*t),-1,1,0,1);_this.speed=v}))}(),function initMeter(){$meter=$this.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg"),_shader=_this.initClass(Shader,"GameplayUIFigmaTestSpeedometer",{uMax:{value:new Color("#ED1C1C")},uBorder:{value:new Color("#000000")},uFill:{value:new Color("#108CFF")},tMeter:{value:Utils3D.getTexture("assets/images/_temp/speedometer.png")},uValue:{value:0},transparent:!0}),$meter.useShader(_shader)}(),_this.startRender(loop),this.set("speed",v=>{_values.x=v}),this.set("rpm",v=>{_values.y=v}),this.get("width",_=>SCALE),this.get("height",_=>SCALE)})),Class((function GameplayUIIntegra(_name){Inherit(this,GameplayUIView);const _this=this;var H_EDGE,V_EDGE,WIDTH,HEIGHT,SCALE,$this,_layout,_layers,_map,_speedometer,_animation=new Vector2(0,0);function updateMap(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let player=gameplay.cars.player.group,ghost=!!gameplay.cars.ghost&&gameplay.cars.ghost.group;_map.x=player.position.x,_map.y=player.position.z,ghost?(_map.ghostX=ghost.position.x,_map.ghostY=ghost.position.z):_map.ghostX=9999,_map.rotation=Math.degrees(player.rotation.y)}function updateSpeedometer(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let speed=gameplay.controls.acceleration;_speedometer.speed=speed}function positionRelativeTo($a,$b){$a.x=$b.x+($a.origin.x-$b.origin.x),$a.y=$b.y+($a.origin.y-$b.origin.y)}function resize(){!function scale(){const height=Config.UI_SCALE;SCALE=Stage.height/height,HEIGHT=height,WIDTH=Stage.width/Stage.height*HEIGHT,H_EDGE=30*SCALE,V_EDGE=20*SCALE,$this.scale=SCALE}(),function map(){_map.element.x=H_EDGE-Math.range(_animation.x,0,1,.08*Stage.width,0,!0),_map.element.y=HEIGHT-V_EDGE-_map.scale}(),function speedometer(){_speedometer.element.x=WIDTH-H_EDGE-_speedometer.width+Math.range(_animation.x,0,1,.07*Stage.width,0,!0),_speedometer.element.y=HEIGHT-V_EDGE-_speedometer.height;let label=_layers["speed-label"],number=_layers["speed-number"],bg=_layers["speed-label-box"];label.x=WIDTH-H_EDGE-30+Math.range(_animation.x,0,1,.15*Stage.width,0,!0),label.y=HEIGHT-V_EDGE-20,positionRelativeTo(number,label),positionRelativeTo(bg,label)}(),function pause(){let pause=_layers.pause,x=Global.ONLINE?H_EDGE-(pause.width+H_EDGE):H_EDGE;x-=Math.range(_animation.x,0,1,.08*Stage.width,0,!0),pause.x=H_EDGE,pause.y=V_EDGE,pause.scale=Global.ONLINE?0:1}(),function level(){let pause=_layers.pause,label=_layers["level-label"],number=_layers["level-number"];label.x=pause.x+pause.width+H_EDGE-Math.range(_animation.x,0,1,.05*Stage.width,0,!0),label.y=pause.y,positionRelativeTo(number,label)}(),function timer(){let label=_layers["your-time-label"],number=_layers["your-time-number"];label.x=.5*WIDTH,label.y=V_EDGE-Math.range(_animation.x,0,1,.08*Stage.height,0,!0),positionRelativeTo(number,label)}(),function beat(){let label=_layers["beat-time-label"],number=_layers["beat-time-number"];label.x=WIDTH-H_EDGE+Math.range(_animation.x,0,1,.08*Stage.width,0,!0),label.y=V_EDGE,positionRelativeTo(number,label)}(),function closed(){let label=_layers["closed-course"];label.x=.5*WIDTH,label.y=HEIGHT-2*V_EDGE+Math.range(_animation.x,0,1,.08*Stage.height,0,!0),label.alpha=0,label.scale=0}()}!async function(){!function initGL(){($this=_this.element).alpha=1e-5}(),await async function initLayout(){_layout=_this.initClass(StageLayout,"level2",{glui:!0}),_layers=await _layout.getAllLayers();let tasks=[];for(let id in _layers){let layer=_layers[id];if(layer.origin=new Vector2(layer.x,layer.y),layer.text){let str=layer.text.string?layer.text.string:"";str=str.toUpperCase();id.includes(["level-label","your-time-label","beat-time-label","speed-label"]);let shader=_this.initClass(Shader,"IntegraTitleGradientText",{uColor1:{value:new Color("#f2ab00")},uColor2:{value:new Color("#b15100")}});layer.useShader(shader),layer.setText(str),tasks.push(layer.text.ready())}}await Promise.all(tasks);for(let id of["bg-placeholder","map","countdown-number","speed-dial"])_layers[id].alpha=0;$this.add(_layout.element)}(),await TransitionUtils.initUIShaders(_layers,_name,{blacklist:["speed-dial"]}),function initMap(){_map=_this.initClass(GameplayUIIntegraMap,_name),_this.startRender(updateMap)}(),function initSpeedometer(){_speedometer=_this.initClass(GameplayUIIntegraSpeedometer),_this.startRender(updateSpeedometer)}(),function initCheckpoint(){let $timer=_layers["your-time-number"],$label=_layers["your-time-label"];_this.initClass(GameplayUICheckpoint,$timer,$label)}(),function addHandlers(){(function exposeInputs(){_this.speedometer=_layers["speed-number"],_this.currentStage=_layers["level-number"],_this.currentTime=_layers["your-time-number"],_this.beatTime=_layers["beat-time-number"],_this.pauseButton=_layers.pause})(),_this.onResize(resize)}(),_this.isReady=!0}(),this.resize=_=>resize(),this.onRPM=function(v){_speedometer.rpm=v},this.animateIn=function(){$this.alpha=0,$this.x=.04*-Stage.width,$this.y=.04*-Stage.height;let scale=$this.scale;$this.scale*=1.08,$this.tween({alpha:1,scale:scale,x:0,y:0},1500,"easeOutCubic"),_animation.x=0,tween(_animation,{x:1},1500,"easeOutQuart").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x),$this.alpha=1})},this.animateOut=function(){return tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x)}).promise()}})),Class((function GameplayUIIntegraMap(_name){Inherit(this,GLUIElement);const _this=this,SCALE=100,ZOOM=4,WORLD_TO_MAP_SCALE=2/ZOOM*.00125,NAME=_name||"integra";var $this,$rotate,$map,_shader,_player=new Vector2(.5,.5),_ghost=new Vector2(.5,.5),_x=.5,_y=.5,_gx=.5,_gy=.5,_rotation=0;function applyPosition(){let s=WORLD_TO_MAP_SCALE;_player.set(.5+_x*s,.5-_y*s),_ghost.set(.5+_gx*s,.5-_gy*s),$rotate.rotation=180-_rotation}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),World.RENDERER.setClearColor("#666666",1),_this.startRender(_=>_this.y+=.1),_this.onResize(_=>{$this.x=.5*(Stage.width-SCALE),$this.y=.5*(Stage.height-SCALE)}))}(),function initRotate(){($rotate=$this.create(0,0)).x=.5*SCALE,$rotate.y=.5*SCALE}(),function initMap(){($map=$rotate.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg")).x=.5*-SCALE,$map.y=.5*-SCALE,_shader=_this.initClass(Shader,"GameplayUIIntegraMap",{uPlayerColor:{value:new Color("#E81E03")},uGhostColor:{value:new Color("#ff0000")},uTrackColor:{value:new Color("#00ffff")},tMapMask:{value:Utils3D.getTexture(`${GenerateMaps.PATH}${NAME}.png`)},uPlayerPosition:{value:_player},uGhostPosition:{value:_ghost},uZoom:{value:ZOOM},transparent:!0}),$map.useShader(_shader)}(),applyPosition(),this.get("x",_=>_x),this.get("y",_=>_y),this.get("ghostX",_=>_gx),this.get("ghostY",_=>_gy),this.get("rotation",_=>_rotation),this.get("scale",_=>SCALE),this.set("x",v=>{_x=v,applyPosition()}),this.set("y",v=>{_y=v,applyPosition()}),this.set("rotation",v=>{_rotation=v,applyPosition()}),this.set("ghostX",v=>{_gx=v,applyPosition()}),this.set("ghostY",v=>{_gy=v,applyPosition()}),this.set("alpha",v=>$map.alpha=v)})),Class((function GameplayUIIntegraSpeedometer(){Inherit(this,GLUIElement);const _this=this,SCALE=175;var $this,$meter,$dial,$rotation,_values=new Vector2,_display=new Vector2;function loop(){_display.lerp(_values,.15);let angle=Math.range(_display.y,0,1,180,-90);$rotation.rotation=angle}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),$this.x=30,$this.y=30,_this.startRender(t=>{let speed=Math.range(Math.sin(.001*t),-1,1,0,1);_this.speed=speed,_this.rpm=(1-speed)%.25*4}))}(),function initMeter(){($meter=$this.create(SCALE,SCALE,"assets/images/speedometers/integra/speedometer.png")).useShader(new Shader("GameplayUIIntegraDefault"))}(),function initDial(){($rotation=$this.create(0,0)).x=.5*SCALE,$rotation.y=.5*SCALE;let height=.45*SCALE,width=.18*height;($dial=$rotation.create(width,height,"assets/images/speedometers/integra/dial.png")).useShader(new Shader("GameplayUIIntegraDefault")),$dial.x=.5*-width,$dial.y=.9*-height}(),_this.startRender(loop),this.set("speed",v=>{_values.x=v}),this.set("rpm",v=>{_values.y=v}),this.get("width",_=>SCALE),this.get("height",_=>SCALE),this.set("alpha",alpha=>{$meter.alpha=alpha,$dial.alpha=alpha})})),Class((function GameplayUINewNSX(_name="new_nsx"){Inherit(this,GameplayUIView);const _this=this;var H_EDGE,V_EDGE,WIDTH,HEIGHT,SCALE,$this,_layout,_layers,_map,_speedometer,_animation=new Vector2(0,0);function updateMap(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let player=gameplay.cars.player.group,ghost=!!gameplay.cars.ghost&&gameplay.cars.ghost.group;_map.x=player.position.x,_map.y=player.position.z,ghost?(_map.ghostX=ghost.position.x,_map.ghostY=ghost.position.z):_map.ghostX=9999,_map.rotation=Math.degrees(player.rotation.y)}function updateSpeedometer(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return void(_speedometer.rpm=Math.range(Math.cos(.001*Render.TIME),-1,1,0,1));let rpm=gameplay.controls.acceleration;_speedometer.rpm=rpm}function positionRelativeTo($a,$b){$a.x=$b.x+($a.origin.x-$b.origin.x),$a.y=$b.y+($a.origin.y-$b.origin.y)}function resize(){!function scale(){const height=Config.UI_SCALE;SCALE=Stage.height/height,HEIGHT=height,WIDTH=Stage.width/Stage.height*HEIGHT,H_EDGE=30*SCALE,V_EDGE=20*SCALE,$this.scale=SCALE}(),function map(){_map.element.x=H_EDGE+15,_map.element.y=HEIGHT-V_EDGE-_map.scale-15;let glow=_layers["map-glow"];glow.element.x=_map.element.x-10,glow.element.y=_map.element.y-15}(),function speedometer(){_speedometer.element.x=WIDTH-H_EDGE-_speedometer.width,_speedometer.element.y=HEIGHT-V_EDGE-_speedometer.height;let label=_layers["speed-label"],number=_layers["speed-number"];number.x=WIDTH-H_EDGE-.5*_speedometer.width,number.y=HEIGHT-V_EDGE-.5*_speedometer.height-20,positionRelativeTo(label,number);let glow=_layers["speedometer-glow"];glow.element.x=number.x-.5*glow.element.width,glow.element.y=number.y-.5*glow.element.height+20}(),function pause(){let pause=_layers.pause,x=Global.ONLINE?H_EDGE-(pause.width+H_EDGE):H_EDGE;pause.x=x,pause.y=V_EDGE,pause.scale=Global.ONLINE?0:1}(),function level(){let pause=_layers.pause,label=_layers["level-label"],number=_layers["level-number"];label.x=pause.x+pause.width+H_EDGE,label.y=pause.y,positionRelativeTo(number,label);let glow=_layers["level-glow"];glow.element.x=number.x-.25*glow.element.width,glow.element.y=number.y-.25*glow.element.height}(),function timer(){let label=_layers["your-time-label"],number=_layers["your-time-number"];label.x=.5*WIDTH,label.y=V_EDGE+5-Math.range(_animation.x,0,1,.05*Stage.height,0,!0),positionRelativeTo(number,label);let glow=_layers["time-glow"];glow.element.x=number.x-.5*glow.element.width,glow.element.y=number.y-.25*glow.element.height}(),function beat(){let label=_layers["beat-time-label"],number=_layers["beat-time-number"];label.x=WIDTH-H_EDGE+Math.range(_animation.x,0,1,.05*Stage.width,0,!0),label.y=V_EDGE+5,positionRelativeTo(number,label);let glow=_layers["beat-glow"];glow.element.x=number.x-.9*glow.element.width,glow.element.y=number.y-.25*glow.element.height}(),function closed(){let label=_layers["closed-course"];label.x=.5*WIDTH,label.y=HEIGHT-2*V_EDGE,label.alpha=0,label.scale=0}()}!async function(){!function initGL(){$this=_this.element}(),await async function initLayout(){_layout=_this.initClass(StageLayout,"level5",{glui:!0}),_layers=await _layout.getAllLayers();let tasks=[];for(let id in _layers){let layer=_layers[id];if(layer.origin=new Vector2(layer.x,layer.y),layer.text){let str=layer.text.string?layer.text.string:"";str=str.toUpperCase(),layer.setText(str),UIFigmaStyles.NewNSXText(layer,layer.text.getData().color),tasks.push(layer.text.ready())}id.includes(["bg-placeholder","Rectangle-1","map","countdown-number"])&&(layer.alpha=0);let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}await Promise.all(tasks),$this.add(_layout.element)}(),function initMap(){_map=_this.initClass(GameplayUINewNSXMap,_name),_this.startRender(updateMap)}(),function initSpeedometer(){_speedometer=_this.initClass(GameplayUINewNSXSpeedometer),_this.startRender(updateSpeedometer)}(),function initCheckpoint(){let $timer=_layers["your-time-number"],$label=_layers["your-time-label"];_this.initClass(GameplayUICheckpoint,$timer,$label)}(),function addHandlers(){(function exposeInputs(){_this.speedometer=_layers["speed-number"],_this.currentStage=_layers["level-number"],_this.currentTime=_layers["your-time-number"],_this.beatTime=_layers["beat-time-number"],_this.pauseButton=_layers.pause})(),_this.onResize(resize)}(),_this.isReady=!0}(),this.resize=_=>resize(),this.onRPM=function(v){_speedometer.rpm=v},this.animateIn=function(){$this.alpha=0,$this.x=.02*-Stage.width,$this.y=.02*-Stage.height;let scale=$this.scale;$this.scale*=1.04,$this.tween({alpha:1,scale:scale,x:0,y:0},2e3,"easeOutCubic"),_animation.x=0,tween(_animation,{x:1},2e3,"easeOutQuart").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x,{blacklist:["speed-label-box"]})})},this.animateOut=function(){return tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x,{blacklist:["speed-label-box"]})}).promise()}})),Class((function GameplayUINewNSXMap(_name){Inherit(this,GLUIElement);const _this=this,SCALE=120,ZOOM=4,WORLD_TO_MAP_SCALE=2/ZOOM*.00125*.415,NAME=_name||"new_nsx";var $this,$rotate,$map,$player,$decor,_shader,_player=new Vector2(.5,.5),_ghost=new Vector2(.5,.5),_x=.5,_y=.5,_gx=.5,_gy=.5,_rotation=0;function applyPosition(){let s=WORLD_TO_MAP_SCALE;_player.set(.5+_x*s,.5-_y*s),_ghost.set(.5+_gx*s,.5-_gy*s),$rotate.rotation=180-_rotation}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),World.RENDERER.setClearColor("#666666",1),_this.startRender(_=>_this.y+=.1),_this.onResize(_=>{$this.x=.5*(Stage.width-SCALE),$this.y=.5*(Stage.height-SCALE)}))}(),function initRotate(){($rotate=$this.create(0,0)).x=.5*SCALE,$rotate.y=.5*SCALE}(),function initMap(){($map=$rotate.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg")).x=.5*-SCALE,$map.y=.5*-SCALE,_shader=_this.initClass(Shader,"GameplayUINewNSXMap",{uPlayerColor:{value:new Color("#E81E03")},uGhostColor:{value:new Color("#ff0000")},uTrackColor:{value:new Color("#00ffff")},tMapMask:{value:Utils3D.getTexture(`${GenerateMaps.PATH}${NAME}.png`)},uPlayerPosition:{value:_player},uGhostPosition:{value:_ghost},uZoom:{value:ZOOM},blending:Shader.ADDITIVE_BLENDING,transparent:!0}),$map.useShader(_shader)}(),function initPlayer(){($player=$this.create(12,12,"assets/images/maps/decor/new_nsx/player.png")).x=.5*SCALE-6,$player.y=.5*SCALE-6,$player.setZ(2),$player.shader.blending=Shader.ADDITIVE_BLENDING}(),function initDecor(){let size=1.1*SCALE;($decor=$rotate.create(size,size,"assets/images/maps/decor/new_nsx/border.png")).rotation=180,$decor.x=.5*size,$decor.y=.5*size,$decor.setZ(2),$decor.shader.blending=Shader.ADDITIVE_BLENDING}(),applyPosition(),this.get("x",_=>_x),this.get("y",_=>_y),this.get("ghostX",_=>_gx),this.get("ghostY",_=>_gy),this.get("rotation",_=>_rotation),this.get("scale",_=>SCALE),this.set("x",v=>{_x=v,applyPosition()}),this.set("y",v=>{_y=v,applyPosition()}),this.set("rotation",v=>{_rotation=v,applyPosition()}),this.set("ghostX",v=>{_gx=v,applyPosition()}),this.set("ghostY",v=>{_gy=v,applyPosition()}),this.set("alpha",v=>$map.alpha=v)})),Class((function GameplayUINewNSXSpeedometer(){Inherit(this,GLUIElement);const _this=this,SCALE=145;var $this,$meter,_shader,_values=new Vector2,_display=new Vector2;function loop(){_display.lerp(_values,.25),_shader.set("uValue",_display.y)}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),_this.startRender(t=>{let speed=Math.range(Math.sin(.001*t),-1,1,0,1);_this.speed=speed,_this.rpm=(1-speed)%.25*4}))}(),function initMeter(){$meter=$this.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg"),_shader=_this.initClass(Shader,"GameplayUINewNSXSpeedometer",{uMax:{value:new Color("#FF2E00")},uFill:{value:new Color("#FFBE41")},tMeter:{value:Utils3D.getTexture("assets/images/speedometers/new-nsx/speedometer.png")},uValue:{value:0},uSpinDist:{value:.355},uFillMin:{value:.375},uFillMax:{value:.475},uAlpha:{value:1},blending:Shader.ADDITIVE_BLENDING,transparent:!0}),$meter.useShader(_shader)}(),_this.startRender(loop),this.set("speed",v=>{_values.x=v}),this.set("rpm",v=>{_values.y=v}),this.get("width",_=>SCALE),this.get("height",_=>SCALE)})),Class((function GameplayUIOldNSX(_name){Inherit(this,GameplayUIView);const _this=this;var H_EDGE,V_EDGE,WIDTH,HEIGHT,SCALE,$this,_layout,_layers,_map,_speedometer,_animation=new Vector2(0,0);function updateMap(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let player=gameplay.cars.player.group,ghost=!!gameplay.cars.ghost&&gameplay.cars.ghost.group;_map.x=player.position.x,_map.y=player.position.z,ghost?(_map.ghostX=ghost.position.x,_map.ghostY=ghost.position.z):_map.ghostX=9999,_map.rotation=Math.degrees(player.rotation.y)}function updateSpeedometer(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let speed=gameplay.controls.acceleration;_speedometer.speed=speed}function resize(){!function scale(){const height=Config.UI_SCALE;SCALE=Stage.height/height,HEIGHT=height,WIDTH=Stage.width/Stage.height*HEIGHT,H_EDGE=30*SCALE,V_EDGE=25*SCALE,$this.scale=SCALE}(),function map(){_map.element.x=H_EDGE-Math.range(_animation.x,0,1,.08*Stage.width,0,!0),_map.element.y=HEIGHT-V_EDGE-_map.scale}(),function speedometer(){let animationOffset=Math.range(_animation.x,0,1,.08*Stage.width,0,!0);_speedometer.element.x=WIDTH-H_EDGE-_speedometer.width+animationOffset,_speedometer.element.y=HEIGHT-V_EDGE-_speedometer.height;let label=_layers["speed-label"],number=_layers["speed-number"],circle=_layers["speed-round-circle"];number.x=WIDTH-H_EDGE-45+animationOffset,number.y=HEIGHT-V_EDGE-60,positionRelativeTo(label,number),positionRelativeTo(circle,number)}(),function pause(){let pause=_layers.pause,x=Global.ONLINE?H_EDGE-(pause.width+H_EDGE):H_EDGE;x-=Math.range(_animation.x,0,1,.08*Stage.width,0,!0),pause.x=x,pause.y=V_EDGE,pause.scale=Global.ONLINE?0:1}(),function level(){let pause=_layers.pause,label=_layers["level-label"],number=_layers["level-number"];label.x=pause.x+pause.width+H_EDGE,label.y=pause.y,positionRelativeTo(number,label)}(),function timer(){let label=_layers["your-time-label"],number=_layers["your-time-number"];label.x=.5*WIDTH,label.y=V_EDGE-Math.range(_animation.x,0,1,.08*Stage.height,0,!0),positionRelativeTo(number,label)}(),function beat(){let label=_layers["beat-time-label"],number=_layers["beat-time-number"];label.x=WIDTH-H_EDGE+Math.range(_animation.x,0,1,.08*Stage.width,0,!0),label.y=V_EDGE,positionRelativeTo(number,label)}(),function closed(){let label=_layers["closed-course"];label.x=.5*WIDTH,label.y=HEIGHT-2*V_EDGE,label.alpha=0,label.scale=0}()}function positionRelativeTo($a,$b){$a.x=$b.x+($a.origin.x-$b.origin.x),$a.y=$b.y+($a.origin.y-$b.origin.y)}!async function(){!function initGL(){($this=_this.element).alpha=1e-5,_animation.x=0,$this.hide()}(),await async function initLayout(){_layout=_this.initClass(StageLayout,"level1",{glui:!0}),_layers=await _layout.getAllLayers();let tasks=[];for(let id in _layers){let layer=_layers[id];if(layer.origin=new Vector2(layer.x,layer.y),layer.text){let str=layer.text.string?layer.text.string:"";str=str.toUpperCase();let shader=_this.initClass(Shader,"UIOldNSXOutlineText",{uBorder:{value:new Color(0,0,0)}});layer.useShader(shader),layer.setText(str),tasks.push(layer.text.ready())}}await Promise.all(tasks);for(let id of["bg-placeholder","map","countdown-number","speed-dial"])_layers[id].alpha=0;$this.add(_layout.element)}(),await TransitionUtils.initUIShaders(_layers,_name),function initMap(){_map=_this.initClass(GameplayUIOldNSXMap,_name),_this.startRender(updateMap)}(),function initSpeedometer(){_speedometer=_this.initClass(GameplayUIOldNSXSpeedometer),_this.startRender(updateSpeedometer)}(),function initCheckpoint(){let $timer=_layers["your-time-number"],$label=_layers["your-time-label"];_this.initClass(GameplayUICheckpoint,$timer,$label)}(),function addHandlers(){(function exposeInputs(){_this.speedometer=_layers["speed-number"],_this.currentStage=_layers["level-number"],_this.currentTime=_layers["your-time-number"],_this.beatTime=_layers["beat-time-number"],_this.pauseButton=_layers.pause})(),_this.onResize(resize)}(),_this.isReady=!0}(),this.resize=_=>resize(),this.onRPM=function(v){_speedometer.rpm=v},this.animateIn=function(){$this.show(),$this.alpha=0,$this.x=.04*-Stage.width,$this.y=.04*-Stage.height;let scale=$this.scale;$this.scale*=1.08,$this.tween({alpha:1,scale:scale,x:0,y:0},1500,"easeOutCubic"),_animation.x=0,tween(_animation,{x:1},1500,"easeOutQuart").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x)})},this.animateOut=function(){return $this.hide(),tween(_animation,{x:0},500,"easeOutCubic").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x)}).promise()}})),Class((function GameplayUIOldNSXMap(_name){Inherit(this,GLUIElement);const _this=this,SCALE=90,ZOOM=4,WORLD_TO_MAP_SCALE=2/ZOOM*.00125,NAME=_name||"old_nsx";var $this,$rotate,$map,_shader,_player=new Vector2(.5,.5),_ghost=new Vector2(.5,.5),_x=.5,_y=.5,_gx=.5,_gy=.5,_rotation=0;function applyPosition(){let s=WORLD_TO_MAP_SCALE;_player.set(.5+_x*s,.5-_y*s),_ghost.set(.5+_gx*s,.5-_gy*s),$rotate.rotation=180}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),World.RENDERER.setClearColor("#ffffff",1),_this.startRender(_=>_this.y+=.1),_this.onResize(_=>{$this.x=.5*(Stage.width-SCALE),$this.y=.5*(Stage.height-SCALE)}))}(),function initRotate(){($rotate=$this.create(0,0)).x=.5*SCALE,$rotate.y=.5*SCALE}(),function initMap(){($map=$rotate.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg")).x=.5*-SCALE,$map.y=.5*-SCALE,_shader=_this.initClass(Shader,"GameplayUIOldNSXMap",{uPlayerColor:{value:new Color("#ff0000")},uGhostColor:{value:new Color("#00ff00")},uTrackColor:{value:new Color("#00ffff")},tMapMask:{value:Utils3D.getTexture(`${GenerateMaps.PATH}${NAME}.png`)},uPlayerPosition:{value:_player},uGhostPosition:{value:_ghost},uZoom:{value:ZOOM},transparent:!0}),$map.useShader(_shader)}(),applyPosition(),this.get("x",_=>_x),this.get("y",_=>_y),this.get("ghostX",_=>_gx),this.get("ghostY",_=>_gy),this.get("rotation",_=>_rotation),this.get("scale",_=>SCALE),this.set("x",v=>{_x=v,applyPosition()}),this.set("y",v=>{_y=v,applyPosition()}),this.set("rotation",v=>{_rotation=v,applyPosition()}),this.set("ghostX",v=>{_gx=v,applyPosition()}),this.set("ghostY",v=>{_gy=v,applyPosition()}),this.set("alpha",v=>$map.alpha=v)})),Class((function GameplayUIOldNSXSpeedometer(){Inherit(this,GLUIElement);const _this=this,SCALE=125;var $this,$meter,_shader,_values=new Vector2,_display=new Vector2;function loop(){_display.lerp(_values,.15),_shader.set("uValue",_display.y)}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),$this.x=30,$this.y=30,World.RENDERER.setClearColor("#ffffff",1),_this.startRender(t=>{let speed=Math.range(Math.sin(.001*t),-1,1,0,1);_this.speed=speed,_this.rpm=(1-speed)%.25*4}))}(),function initMeter(){$meter=$this.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg"),_shader=_this.initClass(Shader,"GameplayUIOldNSXSpeedometer",{uMax:{value:new Color("#ED1C1C")},uBorder:{value:new Color("#000000")},uFill:{value:new Color("#108CFF")},tMeter:{value:Utils3D.getTexture("assets/images/speedometers/old-nsx/speedometer.png")},uValue:{value:0},uScale:{value:SCALE},uAlpha:{value:1},transparent:!0}),$meter.useShader(_shader)}(),_this.startRender(loop),this.set("speed",v=>{_values.x=v}),this.set("rpm",v=>{_values.y=v}),this.get("width",_=>SCALE),this.get("height",_=>SCALE),this.set("alpha",alpha=>$meter.alpha=alpha)})),Class((function GameplayUIRDX(_name){Inherit(this,GameplayUIView);const _this=this;var H_EDGE,V_EDGE,WIDTH,HEIGHT,SCALE,$this,_layout,_layers,_map,_speedometer,_animation=new Vector2(0,0);function updateMap(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let player=gameplay.cars.player.group,ghost=!!gameplay.cars.ghost&&gameplay.cars.ghost.group;_map.x=player.position.x,_map.y=player.position.z,ghost?(_map.ghostX=ghost.position.x,_map.ghostY=ghost.position.z):_map.ghostX=9999,_map.rotation=Math.degrees(player.rotation.y)}function updateSpeedometer(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let speed=gameplay.controls.acceleration;_speedometer.speed=speed}function positionRelativeTo($a,$b){$a.x=$b.x+($a.origin.x-$b.origin.x),$a.y=$b.y+($a.origin.y-$b.origin.y)}function resize(){!function scale(){const height=Config.UI_SCALE;SCALE=Stage.height/height,HEIGHT=height,WIDTH=Stage.width/Stage.height*HEIGHT,H_EDGE=30*SCALE,V_EDGE=20*SCALE,$this.scale=SCALE}(),function map(){_map.element.x=H_EDGE+15,_map.element.y=HEIGHT-V_EDGE-_map.scale-15}(),function speedometer(){_speedometer.element.x=WIDTH-H_EDGE-_speedometer.width+10,_speedometer.element.y=HEIGHT-V_EDGE-_speedometer.height+10;let label=_layers["speed-label"],number=_layers["speed-number"];number.x=WIDTH-H_EDGE-27,number.y=HEIGHT-V_EDGE-53,positionRelativeTo(label,number)}(),function pause(){let pause=_layers.pause,x=Global.ONLINE?H_EDGE-(pause.width+H_EDGE):H_EDGE;pause.x=x,pause.y=V_EDGE,pause.scale=Global.ONLINE?0:1}(),function level(){let pause=_layers.pause,label=_layers["level-label"],number=_layers["level-number"];label.x=pause.x+pause.width+H_EDGE,label.y=pause.y,positionRelativeTo(number,label)}(),function timer(){let label=_layers["your-time-label"],number=_layers["your-time-number"],labelBox=_layers["yout-time-label-box"],numberBox=_layers["yout-time-number-box"];label.x=.5*WIDTH,label.y=V_EDGE+5-Math.range(_animation.x,0,1,.05*Stage.height,0,!0),positionRelativeTo(number,label),positionRelativeTo(labelBox,label),positionRelativeTo(numberBox,label)}(),function beat(){let label=_layers["beat-time-label"],number=_layers["beat-time-number"],labelBox=_layers["beat-time-label-box"],numberBox=_layers["beat-time-number-box"];label.x=WIDTH-H_EDGE-65+Math.range(_animation.x,0,1,.05*Stage.width,0,!0),label.y=V_EDGE+5,positionRelativeTo(number,label),positionRelativeTo(labelBox,label),positionRelativeTo(numberBox,label)}(),function closed(){let label=_layers["closed-course"];label.x=.5*WIDTH,label.y=HEIGHT-2*V_EDGE,label.alpha=0,label.scale=0}()}!async function(){!function initGL(){$this=_this.element}(),await async function initLayout(){_layout=_this.initClass(StageLayout,"level3",{glui:!0}),_layers=await _layout.getAllLayers();let tasks=[];for(let id in _layers){let layer=_layers[id];if(layer.origin=new Vector2(layer.x,layer.y),layer.text){let str=layer.text.string?layer.text.string:"";str=str.toUpperCase();let shader=_this.initClass(Shader,"RDXTextureText");layer.useShader(shader),layer.setText(str),tasks.push(layer.text.ready())}id.includes(["yout-time-number-box","beat-time-number-box"])&&(layer.alpha=.5),id.includes(["yout-time-label-box","beat-time-label-box"])&&(layer.alpha=.5)}await Promise.all(tasks);for(let id of["bg-placeholder","map","countdown-number","Rectangle-1","speed-label-box"])_layers[id].alpha=0;$this.add(_layout.element)}(),await TransitionUtils.initUIShaders(_layers,_name,{params:{tMask:{value:Utils3D.getRepeatTexture("assets/images/transitions/crossfade.png")}}}),function initMap(){_map=_this.initClass(GameplayUIRDXMap,_name),_this.startRender(updateMap)}(),function initSpeedometer(){_speedometer=_this.initClass(GameplayUIRDXSpeedometer),_this.startRender(updateSpeedometer)}(),function initCheckpoint(){let $timer=_layers["your-time-number"],$label=_layers["your-time-label"];_this.initClass(GameplayUICheckpoint,$timer,$label)}(),function addHandlers(){(function exposeInputs(){_this.speedometer=_layers["speed-number"],_this.currentStage=_layers["level-number"],_this.currentTime=_layers["your-time-number"],_this.beatTime=_layers["beat-time-number"],_this.pauseButton=_layers.pause})(),_this.onResize(resize)}(),_this.isReady=!0}(),this.resize=_=>resize(),this.onRPM=function(v){_speedometer.rpm=v},this.animateIn=function(){$this.alpha=0,$this.x=.02*-Stage.width,$this.y=.02*-Stage.height;let scale=$this.scale;$this.scale*=1.04,$this.tween({alpha:1,scale:scale,x:0,y:0},2e3,"easeOutCubic"),_animation.x=0,tween(_animation,{x:1},2e3,"easeOutQuart").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x,{blacklist:["speed-label-box"]})})},this.animateOut=function(){return tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x,{blacklist:["speed-label-box"]})}).promise()}})),Class((function GameplayUIRDXMap(_name){Inherit(this,GLUIElement);const _this=this,SCALE=100,ZOOM=4,WORLD_TO_MAP_SCALE=2/ZOOM*.00125,NAME=_name||"rdx";var $this,$rotate,$map,$player,$decor,_shader,_player=new Vector2(.5,.5),_ghost=new Vector2(.5,.5),_x=.5,_y=.5,_gx=.5,_gy=.5,_rotation=0;function applyPosition(){let s=WORLD_TO_MAP_SCALE;_player.set(.5+_x*s,.5-_y*s),_ghost.set(.5+_gx*s,.5-_gy*s),$rotate.rotation=180-_rotation}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),World.RENDERER.setClearColor("#666666",1),_this.startRender(_=>_this.y+=.1),_this.onResize(_=>{$this.x=.5*(Stage.width-SCALE),$this.y=.5*(Stage.height-SCALE)}))}(),function initRotate(){($rotate=$this.create(0,0)).x=.5*SCALE,$rotate.y=.5*SCALE}(),function initMap(){($map=$rotate.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg")).x=.5*-SCALE,$map.y=.5*-SCALE,_shader=_this.initClass(Shader,"GameplayUIRDXMap",{uPlayerColor:{value:new Color("#62DF4E")},uGhostColor:{value:new Color("#ff0000")},uTrackColor:{value:new Color("#00ffff")},tMapMask:{value:Utils3D.getTexture(`${GenerateMaps.PATH}${NAME}.png`)},tMask:{value:Utils3D.getTexture("assets/images/transitions/crossfade.png")},uPlayerPosition:{value:_player},uGhostPosition:{value:_ghost},uZoom:{value:ZOOM},transparent:!0}),$map.useShader(_shader)}(),function initPlayer(){($player=$this.create(12,12,"assets/images/maps/decor/rdx/player.png")).x=.5*SCALE-6,$player.y=.5*SCALE-6,$player.setZ(2)}(),function initDecor(){let size=1.4*SCALE;($decor=$rotate.create(size,size,"assets/images/maps/decor/rdx/border.png")).x=.5*-size,$decor.y=.5*-size,$decor.setZ(2),$decor.useShader(new Shader("GameplayUIRDXDefault",{tMask:{value:Utils3D.getTexture("assets/images/transitions/crossfade.png")}}))}(),applyPosition(),this.get("x",_=>_x),this.get("y",_=>_y),this.get("ghostX",_=>_gx),this.get("ghostY",_=>_gy),this.get("rotation",_=>_rotation),this.get("scale",_=>SCALE),this.set("x",v=>{_x=v,applyPosition()}),this.set("y",v=>{_y=v,applyPosition()}),this.set("rotation",v=>{_rotation=v,applyPosition()}),this.set("ghostX",v=>{_gx=v,applyPosition()}),this.set("ghostY",v=>{_gy=v,applyPosition()}),this.set("alpha",v=>{$map.alpha=v,$decor.alpha=v,$player.alpha=v})})),Class((function GameplayUIRDXSpeedometer(){Inherit(this,GLUIElement);const _this=this,SCALE=175;var $this,$meter,$dial,$rotation,_values=new Vector2,_display=new Vector2;function loop(){_display.lerp(_values,.15);let angle=Math.range(_display.y,0,1,180,-90);$rotation.rotation=angle}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(World.RENDERER.setClearColor("#aaaaaa",1),GLUI.Stage.add($this),_this.startRender(t=>{let speed=Math.range(Math.sin(.001*t),-1,1,0,1);_this.speed=speed,_this.rpm=(1-speed)%.25*4}))}(),function initMeter(){($meter=$this.create(SCALE,SCALE,"assets/images/speedometers/rdx/speedometer.png")).useShader(new Shader("GameplayUIRDXDefault",{tMask:{value:Utils3D.getRepeatTexture("assets/images/transitions/crossfade.png")}}))}(),function initDial(){($rotation=$this.create(0,0)).x=.5*SCALE,$rotation.y=.5*SCALE;let height=.45*SCALE,width=height*(42/207);($dial=$rotation.create(width,height,"assets/images/speedometers/rdx/dial.png")).x=.5*-width,$dial.y=.9*-height}(),_this.startRender(loop),this.set("speed",v=>{_values.x=v}),this.set("rpm",v=>{_values.y=v}),this.get("width",_=>SCALE),this.get("height",_=>SCALE),this.set("alpha",alpha=>{$meter.alpha=alpha,$dial.alpha=alpha})})),Class((function GameplayUITypeS(_name="type_s"){Inherit(this,GameplayUIView);const _this=this;var H_EDGE,V_EDGE,WIDTH,HEIGHT,SCALE,$this,_layout,_layers,_map,_speedometer,_animation=new Vector2(0,0);function updateMap(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return;let player=gameplay.cars.player.group,ghost=!!gameplay.cars.ghost&&gameplay.cars.ghost.group;_map.x=player.position.x,_map.y=player.position.z,ghost?(_map.ghostX=ghost.position.x,_map.ghostY=ghost.position.z):_map.ghostX=9999,_map.rotation=Math.degrees(player.rotation.y)}function updateSpeedometer(){let gameplay=_this.findParent("Gameplay");if(!gameplay)return _speedometer.speed=Math.range(Math.cos(.001*Render.TIME),-1,1,0,1),void(_speedometer.rpm=Math.range(Math.cos(.001*Render.TIME*6.5),-1,1,0,1));let speed=gameplay.controls.acceleration;_speedometer.speed=speed}function positionRelativeTo($a,$b){$a.x=$b.x+($a.origin.x-$b.origin.x),$a.y=$b.y+($a.origin.y-$b.origin.y)}function resize(){!function scale(){const height=Config.UI_SCALE;SCALE=Stage.height/height,HEIGHT=height,WIDTH=Stage.width/Stage.height*HEIGHT,H_EDGE=30*SCALE,V_EDGE=20*SCALE,$this.scale=SCALE}(),function map(){_map.element.x=H_EDGE+15,_map.element.y=HEIGHT-V_EDGE-_map.scale-15;let glow=_layers["map-glow"];glow.element.x=_map.element.x,glow.element.y=_map.element.y}(),function speedometer(){_speedometer.element.x=WIDTH-H_EDGE-_speedometer.width+20,_speedometer.element.y=HEIGHT-V_EDGE-_speedometer.height+20;let label=_layers.gear,number=_layers["gear-number"];number.x=WIDTH-H_EDGE-.5*_speedometer.width+20,number.y=HEIGHT-V_EDGE-.5*_speedometer.height+20,positionRelativeTo(label,number);let glow=_layers["speedometer-glow"];glow.element.x=number.x-.5*glow.element.width,glow.element.y=number.y-.5*glow.element.height}(),function pause(){let pause=_layers.pause,x=Global.ONLINE?H_EDGE-(pause.width+H_EDGE):H_EDGE;pause.x=x,pause.y=V_EDGE-5,pause.scale=Global.ONLINE?0:1}(),function level(){let pause=_layers.pause,box=_layers["level-box"],label=_layers["level-label"],number=_layers["level-number"];positionRelativeTo(label,pause),positionRelativeTo(box,label),positionRelativeTo(number,label);let glow=_layers["level-glow"];glow.element.x=number.x-.5*glow.element.width,glow.element.y=number.y-.25*glow.element.height}(),function timer(){let box=_layers["your-time-box"],label=_layers["your-time-label"],number=_layers["your-time-number"];label.x=.5*WIDTH,label.y=V_EDGE-Math.range(_animation.x,0,1,.05*Stage.height,0,!0),positionRelativeTo(box,label),positionRelativeTo(number,label);let glow=_layers["time-glow"];glow.element.x=number.x-.5*glow.element.width,glow.element.y=number.y-.25*glow.element.height}(),function beat(){let box=_layers["beat-that-box"],label=_layers["beat-that-label"],number=_layers["beat-time-number"];label.x=WIDTH-H_EDGE-90+Math.range(_animation.x,0,1,.05*Stage.width,0,!0),label.y=V_EDGE,positionRelativeTo(box,label),positionRelativeTo(number,label);let glow=_layers["beat-glow"];glow.element.x=number.x-.5*glow.element.width,glow.element.y=number.y-.25*glow.element.height}(),function closed(){let label=_layers["closed-course"];label.x=.5*WIDTH,label.y=HEIGHT-2*V_EDGE,label.alpha=0,label.scale=0}()}!async function(){!function initGL(){$this=_this.element}(),await async function initLayout(){_layout=_this.initClass(StageLayout,"level6",{glui:!0}),_layers=await _layout.getAllLayers();let tasks=[];for(let id in _layers){let layer=_layers[id];if(void 0!==layer){if(layer.origin=new Vector2(layer.x,layer.y),layer.text){let str=layer.text.string?layer.text.string:"";str=str.toUpperCase(),layer.setText(str),tasks.push(layer.text.ready())}id.includes(["bg-placeholder","speed","map","countdown-number"])&&(layer.alpha=0)}}await Promise.all(tasks),await _this.wait(50);for(let id in _layers){let layer=_layers[id];if(void 0===layer)continue;let shader=_this.getShader(layer);shader&&(id.includes("-glow")||(shader.blending=Shader.ADDITIVE_BLENDING))}$this.add(_layout.element)}(),function initMap(){_map=_this.initClass(GameplayUITypeSMap,_name),_this.startRender(updateMap)}(),function initSpeedometer(){_speedometer=_this.initClass(GameplayUITypeSSpeedometer),_this.startRender(updateSpeedometer)}(),function initCheckpoint(){let $timer=_layers["your-time-number"],$label=_layers["your-time-label"];_this.initClass(GameplayUICheckpoint,$timer,$label)}(),function addHandlers(){(function exposeInputs(){_this.speedometer=_layers["speed-number"],_this.currentStage=_layers["level-number"],_this.currentTime=_layers["your-time-number"],_this.beatTime=_layers["beat-time-number"],_this.pauseButton=_layers.pause})(),_this.onResize(resize)}(),_this.isReady=!0}(),this.resize=_=>resize(),this.onRPM=function(v){_speedometer.rpm=v},this.set("gear",v=>{let number=_layers["gear-number"];number&&number.setText(v)}),this.animateIn=function(){$this.alpha=0,$this.x=.02*-Stage.width,$this.y=.02*-Stage.height;let scale=$this.scale;$this.scale*=1.04,$this.tween({alpha:1,scale:scale,x:0,y:0},2e3,"easeOutCubic"),_animation.x=0,tween(_animation,{x:1},2e3,"easeOutQuart").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x,{blacklist:["speed-label-box","speed"]})})},this.animateOut=function(){return tween(_animation,{x:0},300,"easeOutQuad").onUpdate(_=>{resize(),_map.alpha=_animation.x,_speedometer.alpha=_animation.x,TransitionUtils.update(_layers,_animation.x,{blacklist:["speed-label-box","speed"]})}).promise()}})),Class((function GameplayUITypeSMap(_name){Inherit(this,GLUIElement);const _this=this,SCALE=140,ZOOM=4,WORLD_TO_MAP_SCALE=2/ZOOM*.00125*.415,NAME=_name||"type_s";var $this,$rotate,$map,$player,$decor,_shader,_player=new Vector2(.5,.5),_ghost=new Vector2(.5,.5),_x=.5,_y=.5,_gx=.5,_gy=.5,_rotation=0;function applyPosition(){let s=WORLD_TO_MAP_SCALE;_player.set(.5+_x*s,.5-_y*s),_ghost.set(.5+_gx*s,.5-_gy*s),$rotate.rotation=180-_rotation}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),World.RENDERER.setClearColor("#666666",1),_this.startRender(_=>_this.y+=.1),_this.onResize(_=>{$this.x=.5*(Stage.width-SCALE),$this.y=.5*(Stage.height-SCALE)}))}(),function initRotate(){($rotate=$this.create(0,0)).x=.5*SCALE,$rotate.y=.5*SCALE}(),function initMap(){($map=$rotate.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg")).x=.5*-SCALE,$map.y=.5*-SCALE,_shader=_this.initClass(Shader,"GameplayUITypeSMap",{uPlayerColor:{value:new Color("#E81E03")},uWaveColor:{value:new Color("#E45000")},uTrackColor:{value:new Color("#92F2FF")},tMapMask:{value:Utils3D.getTexture(`${GenerateMaps.PATH}${NAME}.png`)},uPlayerPosition:{value:_player},uGhostPosition:{value:_ghost},uZoom:{value:ZOOM},blending:Shader.ADDITIVE_BLENDING,transparent:!0}),$map.useShader(_shader)}(),function initPlayer(){($player=$this.create(9,9,"assets/images/maps/decor/type_s/player.png")).x=.5*SCALE-4.5,$player.y=.5*SCALE-4.5,$player.setZ(2),$player.shader.blending=Shader.ADDITIVE_BLENDING}(),function initDecor(){let size=1.3*SCALE;($decor=$rotate.create(size,size,"assets/images/maps/decor/type_s/border.png")).rotation=180,$decor.x=.5*size,$decor.y=.5*size,$decor.setZ(2),$decor.shader.blending=Shader.ADDITIVE_BLENDING}(),applyPosition(),this.get("x",_=>_x),this.get("y",_=>_y),this.get("ghostX",_=>_gx),this.get("ghostY",_=>_gy),this.get("rotation",_=>_rotation),this.get("scale",_=>SCALE),this.set("x",v=>{_x=v,applyPosition()}),this.set("y",v=>{_y=v,applyPosition()}),this.set("rotation",v=>{_rotation=v,applyPosition()}),this.set("ghostX",v=>{_gx=v,applyPosition()}),this.set("ghostY",v=>{_gy=v,applyPosition()}),this.set("alpha",v=>$map.alpha=v)})),Class((function GameplayUITypeSSpeedometer(){Inherit(this,GLUIElement);const _this=this,SCALE=230;var $this,$meter,$rotation,$dial,_shader,_values=new Vector2,_display=new Vector2;function loop(){_display.lerp(_values,.25),_shader.set("uSpeed",1-_display.x),_shader.set("uRPM",_display.y);let angle=Math.range(_display.x,0,1,90,-90);$rotation.rotation=angle}!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name&&(GLUI.Stage.add($this),_this.startRender(t=>{let speed=Math.range(Math.sin(.001*t),-1,1,0,1);$this.x=.5*Stage.width-.5*SCALE,$this.y=.5*Stage.height-.5*SCALE,_this.speed=speed,_this.rpm=(1-speed)%.25*4}))}(),function initMeter(){$meter=$this.create(SCALE,SCALE,"assets/images/_scenelayout/uv.jpg"),_shader=_this.initClass(Shader,"GameplayUITypeSSpeedometer",{uMax:{value:new Color("#E45000")},uFill:{value:new Color("#92F2FF")},uBorder:{value:new Color("#FFFFFF")},tMeter:{value:Utils3D.getTexture("assets/images/speedometers/type-s/speedometer.png")},uRPM:{value:0},uSpeed:{value:0},uSpinDist:{value:.45},uFillMin:{value:.35},uFillMax:{value:.4},uAlpha:{value:1},blending:Shader.ADDITIVE_BLENDING,transparent:!0}),$meter.useShader(_shader),$meter.setZ(1)}(),function initDial(){($rotation=$this.create(0,0)).x=.5*SCALE,$rotation.y=.5*SCALE;let height=.165*SCALE,width=height*(12/195);($dial=$rotation.create(width,height,"assets/images/speedometers/type-s/dial.png")).x=.5*-width,$dial.y=1.5*-height,$dial.setZ(2)}(),_this.startRender(loop),this.set("speed",v=>{_values.x=v}),this.set("rpm",v=>{_values.y=v}),this.get("width",_=>SCALE),this.get("height",_=>SCALE)})),Class((function GameplayVFX(_name,_nuke){Inherit(this,Component);const _this=this;var _shader,_ghost={value:null};function loop(){_shader.uniforms.uCarAcceleration.value=_this.parent.controls.acceleration}!async function(){_this.mask=_this.initClass(FX.CarMask,_nuke),_this.prevFrame=_this.initClass(FX.PrevFrame,_nuke),_shader=_this.initClass(Shader,"TestMaterial",{UILPrefix:"VFXCommon",uCarAcceleration:{value:0,ignoreUIL:!0},tCarMask:{value:_this.mask,ignoreUIL:!0},tDepth:{value:_nuke.rttBuffer.createDepthTexture(),ignoreUIL:!0},tGhost:_ghost,uBlurSampleDist:{value:.4},uBlurBaseStrength:{value:1},uBaseRGBStrength:{value:1},uAccelerationRGB:{value:1},uBlurDistRange:{value:new Vector2(.3,.5)},uGhostColor:{value:new Color}}),ShaderUIL.add(_shader).setLabel("VFX Common"),await defer();let VFXClass=window[`GameplayVFX${_name.capitalize().replace("_","")}`];VFXClass&&(_this.custom=_this.initClass(VFXClass,_nuke)),_this.startRender(loop)}(),this.setupCar=async function(car){(await car.getLayers()).forEach(l=>{_this.mask.add(l),l.shader.addUniforms({tMatcap:{value:_this.prevFrame}})})},this.registerGhost=function(fxscene){_ghost.value=fxscene},this.mergeUniforms=function(obj,obj2,obj3,obj4){return Utils.mergeObject(_shader.uniforms,obj,obj2,obj3,obj4)},this.loaded=async function(sync){return await _this.wait(100),Initializer3D.detectUploadNuke(_nuke,sync)}})),FX.Class((function CarMask(_nuke){Inherit(this,FXScene);const _this=this;var _shader;function loop(){_this.render()}_this.create(_nuke),_this.setDPR(1),_this.startRender(loop),(_shader=_this.initClass(Shader,"CarMaskShader")).upload(),this.add=function(mesh){this.addObject(mesh).shader=_shader}})),FX.Class((function PrevFrame(_nuke){Inherit(this,FXScene);const _this=this;var _shader;const ENABLED=Tests.carReflection();function postRender(){ENABLED&&(_shader.set("tMap",_nuke.output),_this.render())}_this.create(_nuke),_this.setDPR(1),_this.setResolution(.5),_this.events.sub(RenderManager.POST_RENDER,postRender),function initMesh(){_shader=_this.initClass(Shader,"ScreenQuad",{tMap:{value:Utils3D.getTexture("assets/images/_scenelayout/uv.jpg")}});let mesh=new Mesh(World.QUAD,_shader);mesh.frustumCulled=!1,_this.scene.add(mesh)}()})),Class((function GameplayVFXARX(_nuke){Inherit(this,Component);const _this=this;var _pass,_brights,_exposure,_camera=_this.findParent("Gameplay").worldCamera.worldCamera,_v=new Vector3,_v2=new Vector3,_vN=new Vector3,_bN=new Vector3;function loop(){_v2.set(0,0,-5).applyQuaternion(_camera.quaternion),_v.copy(_camera.position).add(_v2),_vN.copy(_v).normalize();let max=0;for(let i=_brights.length-1;i>-1;i--){let b=_brights[i],d=Math.clamp(_vN.dot(_bN.copy(b.position).normalize()),0,1);d>max&&(max=d)}let target=max>.97?1:0;_pass.uniforms.uIntoSun.value=Math.lerp(target,_pass.uniforms.uIntoSun.value,.02);for(let i=_exposure.length-1;i>-1;i--){let e=_exposure[i];e.triggered||_camera.position.distanceTo(e.position)<2&&(e.triggered=!0,_pass.tween("uExposure",1,750,"easeOutSine").onComplete(_=>{_pass.tween("uExposure",0,3e3,"easeOutSine")}))}}!async function(){let volumetricLight=_this.initClass(ARXVolumetricLight),bloom=_this.initClass(FX.UnrealBloom,_nuke,{nMips:3,enabled:Tests.arxBloom()},"ARX");bloom.dpr=Tests.arxBloomRes(),_pass=_this.initClass(NukePass,"ARXVFX",_this.parent.mergeUniforms({tVolumetricLight:{value:volumetricLight.rt},tDirt:{value:null},uVolumetricAdd:{value:1},uVignette:{value:1},uDirtAlpha:{value:1},uContrast:{value:new Vector2(1.3,1.3)},uDirtVisibility:{value:new Vector2(0,1)},uIntoSun:{value:0},uExposure:{value:0}},bloom.uniforms)),_nuke.add(_pass),ShaderUIL.add(_pass);let environment=_this.findParent("Gameplay").environment,sky=environment.sky;[_brights,_exposure]=await Promise.all([sky.layout.getLayers("bright1","bright2","bright3","bright4"),environment.layout.getLayers("exposure1","exposure2")]),_brights.forEach(mesh=>mesh.visible=!1),_exposure.forEach(mesh=>mesh.visible=!1),_this.startRender(loop),_this.findParent("Gameplay").setDPR(Tests.getARXDPR()),Tests.fxaa()&&_nuke.add(new FXAA)}()})),window.GameplayVFXArx=GameplayVFXARX,Class((function GameplayVFXIntegra(_nuke){Inherit(this,Component);const _this=this;!function(){let pass=_this.initClass(NukePass,"IntegraVFX",_this.parent.mergeUniforms({uLowerResolution:{value:1},uNoise:{value:new Vector3(10,1,1)},uNoise2:{value:new Vector3(10,1,1)},uVignette:{value:0},uSepia:{value:0},uGlitchRepeat:{value:1},uAcceleration:{value:1},uGlitchBlend:{value:new Vector3(1.5,.5,1.2)},tGlitch:{value:null,getTexture:Utils3D.getRepeatTexture}}));_nuke.add(pass),ShaderUIL.add(pass),_this.findParent("Gameplay").state.bind("acceleration",v=>pass.set("uAcceleration",v))}()})),Class((function GameplayVFXNewNSX(_nuke){Inherit(this,Component);const _this=this;!function(){let bloom=_this.initClass(FX.UnrealBloom,_nuke,{nMips:3,enabled:Tests.arxBloom()},"NewNSX");bloom.dpr=Tests.arxBloomRes();let rain=_this.initClass(VideoTexture,"assets/video/rain.mp4");Tests.renderRain()&&rain.start();let pass=_this.initClass(NukePass,"NewNSXVFX",_this.parent.mergeUniforms({uTint1:{value:new Color},uTint2:{value:new Color},uTintRange:{value:new Vector2},uTintFactor:{value:.5},uRainRefraction:{value:1},uLensBlurRange:{value:new Vector2},uNoiseMin:{value:.5},tRain:{value:rain},uVignette:{value:.5}},bloom.uniforms));_nuke.add(pass),ShaderUIL.add(pass),_this.findParent("Gameplay").setDPR(Tests.getNSXDPR())}()})),window.GameplayVFXNewnsx=GameplayVFXNewNSX,Class((function GameplayVFXOldnsx(_nuke){Inherit(this,Component);const _this=this;var _pass,_collision=0;function loop(){_pass.uniforms.uCollision.value=Math.lerp(_collision,_pass.uniforms.uCollision.value,.07),_collision=Math.lerp(_collision,0,.05)}function collision(v){v&&(_collision=3,_pass.set("uCollision",_collision))}!function(){let pass=_this.initClass(NukePass,"OldNSXVFX",_this.parent.mergeUniforms({uLowerResolution:{value:1},tCRT:{value:null,getTexture:Utils3D.getRepeatTexture},uCRTScale:{value:1},uCRTBlend:{value:new Vector3(1.5,.5,1.2)},uNoise:{value:new Vector3(10,1,1)},uCollision:{value:0},uRes:{value:1},uVignette:{value:0}}));_nuke.add(pass),ShaderUIL.add(pass),_this.findParent("Gameplay").setDPR(Math.min(World.DPR,1)),_pass=pass,Device.mobile&&Device.mobile.phone&&(pass.set("uRes",Math.range(World.DPR,1,2,1,.75)),pass.set("uCRTScale",23)),_this.findParent("Gameplay").state.bind("collision",collision),_this.startRender(loop)}()})),Class((function GameplayVFXRDX(_nuke){Inherit(this,Component);const _this=this;var _pass;!function(){let bloom=_this.initClass(FX.UnrealBloom,_nuke,{nMips:3,enabled:Tests.rdxBloom()},"RDX");bloom.dpr=Tests.rdxBloomRes();let pass=_this.initClass(NukePass,"RDXVFX",_this.parent.mergeUniforms({uVignette:{value:1},uFogBlend:{value:1},uNoiseMin:{value:1},tLUT:{value:null,getTexture:Utils3D.getLookupTexture},tFog:{value:null}},bloom.uniforms));_nuke.add(pass),ShaderUIL.add(pass),_this.findParent("Gameplay").setDPR(Tests.getRDXDPR()),_pass=pass}(),this.registerFog=function(fog){_pass.set("tFog",fog)}})),window.GameplayVFXRdx=GameplayVFXRDX,Class((function GameplayVFXTypes(_nuke){Inherit(this,Component);const _this=this;!function(){let bloom=_this.initClass(FX.UnrealBloom,_nuke,{nMips:3,enabled:Tests.arxBloom()},"Types");bloom.dpr=Tests.arxBloomRes();let pass=_this.initClass(NukePass,"TypesVFX",_this.parent.mergeUniforms({uNoiseMin:{value:.5},uVignette:{value:.5},uTint1:{value:new Color},uTint2:{value:new Color},uContrast:{value:new Vector2(1.3,1.3)}},bloom.uniforms));_nuke.add(pass),ShaderUIL.add(pass),_this.findParent("Gameplay").setDPR(Tests.getTypeSDPR())}()})),window.GameplayVFXTypes=GameplayVFXTypes,Class((function GarageCamera(_layout){Inherit(this,Object3D);const _this=this;var _slider,_cars=[],_currentIndex=0,_tick=0,_decompose0=new Group,_decompose1=new Group,_group=new Group;function loop(){let car=_cars[_currentIndex];Utils3D.decompose(car.camera.camera,_decompose0),_decompose0.position.x-=.5,_this.worldCamera.position.copy(_decompose0.position),_this.worldCamera.quaternion.copy(_decompose0.quaternion);let lock=_tick++<30,offset=car.posValue||0,nextCar=_cars[_currentIndex+Math.sign(-offset)];if(nextCar){let lerp=lock?1:Math.abs(offset);Utils3D.decompose(nextCar.camera.camera,_decompose1),_decompose1.position.x-=.5,_this.worldCamera.position.lerp(_decompose1.position,lerp,!0),_this.worldCamera.quaternion.slerp(_decompose1.quaternion,lerp,!0)}else _this.worldCamera.position.x+=10*-offset*Render.HZ_MULTIPLIER;_group.position.z=Math.lerp(5*Math.abs(_group.velocity.value.x),_group.position.z,lock?1:.07),_group.updateMatrixWorld()}function debouncePrev(){_this.flag("prevent")||_slider.prev()}function debounceNext(){_this.flag("prevent")||_slider.next()}function keyPress(e){_this._invisible||_this.flag("prevent")||("ArrowRight"==e.key&&_slider.next(),"ArrowLeft"==e.key&&_slider.prev())}async function updateSlide(e){_this.flag("prevent",!0,1250),_currentIndex=e.slide;let trackName=Data.getTrackNameByNumber(_currentIndex+1),shouldPlay=await Data.tracks[trackName].isUnlocked();AudioController.instance().changeCar(_currentIndex,shouldPlay),_this.worldCamera.fov=_cars[e.slide].camera.camera.fov,_this.worldCamera.updateProjectionMatrix(),_this.parent.vfx.updateSlide(e.slide),Storage.set("garageSlide",e.slide),_this.events.fire(GarageCamera.UPDATE,e)}function resizeHandler(){_this.worldCamera.aspect=Stage.width/Stage.height,_this.worldCamera.updateProjectionMatrix(),_slider.obj.width=Stage.width*_cars.length,_slider.width=Stage.width}this.worldCamera=World.CAMERA.clone(),async function(){TweenManager.addCustomEase({name:"cameraEase",curve:"cubic-bezier(.45,.2,.2,1)"}),_group.add(_this.worldCamera),_group.velocity=_this.initClass(VelocityTracker,_this.worldCamera.position),_group.velocity.start();let layers=await _layout.getAllLayers();for(let key in layers)layers[key]instanceof GarageCar&&_cars.push(layers[key]);_cars=_cars.sort((a,b)=>a.group.position.x-b.group.position.x),function initSlider(){let obj={x:0,width:Stage.width*_cars.length},slides=Config.LOCK_NEW_CARS?_cars.length-2:_cars.length;_slider=_this.initClass(Interaction.Slider,obj,{x:1},{width:Stage.width,slides:slides,hit:Stage}),_this.events.sub(_slider,Events.UPDATE,updateSlide),_slider.views=_cars,_slider.preventMovement=!0,_slider.obj=obj,_slider.easeTime=600,_slider.ease="cameraEase";let level=Data.levelDeepLink(),startSlide=level?parseInt(level)-1:Number(Storage.get("garageSlide"));startSlide>0&&!Global.PLAYGROUND&&_slider.jumpTo(startSlide)}(),function addListeners(){_this.events.sub(KeyboardUtil.DOWN,keyPress),_this.events.sub(GarageCamera.LEFT,debouncePrev),_this.events.sub(GarageCamera.RIGHT,debounceNext)}(),_this.onResize(resizeHandler),_this.startRender(loop)}(),this.onVisible=function(){Storage.set("garageSlide",_currentIndex),_slider.jumpTo(_currentIndex)},this.animateIn=function(){_group.position.y=2,_group.position.x=2,tween(_group.position,{y:0,x:0},2500,"easeOutQuart")}}),()=>{GarageCamera.LEFT="garagecamera_left",GarageCamera.RIGHT="garagecamera_right",GarageCamera.UPDATE="garagecamera_update"}),Class((function GarageCar(_input,_group){Inherit(this,Object3D);const _this=this;var _proxy,_ui,_rotation,_uiPos;this.posValue=0,this.posUIValue=0;var _targetPos=0,_wrapper=new Group;function loop(){_this.posValue=Math.lerp(_targetPos,_this.posValue,.07),_this.posUIValue=Math.lerp(_targetPos,_this.posUIValue,.1),_ui&&(_ui.state=_this.posUIValue)}function resize(){_uiPos.position.x=_uiPos.oX+Math.range(Stage.width/Stage.height,1.6,2.2,-.1,1.1)}!async function(){TweenManager.addCustomEase({name:"garageCamera",curve:"cubic-bezier(.37,.16,.18,.87)"}),_this.group.add(_wrapper);let name=_input.get("wildcard");_proxy=CarManager.instance().getCarProxy(name,_this),_wrapper.add(_proxy.group),_this.camera=_this.initClass(GazeCamera),_this.camera.group.rotation.x=-10,_this.camera.group.position.y=2,_this.camera.moveXY.y=0,_this.camera.lookAt.y=-1,_this.camera.prefix="garage_car_camera",_this.add(_this.camera.group),CameraUIL.add(_this.camera,_group).setLabel("Camera"),_this.camera.oRY=_this.camera.group.rotation.y;let uiPos=new Group;uiPos.prefix="ui_pos",_this.add(uiPos),MeshUIL.add(uiPos,_group),(_uiPos=uiPos).oX=_uiPos.position.x,_this.camera.useAccelerometer=!0,"Garage"!==Global.PLAYGROUND&&"Gameplay"!==Global.PLAYGROUND&&(_ui=_this.initClass(GarageCarUI,name));let garage=_this.findParent("Garage");garage&&garage.vfx&&garage.vfx.applyCar(_proxy.car),Utils.query("camera")==name&&_this.camera.lock(_this.findParent("Garage").worldCamera),async function initPedestal(){let shader=_this.initClass(PBRShader,"PBR",{unique:"garage_pedestal"});ShaderUIL.add(shader);let geom=await GeomThread.loadGeometry("environments/garage/cylinder"),mesh=new Mesh(geom,shader);_wrapper.add(mesh),_this.pedestal=mesh,mesh.prefix="garage_pedestal",MeshUIL.add(mesh,_group)}(),_rotation=_this.initClass(GarageCarRotation,_wrapper),_this.startRender(loop),_this.onResize(resize);let release=await Initializer3D.queue();_ui&&await _ui.prerender(),release(),_ui&&_this.parent.addInitializer(sync=>{if(!sync)return Initializer3D.uploadAllAsync(_ui.view.element.group)})}(),this.updatePosition=function(value){_targetPos=value,_rotation.enabled=Math.abs(value)<.01,Math.abs(value)>.5&&_this.flag("activated")&&_this.deactivate(),_ui&&(_ui.state=value)},this.activate=function(){_this.flag("activated")||(_this.flag("activated",!0),tween(_this.camera.group.rotation,{y:0},1500,"garageCamera"))},this.deactivate=function(){_this.flag("activated")&&(_this.flag("activated",!1),tween(_this.camera.group.rotation,{y:_this.camera.oRY},1500,"garageCamera"))},this.getAllLayers=function(){return _proxy.car.getLayers()},this.addUIAnchor=function(anchor){_uiPos.add(anchor)}})),Class((function GarageCarRotation(_root){Inherit(this,Component);var _input,_prevent,_moving,_this=this,_move=new Vector2,_hold=new Vector3,_target=new Vector3,_rotation=new Vector3,_velocity=new Vector3,_enabled=!1,_direction=1;function initInput(){_input=_this.initClass(Interaction,Stage),_this.events.sub(_input,Interaction.START,touchStart),_this.events.sub(_input,Interaction.MOVE,touchMove),_this.events.sub(_input,Interaction.END,touchEnd)}function loop(){_enabled&&(_moving||(_velocity.y=_enabled?_velocity.y-.12*_direction:0),_target.lerp(_velocity,.07*_this.lerp),_rotation.lerp(_target,.4*_this.lerp),_root.rotation.y=Math.radians(_rotation.y))}function touchStart(e){if(!_prevent){if(e.touches&&e.touches.length>1||"hit"==e.target.className)return _moving=!1;_moving=!0,_velocity.y=_target.y,_hold.y=_target.y,_hold.x=_target.x,.07}}function touchMove(e){_moving&&!_prevent&&(_target.y=_hold.y+-_input.move.x/Stage.width*_this.screenRotation,_direction=_velocity.y>_target.y?1:-1,_velocity.y=_target.y,_velocity.x=_target.x,_move.copy(_input.move),Math.range(Math.abs(_input.velocity.x),0,7,0,.5*_this.zOrigin))}function touchEnd(e){if(_moving&&!_prevent){var moveX=200*-Math.abs(_input.velocity.x)/Stage.width*_this.screenRotation*Math.sign(_move.x);Math.abs(_input.velocity.y),Stage.height,_this.screenRotation,_this.xLimit,Math.sign(_move.y);_move&&_move.length()>8&&(_velocity.y=_target.y+Math.clamp(moveX,-360,360)),0,.02,_moving=!1,_move&&(_move.x=0,_move.y=0)}}this.lerp=1,this.screenRotation=-180,defer(initInput),_this.startRender(loop),this.set("enabled",e=>{let check=_enabled;_prevent=!e,_enabled=e,check&&!e&&(Math.abs(_rotation.y)>360&&(_velocity.y=_target.y=_rotation.y=Math.mod(_rotation.y,360),_root.rotation.y=Math.radians(_rotation.y)),tween(_velocity,{x:0,y:0},2e3,"easeInOutCubic"),tween(_target,{x:0,y:0},2e3,"easeInOutCubic"),tween(_rotation,{x:0,y:0},2e3,"easeInOutCubic"),tween(_root.rotation,{y:0},2e3,"easeInOutCubic"))})})),Class((function GarageCarUI(_name){Inherit(this,GLUIElement);const _this=this;var $this;const START_X=-1.2;var _start,_controls,_share,_view,$quadSelect,_captureSelect,$quadStart,_captureStart,_last=0,_unlocked=!1,_starting=!1;function getViews(){let type="Debug";switch(_name){case"integra":type="Integra";break;case"rdx":type="RDX";break;case"old_nsx":type="OldNSX";break;case"arx":type="Arx";break;case"new_nsx":type="NewNSX";break;case"type_s":type="TypeS"}return[`GarageCarUIControls${type}`,`GarageCarUILocked${type}`,`GarageCarUISelect${type}`,`GarageCarUIStart${type}`]}function resize(){let dpr=RenderManager.DPR;GarageCarUI.getRTPool().setSize(Stage.width*dpr,Stage.height*dpr),$quadSelect.width=Stage.width/Stage.height,$quadSelect.height=1,$quadStart.width=Stage.width/Stage.height,$quadStart.height=1,_captureSelect.setSize(Stage.width,Stage.height),_captureStart.setSize(Stage.width,Stage.height)}async function onClick({type:type}){if(!_this.flag("clicked"))switch(type){case"select":if(!_captureSelect.enabled)return;_this.parent.activate(),_view.animateOut(),$quadSelect.tween({alpha:0},300,"easeOutSine"),$quadStart.alpha=0,await _this.wait(300),_captureSelect.enabled=!1,$quadStart.x=START_X,$quadStart.tween({alpha:1},300,"easeOutSine"),_captureStart.enabled=!0,$quadSelect.x=2e3,_controls.animateOut(),_start.animateIn(),Track.event("Garage","click",`select-level${Data.getTrackNumberByName(_name)}`);break;case"start":_this.flag("clicked",!0),Track.event("Garage","click",`start-level${Data.getTrackNumberByName(_name)}`),_starting=!0,_captureSelect.enabled=!1,_captureStart.enabled=!1,ViewController.instance().showLoader(_name),await _this.animateOut(),_start.loading&&_start.loading();let track=Data.getTrackByCar(_name);await ViewController.instance().playTrack(track),ViewController.instance().hideLoader();break;case"share":Track.event("Garage","click",`share-level${Data.getTrackNumberByName(_name)}`),Config.FACEBOOK||Share.supports.native?Data.tracks[_name].shareTrack("native"):async function showShare(){await _view.animateOut(),_share.animateIn(),_controls.animateOut()}();break;case"prev":_this.events.fire(GarageCamera.LEFT);break;case"next":_this.events.fire(GarageCamera.RIGHT);break;case"leaderboard":Track.event("Garage","click",`leaderboard-level${Data.getTrackNumberByName(_name)}`),ViewController.instance().showLeaderboard(_name);break;case"garage":_this.parent.deactivate(),_start.animateOut(),$quadStart.tween({alpha:0},300,"easeOutSine"),$quadSelect.alpha=0,await _this.wait(300),_captureStart.enabled=!1,$quadSelect.tween({alpha:1},300,"easeOutSine"),$quadSelect.x=0,$quadStart.x=2e3,_view.animateIn(),_controls.animateIn(),_captureSelect.enabled=!0}}function onChange({view:view}){switch(view){case"Garage":_this.flag("canShow",!0),$this.alpha=0,_starting=!1;break;default:_this.flag("canShow",!1),_this.animateOut()}}function onVisibility({state:state}){switch(state){case"loader":_this.animateOut()}}function closeShare(){_share.animateOut(),_view.animateIn(),_controls.animateIn()}!async function(){await Data.ready(),await async function initHTML(){await _this.wait(GLUI.Stage,"GameLayer"),$this=_this.element,GLUI.Stage.GameLayer.add($this),_this.flag("hidden",!0),$this.hide()}(),await async function initView(){let[controls,locked,select,start]=getViews();_start=_this.initClass(window[start],_name),_controls=_this.initClass(window[controls],_name),_share=_this.initClass(ShareUI,_name,{track:!0}),_view=(_unlocked=await Data.tracks[_name].isUnlocked())?new window[select](_name):new window[locked](_name);_this.view=_view,await _view.ready()}(),await async function initCapture(){_captureSelect=_this.initClass(StageLayoutCapture,_view,Stage.width,Stage.height);let blending=_name&&_name.includes(["type_s","new_nsx"])?Shader.ADDITIVE_BLENDING:Shader.NORMAL_BLENDING,shader=_this.initClass(Shader,"StageLayoutCapture",{tMap:{value:_captureSelect},uAlpha:{value:1},depthWrite:!1,transparent:!0,blending:blending});($quadSelect=$gl(Stage.width/Stage.height,1,_captureSelect)).scale=4.5,$quadSelect.alpha=0,$quadSelect.enable3D(),$quadSelect.useShader(shader),_captureSelect.object3d=$quadSelect,_captureSelect.enabled=!1;let garage=_this.findParent("Garage");_captureSelect.hitCamera=garage.camera.worldCamera,GLUI.Scene.camera=garage.camera.worldCamera,GLUI.Scene.add($quadSelect),_this.parent&&_this.parent.addUIAnchor&&_this.parent.addUIAnchor($quadSelect.anchor);garage&&garage.vfx.addUI($quadSelect.mesh);$quadSelect.y=-1.75,$quadSelect.x=.4,$quadSelect.rotation.y=-Math.radians(30),_captureStart=_this.initClass(StageLayoutCapture,_start,Stage.width,Stage.height),shader=_this.initClass(Shader,"StageLayoutCapture",{tMap:{value:_captureStart},uAlpha:{value:1},depthWrite:!1,transparent:!0,blending:blending}),($quadStart=$gl(Stage.width/Stage.height,1,_captureStart)).scale=4.5,$quadStart.alpha=0,$quadStart.enable3D(),$quadStart.useShader(shader),_captureStart.object3d=$quadStart,_captureStart.hitCamera=garage.camera.worldCamera,_captureStart.enabled=!1,GLUI.Scene.camera=garage.camera.worldCamera,GLUI.Scene.add($quadStart),_this.parent.addUIAnchor($quadStart.anchor),garage&&garage.vfx.addUI($quadStart.mesh);$quadStart.y=-1.7,$quadStart.x=2e3,$quadStart.scale*=.85,$quadStart.rotation.y=-Math.radians(20),_this.flag("hasCapture",!0)}(),function addHandlers(){_this.events.sub(ViewController.CHANGE,onChange),_this.events.sub(UIConfig.VISIBILITY,onVisibility),_this.events.sub(_view,Events.CLICK,onClick),_this.events.sub(_start,Events.CLICK,onClick),_this.events.sub(_controls,Events.CLICK,onClick),_this.events.sub(_share,Events.COMPLETE,closeShare),_this.onResize(resize)}(),_this.isReady=!0}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateOut=async function(){_this.isReady&&_this.flag("showing")&&(_this.flag("blockChange")||(_this.flag("showing",!1),_this.flag("blockChange",!0,1e3),$this.tween({alpha:0},500,"easeInOutSine"),$quadSelect.tween({alpha:0},500,"easeInOutSine"),$quadStart.tween({alpha:0},500,"easeInOutSine"),_share.element.tween({alpha:0},500,"easeInOutSine"),ViewController.instance().hideLeaderboard(),await Promise.all([_view.animateOut(),_start.animateOut(),_share.animateOut(),_controls.animateOut()]),await _this.wait(500),$this.y=1e3,$quadStart.x=START_X,$quadSelect.x=0,$this.hide(),_captureSelect.enabled=!1,_captureStart.enabled=!1))},this.animateIn=async function(){if(!_this.isReady)return;if(!_this.flag("canShow"))return;if(_this.flag("showing"))return;if(_this.flag("blockChange"))return;_this.flag("clicked",!1),_this.flag("showing",!0),_this.flag("blockChange",!0,1e3);let isUnlocked=await Data.tracks[_name].isUnlocked();!_unlocked&&isUnlocked&&await async function unlockView(){let[controls,locked,select,start]=getViews();_this.events.unsub(_view,Events.CLICK,onClick),_view=new window[select](_name),_this.view=_view,await _view.ready(),_captureSelect.layout=_view,_this.events.sub(_view,Events.CLICK,onClick),_unlocked=!0}(),$this.y=0,$this.show(),$this.alpha=0,$this.tween({alpha:1},1500,"easeInOutSine"),$quadStart.x=2e3,$quadSelect.x=0,_view.animateIn(),_controls.animateIn(),_start.animateOut(),_captureSelect.enabled=!0,_captureStart.enabled=!1,_starting=!1,$quadSelect.tween({alpha:1},1500,"easeInOutSine"),$quadStart.tween({alpha:1},1500,"easeInOutSine"),_share.element.tween({alpha:1},1500,"easeInOutSine",1e3)},this.set("state",v=>{if(!$this||!$quadSelect)return;_captureSelect.visible=Math.abs(v)<.5,$quadSelect.alpha=$this.alpha,$quadStart.alpha=$this.alpha,_share.element.x=$this.y;let old=_last;_last=v,_starting||Math.abs(v-old)>.2||(Math.abs(v)<.05?_this.animateIn():_this.animateOut())}),this.prerender=async function(){await _this.wait("hasCapture"),await _this.wait(100),await Initializer3D.uploadAllAsync(_captureSelect.scene),_captureSelect.render(!0)}}),()=>{let pool=null;GarageCarUI.getRTPool=()=>(pool||(pool=StageLayoutCapture.createRTPool(1,1)),pool)}),Class((function GarageCarUIControlsArx(_name="arx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2;function hover(e){}function click(e){let type;switch(e.object.id){case"icon-share":type="share";break;case"icon-arrow-right":type="next";break;case"icon-arrow-left":type="prev"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level4_controls"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","icon-arrow"])&&_this.registerButton("ArxButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.ArxIcon(layer,id),"logo"==id&&(layer.useShader(layer.textureShader),layer.shader.set("tMap",Utils3D.getTexture("assets/images/uistyles/acura-logo.png")))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.animateIn=function(){$this.show(),$this.tween({alpha:1},400,"easeOutQuart")},this.animateOut=async function(){await $this.tween({alpha:1e-5},400,"easeOutQuart").promise(),$this.hide()}})),Class((function GarageCarUILockedArx(_name="arx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;!async function(){await _this.initLayout("level4_locked"),await async function applyData(){let layer=_this.layers.text;if(!layer)return;await layer.text.loaded(),layer.text.originalText||(layer.text.originalText=layer.text.string.toUpperCase());let previous=Config.TRACKS[Config.TRACKS.indexOf(_name)-1];const time=Numbers.formatTime(Qualifying[previous].time);layer.text.setText(layer.text.originalText.replace("[TIME]",time))}(),function parseLayers(){for(let id in _this.layers){let layer=_this.layers[id];"lock"==id&&UIFigmaStyles.ArxIcon(layer,id)}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon","text","lock"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=1e-4,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},200,"easeOutSine"),await $this.tween({alpha:1e-5},200,"easeOutSine").promise(),$this.hide())}})),Class((function GarageCarUISelectArx(_name="arx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2,_specs=[];function hover(e){e.object.button&&_this.hover(e,e.object.button)}function click(e){if(!_this.flag("isVisible"))return;let type;switch(e.object.button&&_this.click(e,e.object.button),e.object.id){case"select-button":case"hit-area":type="select"}type&&_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level4_select"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["rotate-ring","rotate-bar"])?(layer.alpha=0,layer.parent.removeChild(layer)):("hit-area"==id&&(layer.alpha=Global.PLAYGROUND?.1:1e-5,layer.interact(hover,click),layer.button=_this.layers["select-button"],layer.setZ(100)),id.includes(["button","share","sound","icon-arrow"])&&!id.includes(["icon-sound-image","icon-share-image","select-button"])&&_this.registerButton("ArxButton",hover,click,layer),"select-button"==id&&UIFigmaStyles.ArxButton(layer),id.includes("icon")&&UIFigmaStyles.ArxIcon(layer,id),id.includes("spec-bar")&&(UIFigmaStyles.ArxSpecBar(layer,id),_specs.push(layer)))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=1e-4,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}_specs.forEach($spec=>{$spec.value||($spec.value=$spec.shader.uniforms.uSpecValue.value);let delay=Math.range($spec.y,130,300,0,600,!0);$spec.shader.set("uSpecValue",0),$spec.shader.tween("uSpecValue",$spec.value,1200,"easeOutCubic",delay+200+50)})},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},500,"easeInOutSine"),await $this.tween({alpha:1e-5},500,"easeInOutSine").promise(),$this.hide())}})),Class((function GarageCarUIStartArx(_name="arx"){Inherit(this,UIFigma);const _this=this;var $loading,$this=_this.element,_time=(new Euler,"--:--.---");async function updateScore(){let score=Qualifying[_name]?Qualifying[_name].time:0;_time=Numbers.formatTime(score),_this.layers["qualifying-time"].setText(`${_time}`)}function hover(e){}function click(e){let type;switch(e.object.id){case"leader-board-button":type="leaderboard";break;case"icon-close":type="garage";break;case"start":case"start-button":_this.flag("clicked")||(_this.flag("clicked",!0),type="start")}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){$loading=$glText("Loading...","HelveticaNeue-Medium",24,{align:"center",color:"#ffffff"}),$this.add($loading),$loading.alpha=0}(),await _this.initLayout("level4_start"),await updateScore(),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","sound","close"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton("ArxButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.ArxIcon(layer,id),id.includes("lockup")&&UIFigmaStyles.ArxLockup(layer)}}(),_this.flag("isReady",!0),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){await _this.ready(),await updateScore(),_this.flag("clicked",!1);let y=$this.y;$this.y+=10,$this.alpha=0,$this.show(),await defer(),$this.tween({y:y,alpha:1},600,"easeOutQuart",160);for(let id in _this.layers){let $layer=_this.layers[id];if(!id.includes(["undefined"])){let delay=Math.range($layer.y,0,400,0,800,!0);id.includes(["start","icon-play"])&&(delay+=100),$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay)}}},this.animateOut=async function(){await _this.ready(),$loading.alpha=0;let y=$this.y;await $this.tween({y:y+10,alpha:0},600,"easeOutQuart").promise(),$this.hide(),$this.y=y},this.loading=function(){$this.hide(),$loading.x=.5*Stage.width,$loading.y=.5*Stage.height-12,$loading.alpha=1},this.hide=function(){$this.hide()}})),Class((function GarageCarUIDebugSelect(_name){Inherit(this,GLUIElement);const _this=this;var $this,_layers;new Euler;function hover(e){}function click(){_this.events.fire(Events.CLICK,{action:"select"})}function resize(){$this.x=.666*Stage.width-150,$this.y=.5*Stage.height-100}!async function(){!function initGL(){$this=_this.element}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"GarageCarUISpecsDebugView",{glui:!0}),_layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),await async function applyData(){_layers.select.setText(`Select ${_name}`),_layers.name.setText(`${_name}`)}(),function addHandlers(){_layers["hit-area"].interact(hover,click),_layers["hit-area"].alpha=1e-4,_this.onResize(resize)}(),_this.flag("isReady",!0)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){$this.show()},this.animateOut=async function(){$this.hide()}})),Class((function GarageCarUIDebugStart(_name){Inherit(this,GLUIElement);const _this=this;new Euler;var $this,$loading,_layers,_time="--:--.---";async function updateScore(){let score=Qualifying[_name].time;_time=Numbers.formatTime(score),_layers.time.setText(`${_time}`)}function resize(){$this.x=.5*Stage.width-150,$this.y=.75*Stage.height-100}function hover(e){}function click(){_this.flag("clicked")||(_this.flag("clicked",!0),_this.events.fire(Events.CLICK,{action:"start"}))}!async function(){!function initGL(){$this=_this.element,GLUI.Stage.add($this),"GarageCarUIDebugStart"!==Global.PLAYGROUND&&$this.hide();$loading=$glText("Loading...","HelveticaNeue-Medium",24,{align:"center",color:"#ffffff"}),GLUI.Stage.add($loading),$loading.alpha=0}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"GarageCarUIDebugStart",{glui:!0}),_layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),await async function initData(){_layers.car.setText(`${_name}`)}(),await updateScore(),function addHandlers(){_layers["hit-area"].interact(hover,click),_layers["hit-area"].alpha=1e-5,_this.onResize(resize)}(),_this.flag("isReady",!0)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){await _this.ready(),await updateScore(),$this.show(),console.log("show"),_this.flag("clicked",!1)},this.animateOut=async function(){await _this.ready(),$loading.alpha=0,$this.hide()},this.loading=function(){$this.hide(),$loading.x=.5*Stage.width,$loading.y=.5*Stage.height-12,$loading.alpha=1},this.hide=function(){$this.hide()}})),Class((function GarageCarUIDebugView(_name){Inherit(this,GLUIElement);const _this=this;var $this,$quad,_layers,_shader,_camera;new Euler;function loop(){$quad.x=1.25,$quad.z=2.5,$quad.rotation.y=-.5}function hover(e){}function click(){_this.events.fire(Events.CLICK,{action:"select"})}!async function(){!function initGL(){$this=_this.element}(),await async function initLayout(){_this.layout=_this.initClass(StageLayout,"GarageCarUISpecsDebugView",{glui:!0}),_layers=await _this.layout.getAllLayers(),$this.add(_this.layout.element)}(),await async function applyData(){_layers.select.setText(`Select ${_name}`)}(),function initCapture(){let capture=_this.initClass(StageLayoutCapture,_this.layout,500,250);_shader=_this.initClass(Shader,"StageLayoutCapture",{tMap:{value:capture},uAlpha:{value:1},depthWrite:!1,transparent:!0}),($quad=$gl(2,1,capture)).useShader(_shader),$quad.mesh.visible="GarageCarUIDebugView"===Global.PLAYGROUND,GLUI.Scene.add($quad),capture.object3d=$quad}(),function initPosition(){if(_camera=!!_this.findParent("Garage")&&_this.findParent("Garage").camera.worldCamera,!_this.findParent("GarageCar")||!_camera)return;_this.startRender(loop)}(),function addHandlers(){_layers["hit-area"].interact(hover,click),_layers["hit-area"].alpha=1e-4}(),_this.flag("isReady",!0)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){await _this.ready(),$quad.y=0,$quad.alpha=0,$quad.mesh.visible=!0,tween($quad,{y:-.35,alpha:1},300,"easeOutCubic")},this.animateOut=async function(){await _this.ready(),tween($quad,{y:-.7,alpha:0},300,"easeInCubic").onComplete(_=>{$quad.mesh.visible=!1})},this.hide=function(){$quad.mesh.visible=!1}})),Class((function GarageCarUIControlsIntegra(_name="integra"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2;function hover(e){}function click(e){let type;switch(e.object.id){case"icon-share":type="share";break;case"icon-box-arrow-right":type="next";break;case"icon-box-arrow-left":type="prev"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level2_controls"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","icon-box"])&&_this.registerButton("IntegraButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.IntegraIcon(layer,id),"logo"==id&&(layer.useShader(layer.textureShader),layer.shader.set("tMap",Utils3D.getTexture("assets/images/uistyles/acura-logo.png")))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.applyText=function(layer){UIFigmaStyles.IntegraText(layer)},this.animateIn=function(){$this.show(),$this.tween({alpha:1},400,"easeOutQuart")},this.animateOut=async function(){await $this.tween({alpha:1e-5},400,"easeOutQuart").promise(),$this.hide()}})),Class((function GarageCarUILockedIntegra(_name="integra"){Inherit(this,UIFigma);const _this=this,$this=_this.element;!async function(){await _this.initLayout("level2_locked"),await async function applyData(){let layer=_this.layers.text;if(!layer)return;await layer.text.loaded(),layer.text.originalText||(layer.text.originalText=layer.text.string.toUpperCase());let previous=Config.TRACKS[Config.TRACKS.indexOf(_name)-1];const time=Numbers.formatTime(Qualifying[previous].time);layer.text.setText(layer.text.originalText.replace("[TIME]",time))}(),function parseLayers(){for(let id in _this.layers){let layer=_this.layers[id];"lock"==id&&UIFigmaStyles.IntegraIcon(layer,id)}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon","text","lock"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},200,"easeOutSine"),await $this.tween({alpha:1e-5},200,"easeOutSine").promise(),$this.hide())}})),Class((function GarageCarUISelectIntegra(_name="integra"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2,_specs=[];function hover(e){e.object.button&&_this.hover(e,e.object.button)}function click(e){if(!_this.flag("isVisible"))return;let type;switch(e.object.button&&_this.click(e,e.object.button),e.object.id){case"select-button":case"hit-area":type="select"}type&&_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level2_select"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["rotate-ring","rotate-bar"])?(layer.alpha=0,layer.parent.removeChild(layer)):("hit-area"==id&&(layer.alpha=Global.PLAYGROUND?.5:1e-5,layer.interact(hover,click),layer.button=_this.layers["select-button"],layer.setZ(100)),id.includes(["button","share","sound","icon-box"])&&!id.includes(["icon-sound-image","icon-share-image","select-button"])&&_this.registerButton("IntegraButton",hover,click,layer),"select-button"==id&&UIFigmaStyles.IntegraButton(layer),id.includes("icon")&&UIFigmaStyles.IntegraIcon(layer,id),id.includes("spec-bar")&&(UIFigmaStyles.IntegraSpecBar(layer,id),_specs.push(layer)),id.includes("model-name")&&UIFigmaStyles.IntegraTitleText(layer),id.includes("sparkle")&&UIFigmaStyles.IntegraShine(layer))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.applyText=function(layer){UIFigmaStyles.IntegraText(layer)},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=1e-4,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}_specs.forEach($spec=>{$spec.value||($spec.value=$spec.shader.uniforms.uSpecValue.value);let delay=Math.range($spec.y,130,300,0,600,!0);$spec.shader.set("uSpecValue",0),$spec.shader.tween("uSpecValue",$spec.value,1200,"easeOutCubic",delay+200+50)})},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},500,"easeInOutSine"),await $this.tween({alpha:1e-5},500,"easeInOutSine").promise(),$this.hide())}})),Class((function GarageCarUIStartIntegra(_name="integra"){Inherit(this,UIFigma);const _this=this;var $loading,$this=_this.element,_time=(new Euler,"--:--.---");async function updateScore(){let score=Qualifying[_name]?Qualifying[_name].time:0;_time=Numbers.formatTime(score),_this.layers["qualifying-time"].setText(`${_time}`)}function hover(e){}function click(e){let type;switch(e.object.id){case"leader-board-button":type="leaderboard";break;case"icon-close":type="garage";break;case"start":case"start-button":_this.flag("clicked")||(_this.flag("clicked",!0),type="start")}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){$loading=$glText("Loading...","HelveticaNeue-Medium",24,{align:"center",color:"#ffffff"}),$this.add($loading),$loading.alpha=0}(),await _this.initLayout("level2_start"),await updateScore(),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","sound","close"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton("IntegraButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.IntegraIcon(layer,id),id.includes("lockup")&&UIFigmaStyles.IntegraLockup(layer),id.includes("qualifying-time")&&UIFigmaStyles.IntegraTitleText(layer),id.includes("sparkle")&&UIFigmaStyles.IntegraShine(layer)}}(),_this.flag("isReady",!0),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.applyText=function(layer){UIFigmaStyles.IntegraText(layer)},this.animateIn=async function(){await _this.ready(),await updateScore(),_this.flag("clicked",!1);let y=$this.y;$this.y+=10,$this.alpha=0,$this.show(),await defer(),$this.tween({y:y,alpha:1},600,"easeOutQuart",160);for(let id in _this.layers){let $layer=_this.layers[id];if(!id.includes(["undefined"])){let delay=Math.range($layer.y,0,400,0,800,!0);id.includes(["start","icon-play"])&&(delay+=100),$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay)}}},this.animateOut=async function(){await _this.ready(),$loading.alpha=0;let y=$this.y;await $this.tween({y:y+10,alpha:0},600,"easeOutQuart").promise(),$this.hide(),$this.y=y},this.loading=function(){$this.hide(),$loading.x=.5*Stage.width,$loading.y=.5*Stage.height-12,$loading.alpha=1},this.hide=function(){$this.hide()}})),Class((function GarageCarUIControlsNewNSX(_name="new_nsx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2;function hover(e){}function click(e){let type;switch(e.object.id){case"icon-share":type="share";break;case"icon-arrow-left":type="prev";break;case"icon-arrow-right":type="next"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level5_controls"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","icon-arrow"])&&_this.registerButton("NewNSXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.NewNSXIcon(layer,id),"logo"==id&&(layer.useShader(layer.textureShader),layer.shader.set("tMap",Utils3D.getTexture("assets/images/uistyles/acura-logo.png"))),Data.tracks[_name].isAvailable()||id.includes("share")&&(layer.alpha=0,layer.mesh.visible=!1)}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.animateIn=function(){$this.show(),$this.tween({alpha:1},400,"easeOutQuart")},this.animateOut=async function(){await $this.tween({alpha:1e-5},400,"easeOutQuart").promise(),$this.hide()}})),Class((function GarageCarUILockedNewNSX(_name="new_nsx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;!async function(){await _this.initLayout("level5_locked"),await async function applyData(){let layer=_this.layers.text;if(!layer)return;await layer.text.loaded(),layer.text.originalText||(layer.text.originalText=layer.text.string.toUpperCase());let previous=Config.TRACKS[Config.TRACKS.indexOf(_name)-1];const time=Numbers.formatTime(Qualifying[previous].time);layer.text.setText(layer.text.originalText.replace("[TIME]",time))}(),function parseLayers(){for(let id in _this.layers){let layer=_this.layers[id];"lock"==id&&UIFigmaStyles.NewNSXIcon(layer,id)}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon","text","lock"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=1e-4,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},500,"easeInOutSine"),await $this.tween({alpha:1e-5},500,"easeInOutSine").promise(),$this.hide())}})),Class((function GarageCarUISelectNewNSX(_name="new_nsx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2,_specs=[];function hover(e){e.object.button&&_this.hover(e,e.object.button)}function click(e){if(!_this.flag("isVisible"))return;let type;switch(e.object.button&&_this.click(e,e.object.button),e.object.id){case"select-button":case"hit-area":type="select"}type&&_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level5_select"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes("rotate")?(layer.alpha=0,layer.parent.removeChild(layer)):("hit-area"==id&&(layer.alpha=Global.PLAYGROUND?.5:1e-5,layer.interact(hover,click),layer.button=_this.layers["select-button"],layer.setZ(100)),id.includes(["button","share","sound"])&&_this.registerButton("NewNSXButton",hover,click,layer),"select-button"==id&&UIFigmaStyles.NewNSXButton(layer),id.includes("icon")&&UIFigmaStyles.NewNSXIcon(layer,id),id.includes("spec-bar")&&(UIFigmaStyles.NewNSXSpecBar(layer,id),_specs.push(layer)))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=1e-4,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}_specs.forEach($spec=>{$spec.value||($spec.value=$spec.shader.uniforms.uSpecValue.value);let delay=Math.range($spec.y,130,300,0,600,!0);$spec.shader.set("uSpecValue",0),$spec.shader.tween("uSpecValue",$spec.value,1200,"easeOutCubic",delay+200+50)})},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},500,"easeInOutSine"),await $this.tween({alpha:1e-5},500,"easeInOutSine").promise(),$this.hide())}})),Class((function GarageCarUIStartNewNSX(_name="new_nsx"){Inherit(this,UIFigma);const _this=this;var $loading,$this=_this.element,_time=(new Euler,"--:--.---");async function updateScore(){let score=Qualifying[_name]?Qualifying[_name].time:0;_time=Numbers.formatTime(score),_this.layers["qualifying-time"].setText(`${_time}`)}function hover(e){e.object.button&&_this.hover(e,e.object.button)}function click(e){let type;switch(e.object.id){case"leader-board-button":type="leaderboard";break;case"close-icon":case"button-close":type="garage";break;case"start":case"start-button":_this.flag("clicked")||(_this.flag("clicked",!0),type="start")}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){$loading=$glText("Loading...","HelveticaNeue-Medium",24,{align:"center",color:"#ffffff"}),$this.add($loading),$loading.alpha=0}(),await _this.initLayout("level5_start"),await updateScore(),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","sound"])&&_this.registerButton("NewNSXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.NewNSXIcon(layer,id),id.includes("lockup")&&UIFigmaStyles.NewNSXLockup(layer),id.includes("close")&&(layer.interact(hover,click),layer.button=layer)}}(),_this.flag("isReady",!0),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){await _this.ready(),await updateScore(),_this.flag("clicked",!1);let y=$this.y;$this.y+=10,$this.alpha=0,$this.show(),await defer(),$this.tween({y:y,alpha:1},600,"easeOutQuart",160);for(let id in _this.layers){let $layer=_this.layers[id];if(!id.includes(["undefined"])){let delay=Math.range($layer.y,0,400,0,800,!0);id.includes(["start","icon-play"])&&(delay+=100),$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay)}}},this.animateOut=async function(){await _this.ready(),$loading.alpha=0;let y=$this.y;await $this.tween({y:y+10,alpha:0},600,"easeOutQuart").promise(),_this.flag("clicked",!1),$this.hide(),$this.y=y},this.loading=function(){$this.hide(),$loading.x=.5*Stage.width,$loading.y=.5*Stage.height-12,$loading.alpha=1},this.hide=function(){$this.hide()}})),Class((function GarageCarUIControlsOldNSX(_name="old_nsx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2;function hover(e){}function click(e){let type;switch(e.object.id){case"button-share":case"icon-share":type="share";break;case"button-arrow-right":type="next";break;case"button-arrow-left":type="prev"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level1_controls"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","sound"])&&_this.registerButton("OldNSXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.OldNSXIcon(layer,id),"logo"==id&&(layer.useShader(layer.textureShader),layer.shader.set("tMap",Utils3D.getTexture("assets/images/uistyles/acura-logo.png")))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.animateIn=function(){$this.show(),$this.tween({alpha:1},400,"easeOutQuart")},this.animateOut=async function(){await $this.tween({alpha:1e-5},400,"easeOutQuart").promise(),$this.hide()}})),Class((function GarageCarUISelectOldNSX(_name="old_nsx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2,_specs=[];function hover(e){e.object.button&&_this.hover(e,e.object.button)}function click(e){if(!_this.flag("isVisible"))return;let type;switch(e.object.button&&_this.click(e,e.object.button),e.object.id){case"select-button":case"hit-area":type="select"}type&&_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level1_select"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes("rotate")?(layer.alpha=0,layer.parent.removeChild(layer)):("hit-area"==id&&(layer.alpha=Global.PLAYGROUND?.5:1e-5,layer.interact(hover,click),layer.button=_this.layers["select-button"],layer.setZ(100)),id.includes(["button","share","sound"])&&!id.includes(["icon-sound-image","icon-share-image","select-button"])&&_this.registerButton("OldNSXButton",hover,click,layer),"select-button"==id&&UIFigmaStyles.OldNSXButton(layer),id.includes("icon")&&UIFigmaStyles.OldNSXIcon(layer,id),id.includes("spec-bar")&&(UIFigmaStyles.OldNSXSpecBar(layer,id),_specs.push(layer)))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=1e-4,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}_specs.forEach($spec=>{$spec.value||($spec.value=$spec.shader.uniforms.uSpecValue.value);let delay=Math.range($spec.y,130,300,0,600,!0);$spec.shader.set("uSpecValue",0),$spec.shader.tween("uSpecValue",$spec.value,1200,"easeOutCubic",delay+200+50)})},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},500,"easeInOutSine"),await $this.tween({alpha:1e-5},500,"easeInOutSine").promise(),$this.hide())}})),Class((function GarageCarUIStartOldNSX(_name="old_nsx"){Inherit(this,UIFigma);const _this=this;var $loading,$this=_this.element,_time=(new Euler,"--:--.---");async function updateScore(){let score=Qualifying[_name]?Qualifying[_name].time:0;_time=Numbers.formatTime(score),_this.layers["qualifying-time"].setText(`${_time}`)}function hover(e){}function click(e){let type;switch(e.object.id){case"leader-board-button":type="leaderboard";break;case"icon-close":case"button-close":type="garage";break;case"start":case"start-button":_this.flag("clicked")||(_this.flag("clicked",!0),type="start")}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){$loading=$glText("Loading...","HelveticaNeue-Medium",24,{align:"center",color:"#ffffff"}),$this.add($loading),$loading.alpha=0}(),await _this.initLayout("level1_start"),await updateScore(),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","sound"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton("OldNSXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.OldNSXIcon(layer,id),id.includes("lockup")&&UIFigmaStyles.OldNSXLockup(layer)}}(),_this.flag("isReady",!0),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){await _this.ready(),await updateScore(),_this.flag("clicked",!1);let y=$this.y;$this.y+=10,$this.alpha=0,$this.show(),await defer(),$this.tween({y:y,alpha:1},600,"easeOutQuart",160);for(let id in _this.layers){let $layer=_this.layers[id];if(!id.includes(["undefined"])){let delay=Math.range($layer.y,0,400,0,800,!0);id.includes(["start","icon-play"])&&(delay+=100),$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay)}}},this.animateOut=async function(){await _this.ready(),$loading.alpha=0;let y=$this.y;await $this.tween({y:y+10,alpha:0},600,"easeOutQuart").promise(),_this.flag("clicked",!1),$this.hide(),$this.y=y},this.loading=function(){$this.hide(),$loading.x=.5*Stage.width,$loading.y=.5*Stage.height-12,$loading.alpha=1},this.hide=function(){$this.hide()}})),Class((function GarageCarUIControlsRDX(_name="rdx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2;function hover(e){}function click(e){let type;switch(e.object.id){case"icon-share":type="share";break;case"icon-arrow-right":type="next";break;case"icon-arrow-left":type="prev"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level3_controls"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","sound","icon-arrow"])&&_this.registerButton("RDXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.RDXIcon(layer,id),"logo"==id&&(layer.useShader(layer.textureShader),layer.shader.set("tMap",Utils3D.getTexture("assets/images/uistyles/acura-logo.png")))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.animateIn=function(){$this.show(),$this.tween({alpha:1},400,"easeOutQuart")},this.animateOut=async function(){await $this.tween({alpha:1e-5},400,"easeOutQuart").promise(),$this.hide()}})),Class((function GarageCarUILockedRDX(_name="rdx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;!async function(){await _this.initLayout("level3_locked"),await async function applyData(){let layer=_this.layers.text;if(!layer)return;await layer.text.loaded(),layer.text.originalText||(layer.text.originalText=layer.text.string.toUpperCase());let previous=Config.TRACKS[Config.TRACKS.indexOf(_name)-1];const time=Numbers.formatTime(Qualifying[previous].time);layer.text.setText(layer.text.originalText.replace("[TIME]",time))}(),function parseLayers(){for(let id in _this.layers){let layer=_this.layers[id];"lock"==id&&UIFigmaStyles.RDXIcon(layer,id)}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon","text","lock"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},200,"easeOutSine"),await $this.tween({alpha:1e-5},200,"easeOutSine").promise(),$this.hide())}})),Class((function GarageCarUISelectRDX(_name="rdx"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2,_specs=[];function hover(e){e.object.button&&_this.hover(e,e.object.button)}function click(e){if(!_this.flag("isVisible"))return;let type;switch(e.object.button&&_this.click(e,e.object.button),e.object.id){case"select-button":case"hit-area":type="select"}type&&_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level3_select"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["rotate-ring","rotate-bar"])?(layer.alpha=0,layer.parent.removeChild(layer)):("hit-area"==id&&(layer.alpha=Global.PLAYGROUND?.1:1e-4,layer.interact(hover,click),layer.setZ(500),layer.button=_this.layers["select-button"]),id.includes(["button","icon-arrow"])&&!id.includes("select-button")&&_this.registerButton("RDXButton",hover,click,layer),"select-button"==id&&UIFigmaStyles.RDXButton(layer),id.includes("icon")&&UIFigmaStyles.RDXIcon(layer,id),id.includes("spec-bar")&&(UIFigmaStyles.RDXSpecBar(layer,id),_specs.push(layer)))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=1e-4,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}_specs.forEach($spec=>{$spec.value||($spec.value=$spec.shader.uniforms.uSpecValue.value);let delay=Math.range($spec.y,130,300,0,600,!0);$spec.shader.set("uSpecValue",0),$spec.shader.tween("uSpecValue",$spec.value,1200,"easeOutCubic",delay+200+50)})},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},500,"easeInOutSine"),await $this.tween({alpha:1e-5},500,"easeInOutSine").promise(),$this.hide())}})),Class((function GarageCarUIStartRDX(_name="rdx"){Inherit(this,UIFigma);const _this=this;var $loading,$this=_this.element,_time=(new Euler,"--:--.---");async function updateScore(){let score=Qualifying[_name]?Qualifying[_name].time:0;_time=Numbers.formatTime(score),_this.layers["qualifying-time"].setText(`${_time}`)}function hover(e){}function click(e){let type;switch(e.object.id){case"leader-board-button":type="leaderboard";break;case"icon-close":type="garage";break;case"start":case"start-button":_this.flag("clicked")||(_this.flag("clicked",!0),type="start")}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){$loading=$glText("Loading...","HelveticaNeue-Medium",24,{align:"center",color:"#ffffff"}),$this.add($loading),$loading.alpha=0}(),await _this.initLayout("level3_start"),await updateScore(),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","sound","close"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton("RDXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.RDXIcon(layer,id),id.includes("lockup")&&UIFigmaStyles.RDXLockup(layer)}}(),_this.flag("isReady",!0),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){await _this.ready(),await updateScore(),_this.flag("clicked",!1);let y=$this.y;$this.y+=10,$this.alpha=0,$this.show(),await defer(),$this.tween({y:y,alpha:1},600,"easeOutQuart",160);for(let id in _this.layers){let $layer=_this.layers[id];if(!id.includes(["undefined"])){let delay=Math.range($layer.y,0,400,0,800,!0);id.includes(["start","icon-play"])&&(delay+=100),$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay)}}},this.animateOut=async function(){await _this.ready(),$loading.alpha=0;let y=$this.y;await $this.tween({y:y+10,alpha:0},600,"easeOutQuart").promise(),$this.hide(),$this.y=y},this.loading=function(){$this.hide(),$loading.x=.5*Stage.width,$loading.y=.5*Stage.height-12,$loading.alpha=1},this.hide=function(){$this.hide()}})),Class((function GarageCarUIControlsTypeS(_name="type_s"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2;function hover(e){}function click(e){let type;switch(e.object.id){case"icon-share":type="share";break;case"icon-arrow-left":type="prev"}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level6_controls"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","icon-arrow"])&&_this.registerButton("TypeSButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.TypeSIcon(layer,id),"logo"==id&&(layer.useShader(layer.textureShader),layer.shader.set("tMap",Utils3D.getTexture("assets/images/uistyles/acura-logo.png"))),Data.tracks[_name].isAvailable()||id.includes("share")&&(layer.alpha=0,layer.mesh.visible=!1)}}(),function applyStyle(){for(let id in _this.layers){let layer=_this.layers[id],shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.animateIn=function(){$this.show(),$this.tween({alpha:1},400,"easeOutQuart")},this.animateOut=async function(){await $this.tween({alpha:1e-5},400,"easeOutQuart").promise(),$this.hide()}})),Class((function GarageCarUILockedTypeS(_name="type_s"){Inherit(this,UIFigma);const _this=this,$this=_this.element;!async function(){await _this.initLayout("level6_locked"),await async function applyData(){let layer=_this.layers.text;if(!layer)return;await layer.text.loaded(),layer.text.originalText||(layer.text.originalText=layer.text.string.toUpperCase());let previous=Config.TRACKS[Config.TRACKS.indexOf(_name)-1];const time=Numbers.formatTime(Qualifying[previous].time);layer.text.setText(layer.text.originalText.replace("[TIME]",time))}(),function parseLayers(){for(let id in _this.layers){let layer=_this.layers[id];"lock"==id&&UIFigmaStyles.TypeSIcon(layer,id)}}(),function applyStyle(){for(let id in _this.layers){let layer=_this.layers[id],shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon","text","lock"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},500,"easeInOutSine"),await $this.tween({alpha:1e-5},500,"easeInOutSine").promise(),$this.hide())}})),Class((function GarageCarUISelectTypeS(_name="type_s"){Inherit(this,UIFigma);const _this=this,$this=_this.element;var _animation=new Vector2,_specs=[];function hover(e){e.object.button&&_this.hover(e,e.object.button)}function click(e){if(!_this.flag("isVisible"))return;let type;switch(e.object.button&&_this.click(e,e.object.button),e.object.id){case"select-button":case"hit-area":type="select"}type&&_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){Global.PLAYGROUND?_animation.x=1:$this.alpha=1e-5}(),await _this.initLayout("level6_select"),function applyStyle(){for(let id in _this.layers){let layer=_this.layers[id],shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}(),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes("rotate")?(layer.alpha=0,layer.parent.removeChild(layer)):("hit-area"==id&&(layer.alpha=Global.PLAYGROUND?.5:1e-5,layer.interact(hover,click),layer.button=_this.layers["select-button"],layer.setZ(100)),id.includes(["button","share","sound"])&&_this.registerButton("TypeSButton",hover,click,layer),"select-button"==id&&UIFigmaStyles.TypeSButton(layer),id.includes("icon")&&UIFigmaStyles.TypeSIcon(layer,id),id.includes("spec-bar")&&(UIFigmaStyles.TypeSSpecBar(layer,id),_specs.push(layer)))}}(),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this),_this.isReady=!0}(),this.ready=async function(){await _this.wait(_this,"isReady")},this.animateIn=function(){if(_this.flag("isVisible"))return;_this.flag("isVisible",!0),$this.show();$this.tween({alpha:1},800,"easeOutCubic",50),_this.layout.element.tween({alpha:1},800,"easeOutCubic",50);for(let id in _this.layers){let $layer=_this.layers[id];if(id.includes(["spec","select","model","icon"])){let delay=Math.range($layer.y,0,400,0,800,!0);$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=1e-4,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay+50)}}_specs.forEach($spec=>{$spec.value||($spec.value=$spec.shader.uniforms.uSpecValue.value);let delay=Math.range($spec.y,130,300,0,600,!0);$spec.shader.set("uSpecValue",0),$spec.shader.tween("uSpecValue",$spec.value,1200,"easeOutCubic",delay+200+50)})},this.animateOut=async function(){_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.layout.element.tween({alpha:0},500,"easeInOutSine"),await $this.tween({alpha:1e-5},500,"easeInOutSine").promise(),$this.hide())}})),Class((function GarageCarUIStartTypeS(_name="type_s"){Inherit(this,UIFigma);const _this=this;var $loading,$this=_this.element,_time=(new Euler,"--:--.---");async function updateScore(){let score=Qualifying[_name]?Qualifying[_name].time:0;_time=Numbers.formatTime(score),_this.layers["qualifying-time"].setText(`${_time}`)}function hover(e){e.object.button&&_this.hover(e,e.object.button)}function click(e){let type;switch(e.object.id){case"leader-board-button":type="leaderboard";break;case"close-icon":type="garage";break;case"start":case"start-button":_this.flag("clicked")||(_this.flag("clicked",!0),type="start")}_this.events.fire(Events.CLICK,{type:type})}!async function(){!function initGL(){$loading=$glText("Loading...","HelveticaNeue-Medium",24,{align:"center",color:"#ffffff"}),$this.add($loading),$loading.alpha=0}(),await _this.initLayout("level6_start"),await updateScore(),function applyStyle(){for(let id in _this.layers){let layer=_this.layers[id],shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}(),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["button","share","sound"])&&!id.includes(["icon-sound-image","icon-share-image"])&&_this.registerButton("TypeSButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.TypeSIcon(layer,id),id.includes("lockup")&&UIFigmaStyles.TypeSLockup(layer),id.includes("close")&&(layer.interact(hover,click),layer.button=layer)}}(),_this.flag("isReady",!0),Utils.getConstructorName(_this)==Global.PLAYGROUND&&GLUI.Stage.add($this)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){await _this.ready(),await updateScore(),_this.flag("clicked",!1);let y=$this.y;$this.y+=10,$this.alpha=0,$this.show(),await defer(),$this.tween({y:y,alpha:1},600,"easeOutQuart",160);for(let id in _this.layers){let $layer=_this.layers[id];if(!id.includes(["undefined"])&&$layer.tween){let delay=Math.range($layer.y,0,400,0,800,!0);id.includes(["start","icon-play"])&&(delay+=100),$layer.moveY||($layer.moveY=$layer.y),$layer.alpha=0,$layer.y=$layer.moveY+.035*Stage.height,$layer.tween({y:$layer.moveY,alpha:1},800,"easeOutQuart",delay)}}},this.animateOut=async function(){await _this.ready(),$loading.alpha=0;let y=$this.y;await $this.tween({y:y+10,alpha:0},600,"easeOutQuart").promise(),_this.flag("clicked",!1),$this.hide(),$this.y=y},this.loading=function(){$this.hide(),$loading.x=.5*Stage.width,$loading.y=.5*Stage.height-12,$loading.alpha=1},this.hide=function(){$this.hide()}})),Class((function PBRGarageFloor(_mesh,_shader){Inherit(this,Component);const _this=this;_shader.addUniforms({uMirrorDistort:{value:1},uReflAdd:{value:1},uContrast:{value:1}}),async function initMirror(){let mirror=new FX.Mirror(_mesh,{enabled:Tests.renderGarageMirror()||Tests.renderGarageMirrorBlur(),width:1024,height:1024,format:Texture.RGBAFormat});mirror.start(_this.findParent("Garage").nuke),mirror.decorate(_shader),mirror.useCamera(_this.findParent("Garage").nuke.camera);let layers=await _this.parent.getAllLayers();for(let key in layers){let layer=layers[key];!async function(){layer instanceof GarageCar&&((await layer.getAllLayers()).forEach(l=>{l.visible&&mirror.add(l)}),mirror.add(layer.pedestal))}()}await layers.neons.instanceMeshReady;let obj=mirror.add(layers.neons.instanceMesh),shader=obj.shader;obj.shader=shader.clone(),layers.neons.scriptClass.applyToShader(obj.shader),obj.shader.set("tMap",Utils3D.getTexture("assets/images/environment/garage/2.jpg")),obj.shader.depthTest=!1,mirror.add(layers.wall),mirror.add(layers["top-detail"]),PBRGarageFloor.addMirror=function(mesh){mesh&&mirror.add(mesh)}}()})),Class((function GarageUI(){Inherit(this,GLUIElement);const _this=this;!function initGL(){_this.element}()})),Class((function GarageVFX(_nuke){Inherit(this,Component);const _this=this;var _config,_folder,_shader;!function(){!function initConfig(){(_config=InputUIL.create("garage_env_config")).setLabel("Environment"),_config.addImage("tEnvDiffuse"),_config.addImage("tEnvSpecular"),_config.addImage("tLightmap"),_folder=new UILFolder("carenv",{label:"Car Env",closed:!0}),UIL.global&&UIL.global.add(_folder)}();let pass=_this.initClass(NukePass,"GarageVFXPass",{uIndex:{value:0},uRGBStrength:{value:1},uRGBAngle:{value:1},uNoiseMin:{value:1},uLowerResolution:{value:1},tCRT:{value:null,getTexture:Utils3D.getRepeatTexture},uCRTScale:{value:1},uCRTBlend:{value:new Vector3(1.5,.5,1.2)},uNoise:{value:new Vector3(10,1,1)},uCollision:{value:0},uNoise:{value:new Vector3(10,1,1)},uSepia:{value:0},uGlitchRepeat:{value:1},uAcceleration:{value:1},uGlitchBlend:{value:new Vector3(1.5,.5,1.2)},tGlitch:{value:null,getTexture:Utils3D.getRepeatTexture},tRDXLUT:{value:null,getTexture:Utils3D.getLookupTexture},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color},uTint4:{value:new Color},uTint5:{value:new Color},uTint6:{value:new Color}});ShaderUIL.add(pass),_nuke.add(pass),_shader=pass,Tests.fxaa()&&_nuke.add(new FXAA)}(),this.applyCar=async function(car){let diffuse=_config.getImage("tEnvDiffuse")||"assets/images/_scenelayout/mask.jpg",specular=_config.getImage("tEnvSpecular")||"assets/images/_scenelayout/mask.jpg",lightmap=_config.getImage("tLightmap")||"assets/images/_scenelayout/mask.jpg",layers=await car.getLayers();_this.initClass(CarEnvOverrides,car.name,layers,"garage",_folder),layers.forEach(l=>{l.shader.addUniforms({tEnvDiffuse:{value:Utils3D.getRepeatTexture(diffuse)},tEnvSpecular:{value:Utils3D.getRepeatTexture(specular)},tLightmap:{value:Utils3D.getRepeatTexture(lightmap)},tMatcap:{value:Utils3D.getTexture("assets/images/environment/garage/00-1.jpg")}})})},this.updateSlide=function(slide){_shader.tween("uIndex",slide,500,"easeOutSine")},this.addUI=async function(mesh){await _this.wait(1500);try{PBRGarageFloor.addMirror(mesh)}catch(e){}}})),Class((function LoaderView(){Inherit(this,Element);const _this=this,$this=this.element;let $top,$bottom,$wrapper,$bar,$text,$presents;function loop(){Math.round(100*$this.percent);$bar.inner.scaleX=$this.percent,$bar.inner.transform()}!function initHTML(){$this.size("100%").setZ(100),$this.percent=0,$top=$this.create(".top"),$top.size("100%","50%").bg("#000").transformPoint("50%","0%"),$bottom=$this.create(".top"),$bottom.size("100%","50%").css({bottom:0}).bg("#000").transformPoint("50%","100%"),$wrapper=$this.create(".wrapper"),$wrapper.size(300,60).center()}(),function initBar(){$bar=$wrapper.create(".bar"),$bar.size(154,18).center(1,0).css({marginLeft:-82,border:"3px solid #fff",bottom:0}),$bar.inner=$bar.create(".bar"),$bar.inner.size(148,12).bg("#fff").css({top:3,left:3}).transform({scaleX:0}).transformPoint("0%","50%")}(),function initText(){$text=$wrapper.create("blinkingText").fontStyle("PressStart",14,"#fff").css({textAlign:"center",width:"100%",lineHeight:14,letterSpacing:2,opacity:1}),$text.text("LOADING")}(),function initPresents(){$presents=$this.create("presents").size(300,14).center().fontStyle("PressStart",16,"#fff").css({textAlign:"center",lineHeight:16,letterSpacing:2,opacity:1}).invisible(),$presents.text("Acura PRESENTS")}(),_this.startRender(loop),this.progress=function(e){tween($this,{percent:.9*e.percent},600,"easeInOutSine")},this.animateOut=async function(callback){await tween($this,{percent:1},500,"easeOutSine").promise(),_this.complete=!0,_this.stopRender(loop),$text.css({top:-999999}),$bar.tween({scaleY:0},500,"easeOutCubic"),await _this.wait(800),ViewController.instance().showPresents()&&($presents.visible(),await _this.wait(1700),$presents.invisible()),$top.tween({scaleY:0},2200,"easeInOutQuart").onComplete(()=>callback&&callback()),$bottom.tween({scaleY:0},2200,"easeInOutQuart")}})),Class((function ShareCard(_options={}){Inherit(this,FXScene);const _this=this,WIDTH=1200,HEIGHT=628,SCALE=_options.scale||1;!async function(){_this.create(),function initCamera(){let camera=new OrthographicCamera(WIDTH/-2,WIDTH/2,HEIGHT/2,HEIGHT/-2,.01,1e3);camera.position.z=1,camera.position.x=WIDTH/2,camera.position.y=-HEIGHT/2,_this.useCamera(camera),_this.resolution=1,_this.setSize(WIDTH,HEIGHT,!0)}(),await async function initLayout(){let level=_options.level||Utils.query("level"),type=_options.type||Utils.query("type");"all"==type&&(type="daily");_this.layout=_this.initClass(StageLayout,`share_${level}_${type}`,{glui:!0})}(),await async function updateLayers(){let type=_options.type||Utils.query("type"),level=_options.level||Utils.query("level"),rank=_options.rank||Utils.query("rank"),layers=await _this.layout.getAllLayers(),tasks=[];for(let id in layers)layers[id].text&&tasks.push(layers[id].loaded());layers.background&&(layers.background.setZ(-1),layers.background.useShader(layers.background.textureShader),layers.background.shader.set("tMap",Utils3D.getTexture(`assets/images/_share/${level}-${type}.jpg`)),tasks.push(layers.background.shader.get("tMap").promise));layers.Logo&&(layers.Logo.useShader(layers.Logo.textureShader),layers.Logo.shader.set("tMap",Utils3D.getTexture("assets/images/_share/acura-share-card-logo.png")),tasks.push(layers.Logo.shader.get("tMap").promise));if(layers["lock-up"]){let lockup=layers["lock-up"];lockup.useShader(lockup.textureShader),lockup.shader.set("tMap",Utils3D.getTexture(`assets/images/_share/ui${level}/ui${level}-lockup.png`))}let format="5"==level||"6"==level?"png":"jpg";"daily"==type&&layers.daily?(layers.alltime&&(layers.alltime.alpha=0),layers.daily.useShader(layers.daily.textureShader),layers.daily.shader.set("tMap",Utils3D.getTexture(`assets/images/_share/ui${level}/ui${level}-daily-top-${rank}.${format}`)),tasks.push(layers.daily.shader.get("tMap").promise)):"all"==type&&layers.alltime&&(layers.daily&&(layers.daily.alpha=0),layers.alltime.useShader(layers.alltime.textureShader),layers.alltime.shader.set("tMap",Utils3D.getTexture(`assets/images/_share/ui${level}/ui${level}-all-time-${rank}.${format}`)),tasks.push(layers.alltime.shader.get("tMap").promise));layers.initials&&(await layers.initials.loaded(),layers.initials.setText((_options.username||"AAA").toUpperCase()));if(layers.time){await layers.time.loaded();let timePrefix="";2==level||"2"==level?UIFigmaStyles.IntegraTitleText(layers.time):timePrefix="MY TIME: ",layers.time.setText(timePrefix+(_options.time||"").toUpperCase())}await Promise.all(tasks),await Initializer3D.uploadAll(_this.layout.element.group)}(),_this.scene.add(_this.layout.element.group),Global.PLAYGROUND&&"ShareCard"==Global.PLAYGROUND&&_this.startRender(()=>_this.render()),_this.isReady=!0}(),this.getImage=async function(){await _this.ready(),_this.render(),_this.render();let pixels=World.RENDERER.readPixels(_this.rt),canvas=document.createElement("canvas"),context=canvas.getContext("2d");canvas.width=WIDTH,canvas.height=HEIGHT;let imageData=context.getImageData(0,0,WIDTH,HEIGHT);imageData.data.set(pixels),context.putImageData(imageData,0,0);let canvasOut=document.createElement("canvas");canvasOut.width=WIDTH*SCALE,canvasOut.height=HEIGHT*SCALE;let contextOut=canvasOut.getContext("2d");return contextOut.save(),contextOut.translate(0,HEIGHT*SCALE),contextOut.scale(1,-1),contextOut.drawImage(canvas,0,0,WIDTH*SCALE,HEIGHT*SCALE),contextOut.restore(),canvas.width=WIDTH*SCALE,canvas.height=HEIGHT*SCALE,context.drawImage(canvasOut,0,0,WIDTH*SCALE,HEIGHT*SCALE,0,0,WIDTH*SCALE,HEIGHT*SCALE),canvas.toDataURL("image/png",.92)},this.ready=async function(){await _this.wait(_this,"isReady")}}),()=>{ShareCard.getImage=async function(options){let card=new ShareCard(options);return await card.ready(),card.getImage()}}),Class((function BasicTransition(){Inherit(this,Component);const _this=this;var _shader;_this.shader=_shader=_this.initClass(Shader,"Transition","BasicTransition",{tFrom:{value:null},tTo:{value:null},uTransition:{value:0}}),this.play=async function(fromView,toView){_shader.set("uTransition",0),_shader.set("tFrom",fromView),_shader.set("tTo",toView),await _shader.tween("uTransition",1,500,"easeOutCubic").promise()}})),Class((function CRTTransition(_intro){Inherit(this,Component);const _this=this;var _shader,_timeline;!function(){if(TweenManager.addCustomEase({name:"crtTransition",curve:"cubic-bezier(1,.01,.36,.99)"}),TweenManager.addCustomEase({name:"crtOutCubic",curve:"cubic-bezier(.42,.27,.29,.98)"}),_this.shader=_shader=_this.initClass(Shader,"Transition","CRTTransition",{tFrom:{value:null,ignoreUIL:!0},tTo:{value:null,ignoreUIL:!0},tCRT:{value:Utils3D.getTexture("assets/images/transitions/rgb_texture.jpg"),getTexture:Utils3D.getRepeatTexture},uTransition:{value:0},uPadding:{value:0},uCRTScale:{value:0},uCRTTransition:{value:1},uRGBStrength:{value:1},uRGBTransition:{value:0},uCRTCenter:{value:3},uCRTAffect:{value:1},uCRTAffect2:{value:1},uFromZoom:{value:0},uBlend:{value:0},uBrighten:{value:0},uBrighten2:{value:1},uToZoom:{value:1},uGlobal:{value:0},uSwap:{value:0}}),_shader.upload(),"CRTTransition"==Global.PLAYGROUND){let mesh=new Mesh(World.QUAD,_shader);World.SCENE.add(mesh),ShaderUIL.add(_shader);let a=_this.initClass(SplashScreen,"integra"),b=_this.initClass(Gameplay,"old_nsx");_this.shader.uniforms.tFrom.value=a,_this.shader.uniforms.tTo.value=b,Dev.expose("play",async _=>{await _this.play(a,b),await _this.wait(1e3),_this.shader.uniforms.tFrom.value=a,_this.shader.uniforms.tTo.value=b,_timeline.elapsed=0,_timeline.update()})}_shader.set("uBlend",0),_shader.set("uTransition",0),_shader.set("uCRTTransition",.5),_shader.set("uCRTAffect",0),_shader.set("uCRTAffect2",1),_shader.set("uRGBTransition",0),_shader.set("uRGBStrength",7),_shader.set("uFromZoom",0),_shader.set("uToZoom",0),_shader.set("uBrighten",0),_shader.set("uBrighten2",1),_shader.set("uSwap",0),(_timeline=new TweenTimeline).add(_shader.uniforms.uTransition,{value:1},100,"crtOutCubic"),_timeline.add(_shader.uniforms.uBlend,{value:1},90,"easeInOutCubic",5),_timeline.add(_shader.uniforms.uCRTTransition,{value:2},100,"crtOutCubic"),_timeline.add(_shader.uniforms.uCRTAffect,{value:1},20,"easeOutQuart"),_timeline.add(_shader.uniforms.uCRTAffect2,{value:0},40,"easeInOutSine",10),_timeline.add(_shader.uniforms.uRGBTransition,{value:1},50,"easeOutQuint",30),_timeline.add(_shader.uniforms.uRGBStrength,{value:0},50,"easeOutCirc",50),_intro||_timeline.add(_shader.uniforms.uFromZoom,{value:1},70,"easeInSine"),_timeline.add(_shader.uniforms.uToZoom,{value:1},60,"easeOutCubic",40),_timeline.add(_shader.uniforms.uBrighten,{value:.9},9,"easeInSine",4),_timeline.add(_shader.uniforms.uBrighten2,{value:0},5,"easeOutSine",16),_timeline.add(_shader.uniforms.uSwap,{value:1},12,"easeOutSine",8)}(),this.play=async function(fromView,toView){_timeline.elapsed=0,_timeline.update(),_this.parent.flag("canStartGameplay",!1),toView.visible=!0,_shader.set("uTransition",0),_shader.set("tFrom",fromView),_shader.set("tTo",toView),toView.camera.animateIn(),await _timeline.tween(1,2e3,"crtTransition").promise(),await _this.wait(500),fromView.visible=!1,_this.parent.flag("canStartGameplay",!0)}})),Class((function CRTTransition2(_intro){Inherit(this,Component);const _this=this;var _shader,_timeline;!function(){if(TweenManager.addCustomEase({name:"crtTransition",curve:"cubic-bezier(1,.01,.36,.99)"}),TweenManager.addCustomEase({name:"crtOutCubic",curve:"cubic-bezier(.42,.27,.29,.98)"}),_this.shader=_shader=_this.initClass(Shader,"Transition","CRTTransition2",{tFrom:{value:null,ignoreUIL:!0},tTo:{value:null,ignoreUIL:!0},tCRT:{value:Utils3D.getTexture("assets/images/transitions/rgb_texture.jpg"),getTexture:Utils3D.getRepeatTexture},uTransition:{value:0},uPadding:{value:0},uCRTScale:{value:0},uCRTTransition:{value:1},uRGBStrength:{value:1},uRGBTransition:{value:0},uCRTCenter:{value:3},uCRTAffect:{value:1},uCRTAffect2:{value:1},uFromZoom:{value:0},uBlend:{value:0},uBrighten:{value:0},uBrighten2:{value:1},uToZoom:{value:1},uGlobal:{value:0},uSwap:{value:0}}),_shader.upload(),"CRTTransition2"==Global.PLAYGROUND){let mesh=new Mesh(World.QUAD,_shader);World.SCENE.add(mesh),ShaderUIL.add(_shader);let a=_this.initClass(SplashScreen,"integra"),b=_this.initClass(Gameplay,"old_nsx");_this.shader.uniforms.tFrom.value=a,_this.shader.uniforms.tTo.value=b,Dev.expose("play",async _=>{await _this.play(a,b),await _this.wait(1e3),_this.shader.uniforms.tFrom.value=a,_this.shader.uniforms.tTo.value=b,_timeline.elapsed=0,_timeline.update()})}_shader.set("uBlend",0),_shader.set("uTransition",0),_shader.set("uCRTTransition",.5),_shader.set("uCRTAffect",0),_shader.set("uCRTAffect2",1),_shader.set("uRGBTransition",0),_shader.set("uRGBStrength",7),_shader.set("uFromZoom",0),_shader.set("uToZoom",0),_shader.set("uBrighten",0),_shader.set("uBrighten2",1),_shader.set("uSwap",0),(_timeline=new TweenTimeline).add(_shader.uniforms.uTransition,{value:1},100,"crtOutCubic"),_timeline.add(_shader.uniforms.uBlend,{value:1},90,"easeInOutCubic",5),_timeline.add(_shader.uniforms.uCRTTransition,{value:2},100,"crtOutCubic"),_timeline.add(_shader.uniforms.uCRTAffect,{value:1},20,"easeOutQuart"),_timeline.add(_shader.uniforms.uCRTAffect2,{value:0},40,"easeInOutSine",10),_timeline.add(_shader.uniforms.uRGBTransition,{value:1},50,"easeOutQuint",30),_timeline.add(_shader.uniforms.uRGBStrength,{value:0},50,"easeOutCirc",50),_intro||_timeline.add(_shader.uniforms.uFromZoom,{value:1},70,"easeInSine"),_timeline.add(_shader.uniforms.uToZoom,{value:1},60,"easeOutCubic",40),_timeline.add(_shader.uniforms.uBrighten,{value:.9},5,"easeInSine",4),_timeline.add(_shader.uniforms.uBrighten2,{value:0},5,"easeOutSine",16),_timeline.add(_shader.uniforms.uSwap,{value:1},90,"easeInOutSine",10)}(),this.play=async function(fromView,toView){_timeline.elapsed=0,_timeline.update(),_this.parent.flag("canStartGameplay",!1),toView.visible=!0,_shader.set("uTransition",0),_shader.set("tFrom",Tests.lowMemory()?null:fromView),_shader.set("tTo",toView),toView.camera.animateIn(),await _timeline.tween(1,3e3,"crtTransition").promise(),await _this.wait(500),fromView.visible=!1,_this.parent.flag("canStartGameplay",!0),_shader.uniforms=null,_shader.destroy(),_this.destroy()}})),Class((function GameTransition(){Inherit(this,Component);const _this=this;var _shader;!function(){if(_this.shader=_shader=_this.initClass(Shader,"Transition","GameTransition",{tFrom:{value:null,ignoreUIL:!0},tTo:{value:null,ignoreUIL:!0},uTransition:{value:0},uPadding:{value:1}}),"GameTransition"==Global.PLAYGROUND){let mesh=new Mesh(World.QUAD,_shader);World.SCENE.add(mesh),ShaderUIL.add(_shader);let a=_this.initClass(SplashScreen,"integra"),b=_this.initClass(Gameplay,"old_nsx");_this.shader.uniforms.tFrom.value=a,_this.shader.uniforms.tTo.value=b}}(),this.play=async function(fromView,toView){_shader.set("tFrom",fromView),_shader.set("tTo",toView),_shader.set("uTransition",0),toView.visible=!0,fromView.visible=!1,await _shader.tween("uTransition",1,2e3,"easeInOutCubic").promise(),_shader.uniforms=null,_shader.destroy(),_this.destroy()}})),Class((function GarageTransition(){Inherit(this,Component);const _this=this;var _shader;!function(){if(_this.shader=_shader=_this.initClass(Shader,"Transition","GarageTransition",{tFrom:{value:null,ignoreUIL:!0},tTo:{value:null,ignoreUIL:!0},uTransition:{value:0}}),"GarageTransition"==Global.PLAYGROUND){let mesh=new Mesh(World.QUAD,_shader);World.SCENE.add(mesh),ShaderUIL.add(_shader);let a=_this.initClass(SplashScreen,"integra"),b=_this.initClass(Gameplay,"old_nsx");_this.shader.uniforms.tFrom.value=a,_this.shader.uniforms.tTo.value=b,Dev.expose("play",async _=>{await _this.play(a,b),await _this.wait(1e3),_this.shader.uniforms.tFrom.value=a,_this.shader.uniforms.tTo.value=b,_timeline.elapsed=0,_timeline.update()})}}(),this.play=async function(fromView,toView){_shader.set("tFrom",fromView),_shader.set("tTo",toView),toView.visible=!0,fromView.visible=!1,toView.camera.animateIn(),await _shader.tween("uTransition",1,1e3,"easeOutExpo").promise(),_shader.uniforms=null,_shader.destroy(),_this.destroy()}})),Class((function TransitionUtils(){Inherit(this,Component);var _this=this;const BLACKLIST=["bg-placeholder","countdown-number","background","map","speed-dial","Rectangle-1","scroll","icon-scroll-button"];function initAnimateOffset(view,$layer){let width=$layer.text?$layer.text.getData().width:$layer.width;return 250*($layer.x+.5*width<.333*view.width?-1:1)}async function animateIn(view,name,layers){await async function defaultAnimateIn(view,layers){view.element.tween({alpha:1},500,"easeOutCubic");let tasks=[];for(let $layer of layers){$layer.show();let delay=Math.range($layer.y,0,view.height,50,350,!0);$layer.x+=initAnimateOffset(view,$layer),$layer.alpha=1e-5,tasks.push($layer.tween({x:$layer.origin.x,alpha:$layer.origin.alpha},750,"easeOutCubic",delay).onComplete(_=>{$layer.x=$layer.origin.x,$layer.alpha=$layer.origin.alpha}).promise())}await Promise.all(tasks)}(view,layers)}this.initUIShaders=async function(_layers,_type,_options={}){let type;switch(_type){case"integra":type="Integra";break;case"old_nsx":type="OldNSX";break;case"rdx":type="RDX";break;case"arx":type="Arx";break;case"new_nsx":type="NewNSX";break;case"type_s":type="TypeS";break;default:type=_type}for(let key in _layers){let layer=_layers[key],shader=null;if(!(_options.blacklist&&_options.blacklist.indexOf(key)>-1)){if(key.includes("-box")||!key.includes("number")&&!key.includes("label"))switch(key){case"speed-round-circle":case"speed-label-box":case"pause":shader=new Shader(`GameplayUI${type}Default`,Object.assign({},layer.mesh.shader.params,_options.params||{}))}else shader=new Shader(`GameplayUI${type}SpeedText`);shader&&await layer.useShader(shader)}}},this.update=function(_layers,_progress,_options={}){},this.autoAnimateIn=async function(view,name,blacklist=[]){if(view.flag("customAnimateIn"))return;await async function initLayout(view){view.element.alpha=1e-5,await view.ready(),view.resize(),await _this.wait(50)}(view);let layers=await async function getLayers(view,blacklist){var layers=[];for(let id in view.layers){let $layer=view.layers[id];if(!$layer)continue;$layer.element&&($layer=$layer.element);let origin=$layer.origin;origin||(origin=new Vector2($layer.x,$layer.y)),origin.alpha=$layer.alpha,$layer.origin=origin,layers.push($layer)}layers=(layers=layers.sort((a,b)=>a.y-b.y)).filter(layer=>{let filtered=-1!==BLACKLIST.indexOf(layer.id);return!filtered&&blacklist.length>0&&(filtered=-1!==blacklist.indexOf(layer.id)),!filtered});let loaded=[];for(let $layer of layers)$layer.text&&loaded.push($layer.text.loaded());return await Promise.all(loaded),layers}(view,blacklist);await animateIn(view,0,layers)}}),"static"),Class((function AudioInteractionUI(){Inherit(this,UIFigma);const _this=this;var $this,$text,_enabled=!1;!function initGL(){($this=_this.element).alpha=0,GLUI.Stage.add($this),_this.layers={}}(),function initMessage(){Device.mobile;let message=Copy.START_AUDIO;$text=$glText(message,"PressStart2P-Regular",6,{color:new Color("#FFFFFF"),align:"center"}),$this.add($text),$text.x=.5*_this.width,$text.y=_this.height-40}(),function addHandlers(){!function detectInteraction(){let action=Device.mobile?"touchend":"mouseup",touched=function(){AudioController.instance().initWebAudio(),window.removeEventListener(action,touched,{passive:!1}),_this.events.unsub(KeyboardUtil.UP,touched),_enabled=!0,_this.animateOut()};window.addEventListener(action,touched,{passive:!1}),_this.events.sub(KeyboardUtil.UP,touched)}()}(),this.animateIn=function(){_enabled||($this.tween({alpha:1},500,"easeOutCubic"),_this.flag("showing",!0))},this.animateOut=function(){_this.flag("showing")&&(_this.flag("showing",!1),$this.tween({alpha:0},250,"easeOutCubic").onComplete(_=>{$this.remove()}))}})),Class((function UIFigma(){Inherit(this,GLUIElement);const _this=this;var $this,_name;function background($layer){$layer.alpha=0;let mult=1/$this.scale;$layer.width=Stage.width*mult*1.25,$layer.height=Stage.height*mult*1.25,$layer.x=.5*(_this.width-$layer.width),$layer.y=.5*(_this.height-$layer.height),$layer.origin?$layer.origin.copy($layer):$layer.origin=(new Vector2).copy($layer),$layer.setZ(-10)}function logo($layer){if(_name&&_name.includes("_controls")&&Tests.allowsMultiplayer())return $layer.hide();if(_name&&_name.includes("level2_rotate"))return;$layer.bg("assets/images/uistyles/acura-logo.png"),$layer.x=-173.6,$layer.y=25,$layer.width=327.68,$layer.height=39.36,$layer.origin?$layer.origin.copy($layer):$layer.origin=(new Vector2).copy($layer)}function link($layer){if($layer.group.scale.setScalar(.8),$layer.setText("Visit Acura.com"),Config.FACEBOOK||Config.OPEN||Utils.query("awxx"))return $layer.scale=0;$layer.interact(e=>_this.hover(e,$layer,_=>{}),e=>_this.click(e,$layer,_=>{Track.event("Links","click","visit-acura"),open(Config.VISIT_ACURA)}))}function share($layer){if(Config.OPEN)return $layer.scale=0}this.width=812,this.height=375,async function(){!function initGL(){$this=_this.element}(),await _this.wait(_this,"layers"),await defer(),function addHandlers(){_this.onResize(_this.resize)}(),_this.isReady=!0}(),this.ready=function(){return _this.wait(_this,"isReady")},this.initLayout=async function(name){_name=name,_this.layout=_this.initClass(StageLayout,name,{glui:!0}),_this.layers=await _this.layout.getAllLayers();let tasks=[];for(let id in _this.layers){let layer=_this.layers[id];layer.id=id,layer.origin=new Vector2(layer.x,layer.y),layer.origin.alpha=1,layer.text&&(this.applyText&&this.applyText(layer),await layer.text.loaded(),layer.text.setText((layer.text.string||"").toUpperCase()),layer.setZ(150),tasks.push(layer.text.loaded())),id.includes("visit-acura-com")&&link(layer),id.includes("share")&&share(layer)}await Promise.all(tasks),$this.add(_this.layout.element)},this.positionRelativeTo=function($a,$b){$a.x=$b.x+($a.origin.x-$b.origin.x),$a.y=$b.y+($a.origin.y-$b.origin.y)},this.getScale=function(){return _this.width/_this.height<Stage.width/Stage.height?Stage.height/_this.height:Stage.width/_this.width},this.resize=function(){let scale=_this.getScale();$this.x=.5*(Stage.width-_this.width*scale),$this.y=.5*(Stage.height-_this.height*scale),$this.scale=scale;for(let id in _this.layers){let layer=_this.layers[id];"background"===id&&background(layer),"logo"===id&&logo(layer)}},this.registerButton=function(style,hover,click,$box,$label,$icon){$box&&$box.setZ&&($box&&$box.setZ(2),$box&&$label&&($box.label=$label,$box.add($label),$label.x=$label.origin.x-$box.origin.x,$label.y=$label.origin.y-$box.origin.y,$label.origin.copy($label),$label.setZ(3)),$box&&$icon&&($box.icon=$icon,$box.add($icon),$icon.x=$icon.origin.x-$box.origin.x,$icon.y=$icon.origin.y-$box.origin.y,$icon.origin.copy($icon),$icon.setZ(3)),$box&&style&&_this.applyStyle(style,$box,$label,$icon),!Utils.query("disableInteraction")&&$box&&$box.interact(e=>_this.hover(e,$box,hover),e=>_this.click(e,$box,click)))},this.hover=function(e,layer,callback){switch(e.action){case"over":tween(layer,{alpha:layer.text?1:.9,scale:1.04,hover:1},150,"easeOutBack");break;case"out":tween(layer,{alpha:1,scale:1,hover:0},400,"easeOutBack")}callback&&callback(e,layer)},this.click=function(e,layer,callback){layer.scale=.96,layer.alpha=.9,layer.hover=1,tween(layer,{alpha:1,scale:1,hover:0},300,"easeOutSine"),callback&&callback(e,layer)},this.applyStyle=function(style){let args=[...arguments].slice(1);UIFigmaStyles[style]&&UIFigmaStyles[style](...args)},this.getShader=function($layer){return $layer&&"logo"===$layer.id?null:$layer.shader?$layer.shader:$layer.mesh&&$layer.mesh.shader?$layer.mesh.shader:null}})),Class((function UIFigmaStyles(){Inherit(this,Component);const _this=this;function setIcon($layer,id,type){let path,suffix="";switch(type){case"ui1":suffix="-icon";break;case"ui5":case"ui6":"icon-share"==id&&(suffix="-white")}let name=id;switch(name.includes(["arrow-top"])&&(name="arrow-top"),name.includes(["arrow-bottom"])&&(name="arrow-bottom"),name){case"icon-arrow-left":path=`${type}-arrow-left${suffix}.png`;break;case"icon-arrow-right":path=`${type}-arrow-right${suffix}.png`;break;case"icon-check":path=`${type}-check${suffix}.png`;break;case"icon-share":path=`${type}-share${suffix}.png`;break;case"icon-fb":path=`${type}-fb${suffix}.png`;break;case"icon-tw":path=`${type}-tw${suffix}.png`;break;case"button-close":case"icon-close":path=`${type}-close${suffix}.png`;break;case"active-icon-play":case"icon-play":path=`${type}-play${suffix}.png`;break;case"icon-sound":path=`${type}-sound-off${suffix}.png`;break;case"icon-trophy":path=`${type}-trophy${suffix}.png`;break;case"arrow-bottom-box":case"arrow-bottom":path=`${type}-arrow-down${suffix}.png`;break;case"arrow-top-box":case"arrow-top":path=`${type}-arrow-up${suffix}.png`;break;case"lock":path=`${type}-lock${suffix}.png`}if(path){let map=Utils3D.getTexture(`assets/images/uistyles/${type}/${path}`);$layer.useShader($layer.textureShader),$layer.shader.set("tMap",map),$layer.setZ(15)}}function setLockup($layer,type){$layer.useShader($layer.textureShader),$layer.shader.set("tMap",Utils3D.getTexture(`assets/images/uistyles/${type}/${type}-lockup.png`))}function getSpecs(type,id){let index=Data.getTrackNumberByName(type),specs=Data.getSpecsByTrackNumber(index);return id.includes("1")?specs.acceleration:id.includes("2")?specs.handling:id.includes("3")?specs.braking:void 0}this.OldNSXButton=function($layer){let color="#FFFFFF";switch($layer.id){case"select-button":case"start-button":case"resume-button":case"next-level-button":case"save-button":case"4-button-share-box":color="#108CFF"}let border=3/$layer.width,shader=_this.initClass(Shader,"UIOldNSXButton",{uBackground:{value:new Color($layer.color?$layer.color:color)},uBorder:{value:new Color("#000000")},uEdge:{value:new Vector2(1*border,$layer.width/$layer.height*border)},uAlpha:{value:1},uHover:{value:0},uSelected:{value:0},uHoverColor:{value:new Color("#fff601")},transparent:!0});$layer.useShader(shader)},this.OldNSXOutlineBox=function($layer){let border=3/$layer.width,shader=_this.initClass(Shader,"UIOldNSXOutlineBox",{uBorder:{value:new Color("#ffffff")},uEdge:{value:new Vector2(1*border,$layer.width/$layer.height*border)},uAlpha:{value:1},transparent:!0});$layer.useShader(shader)},this.OldNSXOutlineText=function($layer){let shader=_this.initClass(Shader,"UIOldNSXOutlineText",{uBorder:{value:new Color(0,0,0)},transparent:!0});$layer.useShader(shader)},this.OldNSXIcon=function($layer,id){setIcon($layer,id,"ui1")},this.IntegraIcon=function($layer,id){setIcon($layer,id,"ui2")},this.RDXIcon=function($layer,id){setIcon($layer,id,"ui3")},this.ArxIcon=function($layer,id){setIcon($layer,id,"ui4")},this.NewNSXIcon=function($layer,id){setIcon($layer,id,"ui5")},this.TypeSIcon=function($layer,id){setIcon($layer,id,"ui6")},this.IntegraButton=function($layer){let suffix="-grey";switch($layer.id){case"select-button":case"start-button":case"resume-button":case"save-button":case"next-level-button":case"4-button-share-box":suffix="-yellow"}let background=Utils3D.getTexture(`assets/images/uistyles/ui2-gradient${suffix}.png`),border=2/$layer.width,shader=_this.initClass(Shader,"IntegraButton",{tBackground:{value:background},uBorder:{value:new Color("#000000")},uEdge:{value:new Vector2(1*border,$layer.width/$layer.height*border)},uAlpha:{value:1},uHover:{value:0},uSelected:{value:0},transparent:!0});$layer.useShader(shader)},this.RDXButton=function($layer){let background=new Color("#000000");switch($layer.id){case"select-button":case"start-button":case"resume-button":case"next-level-button":case"4-button-share-box":background=new Color("#16C912")}let shader=_this.initClass(Shader,"RDXButton",{uBackground:{value:background},uAspect:{value:new Vector2($layer.width/$layer.height,1)},uBorder:{value:new Color("#ffffff")},uRadius:{value:.04},uThickness:{value:.1},uAlpha:{value:1},uFill:{value:.4},uHover:{value:0},uHoverColor:{value:new Color("#f24044")},uSelected:{value:0},transparent:!0});$layer.useShader(shader)},this.ArxButton=function($layer){let color=new Color("#ffffff"),hover=new Color("#FF2E00");switch($layer.id){case"select-button":case"start-button":case"resume-button":case"next-level-button":case"4-button-share-box":color=new Color("#FF2E00"),hover=new Color("#ffffff")}let border=1/$layer.width,inset=3/$layer.width,shader=_this.initClass(Shader,"ArxButton",{uColor:{value:color},uEdge:{value:new Vector2(border,$layer.width/$layer.height*border)},uInset:{value:new Vector2(inset,$layer.width/$layer.height*inset)},uAlpha:{value:1},uHover:{value:0},uHoverColor:{value:hover},uSelected:{value:0},transparent:!0});$layer.useShader(shader)},this.ARXOutline=function($layer){let color=new Color("#FFFFFF"),border=1/$layer.width,shader=_this.initClass(Shader,"ARXOutline",{uColor:{value:color},uEdge:{value:new Vector2(border,$layer.width/$layer.height*border)},uAlpha:{value:.5},uHover:{value:0},uHoverColor:{value:color},transparent:!0});$layer.useShader(shader)},this.NewNSXButton=function($layer){let color=new Color("#ffffff"),hover=new Color("#FFBE41");switch($layer.id){case"select-button":case"start-button":case"resume-button":case"next-level-button":case"facebook-button":case"twitter-button":case"email-button":case"copy-link-button":case"save-button":case"leader-board-box-1":case"leader-board-box-2":case"leader-board-box-3":case"4-button-share-box":case"play1v1":color=new Color("#FFBE41"),hover=new Color("#ffffff")}let border=1.6/$layer.width,shader=_this.initClass(Shader,"NewNSXButton",{uColor:{value:color},uEdge:{value:new Vector2(border,$layer.width/$layer.height*border)},uAlpha:{value:1},uHover:{value:0},uHoverColor:{value:hover},uSelected:{value:0},blending:Shader.ADDITIVE_BLENDING,transparent:!0});$layer.useShader(shader)},this.TypeSButton=function($layer){let hover=new Color("#92F2FF"),color=new Color("#ffffff");switch($layer.id){case"select-button":case"start-button":case"resume-button":case"next-level-button":case"facebook-button":case"twitter-button":case"email-button":case"copy-link-button":case"save-button":case"4-button-share-box":case"play1v1":hover=new Color("#ffffff"),color=new Color("#92F2FF")}let border=1.1/$layer.width,corner=6/$layer.width,shader=_this.initClass(Shader,"TypeSButton",{uColor:{value:color},uEdge:{value:new Vector2(border,$layer.width/$layer.height*border)},uCorner:{value:new Vector2(corner,$layer.width/$layer.height*corner)},uAlpha:{value:1},uHover:{value:0},uHoverColor:{value:hover},uSelected:{value:0},transparent:!0,blending:Shader.ADDITIVE_BLENDING});$layer.useShader(shader)},this.TypeSOutline=function($layer){let color=new Color("#92F2FF"),border=1.5/$layer.width,shader=_this.initClass(Shader,"TypeSOutline",{uColor:{value:color},uEdge:{value:new Vector2(border,$layer.width/$layer.height*border)},uAlpha:{value:.5},uHover:{value:0},uHoverColor:{value:color},blending:Shader.ADDITIVE_BLENDING,transparent:!0});$layer.useShader(shader)},this.IntegraText=function($layer,color=new Color(0,0,0)){let scale=$layer.text?$layer.text.getData().size/30:1,shader=new Shader("IntegraGradientText",{uBorder:{value:new Color(color)},uScale:{value:scale}});$layer.useShader(shader),$layer.style="IntegraText"},this.IntegraShine=function($layer){let shader=_this.initClass(Shader,"IntegraShine",{uOffset:{value:Math.random()},uTexture:{value:Utils3D.getTexture("assets/images/uistyles/integra-shine.jpg")},transparent:!0,blending:Shader.ADDITIVE_BLENDING});$layer.useShader(shader),$layer.setZ(500)},this.IntegraTitleText=function($layer){let scale=$layer.text?$layer.text.getData().size/45:1,shader=_this.initClass(Shader,"IntegraTitleGradientText",{uColor1:{value:new Color("#f2ab00")},uColor2:{value:new Color("#b15100")},uScale:{value:scale}});$layer.uiStyle="IntegraTitleText",$layer.useShader(shader)},this.NewNSXText=function($layer,color){let shader=_this.initClass(Shader,"NewNSXText",{uColor:{value:color},blending:Shader.ADDITIVE_BLENDING,transparent:!0});$layer.uiStyle="NewNSXText",$layer.useShader(shader)},this.OldNSXLockup=function($layer){setLockup($layer,"ui1")},this.IntegraLockup=function($layer){setLockup($layer,"ui2")},this.RDXLockup=function($layer){setLockup($layer,"ui3")},this.ArxLockup=function($layer){setLockup($layer,"ui4")},this.NewNSXLockup=function($layer){setLockup($layer,"ui5")},this.TypeSLockup=function($layer){setLockup($layer,"ui6")},this.OldNSXSpecBar=function($layer){let value=getSpecs("old_nsx",$layer.id),shader=new Shader("OldNSXSpecBar",{tBackground:{value:Utils3D.getTexture("assets/images/uistyles/ui1/ui1-spec-bg.png")},uFillColor:{value:new Color("#FFF500")},uSpecValue:{value:Math.round(10*value)/10},transparent:!0});$layer.useShader(shader)},this.IntegraSpecBar=function($layer){let value=getSpecs("integra",$layer.id),shader=new Shader("IntegraSpecBar",{tBackground:{value:Utils3D.getTexture("assets/images/uistyles/ui2/ui2-spec-bg.png")},tFill:{value:Utils3D.getTexture("assets/images/uistyles/ui2/ui2-spec-fill.png")},uSpecValue:{value:Math.round(10*value)/10},transparent:!0});$layer.useShader(shader)},this.RDXSpecBar=function($layer){let value=getSpecs("rdx",$layer.id),shader=new Shader("RDXSpecBar",{tBackground:{value:Utils3D.getTexture("assets/images/uistyles/ui3/ui3-spec-bg.png")},tArrow:{value:Utils3D.getTexture("assets/images/uistyles/ui3/ui3-spec-arrow.png")},uFillColor:{value:new Color("#62DF4E")},uFillAlpha:{value:1},uBackgroundColor:{value:new Color("#000000")},uBackgroundAlpha:{value:.4},uSpecValue:{value:Math.round(10*value)/10},transparent:!0});$layer.useShader(shader)},this.ArxSpecBar=function($layer){let value=getSpecs("arx",$layer.id),shader=new Shader("ArxSpecBar",{tBackground:{value:Utils3D.getTexture("assets/images/uistyles/ui4/ui4-spec-bg.png")},uFillColor:{value:new Color("#FF2E00")},uBorderColor:{value:new Color("#ffffff")},uSpecValue:{value:Math.round(10*value)/10},transparent:!0});$layer.useShader(shader)},this.NewNSXSpecBar=function($layer){let value=getSpecs("new_nsx",$layer.id),shader=new Shader("NewNSXSpecBar",{tBackground:{value:Utils3D.getTexture("assets/images/uistyles/ui5/ui5-spec-bg.png")},uFillColor:{value:new Color("#FFBE41")},uBackgroundColor:{value:new Color("#666666")},uSpecValue:{value:Math.round(10*value)/10},transparent:!0});$layer.useShader(shader)},this.TypeSSpecBar=function($layer){let value=getSpecs("type_s",$layer.id),shader=new Shader("TypeSSpecBar",{tBackground:{value:Utils3D.getTexture("assets/images/uistyles/ui6/ui6-spec-bg.png")},uFillColor:{value:new Color("#92F2FF")},uSpecValue:{value:Math.round(10*value)/10},transparent:!0});$layer.useShader(shader)}}),"static"),Class((function Fallback(){Inherit(this,Element);const _this=this;var $this,$container;!function initHTML(){($this=_this.element).size("100%").bg("#000000")}(),function initBG(){$this.create("bg").size("100%").css({opacity:.666,backgroundSize:"cover",backgroundPosition:"center center"}).bg("assets/images/uistyles/unsupported-screen.jpg")}(),function initContainer(){($container=$this.create("container").size(320,200).center(!0,!1).css({top:"50%"})).html('Your browser or device does not support<br />the full experience. </br> </br>Please upgrade to the latest version of <a style="color: inherit; position: static; display: inline" href="https://www.google.com/chrome/browser/desktop/" target="_blank">Google Chrome</a>'),$container.fontStyle("futura-pt-condensed",18,"#ffffff").css({textAlign:"center",textTransform:"uppercase",fontWeight:700})}(),function initLogo(){$this.create("logo").size(187,63).bg("assets/images/uistyles/share-logo.png").center(!0,!1).css({top:"50%",marginTop:-100})}(),Track.page("/fallback")})),Class((function UIGlow($obj,_options,_input,_group){Inherit(this,Component);const _this=this;var _shader;!function initShader(){let name=`${_this.findParent("StageLayout").name}_${_input.id}`;_shader=_this.initClass(Shader,"UIGlow",{UILPrefix:`${name}_glow`,uColor:{value:new Color},uRadius:{value:.5},uFeather:{value:.2},uOpacity:{value:.25},uNoiseSpeed:{value:.25},uNoiseStrength:{value:.25},uNoiseScale:{value:new Vector2(.25,.25)},transparent:!0,blending:Shader.ADDITIVE_BLENDING}),ShaderUIL.add(_shader).setLabel(`${_input.get("name")}`),$obj.useShader(_shader),_this.element=$obj,_this.shader=_shader}()})),Class((function LeaderboardUI(_name=Utils.query("level_id")){Inherit(this,GLUIElement);const _this=this;var $this,_view,_showing="all-time";async function renderData(){_view.clear();let data=await async function getData(){let track=Data.getTrackNumberByName(_name),daily="daily"===_showing;return await Data.Leaderboard.get({track:track,daily:daily})}(),entries=[];for(let point of data)entries.push({time:point.score/1e3,name:point.username,id:point.id});_view&&_view.render&&_view.render(entries)}function applySelectedState(skipAnimation){!function hideExtraLayers(){let dailyBox=_view.layers["active-top-10-button"],dailyText=_view.layers["active-top-10"],allTimeBox=_view.layers["active-all-time-button"],allTimeText=_view.layers["active-all-time"];dailyText&&(dailyText.scale=0);allTimeText&&(allTimeText.scale=0);dailyBox&&(dailyBox.scale=0);allTimeBox&&(allTimeBox.scale=0)}();let dailyIcon=_view.layers["icon-play"],dailyButton=_view.layers["top-10-button"],allTimeIcon=_view.layers["active-icon-play"],allTimeButton=_view.layers["all-time-button"];setSelectedState("all-time"===_showing?1:0,allTimeButton,allTimeIcon,skipAnimation),setSelectedState("all-time"===_showing?0:1,dailyButton,dailyIcon,skipAnimation)}function setSelectedState(selected,button,icon,skip){let state=selected?1:0,rate=skip?0:250;button.shader.tween("uSelected",state,rate,"easeOutCubic"),icon.tween({alpha:state},rate,"easeOutCubic")}function onUpdate(e){_showing!==e.type&&(_showing=e.type,applySelectedState(),Track.page(`/leaderboard/${Data.getTrackNumberByName(_name)}/${_showing}`),renderData())}!async function(){!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name?(GLUI.Stage.add($this),_this.delayedCall(_=>{_this.animateIn()},100),World.RENDERER.setClearColor("#666666",1)):(GLUI.Stage.LeaderboardLayer.add($this),$this.alpha=1e-5,$this.hide())}(),await async function initView(){let view="Debug";switch(_name){case"integra":view="Integra";break;case"rdx":view="RDX";break;case"arx":view="ARX";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:case"old_nsx":view="OldNSX"}view=`Leaderboard${view}`,_view=_this.initClass(window[view],_name),await _view.ready(),await _this.wait(100),_view.layers["top-10"].setText("DAILY"),_view.layers["all-time-button"].shader.set("uSelected",1),applySelectedState()}(),function addHandlers(){_this.events.sub(_view,Events.UPDATE,onUpdate)}()}(),this.get("name",_=>_name),this.animateIn=async function(){_this.flag("isVisible")||(_this.flag("isVisible",!0),await _view.ready(),await renderData(),_this&&_this.events&&(_this.events.fire(UIConfig.VISIBILITY,{state:"leaderboard"}),UIConfig.showBackground(),applySelectedState(!0),await defer(),$this.show(),_view.animateIn(),_view.scrollbar&&_view.scrollbar.animateIn(500),TransitionUtils.autoAnimateIn(_view,_name),$this.alpha=1,Track.page(`/leaderboard/${Data.getTrackNumberByName(_name)}/${_showing}`)))},this.animateOut=async function(){_this&&_this.events&&_this.flag("isVisible")&&(_this.flag("isVisible",!1),_this.events.fire(UIConfig.VISIBILITY,{state:"game"}),UIConfig.hideBackground(),await _view.ready(),await _view.animateOut(),$this.hide())},this.onDestroy=function(){$this.remove()}})),Class((function LeaderboardARX(){Inherit(this,UIFigma);const _this=this;var $this;function hover(e){}function daily(){_this.events.fire(Events.UPDATE,{type:"daily"})}function allTime(){_this.events.fire(Events.UPDATE,{type:"all-time"})}function close(){ViewController.instance().hideLeaderboard()}!async function(){!function initGL(){$this=_this.element}(),await _this.initLayout("level4_leaderboard"),function initListings(){_this.listings=_this.initClass(LeaderboardListings)}(),function initScrollbar(){_this.scrollbar=_this.initClass(LeaderboardScrollbar)}(),function addHandlers(){_this.registerButton(null,hover,daily,_this.layers["top-10-button"]),_this.registerButton(null,hover,allTime,_this.layers["all-time-button"]),_this.registerButton(null,hover,close,_this.layers["button-close"]),_this.layers["challenge-button"].style="ArxButton";for(let id in _this.layers){let layer=_this.layers[id];id.includes("button")&&!id.includes(["scroll-button","button-close"])&&UIFigmaStyles.ArxButton(layer,id),id.includes(["icon","button-close"])&&UIFigmaStyles.ArxIcon(layer,id)}}()}(),this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()},this.clear=async function(){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.clear()},this.render=async function(items){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.render(items)}})),Class((function LeaderboardListing(_data){Inherit(this,GLUIElement);const _this=this;var $this,$wrapper,$border,$button;function positionEl($el,$src,$box,z=3){$src.style&&UIFigmaStyles[$src.style]&&UIFigmaStyles[$src.style]($el),$el.x=$src.x-$box.x,$el.y=$src.y-$box.y,$el.origin=new Vector2($el.x,$el.y),$el.setZ(z),$el.alpha=1,$wrapper.add($el)}function loop(){$button.x=$this.alpha<.01?9e3:$button.origin.x}function hover(e){switch(e.action){case"over":tween(e.object,{alpha:.8,scale:1.03},200,"easeOutBack");break;case"out":tween(e.object,{alpha:1,scale:1},400,"easeOutBack")}}function click(e){if(_this.flag("clicked"))return;_this.flag("clicked",!0),Global.ONLINE=!1,_this.events.fire(GameplayMultiplayer.ONLINE),e.object.scale=.96,e.object.alpha=.9,tween(e.object,{alpha:1,scale:1},500,"easeOutCubic");let id=_data.id,track=_this.findParent("LeaderboardUI").name;Data.setGhost({id:id,track:track}),Track.event("Leaderboard","click","challenge"),Track.event("Deeplink","challenge","level"+Data.getTrackNumberByName(track)),"Garage"===ViewController.instance().state?(ViewController.instance().showLoader(track),_this.delayedCall(_=>{ViewController.instance().playTrack(track)},250)):_this.events.fire(Gameplay.REPLAY)}!function initGL(){$this=_this.element,$wrapper=$gl(),$this.add($wrapper)}(),function initElements(){let layers=_this.parent.parent.layers,box=layers["rank-row-box"],rank=layers["rank-1"],time=layers["time-1"],initials=layers["initials-1"],challenge=layers.challenge,button=layers["challenge-button"],name=_this.findParent("LeaderboardUI").name;switch(name){case"old_nsx":case"arx":!function initBorder($box,name){let inset="old_nsx"===name?5:3,border="old_nsx"===name?3/$box.width:1/$box.width;($border=$gl($box.width-2*inset,$box.height-2*inset,"#ffffff")).x=inset,$border.y=inset,$wrapper.add($border);let shader=_this.initClass(Shader,"UIOldNSXOutlineBox",{uBorder:{value:new Color("#ffffff")},uEdge:{value:new Vector2(1*border,$border.width/$border.height*border)},transparent:!0});$border.useShader(shader)}(box,name)}(function initRank(data,$src,$box){positionEl($glText(`${parseFloat(_data.index)+1}`,data.font,parseFloat(data.size),data),$src,$box)})(rank.text.getData(),rank,box),function initTime(data,$src,$box){positionEl($glText(`${Numbers.formatTime(parseFloat(_data.time))}`,data.font,parseFloat(data.size),data),$src,$box)}(time.text.getData(),time,box),function initInitials(data,$src,$box){positionEl($glText(`${_data.name.toUpperCase()}`,data.font,parseFloat(data.size),data),$src,$box)}(initials.text.getData(),initials,box),function initChallenge(data,$src,$box){positionEl($glText(data.text,data.font,parseFloat(data.size),data),$src,$box)}(challenge.text.getData(),challenge,box),function initButton($src,$box){positionEl($button=$gl($src.width,$src.height,"assets/images/_scenelayout/uv.jpg"),$src,$box,2),null!==_data.id&&$button.interact(hover,click)}(button,box),$this.y=box.height*_data.index;for(let $el of[box,rank,time,initials,challenge,button])$el.alpha=0;_this.height=box.height}(),_this.startRender(loop),this.onDestroy=function(){for(let child of $this.children)$this&&$this.removeChild&&$this.removeChild(child);$this.parent&&$this.parent.removeChild&&$this.parent.removeChild($this)},this.animateIn=function(delay=0){return _this.flag("clicked",!1),$this.x=-50,$wrapper.alpha=0,$wrapper.tween({alpha:null===_data.id?.5:1},400,"easeOutCubic",delay),$this.tween({x:0},500,"easeOutCubic",delay).promise()},this.animateOut=function(delay=0){return $wrapper.tween({alpha:0},400,"easeInCubic",delay),$this.tween({x:50},500,"easeInCubic",delay).promise()}})),Class((function LeaderboardListings(){Inherit(this,GLUIElement);const _this=this;var $this,$scroller,_scroll,_items=[],_y=0,_touching=!1;function clear(){for(;_items.length>0;){let item=_items.pop();item.animateOut&&item.animateOut(50*_items.length).then(_=>{item=item.destroy?item.destroy():null})}}function update(){let height=Math.max(0,scrollHeight());for(let item of _items){let alpha=1,$el=item.element,edges=.25*item.height;alpha*=Math.range($scroller.y+$el.y,-edges,0,0,1,!0),alpha=Math.max(alpha,1e-4),$el.alpha=alpha}$scroller.y=Math.range(_y,0,1,0,-height,!0)}function loop(){let height=Math.max(0,scrollHeight()),[inside,y]=function isInside(){let container=$this.parent,scale=container.scale,xOffset=container.x,yOffset=container.y,xMin=$this.x*scale+xOffset,xMax=xMin+$this.width*scale,yMin=$this.y*scale+yOffset,yMax=yMin+$this.height*scale;return[xMin<Mouse.x&&xMax>Mouse.x&&yMin<Mouse.y&&yMax>Mouse.y,(Mouse.y-yMin)/(yMax-yMin)]}();(function isTouching(inside){!inside||!Mouse.input.isTouching&&Device.mobile||(_touching=!0);!Mouse.input.isTouching&&Math.abs(_scroll.delta.y)<.001&&(_touching=!1);return _touching})(inside);inside&&height>0&&function applyScroll(delta){let distance=delta/scrollHeight();_this.scroll+=distance}(_scroll.delta.y)}function scrollHeight(){return _items&&_items[0]?_items[0].height*_items.length-$this.height:0}!function initGL(){$this=_this.element,$scroller=$this.create()}(),function initScroll(){_scroll=Scroll.createUnlimited(),_this.startRender(loop)}(),this.render=function(data){clear();for(let item of data){item.index=_items.length;let $el=_this.initClass(LeaderboardListing,item);$scroller.add($el.element),$el.animateIn(350+50*_items.length),_items.push($el)}let box=_this.parent.layers["rank-row-box"];$this.x=box.x,$this.y=box.y,$this.width=box.width,$this.height=_this.parent.height-box.y,update()},this.clear=function(){clear()},this.set("scroll",v=>{_y=v,_y=Math.clamp(_y,0,1),update()}),this.get("scroll",_=>_y),this.get("height",_=>Math.max(0,scrollHeight()))})),Class((function LeaderboardScrollbar(){Inherit(this,GLUIElement);const _this=this;var $this,$bar,$area,_touching=!1;function loop(){let scroll=_this.parent.listings.scroll,height=_this.parent.listings.height,area=$area.height,bar=$bar.height;$bar.y=scroll*(area-bar);let[inside,y]=function isInside(){let container=$this.parent,scale=container.scale,xOffset=container.x,yOffset=container.y,xMin=$area.x*scale+xOffset-30,xMax=xMin+$area.width*scale+60,yMin=$area.y*scale+yOffset,yMax=yMin+$area.height*scale;return[xMin<Mouse.x&&xMax>Mouse.x&&yMin<Mouse.y&&yMax>Mouse.y,(Mouse.y-yMin)/(yMax-yMin)]}();(function isTouching(inside){inside&&Mouse.input.isTouching&&(_touching=!0);Mouse.input.isTouching||(_touching=!1);return _touching})(inside)&&height>0&&function setScroll(percent){let edge=$bar.height/$area.height*.5;_this.parent.listings.scroll=Math.range(percent,edge,1-edge,0,1,!0)}(y)}!async function(){!function initGL(){$this=_this.element}(),function initLayers(){let layers=_this.parent.layers;$bar=layers["icon-scroll-button"],($area=layers.scroll).add($bar),$bar.x=.5*($area.width-$bar.width),$bar.y=0}(),await _this.wait(_this.parent,"listings"),_this.startRender(loop)}(),this.animateIn=function(delay=0){$bar&&($bar.alpha=1e-5,$bar.tween({alpha:1},500,"easeOutCubic",delay)),$area&&($area.alpha=1e-5,$area.tween({alpha:1},500,"easeOutCubic",delay))}})),Class((function LeaderboardIntegra(){Inherit(this,UIFigma);const _this=this;var $this,_yellow,_grey;function hover(e){}function daily(){_this.events.fire(Events.UPDATE,{type:"daily"}),_this.layers["top-10-button"].shader.set("tBackground",_yellow),_this.layers["all-time-button"].shader.set("tBackground",_grey)}function allTime(){_this.events.fire(Events.UPDATE,{type:"all-time"}),_this.layers["top-10-button"].shader.set("tBackground",_grey),_this.layers["all-time-button"].shader.set("tBackground",_yellow)}function close(){ViewController.instance().hideLeaderboard()}!async function(){!function initGL(){$this=_this.element}(),await _this.initLayout("level2_leaderboard"),function initTextures(){_yellow=Utils3D.getTexture("assets/images/uistyles/ui2-gradient-yellow.png"),_grey=Utils3D.getTexture("assets/images/uistyles/ui2-gradient-grey.png")}(),function initListings(){_this.listings=_this.initClass(LeaderboardListings)}(),function initScrollbar(){_this.scrollbar=_this.initClass(LeaderboardScrollbar)}(),function addHandlers(){_this.registerButton(null,hover,daily,_this.layers["top-10-button"]),_this.registerButton(null,hover,allTime,_this.layers["all-time-button"]),_this.registerButton(null,hover,close,_this.layers["button-close"]),_this.layers["challenge-button"].style="IntegraButton";for(let id in _this.layers){let layer=_this.layers[id];id.includes(["icon","button-close"])&&UIFigmaStyles.IntegraIcon(layer,id),id.includes("button")&&!id.includes(["scroll-button","button-close"])&&UIFigmaStyles.IntegraButton(layer,id),id.includes("leader-board")&&UIFigmaStyles.IntegraTitleText(layer),layer.text&&id.includes(["challenge","top-10","all-time","level"])&&UIFigmaStyles.IntegraText(layer),id.includes("sparkle")&&UIFigmaStyles.IntegraShine(layer),id.includes("leaderboard-listing-bg")&&layer.setZ(-1)}}(),allTime()}(),this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()},this.clear=async function(){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.clear()},this.render=async function(items){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.render(items)}})),Class((function LeaderboardNewNSX(){Inherit(this,UIFigma);const _this=this;var $this;function hover(e){}function daily(){_this.events.fire(Events.UPDATE,{type:"daily"})}function allTime(){_this.events.fire(Events.UPDATE,{type:"all-time"})}function close(){ViewController.instance().hideLeaderboard()}!async function(){!function initGL(){$this=_this.element}(),await _this.initLayout("level5_leaderboard"),function initListings(){_this.listings=_this.initClass(LeaderboardListings)}(),function initScrollbar(){_this.scrollbar=_this.initClass(LeaderboardScrollbar)}(),function addHandlers(){_this.registerButton(null,hover,daily,_this.layers["top-10-button"]),_this.registerButton(null,hover,allTime,_this.layers["all-time-button"]),_this.registerButton(null,hover,close,_this.layers["button-close"]),_this.layers["challenge-button"].style="NewNSXButton";for(let id in _this.layers){let layer=_this.layers[id];if(id.includes("button")&&!id.includes(["scroll-button","button-close"])&&UIFigmaStyles.NewNSXButton(layer,id),id.includes(["icon","button-close"])&&UIFigmaStyles.NewNSXIcon(layer,id),!id.includes("background")){let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}}()}(),this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()},this.clear=async function(){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.clear()},this.render=async function(items){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.render(items)}})),Class((function LeaderboardOldNSX(){Inherit(this,UIFigma);const _this=this;var $this;function hover(e){}function daily(){_this.events.fire(Events.UPDATE,{type:"daily"})}function allTime(){_this.events.fire(Events.UPDATE,{type:"all-time"})}function close(){ViewController.instance().hideLeaderboard()}!async function(){!function initGL(){$this=_this.element}(),await _this.initLayout("level1_leaderboard"),function initScrollbar(){_this.scrollbar=_this.initClass(LeaderboardScrollbar)}(),function initListings(){_this.layers["challenge-button"].style="OldNSXButton",_this.listings=_this.initClass(LeaderboardListings)}(),function addHandlers(){_this.registerButton(null,hover,daily,_this.layers["top-10-button"]),_this.registerButton(null,hover,allTime,_this.layers["all-time-button"]),_this.registerButton(null,hover,close,_this.layers["button-close"]);for(let id in _this.layers){let layer=_this.layers[id];id.includes(["icon"])&&(UIFigmaStyles.OldNSXIcon(layer,id),layer.setZ(100)),id.includes(["button","scroll"])&&!id.includes("scroll-button")&&UIFigmaStyles.OldNSXButton(layer,id)}}()}(),this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()},this.clear=async function(){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.clear()},this.render=async function(items){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.render(items)}})),Class((function LeaderboardRDX(){Inherit(this,UIFigma);const _this=this;var $this;function hover(e){}function daily(){_this.events.fire(Events.UPDATE,{type:"daily"})}function allTime(){_this.events.fire(Events.UPDATE,{type:"all-time"})}function close(){ViewController.instance().hideLeaderboard()}!async function(){!function initGL(){$this=_this.element}(),await _this.initLayout("level3_leaderboard"),function initListings(){_this.listings=_this.initClass(LeaderboardListings)}(),function initScrollbar(){_this.scrollbar=_this.initClass(LeaderboardScrollbar)}(),function addHandlers(){_this.registerButton(null,hover,daily,_this.layers["top-10-button"]),_this.registerButton(null,hover,allTime,_this.layers["all-time-button"]),_this.registerButton(null,hover,close,_this.layers["button-close"]),_this.layers["challenge-button"].style="RDXButton";for(let id in _this.layers){let layer=_this.layers[id];id.includes("button")&&!id.includes(["scroll-button","button-close"])&&UIFigmaStyles.RDXButton(layer,id),id.includes(["icon","button-close"])&&UIFigmaStyles.RDXIcon(layer,id)}}()}(),this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()},this.clear=async function(){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.clear()},this.render=async function(items){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.render(items)}})),Class((function LeaderboardTypeS(){Inherit(this,UIFigma);const _this=this;var $this;function hover(e){}function daily(){_this.events.fire(Events.UPDATE,{type:"daily"})}function allTime(){_this.events.fire(Events.UPDATE,{type:"all-time"})}function close(){ViewController.instance().hideLeaderboard()}!async function(){!function initGL(){$this=_this.element}(),await _this.initLayout("level6_leaderboard"),function initListings(){_this.listings=_this.initClass(LeaderboardListings)}(),function initScrollbar(){_this.scrollbar=_this.initClass(LeaderboardScrollbar)}(),function addHandlers(){_this.registerButton(null,hover,daily,_this.layers["top-10-button"]),_this.registerButton(null,hover,allTime,_this.layers["all-time-button"]),_this.registerButton(null,hover,close,_this.layers["button-close"]),_this.layers["challenge-button"].style="TypeSButton";for(let id in _this.layers){let layer=_this.layers[id];if(id.includes("button")&&!id.includes(["scroll-button","button-close"])&&UIFigmaStyles.TypeSButton(layer,id),id.includes(["icon","button-close"])&&UIFigmaStyles.TypeSIcon(layer,id),!id.includes("background")){let shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}}()}(),this.animateIn=function(){$this.show()},this.animateOut=function(){$this.hide()},this.clear=async function(){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.clear()},this.render=async function(items){await _this.ready(),await _this.wait(_this,"listings"),_this.listings.render(items)}})),Class((function LoadingUI(_name=Utils.query("level_id")){Inherit(this,GLUIElement);const _this=this;var $this,_view;!async function(){!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name?(GLUI.Stage.add($this),_this.delayedCall(_=>{_this.animateIn()},100),World.RENDERER.setClearColor("#000000",1)):(GLUI.Stage.LoaderLayer.add($this),$this.hide())}(),await async function initView(){let view="Debug";switch(_name){case"integra":view="Integra";break;case"rdx":view="RDX";break;case"arx":view="ARX";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:case"old_nsx":view="OldNSX"}view=`Loader${view}`,_view=_this.initClass(window[view],_name),$this.hide()}()}(),this.get("name",_=>_name),this.animateIn=async function(){$this.hide(),await _view.ready(),_this.events.fire(UIConfig.VISIBILITY,{state:"loader"}),$this.show(),$this.alpha=0,$this.tween({alpha:1},500,"easeOutSine");for(let id in _view.layer)if("background"!==id){let $layer=_view.layers[id];$layer.alpha=1e-4,$layer.scale=1.15,$layer.tween({alpha:1,scale:1},1500,"easeOutCubic",200)}},this.animateOut=async function(){_this.events.fire(UIConfig.VISIBILITY,{state:"game"}),await _view.ready(),await $this.tween({alpha:0},500,"easeOutCubic").promise(),$this.hide()},this.onDestroy=function(){$this.remove()}})),Class((function LoaderARX(){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level4_loading")}(),this.animateIn=function(){},this.animateOut=function(){}})),Class((function LoaderIntegra(){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level2_loading"),function applyStyles(){for(let id in _this.layers){let layer=_this.layers[id];id.includes("copy")&&UIFigmaStyles.IntegraTitleText(layer),id.includes("sparkle")&&UIFigmaStyles.IntegraShine(layer)}}()}(),this.animateIn=function(){},this.animateOut=function(){}})),Class((function LoaderNewNSX(){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level5_loading"),function applyStyle(){for(let id in _this.layers){let layer=_this.layers[id],shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}()}(),this.animateIn=function(){},this.animateOut=function(){}})),Class((function LoaderOldNSX(){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level1_loading")}(),this.animateIn=function(){},this.animateOut=function(){}})),Class((function LoaderRDX(){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level3_loading")}(),this.animateIn=function(){},this.animateOut=function(){}})),Class((function LoaderTypeS(){Inherit(this,UIFigma);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level6_loading"),function applyStyle(){for(let id in _this.layers){let layer=_this.layers[id],shader=_this.getShader(layer);shader&&(shader.blending=Shader.ADDITIVE_BLENDING)}}()}(),this.animateIn=function(){},this.animateOut=function(){}})),Class((function MultiplayerButton(_name=Utils.query("level_id")){Inherit(this,UIFigma);const _this=this;var $this,_view;function initView(){let view="Debug";switch(_name){case"integra":view="Integra";break;case"rdx":view="RDX";break;case"arx":view="ARX";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:case"old_nsx":view="OldNSX"}view=`MultiplayerButton${view}`,_view=_this.initClass(window[view],_name),$this.add(_view.element),_view.element.x=30,_this.events.sub(_view,Events.CLICK,click)}function resize(){let view=_this.flag("currentView");switch(view){case"Garage":_this.width=812,_this.height=375,_view.resize&&_view.resize(view,1);break;case"Gameplay":_this.width=Stage.width,_this.height=Stage.height;let scale=Stage.height/Config.UI_SCALE;_view.resize&&_view.resize(view,scale)}_this.resize()}async function onGarageCamera(e){if(_this.flag("currentCar",e.slide),"Garage"!==_this.flag("currentView"))return;let number=(_this.flag("currentCar")||0)+1;await changeView(number)}async function changeView(number){let view=_this.flag("currentView"),track=Data.getTrackNameByNumber(number),unlocked=await Data.tracks[track].isUnlocked();track===_name&&_view||(_name=track,_view&&_view.animateOut&&_view.animateOut(oldView=>{_this.events.unsub(oldView,Events.CLICK,click),$this.removeChild(oldView.element),oldView.destroy()}),unlocked&&(_this.flag("isVisible")||(_this.flag("isVisible",!0),$this.show(),$this.alpha=1),_this.delayedCall(()=>{initView(),_view.element.alpha=0,_view.animateIn(view),defer(resize)},1300)))}async function click(){if(!_this.flag("isVisible"))return;switch(_this.flag("currentView")){case"Garage":{_this.animateOut(),Global.ONLINE=!0;let number=(_this.flag("currentCar")||0)+1;Track.event("1v1","click",`level${number}`);let car=Data.getTrackNameByNumber(number),track=Data.getTrackByCar(car);ViewController.instance().showLoader(car),_this.events.fire(UIConfig.VISIBILITY,{state:"loader"}),await ViewController.instance().playTrack(track),ViewController.instance().hideLoader();break}case"Gameplay":{let number=(_this.flag("currentCar")||0)+1;Track.event("1v1","click",`level${number}`),_this.animateOut(),MultiplayerSession.toggle(!1),Global.ONLINE=!0,_this.delayedCall(_=>{_this.events.fire(Gameplay.REPLAY)},100);break}}}async function onViewChange({view:view}){switch(_this.flag("currentView",view),view){case"Garage":let number=Number(await Storage.get("garageSlide"))+1;number||(number=1),changeView(number),Global.ONLINE=!1;let track=Data.getTrackNameByNumber(number);await Data.tracks[track].isUnlocked()?(resize(),_this.animateIn()):_this.animateOut();break;case"Gameplay":default:_this.animateOut()}}function gameEnd(){clearTimeout(_this.gameTimer),_this.animateOut()}function onOnline(){clearTimeout(_this.gameTimer),_this.animateOut()}function onPause({visible:visible}){visible?_this.animateOut():Global.ONLINE||_this.animateIn()}async function gameStart(e){Global.ONLINE?_this.animateOut():(_view&&_view.destroy&&(_this.events.unsub(_view,Events.CLICK,click),$this.removeChild(_view.element),_view=_view.destroy()),await changeView(Data.getTrackNumberByName(Global.CURRENT_TRACK)),clearTimeout(_this.gameTimer),_this.gameTimer=_this.delayedCall(_=>{_this.animateIn(),defer(resize)},2200))}function gameReset(){clearTimeout(_this.gameTimer),_this.animateOut()}function gameReplay(){clearTimeout(_this.gameTimer),_this.animateOut()}!async function(){await async function initGL(){$this=_this.element,await _this.wait(GLUI.Stage,"GameLayer"),await defer(),GLUI.Stage.GameLayer.add($this),_this.layers={},_this.flag("isVisible",!1),$this.hide()}(),function setNameFromLocalStorage(){let level=Data.levelDeepLink(),startSlide=level?parseInt(level)-1:Number(Storage.get("garageSlide"))+1;if(!isNaN(startSlide)){const track=Data.getTrackNameByNumber(startSlide);track&&(_name=track)}}(),initView(),function addHandlers(){_this.events.sub(GameplayStatePauseUI.VISIBILITY,onPause),_this.events.sub(GameplayMultiplayer.ONLINE,onOnline),_this.events.sub(GarageCamera.UPDATE,onGarageCamera),_this.events.sub(ViewController.CHANGE,onViewChange),_this.events.sub(Gameplay.END,gameEnd),_this.events.sub(Gameplay.RESET,gameReset),_this.events.sub(Gameplay.REPLAY,gameReplay),_this.events.sub(Gameplay.START,gameStart),_this.events.unsub(Events.RESIZE,_this.resize),_this.onResize(resize)}(),Global.PLAYGROUND===_this.constructor.name&&defer(_=>_this.animateIn())}(),this.animateIn=function(){_this.flag("isVisible")||(clearTimeout(_this.gameTimer),_this.flag("isVisible",!0),$this.alpha=1e-5,$this.show(),$this.tween({alpha:1},500,"easeOutCubic",200),defer(resize))},this.animateOut=function(){_this.flag("isVisible")&&(clearTimeout(_this.gameTimer),_this.flag("isVisible",!1),$this.tween({alpha:0},500,"easeOutCubic").onComplete(_=>{$this.hide()}))}})),Class((function MultiplayerUI(_name=Utils.query("level_id")){Inherit(this,GLUIElement);const _this=this;var $this,_view,_error={},_1v1={},_share={},_select={},_connecting={};function show(group){_view.layers["4-copy"].setText("SEND TO A FRIEND AND RACE NOW");for(let id in group)if("id"!==id){let $layer=group[id],alpha=1;id.includes("overlay")&&($layer.setZ(-1),alpha*=.666),$layer.alpha=alpha,$layer.show()}_view.onGroupShow(group)}async function onViewEvent({type:type,payload:payload}){switch(type){case"raceRandom":{MultiplayerSession.clear(),MultiplayerSession.HOST=!0,_this.events.fire(GameplayMultiplayer.RECONNECT),_this.animateIn("connecting");let number=Data.getTrackNumberByName(Global.CURRENT_TRACK);Track.event("1v1","challenge random",`level${number}`),MultiplayerSession.toggle(!0);break}case"raceFriend":{MultiplayerSession.create();let level=Data.getTrackNumberByName(Global.CURRENT_TRACK);Track.event("1v1","challenge friend",`level${level}`);let short=`playbeatthat.acura.com/?join=${MultiplayerSession.ROOM}&level=${level}`;_view.layers["4-button-share-text"].setText(Share.supports.native&&Device.mobile?"SHARE":"COPY"),_view.layers["4-link"].setText(short),_this.animateIn("share"),MultiplayerSession.toggle(!0),MultiplayerSession.HOST=!0,_this.events.fire(GameplayMultiplayer.ONLINE);break}case"copyCode":Utils.copyToClipboard(MultiplayerSession.LINK),_view.layers["4-copy"].setText("WAITING FOR FRIEND TO JOIN..."),_view.pulseText(_view.layers["4-copy"]);break;case"shareCode":{let link=MultiplayerSession.LINK;Share.supports.native&&Device.mobile?Share.native(link,Copy.SHARE_TITLE):Utils.copyToClipboard(link),_view.layers["4-copy"].setText("WAITING FOR FRIEND TO JOIN..."),_view.pulseText(_view.layers["4-copy"]);break}case"close":MultiplayerSession.clear(),MultiplayerSession.toggle(!0),Global.ONLINE=!1,_this.events.fire(GameplayMultiplayer.ONLINE),_this.animateOut()}}function onKeyPress(e){let num="!@#$%".indexOf(e.key)+1;if(0!==num&&e.shiftKey){for(let id in _view.layers){let $layer=_view.layers[id],alpha=0;0===id.indexOf(`${num}-`)&&(alpha=1),id.includes("overlay")&&($layer.setZ(-1),alpha*=.666),$layer.alpha=alpha,$layer[0===alpha?"hide":"show"]()}switch(num){case 1:show(_select);break;case 2:show(_1v1);break;case 3:show(_connecting);break;case 4:show(_share);break;case 5:show(_error)}}}function onViewChange({view:view}){_this.flag("gameState",view),"Garage"===view&&(MultiplayerSession.toggle(!1),_this.animateOut())}!async function(){!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name?(GLUI.Stage.add($this),_this.delayedCall(_=>{_this.animateIn()},100),_this.events.sub(KeyboardUtil.PRESS,onKeyPress),World.RENDERER.setClearColor("#666666",1)):(GLUI.Stage.MultiplayerLayer.add($this),$this.hide())}(),await async function initView(){let view="Debug";switch(_name){case"integra":view="Integra";break;case"rdx":view="RDX";break;case"arx":view="ARX";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS";break;default:case"old_nsx":view="OldNSX"}_this.flag("gameState","Garage"),view=`Multiplayer${view}`,_view=_this.initClass(window[view],_name),$this.add(_view.element),await _view.ready()}(),function sortLayers(){for(let id in _view.layers){let $layer=_view.layers[id];id.includes("1-")&&(_select[id]=$layer),id.includes("2-")&&(_1v1[id]=$layer),id.includes("3-")&&(_connecting[id]=$layer),id.includes("4-")&&(_share[id]=$layer),id.includes("5-")&&(_error[id]=$layer)}_1v1.id="1v1",_select.id="select",_connecting.id="connecting",_share.id="share",_error.id="error"}(),function addHandlers(){_this.events.sub(_view,Events.SELECT,onViewEvent),_this.events.sub(ViewController.CHANGE,onViewChange)}(),_this.flag("isReady",!0)}(),this.ready=function(){return _this.wait(_this,"isReady")},this.get("name",_=>_name),this.state=function(view){switch(_this.flag("viewState",view),function hide(){for(let id in _view.layers){let $layer=_view.layers[id];$layer.alpha=1e-4,$layer.hide()}}(),view){case"error":show(_error);break;case"1v1":show(_1v1);break;case"share":show(_share);break;case"select":show(_select);break;case"connecting":show(_connecting)}},this.animateIn=async function(state="connecting"){_this.flag("visible")||(_this.events.fire(UIConfig.VISIBILITY,{state:"multiplayer"}),$this.alpha=0,$this.show(),await _this.ready(),$this.tween({alpha:1},500,"easeOutSine"),_this.flag("visible",!0)),_this.state(state)},this.animateOut=async function(){_this.flag("visible")&&(_this.events.fire(UIConfig.VISIBILITY,{state:"game"}),await $this.tween({alpha:0},500,"easeOutCubic").promise(),$this.hide(),_this.flag("visible",!1))},this.onDestroy=function(){$this.remove()}})),Class((function Multiplayer1V1Button(){const _this=this;var $shine,_shader,$this=_this.element;function hover(e){if(exists()&&_this.$background)switch(e.action){case"over":_this.$background.tween({scale:1.1},100,"easeOutCubic"),$shine.tween({scale:1.1},100,"easeOutCubic");break;default:_this.$background.tween({scale:1},350,"easeOutCubic"),$shine.tween({scale:1},350,"easeOutCubic")}}function click(){_this.events.fire(Events.CLICK)}function exists(){return _this&&_this.element}function hintAnimation(){exists()&&_shader&&_shader.set&&(_shader.set("uProgress",0),_shader.tween("uProgress",1,1e3,"easeInOutSine",2e3).onComplete(hintAnimation))}!async function(){await defer(),function initShine(){let{width:width,height:height}=function getDimensions(){let width=0,height=0;for(let $child of $this.children)$child.text||(width=Math.max(width,$child.dimensions.x),height=Math.max(height,$child.dimensions.y));return{width:width,height:height}}(),mask="MultiplayerButtonRDX"===Utils.getConstructorName(_this)?"uistyles/ui3/ui3-1v1-mask.jpg":"_scenelayout/mask.jpg";($shine=$this.create(width,height,"assets/images/_scenelayout/mask.jpg")).setZ(100),$shine.interact(hover,click),_shader=_this.initClass(Shader,"MultiplayerShine",{tMask:{value:Utils3D.getTexture(`assets/images/${mask}`)},uColor:{value:new Color(1,1,1)},uWidth:{value:30},uProgress:{value:0},uAlpha:{value:1},transparent:!0}),$shine.useShader(_shader)}()}(),this.addHandlers=function(){_this.$background.interact(hover,click)},this.initHintAnimation=function(){defer(hintAnimation)},this.animateIn=function(currentView){let startY,endY;switch(currentView){case"Garage":startY=50,endY=30,this.resize(currentView,1),$this.x=30;break;case"Gameplay":let scale=Stage.height/Config.UI_SCALE;this.resize(currentView,scale),endY=70*Math.range(scale,.6,1,.6,1.35),startY=endY+20,$this.x=scale*scale*30}$this.alpha=1e-5,$this.y=startY,$this.tween({alpha:1,y:endY},700,"easeOutCubic",250)},this.resize=function(currentView,scale){switch(currentView){case"Garage":$this.x=30,$this.y=30,$this.scale=1;break;case"Gameplay":scale=Stage.height/Config.UI_SCALE,$this.x=scale*scale*30,$this.y=70*Math.range(scale,.6,1,.6,1.35),$this.scale=scale}},this.animateOut=function(callback){$this.tween({alpha:0,y:20},500,"easeOutCubic").onComplete(()=>{callback&&callback(_this)})},this.onDestroy=function(){$this.remove()}})),Class((function MultiplayerModalView(){const _this=this;function click({type:type,payload:payload}){_this.events.fire(Events.SELECT,{type:type,payload:payload})}this.addHandlers=function(){_this.registerButton(null,null,_=>{click({type:"raceRandom",payload:null})},_this.layers["1-random-player-button"]),_this.registerButton(null,null,_=>{click({type:"raceFriend",payload:null})},_this.layers["1-race-friend-button"]),_this.registerButton(null,null,_=>{click({type:"raceRandom",payload:null})},_this.layers["2-random-player-button"]),_this.registerButton(null,null,_=>{click({type:"copyCode",payload:null})},_this.layers["4-link-box"]),_this.registerButton(null,null,_=>{click({type:"shareCode",payload:null})},_this.layers["4-button-share-box"]),_this.registerButton(null,null,_=>{click({type:"close",payload:"1-button-close"})},_this.layers["1-button-close"]),_this.registerButton(null,null,_=>{click({type:"close",payload:"2-button-close"})},_this.layers["2-button-close"]),_this.registerButton(null,null,_=>{click({type:"close",payload:"3-button-close"})},_this.layers["3-button-close"]),_this.registerButton(null,null,_=>{click({type:"close",payload:"4-button-close"})},_this.layers["4-button-close"]),_this.registerButton(null,null,_=>{click({type:"close",payload:"5-button-close"})},_this.layers["5-button-close"])},this.animateIn=function(){},this.animateOut=function(){},this.onGroupShow=function(group){switch(group.id){case"1v1":this.on1v1Show(group);break;case"connecting":this.pulseText(group["3-header"])}},this.on1v1Show=function(group){const bttn=group["2-random-player-button"],text=group["2-random-player-text"],header=group["2-header"],close=group["2-button-close"];this.pulseText(header),header.originalY||(header.originalY=header.y),bttn.originalY||(bttn.originalY=bttn.y),text.originalY||(text.originalY=text.y),header.y=header.originalY+33,bttn.alpha=0,bttn.y=bttn.originalY+20,text.alpha=0,text.y=text.originalY+20,_this.delayedCall(()=>{close.alpha>2e-4&&(header.tween({y:header.originalY},500,"easeOutQuad"),text.tween({alpha:1,y:text.originalY},500,"easeOutQuad"),bttn.tween({alpha:1,y:bttn.originalY},500,"easeOutQuad"))},2e4)},this.pulseText=function(layer){layer.tween({alpha:0,scale:1},200,"easeOutQuad").onComplete(()=>{layer.tween({alpha:1,scale:1},200,"easeOutQuad").onComplete(()=>{_this&&_this.delayedCall&&_this.delayedCall(()=>{layer.alpha>2e-4&&this.pulseText(layer)},3e3)})})}})),Class((function MultiplayerARX(){Inherit(this,UIFigma),Inherit(this,MultiplayerModalView);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level4_multiplayer"),function applyStyles(){["1-race-friend-button","1-random-player-button","4-button-share-box","2-random-player-button"].forEach(bttnId=>UIFigmaStyles.ArxButton(_this.layers[bttnId]))}(),_this.addHandlers()}()})),Class((function MultiplayerButtonARX(){Inherit(this,GLUIElement),Inherit(this,Multiplayer1V1Button);const _this=this;var $this,$text;_this.gameplayPositioning=[58,125],function initGL(){$this=_this.element}(),function initFigmaStyles(){_this.$background=_this.create(100,38,"assets/images/_scenelayout/mask.jpg"),_this.$background.id="play1v1",UIFigmaStyles.ArxButton(_this.$background),$this.add(_this.$background)}(),function initText(){$text=$glText("PLAY 1v1","BarlowCondensed-ExtraBoldItalic",18,{align:"center",letterSpacing:.03,lineHeight:1,width:155,height:18,color:"#000000"}),$this.add($text),$text.setZ(1),$text.x=_this.$background.x+50,$text.y=_this.$background.y+8,_this.$text=$text}(),_this.addHandlers(),_this.initHintAnimation()})),Class((function MultiplayerIntegra(){Inherit(this,UIFigma),Inherit(this,MultiplayerModalView);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level2_multiplayer"),function applyStyles(){["1-race-friend-button","1-random-player-button","4-button-share-box","2-random-player-button"].forEach(bttnId=>UIFigmaStyles.IntegraButton(_this.layers[bttnId])),["1-random-player-text","1-race-friend-text","2-random-player-text"].forEach(textId=>UIFigmaStyles.IntegraText(_this.layers[textId],new Color(0,0,0))),["2-header","3-header","4-header","5-header"].forEach(textId=>UIFigmaStyles.IntegraTitleText(_this.layers[textId]))}(),_this.addHandlers()}(),this.pulseText=function(layer){layer.tween({alpha:0,scale:.9},200,"easeOutQuad").onComplete(()=>{layer.tween({alpha:1,scale:1},200,"easeOutQuad").onComplete(()=>{_this&&_this.delayedCall&&_this.delayedCall(()=>{layer.alpha>2e-4&&this.pulseText(layer)},3e3)})})}})),Class((function MultiplayerButtonIntegra(){Inherit(this,GLUIElement),Inherit(this,Multiplayer1V1Button);const _this=this;var $this,$text;_this.gameplayPositioning=[58,125],function initGL(){$this=_this.element}(),function initFigmaStyles(){_this.$background=_this.create(125,40,"assets/images/_scenelayout/mask.jpg"),UIFigmaStyles.IntegraButton(_this.$background),$this.add(_this.$background),_this.$background.setZ(1)}(),function initText(){$text=$glText("PLAY 1v1","Roboto-Black",12,{align:"center",letterSpacing:.07,lineHeight:1.2,width:125,height:19,color:"#666666"}),UIFigmaStyles.IntegraText($text),$this.add($text),$text.setZ(2),$text.x=_this.$background.x+62.5,$text.y=_this.$background.y+13.5,_this.$text=$text}(),_this.addHandlers(),_this.initHintAnimation()})),Class((function MultiplayerButtonNewNSX(){Inherit(this,GLUIElement),Inherit(this,Multiplayer1V1Button);const _this=this;var $this,$text;_this.gameplayPositioning=[62,115],function initGL(){$this=_this.element}(),function initFigmaStyles(){_this.$background=_this.create(133,40,"assets/images/_scenelayout/mask.jpg"),_this.$background.id="play1v1",_this.$blackBkg=_this.create(133,40,"assets/images/_scenelayout/black.jpg"),_this.$blackBkg.alpha=.6,_this.$background.add(_this.$blackBkg),UIFigmaStyles.NewNSXButton(_this.$background),$this.add(_this.$background),_this.$background.setZ(1)}(),function initText(){$text=$glText("PLAY 1v1","Orbitron-Bold",16,{align:"center",letterSpacing:.05,lineHeight:1.2,width:133,height:16,color:"#FFBE41"}),$this.add($text),$text.setZ(2),$text.x=_this.$background.x+66.5,$text.y=_this.$background.y+11,_this.$text=$text}(),_this.addHandlers(),_this.initHintAnimation()})),Class((function MultiplayerNewNSX(){Inherit(this,UIFigma),Inherit(this,MultiplayerModalView);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level5_multiplayer"),function applyStyles(){["1-race-friend-button","1-random-player-button","2-random-player-button","4-button-share-box"].forEach(bttnId=>UIFigmaStyles.NewNSXButton(_this.layers[bttnId]))}(),_this.addHandlers()}()})),Class((function MultiplayerButtonOldNSX(){Inherit(this,GLUIElement),Inherit(this,Multiplayer1V1Button);const _this=this;var $this,$background,$text;function hover(e){switch(e.action){case"over":$background.tween({scale:1.1},100,"easeOutCubic");break;default:$background.tween({scale:1},350,"easeOutCubic")}}function click(){_this.events.fire(Events.CLICK)}_this.gameplayPositioning=[58,125],function initGL(){$this=_this.element}(),function initBackground(){_this.$background=$background=$this.create(125,40,"assets/images/uistyles/ui1/ui1-1v1-button.png")}(),function initText(){$text=$glText("PLAY 1v1","PressStart2P-Regular",12,{align:"center",letterSpacing:.02,lineHeight:1.5,width:125,height:40,color:"#000000"}),$this.add($text),$background.setZ(1),$text.setZ(2),$text.x=$background.x+62.5,$text.y=$background.y+16,_this.$text=$text}(),function addHandlers(){$background.interact(hover,click)}(),_this.initHintAnimation()})),Class((function MultiplayerOldNSX(){Inherit(this,UIFigma),Inherit(this,MultiplayerModalView);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level1_multiplayer"),function applyStyles(){for(let id in _this.layers){let layer=_this.layers[id];(id.includes("button")&&!id.includes("close")&&!id.includes("text")||id.includes("link-box"))&&UIFigmaStyles.OldNSXButton(layer)}}(),_this.addHandlers()}(),this.pulseText=function(layer){layer.alpha=0,_this&&_this.delayedCall&&_this.delayedCall(()=>{layer.alpha=1,_this&&_this.delayedCall&&_this.delayedCall(()=>{layer.alpha>2e-4&&this.pulseText(layer)},800)},300)}})),Class((function MultiplayerButtonRDX(){Inherit(this,GLUIElement),Inherit(this,Multiplayer1V1Button);const _this=this;var $this,$text;_this.gameplayPositioning=[51,135],function initGL(){$this=_this.element}(),function initFigmaStyles(){_this.$background=_this.create(130,38,"assets/images/_scenelayout/mask.jpg"),_this.$background.id="play1v1",UIFigmaStyles.RDXButton(_this.$background),defer(_=>{_this.$background.alpha=.45})}(),function initText(){$text=$glText("PLAY 1v1","Capture_it",16,{align:"center",letterSpacing:.06,lineHeight:1,width:198,height:38,color:"#ffffff"}),$this.add($text),$text.setZ(1),$text.x=_this.$background.x+66.5,$text.y=_this.$background.y+11,_this.$text=$text}(),_this.addHandlers(),_this.initHintAnimation()})),Class((function MultiplayerRDX(){Inherit(this,UIFigma),Inherit(this,MultiplayerModalView);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level3_multiplayer"),function applyStyles(){["1-race-friend-button","1-random-player-button","2-random-player-button","4-button-share-box"].forEach(bttnId=>UIFigmaStyles.RDXButton(_this.layers[bttnId]))}(),_this.addHandlers()}()})),Class((function MultiplayerButtonTypeS(){Inherit(this,GLUIElement),Inherit(this,Multiplayer1V1Button);const _this=this;var $this,$text;_this.gameplayPositioning=[57,135],function initGL(){$this=_this.element}(),function initFigmaStyles(){_this.$background=_this.create(130,38,"assets/images/_scenelayout/mask.jpg"),_this.$background.id="play1v1",_this.$blackBkg=_this.create(128,36,"assets/images/_scenelayout/black.jpg"),_this.$blackBkg.x=1,_this.$blackBkg.y=1,_this.$blackBkg.alpha=.6,_this.$blackBkg.setZ(-1),_this.$background.add(_this.$blackBkg),UIFigmaStyles.TypeSButton(_this.$background),$this.add(_this.$background)}(),function initText(){$text=$glText("PLAY 1v1","ChangelingNeo-Regular",13,{align:"center",letterSpacing:.05,lineHeight:.9,width:130,height:38,color:"#ffffff"}),$this.add($text),$text.setZ(1),$text.x=_this.$background.x+66.5,$text.y=_this.$background.y+11,_this.$text=$text}(),_this.addHandlers(),_this.initHintAnimation()})),Class((function MultiplayerTypeS(){Inherit(this,UIFigma),Inherit(this,MultiplayerModalView);const _this=this;!async function(){!function initGL(){_this.element}(),await _this.initLayout("level6_multiplayer"),function applyStyles(){["1-race-friend-button","1-random-player-button","2-random-player-button","4-button-share-box"].forEach(bttnId=>UIFigmaStyles.TypeSButton(_this.layers[bttnId]))}(),_this.addHandlers()}()})),Class((function RotateUI(_name=Utils.query("level_id")){Inherit(this,Element);const _this=this;var $this,_view;function resize(){Stage.width<Stage.height?_this.animateIn():_this.animateOut()}!async function(){!function initHTML(){($this=_this.element).size("100%").setZ(999999),Global.PLAYGROUND===_this.constructor.name?_this.delayedCall(_=>{_this.animateIn()},100):$this.invisible();Stage.add($this)}(),await async function initView(){_view=_this.initClass(RotateView),await _view.ready()}(),function addHandlers(){_this.onResize(resize)}()}(),this.animateIn=async function(){_this.flag("showing")||(_this.flag("showing",!0),await _view.ready(),$this.visible(),_view.animateIn&&_view.animateIn())},this.animateOut=async function(){_this.flag("showing")&&(_this.flag("showing",!1),_view.animateOut&&await _view.animateOut(),$this.invisible())}})),Class((function RotateView(){Inherit(this,Element);const _this=this;var $this,$logo,$icon,$message;!function initHTML(){($this=_this.element).size("100%").bg("#000000")}(),function initLogo(){($logo=$this.create("logo").size(140.25,47.25).bg("assets/images/uistyles/share-logo-black.png")).center(!0,!1).css({top:90})}(),function initIcon(){$icon=$this.create("icon").size(179.2,179.2).bg("assets/images/uistyles/ui-rotate.png").center()}(),function initMessage(){($message=$this.create("message").fontStyle("futura-pt-condensed",18,"#ffffff").size(200,20).center(!0,!1)).css({top:"50%",marginTop:120,textAlign:"center"}).text("ROTATE DEVICE")}(),_this.flag("isReady",!0),this.ready=function(){return _this.wait(_this,"isReady")},this.animateIn=async function(){$logo.css({opacity:0}),$message.css({opacity:0}).transform({y:5}),$icon.css({opacity:0}).transform({x:-40,y:30,rotation:20}),_this.delayedCall(_=>{$logo.tween({opacity:1},2e3,"easeInOutSine"),$message.tween({opacity:1,y:0},800,"easeOutCubic",400),$icon.tween({x:0,y:0,opacity:1,rotation:0},1e3,"easeInOutCubic")},50)}})),Class((function RotateOldNSX(){Inherit(this,UIFigma);const _this=this;var $text,$logo,$rotate;!async function(){!function initGL(){_this.element,[_this.width,_this.height]=[_this.height,_this.width]}(),await _this.initLayout("level1_rotate"),$logo=_this.layers.logo,$text=_this.layers.text,$rotate=_this.layers["rotate-image"]}(),this.animateIn=async function(){await _this.ready(),await _this.wait(_this,"layers"),$logo=_this.layers.logo,$text=_this.layers.text,$rotate=_this.layers["rotate-image"],$logo.alpha=0,$logo.tween({alpha:1},2e3,"easeInOutSine");let y=$text.y;$text.alpha=0,$text.y+=5,$text.tween({alpha:1,y:y},800,"easeOutCubic",400),$rotate.rotation=20,$rotate.alpha=0;let x=$rotate.x;y=$rotate.y,$rotate.x-=40,$rotate.y+=30,$rotate.tween({x:x,y:y,alpha:1,rotation:0},1e3,"easeInOutCubic")}})),Class((function RotateOthers(){Inherit(this,UIFigma);const _this=this;var $text,$logo,$rotate;!async function(){!function initGL(){_this.element,[_this.width,_this.height]=[_this.height,_this.width]}(),await _this.initLayout("level2_rotate"),$logo=_this.layers.logo,$text=_this.layers.text,$rotate=_this.layers["rotate-image"]}(),this.animateIn=async function(){await _this.ready(),await _this.wait(_this,"layers"),$logo=_this.layers.logo,$text=_this.layers.text,$rotate=_this.layers["rotate-image"],$logo.alpha=0,$logo.tween({alpha:1},2e3,"easeInOutSine");let y=$text.y;$text.alpha=0,$text.y+=5,$text.tween({alpha:1,y:y},800,"easeOutCubic",400),$rotate.rotation=20,$rotate.alpha=0;let x=$rotate.x;y=$rotate.y,$rotate.x-=40,$rotate.y+=30,$rotate.tween({x:x,y:y,alpha:1,rotation:0},1e3,"easeInOutCubic")}})),Class((function ShareUI(_name=Utils.query("level_id"),_options={}){Inherit(this,GLUIElement);const _this=this;var $this,_view,_notQualified=!1;function onClick({id:id}){switch(id){case"button-close":case"icon-close":!function close(){_this.events.fire(Events.COMPLETE)}();break;case"facebook-button":share("facebook");break;case"twitter-button":share("twitter");break;case"copy-link-button":share("copy");break;case"email-button":share("email")}}async function share(type){_notQualified||_options.track?Data.tracks[_name].shareTrack(type):Data.tracks[_name].share(type)}!async function(){!function initGL(){$this=_this.element,Global.PLAYGROUND===_this.constructor.name?(_this.delayedCall(_=>{_this.animateIn(),GLUI.Stage.add($this)},100),World.RENDERER.setClearColor("#666666",1)):$this.hide()}(),await async function initView(){let view="Debug";switch(_name){case"integra":view="Integra";break;case"arx":view="ARX";break;case"rdx":view="RDX";break;case"old_nsx":view="OldNSX";break;case"new_nsx":view="NewNSX";break;case"type_s":view="TypeS"}view=`Share${view}`,_view=_this.initClass(window[view],_name),await _view.ready()}(),function addHandlers(){_this.events.sub(_view,Events.CLICK,onClick)}()}(),this.animateIn=async function(playerQualified){GLUI.Stage.ShareLayer.add($this),await _view.ready(),$this.show(),UIConfig.showBackground(),Track.page("/share"),_notQualified=!1===playerQualified,_view.animateIn&&_view.animateIn(),TransitionUtils.autoAnimateIn(_view,_name),_this.events.fire(UIConfig.VISIBILITY,{state:"share"})},this.animateOut=async function(){_view.animateOut&&await _view.animateOut(),UIConfig.hideBackground(),$this.hide(),_this.events.fire(UIConfig.VISIBILITY,{state:"game"})},this.onDestroy=function(){$this.remove()}})),Class((function ShareARX(){Inherit(this,UIFigma);const _this=this;var _copyLink;function hover(e){}function click(e){let id=e.object.id;_this.events.fire(Events.CLICK,{id:id}),"copy-link-button"==id&&_copyLink.text.setText("Link copied!".toUpperCase())}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level4_share"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button","icon-close"])&&_this.registerButton("ArxButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.ArxIcon(layer,id),id.includes("copy-link")&&layer.text&&(layer.text.originalText=layer.text.string,_copyLink=layer)}}(),_this.isReady=!0}(),this.animateIn=async function(){await _this.ready(),_copyLink.text.setText(_copyLink.text.originalText)}})),Class((function ShareIntegra(){Inherit(this,UIFigma);const _this=this;var _copyLink;function hover(e){}function click(e){let id=e.object.id;_this.events.fire(Events.CLICK,{id:id}),"copy-link-button"==id&&_copyLink.text.setText("Link copied!".toUpperCase())}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level2_share"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button","icon-close"])&&_this.registerButton("IntegraButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.IntegraIcon(layer,id),id.includes("share")?UIFigmaStyles.IntegraTitleText(layer):layer.text&&UIFigmaStyles.IntegraText(layer),id.includes("sparkle")&&UIFigmaStyles.IntegraShine(layer),id.includes("copy-link")&&layer.text&&(layer.text.originalText=layer.text.string,_copyLink=layer)}}(),_this.isReady=!0}(),this.animateIn=async function(){await _this.ready(),_copyLink.text.setText(_copyLink.text.originalText)}})),Class((function ShareNewNSX(){Inherit(this,UIFigma);const _this=this;var _copyLink;function hover(e){}function click(e){let id=e.object.id;_this.events.fire(Events.CLICK,{id:id}),"copy-link-button"==id&&_copyLink.text.setText("Link copied!".toUpperCase())}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level5_share"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button","icon-close"])&&_this.registerButton("NewNSXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.NewNSXIcon(layer,id),id.includes("copy-link")&&layer.text&&(layer.text.originalText=layer.text.string,_copyLink=layer)}}(),_this.isReady=!0}(),this.animateIn=async function(){await _this.ready(),_copyLink.text.setText(_copyLink.text.originalText)}})),Class((function ShareOldNSX(){Inherit(this,UIFigma);const _this=this;var _copyLink;function hover(e){}function click(e){let id=e.object.id;_this.events.fire(Events.CLICK,{id:id}),"copy-link-button"==id&&_copyLink.text.setText("Link copied!".toUpperCase())}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level1_share"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button","button-close"])&&_this.registerButton("OldNSXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.OldNSXIcon(layer,id),id.includes("copy-link")&&layer.text&&(layer.text.originalText=layer.text.string,_copyLink=layer)}}(),_this.isReady=!0}(),this.animateIn=async function(){await _this.ready(),_copyLink.text.setText(_copyLink.text.originalText)}})),Class((function ShareRDX(){Inherit(this,UIFigma);const _this=this;var _copyLink;function hover(e){}function click(e){let id=e.object.id;_this.events.fire(Events.CLICK,{id:id}),"copy-link-button"==id&&_copyLink.text.setText("Link copied!".toUpperCase())}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level3_share"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button","icon-close"])&&_this.registerButton("RDXButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.RDXIcon(layer,id),id.includes("copy-link")&&layer.text&&(layer.text.originalText=layer.text.string,_copyLink=layer)}}()}(),this.animateIn=async function(){await _this.ready(),_copyLink.text.setText(_copyLink.text.originalText)}})),Class((function ShareTypeS(){Inherit(this,UIFigma);const _this=this;var _copyLink;function hover(e){}function click(e){let id=e.object.id;_this.events.fire(Events.CLICK,{id:id}),"copy-link-button"==id&&_copyLink.text.setText("Link copied!".toUpperCase())}!async function(){!function initGL(){_this.element}(),await _this.initLayout("level6_share"),function addHandlers(){for(let id in _this.layers){let layer=_this.layers[id];id.includes(["-button","icon-close"])&&_this.registerButton("TypeSButton",hover,click,layer),id.includes("icon")&&UIFigmaStyles.TypeSIcon(layer,id),id.includes("copy-link")&&layer.text&&(layer.text.originalText=layer.text.string,_copyLink=layer)}}(),_this.isReady=!0}(),this.animateIn=async function(){await _this.ready(),_copyLink.text.setText(_copyLink.text.originalText)}})),Class((function SocialBrowser(){Inherit(this,Element);const _this=this;var $this,$container;!function initHTML(){($this=_this.element).size("100%").bg("#000000")}(),function initBG(){$this.create("bg").size("100%").css({opacity:.666,backgroundSize:"cover",backgroundPosition:"25% 75%"}).bg("assets/images/uistyles/social-unsupported-screen.jpg")}(),function initContainer(){$container=$this.create("container").size(320,200).center(!0,!0).css({top:"35%"});let message=`VISIT<b style="position:relative;font-weight:700;display:block;">PLAYBEATTHAT.ACURA.COM</b>IN ${"ios"===Device.system.os?"SAFARI":"CHROME"}`;$container.html(message),$container.fontStyle("futura-pt-condensed",28,"#ffffff").css({fontWeight:400,fontStyle:"italic",textAlign:"center",textTransform:"uppercase"})}(),function initCopyButton(){let $btn=$this.create("copy-link").size(260,45).bg("#fff").center(!0,!1).css({top:"35%",marginTop:50}),$msg=($btn.create("outline").css({top:-4,right:-4,bottom:-4,left:-4,border:"1px solid #fff"}),$btn.create("message").size("100%").fontStyle("futura-pt-condensed",18,"#000000").css({letterSpacing:"0.01sem",fontWeight:700,lineHeight:45,textAlign:"center"})),level=Utils.query("level"),join=Utils.query("join"),link="https://playbeatthat.acura.com/"+location.search;(join||level)&&(link=`${link}?`,join&&(link=`${link}join=${join}`),join&&level&&(link=`${link}&`),level&&(link=`${link}track=${level}`)),$btn.interact(null,_=>{Utils.copyToClipboard(link)&&($btn.tween({scale:.95},200,"easeOutCubic").onComplete(_=>{$btn.tween({scale:1},200,"easeOutCubic")}),$msg.tween({x:50,opacity:0},100,"easeOutQuad").onComplete(_=>{$msg.transform({x:-50}).text("LINK COPIED!"),defer(_=>{$msg.tween({x:0,opacity:1},100,"easeOutQuad",50).onComplete(_=>{$msg.tween({x:50,opacity:0},100,"easeOutQuad",3e3).onComplete(_=>{$msg.transform({x:-50}).text("COPY LINK"),defer(_=>{$msg.tween({x:0,opacity:1},100,"easeOutQuad")})})})})}),Track.event("SocialBrowser","click","copy-link"))}),$msg.text("COPY LINK")}(),Track.page("/social-fallback")})),Class((function BuildingPlane(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null},uTint:{value:new Color},uTintFactor:{value:.5}})})),Class((function PBRBuilding(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogRange:{value:new Vector2},uFogColor:{value:new Color},uBaseTint:{value:new Color},uHueRange:{value:1},uRandomHeight:{value:0}})})),Class((function PBRFence(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tOpacity:{value:null,getTexture:Utils3D.getRepeatTexture},uFogRange:{value:new Vector2},uFogColor:{value:new Color},tTilingTexture:{value:null,getTexture:Utils3D.getRepeatTexture},uTilingMask:{value:.5},uTile:{value:new Vector2}})})),Class((function PBRRoadSurface(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogRange:{value:new Vector2},uFogColor:{value:new Color},uShadowTint:{value:new Color},uOpacityFactor:{value:1},tOpacity:{value:null,getTexture:Utils3D.getRepeatTexture}})})),Class((function PBRRoadSurfaceLightmap(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogRange:{value:new Vector2},uFogColor:{value:new Color},uShadowTint:{value:new Color},uLightmapTile:{value:new Vector2},tLightmap:{value:null,getTexture:Utils3D.getRepeatTexture},uLightmapBrightness:{value:1},uLineFrequency:{value:1},uLineSpeed:{value:1},uLineOffset:{value:1},uLineOffset2:{value:2},uLineCutoff:{value:.5},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color},uAlternateColor:{value:new Color},uAlternateColorFreq:{value:1},uAlternateColorFactor:{value:1},uCloseFogRange:{value:new Vector2(-5500,-5500)}})})),Class((function PBRSurface(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogRange:{value:new Vector2},uFogColor:{value:new Color},uTint:{value:new Color}})})),Class((function PBRSurfaceAlpha(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tOpacity:{value:null,getTexture:Utils3D.getRepeatTexture},uFogRange:{value:new Vector2},uFogColor:{value:new Color}})})),Class((function RealisticSky(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uTile:{value:new Vector2}})})),Class((function Sun(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uTint1:{value:new Color},uTint2:{value:new Color},uRange:{value:new Vector2}})})),Class((function HeadlightMesh(_mesh,_shader){Inherit(this,Component),this.findParent("Gameplay").cars.player.group.add(_mesh)})),Class((function TireFX(_input){Inherit(this,Object3D);const _this=this;!async function(){if(!Tests.tireFX())return;let gameplay=_this.findParent("Gameplay"),car=gameplay.cars.player.car;await car.ready();for(let i=0;i<4;i++){_this.initClass(TireFXSystem,_input.get("wildcard"),car,car.wheels[i])}gameplay.state.bind("paused",value=>{1==value?_this.pause():_this.resume()})}(),this.pause=function(){_this.visible=!1},this.resume=function(){_this.visible=!0}})),Class((function TireFXSpawn(_proton){Inherit(this,Component);const _this=this;var _state=_this.findParent("Gameplay").state,_wheel=_this.parent.data.wheel,_car=_this.parent.data.car,_vel=new Vector3(_wheel.getWorldPosition().x<=0?-1:1,1.5,0),_vel2=new Vector3;function loop(){let pos=_wheel.getWorldPosition();pos.y=0,_vel2.copy(_vel).applyQuaternion(_car.group.quaternion);let acceleration=_state.get("acceleration"),num=Math.floor(Math.range(acceleration,.3,1,3,100))*Render.HZ_MULTIPLIER;_proton.spawn.release(pos,num,.3,_vel2)}_this.startRender(loop)})),Class((function TireFXSystem(_name,_car,_wheel){Inherit(this,Object3D);const _this=this;!function(){let data={car:_car,wheel:_wheel};_this.initClass(SceneLayout,"tirefx_"+_name,{data:data})}()})),Class((function Building(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uFogRange:{value:new Vector2},uFogColor:{value:new Color},uPixellation:{value:100}})})),Class((function BuildingTransparent(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uFogRange:{value:new Vector2},uFogColor:{value:new Color},uTile:{value:new Vector2},uPixellation:{value:100}})})),Class((function GutterNN(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uTextureTile:{value:new Vector2(1,1)},uTextureScroll:{value:new Vector2(0,0)},uFogRange:{value:new Vector2(0,0)},uFogColor:{value:new Color},uPixellation:{value:1},uShadowRange:{value:new Vector2},uShadowColor:{value:new Color}})})),Class((function IntegraBuilding(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getLookupTexture},uFogRange:{value:new Vector2},uFogColor:{value:new Color}})})),Class((function LookupSky(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},tLut:{value:null,getTexture:Utils3D.getLookupTexture},uTile:{value:new Vector2},uScroll:{value:new Vector2},uPixellation:{value:100}})})),Class((function ObjectNN(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getLookupTexture},uFogRange:{value:new Vector2},uFogColor:{value:new Color}})})),Class((function RoadNN(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uTextureTile:{value:new Vector2(1,1)},uTextureScroll:{value:new Vector2(0,0)},uFogRange:{value:new Vector2(0,0)},uFogColor:{value:new Color},uPixellation:{value:1}})})),Class((function NSXRain(_proton){Inherit(this,Component);const _this=this;var _car;function loop(){_proton.behavior.uniforms.uCarPos.value.copy(_car.group.position),_proton.behavior.uniforms.uCarQuat.value.copy(_car.group.quaternion)}!async function(){_proton.antimatter.storeVelocity=!0,_proton.shader.set("DPR",Tests.getNSXDPR());let gameplay=_this.findParent("Gameplay");_car=gameplay.cars.player,_this.startRender(loop)}(),this.pause=function(){_proton.visible=!1},this.resume=function(){_proton.visible=!0}})),Class((function NeonRailing(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uBrightness:{value:1},uOffset:{value:0},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color},uTint4:{value:new Color},uFogRange:{value:new Vector2},uFogColor:{value:new Color},uTile:{value:new Vector2(1,1)}})})),Class((function NeonSign(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uBrightness:{value:1},uOffset:{value:0},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color},uTint4:{value:new Color},uFogRange:{value:new Vector2},uFogColor:{value:new Color},uTile:{value:new Vector2(1,1)}})})),Class((function NeonSky(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uRange:{value:new Vector2},uColor1:{value:new Color},uColor2:{value:new Color},uColor3:{value:new Color},uNoiseFreq:{value:1},uNoiseAmp:{value:1}})})),Class((function PBRRoadSurfaceLights(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogColor:{value:new Color},uShadowTint:{value:new Color}})})),Class((function PBRSurfaceLightmap(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogColor:{value:new Color},uFogRange:{value:new Vector2(-50,-350)},tLightmap:{value:null},uVerticalFogColor:{value:new Color},uVerticalFogRange:{value:new Vector2(1e3,200)},uColor1:{value:new Color},uColor2:{value:new Color},uColor3:{value:new Color},uColor4:{value:new Color},uColor5:{value:new Color}})})),Class((function Blimp(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getLookupTexture},uPixellation:{value:100},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color}})})),Class((function PBROldNSXRetro(_mesh,_shader,_group,_input){Inherit(this,Component);var _mainTex,_windowMaskTex,_windowReflectionTex,_this=this;!function initMainTex(){(_mainTex=Utils3D.getTexture("assets/images/cars/hum3dtest/hum3dtest_Diffuse_dithered.png")).minFilter=_mainTex.magFilter=Texture.NEAREST,_mainTex.wrapS=_mainTex.wrapT=Texture.REPEAT,_mainTex.generateMipmaps=!1}(),function initWindowMaskTex(){(_windowMaskTex=Utils3D.getTexture("assets/images/cars/hum3dtest/window-mask.png")).minFilter=_windowMaskTex.magFilter=Texture.NEAREST,_windowMaskTex.wrapS=_windowMaskTex.wrapT=Texture.REPEAT,_windowMaskTex.generateMipmaps=!1}(),function initWindowReflectionTex(){(_windowReflectionTex=Utils3D.getTexture("assets/images/cars/old_nsx/window-reflection.png")).minFilter=_windowReflectionTex.magFilter=Texture.NEAREST,_windowReflectionTex.wrapS=_windowReflectionTex.wrapT=Texture.REPEAT,_windowReflectionTex.generateMipmaps=!1}(),_shader.addUniforms({tColor:{value:_mainTex},tWindowMask:{value:_windowMaskTex},tWindowReflection:{value:_windowReflectionTex},uResolution:{value:new Vector2},uTile:{value:new Vector2},uWindowTint1:{value:new Color},uWindowTint2:{value:new Color},tLookupTexture:{value:Utils3D.getLookupTexture("assets/images/cars/old_nsx/lookup.png")}}),_this.startRender(()=>{_shader.uniforms.uResolution.value.x=Stage.width,_shader.uniforms.uResolution.value.y=Stage.height})})),Class((function RetroCheckpoint(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color}})})),Class((function RetroClouds(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uTile:{value:new Vector2},uScroll:{value:new Vector2},uTint1:{value:new Color},uTint2:{value:new Color},uRange:{value:new Vector2},uTint3:{value:new Color},uTint4:{value:new Color},tMap:{value:null,getTexture:Utils3D.getRepeatTexture}})})),Class((function RetroCoast(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uTile:{value:new Vector2},uBlendRange:{value:new Vector2},uTint1:{value:new Color},uTint2:{value:new Color},uSky:{value:new Color},uClipHeight:{value:-1},tLUT:{value:null,getTexture:Utils3D.getLookupTexture}})})),Class((function RetroMountains(_mesh,_shader,_group,_input){Inherit(this,Component);!function(){let texture=Utils3D.getLookupTexture("assets/images/environment/old_nsx/mountain-mask.png");texture.wrapS=Texture.REPEAT,_shader.addUniforms({uTile:{value:new Vector2},tMap:{value:texture}})}()})),Class((function RetroRailing(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tLUT:{value:null,getTexture:Utils3D.getLookupTexture},tNormal:{value:null,getTexture:Utils3D.getRepeatTexture},tOpacity:{value:null,getTexture:Utils3D.getRepeatTexture},uTile:{value:new Vector2},uTint1:{value:new Color},uTint2:{value:new Color},uSky:{value:new Color}}),_shader.transparent=!0})),Class((function RetroRoad(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tLUT:{value:null,getTexture:Utils3D.getLookupTexture},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color},uTint4:{value:new Color},uTint5:{value:new Color},uShadowTint:{value:new Color},uLineWidth:{value:1},uLineWidthCenter:{value:1},uLineCount:{value:1},uLineLength:{value:1},uInnerEdgeDistance:{value:1},uInnerEdgeWidth:{value:1},uLineColor:{value:new Color},uSky:{value:new Color},uTile:{value:new Vector2},uEdgeGradient:{value:new Vector2},uEdgeSolid:{value:1},uNoiseFrequency:{value:1},uStep:{value:1},uPixellation:{value:1}})})),Class((function RetroRoad2(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uTile:{value:1},uRoadTint:{value:new Color},uRoadBandTint:{value:new Color},uRoadBandCount:{value:1},uRoadBandWidth:{value:.5},uCenterLineTint:{value:new Color},uCenterLineWidth:{value:.015},uCenterLineLength:{value:.3},uCenterLineCount:{value:12},uStripedEdgeTint1:{value:new Color},uStripedEdgeTint2:{value:new Color},uStripedEdgeWidth:{value:.2},uStripedEdgeLength:{value:.25},uStripedEdgeCount:{value:15},uStripedEdgeShadowTint:{value:new Color},uStripedEdgeShadowWidth:{value:0},uStripedEdgeShadowThickness:{value:.2},uDirtEdgeTint:{value:new Color},uDirtEdgeWidth:{value:.05},uShadowTint:{value:new Color}})})),Class((function RetroTree(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tLUT:{value:null,getTexture:Utils3D.getLookupTexture},uRange:{value:new Vector2},uDistanceRange:{value:new Vector2},uTint1:{value:new Color},uTint2:{value:new Color},uBaseTint:{value:new Color},uSky:{value:new Color},uBands:{value:5}})})),Class((function RetroWater(_mesh,_shader,_group,_input){Inherit(this,Component);var _this=this;!function(){!async function initMirror(){let mirror=new FX.Mirror(_mesh,{enabled:Tests.renderRetroWater(),width:512,height:512,format:Texture.RGBAFormat});mirror.start(),mirror.decorate(_shader),mirror.useCamera(_this.findParent("Gameplay").nuke.camera);let layers=await _this.parent.getAllLayers();for(let key in layers){let l=layers[key];l instanceof Mesh&&l!=_mesh&&(l.instanceMeshReady?l.instanceMeshReady.then(_=>mirror.add(l.instanceMesh)):mirror.add(l))}let track=await _this.findParent("Gameplay").track.getTrackMesh();mirror.add(track)}(),_shader.addUniforms({uTint1:{value:new Color},uTint2:{value:new Color},tWaterNormal:{value:null,getTexture:Utils3D.getRepeatTexture},uWaterSpeed:{value:1},uUVScale:{value:1},uMirrorDistort:{value:1},uReflBlend:{value:.5},uReflColor:{value:new Color},uTint:{value:new Color}});let texture=_shader.get("tWaterNormal");texture&&(texture.anisotropy=World.RENDERER.getMaxAnisotropy())}()})),Class((function SkyFollow(_mesh,_shader,_group,_input){Inherit(this,Component);const _this=this;new Euler;!function(){console.log(_mesh);_this.findParent("Gameplay").camera.group,_this.findParent("Gameplay").camera.camera;console.log(_this.findParent("Gameplay").camera.camera),_this.startRender(_=>{},10)}()})),Class((function PBRSnowRoad(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tNormal:{value:null},uFogRange:{value:new Vector2},uFogColor:{value:new Color}})})),Class((function PBRSnowSurface(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tNormal:{value:null},uFogRange:{value:new Vector2},uFogTopRange:{value:new Vector2},uFogBottomRange:{value:new Vector2},uFogColor:{value:new Color}})})),Class((function RDXFog(){Inherit(this,FXScene);const _this=this;var _camera,_globalCamera;function loop(){_camera.position.copy(_globalCamera.position),_camera.quaternion.copy(_globalCamera.quaternion)}!function(){if(!Tests.renderRDXFog())return;let gameplay=_this.findParent("Gameplay");_this.create(gameplay.nuke),_this.setDPR(1),_this.setResolution(.25),_globalCamera=gameplay.nuke.camera,_camera=gameplay.nuke.camera.clone(),_this.startRender(loop,gameplay.nuke),_this.useCamera(_camera),_camera.near=.1,_camera.far=30,_camera.updateProjectionMatrix();let layout=_this.initClass(SceneLayout,"rdxfog");_this.scene.add(layout.group),_this.startRender(_=>_this.render()),gameplay.vfx.custom.registerFog(_this)}()})),Class((function RDXFogProton(_proton,_group){Inherit(this,Object3D);const _this=this;var _geom;!async function(){let gameplay=_this.findParent("Gameplay");gameplay.cars.player,_geom=(new Geometry).instanceFrom(new PlaneGeometry(1,1)),_proton.applyToInstancedGeometry(_geom);let shader=_this.initClass(Shader,"RDXFog",{tMap:{value:null},uScale:{value:1},uAlpha:{value:1},uQuat:{value:gameplay.nuke.camera.quaternion},tMap:{value:null},uScale:{value:1},uAlpha:{value:1},uNoiseScale:{value:1},uNoiseStrength:{value:1},uNoiseTime:{value:1},uDist:{value:new Vector2(50,50)},uDist2:{value:new Vector2(0,5)},uColor:{value:new Color},transparent:!0,depthWrite:!1,side:Shader.DOUBLE_SIDE});ShaderUIL.add(shader,_group),_proton.applyToShader(shader),shader;let mesh=new Mesh(_geom,shader);_this.add(mesh),mesh.frustumCulled=!1,await _proton.ready(),_this.delayedCall(_proton.stopUpdating,1e3)}(),this.onDestroy=function(){_geom.destroy()}})),Class((function RDXSnow(_proton){Inherit(this,Component);const _this=this;var _car;function loop(){_proton.behavior.uniforms.uCarPos.value.copy(_car.group.position),_proton.behavior.uniforms.uCarQuat.value.copy(_car.group.quaternion)}!async function(){let gameplay=_this.findParent("Gameplay");_car=gameplay.cars.player,_this.startRender(loop),_proton.shader.set("DPR",Tests.getRDXDPR()),gameplay.state.bind("paused",value=>{1==value?_this.pause():_this.resume()})}(),this.pause=function(){_proton.visible=!1},this.resume=function(){_proton.visible=!0}})),Class((function Rock(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tNormal:{value:null},uFogRange:{value:new Vector2},uFogTopRange:{value:new Vector2},uFogBottomRange:{value:new Vector2},uFogColor:{value:new Color},uColor:{value:new Color},uColorFactor:{value:1}})})),Class((function Snow(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogRange:{value:new Vector2},uFogTopRange:{value:new Vector2},uFogBottomRange:{value:new Vector2}})})),Class((function SnowRoad(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uTextureTile:{value:new Vector2(1,1)},uFogRange:{value:new Vector2},uFogColor:{value:new Color}})})),Class((function WinterSky(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uTile:{value:new Vector2},uScroll:{value:new Vector2},uRange:{value:new Vector2},uTint1:{value:new Color},uTint2:{value:new Color},uMix:{value:1},uFogRange:{value:new Vector2},uFogColor1:{value:new Color},uFogColor2:{value:new Color}})})),Class((function PBRStructure(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uFogRange:{value:new Vector2},uFogColor:{value:new Color},uRangeTop:{value:new Vector2},uRangeBottom:{value:new Vector2},uRangeTopEdge:{value:new Vector2},uTint1:{value:new Color},uTint2:{value:new Color},uTint3:{value:new Color},uLineFrequency:{value:2},uLineSpeed:{value:1.5},uLineOffset:{value:1},uLightBrightness:{value:1}})})),Class((function TypeSSky(_mesh,_shader,_group,_input){Inherit(this,Component);!function(){let texture=Utils3D.getLookupTexture("assets/images/environment/old_nsx/cloud.png");texture.wrapS=Texture.REPEAT,_shader.addUniforms({uHighlightRange:{value:new Vector2},tMap:{value:texture},uTile:{value:new Vector2(6,12)},uScroll:{value:new Vector2(-.4,-5)},uRange:{value:new Vector2(.5,.55)},uRange2:{value:new Vector2(.5,.55)},uSkyTint1:{value:new Color},uSkyTint2:{value:new Color},uSkyTint3:{value:new Color},uGroundTint:{value:new Color},uCloudTint:{value:new Color},uBands:{value:4.4}})}()})),Class((function GameUI(){Inherit(this,GLUIElement);const _this=this;var $this;!function initGL(){$this=_this.element,GLUI.Stage.add($this)}(),function initLayout(){let name=Utils.query("name"),type=Utils.query("type"),id=`${name}${type?"_"+type:""}`;_this.layout=_this.initClass(StageLayout,id,{glui:!0}),World.RENDERER.setClearColor("#666666",1),console.log(id)}()})),Class((function Road(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uTextureTile:{value:new Vector2(1,1)},uTextureScroll:{value:new Vector2(0,0)}})})),Class((function TestRoad(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getRepeatTexture},uTextureTile:{value:new Vector2(1,1)}})})),Class((function RetroSky(_mesh,_shader,_group,_input){Inherit(this,Component);!function(){let texture=Utils3D.getLookupTexture("assets/images/environment/old_nsx/cloud.png");texture.wrapS=Texture.REPEAT,_shader.addUniforms({tMap:{value:texture},uTile:{value:new Vector2},uScroll:{value:new Vector2},uRange:{value:new Vector2},uSkyTint1:{value:new Color},uSkyTint2:{value:new Color},uGroundTint:{value:new Color},uCloudTint:{value:new Color},uBands:{value:5}})}()})),Class((function RetroSky2(_mesh,_shader,_group,_input){Inherit(this,Component);!function(){let texture=Utils3D.getLookupTexture("assets/images/environment/old_nsx/cloud.png");texture.wrapS=Texture.REPEAT,_shader.addUniforms({uHighlightRange:{value:new Vector2},tMap:{value:texture},uTile:{value:new Vector2(6,12)},uScroll:{value:new Vector2(-.4,-5)},uRange:{value:new Vector2(.5,.55)},uRange2:{value:new Vector2(.5,.55)},uSkyTint1:{value:new Color},uSkyTint2:{value:new Color},uSkyTint3:{value:new Color},uGroundTint:{value:new Color},uCloudTint:{value:new Color},uBands:{value:4.4}})}()})),Class((function RetroSun(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uRange:{value:new Vector2},uHighlightRange:{value:new Vector2},uBands:{value:5},uTint1:{value:new Color},uTint2:{value:new Color},uCutOff:{value:.5}})})),Class((function SkyGradient(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uRange:{value:new Vector2},uTint1:{value:new Color},uTint2:{value:new Color}})})),Class((function SplashScreen(){Inherit(this,FXScene);const _this=this;var _layout,_promise,$logo,_worldCamera=Camera.instance().createLocal(),_startCamera=_this.initClass(BaseCamera),_endCamera=_this.initClass(BaseCamera);function resize(){$logo&&($logo.isAnimating||($logo.scale=Stage.height/2e3,$logo.x=.5*(Stage.width-$logo.width),$logo.y=.175*Stage.height-.5*$logo.height))}!async function(){_this.create(),_this.startRender(_=>_this.render()),_this.setDPR(1),function initPass(){let pass=_this.initClass(NukePass,"SplashVFX",{uLowerResolution:{value:1},tCRT:{value:null,getTexture:Utils3D.getRepeatTexture},uCRTScale:{value:1},uCRTBlend:{value:new Vector3(1.5,.5,1.2)},uNoise:{value:new Vector3(10,1,1)},uCollision:{value:0},uRes:{value:1},uVignette:{value:0}});_this.nuke.add(pass),ShaderUIL.add(pass)}(),_startCamera.lock(_worldCamera),Utils.query("orbit")||_this.useCamera(_worldCamera.worldCamera),_startCamera.prefix="splash_camera",CameraUIL.add(_startCamera),_endCamera.prefix="splash_camera_finish",CameraUIL.add(_endCamera),_layout=_this.initClass(SceneLayout,"splashscreen"),_this.scene.add(_layout.group),function initLogo(){($logo=$gl(512,74,"assets/images/splash/logo.png")).alpha=0,GLUI.Stage.add($logo)}(),function addHandlers(){_this.onResize(resize)}()}(),this.animateOut=async function(){$logo.alpha=1,resize(),$logo.isAnimating=!0,$logo.tween({y:.85*-Stage.height,scale:3.5*$logo.scale},7e3,"easeInQuint").onUpdate(_=>{$logo.x=.5*(Stage.width-$logo.width)}),$logo.tween({alpha:0},1e3,"easeOutCubic",5e3),_endCamera.transition(7e3,"easeInQuint",_worldCamera),await _this.wait(5e3)},this.loaded=function(){return _promise||(_promise=Promise.create(),_promise=Initializer3D.uploadAll(_layout))}})),Class((function NormalTest(){Inherit(this,Object3D);const _this=this;!async function initScene(){_this.initClass(SceneLayout,"normaltestplayground")}()})),Class((function PBRTest(_mesh,_shader){Inherit(this,CarCommonShader,_shader)})),Class((function PBRTestCar(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uTint:{value:new Color},tPaintMask:{value:null}})})),Class((function PixelCar(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({tMap:{value:null,getTexture:Utils3D.getLookupTexture},uTint1:{value:new Color},uTint2:{value:new Color}})})),Class((function PixelShadow(_mesh,_shader,_group,_input){Inherit(this,Component);_shader.addUniforms({uAlpha:{value:.5},uTint:{value:new Color}})})),Class((function ShaderTest(){Inherit(this,Object3D);const _this=this;!async function initScene(){_this.initClass(SceneLayout,"shadertest_layout")}()})),Class((function FigmaTest(){Inherit(this,GLUIElement);const _this=this,EDGE=26;var $this,_layout,_layers;function resize(){!function map(){let el=_layers.map;el.x=EDGE,el.y=Stage.height-el.height-EDGE}(),function pause(){let el=_layers.pause;el.x=EDGE,el.y=EDGE}(),function stage(){let[pause,stage]=[_layers.pause,_layers["stage-number"]];stage.x=pause.x+pause.width+10,stage.y=pause.y+.5*(pause.height-28)}(),async function elapsed(){let[label,number]=[_layers.elapsed,_layers["elapsed-time"]];await label.text.ready(),label.x=.5*Stage.width,label.y=EDGE,number.x=.5*Stage.width,number.y=label.y+label.dimensions.height+5}(),async function beat(){let[label,number]=[_layers["to-beat"],_layers["to-beat-time"]];await label.text.ready(),label.x=Stage.width-EDGE,label.y=EDGE,number.x=Stage.width-EDGE,number.y=label.y+label.dimensions.height+5}(),async function odometer(){let[shape,number,label]=[_layers.odometer,_layers["speed-number"],_layers.mph];shape.x=Stage.width-shape.width-EDGE,shape.y=Stage.height-shape.height-EDGE,await Promise.all([number.text.ready(),label.text.ready()]),number.x=shape.x+.5*shape.width,number.y=shape.y+.5*shape.height-.5*number.dimensions.height,label.x=shape.x+.5*shape.width,label.y=number.y+number.dimensions.height+7}()}!async function(){!function initHTML(){$this=_this.element,GLUI.Stage.add($this)}(),await async function initLayout(){_layout=_this.initClass(StageLayout,"figmatest",{glui:!0}),_layers=await _layout.getAllLayers(),$this.add(_layout.element)}(),function addHandlers(){_this.onResize(resize)}()}()})),Class((function InstanceTest(){Inherit(this,Object3D),this.initClass(SceneLayout,"instancetest")})),Class((function Main(){Inherit(this,Component);const _this=this;function init(){if(GLUI.init(),window.location.search.includes("p="))return AssetLoader.loadAssets(Assets.list().filter(["data","shaders","lib"])).then(Playground.instance);Container.instance()}Global.ONLINE=!1,GameCenter.ports=2,GameCenter.connect(Config.SOCKET),Assets.CORS="anonymous",Assets.CDN=Config.CDN,FontConfig.instance(),Utils.query("performance")?Performance.displayResults():Tests.fallback()?Stage.add(_this.initClass(Fallback)):Tests.fallbackSocialBrowser()?Stage.add(_this.initClass(SocialBrowser)):(Config.FACEBOOK?function initFB(){FBInstant.initializeAsync().then(()=>{FBInstant.setLoadingProgress(100),FBInstant.startGameAsync().then(()=>{init()})})}():init(),Track.event("Platform",Config.FACEBOOK?"fb-instant-game":"web"),"android"!=Device.system.os||Config.FACEBOOK||(Mobile.fullscreen(),Mobile.setOrientation("landscape")))}));
window._MINIFIED_=true;
window._BUILT_=true;