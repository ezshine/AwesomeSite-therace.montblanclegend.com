!function(root){"use strict";var Klang,func;function Module(func){func(Klang)}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext,func=function(){var Klang={};return Klang.version=Klang.versionNumber=3,Klang.context=null,Klang.engineVersion="N/A",Klang.progressCallback=null,Klang.readyCallback=null,Klang.browser=null,Klang.os=null,Klang.isMobile=null,Klang.isIOS=null,Klang.fallback=null,Klang.loggingEnabled=!1,Klang.useMonoBuffers=!1,Klang.Panner=null,Klang.safari=!1,Klang.Model={},Klang},Klang=func(),Module((function(){window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext})),Module((function(Klang){return Klang.Model.Data=function(data,name){this.data=data.data,this._name=name}})),Module((function(Klang){return Klang.core={}})),Module((function(Klang){!function(detector){var supportedAudioFileSuffixes,temp,ua,match;detector.canPlayAudioSuffix=function(suffix){supportedAudioFileSuffixes=supportedAudioFileSuffixes||function(){var a=window.document.createElement("audio");if(!a.canPlayType)return!1;var supportedFileTypes=[];return a.canPlayType('audio/ogg; codecs="vorbis"').replace(/no/,"")&&supportedFileTypes.push(".ogg"),a.canPlayType("audio/aac").replace(/no/,"")&&supportedFileTypes.push(".m4a"),a.canPlayType("audio/mpeg;").replace(/no/,"")&&supportedFileTypes.push(".mp3"),supportedFileTypes}();for(var i=0;i<supportedAudioFileSuffixes.length;i++)if(supportedAudioFileSuffixes[i]===suffix)return!0;return!1},detector.browser=(ua=navigator.userAgent,0==(match=ua.match(/(edge(?=\/))\/?\s*(\d+)/i)||[]).length&&(match=ua.match(/(edge|opera|chrome|safari|firefox|msie|trident(?=\/))\/?\s*(\d+)/i)||[]),/trident/i.test(match[1])?{name:"IE",version:(temp=/\brv[ :]+(\d+)/g.exec(ua)||[])[1]||"unknown"}:"Chrome"===match[1]&&null!==(temp=ua.match(/\bOPR\/(\d+)/))?{name:"Opera",version:temp[1]}:(match=match[2]?[match[1],match[2]]:[navigator.appName,navigator.appVersion,"-?"],null!==(temp=ua.match(/version\/(\d+)/i))&&match.splice(1,1,temp[1]),{name:match[0],version:parseInt(match[1])}))}(Klang.detector||(Klang.detector={}));var detector=Klang.detector;return Klang.core.detector=detector})),Module((function(Klang){!function(network){network.isCrossDomain=function(url){var target=document.createElement("a");target.href=url;var host=document.createElement("a");return host.href=location.href,""!=target.hostname&&(target.port!=host.port||target.protocol!=host.protocol||target.hostname!=host.hostname)},network.request=function(options,onDone,onProgress,onError){var request;if(options.type=options.type||"GET","MSIE"==Klang.detector.browser.name&&Klang.detector.browser.version<10)(request=new window.XDomainRequest).onload=function(){setTimeout((function(){onDone&&onDone(request.responseText)}),10)},request.onprogress=onProgress||function(){},request.onerror=onError||function(){},request.open(options.type,options.url,!0);else{if(!window.XMLHttpRequest)throw"Error - browser does not support XDomain/XMLHttp Requests";(request=new XMLHttpRequest).open(options.type,options.url,!0),request.onreadystatechange=function(){try{if(4==request.readyState&&200==request.status){if(onDone){var response=request.responseText;onDone(response)}}else 0!=request.status&&200!=request.status&&onError&&onError({status:request.status})}catch(e){throw e}}}request&&request.send(null)}}(Klang.network||(Klang.network={}));var network=Klang.network;return Klang.core.network=network})),Module((function(Klang){function FileHandler(){this.memUsage=0,this._decoding=!1,this._files={},this._bufferQue=[],this._groups={},this._lastSentPercent=-1,this.deferDecoding=!1,this.stremingFileIds=[]}return FileHandler.inst=null,Object.defineProperty(FileHandler,"instance",{get:function(){return null==FileHandler.inst&&(FileHandler.inst=new FileHandler),FileHandler.inst},enumerable:!0,configurable:!0}),FileHandler.prototype.sendProgressCallback=function(group){var loadGroup=this._groups[group];if(loadGroup.progressCallback&&!loadGroup.loadInterrupted){var percent=0;loadGroup.progress.readyAudioFiles>=loadGroup.progress.totalAudioFiles&&(percent=Math.floor((loadGroup.progress.loadedBytes+loadGroup.progress.bufferedFiles)/(loadGroup.progress.totalBytes+loadGroup.progress.totalFiles)*(100-(loadGroup.progress.totalFiles-loadGroup.progress.convertedFiles)))),this._lastSentPercent!==percent&&loadGroup.progressCallback(percent),this._lastSentPercent=percent}},FileHandler.prototype.updateProgress=function(request,e){var group=request.load_group;if(!request.sizeReceived){request.sizeReceived=!0;var totalBytes=1;e.lengthComputable&&(totalBytes=e.total,request.loadedBytes=0),request.totalBytes=totalBytes,this._groups[group].progress.totalBytes+=totalBytes,this._groups[group].progress.readyAudioFiles++}if(void 0!==request.loadedBytes){var deltaBytes=e.loaded-request.loadedBytes;request.loadedBytes=e.loaded,this._groups[group].progress.loadedBytes+=deltaBytes,this.sendProgressCallback(group)}},FileHandler.prototype.decodeBufferQue=function(){var _this=this;if(this._bufferQue.length){var queItem=this._bufferQue.pop(),data=queItem.data,info=queItem.info,callback=queItem.callback;this._decoding=!0,Klang.context.decodeAudioData(data,(function(buf){var group=_this._groups[info.load_group];if(_this._decoding=!1,Klang.useMonoBuffers){var bufferLength=buf.length,monoBuffer=Klang.context.createBuffer(1,bufferLength,Klang.context.sampleRate),leftChannelData=buf.getChannelData(0),monoChannelData=monoBuffer.getChannelData(0);if("function"==typeof monoChannelData.set)monoChannelData.set(leftChannelData);else{for(var ix=0;ix<bufferLength;ix++)monoChannelData[ix]=leftChannelData[ix];buf=monoBuffer}}Klang.downSample&&Klang.downSample!==Klang.context.sampleRate&&(buf=Klang.Util.downSample(buf,Klang.downSample)),_this.memUsage+=buf.length*buf.numberOfChannels*Float32Array.BYTES_PER_ELEMENT;_this.memUsage;_this.addFile(info,buf),group.progress.convertedFiles++,queItem.data=null,_this._bufferQue.length?_this.decodeBufferQue():callback&&callback()}),(function(ex){Klang.log("Klang warning: unable to load file '"+(this._baseURL||"")+info.url+"'")}))}},FileHandler.prototype.decode=FileHandler.prototype.decodeBufferQue,FileHandler.prototype.loadAudioBuffer=function(info,callback){var _this=this,request=new XMLHttpRequest,format=".mp3";"Firefox"!==Klang.detector.browser.name&&"Chrome"!==Klang.detector.browser.name||(format=".ogg");var url=(info.external?"":this._baseURL)+info.url+format;request.open("GET",url,!0),request.responseType="arraybuffer",request.sizeReceived=!1,request.load_group=info.load_group,request.onprogress=function(e){_this.updateProgress(request,e)},request.onload=function(e){var group=_this._groups[info.load_group],queueItem={data:request.response,load_group:group,info:info,callback:callback};if(_this._bufferQue.push(queueItem),request.loadedBytes){var deltaBytes=request.totalBytes-request.loadedBytes;group.progress.loadedBytes+=deltaBytes}else group.progress.loadedBytes+=1;_this.updateProgress(request,e),_this.deferDecoding?(queueItem.callback&&queueItem.callback(),queueItem.load_group.progress.bufferedFiles++,queueItem.load_group.progress.bufferedFiles===queueItem.load_group.progress.totalFiles&&queueItem.load_group.filesLoadedCallback(!0,queueItem.load_group._loadedFiles)):_this.decodeBufferQue();try{request.response=null}catch(e){}request=null},request.onreadystatechange=function(){4==request.readyState&&200==request.status||200!=request.status&&(_this._groups[info.load_group].loadInterrupted=!0,_this._groups[info.load_group].loadFailedCallback&&_this._groups[info.load_group].loadFailedCallback())},request.send(),this._groups[info.load_group].progress.totalAudioFiles++},FileHandler.prototype.loadMidiFile=function(info,callback){var _this=this;loadRemote(this._baseURL+info.url,(function(request,e){_this.updateProgress(request,e)}),(function(data){_this.addFile(info,readMidiFile(data)),callback&&callback()}))},FileHandler.prototype.loadMidiString=function(info){var _this=this,request=new XMLHttpRequest;request.open("GET",this._baseURL+info.url),request.onprogress=function(e){_this.updateProgress(request,e)},request.onreadystatechange=function(){4==this.readyState&&200==this.status&&_this.addFile(info,readMidiString(request.response))},request.send()},FileHandler.prototype.loadFiles=function(group,filesLoadedCallback,progressCallback,loadFailedCallback){"string"==typeof group&&(group=[group]);for(var groupsToLoad=group.length,_filesLoadedCallback=function(){0===--groupsToLoad&&filesLoadedCallback&&filesLoadedCallback.apply(this,arguments)},loadProgression={},_progressCallback=function(prog){if(progressCallback){loadProgression[this.name]=prog;var cnt=0,totProg=0;for(var key in loadProgression)loadProgression.hasOwnProperty(key)&&(cnt++,totProg+=loadProgression[key]);progressCallback(totProg/=cnt)}},_loadFailedCallback=function(){_filesLoadedCallback()},ix=0,len=group.length;ix<len;ix++)loadProgression[group[ix]]=0,this._groups[group[ix]]={},this._groups[group[ix]]._loadedFiles=[],this._groups[group[ix]].filesLoadedCallback=_filesLoadedCallback,this._groups[group[ix]].progressCallback=_progressCallback.bind(this._groups[group[ix]]),this._groups[group[ix]].loadFailedCallback=_loadFailedCallback,this._groups[group[ix]].loadInterrupted=!1,this._groups[group[ix]].name=group[ix],this._groups[group[ix]].progress={totalBytes:0,loadedBytes:0,totalFiles:0,totalAudioFiles:0,readyAudioFiles:0,bufferedFiles:0,convertedFiles:0};this.checkStreaming();for(ix=0,len=this._fileInfo.length;ix<len;ix++){var info=this._fileInfo[ix],groupIx=group.indexOf(info.load_group);if(-1!=groupIx&&!this._files[info.id]&&!info.only_audio_tag){switch(info.file_type){case"audio":if(-1!==this.stremingFileIds.indexOf(info.id))continue;this.loadAudioBuffer(info);break;case"midi":this.loadMidiFile(info);break;case"midistring":this.loadMidiString(info)}this._groups[group[groupIx]].progress.totalFiles++}}for(ix=0,len=group.length;ix<len;ix++)0==this._groups[group[ix]].progress.totalFiles&&this._groups[group[ix]].filesLoadedCallback&&!this._groups[group[ix]]._loadInterrupted&&this._groups[group[ix]].filesLoadedCallback(!0,this._groups[group[ix]]._loadedFiles)},FileHandler.prototype.checkStreaming=function(){var objects=Klang.core.Core.instance._objectTable;for(var key in objects){var object=objects[key];if(object instanceof Klang.Model.StreamingAudioSource){var fileId=object._fileId;this.stremingFileIds.push(fileId)}}},FileHandler.prototype.prepareFile=function(fileInfo){this._fileInfo.push(fileInfo)},FileHandler.prototype.prepareFiles=function(fileInfo){var i,len;for(i=0,len=fileInfo.length;i<len;i++)this.prepareFile(fileInfo[i])},FileHandler.prototype.addFile=function(info,file){this._files[info.id]=file,this._groups[info.load_group].progress.bufferedFiles++,this._groups[info.load_group]._loadedFiles=this._groups[info.load_group]._loadedFiles||[],this._groups[info.load_group]._loadedFiles.push(info),this.sendProgressCallback(info.load_group),this._groups[info.load_group].progress.bufferedFiles!=this._groups[info.load_group].progress.totalFiles||this._groups[info.load_group].loadInterrupted||this._groups[info.load_group].filesLoadedCallback&&this._groups[info.load_group].filesLoadedCallback(!0,this._groups[info.load_group]._loadedFiles||[])},FileHandler.prototype.freeSoundFiles=function(group){"string"==typeof group&&(group=[group]);for(var ix=0,len=this._fileInfo.length;ix<len;ix++){var info=this._fileInfo[ix];-1!=group.indexOf(info.load_group)&&(this._files[info.id]=null)}},FileHandler.prototype.freeSoundFile=function(id){this._files[id]&&(this._files[id]=null)},FileHandler.prototype.getLoadGroups=function(){var i,fileInfoArr=this._fileInfo||[],groupTable={},listOfGroups=[];for(i=0;i<fileInfoArr.length;i++){var fileInfo=fileInfoArr[i];groupTable[fileInfo.load_group]=fileInfo.load_group}for(i in groupTable)listOfGroups.push(i);return listOfGroups},FileHandler.prototype.getFile=function(id){return this._files[id]||null},FileHandler.prototype.getFilesForLoadgroup=function(loadGroup){for(var ret=[],ix=0,len=this._fileInfo.length;ix<len;ix++)this._fileInfo[ix].load_group==loadGroup&&ret.push(this._fileInfo[ix]);return ret},FileHandler.prototype.getFileInfo=function(fileId){for(var ix=0,len=this._fileInfo.length;ix<len;ix++)if(this._fileInfo[ix].id==fileId)return this._fileInfo[ix]},FileHandler.prototype.preloadFiles=function(loadgroups){},Object.defineProperty(FileHandler.prototype,"progress",{get:function(){return this._groups},enumerable:!0,configurable:!0}),Object.defineProperty(FileHandler.prototype,"baseURL",{set:function(url){this._baseURL=url},enumerable:!0,configurable:!0}),Object.defineProperty(FileHandler.prototype,"fileInfo",{set:function(fileInfo){this._fileInfo=fileInfo},enumerable:!0,configurable:!0}),Klang.core.FileHandler=FileHandler})),Module((function(Klang){function Scheduler(){this._updateTime=100,this._lookAHead=2*this._updateTime,this._callbacks=[]}return Scheduler.prototype.scheduleClose=function(callback){var timeOffset=callback.targetTime-Klang.context.currentTime;setTimeout((function(){callback.func.apply(callback.ctx)}),1e3*timeOffset)},Scheduler.prototype.runScheduler=function(){if(this._callbacks.length>0){for(var currentTime=Klang.context.currentTime,ix=0;ix<this._callbacks.length;ix++){var callback=this._callbacks[ix];currentTime+this._lookAHead>=callback.targetTime&&(this.scheduleClose(callback),this._callbacks.splice(ix,1),ix--)}this._lastTime=currentTime;var _this=this;this._scheduler=setTimeout((function(){_this.runScheduler()}),_this._updateTime)}else this.stop()},Scheduler.prototype.start=function(){this._started=!0,this._lastTime=Klang.context.currentTime,clearTimeout(this._scheduler),this.runScheduler()},Scheduler.prototype.stop=function(){this._started=!1,clearTimeout(this._scheduler),this._scheduler=null},Scheduler.prototype.delay=function(targetTime,func,ctx){return this.at(Klang.context.currentTime+targetTime,func,ctx)},Scheduler.prototype.at=function(targetTime,func,ctx){return targetTime<Klang.context.currentTime?this:(this._callbacks.push({ctx:ctx||this,func:func,targetTime:targetTime}),this._started||this.start(),this)},Scheduler.prototype.cancel=function(func){for(var i=0;i<this._callbacks.length;i++)if(this._callbacks[i].func&&this._callbacks[i].func===func){this._callbacks.splice(i,1);break}return this},Klang.core.Scheduler=Scheduler})),Module((function(Klang){function TimeHandler(){this._callbacks=[]}return TimeHandler.inst=null,Object.defineProperty(TimeHandler,"instance",{get:function(){return null==TimeHandler.inst&&(TimeHandler.inst=new TimeHandler),TimeHandler.inst},enumerable:!0,configurable:!0}),TimeHandler.prototype.startScheduler=function(){if(this._callbacks.length>0){for(var currentTime=Klang.context.currentTime,deltaTime=currentTime-this._lastTime,ix=0;ix<this._callbacks.length;ix++){var callback=this._callbacks[ix];callback.timePassed+=deltaTime,callback.timePassed>=callback.targetTime&&(callback.obj[callback.func](),this._callbacks.splice(ix,1),ix--)}this._lastTime=currentTime;var _this=this;this._scheduler=setTimeout((function(){_this.startScheduler()}),Klang.core.Core.settings.timehandler_lookahead)}else this.stop()},TimeHandler.prototype.start=function(){this._started=!0,this._lastTime=Klang.context.currentTime,clearTimeout(this._scheduler),this.startScheduler()},TimeHandler.prototype.stop=function(){this._started=!1,clearTimeout(this._scheduler),this._scheduler=null},TimeHandler.prototype.registerMethodCallback=function(obj,func,targetTime){return this._callbacks.push({obj:obj,func:func,timePassed:0,targetTime:targetTime}),this._started||this.start(),this},TimeHandler.prototype.removeMethodCallback=function(obj,func){for(var ix=0,len=this._callbacks.length;ix<len;ix++){var callback=this._callbacks[ix];if(callback.obj==obj&&callback.func==func)return void this._callbacks.splice(ix,1)}return this},Klang.core.TimeHandler=TimeHandler})),Module((function(Klang){var Util;return function(Util){if(Util.setParam=function(param,value,when){param.setValueAtTime(value,when||Klang.context.currentTime)},Util.adjustParam=function(param,value,when){param.setValueAtTime(param.value+value,when||Klang.context.currentTime)},Util.curveParamLin=function(param,value,duration,when,startValue){when=when||Klang.context.currentTime;var startAt=param.value;void 0!==startValue&&"Firefox"==Klang.detector.browser.name&&(startAt=startValue),param.setValueAtTime(startAt,when),param.linearRampToValueAtTime(value,Klang.context.currentTime+duration)},Util.curveParamExp=function(param,value,duration,when,startValue){when=when||Klang.context.currentTime;var startAt=param.value;void 0!==startValue&&"Firefox"==Klang.detector.browser.name&&(startAt=startValue),param.setValueAtTime(0==startAt?Util.EXP_MIN_VALUE:startAt,when),param.exponentialRampToValueAtTime(value,Klang.context.currentTime+duration)},Util.curveParam=function(param,curve,duration,when){when=when||Klang.context.currentTime,param.setValueCurveAtTime(Util.CUSTOM_CURVES[curve],when,duration)},Util.CUSTOM_CURVES={},Util.createCurves=function(data){for(var name in data){var cdata=data[name];if(cdata instanceof Array)for(var curve=new Float32Array(cdata.length),ix=0,len=cdata.length;ix<len;ix++)curve[ix]=cdata[ix];else{cdata.curve_type||Klang.warn("Modulation: Curve type not specified"),cdata.resolution||(cdata.resolution=1024),cdata.amplitude||(cdata.amplitude=1),cdata.amplitude_offset||(cdata.amplitude_offset=0),cdata.phase_offset||(cdata.phase_offset=0),cdata.length||(cdata.length=1);curve=new Float32Array(cdata.resolution);if("sine"==cdata.curve_type){var phase_offset=cdata.phase_offset*Math.PI*2,length=cdata.length*Math.PI*2;for(ix=0,len=curve.length;ix<len;ix++)curve[ix]=cdata.amplitude_offset+Math.sin(phase_offset+ix/len*length)*cdata.amplitude}else if("saw"==cdata.curve_type)for(ix=0,len=curve.length;ix<len;ix++)curve[ix]=cdata.amplitude_offset+(len-ix)/len*cdata.amplitude;else if("inverse-saw"==cdata.curve_type)for(ix=0,len=curve.length;ix<len;ix++)curve[ix]=cdata.amplitude_offset+ix/len*cdata.amplitude;else Klang.warn("Modulation: Unrecognized curve type");Util.CUSTOM_CURVES[name]=curve}}},-1!=navigator.userAgent.indexOf("MSIE")){var ieVersion,ua=navigator.userAgent;null!=new RegExp("MSIE ([0-9]{1,}[.0-9]{0,})").exec(ua)&&(ieVersion=parseInt(RegExp.$1)),ieVersion<9&&(Object.defineProperty=Object.oldDefineProperty,delete Object.oldDefineProperty)}Util.ROOT12=1.059463094359295,Util.NYQUIST_FREQUENCY=22050,Util.PITCH_SHIFT_FFT=2048,Util.EXP_MIN_VALUE=1e-4,Util.OSC_START_DELAY=.005,Util.LOG_TIME_COLOR="#999999",Util.LOG_EVENT_COLOR="#54CBDD",Util.LOG_UNIMPLEMENTED_EVENT_COLOR="#E075A9",Util.LOG_LOAD_COLOR="#333333",Util.LOG_WARN_COLOR="DarkOrange",Util.LOG_ERROR_COLOR="Red",Util.lastEvent=void 0,Util.clamp=function(value,min,max){return Math.max(min,Math.min(max,value))},Util.clamp01=function(value){return Util.clamp(value,0,1)},Util.vars={},Util.random=function(max,min){return Math.floor(min+(1+max-min)*Math.random())},Util.randomFloat=function(max,min){return min+(max-min)*Math.random()},Util.loadScriptFile=function(url,success,fail){var script=document.createElement("script");script.async=!0,script.onload=function(){success&&success(),script.onload=null},script.onerror=function(e){fail&&fail(e),script.onerror=null},script.src=url,document.getElementsByTagName("head")[0].appendChild(script)},Util.ease=function(current,delta,ease){return void 0===ease&&(ease=3),current-(current-delta)/ease},Util.now=function(){return"webaudio"==Klang.engineVersion?Klang.context.currentTime:0},Util.downSample=function(buffer,sampleRate){for(var ratio=sampleRate/Klang.context.sampleRate,stepLen=Math.floor(1/ratio),newLen=Math.floor(buffer.length*ratio),newSampleRate=Math.floor(Klang.context.sampleRate*ratio),downSampleBuff=Klang.context.createBuffer(buffer.numberOfChannels,newLen,newSampleRate),c=0;c<buffer.numberOfChannels;c++)for(var buffDataIn=buffer.getChannelData(c),buffDataOut=downSampleBuff.getChannelData(c),j=0,i=0;i<buffDataIn.length;i+=stepLen){var acc=0;for(j=0;j<stepLen;j++)acc+=buffDataIn[i+j];buffDataOut[i/stepLen]=acc/stepLen}return downSampleBuff},Util.semitonesToPlaybackRate=function(semitones){var semitoneRatio=Math.pow(2,1/12);return Math.pow(semitoneRatio,semitones)},Util.midiNoteToFrequency=function(note){return 440*Math.pow(2,(note-69)/12)},Util.frequencyToMidiNote=function(freq){return 69+12*Math.log(freq/440)/Math.log(2)},Util.safeFilterType=function(filterType){return void 0===filterType?"lowpass":filterType},Util.checkMobile=function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},Util.checkIOS=function(){return/(iPad|iPhone|iPod)/g.test(navigator.userAgent)},Util.setBlurFadeOut=function(state){Klang.core.Core.instance.blurFadeOut=state},Util.getParameterByName=function(name){name=name.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var results=new RegExp("[\\?&]"+name+"=([^&#]*)").exec(location.search);return null==results?"":decodeURIComponent(results[1].replace(/\+/g," "))},Util.transition=function(from,to,bpm,sync,fadeOutTime,fadeInTime,useOffset,fadeOutImmediately,setOffset){var i=0,toStop=(bpm=bpm||120,fadeOutTime=fadeOutTime||2,[]);if(!to)return Util.now();if(from&&!Array.isArray(from)&&(from=[from]),from){var playingLoop;for(i=0;i<from.length;i++)(from[i].playing||from[i].scheduledToPlay())&&(playingLoop=playingLoop&&playingLoop.scheduledToPlay()&&from[i].playing?from[i]:playingLoop||from[i],from[i]._stopping||from[i]===to||toStop.push(from[i]));from=playingLoop}if(from===to&&!from._stopping)return Util.now();if(!from)return to.play(Util.now(),0,!1),Util.now();var bps=60/bpm,spb=bpm/60,p1=from?from.position:0,toNextBar=(sync=sync||4)-(p1=p1||0)*spb%sync;for(toNextBar<.5&&(toNextBar+=sync);fadeOutImmediately&&toNextBar<fadeOutTime*spb;)toNextBar+=sync;var toNextBarSec=toNextBar*bps;from.playing||(toNextBarSec=0);var scheduleTime=Util.now()+toNextBarSec,offset=0;useOffset&&(offset=from.position+toNextBarSec),setOffset&&(offset=setOffset),fadeInTime?to.fadeInAndPlay(fadeInTime,scheduleTime,offset):to.play(scheduleTime,offset,!1);var fadeOutStartTime=fadeOutImmediately?scheduleTime-fadeOutTime:scheduleTime;for(fadeOutImmediately&&fadeOutStartTime<Klang.context.currentTime&&(fadeOutTime=scheduleTime-Klang.context.currentTime),i=0;i<toStop.length;i++)toStop[i].fadeOutAndStop(fadeOutTime,fadeOutStartTime);return scheduleTime},Util.getTimeToBeat=function(from,bpm,sync,offset){if(bpm=bpm||120,from=from,offset=offset||0,Array.isArray(from)){for(var playingLoop,i=0;i<from.length;i++)if(from[i].playing){playingLoop=from[i];break}from=playingLoop}if(from){var bps=60/bpm,spb=bpm/60,p1=from.position;p1=p1||0,from._loopStart>0&&(p1<from._loopStart?p1=0:p1-=from._loopStart);var toNextBar=(sync=sync||4)-p1*spb%sync,toNextBarSec=(toNextBar+=offset)*bps;return from.playing||(toNextBarSec=0),toNextBarSec}},Util.stopPlayingExcept=function(){for(var exceptions=[],_i=0;_i<arguments.length-0;_i++)exceptions[_i]=arguments[_i+0];for(var sequencerArgs=[{beat:0,fadeOut:2}],ix=exceptions.length-1;ix>=0;ix--){"Pattern"==Klang.core.Core.instance.findInstance(exceptions[ix]).type&&sequencerArgs.push(exceptions[ix])}var objects=Klang.core.Core.instance._objectTable;for(var o in Klang.core.Core.instance._objectTable){var obj=objects[o];"AudioSource"==obj._type&&-1==exceptions.indexOf(o)?obj.loop&&obj.playing&&obj.fadeOutAndStop(1):"Sequencer"==obj._type?obj.stopAll.apply(obj,sequencerArgs):"AdvancedProcess"==obj._type&&obj.started&&-1==exceptions.indexOf(o)&&obj.stop()}},Util.shuffle=function(array){for(var temp,index,counter=array.length;counter--;)index=Math.random()*counter|0,temp=array[counter],array[counter]=array[index],array[index]=temp;return array},Util.cloneObject=function cloneObject(obj){if(null===obj||"object"!=typeof obj)return obj;var temp=obj.constructor();for(var key in obj)temp[key]=cloneObject(obj[key]);return temp},Util.logFreq=function(value){if(0==value)return 0;var min=20;0==min&&(min=.01);var position=value,minp=min,minv=Math.log(minp),scale=(Math.log(2e4)-minv)/(2e4-minp);return Math.exp(minv+scale*(position-minp))},Util.generateIdString=function(len){for(var seed="";seed.length<len;)seed+="0";return(seed+(Math.random()*Math.pow(36,len)<<0).toString(36)).slice(-len)},Util.MidiHandler={midiAccess:null,midiIn:null,midiOut:null,inputs:[],outputs:[],init:function(done){this.MIDIUtils.initUtils();var _this=this;window.navigator.requestMIDIAccess().then((function(e){_this.onMIDIStarted(e),done&&done()}),this.onMIDISystemError)},onMIDISystemError:function(msg){},onMIDIStarted:function(midi){Util.MidiHandler.midiAccess=midi,midi.inputs.forEach((function(port){Util.MidiHandler.inputs.push(port)})),midi.outputs.forEach((function(port){Util.MidiHandler.outputs.push(port)})),Util.MidiHandler.inputs.length&&(Util.MidiHandler.midiIn=Util.MidiHandler.inputs[0],Util.MidiHandler.midiIn.onmidimessage=Util.MidiHandler.midiMessageReceived,Util.MidiHandler.midiOut=Util.MidiHandler.outputs[0])},midiMessageReceived:function(ev){var a=ev.data[0],cmd=ev.data[0]>>4,channel=15&ev.data[0],noteNumber=ev.data[1],velocity=ev.data[2];Util.MidiHandler.handleMidiData(a,cmd,channel,noteNumber,velocity)},handleMidiData:function(a,cmd,channel,noteNumber,velocity){},changeMidi:function(index){this.midiOut=this.outputs[index],this.midiIn=this.inputs[index]},MIDIUtils:{noteMap:{},noteNumberMap:[],notes:["C","C#","D","D#","E","F","F#","G","G#","A","A#","B"],initUtils:function(argument){for(var i=0;i<127;i++){var index=i,key=this.notes[index%12],octave=(index/12|0)-1;1===key.length&&(key+="-"),key+=octave,this.noteMap[key]=i,this.noteNumberMap[i]=key}},getBaseLog:function(value,base){return Math.log(value)/Math.log(base)},noteNameToNoteNumber:function(name){return this.noteMap[name]},noteNumberToFrequency:function(note){return 440*Math.pow(2,(note-69)/12)},noteNumberToName:function(note){return this.noteNumberMap[note]},frequencyToNoteNumber:function(f){return Math.round(12*this.getBaseLog(f/440,2)+69)}},play:function(note,noteLength,velocity){void 0===velocity&&(velocity=100),this.midiOut.send([144,note,velocity]),this.midiOut.send([128,note,0],window.performance.now()+noteLength)},panic:function(){for(var i=1;i<128;++i)this.midiOut.send([128,i,0])}}}(Util||(Util={})),Util.__extends=function(d,b){function __(){this.constructor=d}__.prototype=b.prototype,d.prototype=new __},Klang.Util=Util})),Module((function(Klang){function EventEmitter(){}return EventEmitter.prototype.on=function(name,callback,context){return this._events=this._events||{},(this._events[name]||(this._events[name]=[])).push({callback:callback,ctxArg:context,context:context||this}),this},EventEmitter.prototype.off=function(name,callback,context){var i,len,listener,retain;if(!this._events||!this._events[name])return this;name||callback||context||(this._events={});var eventListeners=this._events[name];if(eventListeners){if(retain=[],callback&&context)for(i=0,len=eventListeners.length;i<len;i++)callback!==(listener=eventListeners[i]).callback&&context!==listener.ctxArg&&retain.push(eventListeners[i]);else if(callback)for(i=0,len=eventListeners.length;i<len;i++)callback!==(listener=eventListeners[i]).callback&&retain.push(eventListeners[i]);else if(context)for(i=0,len=eventListeners.length;i<len;i++)context!==(listener=eventListeners[i]).ctxArg&&retain.push(eventListeners[i]);this._events[name]=retain}return this._events[name].length||delete this._events[name],this},EventEmitter.prototype.trigger=function(name){for(var i,binding,listeners,args=[],_i=0;_i<arguments.length-1;_i++)args[_i]=arguments[_i+1];if(!this._events||!this._events[name])return this;for(listeners=this._events[name],args=[].splice.call(arguments,1),i=listeners.length-1;i>=0;i--)(binding=listeners[i]).callback.apply(binding.context,args);return this},Klang.core.internalEventBus=new EventEmitter,Klang.core.EventEmitter=EventEmitter})),Module((function(Klang){function Core(){this._initComplete=!1,this._blurFadeOut=!1,this._masterBusId=null,this._preLoadInitStack=[],this._postLoadInitStack=[],this._connectStack=[],this._superMasterOutput=Klang.context?Klang.context.createGain():null,this.scheduler=new Klang.core.Scheduler,Klang.Util.getParameterByName("klang_log")&&(Klang.loggingEnabled=!0)}return Core.debugSettings={},Core.inst=null,Core.isInited=function(){return null!=Core.inst&&Core.inst._initComplete},Object.defineProperty(Core.prototype,"initComplete",{get:function(){return this._initComplete},enumerable:!0,configurable:!0}),Object.defineProperty(Core,"instance",{get:function(){return null==Core.inst&&(Core.inst=new Core),Core.inst},enumerable:!0,configurable:!0}),Core.prototype.setCallbacks=function(callbacks){this._callbacks=callbacks},Object.defineProperty(Core,"callbacks",{get:function(){return Core.instance._callbacks},enumerable:!0,configurable:!0}),Core.deinit=function(){Core.inst=null},Core.prototype.stopAll=function(){for(var p in window.KlangVisual&&KlangVisual.stop(),this._objectTable)if(this._objectTable[p].stop)try{this._objectTable[p].stop()}catch(ex){}},Core.prototype.getPlaying=function(){var playing=[];for(var p in this._objectTable){var obj=this._objectTable[p];obj instanceof Klang.Model.AudioSource&&obj.playing?playing.push(obj):obj instanceof Klang.Model.AudioGroup&&obj.playing&&obj.latestPlayed&&playing.push(obj.latestPlayed)}return playing},Core.prototype.loadJSON=function(options,readyCallback,progressCallback,url){if(this._readyCallback=readyCallback,this._progressCallback=progressCallback||function(){},"object"==typeof options){Klang.log("Loading config (editor)");var data=this.createConfigNode(options);Core.settings=data.settings,Core.instance.initContent(data,null,url),window.KlangVisual&&KlangVisual.init(options)}else{if("string"!=typeof options)throw"Klang exception: unrecognized options: '"+options+"'";Klang.log("Loading config (client)");var request=new XMLHttpRequest;request.open("GET",options,!0);var _this=this;request.onreadystatechange=function(){if(4==request.readyState&&200==request.status){var configText=request.responseText,data=_this.parseConfigJSON(configText);Core.settings=data.settings,Core.instance.initContent(data,null,options),window.KlangVisual&&KlangVisual.init(JSON.parse(configText))}else{if(404==request.status)throw"Klang exception: config file not found: '"+options+"'";if(200!=request.status)throw"Klang exception: unable to load config file: '"+options+"'"}},request.send(null)}},Core.prototype.parseConfigJSON=function(jsonString){if("string"==typeof jsonString)return JSON.parse(jsonString,(function(key,value){return value&&"object"==typeof value&&"string"==typeof value.type?Klang.Model[value.type]?new Klang.Model[value.type](value,key):(Klang.warn("Core: Type not found: "+value.type),null):value}));for(var key in Object.keys(jsonString)){var value=jsonString[key];return Klang.Model[value.type]?new Klang.Model[value.type](value,key):(Klang.warn("Core: Type not found: "+value.type),null)}},Core.prototype.createConfigNode=function(node){if("object"==typeof node)for(var key in node){var prop=node[key];if("object"==typeof prop&&"string"==typeof prop.type){if(Klang.Model[prop.type]||Klang.warn("Core: Type not found: "+prop.type),"channel"==prop.type)continue;node[key]=this.createConfigNode(prop),node[key]=new Klang.Model[prop.type](prop,key)}else node[key]=this.createConfigNode(prop)}return node},Core.prototype.createObject=function(name,data,options){if(options||(options={}),Klang.Model[data.type]){!options.excludeFromTable&&this._objectTable[name]&&Klang.warn("Core: Duplicate object: "+name);var obj=new Klang.Model[data.type](data,name);if(options.excludeFromTable||(this._objectTable[name]=obj),!options.noInit&&obj.init&&obj.init(),!options.noConnect&&obj.destinationName&&obj.connect)if("$OUT"==obj.destinationName)obj.connect(this._superMasterOutput);else{var destination=this.findInstance(obj.destinationName);destination||Klang.warn("Core: Destination not found: "+obj.destinationName),"Bus"!=destination._type&&Klang.warn("Core: Destination is not a bus: "+obj.destinationName),obj.connect(destination.input)}return obj}Klang.warn("Core: Type not found: "+data.type)},Core.prototype.updateObject=function(object,data){var obj="string"==typeof object?this._objectTable[object]:object;if("SimpleProcess"==obj._type&&"AdvancedProcess"==data.type){var advancedProcess=newAdvancedProcess(data,object);advancedProcess.init(),this._objectTable[object]=advancedProcess}else if("AdvancedProcess"==obj._type&&"SimpleProcess"==data.type){var simpleProcess=newSimpleProcess(data,object);simpleProcess.init(),this._objectTable[object]=simpleProcess}else obj.setData&&obj.setData(data)},Core.prototype.createEvent=function(name,target){this._eventTable[name]&&Klang.warn("Core: Duplicate event: "+name),this._eventTable[name]=target},Core.prototype.visChange=function(fadeTime){this.isHidden()?this._blurFadeOut&&Klang.Util.curveParamLin(this._superMasterOutput.gain,0,fadeTime):Klang.Util.curveParamLin(this._superMasterOutput.gain,1,fadeTime)},Core.prototype.initContent=function(data,files,url){var baseURL,relativePath=data.settings.relative_path,filePath=data.settings.file_path||"";relativePath&&-1!=url.lastIndexOf("/")?("/"!==(baseURL=url.substring(0,url.lastIndexOf("/"))).charAt(baseURL.length-1)&&(baseURL+="/"),baseURL+=filePath):baseURL=filePath,Klang.log("Initializing core");Klang.context.currentTime;if(-1!=data.settings.blur_fade_time){this._blurFadeOut=!0;var fadeTime=data.settings.blur_fade_time||.5;fadeTime<0&&-1!=fadeTime&&Klang.warn("Core: Invalid blur_fade_time value. Must be -1 or >= 0.");var _this=this;if(this.getHiddenProp()){document.addEventListener("visibilitychange",(function(){_this.visChange(fadeTime)}))}}for(var p in this.maxSimultaneousSounds=data.settings.max_simultaneous_sounds,Klang.core.FileHandler.instance.fileInfo=(null!=files?files:data.files)||[],this._eventTable=data.events||{},this._objectTable={},data.audio)this._objectTable[p]=data.audio[p];for(var p in data.busses)this._objectTable[p]=data.busses[p];for(var p in data.sequencers)this._objectTable[p]=data.sequencers[p];for(var p in data.processes)this._objectTable[p]=data.processes[p];for(var p in data.synths)this._objectTable[p]=data.synths[p];for(var p in data.lfos)this._objectTable[p]=data.lfos[p];for(var p in data.automations)this._objectTable[p]=data.automations[p];for(var p in data.data)this._objectTable[p]=data.data[p];this.setVars(data.vars),this._masterBusId=data.masterBus,this._exportedSymbols=data.exportedSymbols||{},this._logIgnore=data.debug.log_ignore||data.log_ignore||{},Klang.Util.createCurves(data.curves),this._loadStartTimestamp=(new Date).getTime(),data.debug&&(Klang.debugData.ignoredEvents=data.debug.ignored_events||Klang.debugData.ignoredEvents,Klang.debugData.logToConsole=data.debug.log_to_console||Klang.debugData.logToConsole),Klang.log("Pre load initialization started");for(var ix=0,len=this._preLoadInitStack.length;ix<len;ix++){(element=this._preLoadInitStack[ix]).init&&element.init()}Klang.log("Pre load initialization finished"),Klang.log("Connecting nodes"),this._superMasterOutput.connect(Klang.context.destination);for(ix=0,len=this._connectStack.length;ix<len;ix++){var element;switch((element=this._connectStack[ix]).destinationName){case"$OUT":element.connect(this._superMasterOutput);break;case"$PARENT":break;default:var destination=this.findInstance(element.destinationName);destination||Klang.warn("Core: Destination not found: "+element.destinationName),"Bus"!=destination._type&&Klang.warn("Core: Destination is not a bus: "+element.destinationName),element.connect(destination.input)}}Klang.log("Nodes connected"),this._preLoadInitStack=null,this._connectStack=null,this._timeHandler=new Klang.core.TimeHandler,this._initComplete=!0,Klang.log("Core initialized"),Klang.core.FileHandler.instance.baseURL=baseURL,!Klang.initOptions||Klang.initOptions&&!Klang.initOptions.noAutoLoad?Klang.core.FileHandler.instance.loadFiles("auto",Core.soundsLoaded,this._progressCallback):setTimeout(Core.soundsLoaded,4)},Core.prototype.isHidden=function(){var prop=this.getHiddenProp();return!!prop&&document[prop]},Core.prototype.getHiddenProp=function(){var prefixes=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var i=0;i<prefixes.length;i++)if(prefixes[i]+"Hidden"in document)return prefixes[i]+"Hidden";return null},Core.prototype.setVars=function(vars){if(vars){for(var key in vars)if("string"==typeof vars[key]&&vars[key].indexOf("me.")>-1)vars[key]=this.findInstance(vars[key].split("me.")[1]);else if("object"==typeof vars[key]){var obj=vars[key];for(var prop in obj)obj.hasOwnProperty(prop)&&"string"==typeof obj[prop]&&obj[prop].indexOf("me.")>-1&&(obj[prop]=this.findInstance(obj[prop].split("me.")[1]))}Klang.Util.vars=vars}},Core.prototype.loadSoundFiles=function(name,callback,progressCallback,loadFailedCallback){var start=(new Date).getTime();progressCallback&&(this._progressCallback=progressCallback);var _this=this;Klang.core.FileHandler.instance.loadFiles(name,(function(success,loadedFiles){for(var i=0;i<loadedFiles.length;i++){var fileId=loadedFiles[i].id;for(var j in _this._objectTable)if(_this._objectTable.hasOwnProperty(j)){var obj=_this._objectTable[j];"AudioSource"===obj._type&&obj._fileId===fileId&&obj.init()}}var time=(new Date).getTime()-start;Klang.log("Execution time for loadgroup: "+time),callback&&callback(!0)}),this._progressCallback,loadFailedCallback)},Core.prototype.freeSoundFiles=function(name){var loadGroups=Klang.core.FileHandler.instance.getLoadGroups();"string"==typeof name&&(name=[name]);for(var i=0;i<name.length;i++){var isLoadGroup=!1;for(var p in loadGroups.includes(name[i])&&(Klang.core.FileHandler.instance.freeSoundFiles(name[i]),isLoadGroup=!0,Klang.log("freeing loadgroup!",name[i])),this._objectTable){var obj=this._objectTable[p];if("AudioSource"==obj._type){var fileInfo=Klang.core.FileHandler.instance.getFileInfo(obj._fileId);isLoadGroup?fileInfo&&fileInfo.load_group==name[i]&&obj.freeBuffer():obj.editorName===name[i]&&(Klang.core.FileHandler.instance.freeSoundFile(obj._fileId),obj.freeBuffer(),Klang.log("freeing buffer!",name[i]))}}}},Core.soundsLoaded=function(){Klang.log("Post load initialization started");for(var _this=Core.instance,i=0,len=_this._postLoadInitStack.length;i<len;i++)_this._postLoadInitStack[i].init();Klang.log("Post load initialization finished"),_this._postLoadInitStack=null,_this._readyCallback&&_this._readyCallback(!0)},Core.prototype.pushToPreLoadInitStack=function(instance){return!!this._preLoadInitStack&&(this._preLoadInitStack.push(instance),!0)},Core.prototype.pushToPostLoadInitStack=function(instance){return!!this._postLoadInitStack&&(this._postLoadInitStack.push(instance),!0)},Core.prototype.pushToConnectStack=function(instance){return!!this._connectStack&&(this._connectStack.push(instance),!0)},Core.prototype.findInstance=function(name){var instance=this._objectTable[name];return instance||Klang.warn("Core: Unknown reference: '"+name+"'"),instance},Core.prototype.triggerEvent=function(id){for(var eventArgs=[],_i=0;_i<arguments.length-1;_i++)eventArgs[_i]=arguments[_i+1];if(Klang.Util.lastEvent=id,!Klang.debugData.ignoredEvents[id])if(this._eventTable){this._eventTable[id]?Klang.debugData.logToConsole&&!this._logIgnore[id]&&Klang.logc("Klang Core: Incoming sound event: '"+id+"', "+eventArgs,Klang.Util.LOG_EVENT_COLOR):Klang.debugData.logToConsole&&!this._logIgnore[id]&&Klang.logc("Klang Core: Incoming sound event: '"+id+"', "+eventArgs,Klang.Util.LOG_UNIMPLEMENTED_EVENT_COLOR);var process=this._eventTable[id];if("string"==typeof process)this._objectTable[process]||Klang.warn("Core: Unknown process: '"+process+"'"),"SimpleProcess"!=this._objectTable[process]._type&&"AdvancedProcess"!=this._objectTable[process]._type&&Klang.warn("Core: Object is not a process: '"+process+"'"),this._objectTable[process].start(eventArgs[0]);else if(process instanceof Array)for(var ix=0,len=process.length;ix<len;ix++)this._objectTable[process[ix]]||Klang.warn("Core: Unknown process: '"+process[ix]+"'"),"SimpleProcess"!=this._objectTable[process[ix]]._type&&"AdvancedProcess"!=this._objectTable[process[ix]]._type&&Klang.warn("Core: Object is not a process: '"+process+"'"),this._objectTable[process[ix]].start(eventArgs[0])}else Klang.logc("Klang Core: eventTable is undefined")},Core.prototype.getSymbolId=function(symbol){return this._exportedSymbols[symbol]},Core.prototype.resumeAudio=function(){Klang.context.createBufferSource().start(0),Klang.core.internalEventBus.trigger("INIT_IOS"),Klang.context.resume()},Object.defineProperty(Core.prototype,"timeHandler",{get:function(){return this._timeHandler},enumerable:!0,configurable:!0}),Object.defineProperty(Core.prototype,"output",{get:function(){return this._superMasterOutput},enumerable:!0,configurable:!0}),Object.defineProperty(Core.prototype,"blurFadeOut",{get:function(){return this._blurFadeOut},set:function(state){this._blurFadeOut=state},enumerable:!0,configurable:!0}),Klang.core.Core=Core})),Module((function(Klang){var _eventQue;function processEventQue(){if(_eventQue){for(var i in _eventQue)_eventQue.hasOwnProperty(i)&&Klang.triggerEvent.apply(Klang,_eventQue[i]);_eventQue=null}}Klang.READY_STATE_NOT_INITIATED=0,Klang.READY_STATE_INITIATED=1,Klang.READY_STATE_LOADED=2,Klang.klangInited=!1,Klang.readyState=Klang.READY_STATE_NOT_INITIATED,Klang.pushToEventQue=function(name){(_eventQue=_eventQue||{})[name]=arguments},Klang.triggerEvent=Klang.trigger=function(name){for(var args=[],_i=0;_i<arguments.length-1;_i++)args[_i]=arguments[_i+1];if(Klang.core.Core.isInited)if("webaudio"===Klang.engineVersion){if(!Klang.context)return;Klang.core.Core.instance.triggerEvent(name,args)}else"audiotag"===Klang.engineVersion&&Klang.audioTagHandler&&Klang.audioTagHandler.triggerEvent(name,args)},Klang.getDestinationForEvent=function(eventName){var process=Klang.core.Core.instance.findInstance(Klang.getEvents()[eventName]);return process?process.destination():null},Klang.init=function(json,readyCallback,progressCallback,loadFailedCallback,options){var start=(new Date).getTime();if(Klang.initOptions=options=options||{},Klang.isMobile=Klang.Util.checkMobile(),Klang.isIOS=Klang.Util.checkIOS(),options.useMonoBuffers&&(Klang.useMonoBuffers=options.useMonoBuffers),"object"==typeof json&&json.settings&&json.settings.force_logging&&(Klang.loggingEnabled=!0),!Klang.klangInited){Klang.klangInited=!0,Klang.readyState=Klang.READY_STATE_NOT_INITIATED;var doWebaudio="webaudio"===options.forceMode||!options.forceMode&&void 0!==window.AudioContext;"audiotag"===options.forceMode||!options.forceMode&&window.AudioContext;if(!doWebaudio){if(Klang.engineVersion="audiotag","string"==typeof json&&-1===json.indexOf(".json")&&json.indexOf(".js")>1){var oldKLANG_CONFIG=window.KLANGCONFIG;Klang.Util.loadScriptFile(json,(function(){var config=window.KLANG_CONFIG;window.KLANG_CONFIG=oldKLANG_CONFIG,Klang.audioTagHandler=new Klang.AudioTagHandler(config,(function(success){Klang.readyState=Klang.READY_STATE_LOADED,readyCallback&&readyCallback(success),processEventQue()}),progressCallback,json)}),(function(){}))}else Klang.audioTagHandler=new Klang.AudioTagHandler(json,(function(success){Klang.readyState=Klang.READY_STATE_LOADED,readyCallback&&readyCallback(success);var time=(new Date).getTime()-start;Klang.log("Execution time: "+time),processEventQue()}),progressCallback,json);return!0}if(Klang.context||(Klang.context=Klang.engines.webAudio.Util.createAudioContext()),Klang.engineVersion="webaudio",Klang.core.Core.isInited()&&Klang.warn("Klang already initialized"),"string"==typeof json&&-1===json.indexOf(".json")&&json.indexOf(".js")>1){oldKLANG_CONFIG=window.KLANG_CONFIG;Klang.Util.loadScriptFile(json,(function(){var config=window.KLANG_CONFIG;window.KLANG_CONFIG=oldKLANG_CONFIG,Klang.core.Core.instance.loadJSON(config,(function(success){Klang.readyState=Klang.READY_STATE_LOADED,readyCallback&&readyCallback(success),processEventQue()}),progressCallback,json)}),(function(){}))}else Klang.core.Core.instance.loadJSON(json,(function(success){Klang.readyState=Klang.READY_STATE_LOADED,readyCallback&&readyCallback(success),processEventQue();var time=(new Date).getTime()-start;Klang.log("Execution time: "+time)}),progressCallback,json);return!0}Klang.warn("Klang already initialized")},Klang.resumeAudio=function(debugButton){"webaudio"==Klang.engineVersion?Klang.core.Core.instance.resumeAudio():"audiotag"==Klang.engineVersion&&Klang.isMobile&&Klang.audioTagHandler.resumeAudio()},Klang.initIOS=Klang.resumeAudio,Klang.getLoadGroups=function(){var fileHandler,listOfGroups=[];if("webaudio"===Klang.engineVersion)fileHandler=Klang.core.FileHandler.instance;else{if("audiotag"!==Klang.engineVersion)return[];fileHandler=Klang.audioTagHandler}var autoIndex=(listOfGroups=fileHandler.getLoadGroups()).indexOf("auto");return-1!==autoIndex&&listOfGroups.splice(autoIndex,1),listOfGroups},Klang.getCoreInstance=function(){return Klang.core.Core.instance},Klang.getFileHandlerInstance=function(){return Klang.core.FileHandler.instance},Klang.getUtil=function(){return Klang.Util},Klang.getModel=function(){return Klang.Model},Klang.schedule=function(time,fn){return"webaudio"!==Klang.engineVersion?(Klang.err("Schedule only availible in WebAudio version"),this):("number"==typeof time&&"function"==typeof fn?Klang.core.Core.instance.scheduler.at(time,fn):Klang.err(".schedule requires arg0 - time in seconds and arg1 - a callback function"),this)},Klang.createObject=function(name,options){if(!Model[name])throw new Error("No such object");return new Model[name](options)},Klang.setDebugFlag=function(flagName,value){Klang.core.Core.debugSettings[flagName]=value},Klang.load=function(name,readyCallback,progressCallback,loadFailedCallback){Klang.logc("Klang: Loading: '"+name+"'",Klang.Util.LOG_LOAD_COLOR),"webaudio"==Klang.engineVersion?Klang.core.Core.instance.loadSoundFiles(name,readyCallback,progressCallback,loadFailedCallback):"audiotag"==Klang.engineVersion?Klang.audioTagHandler.loadSoundFiles(name,readyCallback,progressCallback,loadFailedCallback):(progressCallback&&progressCallback(1),readyCallback&&readyCallback(!1))},Klang.free=function(name){Klang.logc("Klang: Freeing: '"+name+"'",Klang.Util.LOG_LOAD_COLOR),"webaudio"==Klang.engineVersion?Klang.core.Core.instance.freeSoundFiles(name):Klang.engineVersion},Klang.getLoadProgress=function(){return FileHandler.instance.progress},Klang.stopAll=function(){"webaudio"==Klang.engineVersion?Klang.core.Core.isInited()&&Klang.core.Core.instance.stopAll():"audiotag"==Klang.engineVersion&&Klang.audioTagHandler.stopAll()},Klang.$=function(symbol,args){if("webaudio"==Klang.engineVersion){if(Klang.core.Core.isInited()){if(0===symbol.indexOf(".")){var type=symbol.substring(1),ret=[],entities=Klang.getCoreInstance()._objectTable;for(var i in entities)if(entities.hasOwnProperty(i)){var entity=entities[i];entity._type===type&&ret.push(entity)}return ret}var id=Klang.core.Core.instance.getSymbolId(symbol);return Klang.core.Core.instance.findInstance(id)}}else if("audiotag"==Klang.engineVersion){if(0===symbol.indexOf(".")){ret=[],type=symbol.substring(1);for(var k in Klang.audioTagHandler._audio){-1!==(obj=Klang.audioTagHandler._audio[k]).constructor.name.indexOf(type)&&ret.push(obj)}return ret}for(var k in Klang.audioTagHandler._audio){var obj;if((obj=Klang.audioTagHandler._audio[k])._data.editorName===symbol)return obj}}return null}})),Module((function(Klang){function zeropad(num,digits){for(var str=num.toString();str.length<digits;)str="0"+str;return str}Klang.log=function(){for(var args=[],_i=0;_i<arguments.length-0;_i++)args[_i]=arguments[_i+0];Klang.loggingEnabled&&("Chrome"==Klang.browser||console.log.apply(console,args))},Klang.logc=function(message,color){Klang.loggingEnabled&&"Chrome"==Klang.browser&&(color||(color="gray"))},Klang.warn=function(){for(var args=[],_i=0;_i<arguments.length-0;_i++)args[_i]=arguments[_i+0];Klang.loggingEnabled&&("Chrome"==Klang.browser||console.warn.apply(console,args))},Klang.err=function(){for(var args=[],_i=0;_i<arguments.length-0;_i++)args[_i]=arguments[_i+0];Klang.loggingEnabled&&("Chrome"==Klang.browser||console.warn.apply(console,args))},Klang.zeropad=zeropad,Klang.getTimeStamp=function(time){return zeropad(time.getUTCMinutes(),2)+":"+zeropad(time.getUTCSeconds(),2)+"."+zeropad(time.getUTCMilliseconds(),3)},Klang.getTimeString=function(t){void 0===t&&(t=Klang.context.currentTime);var ms=Math.round(1e3*t),s=Math.floor(ms/1e3%60),m=Math.floor(ms/6e4%60);return zeropad(Math.floor(ms/36e5%24),2)+":"+zeropad(m,2)+":"+zeropad(s,2)+"."+zeropad(ms%1e3,3)},Klang.getEvents=function(){return"flash"===Klang.engineVersion?null:"audiotag"==Klang.engineVersion?Klang.audioTagHandler._events:Klang.core.Core.instance._eventTable},Klang.debugData={ignoredEvents:{},logToConsole:!0},Klang.visualWindow,Klang.setCallbacks=function(callbacks){Klang.core.Core.instance.setCallbacks(callbacks)},Klang.schedulePredefinedEvents=function(events){var nextEventIx=0,eventInterval=setInterval((function(){for(var now=Klang.context.currentTime,e=events[nextEventIx];e.time<now;){if(triggerEvent(e.name,e.args),++nextEventIx==events.length){clearInterval(eventInterval);break}e=events[nextEventIx]}}),10)},Klang.deinit=function(url,readyCallback){Klang.klangInited=!1,"webaudio"==Klang.engineVersion?Klang.core.Core.isInited()&&(Klang.core.Core.instance.stopAll(),Klang.core.Core.deinit()):"audiotag"==Klang.engineVersion&&Klang.audioTagHandler.stopAll(),Klang.engineVersion="n/a"}})),Module((function(Klang){function SyncCountdown(targetStep,process,args){this._currentStep=0,this._targetStep=targetStep,this._process=process,this._args=args}return SyncCountdown.prototype.advance=function(step){this._currentStep+=step},SyncCountdown.prototype.performAction=function(){"string"==typeof this._process?new Function("Core","Model","Util","args",this._process)(Klang.core.Core,Klang.Model,Klang.Util,this._args):this._process.start(this._args)},Object.defineProperty(SyncCountdown.prototype,"finished",{get:function(){return this._currentStep>=this._targetStep},enumerable:!0,configurable:!0}),Klang.core.SyncCountdown=SyncCountdown})),Module((function(Klang){function SyncHandler(){this._timers=[]}return SyncHandler.prototype.addSyncCountdown=function(countdown){this._timers.push(countdown)},SyncHandler.prototype.update=function(step){for(var ix=0;ix<this._timers.length;ix++){var countdown=this._timers[ix];countdown.advance(step),countdown.finished&&(countdown.performAction(),this._timers.splice(ix,1),ix--)}},Klang.core.SyncHandler=SyncHandler})),Module((function(){})),Module((function(Klang){function Audio(data,name){this.data=data,this._name=name,this._type=data.type,this._output=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._volume=void 0!==data.volume?data.volume:1,this._output.gain.setValueAtTime(this._volume,Klang.context.currentTime),data.destination_name&&(this.destinationName=data.destination_name,Klang.core.Core.instance.initComplete||Klang.core.Core.instance.pushToConnectStack(this))}return Audio.prototype.connect=function(destination){return Klang.warn("Audio: Invocation of abstract method: Audio.connect in",this),this},Audio.prototype.disconnect=function(){return Klang.warn("Audio: Invocation of abstract method: Audio.disconnect in",this),this},Audio.prototype.play=function(when,offset){return Klang.warn("Audio: Invocation of abstract method: Audio.play in",this),this},Audio.prototype.stop=function(when){return Klang.warn("Audio: Invocation of abstract method: Audio.stop in",this),this},Audio.prototype.pause=function(){return Klang.warn("Audio: Invocation of abstract method: Audio.pause in",this),this},Audio.prototype.unpause=function(){return Klang.warn("Audio: Invocation of abstract method: Audio.unpause in",this),this},Audio.prototype.curvePlaybackRate=function(value,duration){return Klang.warn("Audio: Invocation of abstract method: Audio.curvePlaybackRate in",this),this},Audio.prototype.fadeInAndPlay=function(duration,when){return this},Audio.prototype.fadeOutAndStop=function(duration,when){return this},Audio.prototype.deschedule=function(){return this},Object.defineProperty(Audio.prototype,"playbackRate",{set:function(value){return Klang.warn("Audio: Invocation of abstract property: Audio.playbackRate in",this),this},enumerable:!0,configurable:!0}),Object.defineProperty(Audio.prototype,"playing",{get:function(){return Klang.warn("Audio: Invocation of abstract property: Audio.playing in",this),!1},enumerable:!0,configurable:!0}),Object.defineProperty(Audio.prototype,"duration",{get:function(){return Klang.warn("Audio: Invocation of abstract property: Audio.duration in",this),0},enumerable:!0,configurable:!0}),Object.defineProperty(Audio.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0}),Object.defineProperty(Audio.prototype,"playbackState",{get:function(){return Klang.warn("Audio: Invocation of abstract property: Audio.playbackState in",this),0},enumerable:!0,configurable:!0}),Audio.prototype.setData=function(data){this._volume=void 0===data.volume?1:data.volume,this._output.gain.value=this._volume,this.destinationName!=data.destination_name&&(this.destinationName=data.destination_name,this.disconnect(),this.connect(Klang.core.Core.instance.findInstance(this.destinationName).input))},Audio.prototype.clone=function(){var clone=new this.constructor(this.data,this._name);return this.data.panner&&(this.data.panner=new Klang.Model.Panner(this.data.panner.data)),clone.connect(Klang.core.Core.instance.findInstance(this.destinationName).input),clone},Klang.Model.Audio=Audio})),Module((function(Klang){Klang.engines=Klang.engines||{},Klang.engines.webAudio={}})),Module((function(Klang){Klang.audioUtils=Klang.engines.webAudio.audioUtils={crossfade:function(buf,loopStart,loopEnd,length,type){var funA,funB;if(void 0===type&&(type="equalpower"),"linear"==type)funA=function(x){return 1-x},funB=function(x){return x};else{if("equalpower"!=type)return;funA=function(x){return Math.pow(1-x,.5)},funB=function(x){return Math.pow(x,.5)}}loopEnd=Math.min(loopEnd,buf.length),length=Math.min(length,loopStart);for(var c=0;c<buf.numberOfChannels;c++){for(var data=buf.getChannelData(c),a=loopEnd-1,b=loopStart-1,i=length-1;i>=0;i--){var ratio=(i+1)/(length+1);data[a]=data[a]*funA(ratio)+data[b]*funB(ratio),a--,b--}for(var le=loopEnd,ls=loopStart;le<buf.length;)data[le++]=data[ls++]}}}})),Module((function(Klang){var AudioSource=function(_super){function AudioSource(data,name){if(data.streaming&&Klang.Model.StreamingAudioSource)return new Klang.Model.StreamingAudioSource(data,name);_super.call(this,data,name),this._sources=[],this._startTime=0,this._loopStartTime=0,this._scheduleAhead=.2,this._stopping=!1,this._fading=!1,this._paused=!1,this._pauseTime=-1,this._pauseStartTime=-1,this.editorName=data.editorName,this._fileId=data.file_id,this._playbackRate=data.playback_rate||1,this._endTime=0,this._loop=void 0!==data.loop&&data.loop,this._loopStart=data.loop_start,this._loopEnd=data.loop_end,this._offset=data.offset||0,this._duration=data.duration||0,this._reverse=data.reverse,this._retrig=void 0===data.retrig||data.retrig,this._volumeStartRange=data.volume_start_range,this._volumeEndRange=data.volume_end_range,this._pitchStartRange=data.pitch_start_range,this._pitchEndRange=data.pitch_end_range,this._maxSources=data.max_sources||-1,this.priority,data.panner&&(this._panner=data.panner),Klang.core.Core.instance.pushToPostLoadInitStack(this)||this.init()}return Klang.Util.__extends(AudioSource,_super),AudioSource.prototype.init=function(){if(this._fileId&&("string"==typeof this._fileId?this._buffer=Klang.core.FileHandler.instance.getFile(this._fileId):this._fileId.sampleRate&&(this._buffer=this._fileId)),this._buffer){if(this._duration||(this._duration=this._buffer.duration),"Edge"==Klang.detector.browser.name&&this._loop&&(this._loopStart=(this._loopStart||0)+.07,this._loopEnd=(this._loopEnd||this.duration)+.07,this.data.xfade=this.data.xfade||.1),this._reverse){for(var reverseBuffer=Klang.context.createBuffer(this._buffer.numberOfChannels,this._buffer.length,Klang.context.sampleRate),c=0;c<this._buffer.numberOfChannels;c++)for(var channelBuffer=this._buffer.getChannelData(c),reverseChannelBuffer=reverseBuffer.getChannelData(c),len=channelBuffer.length,ix=len-1;ix>=0;ix--)reverseChannelBuffer[len-ix]=channelBuffer[ix];this._buffer=reverseBuffer}if(this.data.xfade&&!Klang.core.FileHandler.instance.getFile(this._fileId).isReversed){var sampleRate=Klang.context.sampleRate,fadeLength=!0===this.data.xfade?11025:this.data.xfade*sampleRate,loopStart=void 0===this._loopStart?fadeLength:Math.round(this._loopStart*sampleRate),loopEnd=void 0===this._loopEnd?this._buffer.length:Math.round(this._loopEnd*sampleRate);Klang.engines.webAudio.audioUtils.crossfade(this._buffer,loopStart,loopEnd,fadeLength),Klang.core.FileHandler.instance.getFile(this._fileId).isReversed=!0}}},AudioSource.prototype.setLoopRegion=function(loopStart,loopEnd){this._loopStart=loopStart||this._loopStart,this._loopEnd=loopEnd||this._loopEnd;for(var ix=0,len=this._sources.length;ix<len;ix++){var source=this._sources[ix];source.loopStart=this._loopStart,source.loopEnd=this._loopEnd}return this},AudioSource.prototype.connect=function(destination,forceConnect){return this._destination&&!forceConnect||(this._destination=destination,this._panner?(this._output.connect(this._panner.input),this._panner.output.connect(destination)):this._output.connect(destination)),this},AudioSource.prototype.disconnect=function(){return this._output.disconnect(),this._destination=null,this._panner&&this._panner.output.disconnect(),this},AudioSource.prototype.play=function(when,offset,duration,resume){if((when=when||0,offset=offset||0,resume=!!resume,this.removeUnusedSources(),void 0!==this.priority&&Klang.getCoreInstance().maxSimultaneousSounds)&&!this.checkPriority())return void Klang.warn("AudioSource: Skipped",this.editorName,"due to priority. Priority:",this.priority,"Max sources:",Klang.getCoreInstance().maxSimultaneousSounds);if(this._maxSources>-1&&this._sources.length>this._maxSources)Klang.warn("AudioSource: Max sources reached",this.editorName);else{if(duration||(duration=this._loop?9999999999:this._duration),this._buffer||(this.init(),this._buffer)){if(0!==(when=when||0)&&when+.01<=Klang.context.currentTime)return Klang.warn("AudioSource: Returned, playTime < currentTime",this.editorName),this;if(0===when&&(when=Klang.context.currentTime),this.output.gain.cancelScheduledValues(when),void 0!==this._volumeStartRange?this.output.gain.setValueAtTime(this._volume*(Math.random()*(this._volumeEndRange-this._volumeStartRange)+this._volumeStartRange),when):this.output.gain.setValueAtTime(this._volume,when),this.paused||(this._pauseStartTime=when),resume||(this._pauseTime=0),this._startTime=when,this._loopStartTime=when+this.duration,this._paused=!1,this._stopping&&!this._retrig)return this.output.gain.cancelScheduledValues(when),this.output.gain.setValueAtTime(this.output.gain.value,when),this.output.gain.linearRampToValueAtTime(this._volume,when+.25),clearTimeout(this._stoppingId),void(this._stopping=!1);if(this._fading,this._fading=!1,this._retrig||this.loop)if(this.loop&&!this._retrig){if(-1==this._endTime||when<this._endTime)return}else{if(this.loop&&this._retrig&&this.playing&&!this._stopping)return;if(this._stopping)this._stopping=!1;else if(Math.round(1e3*this._endTime)/1e3==Math.round(1e3*(when+this._buffer.duration))/1e3)return Klang.warn("AudioSource: Returned, Doubletrig",this._name),this}else if(when<this._endTime)return;this._endTime=this.loop?-1:when+this._buffer.duration;var source=this.createBufferSource();if(source.buffer=this._buffer,this._loop&&(source.loop=!0,source.loopStart=this._loopStart?this._loopStart:0,source.loopEnd=this._loopEnd?this._loopEnd:this._buffer.duration),this._destination||Klang.warn("AudioSource: no destination node"),"object"!=typeof this._destination&&Klang.warn("AudioSource: destination is not an object",this.editorName),source.connect(this._output),offset>this._duration&&(offset%=this._duration),this._startOffset=this._offset+offset,void 0!==this._pitchStartRange){var _randomplaybackrateValue=this._playbackRate*(Math.random()*(this._pitchEndRange-this._pitchStartRange)+this._pitchStartRange);source.playbackRate.setValueAtTime(_randomplaybackrateValue,Klang.context.currentTime)}return source.startTime=when,this._loop?source.start(when,this._startOffset):source.start(when,this._startOffset,duration||source.buffer.duration),Klang.core.Core.callbacks&&Klang.core.Core.callbacks.scheduleAudioSource&&Klang.core.Core.callbacks.scheduleAudioSource({audio:this,startTime:when}),this}Klang.warn("AudioSource: Buffer not found!",this.editorName)}},AudioSource.prototype.getNumberOfSamples=function(){return this._buffer.length},AudioSource.prototype.stop=function(when){void 0===when&&(when=0),this._stopping&&(this._stopping=!1,clearTimeout(this._stoppingId));var numSources=this._sources.length;if(numSources>0)if(when=when||Klang.Util.now(),this._loop&&(this._loopPlaying=!1),this._endTime=when,this._retrig)this._sources[this._sources.length-1].stop(when),this._sources[this._sources.length-1].startTime>Klang.context.currentTime&&when>this._sources[this._sources.length-1].startTime||this._sources.splice(this._sources.length-1,1);else{for(var ix=0;ix<numSources;ix++){this._sources[ix].stop(when)}this._sources=[]}else this._loopPlaying=!1;return this._startTime=-1,this},AudioSource.prototype.deschedule=function(){for(var ix=0;ix<this._sources.length;ix++){var source=this._sources[ix];source.startTime>Klang.context.currentTime&&(Number.isInteger(source.playbackState)&&2!==source.playbackState||source.stop(0),this._sources[ix].disconnect(),source.disconnect(),this._sources.splice(ix,1),ix--)}return this},AudioSource.prototype.pause=function(){if(this._endTime>Klang.Util.now()){this._paused=!0;var pauseDelta=Klang.Util.now()-this._startTime;this._pauseTime+=pauseDelta,this.stop()}return this},AudioSource.prototype.unpause=function(){if(this.paused){var realOffset=this._offset;this._offset+=this._pauseTime,this.play(0,0,null,!0),this._offset=realOffset,this._paused=!1}return this},AudioSource.prototype.createBufferSource=function(){var source=Klang.context.createBufferSource();return source.playbackRate.setValueAtTime(this._playbackRate,Klang.context.currentTime),this._sources.push(source),source},AudioSource.prototype.fadeInAndPlay=function(fadeDuration,when,offset,duration){void 0===offset&&(offset=0),void 0===duration&&(duration=this._duration);var now=Klang.context.currentTime;if(when||(when=now),(!this.loop||this._retrig||!(-1==this._endTime||when<this._endTime)||this._stopping)&&(!(this.loop&&this._retrig&&this.playing)||this._stopping))return this.output.gain.cancelScheduledValues(when),this._stopping?(clearTimeout(this._stoppingId),this.output.gain.setValueAtTime(this.output.gain.value,when)):(this._fading=!0,Number.isInteger(this.playbackState)&&0!==this.playbackState||this.play(when==now?0:when,offset,duration),this.output.gain.setValueAtTime(0,when)),this._stopping=!1,this.output.gain.linearRampToValueAtTime(this._volume,when+fadeDuration),this},AudioSource.prototype.fadeOutAndStop=function(duration,when){if(this.playing||this.scheduledToPlay()){if(void 0===when&&(when=Klang.context.currentTime),when<=this._startTime)return this.stop();this._stopping&&clearTimeout(this._stoppingId),this.output.gain.cancelScheduledValues(when),this.output.gain.setValueAtTime(this.output.gain.value||this._volume,when),this.output.gain.linearRampToValueAtTime(0,when+duration);var _this=this;return this._stoppingId=setTimeout((function(){_this._stopping&&(_this._stopping=!1,_this.loop&&(_this._loopPlaying=!1),_this.stop(when+duration))}),(duration+(when-Klang.Util.now())-_this._scheduleAhead)/.001),this._stopping=!0,this}},AudioSource.prototype.checkPriority=function(){var core=Klang.getCoreInstance(),playing=core.getPlaying(),canPlay=!0;core.maxSimultaneousSounds;return playing.length>core.maxSimultaneousSounds&&(playing.sort((function(a,b){return parseFloat(a.priority)-parseFloat(b.priority)})),playing.length&&(playing[0].priority<this.priority?(playing[0].fadeOutAndStop(.1),Klang.warn("AudioSource: Stopped",playing[0].editorName,"due to priority. Priority:",playing[0].priority,"Max sources:",Klang.getCoreInstance().maxSimultaneousSounds)):canPlay=!1)),canPlay},AudioSource.prototype.removeUnusedSources=function(){for(var ix=0;ix<this._sources.length;ix++){var source=this._sources[ix];(!source.buffer||!this.loop&&source.startTime+source.buffer.duration<Klang.context.currentTime)&&(this._sources[ix].disconnect(),this._sources.splice(ix,1),ix--)}},AudioSource.prototype.curvePlaybackRate=function(value,duration,when){var startTime=when||Klang.Util.now(),node=this.playbackRateNode;return node&&(node.cancelScheduledValues(startTime),node.setValueAtTime(0==node.value?Klang.Util.EXP_MIN_VALUE:node.value,startTime),node.exponentialRampToValueAtTime(value,startTime+duration)),this._playbackRate=value,this},Object.defineProperty(AudioSource.prototype,"lastSource",{get:function(){var numSources=this._sources.length;return 0==numSources?null:this._sources[numSources-1]},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"loop",{get:function(){return this._loop},set:function(value){this._loop=value},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"offset",{get:function(){return this._offset},set:function(value){"string"==typeof value&&-1!==value.indexOf("%")&&(value=this._duration*parseFloat(value)),this._offset=value},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"position",{get:function(){if(!this.playing||!this._duration)return 0;var duration=this._duration;(this._loopStart||this._loopEnd)&&(duration=(this._loopEnd||duration)-(this._loopStart||0));var timePlayed=Klang.Util.now()-this._startTime,loopTimePlayed=Klang.Util.now()+this._startOffset-this._loopStartTime;return this._startOffset+timePlayed>this._duration?(this._loopStart||0)+loopTimePlayed%duration:this._startOffset+timePlayed},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"duration",{get:function(){return this._duration},set:function(value){this._duration=value},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"paused",{get:function(){return this._paused},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"playbackRate",{get:function(){return this._playbackRate},set:function(value){var node=this.playbackRateNode;node&&node.cancelScheduledValues(Klang.Util.now()),this._playbackRate=value;for(var ix=0,len=this._sources.length;ix<len;ix++)this._sources[ix].playbackRate.value=this._playbackRate},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"nextPlaybackRate",{set:function(value){this._playbackRate=value},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"playbackRateNode",{get:function(){var source=this.lastSource;return source&&source.playbackRate},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"buffer",{get:function(){return this._buffer||(this._buffer=Klang.core.FileHandler.instance.getFile(this._fileId)),this._buffer},set:function(buffer){this._buffer=buffer},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"playing",{get:function(){return(-1==this._endTime||this._endTime>Klang.Util.now())&&this._startTime<=Klang.Util.now()},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"playbackState",{get:function(){var source=this.lastSource;return source?source.playbackState:0},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"output",{get:function(){return this._panner?this._panner.output:this._output},enumerable:!0,configurable:!0}),Object.defineProperty(AudioSource.prototype,"panner",{get:function(){return this._panner},enumerable:!0,configurable:!0}),AudioSource.prototype.scheduledToPlay=function(){return this._startTime>Klang.Util.now()},AudioSource.prototype.freeBuffer=function(){this._buffer=null;for(var ix=0,len=this._sources.length;ix<len;ix++){try{this._sources[ix].stop(0)}catch(ex){}this._sources[ix].disconnect(),this._sources[ix]=null}this._sources=[]},AudioSource.prototype.setData=function(data){_super.prototype.setData.call(this,data);var reinit=!1;this._volumeStartRange=data.volume_start_range,this._volumeEndRange=data.volume_end_range,this._pitchEndRange=data.pitch_end_range,this._pitchStartRange=data.pitch_start_range,void 0!==data.file_id&&this._fileId!=data.file_id&&(this._fileId=data.file_id,reinit=!0),this._playbackRate=void 0===data.playback_rate?1:data.playback_rate,this.playbackRateNode&&(this.playbackRateNode.value=this._playbackRate),this._loop=void 0!==data.loop&&data.loop,this.lastSource&&(this.lastSource.loop=this._loop),this._loop||(this._loopPlaying=!1),this._loopStart=void 0===data.loop_start?0:data.loop_start,this.lastSource&&(this.lastSource.loopStart=this._loopStart),this._loopEnd=void 0===data.loop_end?0:data.loop_end,this.lastSource&&(this.lastSource.loopEnd=this._loopEnd);var offset=void 0===data.offset?0:data.offset;this._offset!=offset&&(this._offset=offset,reinit=!0);var duration=void 0===data.duration?0:data.duration;if(this._duration!=duration&&(this._duration=duration,reinit=!0),this._retrig=void 0===data.retrig||data.retrig,void 0===data.reverse&&(data.reverse=!1),this._reverse!=data.reverse&&(this._reverse=data.reverse,reinit=!0),void 0===data.xfade&&(data.xfade=!1),this.data.xfade!=data.xfade&&(reinit=!0),this.data=data,reinit&&this.init(),data.panner)if(this._panner)this._panner.setData(data.panner);else{var d=this._destination;this.disconnect(),this._panner=newPanner(data.panner),this.connect(d)}else if(!data.panner&&this._panner){d=this._destination;this.disconnect(),this._panner=null,this.connect(d)}},AudioSource}(Klang.Model.Audio);return Klang.Model.AudioSource=AudioSource})),Module((function(Klang){var GroupType={CONCURRENT:0,STEP:1,RANDOM:2,SHUFFLE:3,BACKWARDS:4},QueueType={NONE:0,ONE:1,INFINITE:2};function AudioGroup(data,name){this._adder=0,this._currentId=0,this._paused=!1,this.data=data,this.editorName=data.editorName,this._name=name,this._type=data.type,this._groupType=void 0!==data.group_type?data.group_type:GroupType.STEP,this._retrig=void 0===data.retrig||data.retrig,this._queue=void 0!==data.queue?data.queue:QueueType.NONE,this._content=data.content||[],Klang.core.Core.instance.pushToPreLoadInitStack(this)}return AudioGroup.prototype.init=function(){for(var newContent=[],ix=0,len=this._content.length;ix<len;ix++)newContent.push(Klang.core.Core.instance.findInstance(this._content[ix]));this._content=newContent},AudioGroup.prototype.play=function(when,audioSource,forcePlay){if(this._content.length){var latestPlaying=!!this.latestPlayed&&this.latestPlayed.playing;if(!forcePlay&&!this._retrig&&latestPlaying)return this._queue!=QueueType.NONE&&(this._queue==QueueType.ONE&&this._latestStartTime>Klang.context.currentTime?(this.latestPlayed.stop(),this.play(this._latestStartTime,audioSource,!0)):this.play(this._latestStartTime+this.latestPlayed.duration,audioSource,!0)),this;if(this._paused=!1,void 0!==audioSource){var asId;"number"==typeof audioSource?asId=audioSource:"string"==typeof audioSource?asId=this.getIdFromString(audioSource):audioSource._name&&(asId=this.getIdFromString(audioSource._name)),this._content[asId].play(when),this._latestPlayed=this._content[asId]}else{if(this._groupType==GroupType.CONCURRENT)for(var ix=0,len=this._content.length;ix<len;ix++)this._content[ix].play(when);else this._currentId=this.getIdToPlay(),this._content[this._currentId].play(when);this._groupType===GroupType.CONCURRENT?this._latestPlayed=this._content[0]:this._latestPlayed=this._content[this._currentId]}return this._latestStartTime=when||Klang.context.currentTime,this}},AudioGroup.prototype.getIdToPlay=function(){var _id;if(this._groupType==GroupType.STEP)_id=this._adder<0?this._content.length-1+this._adder%this._content.length:this._adder%this._content.length,this._adder++;else if(this._groupType==GroupType.RANDOM){var random=Math.floor(Math.random()*(this._content.length-1));this._content.length>1&&random==this._adder&&(random=(random+1)%this._content.length),_id=this._adder=random}else this._groupType==GroupType.SHUFFLE?(this._adder%this._content.length==0&&Klang.Util.shuffle(this._content),_id=this._adder%this._content.length,this._adder++):this._groupType==GroupType.BACKWARDS&&(_id=this._adder<0?this._content.length-1+this._adder%this._content.length:this._adder%this._content.length,this._adder--);return _id},AudioGroup.prototype.stop=function(when){return this._content[this._currentId].stop(when),this},AudioGroup.prototype.stopAll=function(when){for(var ix=0,len=this._content.length;ix<len;ix++)this._content[ix].stop(when);return this},AudioGroup.prototype.pause=function(){return this._paused=!0,this._latestPlayed&&this._latestPlayed.pause(),this},AudioGroup.prototype.unpause=function(){return this._paused=!1,this._latestPlayed&&this._latestPlayed.unpause(),this},AudioGroup.prototype.fadeInAndPlay=function(duration,when,offset){var latestPlaying=!!this.latestPlayed&&this.latestPlayed.playing;if(this._retrig||!latestPlaying)return this._currentId=this.getIdToPlay(),this._latestPlayed=this._content[this._currentId],this._content[this._currentId].fadeInAndPlay(duration,when,offset),this},AudioGroup.prototype.fadeOutAndStop=function(duration,when){return void 0===when&&(when=Klang.context.currentTime),this._latestPlayed&&this._latestPlayed.fadeOutAndStop(duration,when),this},AudioGroup.prototype.curvePlaybackRate=function(value,duration,when){when||Klang.Util.now();for(var ix=0,len=this._content.length;ix<len;ix++)this._content[ix].curvePlaybackRate(value,duration,when);return this},AudioGroup.prototype.deschedule=function(){for(var ix=0,len=this._content.length;ix<len;ix++)this._content[ix].deschedule();return this},AudioGroup.prototype.getIdFromString=function(str){for(var ix=0,len=this._content.length;ix<len;ix++)if(this._content[ix]._name==str)return ix},Object.defineProperty(AudioGroup.prototype,"playbackRate",{set:function(value){for(var ix=0,len=this._content.length;ix<len;ix++)this._content[ix].playbackRate=value},enumerable:!0,configurable:!0}),Object.defineProperty(AudioGroup.prototype,"groupType",{get:function(){return this._groupType},set:function(value){this._groupType=value},enumerable:!0,configurable:!0}),Object.defineProperty(AudioGroup.prototype,"content",{get:function(){return this._content},set:function(value){this._content=value,this.init()},enumerable:!0,configurable:!0}),AudioGroup.prototype.addContent=function(audio){this._content.push(audio)},AudioGroup.prototype.removeContent=function(name){for(var i=0;i<this._content.length;i++)this._content[i]._name===name&&this._content.splice(i,1)},Object.defineProperty(AudioGroup.prototype,"playing",{get:function(){return!!this._latestPlayed&&this._latestPlayed.playing},enumerable:!0,configurable:!0}),Object.defineProperty(AudioGroup.prototype,"duration",{get:function(){return this._latestPlayed?this._latestPlayed.duration:this._content[0].duration},enumerable:!0,configurable:!0}),Object.defineProperty(AudioGroup.prototype,"playbackState",{get:function(){return this._content[this._currentId].playbackState},enumerable:!0,configurable:!0}),Object.defineProperty(AudioGroup.prototype,"latestPlayed",{get:function(){return this._latestPlayed},enumerable:!0,configurable:!0}),AudioGroup.prototype.setData=function(data){this._groupType=void 0===data.group_type?GroupType.STEP:data.group_type,this._retrig=void 0===data.retrig||data.retrig,this._queue=void 0===data.queue?QueueType.NONE:data.queue,data.content&&(this._content=data.content,this.init())},Klang.Model.AudioGroup=AudioGroup})),Module((function(Klang){function Automation(data){this._startValue=data.start_value||0,this._points=data.points||[]}return Automation.prototype.automate=function(param,when){when=when||Klang.context.currentTime,param.cancelScheduledValues(when),param.setValueAtTime(this._startValue,when);for(var lastEndTime=0,ix=0,len=this._points.length;ix<len;ix++){var p=this._points[ix];switch(p.curve){case"lin":param.linearRampToValueAtTime(p.value,when+p.time);break;case"exp":param.exponentialRampToValueAtTime(p.value,when+p.time);break;default:if(Klang.Util.CUSTOM_CURVES[p.curve]){Klang.warn("Automation: Invalid curve type: "+p.curve);break}param.setValueCurveAtTime(Klang.Util.CUSTOM_CURVES[p.curve],when+lastEndTime,p.time-lastEndTime)}lastEndTime=p.time}},Klang.Model.Automation=Automation})),Module((function(Klang){function Bus(data,name){this._name=name,this._type=data.type,this._input=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._output=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._effects=data.effects||[],this._data=data;for(var i=0,len=this._effects.length;i<len;i++)!1===data.effects[i].active&&this._effects[i].setActive(!1);var inputVol=void 0!==data.input_vol?data.input_vol:1,outputVol=void 0!==data.output_vol?data.output_vol:1;this._input.gain.setValueAtTime(inputVol,Klang.context.currentTime),this._output.gain.setValueAtTime(outputVol,Klang.context.currentTime),data.destination_name&&(this.destinationName=data.destination_name,Klang.core.Core.instance.pushToConnectStack(this)),Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Bus.prototype.init=function(){for(var lastNode=this._input,i=0,len=this._effects.length;i<len;i++)lastNode.disconnect(),lastNode.connect(this._effects[i].input),lastNode=this._effects[i];lastNode.connect(this._output)},Bus.prototype.connect=function(destination){return this._output.connect(destination),this._destination=destination,this},Bus.prototype.disconnect=function(){return this._output.disconnect(),this},Bus.prototype.refreshAudioNodes=function(){for(var i=0;i<this.effects.length;i++)this.effects[i].disconnect(),this.effects[i].refreshAudioNodes&&this.effects[i].refreshAudioNodes();var outVol=this._output.gain.value;this._output.gain.cancelScheduledValues(Klang.context.currentTime),this._output.disconnect(),this._output=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._output.gain.setValueAtTime(outVol,Klang.context.currentTime),this.init(),this._destination&&this._output.connect(this._destination)},Bus.prototype.insertEffect=function(effectData,index){var effect=Klang.core.Core.instance.createObject(void 0,effectData,{excludeFromTable:!0});return void 0===index?this._effects.push(effect):this._effects.splice(index,0,effect),this.init(),this},Bus.prototype.moveEffect=function(fromIndex,toIndex){for(var i=0,len=this._effects.length;i<len;i++)this._effects[i].disconnect();var effect=this._effects[fromIndex];return this._effects.splice(fromIndex,1),this._effects.splice(toIndex,0,effect),this.init(),this},Object.defineProperty(Bus.prototype,"input",{get:function(){return this._input},enumerable:!0,configurable:!0}),Object.defineProperty(Bus.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0}),Object.defineProperty(Bus.prototype,"effects",{get:function(){return this._effects},enumerable:!0,configurable:!0}),Bus.prototype.setData=function(data){if(this._input.gain.value=void 0===data.input_vol?1:data.input_vol,this._output.gain.value=void 0===data.output_vol?1:data.output_vol,data.effects.length<this.effects.length){this.input.disconnect();for(var found=!1,ix=0;ix<this._effects.length;ix++)this._effects[ix].disconnect(),found||(void 0===data.effects[ix]?(this._effects.splice(ix,1),found=!0):this._effects[ix]._type!=data.effects[ix].type&&(this._effects.splice(ix,1),ix--,found=!0));this.init()}else if(data.effects.length>this.effects.length)this.insertEffect(data.effects[data.effects.length-1]);else{ix=0;for(var len=this._effects.length;ix<len;ix++)this._effects[ix].setData(data.effects[ix])}this.destinationName!=data.destination_name&&(this.destinationName=data.destination_name,this.disconnect(),"$OUT"==this.destinationName?this.connect(Klang.core.Core.instance._superMasterOutput):this.connect(Klang.core.Core.instance.findInstance(this.destinationName).input))},Klang.Model.Bus=Bus})),Module((function(Klang){Klang.audioUtil=Klang.engines.webAudio.Util={}})),Module((function(Klang){Klang.engines.webAudio.Util.getNoteInScale=function(midiNoteNumber,scale,root){var transpose;if(scale){var scaleStep=midiNoteNumber%12-root;scaleStep<0&&(scaleStep+=12),transpose=this.scales[scale][scaleStep]}return midiNoteNumber+transpose},Klang.engines.webAudio.Util.getTransposeFromScale=function(midiNoteNumber,scale,root){var scaleStep=midiNoteNumber%12-root;return scaleStep<0&&(scaleStep+=12),this.scales[scale][scaleStep]},Klang.engines.webAudio.Util.scales={diatonic:[0,-1,0,-1,0,0,-1,0,-1,0,-1,0],dorian:[0,1,0,0,-1,0,1,0,1,0,0,-1],phrygian:[0,0,-1,0,-1,0,1,0,0,-1,0,-1],lydian:[0,1,0,1,0,1,0,0,1,0,1,0],mixolydian:[0,1,0,1,0,0,-1,0,-1,0,0,-1],aeolian:[0,-1,0,0,-1,0,-1,0,0,-1,0,-1],locrian:[0,0,-1,0,-1,0,0,-1,0,-1,0,-1],harmonicMinor:[0,1,0,0,-1,0,1,0,0,-1,1,0],melodicMinor:[0,1,0,0,-1,0,1,0,-1,0,1,0],majorPentatonic:[0,1,0,1,0,-1,1,0,1,0,-1,1],minorPentatonic:[0,-1,1,0,-1,0,1,0,-1,1,0,-1],doubleHarmonic:[0,0,-1,1,0,0,1,0,0,-1,1,0],halfDim:[0,1,0,0,-1,0,0,-1,0,-1,0,-1],chromatic:[0,0,0,0,0,0,0,0,0,0,0,0],custom:[0,0,0,0,0,0,0,0,0,0,0,0]}})),Module((function(Klang){!function(PatternState){PatternState._map=[],PatternState._map[0]="PrePlaying",PatternState.PrePlaying=0,PatternState._map[1]="Playing",PatternState.Playing=1,PatternState._map[2]="PreStopping",PatternState.PreStopping=2,PatternState._map[3]="PostStop",PatternState.PostStop=3,PatternState._map[4]="Stopped",PatternState.Stopped=4}(Klang.Model.PatternState||(Klang.Model.PatternState={}));var PatternState=Klang.Model.PatternState;Klang.Model.getPatternStateString=function(state){switch(state){case PatternState.PrePlaying:return"PrePlaying";case PatternState.Playing:return"Playing";case PatternState.PreStopping:return"PreStopping";case PatternState.PostStop:return"PostStop";case PatternState.Stopped:return"Stopped"}};var Pattern=function(_super){function Pattern(data,name){_super.call(this,data,name),this._startStep=0,this._totalStep=0,this._currentStep=0,this._syncStep=0,this._stepCount=0,this._fadeTime=0,this._length=2,this._loop=!0,this._tail=!1,this._forceFade=!1,this._activeUpbeat=-1,this._startOffset=0,this._state=PatternState.Stopped,this._beatSubscription=data.beat_subscription||.25,this._length=data.length||0,this._startStep=data.start_step||0,this._loop=void 0===data.loop||data.loop,this._tail=void 0!==data.tail&&data.tail,this._clips=[],this._upbeats=[],this._sequencerName=data.sequencer,this._initData={dummyClips:data.content,dummyUpbeats:data.upbeats},Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Klang.Util.__extends(Pattern,_super),Pattern.prototype.init=function(){if(this._initData.dummyClips)for(var ix=0,len=this._initData.dummyClips.length;ix<len;ix++){var dummy=this._initData.dummyClips[ix];dummy.audio?(this._clips.push({audio:Klang.core.Core.instance.findInstance(dummy.audio),process:null,args:null,step:dummy.step}),this._clips[this._clips.length-1].audio._parentType=this._type):this._clips.push({audio:null,process:Klang.core.Core.instance.findInstance(dummy.process),args:dummy.args,step:dummy.step})}if(this._initData.dummyUpbeats){ix=0;for(var ilen=this._initData.dummyUpbeats.length;ix<ilen;ix++){for(var dummyUpbeat=this._initData.dummyUpbeats[ix],upbeatClips=[],jx=0,jlen=dummyUpbeat.content.length;jx<jlen;jx++){var dummyClip=dummyUpbeat.content[jx];dummyClip.audio?(upbeatClips.push({audio:Klang.core.Core.instance.findInstance(dummyClip.audio),process:null,args:null,step:dummyClip.step}),this._clips[this._clips.length-1].audio._parentType=this._type):upbeatClips.push({audio:null,process:Klang.core.Core.instance.findInstance(dummyClip.process),args:dummyClip.args,step:dummyClip.step})}dummyUpbeat.clips=upbeatClips,this._upbeats.push({length:dummyUpbeat.length,clips:upbeatClips})}this._upbeats.sort((function(a,b){return b.length-a.length}))}this._sequencer=Klang.core.Core.instance.findInstance(this._sequencerName),this._sequencer.registerPattern(this),this._initData=null},Pattern.prototype.connect=function(destination){for(var ix=0,len=this._clips.length;ix<len;ix++){var a=this._clips[ix].audio;!a||a.destinationName&&"$OUT"!=Klang.core.Core.instance.findInstance(a.destinationName).destinationName||(a.disconnect(),a.connect(this._output))}return this._output.connect(destination),this},Pattern.prototype.disconnect=function(){return this._output.disconnect(),this},Pattern.prototype.changeState=function(state){state!=this._state&&(Klang.core.Core.callbacks&&Klang.core.Core.callbacks.changePatternState&&Klang.core.Core.callbacks.changePatternState({pattern:this,lastState:this._state,newState:state,step:this._sequencer.currentStep}),this._state=state)},Pattern.prototype.prePlaySchedule=function(steps,syncStep,restart,fadeIn,duration,offset){restart=restart||!1;var v,t=Klang.context.currentTime;if(this._state==PatternState.PreStopping||this._state==PatternState.PostStop)return this._output.gain.cancelScheduledValues(t),this._output.gain.setValueAtTime(this._output.gain.value,t),this._output.gain.linearRampToValueAtTime(this._volume,t+.5),this.changeState(PatternState.Playing),clearTimeout(this._stoppingId),this;if(this._output.gain.value!=this._volume||PatternState.Stopped)v=this._state===PatternState.Stopped&&fadeIn?0:this._output.gain.value,this._output.gain.cancelScheduledValues(t),this._output.gain.setValueAtTime(v,t),this._output.gain.linearRampToValueAtTime(this._volume,t+duration);else if(fadeIn){var playTime=this._sequencer.getBeatTime(steps);this._output.gain.cancelScheduledValues(playTime),this._output.gain.setValueAtTime(0,playTime),this._output.gain.linearRampToValueAtTime(this._volume,playTime+duration)}if(this._state==PatternState.Playing||this._state==PatternState.PrePlaying){if(!restart)return this;this._syncStep=syncStep,this.stop(steps,!0,0)}if(void 0!==offset&&(this._startOffset=offset),this._syncStep=syncStep%this._length+this._startStep,steps>0||restart){this._stepCount=steps,this._currentStep=this._startStep,this._totalStep=0,this._activeUpbeat=-1;for(var ix=0,len=this._upbeats.length;ix<len;ix++){var upbeat=this._upbeats[ix];upbeat.length<=steps&&(-1==this._activeUpbeat||this._upbeats[this._activeUpbeat].length<upbeat.length)&&(this._activeUpbeat=ix)}this.changeState(PatternState.PrePlaying)}else this.changeState(PatternState.Playing);return this},Pattern.prototype.play=function(when){return this._state==PatternState.Playing||this._state==PatternState.PrePlaying?this:(this._state!=PatternState.PreStopping&&this._state!=PatternState.PostStop||clearTimeout(this._stoppingId),this._currentStep=this._sequencer.currentStep%this._length+this._startStep,this.changeState(PatternState.Playing),this._sequencer.started||this._sequencer.start(),this)},Pattern.prototype.stop=function(when,beat,fadeTime,wait){if(this._state==PatternState.Stopped)return this;if(this._state!==PatternState.PrePlaying){if(void 0===when)return this.changeState(PatternState.Stopped),this._currentStep=0,this;if(void 0===beat&&(beat=!0),beat)this._stepCount=this._sequencer.getStepsToNext(this._sequencer.beatLength*when)||0,this._fadeTime=fadeTime,this.changeState(PatternState.PreStopping),wait>0&&(this._stepCount+=wait);else if(fadeTime){var fadeBeats=fadeTime/this._sequencer.getNoteTime(1);this._stepCount=Math.ceil(fadeBeats),this.changeState(PatternState.Stopped);Klang.context.currentTime;for(var i=0;i<this._clips.length;i++)this._clips[i].audio&&this._clips[i].audio.fadeOutAndStop(fadeTime,when)}else{this.changeState(PatternState.Stopped),this._currentStep=0;for(i=0;i<this._clips.length;i++)this._clips[i].audio&&this._clips[i].audio.stop(when+this._sequencer.getNoteTime(this._sequencer.resolution))}return this}this.changeState(PatternState.Stopped)},Pattern.prototype.pause=function(){for(var ix=0,len=this._clips.length;ix<len;ix++)this._clips[ix].audio&&this._clips[ix].audio.pause();return this},Pattern.prototype.unpause=function(){for(var ix=0,len=this._clips.length;ix<len;ix++)this._clips[ix].audio&&this._clips[ix].audio.unpause();return this},Pattern.prototype.playStep=function(currentStep,scheduleTime){this._currentStep>=this._length+this._startStep&&(this._loop?this._currentStep=this._startStep:this._loop||this.changeState(PatternState.Stopped));for(var ix=0,len=this._clips.length;ix<len;ix++)if(this._clips[ix].step==this._currentStep){var clip=this._clips[ix];clip.audio?clip.audio.play(scheduleTime,this._startOffset):clip.process.start(clip.args)}this._totalStep+=this._beatSubscription,this._currentStep+=this._beatSubscription},Pattern.prototype.update=function(currentStep,scheduleTime){if(this._state!=PatternState.Stopped&&currentStep%this._beatSubscription==0)switch(this._state){case PatternState.PrePlaying:if(-1!=this._activeUpbeat)for(var upbeat=this._upbeats[this._activeUpbeat],ix=0,len=upbeat.clips.length;ix<len;ix++){var clip=upbeat.clips[ix];clip.step==upbeat.length-this._stepCount&&(clip.audio?clip.audio.play(scheduleTime):clip.process.start(clip.args))}this._stepCount-=this._beatSubscription,this._stepCount<=0&&(this._currentStep=this._startStep+this._syncStep%this._length,this._syncStep=0,this.changeState(PatternState.Playing));break;case PatternState.Playing:this.playStep(currentStep,scheduleTime);break;case PatternState.PreStopping:this._stepCount-=this._beatSubscription,this._stepCount<=0?!this._tail||this._forceFade?this.stop(scheduleTime,!1,this._fadeTime):(this.changeState(PatternState.Stopped),this._currentStep=0):this.playStep(currentStep,scheduleTime);break;case PatternState.PostStop:this.playStep(currentStep,scheduleTime),this._stepCount-=this._beatSubscription,this._stepCount<=0&&(this._forceFade=!1,this.changeState(PatternState.Stopped),this._currentStep=0)}return this},Pattern.prototype.deschedule=function(steps){if(void 0===steps&&(steps=this._length),this._state!=PatternState.Stopped){steps%=this._length;for(var ix=0,len=this._clips.length;ix<len;ix++){var clip=this._clips[ix];clip.audio&&clip.audio.deschedule()}if(clearTimeout(this._stoppingId),this._output.gain.cancelScheduledValues(Klang.Util.now()),this._currentStep=this._currentStep-steps,this._currentStep<this._startStep){var stepDelta=this._startStep-this._currentStep;this._currentStep=this._startStep+this._length-stepDelta}}return this},Pattern.prototype.fadeInAndPlay=function(duration,when){return this},Pattern.prototype.fadeOutAndStop=function(duration,when){return when=when||Klang.Util.now(),this.stop(when,!1,duration),this},Pattern.prototype.curvePlaybackRate=function(value,duration){for(var i=0,l=this._clips.length;i<l;i++)this._clips[i].audio.curvePlaybackRate(value,duration);return this},Pattern.prototype.getNextBar=function(x){var nextBar=Math.ceil(this._currentStep/x);return this._currentStep>this._length-x&&(nextBar=0),nextBar},Object.defineProperty(Pattern.prototype,"forceFade",{set:function(value){this._forceFade=value},enumerable:!0,configurable:!0}),Object.defineProperty(Pattern.prototype,"playbackRate",{set:function(value){for(var ix=0,len=this._clips.length;ix<len;ix++)this._clips[ix].audio.playbackRate=value},enumerable:!0,configurable:!0}),Object.defineProperty(Pattern.prototype,"length",{get:function(){return this._length},enumerable:!0,configurable:!0}),Object.defineProperty(Pattern.prototype,"loop",{get:function(){return this._loop},enumerable:!0,configurable:!0}),Object.defineProperty(Pattern.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(Pattern.prototype,"playing",{get:function(){var _playing=!1;return 1!==this._state&&1!==this._state||(_playing=!0),_playing},enumerable:!0,configurable:!0}),Object.defineProperty(Pattern.prototype,"duration",{get:function(){return this._length*this._sequencer.getNoteTime(1)},enumerable:!0,configurable:!0}),Object.defineProperty(Pattern.prototype,"playbackState",{get:function(){return 0},enumerable:!0,configurable:!0}),Object.defineProperty(Pattern.prototype,"currentStep",{get:function(){return this._currentStep},enumerable:!0,configurable:!0}),Pattern.prototype.setData=function(data){_super.prototype.setData.call(this,data);var reinit=!1;this._beatSubscription=void 0!==data.beat_subscription?data.beat_subscription:.25,this._length=void 0!==data.length?data.length:0,this._startStep=void 0!==data.start_step?data.start_step:0,this._loop=void 0===data.loop||data.loop,this._tail=void 0!==data.tail&&data.tail,void 0!==data.sequencer&&this._sequencerName!=data.sequencer&&(this._sequencerName=data.sequencer,reinit=!0),this._initData={dummyClips:null,dummyUpbeats:null},data.content&&(this._initData.dummyClips=data.content,this._clips=[],reinit=!0),data.upbeats&&(this._initData.dummyUpbeats=data.upbeats,this._upbeats=[],reinit=!0),reinit&&(this._sequencer.unregisterPattern(this),this.init())},Pattern}(Klang.Model.Audio);return Klang.Model.Pattern=Pattern})),Module((function(Klang){var PatternState=Klang.Model.PatternState,audioUtil=Klang.engines.webAudio.Util,MidiPattern=function(_super){function MidiPattern(data,name){if(_super.call(this,data,name),this._startStep=0,this._totalStep=0,this._currentStep=0,this._syncStep=0,this._stepCount=0,this._fadeTime=0,this._transpose=0,this._updatedClips=[],this._state=PatternState.Stopped,this._beatSubscription=data.beat_subscription||.25,this._midiFileId=data.file_id,this._midiTrackIx=data.midi_track||0,this._sequencerName=data.sequencer,this._synthName=data.synth,this._loop=void 0===data.loop||data.loop,this._length=data.length||0,this._nextClip=0,this._startStep=data.start_step||0,this._root=data.root||0,this._transpose=this._orgTranspose=data.transpose||0,this._scale=this._orgScale=data.scale,this._rootNote=data.root_note||36,this._activeUpbeat=-1,this._dataClips=data.clips||void 0,data.upbeats){this._upbeats=[],this._upbeatLoopOffset=0;for(var ix=0,len=data.upbeats.length;ix<len;ix++)this._upbeats.push({length:data.upbeats[ix].length,step:data.upbeats[ix].step,targetStep:data.upbeats[ix].target_step,playInLoop:data.upbeats[ix].play_in_loop})}Klang.core.Core.instance.pushToPostLoadInitStack(this)}return Klang.Util.__extends(MidiPattern,_super),MidiPattern.prototype.init=function(){this._sequencer=Klang.core.Core.instance.findInstance(this._sequencerName),this._sequencer.registerPattern(this),"progression"===this._synthName?(this._synth="progression",this._progression=!0,this._currentChord=[]):this._synth=Klang.core.Core.instance.findInstance(this._synthName),this._midiFile=Klang.core.FileHandler.instance.getFile(this._midiFileId),this._midiFile?this.setupFile():this._dataClips?this._clips=this._dataClips:this._clips=[]},MidiPattern.prototype.setupFile=function(){this._midiTrack=this._midiFile.tracks[this._midiTrackIx],void 0===this._midiTrack&&Klang.warn("MidiPattern: midi track out of bounds: "+this._midiTrackIx),this.recalculateBPM(this._sequencer.bpm);var ticksPerBeat=this._midiFile.header.ticksPerBeat,ticks=0;this._clips=[];for(var ix=0,len=this._midiTrack.length;ix<len;ix++){var ev=this._midiTrack[ix],st=(ticks+=ev.deltaTime)/ticksPerBeat-ticks/ticksPerBeat%this._sequencer.resolution;this._clips.push({event:ev,step:st,offset:ticks%(ticksPerBeat*this._sequencer.resolution)})}return this},MidiPattern.prototype.connect=function(destination){return this._output.connect(destination),this},MidiPattern.prototype.disconnect=function(){return this._output.disconnect(),this},MidiPattern.prototype.changeState=function(state){state!=this._state&&(Klang.core.Core.callbacks&&Klang.core.Core.callbacks.changePatternState&&Klang.core.Core.callbacks.changePatternState({pattern:this,lastState:this._state,newState:state,step:this._sequencer.currentStep}),this._state=state)},MidiPattern.prototype.prePlaySchedule=function(steps,syncStep,restart){if(this._midiFile||(this._midiFile=Klang.core.FileHandler.instance.getFile(this._midiFileId),this._midiFile?this.setupFile():Klang.log("MidiPattern: midifile not found: "+this._name+". Playing without midifile.")),restart=restart||!1,this._state==PatternState.Playing){if(!restart)return this;this._syncStep=syncStep,this.stop(steps,!0)}var startTime=this._sequencer._scheduleTime+steps*this._sequencer.getNoteTime(.25);if(this.trigger("start",startTime),this._syncStep=syncStep%this._length,this._currentStep=this._startStep,this.findNextClip(this._currentStep),steps>0){if(this._stepCount=steps,this._currentStep+=this._syncStep,this._syncStep=0,this._totalStep=0,this.changeState(PatternState.PrePlaying),this._upbeats){this._activeUpbeat=-1;for(var ix=0,len=this._upbeats.length;ix<len;ix++){var upbeat=this._upbeats[ix];upbeat.length<=steps&&(-1==this._activeUpbeat||this._upbeats[this._activeUpbeat].length<upbeat.length)&&(this._activeUpbeat=ix)}-1!=this._activeUpbeat&&this._upbeats[this._activeUpbeat].playInLoop&&(this._upbeatLoopOffset=this._upbeats[this._activeUpbeat].length)}this.findNextClip(-1==this._activeUpbeat?this._currentStep:this._upbeats[this._activeUpbeat].step)}else this.changeState(PatternState.Playing);return this._patternStartTime=Klang.Util.now(),this},MidiPattern.prototype.play=function(when){if(this._midiFile||(this._midiFile=Klang.core.FileHandler.instance.getFile(this._midiFileId),this._midiFile?this.setupFile():Klang.log("MidiPattern: midifile not found: "+this._name+". Playing without midifile.")),this._state==PatternState.Playing)return this;if(when&&0!=when){var targetVol=this._output.gain.value;this._output.gain.setValueAtTime(0,0),this._output.gain.setValueAtTime(targetVol,when)}return this._currentStep=this._sequencer.currentStep%this._length+this._startStep,this.changeState(PatternState.Playing),this.findNextClip(this._currentStep),this._sequencer.started||this._sequencer.start(),this},MidiPattern.prototype.restart=function(){return this._currentStep=this._startStep,this._nextClip=0,this},MidiPattern.prototype.stop=function(when,beat){return this.trigger("stop",when),this._synth.deschedule&&this._sequencer._scheduleAheadTime>.5&&this._synth.deschedule(),void 0===when||this._state==PatternState.Stopped?(this.changeState(PatternState.Stopped),this):(void 0===beat&&(beat=!0),beat?(this._stepCount=this._sequencer.getStepsToNext(this._sequencer.beatLength*when),this.changeState(PatternState.PreStopping)):(this.changeState(PatternState.Stopped),"progression"!==this._synth&&this._synth._loopedSamples&&this._synth.stop(when)),this)},MidiPattern.prototype.pause=function(){return this},MidiPattern.prototype.unpause=function(){return this},MidiPattern.prototype.sendMidiEvents=function(step,scheduleTime,bypassNoteOn){if(this._clips.length){for(var startClip=this._nextClip;this._clips[this._nextClip].step==step;){var nextClip=this._clips[this._nextClip];if(this._progression){if("noteOn"===nextClip.event.subtype)this._currentChord.push(nextClip.event.noteNumber);else if("noteOff"===nextClip.event.subtype){var id=this._currentChord.indexOf(nextClip.event.noteNumber);id>-1&&this._currentChord.splice(id,1)}}else{var transpose=0;if(nextClip.event.noteNumber&&(this._scale&&(transpose=audioUtil.getTransposeFromScale(nextClip.event.noteNumber,this._scale,this._root)),0!=this._transpose&&(transpose+=this._transpose)),!bypassNoteOn||"noteOn"!==nextClip.event.subtype){var offset=this._midiFile?nextClip.offset*this._secPerTick:nextClip.offset;if(this._synth.handleMidiEvent(nextClip.event,scheduleTime+offset,transpose),"undefined"!=nextClip.duration){var newEvent=Klang.Util.cloneObject(nextClip.event);newEvent.subtype="noteOff";var noteOffTime=nextClip.duration*(4*this._sequencer.getNoteTime(.25));this._synth.handleMidiEvent(newEvent,scheduleTime+noteOffTime+offset,transpose)}}}if(this._nextClip++,this._nextClip==this._clips.length&&(this._nextClip=0),this._nextClip===startClip){Klang.log("MidiPattern",this._name,"got stuck, check if you're playing the correct midi track.");break}}if(this._progression&&this._currentChord.length){this._currentChord.sort((function(a,b){return a-b}));var chordRootMidiNote=this._currentChord[0],root=chordRootMidiNote%12;transpose=0;root!=this._root&&(transpose=chordRootMidiNote-this._rootNote);for(var scale=[0,0,0,0,0,0,0,0,0,0,0,0],chordNormalized=[],j=0;j<this._currentChord.length;j++){var n=this._currentChord[j]%12-root;n<0&&(n+=12),chordNormalized.push(n)}chordNormalized.sort((function(a,b){return a-b}));for(var i=0;i<scale.length;i++){var closest=this.getClosestValues(chordNormalized,i);void 0!==closest&&(scale[i]=closest-i)}this._sequencer.customScale=scale,this._sequencer.transpose=transpose,this._rootNote=chordRootMidiNote}}},MidiPattern.prototype.getClosestValues=function(a,x){for(var lo=-1,hi=a.length;hi-lo>1;){var mid=Math.round((lo+hi)/2);a[mid]<=x?lo=mid:hi=mid}return a[lo]==x&&(hi=lo),a[Math.abs(x-hi)>Math.abs(x-lo)?lo:Math.abs(x-hi)<Math.abs(x-lo)?hi:lo]},MidiPattern.prototype.findNextClip=function(step){for(var ix=0,len=this._clips.length;ix<len;ix++)if(this._clips[ix].step>=step)return this._nextClip=ix,ix},MidiPattern.prototype.playStep=function(currentStep,scheduleTime){var playThisStep=!0;if(this._currentStep>=this._length+this._startStep&&(this.sendMidiEvents(this._length,scheduleTime,!0),this._currentStep=this._startStep,this.findNextClip(this._currentStep),this._loop||(this.changeState(PatternState.Stopped),playThisStep=!1),this._updatedClips.length)){var newArray=this._clips.concat(this._updatedClips);newArray.sort((function(a,b){return a.step-b.step})),this._clips=newArray,this._updatedClips=[]}playThisStep&&this.sendMidiEvents(this._currentStep,scheduleTime,!1),this._totalStep+=this._beatSubscription,this._currentStep+=this._beatSubscription},MidiPattern.prototype.update=function(currentStep,scheduleTime){if(this._state!=PatternState.Stopped&&currentStep%this._beatSubscription==0)switch(this._upbeats&&-1!=this._activeUpbeat&&this._upbeats[this._activeUpbeat].playInLoop&&this._state==PatternState.Playing&&this._currentStep>=this._length+this._startStep-this._upbeatLoopOffset&&(this._upbeatLoopOffset>0&&(this._stepCount=this._upbeatLoopOffset,this.changeState(PatternState.PrePlaying)),this.sendMidiEvents(this._currentStep,scheduleTime,!0),this._currentStep=this._startStep,this.findNextClip(this._upbeats[this._activeUpbeat].step)),this._state){case PatternState.PrePlaying:if(-1!=this._activeUpbeat){var upbeat=this._upbeats[this._activeUpbeat],currentUpbeatStep=upbeat.length-this._stepCount;currentUpbeatStep>=0&&this.sendMidiEvents(upbeat.step+currentUpbeatStep,scheduleTime,!1)}this._stepCount-=this._beatSubscription,this._stepCount<=0&&(-1!=this._activeUpbeat&&upbeat.targetStep&&(this._currentStep=upbeat.targetStep),this.findNextClip(this._currentStep),this.changeState(PatternState.Playing));break;case PatternState.Playing:this.playStep(currentStep,scheduleTime);break;case PatternState.PreStopping:this._stepCount-=this._beatSubscription,this._stepCount<=0?this.stop(scheduleTime,!1):this.playStep(currentStep,scheduleTime);break;case PatternState.PostStop:}return this},MidiPattern.prototype.recalculateBPM=function(bpm){var ticksPerBeat=this._midiFile.header.ticksPerBeat,secPerQuarterNote=6e7/bpm/1e6;this._secPerTick=secPerQuarterNote/ticksPerBeat},MidiPattern.prototype.getNextBar=function(x){var nextBar=Math.ceil(this._currentStep/x);return this._currentStep>this._length-x&&(nextBar=0),nextBar},MidiPattern.prototype.fadeInAndPlay=function(duration,when){return this.play(when),this.output.gain.value=0,Klang.Util.curveParamLin(this.output.gain,1,duration,when),this},MidiPattern.prototype.fadeOutAndStop=function(duration,when){return void 0===when&&(when=Klang.context.currentTime),this.output.gain.cancelScheduledValues(when),Klang.Util.curveParamLin(this.output.gain,0,duration,when),Klang.Util.setParam(this.output.gain,this._volume,when+duration),this.stop(when+duration),this},MidiPattern.prototype.deschedule=function(steps){if(void 0===steps&&(steps=this._length),this._synth.deschedule&&this._synth.deschedule(),this._state!=PatternState.Stopped){if(steps%=this._length,this._currentStep=this._currentStep-steps,this._currentStep<this._startStep){var stepDelta=this._startStep-this._currentStep;this._currentStep=this._startStep+this._length-stepDelta}for(var ix=0,len=this._clips.length;ix<len;ix++)if(this._clips[ix].step>=this._currentStep){this._nextClip=ix;break}}return this},MidiPattern.prototype.resetTranspose=function(){this._transpose=this._orgTranspose},Object.defineProperty(MidiPattern.prototype,"length",{get:function(){return this._length},set:function(length){this._length=length},enumerable:!0,configurable:!0}),Object.defineProperty(MidiPattern.prototype,"startStep",{set:function(step){this._startStep=step,this._currentStep=this._sequencer.currentStep%this._length+this._startStep;for(var ix=0,len=this._clips.length;ix<len;ix++)if(this._clips[ix].step>=this._currentStep){this._nextClip=ix;break}},enumerable:!0,configurable:!0}),Object.defineProperty(MidiPattern.prototype,"scale",{set:function(scale){this._progression||(this._scale="reset"===scale?this._orgScale:scale)},enumerable:!0,configurable:!0}),Object.defineProperty(MidiPattern.prototype,"customScale",{set:function(obj){this._progression||(Klang.audioUtil.scales.custom=obj,this._scale="custom")},enumerable:!0,configurable:!0}),Object.defineProperty(MidiPattern.prototype,"transpose",{get:function(){return this._transpose},set:function(transpose){this._transpose=transpose},enumerable:!0,configurable:!0}),Object.defineProperty(MidiPattern.prototype,"loop",{get:function(){return this._loop},enumerable:!0,configurable:!0}),Object.defineProperty(MidiPattern.prototype,"state",{get:function(){return this._state},enumerable:!0,configurable:!0}),Object.defineProperty(MidiPattern.prototype,"playing",{get:function(){var _playing=!1;return 1!==this._state&&1!==this._state||(_playing=!0),_playing},enumerable:!0,configurable:!0}),Object.defineProperty(MidiPattern.prototype,"duration",{get:function(){return this._length*this._sequencer.getNoteTime(1)},enumerable:!0,configurable:!0}),MidiPattern.prototype.getNoteInScale=function(midiNumber){return Klang.audioUtil.getNoteInScale(midiNumber,this._scale,this._root)},MidiPattern.prototype.getPositionInPattern=function(){var patternLength=this.length,lengthSeconds=this._sequencer.getNoteTime(patternLength),positionSeconds=(Klang.Util.now()-this._patternStartTime)%lengthSeconds,sixteenNote=this._sequencer.getNoteTime(.25),positionStepsRaw=positionSeconds/sixteenNote,positionSteps=Math.floor(positionStepsRaw);return{step:positionSteps/4-.25,offset:sixteenNote*(positionStepsRaw-positionSteps)}},MidiPattern.prototype.addNote=function(noteNumber,velocity,step,duration,offset){this.addSingleEvent("noteOn",noteNumber,velocity,step,offset);var noteOffStep=step+duration;noteOffStep>this.length&&(noteOffStep-=this.length),this.addSingleEvent("noteOff",noteNumber,velocity,noteOffStep,offset)},MidiPattern.prototype.addSingleEvent=function(type,noteNumber,velocity,step,offset){this._updatedClips.push({event:{type:"channel",subtype:type,noteNumber:noteNumber,velocity:velocity},step:step,offset:offset||0}),this._updatedClips.sort((function(a,b){return a.step-b.step}))},MidiPattern.prototype.setData=function(data){_super.prototype.setData.call(this,data);var reinit=!1;if(this._beatSubscription=void 0===data.beat_subscription?.25:data.beat_subscription,this._midiFile!=data.file_id&&(this._midiFile=data.file_id),this._midiTrackIx!=data.midi_track&&(this._midiTrackIx=data.midi_track),void 0!==data.sequener&&this._sequencerName!=data.sequencer&&(this._sequencerName=data.sequencer,reinit=!0),void 0!==data.synth&&this._synthName!=data.synth&&(this._synthName=data.synth,reinit=!0),data.clips&&(this._clips=data.clips),this._loop=void 0!==data.loop&&data.loop,this._length=void 0===data.length?0:data.length,this._root=void 0===data.root?0:data.root,this._orgTranspose=void 0===data.transpose?0:data.transpose,this._transpose=this._orgTranspose,this._orgScale=void 0===data.scale?0:data.scale,this._scale=this._orgScale,this._rootNote=void 0===data.root_note?36:data.root_note,this._activeUpbeat=-1,data.upbeats){this._upbeats=[],this._upbeatLoopOffset=0;for(var ix=0,len=data.upbeats.length;ix<len;ix++)this._upbeats.push({length:data.upbeats[ix].length,step:data.upbeats[ix].step,targetStep:data.upbeats[ix].target_step,playInLoop:data.upbeats[ix].play_in_loop});reinit=!0}reinit&&(this._sequencer.unregisterPattern(this),this.init())},MidiPattern}(Klang.Model.Audio);return Klang.Model.MidiPattern=MidiPattern})),Module((function(Klang){function Effect(data){this.active=!0,this._type=data.type,this._output&&this.disconnect(),this._input=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._output=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),!1===data.active&&(this.active=!1)}return Effect.prototype.connect=function(destination){return this._output.connect(destination),this},Effect.prototype.disconnect=function(){return this._output.disconnect(),this},Effect.prototype.setActive=function(state){return Klang.warn("Effect: Invocation of abstract method: Effect.setActive in",this),this},Object.defineProperty(Effect.prototype,"input",{get:function(){return this._input},enumerable:!0,configurable:!0}),Object.defineProperty(Effect.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0}),Klang.Model.Effect=Effect})),Module((function(Klang){var EffectSend=function(_super){function EffectSend(data){_super.call(this,data),this._wet=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._wet.gain.setValueAtTime(data.wet,Klang.context.currentTime),this._input.connect(this._wet),this._input.connect(this._output),this.destinationName=data.destination_name,Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Klang.Util.__extends(EffectSend,_super),EffectSend.prototype.init=function(){var destination=Klang.core.Core.instance.findInstance(this.destinationName);destination&&this._wet.connect(destination.input)},EffectSend.prototype.setActive=function(state){return this._input.disconnect(),state?(this._input.connect(this._wet),this._input.connect(this._output)):this._input.connect(this._output),this},Object.defineProperty(EffectSend.prototype,"wet",{get:function(){return this._wet.gain},enumerable:!0,configurable:!0}),EffectSend.prototype.setData=function(data){void 0!==data.wet&&(this.wet.value=data.wet),data.destination_name!=this.destinationName&&(this.destinationName=data.destination_name,this._wet.disconnect(),this.init())},EffectSend}(Klang.Model.Effect);return Klang.Model.EffectSend=EffectSend})),Module((function(Klang){var Equalizer=function(_super){function Equalizer(data){if(_super.call(this,data),this._filters=[],"Firefox"!=Klang.detector.browser.name)if(0==data.bands.length)Klang.warn("Equalizer: No bands specified"),this._input.connect(this.output);else{for(var ix=0,len=data.bands.length;ix<len;ix++){var band=data.bands[ix],filter=Klang.context.createBiquadFilter();band.filter_type&&(filter.type=Klang.Util.safeFilterType(band.filter_type)),band.frequency&&(filter.frequency.value=band.frequency),band.gain&&(filter.gain.value=band.gain),band.Q&&(filter.Q.value=band.Q),0==ix?this._input.connect(filter):this._filters[ix-1].connect(filter),this._filters.push(filter)}this._filters[this._filters.length-1].connect(this._output)}else this._input.connect(this._output)}return Klang.Util.__extends(Equalizer,_super),Equalizer.prototype.addFilter=function(type,frequency,q,gain){var filter=Klang.context.createBiquadFilter();filter.type=type,filter.frequency.value=frequency,filter.gain.value=gain,filter.Q.value=q,0==this._filters.length?(this._input.disconnect(),this._input.connect(filter)):(this._filters[this._filters.length-1].disconnect(),this._filters[this._filters.length-1].connect(filter)),filter.connect(this.output),this._filters.push(filter)},Equalizer.prototype.removeFilter=function(index){this._filters[index].disconnect(),0==index&&this._filters.length>1?(this._input.disconnect(),this._input.connect(this._filters[1])):0==index?(this._input.disconnect(),this._input.connect(this._output)):index==this._filters.length-1?(this._filters[index-1].disconnect(),this._filters[index-1].connect(this._output)):(this._filters[index-1].disconnect(),this._filters[index-1].connect(this._filters[index+1])),this._filters.splice(index,1)},Equalizer.prototype.setActive=function(state){return this._input.disconnect(),state?0==this._filters.length?this._input.connect(this._output):this._input.connect(this._filters[0]):this._input.connect(this._output),this},Object.defineProperty(Equalizer.prototype,"filters",{get:function(){return this._filters},enumerable:!0,configurable:!0}),Equalizer.prototype.setData=function(data){for(var ix=0,len=this._filters.length;ix<len;ix++){var filterData=data.bands[ix],filter=this._filters[ix];if(filter&&filterData){filter.frequency.value=filterData.frequency,filter.Q.value=filterData.Q,filter.gain.value=filterData.gain;var newType=Klang.Util.safeFilterType(filterData.filter_type);filter.type!=newType&&(filter.type=newType)}}},Equalizer}(Klang.Model.Effect);return Klang.Model.Equalizer=Equalizer})),Module((function(Klang){var BiquadFilter=function(_super){function BiquadFilter(data){_super.call(this,data),this.init(data)}return Klang.Util.__extends(BiquadFilter,_super),BiquadFilter.prototype.init=function(data){this._data=data,this._filter=Klang.context.createBiquadFilter(),this._filter.type=Klang.Util.safeFilterType(data.filter_type),this._input.connect(this._filter),this._filter.connect(this._output);var _filterStartFreq=void 0!==data.frequency?data.frequency:1e3;this._filter.frequency.setValueAtTime(_filterStartFreq,Klang.context.currentTime);var _filterStartQ=void 0!==data.Q?data.Q:1;this._filter.Q.setValueAtTime(_filterStartQ,Klang.context.currentTime);var _filterStartGain=void 0!==data.gain?data.gain:0;this._filter.gain.setValueAtTime(_filterStartGain,Klang.context.currentTime)},BiquadFilter.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._filter):this._input.connect(this._output),this},Object.defineProperty(BiquadFilter.prototype,"frequency",{get:function(){return this._filter.frequency},enumerable:!0,configurable:!0}),Object.defineProperty(BiquadFilter.prototype,"Q",{get:function(){return this._filter.Q},enumerable:!0,configurable:!0}),Object.defineProperty(BiquadFilter.prototype,"gain",{get:function(){return this._filter.gain},enumerable:!0,configurable:!0}),BiquadFilter.prototype.refreshAudioNodes=function(){var fValue=this._filter.frequency.value,qValue=this._filter.Q.value,gValue=this._filter.gain.value;this._filter.frequency.cancelScheduledValues(Klang.context.currentTime),this._filter.Q.cancelScheduledValues(Klang.context.currentTime),this._filter.gain.cancelScheduledValues(Klang.context.currentTime),this._filter.disconnect(),this.init(this._data),this._filter.frequency.value=fValue,this._filter.Q.value=qValue,this._filter.gain.value=gValue},BiquadFilter.prototype.setData=function(data){void 0===data.filter_type&&(data.filter_type="lowpass"),this._filter.type!=data.filter_type&&(this._filter.type=Klang.Util.safeFilterType(data.filter_type)),this._filter.frequency.value=void 0===data.frequency?1e3:data.frequency,this._filter.Q.value=void 0===data.Q?1:data.Q,this._filter.gain.value=void 0===data.gain?0:data.gain},BiquadFilter}(Klang.Model.Effect);return Klang.Model.BiquadFilter=BiquadFilter})),Module((function(Klang){var Bitcrusher=function(_super){function Bitcrusher(data){_super.call(this,data),this._pro=Klang.context.createScriptProcessor(data.buffer_size||4096,2,2);var _this=this;this._pro.onaudioprocess=function(e){for(var inp=e.inputBuffer,out=e.outputBuffer,iL=inp.getChannelData(0),iR=inp.getChannelData(1),oL=out.getChannelData(0),oR=out.getChannelData(1),step=Math.pow(.5,_this._bits),len=inp.length,sample=0,lastL=0,lastR=0,i=0;i<len;++i)(sample+=_this._reduction)>=1&&(sample--,lastL=step*Math.floor(iL[i]/step),lastR=step*Math.floor(iR[i]/step)),oL[i]=lastL,oR[i]=lastR},this._bits=data.bits||4,this._reduction=data.reduction||.2,this._input.connect(this._pro),this._pro.connect(this._output)}return Klang.Util.__extends(Bitcrusher,_super),Bitcrusher.prototype.setActive=function(state){return this._input.disconnect(),state?(this._input.connect(this._pro),this._input.connect(this._output)):this._input.connect(this._output),this},Object.defineProperty(Bitcrusher.prototype,"bits",{get:function(){return this._bits},set:function(value){this._bits=value},enumerable:!0,configurable:!0}),Object.defineProperty(Bitcrusher.prototype,"reduction",{get:function(){return this._reduction},set:function(value){this._reduction=value},enumerable:!0,configurable:!0}),Bitcrusher.prototype.setData=function(data){this._bits=void 0!==data.bits?data.bits:4,this._reduction=void 0!==data.reduction?data.reduction:.2},Bitcrusher}(Klang.Model.Effect);return Klang.Model.Bitcrusher=Bitcrusher})),Module((function(Klang){var Compressor=function(_super){function Compressor(data){_super.call(this,data),this._bypass=data.bypass,Klang.isMobile?this._input.connect(this._output):(this._dynamicsCompressor=Klang.context.createDynamicsCompressor(),this._makeUpGain=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._input.connect(this._dynamicsCompressor),this._dynamicsCompressor.connect(this._makeUpGain),this._makeUpGain.connect(this._output),this._bypass&&(this._input.connect(this._output),this._makeUpGain.gain.value=0),this._dynamicsCompressor.threshold.value=data.threshold||this._dynamicsCompressor.threshold.value,this._dynamicsCompressor.knee.value=data.knee||this._dynamicsCompressor.knee.value,this._dynamicsCompressor.ratio.value=data.ratio||this._dynamicsCompressor.ratio.value,this._dynamicsCompressor.attack.value=data.attack||this._dynamicsCompressor.attack.value,this._dynamicsCompressor.release.value=data.release||this._dynamicsCompressor.release.value,this._makeUpGain.gain.value=data.make_up_gain||this._makeUpGain.gain.value)}return Klang.Util.__extends(Compressor,_super),Compressor.prototype.setActive=function(state){return this._input.disconnect(),state?(this._input.connect(this._dynamicsCompressor),this._bypass&&this._input.connect(this._output)):this._input.connect(this._output),this},Object.defineProperty(Compressor.prototype,"threshold",{get:function(){return this._dynamicsCompressor.threshold},enumerable:!0,configurable:!0}),Object.defineProperty(Compressor.prototype,"knee",{get:function(){return this._dynamicsCompressor.knee},enumerable:!0,configurable:!0}),Object.defineProperty(Compressor.prototype,"ratio",{get:function(){return this._dynamicsCompressor.ratio},enumerable:!0,configurable:!0}),Object.defineProperty(Compressor.prototype,"attack",{get:function(){return this._dynamicsCompressor.attack},enumerable:!0,configurable:!0}),Object.defineProperty(Compressor.prototype,"release",{get:function(){return this._dynamicsCompressor.release},enumerable:!0,configurable:!0}),Object.defineProperty(Compressor.prototype,"reduction",{get:function(){return this._dynamicsCompressor.reduction},enumerable:!0,configurable:!0}),Object.defineProperty(Compressor.prototype,"makeUpGain",{get:function(){return this._makeUpGain.gain},enumerable:!0,configurable:!0}),Compressor.prototype.setData=function(data){void 0!==data.threshold&&(this.threshold.value=data.threshold),void 0!==data.knee&&(this.knee.value=data.knee),void 0!==data.ratio&&(this.ratio.value=data.ratio),void 0!==data.attack&&(this.attack.value=data.attack),void 0!==data.release&&(this.release.value=data.release),void 0!==data.make_up_gain&&(this.makeUpGain.value=data.make_up_gain)},Compressor}(Klang.Model.Effect);return Klang.Model.Compressor=Compressor})),Module((function(Klang){var Convolver=function(_super){function Convolver(data){_super.call(this,data),this._soundName=data.sound,this._convolver=Klang.context.createConvolver(),this._wetGain=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._dryGain=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._wetGain.gain.value=1,this._dryGain.gain.value=0,this._wetGain.connect(this._convolver),this._dryGain.connect(this._output),this._input.connect(this._wetGain),this._input.connect(this._dryGain),this._convolver.connect(this._output),Klang.core.Core.instance.pushToPostLoadInitStack(this)}return Klang.Util.__extends(Convolver,_super),Convolver.prototype.dryWet=function(mix){mix=Math.max(0,Math.min(1,mix)),this._wetGain.gain.value=mix,this._dryGain.gain.value=1-mix},Convolver.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._convolver):this._input.connect(this._output),this},Convolver.prototype.init=function(){var soundInstance=Klang.core.Core.instance.findInstance(this._soundName);this._convolver.buffer=soundInstance.buffer},Convolver.prototype.setData=function(data){data.sound&&data.sound!=this._soundName&&(this._soundName=data.sound,this.init())},Convolver}(Klang.Model.Effect);return Klang.Model.Convolver=Convolver})),Module((function(Klang){var DelayBase=function(_super){function DelayBase(data){_super.call(this,data),this._sync=data.sync}return Klang.Util.__extends(DelayBase,_super),DelayBase.prototype.init=function(){if(this._sync){var seq=Klang.core.Core.instance.findInstance(this._sync);this.updateSync(seq.bpm),seq.registerBPMSync(this)}},DelayBase.prototype.setSync=function(sequencer,rate){return sequencer?(this._sync=sequencer,this._syncResolution=rate||1,this.init()):(this._sync=null,this._syncResolution=null),this},DelayBase.prototype.setSyncRate=function(rate){return this._sync&&(this._syncResolution=rate,this.updateSync(Klang.core.Core.instance.findInstance(this._sync).bpm)),this},DelayBase.prototype.updateSync=function(bpm){return Klang.warn("DelayBase: Invocation of abstract method: DelayBase.updateSync in",this),this},Object.defineProperty(DelayBase.prototype,"sync",{get:function(){return this._sync},enumerable:!0,configurable:!0}),Object.defineProperty(DelayBase.prototype,"syncResolution",{get:function(){return this._syncResolution},set:function(value){this._syncResolution=value},enumerable:!0,configurable:!0}),DelayBase}(Klang.Model.Effect);return Klang.Model.DelayBase=DelayBase})),Module((function(Klang){var Delay=function(_super){function Delay(data){_super.call(this,data),this._feedback=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._delay=Klang.context.createDelay(),data.filter?(this._filter=Klang.context.createBiquadFilter(),this._input.connect(this._filter),this._filter.connect(this._delay),this._filter.type=Klang.Util.safeFilterType(data.filter.filter_type),this._filter.frequency.value=data.filter.frequency||1e3,this._filter.Q.value=data.filter.Q||4,this._filter.gain.value=data.filter.gain||1):this._input.connect(this._delay),this._delay.connect(this._feedback),this._delay.connect(this._output),this._feedback.connect(this._delay),this.sync?(Klang.core.Core.instance.pushToPreLoadInitStack(this),this.syncResolution=data.delay_time||1):this._delay.delayTime.value=data.delay_time||.125,this._feedback.gain.value=data.feedback||.3,this._output.gain.value=data.output_vol||data.wet||1}return Klang.Util.__extends(Delay,_super),Delay.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._delay):this._input.connect(this._output),this},Delay.prototype.updateSync=function(bpm){return this._delay.delayTime.value=60/bpm*this.syncResolution,this},Object.defineProperty(Delay.prototype,"delayTime",{get:function(){return this._delay.delayTime},enumerable:!0,configurable:!0}),Object.defineProperty(Delay.prototype,"feedback",{get:function(){return this._feedback.gain},enumerable:!0,configurable:!0}),Object.defineProperty(Delay.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0}),Delay.prototype.setData=function(data){data.feedback&&(this._feedback.gain.value=data.feedback),data.sync?this.setSync(data.sync,data.delay_time):data.delay_time&&(this._delay.delayTime.value=data.delay_time),data.filter?(this._filter||(this.input.disconnect(),this._filter=Klang.context.createBiquadFilter(),this.input.connect(this._filter),this._filter.connect(this._delay)),void 0!==data.filter.filter_type&&(this._filter.type=Klang.Util.safeFilterType(data.filter.filter_type)),void 0!==data.filter.frequency&&(this._filter.frequency.value=data.filter.frequency),void 0!==data.filter.Q&&(this._filter.Q.value=data.filter.Q),void 0!==data.filter.gain&&(this._filter.gain.value=data.filter.gain)):this._filter&&(this.input.disconnect(),this._filter.disconnect(),this.input.connect(this._delay),this._filter=null)},Delay}(Klang.Model.DelayBase);return Klang.Model.Delay=Delay})),Module((function(Klang){var StereoDelay=function(_super){function StereoDelay(data){_super.call(this,data),this.sync&&(data.left.sync=this.sync,data.right.sync=this.sync),this._splitter=Klang.context.createChannelSplitter(2),this._merger=Klang.context.createChannelMerger(2),this._leftDelay=Klang.context.createDelay(),this._rightDelay=Klang.context.createDelay(),this._input.connect(this._splitter),this._splitter.connect(this._leftDelay,0,0),this._splitter.connect(this._rightDelay,0,0),this._splitter.connect(this._rightDelay,1,0),this._leftDelay.connect(this._merger,0,0),this._rightDelay.connect(this._merger,0,1),this._merger.connect(this._output)}return Klang.Util.__extends(StereoDelay,_super),StereoDelay.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._splitter):this._input.connect(this._output),this},StereoDelay.prototype.updateSync=function(bpm){return this._leftDelay.updateSync(bpm),this._rightDelay.updateSync(bpm),this},Object.defineProperty(StereoDelay.prototype,"leftDelay",{get:function(){return this._leftDelay},enumerable:!0,configurable:!0}),Object.defineProperty(StereoDelay.prototype,"rightDelay",{get:function(){return this._rightDelay},enumerable:!0,configurable:!0}),StereoDelay.prototype.setData=function(data){this._leftDelay.setData(data.left),this._rightDelay.setData(data.right)},StereoDelay}(Klang.Model.DelayBase);return Klang.Model.StereoDelay=StereoDelay})),Module((function(Klang){var PingPongDelay=function(_super){function PingPongDelay(data){if(_super.call(this,data),this._splitter=Klang.context.createChannelSplitter(2),this._merger=Klang.context.createChannelMerger(2),this._mono=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._leftDelay=Klang.context.createDelay(),this._rightDelay=Klang.context.createDelay(),this._feedback=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),data.filter?(this._filter=Klang.context.createBiquadFilter(),this._mono.connect(this._filter),this._filter.connect(this._leftDelay),this._feedback.connect(this._filter),this._filter.type=Klang.Util.safeFilterType(data.filter.filter_type),this._filter.frequency.value=data.filter.frequency||1e3,this._filter.Q.value=data.filter.Q||4,this._filter.gain.value=data.filter.gain||1):(this._mono.connect(this._leftDelay),this._feedback.connect(this._leftDelay)),this._input.connect(this._splitter),this._splitter.connect(this._mono,0,0),this._splitter.connect(this._mono,1,0),this._leftDelay.connect(this._rightDelay),this._rightDelay.connect(this._feedback),this._leftDelay.connect(this._merger,0,0),this._rightDelay.connect(this._merger,0,1),this._merger.connect(this._output),this.sync)Klang.core.Core.instance.pushToPreLoadInitStack(this),this.syncResolution=data.delay_time||1;else{var _delayStartTime=data.delay_time||.125;this._leftDelay.delayTime.setValueAtTime(_delayStartTime,Klang.context.currentTime),this._rightDelay.delayTime.setValueAtTime(_delayStartTime,Klang.context.currentTime)}var _startFeedback=data.feedback||.3;this._feedback.gain.setValueAtTime(_startFeedback,Klang.context.currentTime);var _startOutput=data.output_vol||data.wet||1;this._output.gain.setValueAtTime(_startOutput,Klang.context.currentTime)}return Klang.Util.__extends(PingPongDelay,_super),PingPongDelay.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._splitter):this._input.connect(this._output),this},PingPongDelay.prototype.updateSync=function(bpm){return this._leftDelay.delayTime.value=60/bpm*this.syncResolution,this._rightDelay.delayTime.value=this._leftDelay.delayTime.value,this},Object.defineProperty(PingPongDelay.prototype,"delay_time",{set:function(val){this._leftDelay.delayTime.value=val,this._rightDelay.delayTime.value=val},enumerable:!0,configurable:!0}),Object.defineProperty(PingPongDelay.prototype,"feedback",{get:function(){return this._feedback.gain},enumerable:!0,configurable:!0}),Object.defineProperty(PingPongDelay.prototype,"filter",{get:function(){return this._filter},enumerable:!0,configurable:!0}),PingPongDelay.prototype.setData=function(data){data.feedback&&(this._feedback.gain.value=data.feedback),data.sync?this.setSync(data.sync,data.delay_time):data.delay_time&&(this._leftDelay.delayTime.value=data.delay_time,this._rightDelay.delayTime.value=data.delay_time),data.filter?(this._filter||(this._mono.disconnect(),this._feedback.disconnect(),this._filter=Klang.context.createBiquadFilter(),this._mono.connect(this._filter),this._filter.connect(this._leftDelay),this._feedback.connect(this._filter)),void 0!==data.filter.filter_type&&(this._filter.type=Klang.Util.safeFilterType(data.filter.filter_type)),void 0!==data.filter.frequency&&(this._filter.frequency.value=data.filter.frequency),void 0!==data.filter.Q&&(this._filter.Q.value=data.filter.Q),void 0!==data.filter.gain&&(this._filter.gain.value=data.filter.gain)):this._filter&&(this._mono.disconnect(),this._feedback.disconnect(),this._filter.disconnect(),this._mono.connect(this._leftDelay),this._feedback.connect(this._leftDelay),this._filter=null)},PingPongDelay}(Klang.Model.DelayBase);return Klang.Model.PingPongDelay=PingPongDelay})),Module((function(Klang){var Limiter=function(_super){function Limiter(data){_super.call(this,data),this._compressor=Klang.context.createDynamicsCompressor(),this._preGain=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._postGain=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._input.connect(this._preGain),this._preGain.connect(this._compressor),this._compressor.connect(this._postGain),this._postGain.connect(this._output),this._compressor.threshold.value=data.threshold||0,this._compressor.knee.value=0,this._compressor.ratio.value=100,this._compressor.attack.value=0,this._compressor.release.value=0,this._preGain.gain.value=void 0===data.pre_gain?1:data.pre_gain,this._postGain.gain.value=void 0===data.post_gain?1:data.post_gain}return Klang.Util.__extends(Limiter,_super),Limiter.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._preGain):this._input.connect(this._output),this},Object.defineProperty(Limiter.prototype,"threshold",{get:function(){return this._compressor.threshold},enumerable:!0,configurable:!0}),Object.defineProperty(Limiter.prototype,"preGain",{get:function(){return this._preGain.gain},enumerable:!0,configurable:!0}),Object.defineProperty(Limiter.prototype,"postGain",{get:function(){return this._postGain.gain},enumerable:!0,configurable:!0}),Object.defineProperty(Limiter.prototype,"reduction",{get:function(){return this._compressor.reduction},enumerable:!0,configurable:!0}),Limiter.prototype.setData=function(data){void 0!==data.threshold&&(this._compressor.threshold.value=data.threshold),void 0!==data.pre_gain&&(this._preGain.gain.value=data.pre_gain),void 0!==data.post_gain&&(this._postGain.gain.value=data.post_gain)},Limiter}(Klang.Model.Effect);return Klang.Model.Limiter=Limiter})),Module((function(Klang){var Panner=function(_super){function Panner(data){_super.call(this,data),this.data=data,this._name=data.name,this._panner=Klang.context.createPanner(),this._input.connect(this._panner),this._panner.connect(this._output),void 0!==data.panning_model&&(this._panner.panningModel=data.panning_model),void 0!==data.distance_model&&(this._panner.distanceModel=data.distance_model),void 0!==data.ref_distance&&(this._panner.refDistance=data.ref_distance),void 0!==data.max_distance&&(this._panner.maxDistance=data.max_distance),void 0!==data.rolloff_factor&&(this._panner.rolloffFactor=data.rolloff_factor),void 0!==data.cone_inner_angle&&(this._panner.coneInnerAngle=data.cone_inner_angle),void 0!==data.cone_outer_angle&&(this._panner.coneOuterAngle=data.cone_outer_angle),void 0!==data.cone_outer_gain&&(this._panner.coneOuterGain=data.cone_outer_gain),void 0!==data.position&&this._panner.setPosition(data.position[0],data.position[1],data.position[2]),void 0!==data.orientation&&this._panner.setOrientation(data.position[0],data.position[1],data.position[2]),Panner.panners[this._name]=this}return Klang.Util.__extends(Panner,_super),Panner.panners={},Panner._scale=1,Panner.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._panner):this._input.connect(this._output),this},Panner.prototype.setPosition=function(x,y,z){this._panner.setPosition(x*Panner.scale,y*Panner.scale,z*Panner.scale)},Panner.prototype.setOrientation=function(x,y,z){this._panner.setOrientation(x,y,z)},Panner.prototype.setVelocity=function(x,y,z){Klang.warn("setVelocity is removed from Klang and the WebAudio API")},Panner.prototype.setData=function(data){this._panner.setPosition(data.position[0],data.position[1],data.position[2]),this._panner.setOrientation(data.position[0],data.position[1],data.position[2]),void 0!==data.panning_model&&(this._panner.panningModel=data.panning_model),void 0!==data.distance_model&&(this._panner.distanceModel=data.distance_model),void 0!==data.ref_distance&&(this._panner.refDistance=data.ref_distance),void 0!==data.max_distance&&(this._panner.maxDistance=data.max_distance),void 0!==data.rolloff_factor&&(this._panner.rolloffFactor=data.rolloff_factor),void 0!==data.cone_inner_angle&&(this._panner.coneInnerAngle=data.cone_inner_angle),void 0!==data.cone_outer_angle&&(this._panner.coneOuterAngle=data.cone_outer_angle),void 0!==data.cone_outer_gain&&(this._panner.coneOuterGain=data.cone_outer_gain)},Object.defineProperty(Panner,"listener",{get:function(){return Klang.context.listener},enumerable:!0,configurable:!0}),Panner.setListenerPosition=function(x,y,z){Klang.context.listener.setPosition(x*Panner.scale,y*Panner.scale,z*Panner.scale)},Panner.setListenerOrientation=function(x,y,z,xUp,yUp,zUp){Klang.context.listener.setOrientation(x,y,z,xUp,yUp,zUp)},Panner.setListenerVelocity=function(x,y,z){Klang.warn("setListenerVelocity is removed from Klang and the WebAudio API")},Panner.setDopplerFactor=function(factor){Klang.warn("setDopplerFactor is removed from Klang and the WebAudio API")},Panner.setSpeedOfSound=function(speed){Klang.context.listener.speed=speed},Panner.setListenerData=function(data){data&&(Panner.scale=data.scale,Panner.setListenerPosition(data.position[0],data.position[1],data.position[2]),Panner.setListenerOrientation(data.orientation[0],data.orientation[1],data.orientation[2],data.orientation_up[0],data.orientation_up[1],data.orientation_up[2]),Panner.setSpeedOfSound(data.speed_of_sound))},Panner.get=function(name){return Panner.panners[name]},Object.defineProperty(Panner,"scale",{get:function(){return Panner._scale},set:function(scale){Panner._scale=scale},enumerable:!0,configurable:!0}),Panner}(Klang.Model.Effect);return Klang.Model.Panner=Panner})),Module((function(Klang){var Sidechain=function(_super){function Sidechain(data){_super.call(this,data),this._source=data.source,this._gain=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._processor=Klang.context.createScriptProcessor(data.buffer_size||0);var _this=this,reductionIsAudioParameter="number"!=typeof this._source.reduction;this._processor.onaudioprocess=function(){var reduction=reductionIsAudioParameter?_this._source.reduction.value:_this._source.reduction;_this._gain.gain.value=0===reduction?1:Math.pow(10,reduction/20)},this._input.connect(this._gain),this._input.connect(this._processor),this._processor.connect(Klang.context.destination),this._gain.connect(this._output),Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Klang.Util.__extends(Sidechain,_super),Sidechain.prototype.init=function(){this._source&&this._source.bus&&void 0!==this._source.index||Klang.warn("Sidechain: No source specified");var bus=Klang.core.Core.instance.findInstance(this._source.bus);this._source=bus._effects[this._source.index]},Sidechain.prototype.setActive=function(state){return this._input.disconnect(),state?(this._input.connect(this._gain),this._input.connect(this._processor)):this._input.connect(this._output),this},Sidechain}(Klang.Model.Effect);return Klang.Model.Sidechain=Sidechain})),Module((function(Klang){var StereoPannerPolyfill=function(_super){function StereoPannerPolyfill(data){_super.call(this,data),this._splitter=Klang.context.createChannelSplitter(2),this._merger=Klang.context.createChannelMerger(2),this._left=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._right=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._input.connect(this._splitter),this._splitter.connect(this._left,0,0),this._splitter.connect(this._right,1,0),this._left.connect(this._merger,0,0),this._right.connect(this._merger,0,1),this._merger.connect(this._output),this.pan=data.pan}return Klang.Util.__extends(StereoPannerPolyfill,_super),StereoPannerPolyfill.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._splitter):this._input.connect(this._output),this},StereoPannerPolyfill.prototype.getGainValue=function(value){return(value+1)/2},StereoPannerPolyfill.prototype.setPanTo=function(value,when){var gainValue=this.getGainValue(value);return this._left.gain.setValueAtTime(1-gainValue,when||0),this._right.gain.setValueAtTime(gainValue,when||0),this},StereoPannerPolyfill.prototype.linPanTo=function(value,duration,when){when=when||Klang.context.currentTime;var gainValue=this.getGainValue(value);return this._left.gain.setValueAtTime(this._left.gain.value,when),this._left.gain.linearRampToValueAtTime(1-gainValue,when+duration),this._right.gain.setValueAtTime(this._right.gain.value,when),this._right.gain.linearRampToValueAtTime(gainValue,when+duration),this},StereoPannerPolyfill.prototype.expPanTo=function(value,duration,when){when=when||Klang.context.currentTime;var gainValue=this.getGainValue(value);return this._left.gain.setValueAtTime(0==this._left.gain.value?Klang.Util.EXP_MIN_VALUE:this._left.gain.value,when),this._left.gain.exponentialRampToValueAtTime(1-gainValue,when+duration),this._right.gain.setValueAtTime(0==this._right.gain.value?Klang.Util.EXP_MIN_VALUE:this._right.gain.value,when),this._right.gain.exponentialRampToValueAtTime(gainValue,when+duration),this},Object.defineProperty(StereoPannerPolyfill.prototype,"pan",{get:function(){return this._right.gain.value},set:function(value){var gainValue=this.getGainValue(value);this._left.gain.value=1-gainValue,this._right.gain.value=gainValue},enumerable:!0,configurable:!0}),StereoPannerPolyfill.prototype.setData=function(data){void 0!==data.pan&&(this.pan=data.pan)},StereoPannerPolyfill}(Klang.Model.Effect),StereoPanner=function(_super){if(window.AudioContext&&void 0===window.AudioContext.prototype.createStereoPanner)return StereoPannerPolyfill;function StereoPanner(data){_super.call(this,data),this._panner=Klang.context.createStereoPanner(),this._panner.pan.setValueAtTime(data.pan,Klang.context.currentTime),this._input.connect(this._panner),this._panner.connect(this._output)}return Klang.Util.__extends(StereoPanner,_super),StereoPanner.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._splitter):this._input.connect(this._output),this},StereoPanner.prototype.getGainValue=function(value){return value},StereoPanner.prototype.setPanTo=function(value,when){return when=Math.max(when||0,Klang.context.currentTime),this._panner.pan.cancelScheduledValues(when),this._panner.pan.setValueAtTime(value,when),this},StereoPanner.prototype.linPanTo=function(value,duration,when){return when=Math.max(when||0,Klang.context.currentTime),this._panner.pan.cancelScheduledValues(when),this._panner.pan.setValueAtTime(this._panner.pan.value,when),this._panner.pan.linearRampToValueAtTime(value,when+duration),this},StereoPanner.prototype.expPanTo=function(value,duration,when){return when=when||Klang.context.currentTime,value=Klang.Util.clamp(value,-.99,.99),this._panner.pan.setValueAtTime(0==this._panner.pan.value?Klang.Util.EXP_MIN_VALUE:this._panner.pan.value,when),this._panner.pan.exponentialRampToValueAtTime(value,when+duration),this},StereoPanner.prototype.refreshAudioNodes=function(){var panValue=this._panner.pan.value;this._panner.pan.cancelScheduledValues(Klang.context.currentTime),this._panner.disconnect(),this._panner=Klang.context.createStereoPanner(),this._panner.pan.value=panValue,this._input.connect(this._panner),this._panner.connect(this._output)},Object.defineProperty(StereoPanner.prototype,"pan",{get:function(){return this._panner.pan.value},set:function(value){this._panner.pan.value=value},enumerable:!0,configurable:!0}),StereoPanner.prototype.setData=function(data){void 0!==data.pan&&(this.pan=data.pan)},StereoPanner}(Klang.Model.Effect);return Klang.Model.StereoPanner=StereoPanner})),Module((function(Klang){var Tremolo=function(_super){function Tremolo(data,startTime){_super.call(this,data),data.sync&&(this._sync=data.sync,this._rate=data.rate||.25),this._oscillator=Klang.context.createOscillator(),this._amplitude=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._input.connect(this._output),this._oscillator.connect(this._amplitude),this._amplitude.connect(this._output.gain),this._oscillator.frequency.value=data.frequency||10,this._oscillator.type=data.wave||0,this._amplitude.gain.value=data.amplitude||1,this._oscillator.start(startTime),Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Klang.Util.__extends(Tremolo,_super),Tremolo.prototype.init=function(){if(this._sync){var seq=Klang.core.Core.instance.findInstance(this._sync);this.updateSync(seq.bpm),seq.registerBPMSync(this)}},Tremolo.prototype.setActive=function(state){return state?this._amplitude.connect(this._output.gain):this._amplitude.disconnect(),this},Tremolo.prototype.updateSync=function(bpm){return this._oscillator.frequency.value=bpm/60/this._rate,this},Object.defineProperty(Tremolo.prototype,"frequency",{get:function(){return this._oscillator.frequency},enumerable:!0,configurable:!0}),Object.defineProperty(Tremolo.prototype,"amplitude",{get:function(){return this._amplitude.gain},enumerable:!0,configurable:!0}),Tremolo.prototype.setData=function(data){void 0!==data.amplitude&&(this.amplitude.value=data.amplitude),void 0!==data.wave&&(this._oscillator.type=data.wave),data.sync?(this._sync=data.sync,this._rate=data.rate||.25,this.init()):void 0!==data.frequency&&(this.frequency.value=data.frequency)},Tremolo}(Klang.Model.Effect);return Klang.Model.Tremolo=Tremolo})),Module((function(Klang){var Distortion=function(_super){function Distortion(data){_super.call(this,data),this._samples=8192,this._distortionType=data.distortion_type||0,this._amount=data.amount||.7,this._samples=8192,this._waveshaper=Klang.context.createWaveShaper(),this._inputDrive=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._outputDrive=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._input.connect(this._inputDrive),this._inputDrive.connect(this._waveshaper),this._waveshaper.connect(this._outputDrive),this._outputDrive.connect(this._output),this._ws_table=new Float32Array(this._samples),this.createWSCurve(this._distortionType,this._amount),this._inputDrive.gain.value=data.drive||.5,this._outputDrive.gain.value=data.outputGain||.5}return Klang.Util.__extends(Distortion,_super),Distortion.prototype.createWSCurve=function(type,amount){switch(type){case 0:var k=2*(amount=Math.min(amount,.9999))/(1-amount);for(i=0;i<this._samples;i++)x=2*i/this._samples-1,this._ws_table[i]=(1+k)*x/(1+k*Math.abs(x));break;case 1:for(i=0;i<this._samples;i++)x=2*i/this._samples-1,y=(.5*Math.pow(x+1.4,2)-1)*y>=0?5.8:1.2,this._ws_table[i]=this.tanh(y);break;case 2:var a=1-amount;for(i=0;i<this._samples;i++)y=(x=2*i/this._samples-1)<0?-Math.pow(Math.abs(x),a+.04):Math.pow(x,a),this._ws_table[i]=this.tanh(2*y);break;case 3:var y,abx;a=1-amount>.99?.99:1-amount;for(i=0;i<this._samples;i++)x=2*i/this._samples-1,(abx=Math.abs(x))<a?y=abx:abx>a?y=a+(abx-a)/(1+Math.pow((abx-a)/(1-a),2)):abx>1&&(y=abx),this._ws_table[i]=this.sign(x)*y*(1/((a+1)/2));break;case 4:for(i=0;i<this._samples;i++)x=2*i/this._samples-1,this._ws_table[i]=x<-.08905?-.75*(1-Math.pow(1-(Math.abs(x)-.032857),12)+1/3*(Math.abs(x)-.032847))+.01:x>=-.08905&&x<.320018?x*x*-6.153+3.9375*x:.630035;break;case 5:a=2+Math.round(14*amount);var i,x,bits=Math.round(Math.pow(2,a-1));for(i=0;i<this._samples;i++)x=2*i/this._samples-1,this._ws_table[i]=Math.round(x*bits)/bits}this._waveshaper.curve=this._ws_table},Distortion.prototype.tanh=function(n){return(Math.exp(n)-Math.exp(-n))/(Math.exp(n)+Math.exp(-n))},Distortion.prototype.sign=function(x){return 0===x?1:Math.abs(x)/x},Distortion.prototype.setActive=function(state){return this._input.disconnect(),state?this._input.connect(this._inputDrive):this._input.connect(this._output),this},Object.defineProperty(Distortion.prototype,"amount",{get:function(){return this._amount},set:function(val){this._amount=val,this.createWSCurve(this._distortionType,this._amount)},enumerable:!0,configurable:!0}),Object.defineProperty(Distortion.prototype,"distortionType",{get:function(){return this._distortionType},set:function(val){this._distortionType=val,this.createWSCurve(this._distortionType,this._amount)},enumerable:!0,configurable:!0}),Object.defineProperty(Distortion.prototype,"drive",{get:function(){return this._inputDrive.gain},enumerable:!0,configurable:!0}),Object.defineProperty(Distortion.prototype,"outputGain",{get:function(){return this._outputDrive.gain},enumerable:!0,configurable:!0}),Distortion.prototype.setData=function(data){void 0!==data.amount&&(this.amount=data.amount),void 0!==data.distortion_type&&(this.distortionType=data.distortion_type),void 0!==data.drive&&(this._inputDrive.gain.value=data.drive),void 0!==data.outputGain&&(this._outputDrive.gain.value=data.outputGain)},Distortion}(Klang.Model.Effect);return Klang.Model.Distortion=Distortion})),Module((function(Klang){function Synth(data,name){this._arpCounter=0,this._arpNoteLength=.5,this._arpPattern=[],this._arpPatternStep=0,this._name=name,this._type=data.type,this._output=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._output.gain.value=data.volume||1,data.destination_name&&(this.destinationName=data.destination_name,Klang.core.Core.instance.initComplete||Klang.core.Core.instance.pushToConnectStack(this)),data.arp?(this._arpMode=data.arp.arp_mode||"off",this._octaves=data.arp.octaves||1,this._sync=data.arp.sync,this._arpPattern=data.arp.arp_pattern||[]):this._arpMode="off",this._activeVoices=[],this._arpVoices=[],this._beatSubscription=data.beat_subscription||.25,this.data=data}return Synth.prototype.connect=function(destination){return this._output.connect(destination),this},Synth.prototype.disconnect=function(){return this._output.disconnect(),this},Synth.prototype.handleMidiEvent=function(event,when,transpose,bypassArp){return Klang.warn("Synth: Invocation of abstract method: Synth.handleMidiEvent in",this),this},Synth.prototype.stop=function(){Klang.warn("Synth: Invocation of abstract method: Synth.stop in",this)},Synth.prototype.handleArpModes=function(midiEvent){if(this._arpVoices=[],this._octaves>1){for(var octaves=[],j=0;j<this._octaves-1;j++)for(var i=0;i<this._activeVoices.length;i++){var e=this._activeVoices[i].midiEvent,note=e.noteNumber,ev={type:"channel",subtype:e.subtype,noteNumber:note+=12*(j+1),velocity:e.velocity,deltaTime:e.deltaTime};octaves.push({midiEvent:ev,transpose:this._activeVoices[i].transpose})}this._arpVoices=this._activeVoices.concat(octaves)}else this._arpVoices=this._activeVoices;if("up"===this._arpMode)this._arpVoices=this._arpVoices.sort(this.sortVoices);else if("down"===this._arpMode)this._arpVoices=this._arpVoices.sort(this.sortVoices),this._arpVoices.reverse();else if("up-down"===this._arpMode){var up=this._arpVoices.slice(0);up.sort(this.sortVoices);var down=this._arpVoices.slice(0);down.sort(this.sortVoices),down.reverse(),this._arpVoices=up.concat(down),this._arpVoices.length>1&&(this._arpVoices.splice(this._arpVoices.length/2,1),this._arpVoices.pop())}else"random"===this._arpMode&&(this._arpVoices=Klang.Util.shuffle(this._arpVoices))},Synth.prototype.sortVoices=function(a,b){return a.midiEvent.noteNumber<b.midiEvent.noteNumber?-1:a.midiEvent.noteNumber>b.midiEvent.noteNumber?1:0},Synth.prototype.arpActive=function(active){var seq;active?this._sync&&((seq=Klang.core.Core.instance.findInstance(this._sync)).registerSynth(this),seq._started||seq.start()):(this._arpMode="off",this._sync&&(seq=Klang.core.Core.instance.findInstance(this._sync)).unregisterSynth(this))},Synth.prototype.update=function(currentStep,scheduleTime){if(currentStep%this._beatSubscription==0){if(this._arpPatternStep=4*currentStep%this._arpPattern.length,0===this._arpVoices.length)return;if(this._arpPattern.length&&!this._arpPattern[4*currentStep%this._arpPattern.length])return;if(this._arpCounter++,this._arpCounter=this._arpCounter%this._arpVoices.length,this._arpCounter<this._arpVoices.length){var vel=this._fixedVelocities?this._fixedVelocities[this._arpCounter]:this._arpVoices[this._arpCounter].midiEvent.velocity;this._arpVoices[this._arpCounter].midiEvent.velocity=vel,this.handleMidiEvent(this._arpVoices[this._arpCounter].midiEvent,scheduleTime,this._arpVoices[this._arpCounter].transpose,!0);var noteOff={type:"channel",subtype:"noteOff",noteNumber:this._arpVoices[this._arpCounter].midiEvent.noteNumber,velocity:this._arpVoices[this._arpCounter].midiEvent.velocity,deltaTime:this._arpVoices[this._arpCounter].midiEvent.deltaTime};this.handleMidiEvent(noteOff,scheduleTime+this._arpNoteLength,this._arpVoices[this._arpCounter].transpose,!0)}}},Synth.prototype.deschedule=function(){return Klang.warn("Synth: Invocation of abstract method: Synth.deschedule in",this),this},Object.defineProperty(Synth.prototype,"arpCounter",{get:function(){return this._arpCounter},enumerable:!0,configurable:!0}),Object.defineProperty(Synth.prototype,"arpLength",{get:function(){return this._arpVoices.length},enumerable:!0,configurable:!0}),Object.defineProperty(Synth.prototype,"output",{get:function(){return this._output},enumerable:!0,configurable:!0}),Object.defineProperty(Synth.prototype,"arpPattern",{get:function(){return this._arpPattern},set:function(pattern){this._arpPattern=pattern},enumerable:!0,configurable:!0}),Object.defineProperty(Synth.prototype,"arpPatternStep",{get:function(){return this._arpPatternStep},enumerable:!0,configurable:!0}),Synth.prototype.setData=function(data){if(void 0!==data.volume&&(this.output.gain.value=data.volume),this.destinationName!=data.destination_name&&(this.destinationName=data.destination_name,this.disconnect(),this.connect(Klang.core.Core.instance.findInstance(this.destinationName).input)),data.arp){if(this._sync=data.arp.sync,this._octaves=data.arp.octaves,this._arpPattern=data.arp.arp_pattern,"off"==this._arpMode)(seq=Klang.core.Core.instance.findInstance(this._sync)).registerSynth(this),seq._started||seq.start();this._arpMode=data.arp.arp_mode}else{var seq;if(this._arpMode="off",this._sync)(seq=Klang.core.Core.instance.findInstance(this._sync)).unregisterSynth(this)}this.data=data},Klang.Model.Synth=Synth})),Module((function(Klang){function LFO(data,startTime){startTime=startTime||0,this._targets=data.targets,this._sync=data.sync,this._rate=data.rate||1,this._phaseVal=data.phase||0,this._oscillator=Klang.context.createOscillator(),this._oscillator.type=data.wave||"sine",this._oscillator.frequency.value=this._rate,this._amplitude=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._amplitude.gain.value=data.amplitude||1,this._phase=Klang.context.createDelay(),this._phase.delayTime.value=this._phaseVal*(1/this._oscillator.frequency.value),this._oscillator.connect(this._phase),this._phase.connect(this._amplitude),this._oscillator.start(startTime),Klang.core.Core.instance.pushToPreLoadInitStack(this)}return LFO.prototype.init=function(){if(this._sync){var seq=Klang.core.Core.instance.findInstance(this._sync);this.updateSync(seq.bpm),seq.registerBPMSync(this)}for(var ix=0,len=this._targets.length;ix<len;ix++){var t=this._targets[ix],effect=Klang.core.Core.instance.findInstance(t.bus).effects[t.effect];effect||Klang.warn("LFO: Effect index out of bounds: "+t.effect),effect[t.param]||Klang.warn("LFO: Parameter not recognized: "+t.param),this._amplitude.connect(effect[t.param])}},LFO.prototype.updateSync=function(bpm){return this._oscillator.frequency.value=bpm/60/this._rate,this._phase.delayTime.value=this._phaseVal*(1/this._oscillator.frequency.value),this},LFO.prototype.setData=function(data){this._oscillator.type=data.wave,this._oscillator.frequency.value=data.rate,this._phase.delayTime.value=data.phase*(1/this._oscillator.frequency.value),this._amplitude.gain.value=data.amplitude||1,data.targets&&(this._targets=data.targets,this.init()),this._sync!=data.sync&&(this._sync=data.sync,this.init())},Klang.Model.LFO=LFO})),Module((function(Klang){Klang.engines.webAudio.Util.generateNoiseBuffer=function(frames,alg){(alg<0||alg>3)&&Klang.warn("Synth: Invalid noise algorithm: "+alg);var sampleFrames=frames||65536,buffer=Klang.context.createBuffer(1,sampleFrames,Klang.context.sampleRate),bufferData=buffer.getChannelData(0);alg||(alg=0);for(var i=0;i<sampleFrames;i++)switch(alg){case 0:bufferData[i]=2*Math.random()-1;break;case 1:bufferData[i]=Math.random();break;case 2:bufferData[i]=Math.random()-1;break;case 3:bufferData[i]=i/sampleFrames}return buffer}})),Module((function(Klang){var audioUtil=Klang.engines.webAudio.Util,SympleVoice=function(){function SympleVoice(data,voiceType,filterData,startTime,noiseBuffer){this.filterStartFreq=-1,this._filterEnabled=!0,this.voiceType=voiceType,this.active=!1,this.activatedNote=-1,this._enabled=!0,this._detune=data.detune||0,this._wave=data.wave||"sine",this._frames=data.frames,this._algorithm=data.algorithm,noiseBuffer&&(this._noiseBuffer=noiseBuffer),this.gain=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),filterData||(filterData={frequency:22050,Q:1,filter_type:"lowpass"},this.filterEnabled=!1),this._filterData=filterData}return SympleVoice.prototype.noteOn=function(noteNumber,velocity,when,gainEG,filterEG,pitchEG,transpose){if(this.enabled){if("noise"!==this._wave?(this.source=Klang.context.createOscillator(),this.source.type=this._wave,this.source.detune.value=this._detune):"noise"==this._wave&&(this.source=Klang.context.createBufferSource(),this.source.buffer=this._noiseBuffer,this.source.loop=!0),this._envelope=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._filterData?(this.filter=Klang.context.createBiquadFilter(),this.filter.type=Klang.Util.safeFilterType(this._filterData.filter_type),this.filter.frequency.value=void 0===this._filterData.frequency?Klang.Util.NYQUIST_FREQUENCY:this._filterData.frequency,this.filter.detune&&(this.filter.detune.value=this._filterData.detune||0),this.filter.Q.value=this._filterData.Q||this.filter.Q.value,this.filter.gain.value=this._filterData.gain||this.filter.gain.value,this.filterTargetFreq=this.filter.frequency.value,this.source.connect(this.filter),this.filter.connect(this._envelope),this._envelope.connect(this.gain)):(this.source.connect(this._envelope),this._envelope.connect(this.gain)),1==this.voiceType&&this.filterAmplitudeGainNode.connect(this.filter.frequency),when<Klang.Util.now()&&(when=Klang.Util.now()),this.active=!0,this.activatedNote=noteNumber,"noise"!==this._wave){var pitchTargetFreq=Klang.Util.midiNoteToFrequency(noteNumber+transpose);if(pitchEG){var pitchStartFreq=-1;pitchEG.contour>0?pitchStartFreq=pitchTargetFreq*(1-pitchEG.contour):pitchEG.contour<0&&(pitchStartFreq=(Klang.Util.NYQUIST_FREQUENCY-pitchTargetFreq)*-pitchEG.contour+pitchTargetFreq),this.source.frequency.cancelScheduledValues(when),-1!=pitchStartFreq?(this.source.frequency.setValueAtTime(pitchStartFreq,when),Klang.safari?this.source.frequency.setTargetValueAtTime(pitchTargetFreq,when,pitchEG.decay):this.source.frequency.setTargetAtTime(pitchTargetFreq,when,pitchEG.decay)):this.source.frequency.setValueAtTime(pitchTargetFreq,when)}else this.source.frequency.setValueAtTime(pitchTargetFreq,when)}var vol;filterEG&&(this.filterStartFreq=-1,filterEG.contour<0?this.filterStartFreq=this.filterTargetFreq*(1+filterEG.contour)+1:filterEG.contour>0&&(this.filterStartFreq=(Klang.Util.NYQUIST_FREQUENCY-this.filterTargetFreq)*filterEG.contour+this.filterTargetFreq),-1!=this.filterStartFreq&&(this.filter.frequency.cancelScheduledValues(when),this.filter.frequency.setValueAtTime(this.filterStartFreq,when+1e-4),this.filter.frequency.exponentialRampToValueAtTime(this.filterTargetFreq,when+filterEG.attack),Klang.safari?this.filter.frequency.setTargetValueAtTime(this.filterTargetFreq*filterEG.sustain,when+filterEG.attack,filterEG.decay):this.filter.frequency.setTargetAtTime(this.filterTargetFreq*filterEG.sustain,when+filterEG.attack+1e-4,filterEG.decay))),vol="linear"===gainEG.volumeCurve?velocity/128:"exponential"===gainEG.volumeCurve?Math.abs(1-Math.exp(velocity/128)):1,gainEG?(this.gain.gain.cancelScheduledValues(when),this._envelope.gain.setValueAtTime(0,when),this._envelope.gain.linearRampToValueAtTime(vol,when+gainEG.attack),Klang.safari?this._envelope.gain.setTargetValueAtTime(vol*gainEG.sustain,when+gainEG.attack,gainEG.decay):this._envelope.gain.setTargetAtTime(vol*gainEG.sustain,when+gainEG.attack+1e-4,gainEG.decay)):this._envelope.gain.setValueAtTime(vol,when),this.source.startTime=when,Klang.safari?this.source.noteOn(when):this.source.start(when)}},SympleVoice.prototype.noteOff=function(noteNumber,when,gainEG,filterEG){this.enabled&&(when<Klang.Util.now()&&(when=Klang.Util.now()),this.active=!1,filterEG&&-1!=this.filterStartFreq&&(this.filter.frequency.cancelScheduledValues(when),when!=Klang.Util.now()?this.filter.frequency.setTargetAtTime(this.filterTargetFreq*filterEG.sustain,when,.1):this.filter.frequency.setValueAtTime(this.filter.frequency.value,when),Klang.safari?this.filter.frequency.setTargetValueAtTime(this.filterStartFreq,when,filterEG.release):this.filter.frequency.setTargetAtTime(this.filterStartFreq,when,filterEG.release)),gainEG?(this._envelope.gain.cancelScheduledValues(when),when!=Klang.Util.now()?this._envelope.gain.setTargetAtTime(gainEG.sustain,when,.1):this._envelope.gain.setValueAtTime(this._envelope.gain.value,when),Klang.safari?this._envelope.gain.setTargetValueAtTime(0,when,gainEG.release):this._envelope.gain.setTargetAtTime(0,when,gainEG.release)):this._envelope.gain.setValueAtTime(0,when),this.source.offTime=when,Klang.safari?this.source.noteOff(when+5*gainEG.release):this.source.stop(when+5*gainEG.release))},SympleVoice.prototype.stop=function(){this.filter.frequency.cancelScheduledValues(0),this._envelope.gain.cancelScheduledValues(0),this._envelope.gain.setValueAtTime(0,0),Klang.safari?this.source.noteOff(0):this.source.stop(0),this.source.disconnect(),this.filter&&this.filter.disconnect(),this._envelope&&this._envelope.disconnect()},SympleVoice.prototype.stopSoft=function(when,gainEG,filterEG){this.active=!1,this._envelope.gain.cancelScheduledValues(when),Klang.safari?this._envelope.gain.setTargetValueAtTime(0,when,gainEG.release):this._envelope.gain.setTargetAtTime(0,when,gainEG.release);var offTime=when+5*gainEG.release;Klang.safari?this.source.noteOff(offTime):this.source.stop(offTime);var _this=this;setTimeout((function(){_this.source.disconnect(),_this.filter&&_this.filter.disconnect(),_this._envelope&&_this._envelope.disconnect()}),1e3*(offTime-Klang.Util.now()))},Object.defineProperty(SympleVoice.prototype,"enabled",{get:function(){return this._enabled},set:function(state){this._enabled=state},enumerable:!0,configurable:!0}),Object.defineProperty(SympleVoice.prototype,"filterEnabled",{get:function(){return this._filterEnabled},set:function(state){this._filterEnabled=state,this.source&&(state?(this.source.disconnect(),this.source.connect(this.filter),this.filter.connect(this._envelope)):(this.source.disconnect(),this.filter.disconnect(),this.source.connect(this._envelope)))},enumerable:!0,configurable:!0}),SympleVoice}(),SympleOsc=function(){function SympleOsc(data,poly,filterData,startTime){this._enabled=!0,this.nextVoice=0,this.octave=data.octave||0,this.output=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this.output.gain.value=void 0===data.volume?1:data.volume,this._data=data,this._poly=poly,this._filterData=filterData,this.voices=[],this._noiseBuffer=audioUtil.generateNoiseBuffer(this._data._frames,this._data._algorithm)}return SympleOsc.prototype.noteOn=function(noteNumber,velocity,when,gainEG,filterEG,pitchEG,transpose){var v;this.enabled&&(this.voices.length==this._poly&&(this.voices[0].noteOff(noteNumber,when,gainEG,filterEG),this.voices.splice(0,1)),noteNumber+=12*this.octave,(v="noise"==this._data.wave?new SympleVoice(this._data,0,this._filterData,when,this._noiseBuffer):new SympleVoice(this._data,0,this._filterData,when,null)).gain.connect(this.output),v.noteOn(noteNumber,velocity,when,gainEG,filterEG,pitchEG,transpose),this.lfoPitchGainNode&&"noise"!=this._data.wave&&this.lfoPitchGainNode.connect(v.source.frequency),this.filterAmplitude&&v.filter&&this.filterAmplitude.connect(v.filter.frequency),this.voices.push(v))},SympleOsc.prototype.noteOff=function(noteNumber,when,gainEG,filterEG){if(this.enabled){noteNumber+=12*this.octave;for(var ix=0;ix<this.voices.length;ix++)if(this.voices[ix].active&&this.voices[ix].activatedNote==noteNumber){this.voices[ix].noteOff(noteNumber,when,gainEG,filterEG),this.voices.splice(ix,1);break}}},SympleOsc.prototype.stopSoft=function(when,gainEG,filterEG){for(var ix=0;ix<this.voices.length;ix++)this.voices[ix].stopSoft(when,gainEG,filterEG);this.voices=[]},SympleOsc.prototype.stop=function(){for(var ix=0,len=this.voices.length;ix<len;ix++)this.voices[ix].stop();this.voices=[]},SympleOsc.prototype.deschedule=function(){for(var ix=0,len=this.voices.length;ix<len;ix++)if(this.voices[ix]){var source=this.voices[ix].source;(1==source.playbackState||source.startTime>Klang.context.currentTime)&&(this.voices[ix].stop(),this.voices.splice(ix,1),ix--)}},SympleOsc.prototype.setDetune=function(detune,when){if(this._data){this._data.detune=detune;for(var ix=0,len=this.voices.length;ix<len;ix++)this.voices[ix].source.detune.setValueAtTime(detune,when)}},Object.defineProperty(SympleOsc.prototype,"enabled",{get:function(){return this._enabled},set:function(state){this._enabled=state},enumerable:!0,configurable:!0}),Object.defineProperty(SympleOsc.prototype,"detune",{get:function(){return this._detune},enumerable:!0,configurable:!0}),SympleOsc}(),SympleLFO=function(){function SympleLFO(data,startTime){this.osc=Klang.context.createOscillator(),this.phaseDelay=Klang.context.createDelay(),this.osc.type=data.wave||"sine",this.osc.frequency.value=data.rate||1,this.phase=data.phase||0,this.phaseDelay.delayTime.value=this.phase*(1/this.osc.frequency.value),this.sync=data.sync,this.syncResolution=data.rate,this.osc.connect(this.phaseDelay),this.oscVolumeAmplitude=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this.oscVolumeAmplitude.gain.value=data.osc_volume_amount,this.phaseDelay.connect(this.oscVolumeAmplitude),this.pitchAmplitude=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this.pitchAmplitude.gain.value=data.pitch_amount,this.phaseDelay.connect(this.pitchAmplitude),this.filterAmplitude=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this.filterAmplitude.gain.value=data.filter_amount,this.phaseDelay.connect(this.filterAmplitude),Klang.safari?this.osc.noteOn(startTime):this.osc.start(startTime)}return SympleLFO.prototype.updateSync=function(bpm){return this.osc.frequency.value=bpm/60/this.syncResolution,this.phaseDelay.delayTime.value=this.phase*(1/this.osc.frequency.value),this},SympleLFO}(),Symple=function(_super){function Symple(data,name){_super.call(this,data,name),this.bendRange=400;var startTime=Klang.context.currentTime+Klang.Util.OSC_START_DELAY;this._gainEG=data.gain_eg,this._filterEG=data.filter_eg,this._pitchEG=data.pitch_eg;var disabledOscs=0;data.oscillators[0]||(data.oscillators.push({wave:"sine",detune:0,volume:1,octave:0}),disabledOscs++),data.oscillators[1]||(data.oscillators.push({wave:"sine",detune:0,volume:1,octave:0}),disabledOscs++),this._oscs=[],this._poly=data.poly;for(var ix=0,len=data.oscillators.length;ix<len;ix++){var o=new SympleOsc(data.oscillators[ix],data.poly,data.filter,startTime);o.output.connect(this.output),this._oscs.push(o)}if(1==disabledOscs?this._oscs[1].enabled=!1:2==disabledOscs&&(this._oscs[0].enabled=!1,this._oscs[1].enabled=!1),data.LFO){this._LFO=new SympleLFO(data.LFO,startTime);for(ix=0,len=this._oscs.length;ix<len;ix++){var osc=this._oscs[ix];this._LFO.oscVolumeAmplitude&&this._LFO.oscVolumeAmplitude.connect(osc.output.gain),this._LFO.pitchAmplitude&&(osc.lfoPitchGainNode=this._LFO.pitchAmplitude),this._LFO.filterAmplitude&&(osc.filterAmplitude=this._LFO.filterAmplitude)}this._LFO.sync&&Klang.core.Core.instance.pushToPreLoadInitStack(this)}this._sync&&Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Klang.Util.__extends(Symple,_super),Symple.prototype.init=function(){if(this._LFO&&this._LFO.sync){var seq=Klang.core.Core.instance.findInstance(this._LFO.sync);this._LFO.updateSync(seq.bpm),seq.registerBPMSync(this._LFO)}this._sync&&((seq=Klang.core.Core.instance.findInstance(this._sync)).registerSynth(this),seq.started||seq.start())},Symple.prototype.handleMidiEvent=function(midiEvent,when,transpose,bypassArp){if(when=when||Klang.context.currentTime,bypassArp=bypassArp||!1,transpose=transpose||0,"channel"==midiEvent.type)if("noteOn"==midiEvent.subtype){if("off"!=this._arpMode&&!bypassArp)return this._activeVoices.push({midiEvent:midiEvent,transpose:transpose}),void this.handleArpModes(midiEvent);for(var ix=0,len=this._oscs.length;ix<len;ix++)this._oscs[ix].noteOn(midiEvent.noteNumber,midiEvent.velocity,when,this._gainEG,this._filterEG,this._pitchEG,transpose)}else if("noteOff"==midiEvent.subtype){if("off"!=this._arpMode&&!bypassArp){for(var i=0;i<this._activeVoices.length;i++)midiEvent.noteNumber===this._activeVoices[i].midiEvent.noteNumber&&this._activeVoices.splice(i,1);return void this.handleArpModes(midiEvent)}for(ix=0,len=this._oscs.length;ix<len;ix++)this._oscs[ix].noteOff(midiEvent.noteNumber,when,this._gainEG,this._filterEG)}else if("pitchBend"==midiEvent.subtype){var bend;void 0!==midiEvent.value?bend=midiEvent.value:void 0!==midiEvent.velocity&&(bend=midiEvent.velocity);var currentPitch=(bend-8192)/16384*this.bendRange;for(i=0;i<this._oscs.length;i++)this._oscs[i].setDetune(currentPitch,when)}return this},Symple.prototype.glideTo=function(midiNotes,when,duration,transpose){var now=Klang.Util.now();when=when||now,void 0===duration&&(duration=.5),transpose=transpose||0;for(var o=0,len=this._oscs.length;o<len;o++)for(var osc=this._oscs[o],voicesToUpdate=Math.min(midiNotes.length,osc.voices.length),v=0;v<voicesToUpdate;v++){var voice=osc.voices[v],toFrequency=Klang.Util.midiNoteToFrequency(midiNotes[v]+transpose+12*osc.octave);voice.source.frequency&&voice.source.frequency.linearRampToValueAtTime(toFrequency,when+duration)}return this},Symple.prototype.stop=function(when){when=when||Klang.Util.now();for(var ix=0,len=this._oscs.length;ix<len;ix++)this._oscs[ix].stopSoft(when,this._gainEG,this._filterEG);this._activeVoices.length&&(this._activeVoices=[]),this._arpVoices=[]},Symple.prototype.deschedule=function(){for(var o=0,len=this._oscs.length;o<len;o++)this._oscs[o].deschedule();return this},Object.defineProperty(Symple.prototype,"filterFrequency",{set:function(val){for(var o=0,len=this._oscs.length;o<len;o++){var osc=this._oscs[o];osc._filterData.frequency=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];voice.filterTargetFreq=val,this._filterEG&&0!=this._filterEG.contour||(voice.filter.frequency.value=val)}}},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"filterQ",{set:function(val){for(var o=0,len=this._oscs.length;o<len;o++){var osc=this._oscs[o];osc._filterData.Q=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];voice.filterTargetFreq=val,this._filterEG&&0!=this._filterEG.contour||(voice.filter.Q.value=val)}}},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"filterType",{set:function(val){for(var o=0,len=this._oscs.length;o<len;o++){var osc=this._oscs[o];osc._filterData.filter_type=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){osc.voices[v].filter.type=val}}},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"osc1Wave",{set:function(val){var osc=this._oscs[0];osc._data.wave=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];voice.source.type&&"4"!==val&&(voice.source.type=val)}},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"osc1Vol",{set:function(val){this._oscs[0].output.gain.value=val},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"osc1Detune",{set:function(val){var osc=this._oscs[0];osc._detune=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];voice.source.detune&&(voice.source.detune.value=val)}},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"osc1Octave",{set:function(val){this._oscs[0].octave=val},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"osc2Wave",{set:function(val){if(!(this._oscs.length<2)){var osc=this._oscs[1];osc._data.wave=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];voice.source.type&&"4"!==val&&(voice.source.type=val)}}},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"osc2Vol",{set:function(val){this._oscs.length<2||(this._oscs[1].output.gain.value=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"osc2Detune",{set:function(val){if(!(this._oscs.length<2)){var osc=this._oscs[1];osc._detune=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];voice.source.detune&&(voice.source.detune.value=val)}}},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"osc2Octave",{set:function(val){this._oscs.length<2||(this._oscs[1].octave=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"pitchDecay",{set:function(val){this._pitchEG&&(this._pitchEG.decay=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"pitchContour",{set:function(val){this._pitchEG&&(this._pitchEG.contour=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"lfoWave",{set:function(val){this._LFO&&(this._LFO.osc.type=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"lfoRate",{set:function(val){this._LFO&&(this._LFO.osc.frequency.value=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"lfoPhase",{set:function(val){this._LFO&&(this._LFO.phase=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"lfoOscVol",{set:function(val){this._LFO&&(this._LFO.oscVolumeAmplitude.gain.value=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"lfoPitch",{set:function(val){this._LFO&&(this._LFO.pitchAmplitude.gain.value=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"lfoFilter",{set:function(val){this._LFO&&(this._LFO.filterAmplitude.gain.value=val)},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"arpMode",{set:function(val){this._arpMode=val},enumerable:!0,configurable:!0}),Object.defineProperty(Symple.prototype,"arpOctaves",{set:function(val){this._octaves=val},enumerable:!0,configurable:!0}),Symple.prototype.setData=function(data){_super.prototype.setData.call(this,data),this._poly=data.poly,this._gainEG=data.gain_eg?data.gain_eg:void 0,this._filterEG=data.filter_eg?data.filter_eg:void 0,this._pitchEG=data.pitch_eg?data.pitch_eg:void 0,this._oscs[0].enabled=!!data.oscillators[0],this._oscs[1].enabled=!!data.oscillators[1];for(var o=0,len=this._oscs.length;o<len;o++){var osc=this._oscs[o];osc._data=data.oscillators[o],osc._filterData=data.filter,osc._poly=this._poly;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];data.filter?(voice.filterEnabled||(voice.filterEnabled=!0),this._filterEG&&0!=this._filterEG.contour||(voice.filter.frequency.value=data.filter.frequency),voice.filter.Q.value=data.filter.Q,voice.filterTargetFreq=data.filter.frequency,voice.filter.type=data.filter.filter_type):voice.filterEnabled&&(voice.filterEnabled=!1),data.oscillators&&data.oscillators[o]&&0==voice.voiceType&&(voice.source.type&&4!==data.oscillators[0].wave&&(voice.source.type=data.oscillators[o].wave),voice.source.detune&&(voice.source.detune.value=data.oscillators[o].detune))}data.oscillators[o]&&(osc.output.gain.value=data.oscillators[o].volume,osc.octave=data.oscillators[o].octave)}data.LFO?(this._LFO.osc.type=data.LFO.wave,this._LFO.osc.frequency.value=data.LFO.rate,this._LFO.phase=data.LFO.phase,this._LFO.phaseDelay.delayTime.value=data.LFO.phase*(1/this._LFO.osc.frequency.value),this._LFO.oscVolumeAmplitude.gain.value=data.LFO.osc_volume_amount,this._LFO.pitchAmplitude.gain.value=data.LFO.pitch_amount,this._LFO.filterAmplitude.gain.value=data.LFO.filter_amount):(this._LFO.oscVolumeAmplitude.gain.value=0,this._LFO.pitchAmplitude.gain.value=0,this._LFO.filterAmplitude.gain.value=0)},Symple}(Klang.Model.Synth);return Klang.Model.Symple=Symple})),Module((function(Klang){Klang.engines.webAudio.Util;var MonoSynth=function(_super){function MonoSynth(data,name){_super.call(this,data,name);Klang.context.currentTime,Klang.Util.OSC_START_DELAY;this._gainEG=data.gain_eg,this._pitchEG=data.pitch_eg,this._osc=null,this._sync&&Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Klang.Util.__extends(MonoSynth,_super),MonoSynth.prototype.init=function(){if(this._sync){var seq=Klang.core.Core.instance.findInstance(this._sync);seq.registerSynth(this),seq.started||seq.start()}},MonoSynth.prototype.trigger=function(note){var midiEvent={noteNumber:note,when:Klang.context.currentTime};this.noteOn(midiEvent.noteNumber,midiEvent.when),this.noteOff(midiEvent.noteNumber,midiEvent.when)},MonoSynth.prototype.noteOn=function(noteNumber,velocity,when,transpose){when=Math.max(when||0,Klang.context.currentTime),transpose=transpose||0,this._osc||(this._osc=Klang.context.createOscillator(),this._oscGain=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode(),this._osc.connect(this._oscGain),this._oscGain.connect(this.output),this._osc.start(when),this._oscGain.gain.value=0,this._osc.type=this.data.oscillators[0].wave);var f=Klang.Util.midiNoteToFrequency(noteNumber+transpose+12*this.data.oscillators[0].octave),v=this._oscGain.gain.value,oldF=this._osc.frequency.value;this._oscGain.gain.cancelScheduledValues(when),this._osc.frequency.cancelScheduledValues(when),this._osc.frequency.setValueAtTime(oldF,when),this._oscGain.gain.setValueAtTime(v,when),this._oscGain.gain.linearRampToValueAtTime(0,when+.02),this._osc.frequency.linearRampToValueAtTime(f,when+.02),this.smoothingTime=.02;var attackVal=.02+this._gainEG.attack+.01;this._oscGain.gain.linearRampToValueAtTime(1,when+attackVal);var decayVal=attackVal+this._gainEG.decay;return this._oscGain.gain.linearRampToValueAtTime(this._gainEG.sustain,when+decayVal),this._adEndTime=when+decayVal,this},MonoSynth.prototype.noteOff=function(noteNumber,when){when=Math.max(when||0,this._adEndTime+1e-4);var release=this.smoothingTime+this._gainEG.attack+.01+this.smoothingTime+this._gainEG.release;this._oscGain.gain.linearRampToValueAtTime(0,when+release)},MonoSynth.prototype.handleMidiEvent=function(midiEvent,when,transpose,bypassArp){if(when=when||Klang.context.currentTime,transpose=transpose||0,"channel"==midiEvent.type)if("noteOn"==midiEvent.subtype)this.noteOn(midiEvent.noteNumber,midiEvent.velocity,when,transpose);else if("noteOff"==midiEvent.subtype)this.noteOff(midiEvent.noteNumber,when,this._gainEG);else if("pitchBend"==midiEvent.subtype){var bend;void 0!==midiEvent.value?bend=midiEvent.value:void 0!==midiEvent.velocity&&(bend=midiEvent.velocity);for(var currentPitch=(bend-8192)/16384*this.bendRange,i=0;i<this._oscs.length;i++)this._oscs[i].setDetune(currentPitch,when)}return this},MonoSynth.prototype.glideTo=function(midiNotes,when,duration,transpose){var now=Klang.Util.now();when=when||now,void 0===duration&&(duration=.5),transpose=transpose||0;for(var o=0,len=this._oscs.length;o<len;o++)for(var osc=this._oscs[o],voicesToUpdate=Math.min(midiNotes.length,osc.voices.length),v=0;v<voicesToUpdate;v++){var voice=osc.voices[v],toFrequency=Klang.Util.midiNoteToFrequency(midiNotes[v]+transpose+12*osc.octave);voice.source.frequency&&voice.source.frequency.linearRampToValueAtTime(toFrequency,when+duration)}return this},MonoSynth.prototype.stop=function(when){when=when||Klang.Util.now(),this._osc.stop(),this._osc.disconnect(),this._oscGain.disconnect(),this._osc=null},MonoSynth.prototype.deschedule=function(){},Object.defineProperty(MonoSynth.prototype,"osc1Wave",{set:function(val){var osc=this._oscs[0];osc._data.wave=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];voice.source.type&&"4"!==val&&(voice.source.type=val)}},enumerable:!0,configurable:!0}),Object.defineProperty(MonoSynth.prototype,"osc1Vol",{set:function(val){this._oscs[0].output.gain.value=val},enumerable:!0,configurable:!0}),Object.defineProperty(MonoSynth.prototype,"osc1Detune",{set:function(val){var osc=this._oscs[0];osc._detune=val;for(var v=0,vlen=osc.voices.length;v<vlen;v++){var voice=osc.voices[v];voice.source.detune&&(voice.source.detune.value=val)}},enumerable:!0,configurable:!0}),Object.defineProperty(MonoSynth.prototype,"osc1Octave",{set:function(val){this._oscs[0].octave=val},enumerable:!0,configurable:!0}),Object.defineProperty(MonoSynth.prototype,"pitchDecay",{set:function(val){this._pitchEG&&(this._pitchEG.decay=val)},enumerable:!0,configurable:!0}),Object.defineProperty(MonoSynth.prototype,"pitchContour",{set:function(val){this._pitchEG&&(this._pitchEG.contour=val)},enumerable:!0,configurable:!0}),MonoSynth.prototype.setData=function(data){_super.prototype.setData.call(this,data),this._poly=data.poly,this._gainEG=data.gain_eg?data.gain_eg:void 0,this._pitchEG=data.pitch_eg?data.pitch_eg:void 0,this._osc&&(this._osc.type=data.oscillators[0].wave)},MonoSynth}(Klang.Model.Synth);return Klang.Model.MonoSynth=MonoSynth})),Module((function(Klang){var SamplePlayer=function(_super){function SamplePlayer(data,name){_super.call(this,data,name),this._content=[],this._playingVoices=[],this._allVoices=[],this._hasNoteOffSamples=!1,this._hasSustainOnSamples=!1,this._hasSustainOffSamples=!1,this._useEnvelope=!0,this._pitchBendRange=.25,this._pedalOnTime=-1,this._sustained=[],this._maxNotes=20,this._stopFactor=5,this._content=Klang.Util.cloneObject(data.content),this._volumeCurve=data.volume_curve||"none",this._gainEG=data.eg_gain||{attack:0,decay:0,sustain:1,release:.005},this._currentPitch=1,Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Klang.Util.__extends(SamplePlayer,_super),SamplePlayer.prototype.init=function(){this._envelope=Klang.context.createGain?Klang.context.createGain():Klang.context.createGainNode();for(var ix=0,len=this._content.length;ix<len;ix++){"noteOff"===this._content[ix].value&&(this._hasNoteOffSamples=!0),"sustainOn"===this._content[ix].value&&(this._hasSustainOnSamples=!0),"sustainOff"===this._content[ix].value&&(this._hasSustainOffSamples=!0);for(var j=0;j<this._content[ix].samples.length;j++)this._content[ix].samples[j].source=Klang.core.Core.instance.findInstance(this._content[ix].samples[j].source),this._content[ix].samples[j].source||Klang.warn("SamplePlayer: audio source not found"),this._content[ix].samples[j].source._parentType="SamplePlayer",this._content[ix].samples[j].source.loop&&(this._loopedSamples=!0)}if(this._sync){var seq=Klang.core.Core.instance.findInstance(this._sync);seq.registerSynth(this),seq.started}},SamplePlayer.prototype.handleMidiEvent=function(midiEvent,when,transpose,bypassArp,insertBus){if(when=when||Klang.Util.now(),bypassArp=bypassArp||!1,transpose=transpose||0,"channel"==midiEvent.type)if("noteOn"==midiEvent.subtype){if("off"!=this._arpMode&&!bypassArp)return this._activeVoices.push({midiEvent:midiEvent,transpose:transpose}),void this.handleArpModes(midiEvent);this.noteOn(when,midiEvent.noteNumber,transpose,midiEvent.velocity,midiEvent.subtype,!1,insertBus),this._callback&&this._callback(midiEvent,when)}else if("noteOff"==midiEvent.subtype){if("off"!=this._arpMode&&!bypassArp){for(var i=0;i<this._activeVoices.length;i++)midiEvent.noteNumber===this._activeVoices[i].midiEvent.noteNumber&&this._activeVoices.splice(i,1);return void this.handleArpModes(midiEvent)}this.noteOff(when,midiEvent.noteNumber,midiEvent.velocity,midiEvent.subtype),this._callback&&this._callback(midiEvent,when)}else if("pitchBend"==midiEvent.subtype){var bend=midiEvent.value;this._currentPitch=1+(bend-64)/127;for(i=0;i<this._playingVoices.length;i++)this._playingVoices[i].source.playbackRateNode.setValueAtTime(this._currentPitch,when)}else if("controller"==midiEvent.subtype){var controllerType=midiEvent.controllerType||midiEvent.noteNumber,value=void 0===midiEvent.value?midiEvent.velocity:midiEvent.value;switch(controllerType){case 1:break;case 64:value<64?(this.pedalRelease(when),when>this._pedalOnTime&&(this._pedalOnTime=-1),this._hasSustainOffSamples&&this.noteOn(when,0,0,127,"sustainOff")):value>64&&(this._pedalOnTime=when,this._hasSustainOnSamples&&this.noteOn(when,0,0,127,"sustainOn"))}}return this},SamplePlayer.prototype.noteOn=function(when,midiNote,transpose,velocity,value,volume,insertBus){for(var ix=0;ix<this._allVoices.length;ix++){var v=this._allVoices[ix];0!=v.source._sources.length&&3!=v.source.lastSource.playbackState||(this._allVoices.splice(ix,1),ix--)}var note=this.getNote(midiNote+transpose,velocity,value),rate=Klang.Util.midiNoteToFrequency(midiNote+transpose)/Klang.Util.midiNoteToFrequency(note.root);-1===note.root&&(rate=1);var copy=new Klang.Model.AudioSource(note.source.data,midiNote.toString());if("noteOn"===value){var newVoice={source:copy,time:when,velocity:velocity,note:midiNote,transpose:transpose};this._playingVoices.push(newVoice),this._allVoices.push(newVoice)}insertBus?copy.connect(insertBus.input):this.destinationName?copy.connect(Klang.core.Core.instance.findInstance(this.destinationName).input):copy.connect(Klang.core.Core.instance.findInstance(copy.destinationName).input),when=when<Klang.Util.now()?Klang.Util.now():when;var vol=0;if(volume?vol=volume*velocity/128:"linear"===this._volumeCurve?vol=velocity/128:"exponential"===this._volumeCurve?vol=Math.abs(1-Math.exp(velocity/128)):"none"===this._volumeCurve&&(vol=1),vol*=copy.output.gain.value,copy.output.gain.cancelScheduledValues(when),copy.nextPlaybackRate=rate*this._currentPitch,copy.play(when),this._useEnvelope){var attackWhen=Math.max(when+1e-4,when+this._gainEG.attack);copy.output.gain.setValueAtTime(0,when),copy.output.gain.linearRampToValueAtTime(vol,attackWhen),copy.output.gain.setTargetAtTime?copy.output.gain.setTargetAtTime(vol*this._gainEG.sustain,attackWhen,this._gainEG.decay||.01):copy.output.gain.setTargetValueAtTime&&copy.output.gain.setTargetValueAtTime(vol*this._gainEG.sustain,attackWhen,this._gainEG.decay)}else copy.output.gain.setValueAtTime(vol,when),copy.output.gain.value=vol},SamplePlayer.prototype.adsr=function(attack,decay,sustain,release){var eg=this._gainEG;return 0===arguments.length?{attack:eg.attack,decay:eg.decay,sustain:eg.sustain,release:eg.release}:(eg.attack=void 0===arguments[0]?eg.attack:arguments[0],eg.decay=void 0===arguments[1]?eg.decay:arguments[1],eg.sustain=void 0===arguments[2]?eg.sustain:arguments[2],eg.release=void 0===arguments[3]?eg.release:arguments[3],this)},SamplePlayer.prototype.noteOff=function(when,midiNote,velocity,value){this.getNote(midiNote,velocity,"noteOn");for(var i=0;i<this._playingVoices.length;i++)if(!midiNote||midiNote.toString()===this._playingVoices[i].source._name)if(when>this._pedalOnTime&&this._pedalOnTime>0)this._sustained.length>this._maxNotes&&(this._sustained[0].source.stop(when+this._gainEG.release*this._stopFactor),this._sustained.splice(0,1)),this._sustained.push(this._playingVoices[i]),this._playingVoices.splice(i,1);else{if(when<Klang.Util.now()&&(when=Klang.Util.now()),this._useEnvelope){var val=this._playingVoices[i].source.output.gain.value;this._playingVoices[i].source.output.gain.cancelScheduledValues(when),when!=Klang.Util.now()||"Firefox"==Klang.detector.browser.name?this._playingVoices[i].source.output.gain.setTargetAtTime(this._gainEG.sustain,when,.1):this._playingVoices[i].source.output.gain.setValueAtTime(val,when),this._playingVoices[i].source.stop(when+this._gainEG.release*this._stopFactor),this._playingVoices[i].source.output.gain.setTargetAtTime(0,when,this._gainEG.release)}else this._playingVoices[i].source.fadeOutAndStop(this._gainEG.release,when);if(this._hasNoteOffSamples){var t=Klang.Util.now()-this._playingVoices[i].time,v=Math.min(Math.exp(-t)/3,1);this.noteOn(when,midiNote,this._playingVoices[i].transpose,this._playingVoices[i].velocity,value,v)}this._playingVoices.splice(i,1)}},SamplePlayer.prototype.stop=function(when){when=when||Klang.Util.now();this.pedalRelease(when);for(var i=0;i<this._playingVoices.length;i++){when<Klang.Util.now()&&(when=Klang.Util.now());var val=this._playingVoices[i].source.output.gain.value;this._playingVoices[i].source.output.gain.cancelScheduledValues(when),this._playingVoices[i].source.output.gain.setValueAtTime(val,when),this._playingVoices[i].source.stop(when+this._gainEG.release*this._stopFactor),this._playingVoices[i].source.output.gain.setTargetAtTime(0,when,this._gainEG.release)}return this._playingVoices=[],this._arpVoices=[],this},SamplePlayer.prototype.deschedule=function(){for(var i=0;i<this._allVoices.length;i++)this._allVoices[i].source.deschedule();return this},SamplePlayer.prototype.pedalRelease=function(when){for(var i=0;i<this._sustained.length;i++)if(when<Klang.Util.now()&&(when=Klang.Util.now()),"Firefox"!=Klang.detector.browser.name){if(this._sustained[i].source.output.gain.setTargetAtTime(0,when,this._gainEG.release),this._hasNoteOffSamples){var t=Klang.Util.now()-this._sustained[i].time,v=Math.min(Math.exp(-t)/3,1);this.noteOn(when,this._sustained[i].note,this._sustained[i].transpose,this._sustained[i].velocity,"noteOff",v)}}else this._sustained[i].source.output.gain.linearRampToValueAtTime(0,when+.3),this._sustained[i].source.stop(when+this._gainEG.release*this._stopFactor);this._sustained=[]},SamplePlayer.prototype.getNote=function(note,velocity,value){var i=0;for(this._content[i].value;velocity>this._content[i].highVelocity||value!==this._content[i].value;)i++;for(var velocityLayer=i,j=0;note<this._content[velocityLayer].samples[j].startRange||note>this._content[velocityLayer].samples[j].endRange;)j++;return this._content[velocityLayer].samples[j]},Object.defineProperty(SamplePlayer.prototype,"content",{get:function(){return this._content},set:function(value){this._content=value,this.init()},enumerable:!0,configurable:!0}),Object.defineProperty(SamplePlayer.prototype,"callbackFunction",{set:function(func){this._callback=func},enumerable:!0,configurable:!0}),SamplePlayer.prototype.setData=function(data){_super.prototype.setData.call(this,data),data.eg_gain&&(this._gainEG=data.eg_gain),data.content&&(this._content=data.content,this.init()),data.volumeCurve&&(this._volumeCurve=data.volumeCurve)},SamplePlayer}(Klang.Model.Synth);return Klang.Model.SamplePlayer=SamplePlayer})),Module((function(Klang){var SyncType;(SyncType=Klang.Model.SyncType||(Klang.Model.SyncType={}))._map=[],SyncType._map[0]="Restart",SyncType.Restart=0,SyncType._map[1]="Playing",SyncType.Playing=1,SyncType._map[2]="All",SyncType.All=2,SyncType._map[3]="Continue",SyncType.Continue=3})),Module((function(Klang){var SyncType=Klang.Model.SyncType,Sequencer=function(_super){function Sequencer(data,name){_super.call(this),this._scheduler=null,this._started=!1,this._bpm=120,this._barLength=4,this._beatLength=1,this._resolution=.25,this._currentStep=0,this._paused=!1,this._maxSwing=.08,this._swingFactor=0,this._lastBeat=-1,this._name=name,this._type=data.type,this._bpm=data.bpm||120,this._barLength=data.bar_length||4,this._beatLength=data.beat_length||1,this._registeredPatterns=[],this._registeredSynths=[],this._syncHandler=new Klang.core.SyncHandler,this._syncedObjects=[],this._swingFactor=data.swing_factor||0,Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Klang.Util.__extends(Sequencer,_super),Sequencer.prototype.init=function(){this._lookahead=Klang.core.Core.settings.sequencer_lookahead||50,this._scheduleAheadTime=Klang.core.Core.settings.sequencer_schedule_ahead||.2,Klang.isIOS&&(this._scheduleAheadTime=Klang.core.Core.settings.sequencer_schedule_ahead_ios||5),this._resolution=Klang.core.Core.settings.sequencer_resolution||.25},Sequencer.prototype.startScheduler=function(){if(!this._paused&&0!==Klang.context.currentTime)for(this._lastScheduleLoopTime=Klang.context.currentTime;this._scheduleTime<Klang.context.currentTime+this._scheduleAheadTime;){for(var ix=0,len=this._registeredPatterns.length;ix<len;ix++)this._registeredPatterns[ix].update(this._currentStep,this._scheduleTime);var jx=0;for(len=this._registeredSynths.length;jx<len;jx++)this._registeredSynths[jx].update(this._currentStep,this._scheduleTime);var currentStep=this.currentStep,currentBeat=Math.floor(currentStep);currentBeat!==this._lastBeat&&this.trigger("beforeNextBeat",currentBeat,this.getBeatTime(0)-this._scheduleTime,this._scheduleTime),this._lastBeat=currentBeat,this.trigger("progress",this._currentStep,this.getBeatTime(0)-this._scheduleTime,this._scheduleTime),this._currentStep+=this._resolution,this._syncHandler.update(this._resolution),this._swingFactor>0?4*this._currentStep%2?this._scheduleTime+=(.25+this._maxSwing*this._swingFactor)*(60/this._bpm):this._scheduleTime+=(.25-this._maxSwing*this._swingFactor)*(60/this._bpm):this._scheduleTime+=60/this._bpm*this._resolution}var _this=this;this._scheduler=setTimeout((function(){_this.startScheduler()}),_this._lookahead)},Sequencer.prototype.start=function(offset){return offset=offset||0,this._started||(this._started=!0,this._scheduleTime=Klang.context.currentTime+offset,this._scheduleAheadTime<=.2&&(this._scheduleTime+=.3),clearTimeout(this._scheduler),this.startScheduler(),Klang.core.Core.callbacks&&Klang.core.Core.callbacks.startSequencer&&Klang.core.Core.callbacks.startSequencer({name:this._name}),this.trigger("start")),this},Sequencer.prototype.pause=function(){this._paused=!0,this._pauseOffset=this._scheduleTime-Klang.Util.now();for(var ix=0,len=this._registeredPatterns.length;ix<len;ix++)this._registeredPatterns[ix].pause();return this.trigger("pause"),this},Sequencer.prototype.unpause=function(){this._paused=!1,this._scheduleTime=Klang.Util.now()+this._pauseOffset;for(var ix=0,len=this._registeredPatterns.length;ix<len;ix++)this._registeredPatterns[ix].unpause();return this},Sequencer.prototype.reschedule=function(){clearTimeout(this._scheduler);var scheduled=this._scheduleTime-Klang.context.currentTime,resolutionTime=this.getNoteTime(this._resolution),scheduleOffset=scheduled>this._scheduleAheadTime?scheduled-this._scheduleAheadTime:scheduled-(this._scheduleAheadTime-resolutionTime),realScheduledSteps=(scheduled-scheduled%resolutionTime)/resolutionTime/(this._beatLength/this._resolution),scheduledSteps=this._scheduleAheadTime/resolutionTime/(this._beatLength/this._resolution);this._scheduleTime=Klang.context.currentTime+scheduleOffset,realScheduledSteps<scheduledSteps&&(this._scheduleTime-=resolutionTime),this._currentStep-=scheduledSteps,(isNaN(this._currentStep)||this._currentStep<0)&&(this._currentStep=0);for(var ix=0,len=this._registeredPatterns.length;ix<len;ix++)this._registeredPatterns[ix].deschedule(scheduledSteps);return this.startScheduler(),this},Sequencer.prototype.stop=function(){return this._started=!1,clearTimeout(this._scheduler),this._scheduler=null,this._started=!1,Klang.core.Core.callbacks&&Klang.core.Core.callbacks.stopSequencer&&Klang.core.Core.callbacks.stopSequencer({name:this._name}),this},Sequencer.prototype.stopAll=function(params){for(var exceptions=[],_i=0;_i<arguments.length-1;_i++)exceptions[_i]=arguments[_i+1];for(var beat=void 0!==params.beat?params.beat:4,fadeTime=void 0===params.fadeTime?0:params.fadeTime,forceFade=params.forceFade||!1,wait=params.wait||0,ix=0,len=this._registeredPatterns.length;ix<len;ix++)-1==exceptions.indexOf(this._registeredPatterns[ix])&&(this._registeredPatterns[ix].forceFade=forceFade,this._registeredPatterns[ix].stop(beat,!0,fadeTime,wait));return this},Sequencer.prototype.restart=function(){return this._currentStep=0,this},Sequencer.prototype.registerPattern=function(pattern){return this._registeredPatterns.push(pattern),this},Sequencer.prototype.unregisterPattern=function(pattern){var index=this._registeredPatterns.indexOf(pattern);return this._registeredPatterns.splice(index,1),this},Sequencer.prototype.registerSynth=function(synth){return-1==this._registeredSynths.indexOf(synth)&&this._registeredSynths.push(synth),this},Sequencer.prototype.unregisterSynth=function(synth){var index=this._registeredPatterns.indexOf(synth);return this._registeredSynths.splice(index,1),this},Sequencer.prototype.sync=function(process,beatModifier,args){return this.syncInSteps(process,this.getStepsToNext(this.beatLength*beatModifier),args)},Sequencer.prototype.syncInSteps=function(process,steps,args){this._started||this.start();var scheduleTime=this.getNoteTime(steps)+this._scheduleTime;return args?args.length&&args.push(scheduleTime):args=[scheduleTime],this._syncHandler.addSyncCountdown(new SyncCountdown(steps,process,args)),this},Sequencer.prototype.quantizeDuration=function(duration,beat){var bpm=this.bpm,spb=60/bpm,bps=bpm/60;return Math.floor(duration/spb)*bps},Sequencer.prototype.syncCallback=function(cb,beatQuant,offset,minOffset){minOffset=minOffset||0,offset=offset||0,beatQuant=beatQuant||1;var _this=this,handler=function(scheduleBeat,_,scheduleTime){scheduleBeat%beatQuant===offset&&minOffset<=0&&(_this.off("beforeNextBeat",handler),cb(scheduleBeat,scheduleTime)),minOffset--};this._syncCallbackContext=this._syncCallbackContext||{ctx:this},this.on("beforeNextBeat",handler,this._syncCallbackContext)},Sequencer.prototype.cancelCallbacks=function(){this._syncCallbackContext&&this.off("beforeNextBeat",null,this._syncCallbackContext)},Sequencer.prototype.syncPattern=function(params){for(var patterns=[],_i=0;_i<arguments.length-1;_i++)patterns[_i]=arguments[_i+1];var steps,first,syncStep,beat=params.beat||0,fadeIn=params.fadeIn||!1,duration=params.duration||1,absolute=void 0!==params.absolute&&params.absolute,syncType=void 0!==params.syncType?params.syncType:3,offset=params.offset,wait=params.wait||0;this._started||(this._currentStep=0,this.start(),steps=beat=0,first=!0);var restart=!1;if(syncType===SyncType.Restart)syncStep=0,restart=!0;else if(syncType===SyncType.Playing){for(var longest=0,longestId=-1,ix=0,len=patterns.length;ix<len;ix++)1===patterns[ix].state&&patterns[ix].length>longest&&(longest=patterns[ix].length,longestId=ix);var nextBar=0;longestId>-1&&(nextBar=patterns[longestId].getNextBar(beat)),syncStep=nextBar*beat,nextBar>0&&wait>0&&(syncStep+=wait)}else if(syncType===SyncType.All){for(longest=0,longestId=-1,ix=0,len=this._registeredPatterns.length;ix<len;ix++)1!==this._registeredPatterns[ix].state&&2!==this._registeredPatterns[ix].state||this._registeredPatterns[ix].length>longest&&(longest=this._registeredPatterns[ix].length,longestId=ix);var nextStep=0;longestId>-1&&(nextStep=this._currentStep+this.getStepsToNext(beat)),syncStep=nextStep}else syncType===SyncType.Continue&&(syncStep=0,restart=!!first);0!=absolute?steps="number"==typeof absolute?this.getStepsToNext(this.beatLength*absolute)+this.beatLength*beat:this.beatLength*beat:beat>0?steps=this.getStepsToNext(this.beatLength*beat):0==beat&&(steps=0),wait>0&&(steps+=wait);for(ix=0,len=patterns.length;ix<len;ix++)void 0!==offset&&(offset=this.getNoteTime(offset)),patterns[ix].prePlaySchedule(steps,syncStep,restart,fadeIn,duration,offset);if(first){var scheduled=this._scheduleTime-Klang.context.currentTime,resolutionTime=this.getNoteTime(this._resolution),scheduleOffset=scheduled>this._scheduleAheadTime?scheduled-this._scheduleAheadTime:scheduled-(this._scheduleAheadTime-resolutionTime);this._scheduleTime=Klang.context.currentTime+scheduleOffset,this._currentStep=restart?patterns[0]._currentStep-this._resolution:patterns[0]._currentStep,first=!1}else this._scheduleAheadTime>.5&&this.reschedule();return this},Sequencer.prototype.registerBPMSync=function(obj){return-1==this._syncedObjects.indexOf(obj)&&this._syncedObjects.push(obj),this},Sequencer.prototype.unregisterBPMSync=function(obj){var index=this._syncedObjects.indexOf(obj);return-1!=index&&this._syncedObjects.splice(index,1),this},Sequencer.prototype.getStepsToNext=function(x){return 0==x?0:x-this._currentStep%x},Sequencer.prototype.getNoteTime=function(note){return void 0===note&&(note=1),60/this._bpm*note},Sequencer.prototype.getBeatTime=function(x){return this.getNoteTime(this.getStepsToNext(x))+this._scheduleTime},Object.defineProperty(Sequencer.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"paused",{get:function(){return this._paused},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"bpm",{get:function(){return this._bpm},set:function(value){this._bpm=value;for(var ix=0,len=this._registeredPatterns.length;ix<len;ix++)"MidiPattern"==this._registeredPatterns[ix]._type&&this._registeredPatterns[ix].recalculateBPM(this._bpm);for(ix=0,len=this._syncedObjects.length;ix<len;ix++)this._syncedObjects[ix].updateSync(this._bpm)},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"scale",{set:function(scale){for(var ix=0,len=this._registeredPatterns.length;ix<len;ix++)"MidiPattern"==this._registeredPatterns[ix]._type&&(this._registeredPatterns[ix].scale=scale)},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"customScale",{set:function(obj){for(var ix=0,len=this._registeredPatterns.length;ix<len;ix++)"MidiPattern"==this._registeredPatterns[ix]._type&&(this._registeredPatterns[ix].customScale=obj)},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"transpose",{set:function(transpose){for(var ix=0,len=this._registeredPatterns.length;ix<len;ix++)"MidiPattern"==this._registeredPatterns[ix]._type&&(0===transpose?this._registeredPatterns[ix].resetTranspose():this._registeredPatterns[ix].transpose+=transpose)},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"resolution",{get:function(){return this._resolution},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"barLength",{get:function(){return this._barLength},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"beatLength",{get:function(){return this._beatLength},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"currentStep",{get:function(){return this._currentStep},enumerable:!0,configurable:!0}),Object.defineProperty(Sequencer.prototype,"swingFactor",{set:function(val){this._swingFactor=val},enumerable:!0,configurable:!0}),Sequencer.prototype.setData=function(data){this._bpm=data.bpm||120,this._barLength=data.measure_length||4,this._beatLength=data.beat_length||1,this._swingFactor=data.swing_factor||0},Sequencer}(Klang.core.EventEmitter);return Klang.Model.Sequencer=Sequencer})),Module((function(Klang){var Process=function(){function Process(data){this._vars=data.vars,Klang.core.Core.instance.pushToPreLoadInitStack(this)}return Process.prototype.init=function(){for(var ix=0,len=this._vars.length;ix<len;ix++){var n=this._vars[ix];this._destination=this._actionData[n]=Klang.core.Core.instance.findInstance(n)}this._vars=null},Process.prototype.start=function(args){Klang.warn("Process: Invocation of abstract method")},Process.prototype.destination=function(){return this._destination},Process.prototype.execute=function(action,args,noCache){if("function"!=typeof action)return this._func&&!noCache||(this._func=new Function("Core","Model","Util","me","args","vars",action)),this._func(Klang.core.Core,Klang.Model,Klang.Util,this._actionData,args,Klang.Util.vars);action(Klang.core.Core,Klang.Model,Klang.Util,this._actionData,args,Klang.Util.vars)},Process}();return Klang.core.Process=Process})),Module((function(Klang){var SimpleProcess=function(_super){function SimpleProcess(data,name){_super.call(this,data),this._name=name,this.data=data,this._type=data.type,this._action=data.action,this._actionData={}}return Klang.Util.__extends(SimpleProcess,_super),SimpleProcess.prototype.start=function(args){this.execute(this._action,args)},SimpleProcess.prototype.setData=function(data){this._action=data.action,this._vars=data.vars,this.init(),this._func=new Function("Core","Model","Util","me","args","vars",this._action)},SimpleProcess}(Klang.core.Process);Klang.Model.SimpleProcess=SimpleProcess;var AdvancedProcess=function(_super){function AdvancedProcess(data,name){if(_super.call(this,data),this._nextStartTime=0,this._waitOffset=0,this.SCHEDULE_AHEAD_TIME=.2,this._lastTime=0,this._name=name,this._type=data.type,this._preAction=data.pre_action||null,this._actions=data.actions,this._currentAction=0,this._started=!1,this._loop=void 0!==data.loop&&data.loop,this._loopTime=data.loopTime||-1,this._actionData={process:this},this._loop){for(var waitFound=!1,ix=0,len=this._actions.length;ix<len;ix++)if("wait"==this._actions[ix].operation){waitFound=!0;break}waitFound||Klang.warn("Process: Infinite loop found in process '"+this._name+"'")}}return Klang.Util.__extends(AdvancedProcess,_super),AdvancedProcess.prototype.start=function(args){if(!Klang.isIOS){if(this._args=args,this._currentAction=0,this._execTime=0,this._startTime=Klang.context.currentTime,this._nextStartTime=this._startTime,this._preAction)if("exec"==this._preAction.operation)this.execute(this._preAction.script,this._args);else if("wait"==this._preAction.operation)return this._execTime=this.execute(this._preAction.script,this._args),this._waitOffset+=this._execTime,void(this._execTime>=this.SCHEDULE_AHEAD_TIME?Klang.core.TimeHandler.instance.registerMethodCallback(this,"cont",this._execTime-this.SCHEDULE_AHEAD_TIME/2):this.cont());this._started=!0,this.cont()}},AdvancedProcess.prototype.cont=function(){this._actionData.execTime=this._nextStartTime+this._waitOffset;for(var len=this._actions.length;this._currentAction<len;this._currentAction++){if(!this._started)return;var action=this._actions[this._currentAction];if("exec"==action.operation)this.execute(action.script,this._args,!0),this._execTime=0;else if("wait"==action.operation)return this._execTime=this.execute(action.script,this._args,!0),this._waitOffset+=this._execTime,this._execTime>=this.SCHEDULE_AHEAD_TIME?Klang.core.TimeHandler.instance.registerMethodCallback(this,"cont",this._execTime-this.SCHEDULE_AHEAD_TIME/2):this._waitOffset>this.SCHEDULE_AHEAD_TIME?this.scheduleLoop(this._waitOffset):(this._currentAction++,this.cont()),void this._currentAction++}this._loop&&(this._loopTime>0?this.scheduleLoop(this._loopTime):(this._waitOffset=0,this._currentAction=0,this.cont()))},AdvancedProcess.prototype.scheduleLoop=function(loopTime){if(this._started){this._nextStartTime+=loopTime;var timeTilNext=this._nextStartTime-Klang.context.currentTime,_this=this;setTimeout((function(){_this._waitOffset=0,_this._currentAction=0,_this.cont()}),1e3*(timeTilNext-this.SCHEDULE_AHEAD_TIME/2))}},AdvancedProcess.prototype.stop=function(){this._started=!1,Klang.core.TimeHandler.instance.removeMethodCallback(this,"cont")},Object.defineProperty(AdvancedProcess.prototype,"started",{get:function(){return this._started},enumerable:!0,configurable:!0}),AdvancedProcess.prototype.setData=function(data){this._actions=data.actions,this._vars=data.vars,this.init()},AdvancedProcess}(Klang.core.Process);return Klang.Model.AdvancedProcess=AdvancedProcess})),Module((function(Klang){Klang.engines.webAudio.Util.createAudioContext=function(desiredSampleRate){var AudioCtor=window.AudioContext||window.webkitAudioContext;desiredSampleRate="number"==typeof desiredSampleRate?desiredSampleRate:44100;var context=new AudioCtor;if(/(iPhone|iPad)/i.test(navigator.userAgent)&&context.sampleRate!==desiredSampleRate){var buffer=context.createBuffer(1,1,desiredSampleRate),dummy=context.createBufferSource();dummy.buffer=buffer,dummy.connect(context.destination),dummy.start(0),dummy.disconnect(),context.close(),context=new AudioCtor}return context}})),Module((function(Klang){})),Module((function(Klang){var ATAudioFile=function(){function ATAudioFile(url,fileData){this._url=url,this.data=fileData,this._onCanPlayThrough=this._onCanPlayThrough.bind(this),this._waitForReadyState=this._waitForReadyState.bind(this),this.state=ATAudioFile.STATE_NOT_LOADED}return ATAudioFile.STATE_NOT_LOADED=0,ATAudioFile.STATE_LOADING=1,ATAudioFile.STATE_LOADED=2,ATAudioFile.prototype._onCanPlayThrough=function(){this.audioElement.removeEventListener("canplaythrough",this._onCanPlayThrough,!1),this._waitForReadyState(function(){this.ready=!0,this.state=this.state=ATAudioFile.STATE_LOADED,this._readyCallback&&this._readyCallback(),this.audioElement.pause()}.bind(this))},ATAudioFile.prototype._waitForReadyState=function(cb){var _this=this;!function wait(){_this.audioElement.readyState?cb&&cb():setTimeout(wait,100)}()},ATAudioFile.prototype.load=function(onDone){if(this.state===ATAudioFile.STATE_NOT_LOADED){this.state=ATAudioFile.STATE_LOADING;var el=this.audioElement=new Audio;el.src=this._url,el.addEventListener("canplaythrough",this._onCanPlayThrough,!1),el.volume=0,el.play()}this._readyCallback=onDone},ATAudioFile.prototype.clone=function(){var clone=new ATAudioFile(this._url,this.data);return clone.state=this.state,clone.audioElement=new Audio,clone.ready=!!this.ready,clone.audioElement.src=this._url,clone.audioElement.volume=0,clone.audioElement.play(),clone},ATAudioFile}();Klang.ATAudioFile=ATAudioFile;var ATAudioSource=function(){function ATAudioSource(data,file){this._xLoopTimer=0,this.state=ATAudioSource.STATE_STOPPED,this._data=data,this._currentFile=file,this._retrig=void 0===data.retrig||data.retrig,this._loopStart=data.loop_start||0,this._loopEnd=data.loop_end||0,this._destination_name=data.destination_name,this._currentFile&&(this._priority=this._currentFile.data.audio_tag,this._loop=!!this._data.loop,this._gain=new ATGainNode(data.volume,this),this._loop&&(this._files=[this._currentFile,this._currentFile.clone()]),this.beforeEnding=this.beforeEnding.bind(this))}return ATAudioSource.STATE_PLAYING=3,ATAudioSource.STATE_STOPPING=3,ATAudioSource.STATE_STOPPED=4,ATAudioSource.prototype.beforeEnding=function(){if(this._playing&&this._loop){var otherFile=this._currentFile;this._currentFile=otherFile===this._files[0]?this._files[1]:this._files[0],this._currentFile.currentTime=this._loopStart,this._currentFile.audioElement.currentTime=this._loopStart,otherFile.audioElement.pause(),this.update(),this._currentFile.audioElement.play(),clearTimeout(this._xLoopTimer),this._xLoopTimer=setTimeout(this.beforeEnding,1e3*(this._currentFile.audioElement.duration-this._loopStart-(this._loopEnd?this._currentFile.audioElement.duration-this._loopEnd:0)))}},ATAudioSource.prototype.play=function(when,offset,resume,keepVolume,loopTrigg){if(when=when||0,!this._currentFile.ready)return this;if(this._playing&&!this._retrig&&this.state!==ATAudioSource.STATE_STOPPING)return this;if(when>0){var _this=this;this._playTimeout=setTimeout((function(){_this.doPlay(offset,resume,keepVolume,loopTrigg)}),1e3*when)}else this.doPlay(offset,resume,keepVolume,loopTrigg)},ATAudioSource.prototype.doPlay=function(offset,resume,keepVolume,loopTrigg){return offset=offset||0,this.state!=ATAudioSource.STATE_STOPPING||this._retrig?(this.update(),this._currentFile.audioElement.currentTime=offset,this._currentFile.audioElement.play(),this._playing=!0,this._loop&&(clearTimeout(this._xLoopTimer),this._xLoopTimer=setTimeout(this.beforeEnding,1e3*(this._currentFile.audioElement.duration-offset-this._loopStart-(this._loopEnd?this._currentFile.audioElement.duration-this._loopEnd:0)))),this.state=ATAudioSource.STATE_PLAYING,this):(this.getOutput().fadeVolume(this.getOutput().getVolume(),.5),void(this.state=ATAudioSource.STATE_PLAYING))},ATAudioSource.prototype.fadeInAndPlay=function(targetValue,duration,when,offset){if((when=when||0)>0){var _this=this;this._playTimeout=setTimeout((function(){_this.doFadeInAndPlay(_this.getOutput().getVolume(),duration)}),1e3*when)}else this.doFadeInAndPlay(this.getOutput().getVolume(),duration);return this},ATAudioSource.prototype.doFadeInAndPlay=function(targetValue,duration){return this._gain.setVolume(this.state==ATAudioSource.STATE_PLAYING?this._gain.getVolume():0),this.play(0,0,!1,!0),this._gain.fadeVolume(targetValue,duration),this},ATAudioSource.prototype.stop=function(when){return this._playTimeout&&clearTimeout(this._playTimeout),this.state=ATAudioSource.STATE_STOPPED,this._currentFile.audioElement.pause(),this._playing=!1,clearTimeout(this._xLoopTimer),this},ATAudioSource.prototype.fadeOutAndStop=function(duration,when){if(this.state==ATAudioSource.STATE_PLAYING){this._playTimeout&&clearTimeout(this._playTimeout);var _this=this;return this._gain.fadeVolume(0,duration,(function(){_this.state==ATAudioSource.STATE_STOPPING&&_this.stop()})),this.state=ATAudioSource.STATE_STOPPING,this}},ATAudioSource.prototype.setVolume=function(value){return value=void 0===value?this.getOutput().getVolume():value*this.getOutput().getVolume(),value=Math.max(0,Math.min(1,value*Klang.audioTagHandler.getGlobalVolume()*Klang.audioTagHandler.getFocusBlurVolume())),this._currentFile.audioElement&&isFinite(value)&&(this._currentFile.audioElement.volume=value),this},ATAudioSource.prototype.update=function(){this.setVolume(this._destination.calcVolume())},ATAudioSource.prototype.connect=function(bus){this._destination=bus,bus.addConnected(this),this.update()},ATAudioSource.prototype.getOutput=function(){return this._gain},Object.defineProperty(ATAudioSource.prototype,"position",{get:function(){return this.playing?this._currentFile.audioElement.currentTime:0},enumerable:!0,configurable:!0}),Object.defineProperty(ATAudioSource.prototype,"playing",{get:function(){return this._playing},enumerable:!0,configurable:!0}),ATAudioSource}();Klang.ATAudioSource=ATAudioSource;var ATAudioGroup=function(){function ATAudioGroup(data,audioTagHandler){for(var c in this._data=data,this._content=[],this._data.content){var audio=audioTagHandler.getObject(this._data.content[c]);audio&&this._content.push(audio)}}return ATAudioGroup.prototype.play=function(when,audioSource,forcePlay){var index="number"==typeof audioSource?audioSource:Klang.Util.random(this._content.length-1,0);return this._content[index]&&this._content[index].play(when),this},ATAudioGroup.prototype.stop=function(){for(var c in this._content)this._content[c]&&this._content[c].stop();return this},Object.defineProperty(ATAudioGroup.prototype,"playing",{get:function(){var playing=!1;for(var c in this._content)this._content[c]._playing&&(playing=!0);return playing},enumerable:!0,configurable:!0}),ATAudioGroup.prototype.update=function(){},ATAudioGroup.prototype.connect=function(bus){},ATAudioGroup}();Klang.ATAudioGroup=ATAudioGroup;var ATGainNode=function(){function ATGainNode(volume,owner){this._currentVolume=this._volume=void 0!==volume?volume:1,this._currentVolume=Math.max(0,Math.min(this._currentVolume,1)),this._owner=owner}return ATGainNode.prototype.getVolume=function(){return this._volume},ATGainNode.prototype.setVolume=function(value){return value=Math.max(0,Math.min(1,value)),this._currentVolume=value,this._owner&&this._owner.setVolume&&this._owner.setVolume(this._currentVolume),this},ATGainNode.prototype.fadeVolume=function(targetValue,duration,callback){this._fadeTimer&&clearInterval(this._fadeTimer);var _this=this;return this._fadeSteps=Math.round(1e3*duration)/10,this._volumeStep=(this._currentVolume-targetValue)/this._fadeSteps,this._fadeTimer=setInterval((function(){_this.setVolume(_this._currentVolume-_this._volumeStep),_this._fadeSteps--,_this._fadeSteps<=0&&(clearInterval(_this._fadeTimer),callback&&callback())}),10),this},ATGainNode.prototype.resetVolume=function(keepVolume){var volumeToSet=keepVolume?this._currentVolume:this._volume;return clearInterval(this._fadeTimer),this.setVolume(volumeToSet),this},ATGainNode}();Klang.ATGainNode=ATGainNode;var ATBus=function(){function ATBus(data,name,isMaster){this._isMaster=!1,this._connected=[],this._isMaster=isMaster,this._data=data,this._name=name,this._output=new ATGainNode(void 0!==data.output_vol?data.output_vol:1,this),this._volume=void 0!==data.output_vol?data.output_vol:1,this._destination_name=data.destination_name}return ATBus.prototype.getVolume=function(){return this._isMaster,this._volume},ATBus.prototype.calcVolume=function(vol){return void 0===vol&&(vol=1),vol*=this._volume,this._destination?this._destination.calcVolume(vol):vol},ATBus.prototype.setVolume=function(volume){this._volume=volume;for(var i=0;i<this._connected.length;i++)this._connected[i].update()},ATBus.prototype.update=function(){for(var i=0;i<this._connected.length;i++)this._connected[i].update()},ATBus.prototype.getOutput=function(){return this._output},ATBus.prototype.addConnected=function(c){this._connected.push(c)},ATBus.prototype.connect=function(bus){this._destination=bus,bus.addConnected(this)},ATBus}();Klang.ATBus=ATBus;var ATProcess=function(){function ATProcess(data,name,vars){this._data=data,this._name=name,this._vars=vars,"copy"===this._data.at_action&&(this._data.at_action=this._data.action)}return ATProcess.prototype.start=function(args){try{"function"==typeof this._data.at_action?this._data.at_action(Klang.Util,this._vars,args):new Function("Util","me","args",this._data.at_action)(Klang.Util,this._vars,args)}catch(ex){Klang.err("Klang: error in process '"+this._name+"': "+ex.name+": "+ex.message)}},ATProcess}();function AudioTagHandler(config,readyCallback,progressCallback,configURL){if(this._loadedFiles=0,Klang.audioTagHandler=this,this._audioFiles={},this._limitSounds=Klang.isMobile||"Opera"==Klang.detector.browser.name,"string"==typeof config){var _this=this;Klang.network.request({url:config},(function(data){try{_this.init(JSON.parse(data),readyCallback,progressCallback,configURL)}catch(ex){Klang.engineVersion="n/a",readyCallback&&readyCallback(!1)}}),null,(function(error){Klang.err(error)}))}else"object"==typeof config?this.init(config,readyCallback,progressCallback,configURL):Klang.err("Klang exception: unrecognized config type: "+typeof config)}return Klang.ATProcess=ATProcess,AudioTagHandler.prototype.init=function(data,readyCallback,progressCallback,configURL){this._globalVolume=1,this._focusBlurVolume=1,this._readyCallback=readyCallback,this._progressCallback=progressCallback,this._events=data.events;var baseURL,relativePath=parseInt(data.settings.relative_path),filePath=data.settings.file_path||"";relativePath&&-1!=configURL.lastIndexOf("/")?("/"!==(baseURL=configURL.substring(0,configURL.lastIndexOf("/"))).charAt(baseURL.length-1)&&(baseURL+="/"),baseURL+=filePath):baseURL=filePath;var format=".mp3";for(var p in"Firefox"!=Klang.detector.browser.name&&"Chrome"!=Klang.detector.browser.name||(format=".ogg"),data.files){var fileData=data.files[p],prio=fileData.audio_tag;!prio||this._limitSounds&&1!=prio||(this._audioFiles[fileData.id]=new ATAudioFile(baseURL+fileData.url+format,fileData))}for(var b in this._masterBus=data.masterBus,this._busses={},data.busses)this._busses[b]=new ATBus(data.busses[b],b,b==this._masterBus);for(var a in this._audio={},data.audio)if(data.audio.hasOwnProperty(a)){var audioData=data.audio[a];if("AudioSource"==audioData.type){if(this._audioFiles[audioData.file_id]){this._audioFiles[audioData.file_id];this._audio[a]=new ATAudioSource(audioData,this._audioFiles[audioData.file_id])}}else"AudioGroup"==audioData.type&&(this._audio[a]=new ATAudioGroup(audioData,this))}for(var bus in this._busses)bus!=this._masterBus&&this._busses[bus].connect(this._busses[this._busses[bus]._destination_name]);for(var as in this._audio)"AudioSource"==this._audio[as]._data.type&&this._audio[as].connect(this._busses[this._audio[as]._destination_name]);for(var p in this._processes={},data.processes){var processData=data.processes[p];if(processData.at_action){var processArgs={};for(var v in processData.vars){var processVarName=processData.vars[v];processArgs[processVarName]=this._audio[processVarName]||this._busses[processVarName]}this._processes[p]=new ATProcess(processData,p,processArgs)}}if(this.loadSoundFiles(["auto","autotag"],readyCallback,progressCallback),-1!=data.settings.blur_fade_time){this._blurFadeOut=!0;data.settings.blur_fade_time;if(this.getHiddenProp()){document.addEventListener("visibilitychange",this.visChange.bind(this))}}},AudioTagHandler.prototype.visChange=function(){this.isHidden()?this._blurFadeOut&&this.setFocusBlurVolume(0):this.setFocusBlurVolume(1)},AudioTagHandler.prototype.fadeBusVolume=function(bus,value,duration){this._busses[bus._name].getOutput().fadeVolume(value,duration)},AudioTagHandler.prototype.isHidden=function(){var prop=this.getHiddenProp();return!!prop&&document[prop]},AudioTagHandler.prototype.getHiddenProp=function(){var prefixes=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var i=0;i<prefixes.length;i++)if(prefixes[i]+"Hidden"in document)return prefixes[i]+"Hidden";return null},AudioTagHandler.prototype.resumeAudio=function(){if(Klang.isIOS||Klang.isMobile)for(var p in this._audioFiles)this._audioFiles[p].load()},AudioTagHandler.prototype.loadSoundFiles=function(group,readyCallback,progressCallback,loadFailedCallback){readyCallback&&(this._readyCallback=readyCallback),progressCallback&&(this._progressCallback=progressCallback),"string"==typeof group&&(group=[group]),this._loadedFiles=0,this._numFiles=0;var _this=this;for(var p in this._audioFiles)if(this._audioFiles.hasOwnProperty(p)){var audioFile=this._audioFiles[p],loadGroup=audioFile.data.load_group;void 0!==group&&-1==group.indexOf(loadGroup)||audioFile.state===ATAudioFile.STATE_NOT_LOADED&&(this._numFiles++,audioFile.load((function(){_this.loadProgress()})))}0==this._numFiles&&this._readyCallback&&this._readyCallback(!0)},AudioTagHandler.prototype.getLoadGroups=function(){var i,fileInfoArr=this._audioFiles||[],groupTable={},listOfGroups=[];for(i in fileInfoArr){var fileInfo=fileInfoArr[i];groupTable[fileInfo.data.load_group]=fileInfo.data.load_group}for(i in groupTable)listOfGroups.push(i);return listOfGroups},AudioTagHandler.prototype.loadProgress=function(){if(this._loadedFiles++,this._progressCallback&&this._progressCallback(this._loadedFiles/this._numFiles*100),this._readyCallback&&this._loadedFiles==this._numFiles){var _this=this;setTimeout((function(){_this._readyCallback(!0)}),200)}},AudioTagHandler.prototype.triggerEvent=function(name,args){for(var i=0;i<args.length;i++)args[i]+", ";if("sound_position"!=name){args&&args[0]}if(this._events)try{var eventTarget=this._events[name];if("string"==typeof eventTarget)(process=this._processes[eventTarget])&&process.start(args);else if(eventTarget)for(var ix=0,len=eventTarget.length;ix<len;ix++){var process,processName=eventTarget[ix];(process=this._processes[processName])&&process.start(args)}}catch(ex){Klang.err("Klang: error when triggering event '"+name+"': "+ex.name+": "+ex.message)}},AudioTagHandler.prototype.getFocusBlurVolume=function(){return this._focusBlurVolume},AudioTagHandler.prototype.setFocusBlurVolume=function(value){for(var a in value=Math.max(0,Math.min(value,1)),this._focusBlurVolume=value,this._audio){var audio=this._audio[a];if(audio&&audio.setVolume&&audio.getOutput()){var audioOut=audio.getOutput();audioOut&&audio.setVolume(audioOut.getVolume())}}},AudioTagHandler.prototype.getGlobalVolume=function(){return this._globalVolume},AudioTagHandler.prototype.setGlobalVolume=function(value){for(var a in value=Math.max(0,Math.min(value,1)),this._globalVolume=value,this._audio){var audio=this._audio[a];if(audio&&audio.setVolume&&audio.getOutput){var audioOut=audio.getOutput();audioOut&&audio.setVolume(audioOut.getVolume())}}},AudioTagHandler.prototype.fadeGlobalVolume=function(value,duration){value=Math.max(0,Math.min(value,1)),this._globalFadeTimer&&clearInterval(this._globalFadeTimer);var _this=this,fadeSteps=Math.round(1e3*duration)/10,volumeStep=(this._globalVolume-value)/fadeSteps;this._globalFadeTimer=setInterval((function(){for(var a in _this._globalVolume=_this._globalVolume-volumeStep,fadeSteps--,_this._audio){var audio=_this._audio[a];audio&&audio.setVolume&&audio.getOutput&&audio.setVolume()}fadeSteps<=0&&clearInterval(_this._globalFadeTimer)}),10)},AudioTagHandler.prototype.getLimitSounds=function(){return this._limitSounds},AudioTagHandler.prototype.stopAll=function(priority){for(var a in this._audio)void 0!==priority&&this._audio[a]._priority!=priority||this._audio[a].stop();return this.stopPeriodic(),this},AudioTagHandler.prototype.getObject=function(name){return this._audioFiles[name]||this._audio[name]},AudioTagHandler.prototype.playPeriodic=function(obj,maxSec,minSec){clearTimeout(this._periodicTimer);var _this=this;this._periodicTimer=setTimeout((function(){obj.play(),_this.playPeriodic(obj,maxSec,minSec)}),Klang.Util.random(1e3*maxSec,1e3*minSec))},AudioTagHandler.prototype.stopPeriodic=function(){clearTimeout(this._periodicTimer)},Klang.AudioTagHandler=AudioTagHandler})),Module((function(Klang){var StreamingAudioSource=function(){function StreamingAudioSource(data,name){Klang.Model.Audio.call(this,data,name),this._startTime=0,this._loopStartTime=0,this._scheduleAhead=.2,this._stopping=!1,this._fading=!1,this._paused=!1,this._pauseTime=-1,this._connected=!1,this._durationTimeout=0,this._pauseStartTime=-1,this.data=data,this.editorName=data.editorName,this._fileId=data.file_id,this._playbackRate=data.playback_rate||1,this._endTime=0,this._loop=void 0!==data.loop&&data.loop,this._loopStart=data.loop_start,this._loopEnd=data.loop_end,this._offset=data.offset||0,this._duration=data.duration||0,this._reverse=data.reverse,this._retrig=void 0===data.retrig||data.retrig,this._lockPlaybackrate=void 0!==data.lock_playback_rate&&data.lock_playback_rate,this._volumeStartRange=data.volume_start_range,this._volumeEndRange=data.volume_end_range,data.panner&&(this._panner=data.panner),Klang.core.Core.instance.pushToPostLoadInitStack(this)||this.init(),Klang.core.internalEventBus.on("INIT_IOS",this.initIOS.bind(this))}return Klang.Util.__extends(StreamingAudioSource,Klang.Model.Audio),StreamingAudioSource.prototype.init=function(){var url,self=this;if(this._audioElement=new Audio,this._mediaElementSource=Klang.context.createMediaElementSource(this._audioElement),this._mediaElementSource.connect(this._output),this._audioElement.crossOrigin="anonymous",this._fileId){if("string"==typeof this._fileId){var info=Klang.core.FileHandler.instance.getFileInfo(this._fileId);url=(info.external?"":Klang.core.FileHandler.instance._baseURL)+info.url}}else url=this.data.url;var format=".mp3";"Firefox"!==Klang.detector.browser.name&&"Chrome"!==Klang.detector.browser.name||(format=".ogg"),this._audioElement.src=url+format,this._duration||this._audioElement.addEventListener("loadedmetadata",(function onMetaData(_event){self._duration=self._audioElement.duration,self._audioElement.removeEventListener("loadedmetadata",onMetaData,!1)}),!1)},StreamingAudioSource.prototype.setLoopRegion=function(loopStart,loopEnd){return this._loopStart=loopStart||this._loopStart,this._loopEnd=loopEnd||this._loopEnd,this._audioElement.loopStart=this._loopStart,this._audioElement.loopEnd=this._loopEnd,this},StreamingAudioSource.prototype.connect=function(destination,forceConnect){return this._destination&&!forceConnect||(this._destination=destination,this._panner?(this._output.connect(this._panner.input),this._panner.output.connect(destination)):this._output.connect(destination)),this},StreamingAudioSource.prototype.disconnect=function(){return this._output.disconnect(),this._destination=null,this._panner&&this._panner.output.disconnect(),this},StreamingAudioSource.prototype.play=function(when,offset,duration,resume){var now=Klang.context.currentTime;if(clearTimeout(this._stopTimeout),Klang.log("StreamingAudioSource.play. Playing: "+this._playing),this._playing&&this.stop(when),when=when||0,offset=offset||0,!0,this.removeUnusedSources(),duration||(duration=this._loop?9999999999:this._duration),this._audioElement||this.init(),0!==when&&when+.01<=now)return Klang.warn("StreamingAudioSource: Returned, playTime < currentTime",this._name),this;if(0==when&&(when=now),this.output.gain.cancelScheduledValues(when),this.output.gain.setValueAtTime(this._volume,when),this.paused||(this._pauseStartTime=when),this._startTime=when,this._loopStartTime=when+this.duration,this._paused=!1,this._stopping&&!this._retrig)return this.output.gain.cancelScheduledValues(when),this.output.gain.setValueAtTime(this.output.gain.value,when),this.output.gain.linearRampToValueAtTime(this._volume,when+.25),clearTimeout(this._stoppingId),void(this._stopping=!1);if(this._fading=!1,this._retrig||this.loop){if(this.loop&&this._retrig&&this.playing&&!this._stopping)return;if(this._stopping)this._stopping=!1;else if(Math.round(1e3*this._endTime)/1e3==Math.round(1e3*(when+this._duration))/1e3)return Klang.warn("StreamingAudioSource: Returned, Doubletrig",this._name),this}else if(when<this._endTime)return;return this._endTime=this.loop?-1:when+this._duration,this._loop&&(this._audioElement.loop=!0,this._audioElement.loopStart=this._loopStart?this._loopStart:0,this._audioElement.loopEnd=this._loopEnd?this._loopEnd:this._duration),this._destination||Klang.warn("StreamingAudioSource: no destination node"),"object"!=typeof this._destination&&Klang.warn("StreamingAudioSource: destination is not an object",this._name),offset>this._duration&&(offset%=this._duration),this._startOffset=this._offset+offset,this._playing=!0,Klang.log("AudioElement.play"),this._playTimeout=setTimeout(function(){this._audioElement.play()}.bind(this),1e3*Math.max(0,when-Klang.Util.now())),this},StreamingAudioSource.prototype.getNumberOfSamples=function(){return this._duration*Klang.context.sampleRate},StreamingAudioSource.prototype.stop=function(when){void 0===when&&(when=0),clearTimeout(this._playTimeout),clearTimeout(this._durationTimeout),this._stopping&&(this._stopping=!1,clearTimeout(this._stoppingId));var whenDelta=when-Klang.context.currentTime;return whenDelta>0?(this._stopTimeout=setTimeout(function(){this._audioElement.pause(),this._audioElement.currentTime=0,this._stopping=!1}.bind(this),1e3*whenDelta),this._stopping=!0,this._endTime=when):(this._audioElement.pause(),this._audioElement.currentTime=0,this._endTime=Klang.Util.now()),this._playing=!1,this},StreamingAudioSource.prototype.deschedule=function(){return this._audioElement.pause(),this},StreamingAudioSource.prototype.pause=function(){if(this._endTime>Klang.Util.now()){this._paused=!0;var pauseDelta=Klang.Util.now()-this._startTime;this._pauseTime+=pauseDelta,this.stop()}return this},StreamingAudioSource.prototype.unpause=function(){if(this.paused){var realOffset=this._offset;this._offset+=this._pauseTime,this.play(0,0,null,!0),this._offset=realOffset,this._paused=!1}return this},StreamingAudioSource.prototype.createMediaElementSource=function(){if(this._connected)source=this._source;else{var source=Klang.context.createMediaElementSource(this._audioElement);this._source=source}return source},StreamingAudioSource.prototype.initIOS=function(){this._audioElement||this.init(),this._audioElement.play(),this._audioElement.pause()},StreamingAudioSource.prototype.fadeInAndPlay=function(fadeDuration,when,offset,duration){void 0===offset&&(offset=0),void 0===duration&&(duration=this._duration);var now=Klang.context.currentTime;if(when||(when=now),(!this.loop||this._retrig||!(-1==this._endTime||when<this._endTime)||this._stopping)&&(!(this.loop&&this._retrig&&this.playing)||this._stopping))return this.output.gain.cancelScheduledValues(when),this._stopping&&!this._retrig?(clearTimeout(this._stoppingId),this.output.gain.setValueAtTime(this.output.gain.value,when)):(this._fading=!0,this.play(when==now?0:when,offset,duration),this.output.gain.setValueAtTime(0,when)),this._stopping=!1,this.output.gain.linearRampToValueAtTime(this._volume,when+fadeDuration),this},StreamingAudioSource.prototype.fadeOutAndStop=function(duration,when){if(this.playing){void 0===when&&(when=Klang.context.currentTime),this._stopping&&clearTimeout(this._stoppingId),this.output.gain.cancelScheduledValues(when),this.output.gain.setValueAtTime(this.output.gain.value||this._volume,when),this.output.gain.linearRampToValueAtTime(0,when+duration);var _this=this;return this._stoppingId=setTimeout((function(){_this._stopping&&(_this._stopping=!1,_this.loop&&(_this._loopPlaying=!1),_this.stop(when+duration))}),1e3*(duration+(when-Klang.Util.now())-_this._scheduleAhead)),this._stopping=!0,this}},StreamingAudioSource.prototype.removeUnusedSources=function(){},StreamingAudioSource.prototype.curvePlaybackRate=function(value,duration,when){if(!this._lockPlaybackrate){var startTime=when||Klang.Util.now(),node=this.playbackRateNode;return node&&(node.cancelScheduledValues(startTime),node.setValueAtTime(0==node.value?Klang.Util.EXP_MIN_VALUE:node.value,startTime),node.exponentialRampToValueAtTime(value,startTime+duration)),this._playbackRate=value,this}},Object.defineProperty(StreamingAudioSource.prototype,"lastSource",{get:function(){return this._audioElement},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"loop",{get:function(){return this._loop},set:function(value){this._loop=value},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"offset",{get:function(){return this._offset},set:function(value){"string"==typeof value&&-1!==value.indexOf("%")&&(value=this._duration*parseFloat(value)),this._offset=value},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"position",{get:function(){if(!this.playing||!this._duration)return 0;var duration=this._duration;(this._loopStart||this._loopEnd)&&(duration=(this._loopEnd||duration)-(this._loopStart||0));var timePlayed=Klang.Util.now()-this._startTime,loopTimePlayed=Klang.Util.now()+this._startOffset-this._loopStartTime;return this._startOffset+timePlayed>this._duration?this._loopStart+loopTimePlayed%duration:this._startOffset+timePlayed},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"duration",{get:function(){return this._duration},set:function(value){this._duration=value},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"paused",{get:function(){return this._paused},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"playbackRate",{get:function(){return this._playbackRate},set:function(value){if(!this._lockPlaybackrate){var node=this.playbackRateNode;node&&node.cancelScheduledValues(Klang.Util.now()),this._playbackRate=value;for(var ix=0,len=this._sources.length;ix<len;ix++)this._sources[ix].playbackRate.value=this._playbackRate}},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"nextPlaybackRate",{set:function(value){this._lockPlaybackrate||(this._playbackRate=value)},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"playbackRateNode",{get:function(){var source=this.lastSource;return source&&source.playbackRate},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"buffer",{get:function(){return null},set:function(buffer){},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"playing",{get:function(){return-1==this._endTime||this._endTime>Klang.Util.now()},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"playbackState",{get:function(){var source=this.lastSource;return source?source.playbackState:0},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"output",{get:function(){return this._panner?this._panner.output:this._output},enumerable:!0,configurable:!0}),Object.defineProperty(StreamingAudioSource.prototype,"panner",{get:function(){return this._panner},enumerable:!0,configurable:!0}),StreamingAudioSource.prototype.freeBuffer=function(){},StreamingAudioSource.prototype.setData=function(data){Klang.Model.Audio.prototype.setData.call(this,data);var reinit=!1;this._volumeStartRange=data.volume_start_range,this._volumeEndRange=data.volume_end_range,void 0!==data.file_id&&this._fileId!=data.file_id&&(this._fileId=data.file_id,reinit=!0),this._playbackRate=void 0===data.playback_rate?1:data.playback_rate,this.playbackRateNode&&(this.playbackRateNode.value=this._playbackRate),this._loop=void 0!==data.loop&&data.loop,this.lastSource&&(this.lastSource.loop=this._loop),this._loop||(this._loopPlaying=!1),this._loopStart=void 0===data.loop_start?0:data.loop_start,this.lastSource&&(this.lastSource.loopStart=this._loopStart),this._loopEnd=void 0===data.loop_end?0:data.loop_end,this.lastSource&&(this.lastSource.loopEnd=this._loopEnd);var offset=void 0===data.offset?0:data.offset;this._offset!=offset&&(this._offset=offset,reinit=!0);var duration=void 0===data.duration?0:data.duration;if(this._duration!=duration&&(this._duration=duration,reinit=!0),this._retrig=void 0===data.retrig||data.retrig,void 0===data.reverse&&(data.reverse=!1),this._reverse!=data.reverse&&(this._reverse=data.reverse,reinit=!0),this.data.xfade!=data.xfade&&(reinit=!0),this.data=data,reinit&&this.init(),data.panner)if(this._panner)this._panner.setData(data.panner);else{var d=this._destination;this.disconnect(),this._panner=newPanner(data.panner),this.connect(d)}else if(!data.panner&&this._panner){d=this._destination;this.disconnect(),this._panner=null,this.connect(d)}},StreamingAudioSource}();return Klang.Model.StreamingAudioSource=StreamingAudioSource})),Module((function(Klang){return window.Klang=Klang,window.Klang})),window.Klang=Klang}();